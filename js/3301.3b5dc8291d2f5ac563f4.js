(self.webpackChunkjob=self.webpackChunkjob||[]).push([[3301],{2240:function(t,e){"use strict";Object.defineProperty(e,"X",{value:!0}),e.Z=void 0;var a={name:"ToggleDisplay",data:()=>({isOpen:!1}),methods:{handleToggle(){this.isOpen=!this.isOpen}}};e.Z=a},32436:function(t,e,a){"use strict";a(45974),a(43364);var i=a(22696);Object.defineProperty(e,"X",{value:!0}),e.Z=void 0,a(57024),a(87033),a(35948),a(94522),a(35927),a(6919),a(61026),a(9042),a(23232),a(80433),a(71959),a(7170);var r=i(a(33610)),s=i(a(24437)),l=i(a(15399)),n=i(a(22910)),o=i(a(84484)),c=a(61681),p=i(a(15578)),u=i(a(86234)),m=i(a(41641)),f=i(a(40515)),d=i(a(14617)),h=i(a(6880));function b(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,i)}return a}function v(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?b(Object(a),!0).forEach((function(e){(0,r.default)(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):b(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var g={name:"",components:{JbTagSelect:p.default,JbInput:u.default,BackTop:m.default,ToggleDisplay:h.default,RenderGlobalVar:f.default,RenderTaskStep:d.default},data:()=>({isLoading:!0,isPlanListLoading:!0,formData:{name:"",tags:[],variables:[],steps:[],description:""},planList:[{},{},{}],isSubmiting:!1,execLoading:!1}),computed:{isSkeletonLoading(){return this.isLoading}},watch:{formData:{handler(){this.isLoading||(this.hasChange=!0)},deep:!0}},created(){this.taskId=this.$route.params.id||0,this.isEdit="templateEdit"===this.$route.name,this.isClone="templateClone"===this.$route.name,this.initShowStepId=Number(this.$route.params.stepId),"templateCreate"!==this.$route.name&&this.fetchData(!0),this.isEdit&&this.fetchPlanList(),this.submitText=this.isEdit?l.default.t("template.保存"):l.default.t("template.提交"),this.rules={name:[{required:!0,message:l.default.t("template.模板名称必填"),trigger:"blur"},{validator:c.taskTemplateName.validator,message:c.taskTemplateName.message,trigger:"blur"},{validator:this.checkName,message:l.default.t("template.模板名已存在，请重新输入"),trigger:"blur"}],steps:[{validator:function(t){return t.length&&t.some((function(t){return!t.delete}))},message:l.default.t("template.作业步骤必填"),trigger:"blur"}]}},methods:{fetchData(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.isLoading=!0,(this.isEdit?n.default.taskDetail:n.default.taskClone)({id:this.taskId},{permission:"page"}).then((function(a){var i=a.name,r=a.description,l=a.tags,n=a.variables,o=a.stepList;t.formData={name:i,description:r,tags:l,variables:n,steps:o},t.isClone&&t.searchCiphertextVariable(),e&&t.isEdit&&t.initShowStepId>0&&setTimeout((function(){t.$refs.step.clickStepByIndex((0,s.default)(o,(function(e){return e.id===t.initShowStepId})))})),e||setTimeout((function(){window.changeAlert=!1}),100)})).catch((function(e){[1,400].includes(e.code)&&setTimeout((function(){t.$router.push({name:"taskList"})}),3e3)})).finally((function(){t.isLoading=!1}))},fetchPlanList(){var t=this;this.isPlanListLoading=!0,o.default.fetchTaskPlan({id:this.taskId}).then((function(e){t.planList=Object.freeze(e)})).finally((function(){t.isPlanListLoading=!1}))},checkName(t){return n.default.taskCheckName({id:this.isEdit?this.taskId:0,name:t})},getScrollParent(){return this.$refs.contentScroll.$el.querySelector(".scroll-faker-content")},searchCiphertextVariable(){var t=[];this.formData.variables.forEach((function(e){e.isPassword&&t.push(e.name)})),t.length<1||this.$bkInfo({title:l.default.t("template.模板中包含密文变量，请重新设置值"),subTitle:l.default.t("template.“密文”类型的变量经过特殊加密处理，为避免信息泄露，克隆后初始值不会还原，需用户重新设置。"),okText:l.default.t("template.我知道了"),extCls:"password-variable-info"})},syncStepVarialbeDelete(t,e){var a=!1;return t.forEach((function(t){if(!t.delete){if(t.isFile){var i=t.fileStepInfo,r=i.fileDestination,s=i.fileSourceList,l=r.server;return e[l.variable]&&(l.variable="",t.localValidator=!1,a=!0),void s.forEach((function(i){1===i.fileType&&e[i.host.variable]&&(i.host.variable="",t.localValidator=!1,a=!0)}))}if(t.isScript){var n=t.scriptStepInfo.executeTarget;e[n.variable]&&(n.variable="",t.localValidator=!1,a=!0)}}})),a?[...t]:t},syncStepVariableRename:(t,e)=>(t.forEach((function(t){if(!t.delete){if(t.isFile){var a=t.fileStepInfo,i=a.fileDestination,r=a.fileSourceList,s=i.server;return e[s.variable]&&(s.variable=e[s.variable]),void r.forEach((function(t){1===t.fileType&&e[t.host.variable]&&(t.host.variable=e[t.host.variable])}))}if(t.isScript){var l=t.scriptStepInfo.executeTarget;e[l.variable]&&(l.variable=e[l.variable])}}})),[...t]),handleGlobalVariableChange(t){var e=t.reduce((function(t,e){return t[e.id]={name:e.name,delete:e.delete},t}),{}),a={},i={};this.formData.variables.forEach((function(t){if(t.isHost){var r=t.id,s=t.name;e[r]&&!e[r].delete?e[r].name!==s&&(a[s]=e[r].name):i[s]=!0}}));var r=this.syncStepVarialbeDelete(this.formData.steps,i);r=this.syncStepVariableRename(r,a),this.formData.variables=t,this.formData.steps=r},handleTaskStepChange(t){this.formData.steps=t,this.$refs.templateOperateRef.clearError()},handlerSubmit(){for(var t=this,e=0;e<this.formData.steps.length;e++)if(1!==this.formData.steps[e].delete&&!1===this.formData.steps[e].localValidator)return void this.messageError(l.default.t("template.请将「待补全」的步骤信息完善后提交重试"));this.isSubmiting=!0,this.$refs.templateOperateRef.validate().then((function(){return n.default.taskUpdate(v(v({},t.formData),{},{id:t.isEdit?t.taskId:0})).then((function(e){return window.changeAlert=!1,o.default.fetchTaskPlan({id:e}).then((function(a){for(var i=!1,r=0;r<a.length;r++)if(a[r].needUpdate){i=!0;break}t.planList=Object.freeze(a),t.isEdit?t.editSuccessCallback(e,i):t.createSuccessCallback(e)}))}))})).finally((function(){t.isSubmiting=!1}))},createSuccessCallback(t){var e=this,a=this.$createElement,i="",r=!1,s=function(){e.$router.push({name:"templateEdit",params:{id:t}}),r=!0,i.close()},n=function(){e.$router.push({name:"templateDetail",params:{id:t}}),r=!0,i.close()},o=function(){e.$router.push({name:"viewPlan",params:{templateId:t},query:{mode:"create"}}),r=!0,i.close()};i=this.$bkInfo({type:"success",title:l.default.t("template.作业创建成功"),showFooter:!1,subHeader:a("div",[a("p",{style:{marginBottom:"10px",color:"#979BA5"}},[l.default.t("template.还差一步「 设置执行方案」，即可执行作业")]),a("p",[a("bk-button",{style:{marginRight:"10px"},attrs:{text:!0},on:{click:s}},[l.default.t("template.继续编辑")]),a("bk-button",{style:{marginRight:"10px"},attrs:{text:!0},on:{click:n}},[l.default.t("template.立即查看")]),a("bk-button",{attrs:{text:!0},on:{click:o}},[l.default.t("template.设置方案")])])]),cancelFn:function(){r||e.$router.push({name:"templateEdit",params:{id:t}})}})},editSuccessCallback(t,e){var a=this,i=this.$createElement,r="",s=!1,n=function(){a.$router.push({name:"templateDetail",params:{id:t}}),s=!0,r.close()},o=function(){a.$router.push({name:"syncPlanBatch",query:{planIds:a.planList.map((function(t){return t.id})).join(","),from:"templateEdit"}}),s=!0,r.close()},c=function(){a.$router.push({name:"viewPlan",params:{templateId:t},query:{from:"templateDetail"}}),s=!0,r.close()};r=this.$bkInfo({type:"success",title:l.default.t("template.编辑保存成功"),showFooter:!1,subHeader:i("div",[i("p",{style:{marginBottom:"10px",color:"#979BA5"}},[l.default.t("template.可以通过 “立即同步” 入口前往更新所有执行方案")]),i("p",[i("bk-button",{class:"mr10",attrs:{text:!0},on:{click:n}},[l.default.t("template.返回查看")]),i("bk-button",{class:"mr10",attrs:{text:!0,disabled:!e},on:{click:o}},[l.default.t("template.立即同步")]),i("bk-button",{attrs:{text:!0},on:{click:c}},[l.default.t("template.查看方案")])])]),cancelFn:function(){s||a.fetchData(!1)}})},handleCancel(){this.routerBack()},routerBack(){"templateDetail"!==this.$route.query.from?this.$router.push({name:"taskList"}):this.$router.push({name:"templateDetail",params:{id:this.taskId}})}}};e.Z=g},52162:function(){},86287:function(){},6880:function(t,e,a){"use strict";a.r(e),a.d(e,{__esModule:function(){return r.X},default:function(){return n}});var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"toggle-display"},[a("div",{directives:[{name:"show",rawName:"v-show",value:t.isOpen,expression:"isOpen"}]},[t._t("default")],2),t._v(" "),a("bk-form-item",{staticStyle:{"margin-top":"-10px"},attrs:{label:" "}},[a("div",{staticClass:"action",on:{click:t.handleToggle}},[t.isOpen?[a("Icon",{staticClass:"toggle-arrow",attrs:{type:"angle-double-up"}}),t._v(" "),a("span",[t._v(t._s(t.$t("template.收起更多设置")))])]:[a("Icon",{staticClass:"toggle-arrow",attrs:{type:"angle-double-down"}}),t._v(" "),a("span",[t._v(t._s(t.$t("template.展开更多设置")))])]],2)])],1)};i._withStripped=!0;var r=a(2240),s=r.Z,l=(a(13533),(0,a(35471).Z)(s,i,[],!1,null,"d5d452ba",null));l.options.__file="src/views/task-manage/template-operation/components/toggle-display.vue";var n=l.exports},13301:function(t,e,a){"use strict";a.r(e),a.d(e,{__esModule:function(){return r.X},default:function(){return n}});var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"template-operation",attrs:{id:"templateOperation"}},[a("div",{staticClass:"layout-left"},[a("scroll-faker",{ref:"contentScroll"},[a("div",{staticClass:"template-container"},[a("smart-action",{attrs:{"offset-target":"bk-form-content"},scopedSlots:t._u([{key:"action",fn:function(){return[a("bk-button",{directives:[{name:"test",rawName:"v-test",value:{type:"button",value:"operationTemplateSubmit"},expression:"{ type: 'button', value: 'operationTemplateSubmit' }"}],staticClass:"w120 mr10",attrs:{theme:"primary",loading:t.isSubmiting},on:{click:t.handlerSubmit}},[t._v("\n                            "+t._s(t.submitText)+"\n                        ")]),t._v(" "),a("bk-button",{directives:[{name:"test",rawName:"v-test",value:{type:"button",value:"operationTemplateCancel"},expression:"{ type: 'button', value: 'operationTemplateCancel' }"}],on:{click:t.handleCancel}},[t._v("\n                            "+t._s(t.$t("template.取消"))+"\n                        ")])]},proxy:!0}])},[a("jb-form",{directives:[{name:"test",rawName:"v-test",value:{type:"form",value:"template"},expression:"{ type: 'form', value: 'template' }"}],ref:"templateOperateRef",attrs:{model:t.formData,rules:t.rules}},[a("bk-alert",{staticClass:"info",attrs:{title:t.$t("template.「对作业模板的修改不会立即自动更新执行方案，需要由用户手动触发」")}}),t._v(" "),a("jb-form-item",{attrs:{label:t.$t("template.模板名称"),required:"",property:"name"}},[a("jb-input",{staticClass:"input form-item-content",attrs:{placeholder:t.$t("template.输入作业模板名称"),maxlength:60},model:{value:t.formData.name,callback:function(e){t.$set(t.formData,"name",e)},expression:"formData.name"}})],1),t._v(" "),a("toggle-display",{staticStyle:{"margin-bottom":"20px"}},[a("jb-form-item",{attrs:{label:t.$t("template.场景标签.label"),property:"tags"}},[a("jb-tag-select",{staticClass:"input form-item-content",attrs:{placeholder:t.$t("template.标签对资源的分类管理有很大帮助")},model:{value:t.formData.tags,callback:function(e){t.$set(t.formData,"tags",e)},expression:"formData.tags"}})],1),t._v(" "),a("jb-form-item",{attrs:{label:t.$t("template.模板描述")}},[a("bk-input",{staticClass:"template-desc-textarea form-item-content",attrs:{type:"textarea",maxlength:500,placeholder:t.$t("template.填写该模板的功能介绍等详细描述...")},model:{value:t.formData.description,callback:function(e){t.$set(t.formData,"description",e)},expression:"formData.description"}})],1)],1),t._v(" "),a("jb-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{label:t.$t("template.全局变量.label")}},[a("render-global-var",{attrs:{list:t.formData.variables,mode:"operate"},on:{"on-change":t.handleGlobalVariableChange}})],1),t._v(" "),a("jb-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{label:t.$t("template.作业步骤.label"),required:"",property:"steps"}},[a("render-task-step",{ref:"step",attrs:{list:t.formData.steps,variable:t.formData.variables,mode:"operation"},on:{"on-change":t.handleTaskStepChange}})],1)],1)],1)],1)]),t._v(" "),a("back-top",{attrs:{target:t.getScrollParent}})],1),t._v(" "),a("div",{staticClass:"layout-right",attrs:{id:"templateOperationLayoutRight"}})])};i._withStripped=!0;var r=a(32436),s=r.Z,l=(a(66421),(0,a(35471).Z)(s,i,[],!1,null,null,null));l.options.__file="src/views/task-manage/template-operation/index.vue";var n=l.exports},13533:function(t,e,a){var i=a(52162);i.__esModule&&(i=i.default),"string"==typeof i&&(i=[[t.id,i,""]]),i.locals&&(t.exports=i.locals);(0,a(13570).Z)("b5bc35b6",i,!1,{})},66421:function(t,e,a){var i=a(86287);i.__esModule&&(i=i.default),"string"==typeof i&&(i=[[t.id,i,""]]),i.locals&&(t.exports=i.locals);(0,a(13570).Z)("dbce0916",i,!1,{})}}]);