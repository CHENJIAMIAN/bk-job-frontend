(self.webpackChunkjob=self.webpackChunkjob||[]).push([[6004],{50087:function(t,e,a){"use strict";a(35927),a(45974),a(9042),a(43364);var n=a(22696);Object.defineProperty(e,"X",{value:!0}),e.Z=void 0,a(87033),a(35948),a(94522),a(85604);var i=n(a(33610)),o=n(a(45812)),r=n(a(57525)),s=n(a(93435)),c=a(45614),u=n(a(15399)),l=n(a(67713)),f=n(a(72075)),d=n(a(39986)),m=n(a(32888)),h=n(a(70007)),p=n(a(2699)),v=a(41980),g=a(46790);function y(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,n)}return a}function I(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?y(Object(a),!0).forEach((function(e){(0,i.default)(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):y(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var b=function(){return{name:(0,v.genDefaultName)(u.default.t("execution.快速执行分发文件")),fileSourceList:[],timeout:7200,uploadSpeedLimit:0,transferMode:2,downloadSpeedLimit:0,account:"",path:"",server:new d.default({})}},S={name:"",components:{JbForm:m.default,CardLayout:h.default,ItemFactory:p.default},data:()=>({isLoading:!1,formData:b(),isSubmiting:!1,historyList:[],isShowHistory:!1,targetPathTipsPlacement:""}),computed:I({},(0,c.mapState)("distroFile",{isEditNewSourceFile:function(t){return t.isEditNewSourceFile}})),created(){this.init(),this.calcTargetPathTipsPlacement()},mounted(){var t=this;window.addEventListener("resize",this.calcTargetPathTipsPlacement),this.$once("hook:beforeDestroy",(function(){window.removeEventListener("resize",t.calcTargetPathTipsPlacement)})),window.IPInputScope="FILE_DISTRIBUTION",this.$once("hook:beforeDestroy",(function(){window.IPInputScope=""}))},methods:{fetchData(){var t=this;this.$request(l.default.fetchTaskInstance({id:this.taskInstanceId}),(function(){t.isLoading=!0})).then((function(e){var a=e.stepInfo,n=a.fileStepInfo,i=n.downloadSpeedLimit,o=n.fileDestination,r=n.fileSourceList,s=n.timeout,c=n.transferMode,u=n.uploadSpeedLimit,l=o.account,f=o.path,d=o.server;t.formData=I(I({},t.formData),{},{name:a.name,uploadSpeedLimit:u,downloadSpeedLimit:i,account:l,path:f,server:d,timeout:s,fileSourceList:r,transferMode:c})})).finally((function(){t.isLoading=!1}))},init(){var t=this;if(this.taskInstanceId=parseInt(this.$route.params.taskInstanceId,10),this.timeTravel(),"historyStep"===this.$route.query.from){var e=null;if(e=this.taskInstanceId?(0,s.default)(this.historyList,(function(e){return e.taskInstanceId===t.taskInstanceId})):(0,r.default)(this.historyList))return void(this.formData=e.formData)}this.taskInstanceId>0&&this.fetchData()},calcTargetPathTipsPlacement:(0,o.default)((function(){this.targetPathTipsPlacement=window.innerWidth>1650?"right-start":"top"}),60),timeTravel(){this.historyList=Object.freeze(g.pushFileHistory.getItem())},pushLocalStorage(t){var e=g.pushFileHistory.getItem();e.unshift(t),g.pushFileHistory.setItem(e)},handleShowHistory(){this.isShowHistory=!this.isShowHistory},handleGoHistoryDetail(t){this.$router.push({name:"historyStep",params:{taskInstanceId:t.taskInstanceId},query:{stepInstanceId:t.stepInstanceId,from:"fastPushFile"}})},handleChange(t,e){this.formData[t]=e},handleSubmit(){var t=this;this.isSubmiting=!0,this.$refs.pushFileForm.validate().then((function(){return new Promise((function(e,a){if(!t.isEditNewSourceFile)return e();t.$bkInfo({title:u.default.t("execution.您有未保存的源文件"),type:"warning",okText:u.default.t("execution.继续执行"),cancelText:u.default.t("execution.去保存"),confirmFn:function(){setTimeout((function(){e()}),300)},cancelFn:function(){setTimeout((function(){a(new Error("save"))}),300)}})}))})).then((function(){return new Promise((function(e,a){for(var n=!1,i=0;i<t.formData.fileSourceList.length;i++){var o=t.formData.fileSourceList[i];if(o.fileType===f.default.fileStep.TYPE_SERVER&&(0,v.compareHost)(t.formData.server,o.host)){n=!0;break}}n?t.$bkInfo({title:u.default.t("execution.源和目标服务器相同"),subTitle:u.default.t("execution.检测到文件传输源和目标服务器是同一批，若是单台建议使用本地 cp 方式效率会更高，请问你是否确定参数无误？"),width:500,okText:u.default.t("execution.好的，我调整一下"),cancelText:u.default.t("execution.是的，确定无误"),confirmFn:function(){a(new Error("execute"))},cancelFn:function(){e()}}):e()}))})).then((function(){return new Promise((function(e,a){(0,v.detectionSourceFileDupLocation)(t.formData.fileSourceList)?t.$bkInfo({title:u.default.t("execution.源文件可能出现同名"),subTitle:u.default.t("execution.多文件源传输场景下容易出现同名文件覆盖的问题，你可以在目标路径中使用 [源服务器IP] 的变量来尽可能规避风险。"),okText:u.default.t("execution.好的，我调整一下"),cancelText:u.default.t("execution.已知悉，确定执行"),closeIcon:!1,width:500,confirmFn:function(){t.$refs.targetPath.$el.scrollIntoView(),t.$refs.targetPath.$el.querySelector(".bk-form-input").focus(),a(new Error("transferMode change"))},cancelFn:function(){e()}}):e()}))})).then((function(){var e=t.formData,a=e.name,n=e.timeout,i=e.uploadSpeedLimit,o=e.downloadSpeedLimit,r=e.transferMode,s=e.fileSourceList,c=e.account,u=e.path,f=e.server;return l.default.pushFile({name:a,uploadSpeedLimit:parseInt(i,10),downloadSpeedLimit:parseInt(o,10),timeout:parseInt(n,10),fileSourceList:s,transferMode:r,fileDestination:{account:c,path:u,server:f}}).then((function(e){window.changeAlert=!1,t.$router.push({name:"historyStep",params:{taskInstanceId:e.taskInstanceId},query:{stepInstanceId:e.stepInstanceId,from:"fastPushFile"}}),t.pushLocalStorage({id:Date.now(),name:a,taskInstanceId:e.taskInstanceId,stepInstanceId:e.stepInstanceId,formData:t.formData})}))})).catch((function(){t.isSubmiting=!1}))},handleCancel(){this.$refs.pushFileForm.clearError(),this.formData=b()}}};e.Z=S},35831:function(){},56004:function(t,e,a){"use strict";a.r(e),a.d(e,{__esModule:function(){return i.X},default:function(){return s}});var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.isLoading},expression:"{ isLoading }"}],staticClass:"distro-file-page"},[a("smart-action",{attrs:{"offset-target":"bk-form-content"},scopedSlots:t._u([{key:"action",fn:function(){return[a("bk-button",{directives:[{name:"test",rawName:"v-test",value:{type:"button",value:"fastPushFileSubmit"},expression:"{ type: 'button', value: 'fastPushFileSubmit' }"}],staticClass:"w120 mr10",attrs:{theme:"primary",loading:t.isSubmiting},on:{click:t.handleSubmit}},[t._v("\n                "+t._s(t.$t("execution.执行"))+"\n            ")]),t._v(" "),a("bk-button",{directives:[{name:"test",rawName:"v-test",value:{type:"button",value:"fastPushFileReset"},expression:"{ type: 'button', value: 'fastPushFileReset' }"}],on:{click:t.handleCancel}},[t._v("\n                "+t._s(t.$t("execution.重置"))+"\n            ")])]},proxy:!0}])},[a("jb-form",{directives:[{name:"test",rawName:"v-test",value:{type:"form",value:"pushFile"},expression:"{ type: 'form', value: 'pushFile' }"}],ref:"pushFileForm",staticClass:"push-file-form",attrs:{model:t.formData}},[a("card-layout",{staticClass:"block",attrs:{title:t.$t("execution.基本信息")}},[a("item-factory",{attrs:{name:"stepName",field:"name",label:t.$t("execution.任务名称"),placeholder:t.$t("execution.取一个便于记忆的任务名，方便后续在历史记录中快速定位..."),"form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"timeout",field:"timeout","form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"speedLimit",field:"uploadSpeedLimit",label:t.$t("execution.上传限速"),"form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"speedLimit",field:"downloadSpeedLimit",label:t.$t("execution.下载限速"),"form-data":t.formData},on:{"on-change":t.handleChange}})],1),t._v(" "),a("card-layout",{staticClass:"block",attrs:{title:t.$t("execution.文件来源")}},[a("item-factory",{attrs:{name:"sourceFileOfExecution",field:"fileSourceList","form-data":t.formData},on:{"on-change":t.handleChange}})],1),t._v(" "),a("card-layout",{staticClass:"block",staticStyle:{"margin-bottom":"0"},attrs:{title:t.$t("execution.传输目标")}},[a("item-factory",{ref:"targetPath",attrs:{name:"targetPath",field:"path","tips-placement":t.targetPathTipsPlacement,"form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"transferMode",field:"transferMode","form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"executeAccount",field:"account","form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"targetServerOfExecution",field:"server","form-data":t.formData},on:{"on-change":t.handleChange}})],1)],1)],1),t._v(" "),t.historyList.length>0?a("div",{staticClass:"execution-history",class:{active:t.isShowHistory}},[a("div",{staticClass:"toggle-btn",on:{click:t.handleShowHistory}},[a("Icon",{staticClass:"toggle-flag",attrs:{type:"angle-double-left"}}),t._v(" "),a("div",{staticClass:"recent-result"},[t._v(t._s(t.$t("execution.最近结果")))])],1),t._v(" "),a("div",{staticClass:"history-content"},t._l(t.historyList,(function(e){return a("div",{key:e.id,staticClass:"item",on:{click:function(a){return t.handleGoHistoryDetail(e)}}},[t._v("\n                "+t._s(e.name)+"\n            ")])})),0)]):t._e()],1)};n._withStripped=!0;var i=a(50087),o=i.Z,r=(a(66726),(0,a(35471).Z)(o,n,[],!1,null,null,null));r.options.__file="src/views/fast-execution/distro-file/index.vue";var s=r.exports},66726:function(t,e,a){var n=a(35831);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[t.id,n,""]]),n.locals&&(t.exports=n.locals);(0,a(13570).Z)("64cbf07d",n,!1,{})}}]);