(self.webpackChunkjob=self.webpackChunkjob||[]).push([[7409],{19877:function(t,e,a){"use strict";a(87147),a(13118),a(59241),a(20767);var n=a(70534);Object.defineProperty(e,"X",{value:!0}),e.Z=void 0,a(41336),a(91981),a(63898),a(75328);var i=n(a(68203)),o=n(a(2771)),r=n(a(81371)),s=n(a(7285)),c=a(80771),l=n(a(56762)),u=n(a(63557)),f=n(a(34976)),d=n(a(52707)),m=n(a(10827)),h=n(a(26044)),p=a(11986),v=a(15513);function g(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,n)}return a}function y(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?g(Object(a),!0).forEach((function(e){(0,i.default)(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):g(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var I=function(){return{name:(0,p.genDefaultName)("快速执行分发文件"),fileSourceList:[{},{},{}],timeout:7200,uploadSpeedLimit:0,transferMode:2,downloadSpeedLimit:0,account:"",path:"",server:new f.default({})}},b={name:"",components:{JbForm:d.default,CardLayout:m.default,ItemFactory:h.default},data:()=>({isLoading:!1,formData:I(),isSubmiting:!1,historyList:[{},{},{}],isShowHistory:!1,targetPathTipsPlacement:""}),computed:y({},(0,c.mapState)("distroFile",{isEditNewSourceFile:function(t){return t.isEditNewSourceFile}})),created(){this.init(),this.calcTargetPathTipsPlacement()},mounted(){var t=this;window.addEventListener("resize",this.calcTargetPathTipsPlacement),this.$once("hook:beforeDestroy",(function(){window.removeEventListener("resize",t.calcTargetPathTipsPlacement)})),window.IPInputScope="FILE_DISTRIBUTION",this.$once("hook:beforeDestroy",(function(){window.IPInputScope=""}))},methods:{fetchData(){var t=this;this.$request(l.default.fetchTaskInstance({id:this.taskInstanceId}),(function(){t.isLoading=!0})).then((function(e){var a=e.stepInfo,n=a.fileStepInfo,i=n.downloadSpeedLimit,o=n.fileDestination,r=n.fileSourceList,s=n.timeout,c=n.transferMode,l=n.uploadSpeedLimit,u=o.account,f=o.path,d=o.server;t.formData=y(y({},t.formData),{},{name:a.name,uploadSpeedLimit:l,downloadSpeedLimit:i,account:u,path:f,server:d,timeout:s,fileSourceList:r,transferMode:c})})).finally((function(){t.isLoading=!1}))},init(){var t=this;if(this.taskInstanceId=parseInt(this.$route.params.taskInstanceId,10),this.timeTravel(),"historyStep"===this.$route.query.from){var e=null;if(e=this.taskInstanceId?(0,s.default)(this.historyList,(function(e){return e.taskInstanceId===t.taskInstanceId})):(0,r.default)(this.historyList))return void(this.formData=e.formData)}this.taskInstanceId>0&&this.fetchData()},calcTargetPathTipsPlacement:(0,o.default)((function(){this.targetPathTipsPlacement=window.innerWidth>1650?"right-start":"top"}),60),timeTravel(){this.historyList=Object.freeze(v.pushFileHistory.getItem())},pushLocalStorage(t){var e=v.pushFileHistory.getItem();e.unshift(t),v.pushFileHistory.setItem(e)},handleShowHistory(){this.isShowHistory=!this.isShowHistory},handleGoHistoryDetail(t){this.$router.push({name:"historyStep",params:{taskInstanceId:t.taskInstanceId},query:{stepInstanceId:t.stepInstanceId,from:"fastPushFile"}})},handleChange(t,e){this.formData[t]=e},handleSubmit(){var t=this;this.isSubmiting=!0,this.$refs.pushFileForm.validate().then((function(){return new Promise((function(e,a){if(!t.isEditNewSourceFile)return e();t.$bkInfo({title:"您有未保存的源文件",type:"warning",okText:"继续执行",cancelText:"去保存",confirmFn:function(){setTimeout((function(){e()}),300)},cancelFn:function(){setTimeout((function(){a(new Error("save"))}),300)}})}))})).then((function(){return new Promise((function(e,a){for(var n=!1,i=0;i<t.formData.fileSourceList.length;i++){var o=t.formData.fileSourceList[i];if(o.fileType===u.default.fileStep.TYPE_SERVER&&(0,p.compareHost)(t.formData.server,o.host)){n=!0;break}}n?t.$bkInfo({title:"源和目标服务器相同",subTitle:"检测到文件传输源和目标服务器是同一批，若是单台建议使用本地 cp 方式效率会更高，请问你是否确定参数无误？",width:500,okText:"好的，我调整一下",cancelText:"是的，确定无误",confirmFn:function(){a(new Error("execute"))},cancelFn:function(){e()}}):e()}))})).then((function(){return new Promise((function(e,a){(0,p.detectionSourceFileDupLocation)(t.formData.fileSourceList)?t.$bkInfo({title:"源文件可能出现同名",subTitle:"多文件源传输场景下容易出现同名文件覆盖的问题，你可以在目标路径中使用 [源服务器IP] 的变量来尽可能规避风险。",okText:"好的，我调整一下",cancelText:"已知悉，确定执行",closeIcon:!1,width:500,confirmFn:function(){t.$refs.targetPath.$el.scrollIntoView(),t.$refs.targetPath.$el.querySelector(".bk-form-input").focus(),a(new Error("transferMode change"))},cancelFn:function(){e()}}):e()}))})).then((function(){var e=t.formData,a=e.name,n=e.timeout,i=e.uploadSpeedLimit,o=e.downloadSpeedLimit,r=e.transferMode,s=e.fileSourceList,c=e.account,u=e.path,f=e.server;return l.default.pushFile({name:a,uploadSpeedLimit:parseInt(i,10),downloadSpeedLimit:parseInt(o,10),timeout:parseInt(n,10),fileSourceList:s,transferMode:r,fileDestination:{account:c,path:u,server:f}}).then((function(e){window.changeAlert=!1,t.$router.push({name:"historyStep",params:{taskInstanceId:e.taskInstanceId},query:{stepInstanceId:e.stepInstanceId,from:"fastPushFile"}}),t.pushLocalStorage({id:Date.now(),name:a,taskInstanceId:e.taskInstanceId,stepInstanceId:e.stepInstanceId,formData:t.formData})}))})).catch((function(){t.isSubmiting=!1}))},handleCancel(){this.$refs.pushFileForm.clearError(),this.formData=I()}}};e.Z=b},80301:function(){},87409:function(t,e,a){"use strict";a.r(e),a.d(e,{__esModule:function(){return i.X},default:function(){return s}});var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.isLoading},expression:"{ isLoading }"}],staticClass:"distro-file-page"},[a("smart-action",{attrs:{"offset-target":"bk-form-content"},scopedSlots:t._u([{key:"action",fn:function(){return[a("bk-button",{directives:[{name:"test",rawName:"v-test",value:{type:"button",value:"fastPushFileSubmit"},expression:"{ type: 'button', value: 'fastPushFileSubmit' }"}],staticClass:"w120 mr10",attrs:{theme:"primary",loading:t.isSubmiting},on:{click:t.handleSubmit}},[t._v("\n                "+t._s("执行")+"\n            ")]),t._v(" "),a("bk-button",{directives:[{name:"test",rawName:"v-test",value:{type:"button",value:"fastPushFileReset"},expression:"{ type: 'button', value: 'fastPushFileReset' }"}],on:{click:t.handleCancel}},[t._v("\n                "+t._s("重置")+"\n            ")])]},proxy:!0}])},[a("jb-form",{directives:[{name:"test",rawName:"v-test",value:{type:"form",value:"pushFile"},expression:"{ type: 'form', value: 'pushFile' }"}],ref:"pushFileForm",staticClass:"push-file-form",attrs:{model:t.formData}},[a("card-layout",{staticClass:"block",attrs:{title:"基本信息"}},[a("item-factory",{attrs:{name:"stepName",field:"name",label:"任务名称",placeholder:"取一个便于记忆的任务名，方便后续在历史记录中快速定位...","form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"timeout",field:"timeout","form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"speedLimit",field:"uploadSpeedLimit",label:"上传限速","form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"speedLimit",field:"downloadSpeedLimit",label:"下载限速","form-data":t.formData},on:{"on-change":t.handleChange}})],1),t._v(" "),a("card-layout",{staticClass:"block",attrs:{title:"文件来源"}},[a("item-factory",{attrs:{name:"sourceFileOfExecution",field:"fileSourceList","form-data":t.formData},on:{"on-change":t.handleChange}})],1),t._v(" "),a("card-layout",{staticClass:"block",staticStyle:{"margin-bottom":"0"},attrs:{title:"传输目标"}},[a("item-factory",{ref:"targetPath",attrs:{name:"targetPath",field:"path","tips-placement":t.targetPathTipsPlacement,"form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"transferMode",field:"transferMode","form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"executeAccount",field:"account","form-data":t.formData},on:{"on-change":t.handleChange}}),t._v(" "),a("item-factory",{attrs:{name:"targetServerOfExecution",field:"server","form-data":t.formData},on:{"on-change":t.handleChange}})],1)],1)],1),t._v(" "),t.historyList.length>0?a("div",{staticClass:"execution-history",class:{active:t.isShowHistory}},[a("div",{staticClass:"toggle-btn",on:{click:t.handleShowHistory}},[a("Icon",{staticClass:"toggle-flag",attrs:{type:"angle-double-left"}}),t._v(" "),a("div",{staticClass:"recent-result"},[t._v(t._s("最近结果"))])],1),t._v(" "),a("div",{staticClass:"history-content"},t._l(t.historyList,(function(e){return a("div",{key:e.id,staticClass:"item",on:{click:function(a){return t.handleGoHistoryDetail(e)}}},[t._v("\n                "+t._s(e.name)+"\n            ")])})),0)]):t._e()],1)};n._withStripped=!0;var i=a(19877),o=i.Z,r=(a(67891),(0,a(51900).Z)(o,n,[],!1,null,null,null));r.options.__file="src/views/fast-execution/distro-file/index.vue";var s=r.exports},67891:function(t,e,a){var n=a(80301);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[t.id,n,""]]),n.locals&&(t.exports=n.locals);(0,a(18086).Z)("dc7250e8",n,!1,{})}}]);