(self.webpackChunkjob=self.webpackChunkjob||[]).push([[8500],{84852:function(t,e){"use strict";Object.defineProperty(e,"X",{value:!0}),e.Z=void 0;var a={name:"ToggleDisplay",data:()=>({isOpen:!1}),methods:{handleToggle(){this.isOpen=!this.isOpen}}};e.Z=a},14043:function(t,e,a){"use strict";a(13118),a(20767);var i=a(70534);Object.defineProperty(e,"X",{value:!0}),e.Z=void 0,a(85376),a(41336),a(91981),a(63898),a(87147),a(63876),a(94354),a(59241),a(79951),a(45680),a(70616),a(14309);var r=i(a(68203)),s=i(a(41844)),n=i(a(74650)),o=i(a(51391)),l=a(2938),c=i(a(37308)),u=i(a(76960)),p=i(a(11944)),m=i(a(18094)),f=i(a(96187)),d=i(a(52774));function h(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,i)}return a}function b(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?h(Object(a),!0).forEach((function(e){(0,r.default)(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):h(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var v={name:"",components:{JbTagSelect:c.default,JbInput:u.default,BackTop:p.default,ToggleDisplay:d.default,RenderGlobalVar:m.default,RenderTaskStep:f.default},data:()=>({isLoading:!0,isPlanListLoading:!0,formData:{name:"",tags:[],variables:[],steps:[],description:""},planList:[{},{},{}],isSubmiting:!1,execLoading:!1}),computed:{isSkeletonLoading(){return this.isLoading}},watch:{formData:{handler(){this.isLoading||(this.hasChange=!0)},deep:!0}},created(){this.taskId=this.$route.params.id||0,this.isEdit="templateEdit"===this.$route.name,this.isClone="templateClone"===this.$route.name,this.initShowStepId=Number(this.$route.params.stepId),"templateCreate"!==this.$route.name&&this.fetchData(!0),this.isEdit&&this.fetchPlanList(),this.submitText=this.isEdit?"保存":"提交",this.rules={name:[{required:!0,message:"模板名称必填",trigger:"blur"},{validator:l.taskTemplateName.validator,message:l.taskTemplateName.message,trigger:"blur"},{validator:this.checkName,message:"模板名已存在，请重新输入",trigger:"blur"}],steps:[{validator:function(t){return t.length&&t.some((function(t){return!t.delete}))},message:"作业步骤必填",trigger:"blur"}]}},methods:{fetchData(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.isLoading=!0,(this.isEdit?n.default.taskDetail:n.default.taskClone)({id:this.taskId},{permission:"page"}).then((function(a){var i=a.name,r=a.description,n=a.tags,o=a.variables,l=a.stepList;t.formData={name:i,description:r,tags:n,variables:o,steps:l},t.isClone&&t.searchCiphertextVariable(),e&&t.isEdit&&t.initShowStepId>0&&setTimeout((function(){t.$refs.step.clickStepByIndex((0,s.default)(l,(function(e){return e.id===t.initShowStepId})))})),e||setTimeout((function(){window.changeAlert=!1}),100)})).catch((function(e){[1,400].includes(e.code)&&setTimeout((function(){t.$router.push({name:"taskList"})}),3e3)})).finally((function(){t.isLoading=!1}))},fetchPlanList(){var t=this;this.isPlanListLoading=!0,o.default.fetchTaskPlan({id:this.taskId}).then((function(e){t.planList=Object.freeze(e)})).finally((function(){t.isPlanListLoading=!1}))},checkName(t){return n.default.taskCheckName({id:this.isEdit?this.taskId:0,name:t})},getScrollParent(){return this.$refs.contentScroll.$el.querySelector(".scroll-faker-content")},searchCiphertextVariable(){var t=[];this.formData.variables.forEach((function(e){e.isPassword&&t.push(e.name)})),t.length<1||this.$bkInfo({title:"模板中包含密文变量，请重新设置值",subTitle:"“密文”类型的变量经过特殊加密处理，为避免信息泄露，克隆后初始值不会还原，需用户重新设置。",okText:"我知道了",extCls:"password-variable-info"})},syncStepVarialbeDelete(t,e){var a=!1;return t.forEach((function(t){if(!t.delete){if(t.isFile){var i=t.fileStepInfo,r=i.fileDestination,s=i.fileSourceList,n=r.server;return e[n.variable]&&(n.variable="",t.localValidator=!1,a=!0),void s.forEach((function(i){1===i.fileType&&e[i.host.variable]&&(i.host.variable="",t.localValidator=!1,a=!0)}))}if(t.isScript){var o=t.scriptStepInfo.executeTarget;e[o.variable]&&(o.variable="",t.localValidator=!1,a=!0)}}})),a?[...t]:t},syncStepVariableRename:(t,e)=>(t.forEach((function(t){if(!t.delete){if(t.isFile){var a=t.fileStepInfo,i=a.fileDestination,r=a.fileSourceList,s=i.server;return e[s.variable]&&(s.variable=e[s.variable]),void r.forEach((function(t){1===t.fileType&&e[t.host.variable]&&(t.host.variable=e[t.host.variable])}))}if(t.isScript){var n=t.scriptStepInfo.executeTarget;e[n.variable]&&(n.variable=e[n.variable])}}})),[...t]),handleGlobalVariableChange(t){var e=t.reduce((function(t,e){return t[e.id]={name:e.name,delete:e.delete},t}),{}),a={},i={};this.formData.variables.forEach((function(t){if(t.isHost){var r=t.id,s=t.name;e[r]&&!e[r].delete?e[r].name!==s&&(a[s]=e[r].name):i[s]=!0}}));var r=this.syncStepVarialbeDelete(this.formData.steps,i);r=this.syncStepVariableRename(r,a),this.formData.variables=t,this.formData.steps=r},handleTaskStepChange(t){this.formData.steps=t,this.$refs.templateOperateRef.clearError()},handlerSubmit(){for(var t=this,e=0;e<this.formData.steps.length;e++)if(1!==this.formData.steps[e].delete&&!1===this.formData.steps[e].localValidator)return void this.messageError("请将「待补全」的步骤信息完善后提交重试");this.isSubmiting=!0,this.$refs.templateOperateRef.validate().then((function(){return n.default.taskUpdate(b(b({},t.formData),{},{id:t.isEdit?t.taskId:0})).then((function(e){return window.changeAlert=!1,o.default.fetchTaskPlan({id:e}).then((function(a){for(var i=!1,r=0;r<a.length;r++)if(a[r].needUpdate){i=!0;break}t.planList=Object.freeze(a),t.isEdit?t.editSuccessCallback(e,i):t.createSuccessCallback(e)}))}))})).finally((function(){t.isSubmiting=!1}))},createSuccessCallback(t){var e=this,a=this.$createElement,i="",r=!1,s=function(){e.$router.push({name:"templateEdit",params:{id:t}}),r=!0,i.close()},n=function(){e.$router.push({name:"templateDetail",params:{id:t}}),r=!0,i.close()},o=function(){e.$router.push({name:"viewPlan",params:{templateId:t},query:{mode:"create"}}),r=!0,i.close()};i=this.$bkInfo({type:"success",title:"作业创建成功",showFooter:!1,subHeader:a("div",[a("p",{style:{marginBottom:"10px",color:"#979BA5"}},["还差一步「 设置执行方案」，即可执行作业"]),a("p",[a("bk-button",{style:{marginRight:"10px"},attrs:{text:!0},on:{click:s}},["继续编辑"]),a("bk-button",{style:{marginRight:"10px"},attrs:{text:!0},on:{click:n}},["立即查看"]),a("bk-button",{attrs:{text:!0},on:{click:o}},["设置方案"])])]),cancelFn:function(){r||e.$router.push({name:"templateEdit",params:{id:t}})}})},editSuccessCallback(t,e){var a=this,i=this.$createElement,r="",s=!1,n=function(){a.$router.push({name:"templateDetail",params:{id:t}}),s=!0,r.close()},o=function(){a.$router.push({name:"syncPlanBatch",query:{planIds:a.planList.map((function(t){return t.id})).join(","),from:"templateEdit"}}),s=!0,r.close()},l=function(){a.$router.push({name:"viewPlan",params:{templateId:t},query:{from:"templateDetail"}}),s=!0,r.close()};r=this.$bkInfo({type:"success",title:"编辑保存成功",showFooter:!1,subHeader:i("div",[i("p",{style:{marginBottom:"10px",color:"#979BA5"}},["可以通过 “立即同步” 入口前往更新所有执行方案"]),i("p",[i("bk-button",{class:"mr10",attrs:{text:!0},on:{click:n}},["返回查看"]),i("bk-button",{class:"mr10",attrs:{text:!0,disabled:!e},on:{click:o}},["立即同步"]),i("bk-button",{attrs:{text:!0},on:{click:l}},["查看方案"])])]),cancelFn:function(){s||a.fetchData(!1)}})},handleCancel(){this.routerBack()},routerBack(){"templateDetail"!==this.$route.query.from?this.$router.push({name:"taskList"}):this.$router.push({name:"templateDetail",params:{id:this.taskId}})}}};e.Z=v},47640:function(){},62195:function(){},52774:function(t,e,a){"use strict";a.r(e),a.d(e,{__esModule:function(){return r.X},default:function(){return o}});var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"toggle-display"},[a("div",{directives:[{name:"show",rawName:"v-show",value:t.isOpen,expression:"isOpen"}]},[t._t("default")],2),t._v(" "),a("bk-form-item",{staticStyle:{"margin-top":"-10px"},attrs:{label:" "}},[a("div",{staticClass:"action",on:{click:t.handleToggle}},[t.isOpen?[a("Icon",{staticClass:"toggle-arrow",attrs:{type:"angle-double-up"}}),t._v(" "),a("span",[t._v(t._s("收起更多设置"))])]:[a("Icon",{staticClass:"toggle-arrow",attrs:{type:"angle-double-down"}}),t._v(" "),a("span",[t._v(t._s("展开更多设置"))])]],2)])],1)};i._withStripped=!0;var r=a(84852),s=r.Z,n=(a(13516),(0,a(51900).Z)(s,i,[],!1,null,"d5d452ba",null));n.options.__file="src/views/task-manage/template-operation/components/toggle-display.vue";var o=n.exports},18500:function(t,e,a){"use strict";a.r(e),a.d(e,{__esModule:function(){return r.X},default:function(){return o}});var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"template-operation",attrs:{id:"templateOperation"}},[a("div",{staticClass:"layout-left"},[a("scroll-faker",{ref:"contentScroll"},[a("div",{staticClass:"template-container"},[a("smart-action",{attrs:{"offset-target":"bk-form-content"},scopedSlots:t._u([{key:"action",fn:function(){return[a("bk-button",{directives:[{name:"test",rawName:"v-test",value:{type:"button",value:"operationTemplateSubmit"},expression:"{ type: 'button', value: 'operationTemplateSubmit' }"}],staticClass:"w120 mr10",attrs:{theme:"primary",loading:t.isSubmiting},on:{click:t.handlerSubmit}},[t._v("\n                            "+t._s(t.submitText)+"\n                        ")]),t._v(" "),a("bk-button",{directives:[{name:"test",rawName:"v-test",value:{type:"button",value:"operationTemplateCancel"},expression:"{ type: 'button', value: 'operationTemplateCancel' }"}],on:{click:t.handleCancel}},[t._v("\n                            "+t._s("取消")+"\n                        ")])]},proxy:!0}])},[a("jb-form",{directives:[{name:"test",rawName:"v-test",value:{type:"form",value:"template"},expression:"{ type: 'form', value: 'template' }"}],ref:"templateOperateRef",attrs:{model:t.formData,rules:t.rules}},[a("bk-alert",{staticClass:"info",attrs:{title:"「对作业模板的修改不会立即自动更新执行方案，需要由用户手动触发」"}}),t._v(" "),a("jb-form-item",{attrs:{label:"模板名称",required:"",property:"name"}},[a("jb-input",{staticClass:"input form-item-content",attrs:{placeholder:"输入作业模板名称",maxlength:60},model:{value:t.formData.name,callback:function(e){t.$set(t.formData,"name",e)},expression:"formData.name"}})],1),t._v(" "),a("toggle-display",{staticStyle:{"margin-bottom":"20px"}},[a("jb-form-item",{attrs:{label:"场景标签",property:"tags"}},[a("jb-tag-select",{staticClass:"input form-item-content",attrs:{placeholder:"标签对资源的分类管理有很大帮助"},model:{value:t.formData.tags,callback:function(e){t.$set(t.formData,"tags",e)},expression:"formData.tags"}})],1),t._v(" "),a("jb-form-item",{attrs:{label:"模板描述"}},[a("bk-input",{staticClass:"template-desc-textarea form-item-content",attrs:{type:"textarea",maxlength:500,placeholder:"填写该模板的功能介绍等详细描述..."},model:{value:t.formData.description,callback:function(e){t.$set(t.formData,"description",e)},expression:"formData.description"}})],1)],1),t._v(" "),a("jb-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{label:"全局变量"}},[a("render-global-var",{attrs:{list:t.formData.variables,mode:"operate"},on:{"on-change":t.handleGlobalVariableChange}})],1),t._v(" "),a("jb-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{label:"作业步骤",required:"",property:"steps"}},[a("render-task-step",{ref:"step",attrs:{list:t.formData.steps,variable:t.formData.variables,mode:"operation"},on:{"on-change":t.handleTaskStepChange}})],1)],1)],1)],1)]),t._v(" "),a("back-top",{attrs:{target:t.getScrollParent}})],1),t._v(" "),a("div",{staticClass:"layout-right",attrs:{id:"templateOperationLayoutRight"}})])};i._withStripped=!0;var r=a(14043),s=r.Z,n=(a(69648),(0,a(51900).Z)(s,i,[],!1,null,null,null));n.options.__file="src/views/task-manage/template-operation/index.vue";var o=n.exports},13516:function(t,e,a){var i=a(47640);i.__esModule&&(i=i.default),"string"==typeof i&&(i=[[t.id,i,""]]),i.locals&&(t.exports=i.locals);(0,a(18086).Z)("19e6a0fa",i,!1,{})},69648:function(t,e,a){var i=a(62195);i.__esModule&&(i=i.default),"string"==typeof i&&(i=[[t.id,i,""]]),i.locals&&(t.exports=i.locals);(0,a(18086).Z)("6a1bc304",i,!1,{})}}]);