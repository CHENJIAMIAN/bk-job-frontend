(self.webpackChunkjob=self.webpackChunkjob||[]).push([[6401],{44442:function(t,e,a){"use strict";var s=a(22696);Object.defineProperty(e,"X",{value:!0}),e.Z=void 0,a(45974),a(87033),a(61026),a(60259),a(57024),a(35948),a(94522),a(7170),a(39677),a(77036),a(71959);var l=s(a(15399)),n=s(a(67713)),i=s(a(84484)),r=s(a(41641)),o=s(a(15621)),u=s(a(4027)),m=a(61681),d=a(41980),c=s(a(40515)),p=s(a(14617)),f={name:"",components:{BackTop:r.default,DetailLayout:o.default,DetailItem:u.default,RenderGlobalVar:c.default,RenderTaskStep:p.default},data:()=>({formData:{id:0,name:"",enableSteps:[],templateId:0,variables:[]},planFormData:{name:""},variableList:[],taskStepList:[],isLoading:!0,isShowSave:!1,isPlanCreating:!1}),computed:{isSkeletonLoading(){return this.isLoading},selectedVariable(){var t=this,e=this.taskStepList.filter((function(e){return t.formData.enableSteps.includes(e.id)}));return(0,d.findUsedVariable)(e)},hasSelectAll(){return this.formData.enableSteps.length>=this.taskStepList.length},enableStepsNotEmpty(){return this.formData.enableSteps.length>0}},created(){this.formData.templateId=Number(this.$route.params.id),this.fetchData(),this.rules={name:[{required:!0,message:l.default.t("template.方案名称必填"),trigger:"blur"},{validator:m.planNameRule.validator,message:m.planNameRule.message,trigger:"blur"},{validator:this.checkName,message:l.default.t("template.方案名称已存在，请重新输入"),trigger:"blur"}]}},methods:{fetchData(){var t=this;i.default.fetchDebugInfo({templateId:this.formData.templateId}).then((function(e){t.variableList=Object.freeze(e.variableList),t.taskStepList=Object.freeze(e.stepList),t.formData.name=e.name,t.formData.id=e.id,t.formData.enableSteps=e.stepList.map((function(t){return t.id})),t.formData.variables=e.variableList})).catch((function(e){[1243027,400].includes(e.code)&&setTimeout((function(){t.$router.push({name:"taskList"})}),3e3)})).finally((function(){t.isLoading=!1}))},taskExecution(){var t=this;this.isExecuting=!0,n.default.taskExecution({taskId:this.formData.id,taskVariables:[]}).then((function(e){var a=e.taskInstanceId;t.$bkMessage({theme:"success",message:l.default.t("template.操作成功")}),t.$router.push({name:"historyTask",params:{id:a}})})).finally((function(){t.isExecuting=!1}))},checkName(t){return i.default.planCheckName({templateId:this.formData.templateId,planId:this.formData.id,name:t})},handleSelectStep(t){var e=this.formData.enableSteps.findIndex((function(e){return e===t.id}));e>-1?this.formData.enableSteps.splice(e,1):this.formData.enableSteps.push(t.id)},handleSelectAll(){this.formData.enableSteps=this.taskStepList.map((function(t){return t.id}))},handleDeselectAll(){this.formData.enableSteps=[]},handleSubmitExec(){var t=this;this.isExecuting=!0,i.default.planUpdate(this.formData).then((function(){t.variableList.length<1?t.$bkInfo({title:l.default.t("template.确认执行？"),subTitle:l.default.t("template.未设置全局变量，点击确认将直接执行。"),confirmFn:function(){t.taskExecution()}}):t.$router.push({name:"settingVariable",params:{id:t.formData.id,templateId:t.formData.templateId,debug:1},query:{from:"debugPlan"}})})).finally((function(){t.isExecuting=!1}))},handleSavePlan(){this.isShowSave=!0},handleCloseSave(){this.isShowSave=!1,this.planFormData.name=""},handleEnter(t,e){e.isComposing||13===e.keyCode&&this.handleSubmitCreatePlan()},handleSubmitCreatePlan(){var t=this;this.$createElement;this.isPlanCreating=!0,this.$refs.editPlanForm.validate().then((function(){var e;return i.default.planUpdate({id:0,name:t.planFormData.name,templateId:t.formData.templateId,enableSteps:(e=t.formData.enableSteps.reduce((function(t,e){return t[e]=!0,t}),{}),t.taskStepList.reduce((function(t,a){return e[a.id]&&t.push(a.templateStepId),t}),[])),variables:t.formData.variables}).then((function(e){window.changeAlert=!1,t.isShowSave=!1,t.planFormData.name="";var a=null,s=function(){a.close()},n=function(){a.close(),t.$router.push({name:"viewPlan",params:{templateId:t.formData.templateId},query:{viewPlanId:e,from:"debugPlan"}})};a=t.$bkInfo({type:"success",title:l.default.t("template.另存执行方案成功"),showFooter:!1,subHeader:function(){var e=t.$createElement;return e("div",[e("bk-button",{style:{marginRight:"10px"},attrs:{text:!0},on:{click:s}},[l.default.t("template.返回继续调试")]),e("bk-button",{attrs:{text:!0},on:{click:n}},[l.default.t("template.立即前往查看")])])}()})}))})).finally((function(){t.isPlanCreating=!1}))},handleCancle(){this.routerBack()},routerBack(){"taskList"!==this.$route.query.from?this.$router.push({name:"templateDetail",params:{id:this.formData.templateId}}):this.$router.push({name:"taskList"})}}};e.Z=f},50204:function(){},96401:function(t,e,a){"use strict";a.r(e),a.d(e,{__esModule:function(){return l.X},default:function(){return r}});var s=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",[a("smart-action",{staticClass:"edit-execute-plan",attrs:{"offset-target":"detail-content"},scopedSlots:t._u([{key:"action",fn:function(){return[a("div",{staticClass:"action-wraper"},[a("bk-button",{staticClass:"w120 mr10",attrs:{theme:"primary",disabled:!t.enableStepsNotEmpty},on:{click:t.handleSubmitExec}},[t._v("\n                    "+t._s(t.$t("template.去执行"))+"\n                ")]),t._v(" "),a("bk-button",{on:{click:t.handleCancle}},[t._v(t._s(t.$t("template.取消")))]),t._v(" "),a("bk-button",{staticClass:"plan-save",attrs:{disabled:!t.enableStepsNotEmpty},on:{click:t.handleSavePlan}},[t._v("\n                    "+t._s(t.$t("template.另存为"))+"\n                ")])],1)]},proxy:!0}])},[a("detail-layout",{attrs:{mode:"see"}},[a("detail-item",{staticClass:"gloval-var-item",attrs:{label:t.$t("template.全局变量：")}},[a("render-global-var",{attrs:{list:t.variableList,"select-value":t.selectedVariable,mode:"editOfPlan"}})],1),t._v(" "),a("detail-item",{staticClass:"task-step-item",attrs:{label:""}},[a("div",{staticClass:"task-step-selection"},[a("div",[t._v(t._s(t.$t("template.选择要调试的步骤"))+"（ "+t._s(t.formData.enableSteps.length)+" / "+t._s(t.taskStepList.length)+" ）")]),t._v(" "),a("div",{staticClass:"step-check"},[t.hasSelectAll?a("bk-button",{attrs:{text:""},on:{click:t.handleDeselectAll}},[t._v("\n                            "+t._s(t.$t("template.取消全选"))+"\n                        ")]):a("bk-button",{attrs:{text:""},on:{click:t.handleSelectAll}},[t._v("\n                            "+t._s(t.$t("template.全选"))+"\n                        ")])],1)]),t._v(" "),a("render-task-step",{attrs:{list:t.taskStepList,"select-value":t.formData.enableSteps,mode:"select"},on:{"on-select":t.handleSelectStep}})],1)],1)],1),t._v(" "),a("back-top"),t._v(" "),a("jb-dialog",{staticClass:"save-debug-plan-dialog",attrs:{title:t.$t("template.另存为执行方案"),"header-position":"left","render-directive":"if","mask-close":!1,"esc-close":!1,width:480},model:{value:t.isShowSave,callback:function(e){t.isShowSave=e},expression:"isShowSave"}},[a("jb-form",{ref:"editPlanForm",attrs:{model:t.planFormData,"form-type":"vertical",rules:t.rules}},[a("jb-form-item",{attrs:{label:t.$t("template.执行方案名称"),required:"",property:"name"}},[a("bk-input",{attrs:{"native-attributes":{autofocus:"autofocus"},placeholder:t.$t("template.请输入执行方案名称")},on:{keydown:t.handleEnter},model:{value:t.planFormData.name,callback:function(e){t.$set(t.planFormData,"name",e)},expression:"planFormData.name"}})],1)],1),t._v(" "),a("div",{staticClass:"setting-password-footer",attrs:{slot:"footer"},slot:"footer"},[a("bk-button",{staticClass:"mr10",attrs:{theme:"primary",loading:t.isPlanCreating},on:{click:t.handleSubmitCreatePlan}},[t._v("\n                "+t._s(t.$t("template.确定"))+"\n            ")]),t._v(" "),a("bk-button",{on:{click:t.handleCloseSave}},[t._v(t._s(t.$t("template.取消")))])],1)],1)],1)};s._withStripped=!0;var l=a(44442),n=l.Z,i=(a(47968),(0,a(35471).Z)(n,s,[],!1,null,null,null));i.options.__file="src/views/task-manage/debug-plan/index.vue";var r=i.exports},47968:function(t,e,a){var s=a(50204);s.__esModule&&(s=s.default),"string"==typeof s&&(s=[[t.id,s,""]]),s.locals&&(t.exports=s.locals);(0,a(13570).Z)("52399944",s,!1,{})}}]);