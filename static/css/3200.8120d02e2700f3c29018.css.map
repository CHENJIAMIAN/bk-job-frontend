{"version":3,"file":"static/css/3200.8120d02e2700f3c29018.css","mappings":"AAiIA,qCAEA,mBADA,WAEA,CCsUA,gCACA,GACA,mBACA,CAEA,GACA,uBACA,CACA,CAGA,4CACA,WASA,CAPA,kEAKA,kDAHA,aAEA,YAHA,kBAEA,UAGA","sources":["webpack://job/./src/views/ticket-manage/list/components/related-ticket.vue","webpack://job/./src/views/ticket-manage/list/index.vue"],"sourcesContent":["<template>\n    <div class=\"related-ticket\">\n        <jb-search-select\n            ref=\"search\"\n            class=\"search-select-style\"\n            @on-change=\"handleSearch\"\n            :parse-url=\"false\"\n            :data=\"searchSelect\"\n            :placeholder=\"'搜索文件源别名...'\" />\n        <render-list\n            ref=\"fileSourcelist\"\n            :data-source=\"fetchFileSourceList\"\n            :search-control=\"() => $refs.search\">\n            <bk-table-column width=\"60\">\n                <template slot-scope=\"{ row }\">\n                    <span v-html=\"row.publicFlagHtml\" />\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                :label=\"'文件源别名'\"\n                sortable\n                align=\"left\"\n                show-overflow-tooltip>\n                <template slot-scope=\"{ row }\">\n                    <auth-router-link\n                        v-if=\"row.isAvailable\"\n                        auth=\"file_source/view\"\n                        :permission=\"row.canView\"\n                        :resource-id=\"row.id\"\n                        :to=\"{\n                            name: 'fileList',\n                            query: {\n                                fileSourceId: 4 || row.id,\n                            },\n                        }\"\n                        target=\"_blank\">\n                        {{ row.alias }}\n                    </auth-router-link>\n                    <span\n                        v-else\n                        v-bk-tooltips=\"'接入点异常，暂时不可用'\">\n                        <bk-button disabled text>{{ row.alias }}</bk-button>\n                    </span>\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                :label=\"'文件源标识'\"\n                sortable\n                align=\"left\"\n                width=\"160\"\n                show-overflow-tooltip\n                prop=\"code\" />\n            <bk-table-column\n                width=\"80\"\n                :label=\"'状态'\">\n                <template slot-scope=\"{ row }\">\n                    <Icon :type=\"row.statusIcon\" svg />\n                    {{ row.statusText }}\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                width=\"120\"\n                :label=\"'更新人'\"\n                prop=\"lastModifyUser\" />\n            <bk-table-column\n                width=\"180\"\n                :label=\"'更新时间'\"\n                prop=\"lastModifyTime\" />\n        </render-list>\n    </div>\n</template>\n<script>\n       import FileManageService from '@service/file-source-manage';\n    import JbSearchSelect from '@components/jb-search-select';\n    import RenderList from '@components/render-list';\n\n    export default {\n        name: 'RelatedTicket',\n        components: {\n            JbSearchSelect,\n            RenderList,\n        },\n        props: {\n            credentialId: {\n                type: String,\n            },\n        },\n        data () {\n            return {\n                sourceFileList: [{},{},{}],\n            };\n        },\n        mounted () {\n            this.fetchData();\n        },\n        created () {\n            this.fetchFileSourceList = FileManageService.fetchFileSourceList;\n            this.searchSelect = [\n                {\n                    name: '文件源别名',\n                    id: 'alias',\n                },\n            ];\n        },\n        methods: {\n            /**\n             * @desc 获取被引用文件源列表\n             */\n            fetchData () {\n                this.$refs.fileSourcelist.$emit('onFetch', {\n                    ...this.searchParams,\n                    credentialId: this.credentialId,\n                });\n            },\n            /**\n             * @desc 过滤表格数据\n             * @param {Array} payload 用户输入的过滤数据\n             *\n             * 重新拉取数据\n             */\n            handleSearch (payload) {\n                this.searchParams = payload;\n                this.fetchData();\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .related-ticket {\n        .search-select-style {\n            width: 480px;\n            margin-bottom: 20px;\n        }\n    }\n</style>\n","<template>\n    <div class=\"ticket-manage-page\" v-bkloading=\"{ isLoading }\">\n        <list-action-layout>\n            <auth-button\n                theme=\"primary\"\n                auth=\"ticket/create\"\n                @click=\"handleCreate\"\n                class=\"w120\"\n                v-test=\"{ type: 'button', value: 'createTicket' }\">\n                {{ '新建' }}\n            </auth-button>\n            <template #right>\n                <jb-search-select\n                    ref=\"search\"\n                    @on-change=\"handleSearch\"\n                    :data=\"searchSelect\"\n                    :placeholder=\"'搜索 ID、名称、描述、创建人、更新人...'\"\n                    style=\"width: 480px;\" />\n            </template>\n        </list-action-layout>\n        <render-list\n            ref=\"list\"\n            :data-source=\"getTicketList\"\n            :size=\"tableSize\"\n            :search-control=\"() => $refs.search\"\n            v-test=\"{ type: 'list', value: 'ticket' }\">\n            <bk-table-column\n                v-if=\"allRenderColumnMap.id\"\n                :label=\"'凭证ID'\"\n                width=\"300\"\n                prop=\"id\"\n                key=\"id\"\n                align=\"left\">\n                <template slot-scope=\"{ row }\">\n                    <span>{{ row.id }}</span>\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                :label=\"'凭证名称'\"\n                sortable\n                prop=\"name\"\n                key=\"name\"\n                align=\"left\"\n                min-width=\"200\"\n                show-overflow-tooltip>\n                <template slot-scope=\"{ row }\">\n                    <span class=\"ticket-name\">{{ row.name }}</span>\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                :label=\"'类型'\"\n                prop=\"type\"\n                key=\"type\"\n                align=\"left\"\n                width=\"180\"\n                :filters=\"sourceFilters\"\n                :filter-method=\"handelFilterType\">\n                <template slot-scope=\"{ row }\">\n                    <span>{{ typeMap[row.type] }}</span>\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                v-if=\"allRenderColumnMap.description\"\n                :label=\"'描述'\"\n                prop=\"description\"\n                key=\"description\"\n                min-width=\"150\"\n                align=\"left\">\n                <template slot-scope=\"{ row }\">\n                    <span>{{ row.description }}</span>\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                v-if=\"allRenderColumnMap.related\"\n                :label=\"'被引用'\"\n                prop=\"related\"\n                key=\"related\"\n                width=\"100\"\n                align=\"right\">\n                <template slot-scope=\"{ row }\">\n                    <div\n                        v-if=\"row.isRelatedLoading\"\n                        class=\"sync-fetch-relate-nums\">\n                        <div class=\"related-nums-loading\">\n                            <Icon\n                                type=\"sync-pending\"\n                                svg\n                                style=\"color: #3a84ff;\" />\n                        </div>\n                    </div>\n                    <bk-button\n                        v-else\n                        text\n                        @click=\"handleShowRelated(row.id)\">\n                        {{ row.relatedNums }}\n                    </bk-button>\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                v-if=\"allRenderColumnMap.creator\"\n                :label=\"'创建人'\"\n                width=\"120\"\n                prop=\"creator\"\n                key=\"creator\"\n                align=\"left\" />\n            <bk-table-column\n                v-if=\"allRenderColumnMap.createTime\"\n                :label=\"'创建时间'\"\n                prop=\"createTime\"\n                key=\"createTime\"\n                width=\"180\"\n                align=\"left\" />\n            <bk-table-column\n                v-if=\"allRenderColumnMap.lastModifyUser\"\n                :label=\"'更新人'\"\n                prop=\"lastModifyUser\"\n                key=\"lastModifyUser\"\n                width=\"120\"\n                align=\"left\" />\n            <bk-table-column\n                v-if=\"allRenderColumnMap.lastModifyTime\"\n                :label=\"'更新时间'\"\n                prop=\"lastModifyTime\"\n                key=\"lastModifyTime\"\n                width=\"180\"\n                align=\"left\" />\n            <bk-table-column\n                :label=\"'操作'\"\n                :resizable=\"false\"\n                key=\"action\"\n                fixed=\"right\"\n                width=\"100\"\n                align=\"left\">\n                <template slot-scope=\"{ row }\">\n                    <auth-button\n                        auth=\"ticket/edit\"\n                        :resource-id=\"row.id\"\n                        :permission=\"row.canManage\"\n                        text\n                        class=\"mr10\"\n                        @click=\"handleEdit(row)\"\n                        v-test=\"{ type: 'list', value: 'editTicket' }\">\n                        {{ '编辑' }}\n                    </auth-button>\n                    <jb-popover-confirm\n                        :title=\"'确定删除该凭证？'\"\n                        :content=\"'正在被文件源使用的凭证无法删除，如需删除请先解除引用关系。'\"\n                        :confirm-handler=\"() => handleDelete(row.id)\">\n                        <auth-button\n                            auth=\"ticket/edit\"\n                            :permission=\"row.canManage\"\n                            :resource-id=\"row.id\"\n                            text\n                            v-test=\"{ type: 'list', value: 'deleteTicket' }\">\n                            {{ '删除' }}\n                        </auth-button>\n                    </jb-popover-confirm>\n                </template>\n            </bk-table-column>\n            <bk-table-column type=\"setting\">\n                <bk-table-setting-content\n                    :fields=\"tableColumn\"\n                    :selected=\"selectedTableColumn\"\n                    :size=\"tableSize\"\n                    @setting-change=\"handleSettingChange\" />\n            </bk-table-column>\n        </render-list>\n        <jb-sideslider\n            :is-show.sync=\"showRelatedSideslider\"\n            :show-footer=\"false\"\n            :width=\"900\"\n            :title=\"'被引用'\">\n            <related-ticket\n                :credential-id=\"credentialId\" />\n        </jb-sideslider>\n        <jb-sideslider\n            :is-show.sync=\"showOpertionSideslider\"\n            :width=\"600\"\n            v-bind=\"operationSidesliderInfo\">\n            <ticket-opertion\n                :data=\"ticketDetailInfo\"\n                @on-change=\"handleChange\" />\n        </jb-sideslider>\n    </div>\n</template>\n<script>\n       import TicketService from '@service/ticket-manage';\n    import NotifyService from '@service/notify';\n    import { listColumnsCache } from '@utils/cache-helper';\n    import RenderList from '@components/render-list';\n    import JbSearchSelect from '@components/jb-search-select';\n    import JbPopoverConfirm from '@components/jb-popover-confirm';\n    import ListActionLayout from '@components/list-action-layout';\n    import RelatedTicket from './components/related-ticket';\n    import TicketOpertion from './components/opertion';\n\n    const TABLE_COLUMN_CACHE = 'ticket_list_columns';\n\n    export default {\n        name: 'TicketList',\n        components: {\n            ListActionLayout,\n            JbSearchSelect,\n            RenderList,\n            TicketOpertion,\n            JbPopoverConfirm,\n            RelatedTicket,\n        },\n        data () {\n            return {\n                isLoading: false,\n                tableSize: 'small',\n                selectedTableColumn: [],\n                searchParams: {},\n                showRelatedSideslider: false,\n                showOpertionSideslider: false,\n                ticketDetailInfo: {},\n                credentialId: 0,\n                relatedNum: [],\n            };\n        },\n        computed: {\n            isSkeletonLoading () {\n                return this.isLoading;\n            },\n            allRenderColumnMap () {\n                return this.selectedTableColumn.reduce((result, item) => {\n                    result[item.id] = true;\n                    return result;\n                }, {});\n            },\n            operationSidesliderInfo () {\n                if (!this.ticketDetailInfo.id) {\n                    return {\n                        title: '新建凭证',\n                        okText: '提交',\n                        \n                    };\n                }\n                return {\n                    title: '编辑凭证',\n                    okText: '保存',\n                };\n            },\n        },\n        created () {\n            this.getTicketList = TicketService.fetchListWithRelate;\n            this.sourceFilters = [\n                {\n                    value: 'APP_ID_SECRET_KEY',\n                    text: 'AppID+SecretKey',\n                },\n                {\n                    value: 'PASSWORD',\n                    text: '单一密码',\n                },\n                {\n                    value: 'USERNAME_PASSWORD',\n                    text: '用户名+密码',\n                },\n                {\n                    value: 'SECRET_KEY',\n                    text: '单一SecretKey',\n                },\n            ];\n            this.searchSelect = [\n                {\n                    id: 'id',\n                    name: 'ID',\n                    description: '将覆盖其它条件',\n                },\n                {\n                    id: 'name',\n                    name: '名称',\n                    default: true,\n                },\n                {\n                    name: '描述',\n                    id: 'description',\n                },\n                {\n                    name: '创建人',\n                    id: 'creator',\n                    remoteMethod: NotifyService.fetchUsersOfSearch,\n                    inputInclude: true,\n                },\n                {\n                    name: '更新人',\n                    id: 'lastModifyUser',\n                    remoteMethod: NotifyService.fetchUsersOfSearch,\n                    inputInclude: true,\n                },\n            ];\n            this.tableColumn = [\n                {\n                    id: 'id',\n                    label: '凭证ID',\n                },\n                {\n                    id: 'name',\n                    label: '名称',\n                    disabled: true,\n                },\n                {\n                    id: 'type',\n                    label: '类型',\n                    disabled: true,\n                },\n                {\n                    id: 'description',\n                    label: '描述',\n                },\n                {\n                    id: 'related',\n                    label: '被引用',\n                },\n                {\n                    id: 'creator',\n                    label: '创建人',\n                },\n                {\n                    id: 'createTime',\n                    label: '创建时间',\n                },\n                {\n                    id: 'lastModifyUser',\n                    label: '更新人',\n                },\n                {\n                    id: 'lastModifyTime',\n                    label: '更新时间',\n                },\n            ];\n            this.typeMap = {\n                APP_ID_SECRET_KEY: 'AppID+SecretKey',\n                PASSWORD: '单一密码',\n                USERNAME_PASSWORD: '用户名+密码',\n                SECRET_KEY: '单一SecretKey',\n            };\n\n            const columnsCache = listColumnsCache.getItem(TABLE_COLUMN_CACHE);\n            if (columnsCache) {\n                this.selectedTableColumn = Object.freeze(columnsCache.columns);\n                this.tableSize = columnsCache.size;\n            } else {\n                this.selectedTableColumn = Object.freeze([\n                    { id: 'id' },\n                    { id: 'name' },\n                    { id: 'type' },\n                    { id: 'description' },\n                    { id: 'related' },\n                    { id: 'lastModifyUser' },\n                    { id: 'lastModifyTime' },\n                ]);\n            }\n        },\n        methods: {\n\n            /**\n             * @desc 获取凭证数据列表\n             */\n            fetchData () {\n                this.$refs.list.$emit('onFetch', {\n                    ...this.searchParams,\n                });\n            },\n\n            /**\n             * @desc 新建凭证\n             *\n             * 显示新建凭证模板\n             */\n            handleCreate () {\n                this.showOpertionSideslider = true;\n                this.ticketDetailInfo = {};\n            },\n\n            /**\n             * @desc 查看被引用模板\n             * @param {Number} id 凭证id\n             *\n             * 显示被引用模板详情\n             */\n            handleShowRelated (id) {\n                this.credentialId = id;\n                this.showRelatedSideslider = true;\n            },\n\n            /**\n             * @desc 过滤表格数据\n             * @param {Object} searchParams 用户输入的过滤数据\n             *\n             * 重新拉取数据\n             */\n            handleSearch (searchParams) {\n                this.searchParams = searchParams;\n                this.fetchData();\n            },\n\n            /**\n             * @desc 设置表格显示列/表格size\n             */\n            handleSettingChange ({ fields, size }) {\n                this.selectedTableColumn = Object.freeze(fields);\n                this.tableSize = size;\n                listColumnsCache.setItem(TABLE_COLUMN_CACHE, {\n                    columns: fields,\n                    size,\n                });\n            },\n\n            /**\n             * @desc 新建、编辑凭证成功\n             *\n             * 重新拉取列表数据\n             */\n            handleChange () {\n                this.fetchData();\n                this.relatedNum = [];\n                this.fetchCitedNum();\n            },\n\n            handelFilterType (value, row, column) {\n                const { property } = column;\n                return row[property] === value;\n            },\n\n            /**\n             * @desc 编辑凭证数据\n             * @param {Object} payload 选中凭证的详细数据\n             *\n             * 显示编辑凭证数据模板\n             */\n            handleEdit (payload) {\n                this.ticketDetailInfo = payload;\n                this.showOpertionSideslider = true;\n            },\n\n            /**\n             * @desc 删除凭证\n             * @param {Number} id 凭证id\n             *\n             * 删除成功重新拉取列表数据\n             */\n            handleDelete (id) {\n                TicketService.remove({\n                    id,\n                }).then(() => {\n                    this.messageSuccess('删除成功');\n                    this.fetchData();\n                    this.relatedNum = [];\n                    this.fetchCitedNum();\n                });\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    @keyframes related-nums-loading {\n        0% {\n            transform: rotateZ(0);\n        }\n\n        100% {\n            transform: rotateZ(360deg);\n        }\n    }\n\n    .ticket-manage-page {\n        .sync-fetch-relate-nums {\n            height: 13px;\n\n            .related-nums-loading {\n                position: absolute;\n                display: flex;\n                width: 13px;\n                height: 13px;\n                animation: related-nums-loading 1s linear infinite;\n            }\n        }\n    }\n</style>\n"],"names":[],"sourceRoot":""}