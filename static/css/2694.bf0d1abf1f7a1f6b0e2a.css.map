{"version":3,"file":"static/css/2694.bf0d1abf1f7a1f6b0e2a.css","mappings":"AAoQA,oFACA,cACA,CAKA,uFACA,wBACA,CAGA,uEAEA,yBADA,cAEA,CAEA,gCAEA,mBACA,eAFA,YASA,CAJA,oDACA,aACA,CAIA,kCACA,aACA,CAEA,0CAQA,sBAPA,qBAGA,eACA,gBAFA,YAGA,iBACA,kBALA,UAOA,CAEA,6BAEA,yBADA,aAEA,CAEA,8BAEA,sBADA,aAEA,CAEA,4BAEA,yBADA,aAEA,CAEA,8BACA,wBACA,CAEA,mDACA,aACA","sources":["webpack://job/./src/views/service-state/list/index.vue"],"sourcesContent":["\r\n\r\n<template>\r\n    <div class=\"service-state-info\" v-bkloading=\"{ isLoading }\">\r\n        <bk-table\r\n            :data=\"serviceData\"\r\n            :size=\"tableSize\"\r\n            row-key=\"name\"\r\n            ext-cls=\"service-table\"\r\n            :expand-row-keys=\"expandRow\"\r\n            @row-click=\"toggleRowExpansion\">\r\n            <bk-table-column\r\n                type=\"expand\"\r\n                key=\"expand\"\r\n                :before-expand-change=\"onBeforeExpandChange\">\r\n                <template slot-scope=\"{ row }\">\r\n                    <bk-table\r\n                        ext-cls=\"service-expand-table\"\r\n                        :data=\"row.instanceList\"\r\n                        :outer-border=\"false\"\r\n                        :header-border=\"false\">\r\n                        <bk-table-column\r\n                            key=\"index\"\r\n                            width=\"60\"\r\n                            :label=\"$t('service.序号.colHead')\">\r\n                            <template slot-scope=\"{ $index }\">\r\n                                #{{ $index + 1 }}\r\n                            </template>\r\n                        </bk-table-column>\r\n                        <bk-table-column\r\n                            prop=\"name\"\r\n                            key=\"name\"\r\n                            width=\"420\"\r\n                            :label=\"$t('service.实例名.colHead')\">\r\n                            <template slot-scope=\"scope\">\r\n                                {{ scope.row.name }}\r\n                            </template>\r\n                        </bk-table-column>\r\n                        <bk-table-column\r\n                            prop=\"version\"\r\n                            key=\"version\"\r\n                            width=\"310\"\r\n                            :label=\"$t('service.版本号.label')\" />\r\n                        <bk-table-column\r\n                            prop=\"status\"\r\n                            key=\"status\"\r\n                            :label=\"$t('service.状态.colHead')\">\r\n                            <template slot-scope=\"scope\">\r\n                                <Icon :type=\"statusIcon(scope.row)\" svg />\r\n                                <span v-html=\"statusHtml(scope.row)\" />\r\n                            </template>\r\n                        </bk-table-column>\r\n                        <bk-table-column\r\n                            prop=\"ip\"\r\n                            key=\"ip\"\r\n                            width=\"150\"\r\n                            :label=\"$t('service.绑定IP.colHead')\">\r\n                            <template slot-scope=\"scope\">\r\n                                <span class=\"service-ip\" @click=\"handleCopyIp(scope.row.ip)\">\r\n                                    {{ scope.row.ip }}\r\n                                    <Icon class=\"ml5 copy-ip-icon\" type=\"step-copy\" svg />\r\n                                    <!-- <Icon class=\"skip-icon\" type=\"edit\" svg /> -->\r\n                                </span>\r\n                            </template>\r\n                        </bk-table-column>\r\n                        <bk-table-column\r\n                            prop=\"port\"\r\n                            key=\"port\"\r\n                            width=\"100\"\r\n                            :label=\"$t('service.端口.colHead')\" />\r\n                    </bk-table>\r\n                </template>\r\n            </bk-table-column>\r\n            <bk-table-column\r\n                :label=\"$t('service.服务名.colHead')\"\r\n                prop=\"name\"\r\n                width=\"480\"\r\n                key=\"name\"\r\n                align=\"left\" />\r\n            <bk-table-column\r\n                :label=\"$t('service.版本号.colHead')\"\r\n                prop=\"version\"\r\n                width=\"310\"\r\n                key=\"version\"\r\n                align=\"left\">\r\n                <template slot-scope=\"{ row }\">\r\n                    <span v-html=\"row.versionHtml\" />\r\n                </template>\r\n            </bk-table-column>\r\n            <bk-table-column\r\n                :label=\"$t('service.实例状态.colHead')\"\r\n                prop=\"instanceList\"\r\n                key=\"instanceList\"\r\n                align=\"left\">\r\n                <template slot-scope=\"{ row }\">\r\n                    <div v-bk-tooltips=\"instanceTips(row)\">\r\n                        <span class=\"service-instance-num abnormal\" v-if=\"row.abnormalNum\">{{ row.abnormalNum }}</span>\r\n                        <span class=\"service-instance-num unknown\" v-if=\"row.unknownNum\">{{ row.unknownNum }}</span>\r\n                        <span class=\"service-instance-num normal\" v-if=\"row.normalNum\">{{ row.normalNum }}</span>\r\n                    </div>\r\n                </template>\r\n            </bk-table-column>\r\n        </bk-table>\r\n    </div>\r\n</template>\r\n \r\n<script>\r\n    import I18n from '@/i18n';\r\n    import ServiceStateService from '@service/service-state';\r\n    import {\r\n        execCopy,\r\n    } from '@utils/assist';\r\n\r\n    export default {\r\n        name: 'Service',\r\n        data () {\r\n            return {\r\n                isLoading: false,\r\n                tableSize: 'small',\r\n                serviceData: [],\r\n                expandRow: [],\r\n                timer: null,\r\n                showFirstExpandRow: true,\r\n            };\r\n        },\r\n        computed: {\r\n            isSkeletonLoading () {\r\n                return this.isLoading;\r\n            },\r\n        },\r\n        created () {\r\n            this.fetchData();\r\n        },\r\n        destroyed () {\r\n            clearInterval(this.timer);\r\n        },\r\n        methods: {\r\n            /**\r\n             * @desc 获取服务运行状态数据,每三秒轮询一次\r\n             */\r\n            fetchData () {\r\n                ServiceStateService.serviceList({}, {\r\n                    permission: 'page',\r\n                })\r\n                    .then((data) => {\r\n                        if (data.length < 1) {\r\n                            return;\r\n                        }\r\n                        this.serviceData = Object.freeze(data);\r\n                        // 折叠表格默认展开第一个\r\n                        if (this.showFirstExpandRow) {\r\n                            this.expandRow.push(this.serviceData[0].name);\r\n                        }\r\n                        this.serviceData.forEach((service) => {\r\n                            let abnormalNum = 0;\r\n                            let normalNum = 0;\r\n                            let unknownNum = 0;\r\n                            service.instanceList.forEach((instance) => {\r\n                                if (instance.status === 1) {\r\n                                    normalNum += 1;\r\n                                } else if (instance.status === -1) {\r\n                                    unknownNum += 1;\r\n                                } else if (instance.status === 0) {\r\n                                    abnormalNum += 1;\r\n                                }\r\n                            });\r\n                            const statusMap = {\r\n                                abnormalNum,\r\n                                normalNum,\r\n                                unknownNum,\r\n                            };\r\n                            Object.assign(service, statusMap);\r\n                            this.showFirstExpandRow = false;\r\n                            clearInterval(this.timer);\r\n                            this.timer = setInterval(() => {\r\n                                this.fetchData();\r\n                            }, 3000);\r\n                        });\r\n                    })\r\n                    .finally(() => {\r\n                        this.isLoading = false;\r\n                    });\r\n            },\r\n\r\n            /**\r\n             * @desc 控制折叠表格只能展开一项\r\n             * @param {Object} row 表格当前行数据\r\n             */\r\n            toggleRowExpansion (row) {\r\n                if (this.expandRow.includes(row.name)) {\r\n                    this.expandRow = [];\r\n                } else {\r\n                    this.expandRow = [\r\n                        row.name,\r\n                    ];\r\n                }\r\n            },\r\n\r\n            /**\r\n             * @desc 控制折叠表格只能展开一项\r\n             * @param {Object} row 表格当前行数据\r\n             */\r\n            onBeforeExpandChange ({ row }) {\r\n                this.toggleRowExpansion(row);\r\n            },\r\n\r\n            /**\r\n             * @desc 自定义表格状态内容\r\n             */\r\n            statusHtml (row) {\r\n                const styles = 'color: #aaacb5';\r\n                const statusHtmlMap = {\r\n                    0: `<span>${I18n.t('异常')}<span style=\"${styles}\"> #SERVICE UNAVAILABLE (503)</span></span>`,\r\n                    1: `<span>${I18n.t('正常')}</span>`,\r\n                    '-1': `<span>${I18n.t('未知')}<span style=\"${styles}\"> #NO MAPPING</span></span>`,\r\n                };\r\n                return statusHtmlMap[row.status];\r\n            },\r\n\r\n            /**\r\n             * @desc 自定义表格状态图标\r\n             */\r\n            statusIcon (row) {\r\n                const statusIcomMap = {\r\n                    0: 'abnormal',\r\n                    1: 'normal',\r\n                    '-1': 'unknown',\r\n                };\r\n                return statusIcomMap[row.status];\r\n            },\r\n\r\n            /**\r\n             * @desc 自定义实例状态tooltips内容\r\n             */\r\n            instanceTips (row) {\r\n                let tipsStr = '';\r\n                if (row.abnormalNum) {\r\n                    tipsStr = `${I18n.t('异常')}: ${row.abnormalNum}`;\r\n                }\r\n                if (row.unknownNum) {\r\n                    tipsStr += ` ${I18n.t('未知')}: ${row.unknownNum}`;\r\n                }\r\n                if (row.normalNum) {\r\n                    tipsStr += ` ${I18n.t('正常')}: ${row.normalNum}`;\r\n                }\r\n                return { content: tipsStr, placement: 'top' };\r\n            },\r\n\r\n            /**\r\n             * @desc 复制IP\r\n             */\r\n            handleCopyIp (ip) {\r\n                execCopy(ip, `${I18n.t('复制成功')}`);\r\n            },\r\n        },\r\n    };\r\n</script>\r\n\r\n<style lang=\"postcss\">\r\n    .service-state-info {\r\n        .service-table > .bk-table-body-wrapper > table > tbody > .bk-table-row {\r\n            cursor: pointer;\r\n        }\r\n\r\n        .service-expand-table {\r\n            background-color: #fafbfd;\r\n\r\n            tr {\r\n                background-color: #fafbfd;\r\n            }\r\n        }\r\n\r\n        .bk-table .bk-table-body td.bk-table-expanded-cell {\r\n            padding: 0 48px;\r\n            background-color: #fafbfd;\r\n        }\r\n\r\n        .service-ip {\r\n            display: flex;\r\n            align-items: center;\r\n            cursor: pointer;\r\n\r\n            &:hover {\r\n                .copy-ip-icon {\r\n                    color: #3a84ff;\r\n                }\r\n            }\r\n        }\r\n\r\n        .copy-ip-icon {\r\n            color: #979ba5;\r\n        }\r\n\r\n        .service-instance-num {\r\n            display: inline-block;\r\n            width: 20px;\r\n            height: 20px;\r\n            font-size: 12px;\r\n            font-weight: 700;\r\n            line-height: 18px;\r\n            text-align: center;\r\n            border: 1px solid #fff;\r\n        }\r\n\r\n        .unknown {\r\n            color: #979ba5;\r\n            background-color: #e6e8f0;\r\n        }\r\n\r\n        .abnormal {\r\n            color: #ea3536;\r\n            background-color: #fdd;\r\n        }\r\n\r\n        .normal {\r\n            color: #14a568;\r\n            background-color: #dff0e4;\r\n        }\r\n\r\n        .expanded {\r\n            background-color: #f0f1f5;\r\n        }\r\n\r\n        .bk-table-expand-icon-expanded {\r\n            color: #979ba5;\r\n        }\r\n    }\r\n</style>\r\n"],"names":[],"sourceRoot":""}