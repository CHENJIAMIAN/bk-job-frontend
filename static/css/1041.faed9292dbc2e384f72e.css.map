{"version":3,"file":"static/css/1041.faed9292dbc2e384f72e.css","mappings":"AAwQA,uBACA,eAiEA,CA/DA,kCAGA,yBACA,kBAHA,aACA,qBAGA,CAEA,mCACA,aAoBA,CAjBA,kEACA,UASA,CAPA,6EACA,MACA,CAEA,iFACA,iBACA,CAIA,kDACA,mCACA,yCACA,CAGA,gCACA,wBAoBA,CAlBA,0CACA,aACA,qBASA,CAPA,oDACA,kBAKA,CAHA,+DACA,eACA,CAIA,8CAEA,eADA,gBAEA,qBACA,CAGA,mCAOA,mBACA,6BAHA,cACA,eAHA,eAFA,YAGA,iBAFA,iBAOA","sources":["webpack://job/./src/views/tag-manage/index/components/batch-edit-relate.vue"],"sourcesContent":["<template>\r\n    <div class=\"batch-edit-relate-box\" v-bkloading=\"{ isLoading }\">\r\n        <jb-form\r\n            ref=\"formRef\"\r\n            form-type=\"vertical\"\r\n            :model=\"formData\"\r\n            :rules=\"rules\">\r\n            <jb-form-item\r\n                :label=\"$t('tag.范围')\"\r\n                required\r\n                property=\"resourceTypeList\">\r\n                <bk-checkbox-group v-model=\"formData.resourceTypeList\">\r\n                    <bk-checkbox\r\n                        class=\"mr10\"\r\n                        :value=\"5\">\r\n                        {{ $t('tag.作业') }}（{{ data.relatedTaskTemplateNum }}）\r\n                    </bk-checkbox>\r\n                    <bk-checkbox :value=\"1\">\r\n                        {{ $t('tag.脚本') }}（{{ data.relatedScriptNum }}）\r\n                    </bk-checkbox>\r\n                </bk-checkbox-group>\r\n            </jb-form-item>\r\n            <jb-form-item\r\n                :label=\"$t('tag.标签')\"\r\n                style=\"margin-bottom: 0;\">\r\n                <div class=\"tag-panel\">\r\n                    <bk-input\r\n                        class=\"tag-search\"\r\n                        :value=\"search\"\r\n                        :spellcheck=\"false\"\r\n                        left-icon=\"bk-icon icon-search\"\r\n                        @change=\"handleSearch\" />\r\n                    <div class=\"wrapper\" style=\"height: 210px;\">\r\n                        <scroll-faker\r\n                            v-if=\"renderList.length > 0\"\r\n                            ref=\"scrollRef\">\r\n                            <bk-checkbox-group\r\n                                v-model=\"formData.operationList\"\r\n                                class=\"tag-list\">\r\n                                <bk-checkbox\r\n                                    v-for=\"tagItem in renderList\"\r\n                                    :value=\"tagItem.id\"\r\n                                    class=\"tag-item\"\r\n                                    :key=\"tagItem.id\">\r\n                                    {{ tagItem.name }}\r\n                                    <Icon\r\n                                        v-if=\"tagItem.isNew\"\r\n                                        type=\"new\"\r\n                                        svg\r\n                                        class=\"new-tag-flag\" />\r\n                                </bk-checkbox>\r\n                            </bk-checkbox-group>\r\n                        </scroll-faker>\r\n                        <Empty\r\n                            v-else-if=\"search\"\r\n                            type=\"search\"\r\n                            style=\"margin-top: 20px;\">\r\n                            <span>{{ $t('tag.搜索结果为空') }}，</span>\r\n                            <bk-button\r\n                                text\r\n                                @click=\"handleClearSearch\">\r\n                                {{ $t('tag.清空搜索') }}\r\n                            </bk-button>\r\n                        </Empty>\r\n                    </div>\r\n                    <auth-component auth=\"tag/create\">\r\n                        <div class=\"tag-create\" @click=\"handleNew\">\r\n                            <bk-icon\r\n                                type=\"plus-circle\"\r\n                                style=\" margin-right: 8px; font-size: 16px;\" />\r\n                            <span>{{ $t('tag.新建标签') }}</span>\r\n                        </div>\r\n                        <div slot=\"forbid\" class=\"tag-create\">\r\n                            <bk-icon\r\n                                type=\"plus-circle\"\r\n                                style=\" margin-right: 8px; font-size: 16px;\" />\r\n                            <span>{{ $t('tag.新建标签') }}</span>\r\n                        </div>\r\n                    </auth-component>\r\n                </div>\r\n            </jb-form-item>\r\n        </jb-form>\r\n        <lower-component\r\n            level=\"custom\"\r\n            :custom=\"isShowCreateTag\">\r\n            <operation-tag\r\n                v-model=\"isShowCreateTag\"\r\n                @on-change=\"handleTagOperationChange\" />\r\n        </lower-component>\r\n    </div>\r\n</template>\r\n<script>\r\n    import {\r\n        reactive,\r\n        computed,\r\n        ref,\r\n        toRefs,\r\n        onBeforeMount,\r\n        getCurrentInstance,\r\n    } from '@vue/composition-api';\r\n    import _ from 'lodash';\r\n    import I18n from '@/i18n';\r\n    import TagManageService from '@service/tag-manage';\r\n    import { encodeRegexp } from '@utils/assist';\r\n    import OperationTag from '@components/operation-tag';\r\n\r\n    export default {\r\n        name: '',\r\n        components: {\r\n            OperationTag,\r\n        },\r\n        props: {\r\n            data: {\r\n                type: Object,\r\n                required: true,\r\n            },\r\n        },\r\n        setup (props, ctx) {\r\n            const state = reactive({\r\n                isLoading: true,\r\n                isShowCreateTag: false,\r\n                newTagList: [{},{},{}],\r\n                wholeTagList: [{},{},{}],\r\n                search: '',\r\n                formData: {\r\n                    resourceTypeList: [1, 5],\r\n                    operationList: [{},{},{}],\r\n                },\r\n            });\r\n            // 默认选中的 tag\r\n            state.formData.operationList = [props.data.id];\r\n            const formRef = ref(null);\r\n            const scrollRef = ref(null);\r\n            const isSubmitDisable = computed(() => props.data.relatedTaskTemplateNum + props.data.relatedScriptNum < 1);\r\n            const { proxy } = getCurrentInstance();\r\n            // 表单验证规则\r\n            const rules = {\r\n                resourceTypeList: [\r\n                    {\r\n                        validator: resourceTypeList => resourceTypeList.length > 0,\r\n                        message: I18n.t('tag.范围不能为空'),\r\n                        trigger: 'blur',\r\n                    },\r\n                ],\r\n            };\r\n            // 展示的 tag 列表数据\r\n            const renderList = computed(() => {\r\n                const allTagList = [...state.newTagList, ...state.wholeTagList];\r\n                if (!state.search) {\r\n                    return allTagList;\r\n                }\r\n                const searchReg = new RegExp(encodeRegexp(state.search), 'i');\r\n                const result = allTagList.filter(item => searchReg.test(item.name));\r\n                return Object.freeze(result);\r\n            });\r\n            /**\r\n             * @desc 获取 tag 列表\r\n             */\r\n            const fetchData = () => {\r\n                proxy.$request(TagManageService.fetchWholeList(), () => {\r\n                    state.isLoading = true;\r\n                })\r\n                    .then((data) => {\r\n                        // 排序\r\n                        // 当前编辑的 tag 在最上面\r\n                        state.wholeTagList = Object.freeze(data.reduce((result, item) => {\r\n                            if (item.id === props.data.id) {\r\n                                result.unshift(item);\r\n                            } else {\r\n                                result.push(item);\r\n                            }\r\n                            return result;\r\n                        }, []));\r\n                    })\r\n                    .finally(() => {\r\n                        state.isLoading = false;\r\n                    });\r\n            };\r\n            /**\r\n             * @desc 外部调用——刷新 tag 数据\r\n             */\r\n            const refresh = () => {\r\n                this.fetchData();\r\n            };\r\n            /**\r\n             * @desc 过滤 tag 列表\r\n             */\r\n            const handleSearch = _.debounce((search) => {\r\n                state.search = _.trim(search);\r\n            }, 300);\r\n            /**\r\n             * @desc 清除过滤项\r\n             */\r\n            const handleClearSearch = () => {\r\n                state.search = '';\r\n            };\r\n            /**\r\n             * @desc 新建 tag\r\n             * @returns { Boolean }\r\n             */\r\n            const handleNew = () => {\r\n                state.isShowCreateTag = true;\r\n            };\r\n            const handleTagOperationChange = (tag) => {\r\n                tag.isNew = true;\r\n                state.newTagList.unshift(tag);\r\n                if (scrollRef.value) {\r\n                    scrollRef.value.scrollTo(0, 0);\r\n                }\r\n            };\r\n            /**\r\n             * @desc 提交批量流转\r\n             * @returns { Promise }\r\n             */\r\n            const submit = () => {\r\n                if (isSubmitDisable.value) {\r\n                    return Promise.resolve();\r\n                }\r\n                const {\r\n                    operationList,\r\n                    resourceTypeList,\r\n                } = state.formData;\r\n\r\n                const addTagIdList = operationList;\r\n                const deleteTagIdList = [];\r\n                if (!operationList.includes(props.data.id)) {\r\n                    deleteTagIdList.push(props.data.id);\r\n                }\r\n                _.remove(addTagIdList, id => id === props.data.id);\r\n                return formRef.value.validate()\r\n                    .then(() => TagManageService.batchUpdate({\r\n                        id: props.data.id,\r\n                        resourceTypeList,\r\n                        addTagIdList,\r\n                        deleteTagIdList,\r\n                    }))\r\n                    .then(() => {\r\n                        proxy.messageSuccess(I18n.t('tag.批量流转关联项成功'));\r\n                        ctx.emit('on-change');\r\n                    });\r\n            };\r\n\r\n            onBeforeMount(() => {\r\n                fetchData();\r\n            });\r\n\r\n            return {\r\n                ...toRefs(state),\r\n                isSubmitDisable,\r\n                formRef,\r\n                scrollRef,\r\n                rules,\r\n                renderList,\r\n                refresh,\r\n                handleSearch,\r\n                handleClearSearch,\r\n                handleNew,\r\n                handleTagOperationChange,\r\n                submit,\r\n            };\r\n        },\r\n    };\r\n</script>\r\n<style lang=\"postcss\">\r\n    .batch-edit-relate-box {\r\n        padding-top: 5px;\r\n\r\n        .tag-panel {\r\n            display: flex;\r\n            flex-direction: column;\r\n            border: 1px solid #dcdee5;\r\n            border-radius: 2px;\r\n        }\r\n\r\n        .tag-search {\r\n            margin: 0 10px;\r\n\r\n            &.bk-form-control {\r\n                &.with-left-icon {\r\n                    width: auto;\r\n\r\n                    .left-icon {\r\n                        left: 0;\r\n                    }\r\n\r\n                    .bk-form-input {\r\n                        padding-left: 24px;\r\n                    }\r\n                }\r\n            }\r\n\r\n            .bk-form-input {\r\n                border-color: transparent !important;\r\n                border-bottom: 1px solid #c4c6cc !important;\r\n            }\r\n        }\r\n\r\n        .wrapper {\r\n            padding: 18px 0 18px 12px;\r\n\r\n            .tag-list {\r\n                display: flex;\r\n                flex-direction: column;\r\n\r\n                .tag-item {\r\n                    margin-bottom: 16px;\r\n\r\n                    &:last-child {\r\n                        margin-bottom: 0;\r\n                    }\r\n                }\r\n            }\r\n\r\n            .new-tag-flag {\r\n                margin-left: 5px;\r\n                font-size: 18px;\r\n                vertical-align: middle;\r\n            }\r\n        }\r\n\r\n        .tag-create {\r\n            height: 38px;\r\n            padding-left: 10px;\r\n            font-size: 12px;\r\n            line-height: 38px;\r\n            color: #63656e;\r\n            cursor: pointer;\r\n            background: #fafbfd;\r\n            border-top: 1px solid #dcdee5;\r\n        }\r\n    }\r\n</style>\r\n"],"names":[],"sourceRoot":""}