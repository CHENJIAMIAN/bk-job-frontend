{"version":3,"file":"static/css/6023.67b008a76af6ca9ef672.css","mappings":"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","sources":["webpack://job/./src/views/executive-history/step-detail/components/task-step/view/approval.vue","webpack://job/./src/views/executive-history/step-detail/components/task-step/view/normal.vue","webpack://job/./src/views/executive-history/step-detail/components/task-step/view/no-start.vue","webpack://job/./src/views/executive-history/step-detail/components/task-step/index.vue","webpack://job/./src/views/executive-history/step-detail/components/task-status.vue","webpack://job/./src/views/executive-history/step-detail/components/execution-history-select.vue","webpack://job/./src/views/executive-history/step-detail/components/group-tab.vue","webpack://job/./src/views/executive-history/step-detail/components/ip-list/index.vue","webpack://job/./src/views/executive-history/step-detail/components/execution-info/script-log/index.vue","webpack://job/./src/views/executive-history/step-detail/components/execution-info/file-log/log-item.vue","webpack://job/./src/views/executive-history/step-detail/components/execution-info/file-log/index.vue","webpack://job/./src/views/executive-history/step-detail/components/execution-info/variable-view.vue","webpack://job/./src/views/executive-history/step-detail/components/execution-info/index.vue","webpack://job/./src/views/executive-history/step-detail/components/export-log.vue","webpack://job/./src/views/executive-history/step-detail/index.vue"],"sourcesContent":["<template>\n    <div\n        ref=\"popover\"\n        class=\"task-execute-bar-step-confirm-popover-view\"\n        :class=\"{\n            [data.displayStyle]: true,\n            'not-start': data.isNotStart,\n        }\">\n        <div class=\"confirm-wraper\">\n            <div class=\"step-name\">{{ data.name }}</div>\n            <div class=\"approval-info\">\n                <div v-if=\"data.roleNameList.length || data.userList.length\" class=\"approval-person\">\n                    <span class=\"persion-label\">{{ '确认人' }}：</span>\n                    <div v-for=\"item in data.roleNameList\" :key=\"`role_${item}`\" class=\"person\">\n                        <Icon type=\"user-group-gray\" class=\"role-flag\" />\n                        {{ item }}\n                    </div>\n                    <div v-for=\"item in data.userList\" :key=\"`user_${item}`\" class=\"person\">\n                        <Icon type=\"user\" class=\"role-flag\" />\n                        {{ item }}\n                    </div>\n                </div>\n                <div v-if=\"data.notifyChannelNameList.length > 0\" class=\"approval-channel\">\n                    {{ '通知方式' }}：{{ data.notifyChannelNameList.join('，') }}\n                </div>\n            </div>\n            <div v-if=\"data.confirmMessage\" class=\"step-desc\">{{ data.confirmMessage }}</div>\n            <template v-if=\"!data.isNotStart\">\n                <bk-input\n                    v-if=\"data.isApprovaling\"\n                    v-model=\"confirmReason\"\n                    class=\"confirm-reason\"\n                    type=\"textarea\"\n                    :rows=\"3\"\n                    :maxlength=\"100\"\n                    :placeholder=\"'可在此处输入确认或终止的因由'\" />\n                <div v-else-if=\"data.operator\" class=\"confirm-reason-text\">\n                    <div class=\"person\">{{ data.operator }}</div>\n                    <span v-html=\"data.confirmReasonHtml\" />\n                </div>\n                <div v-if=\"data.actions.length > 0\" class=\"step-action\" @click.stop=\"\">\n                    <step-action\n                        v-for=\"action in data.actions\"\n                        :name=\"action\"\n                        :key=\"action\"\n                        :confirm-handler=\"operationCode => handleChangeStatus(operationCode)\" />\n                </div>\n            </template>\n        </div>\n        <Icon v-if=\"data.displayStyle !== 'success'\" type=\"close\" class=\"approval-close\" @click=\"handleClose\" />\n    </div>\n</template>\n<script>\n       import TaskExecuteService from '@service/task-execute';\n    import StepAction from '../../../../common/step-action';\n\n    export default {\n        name: '',\n        components: {\n            StepAction,\n        },\n        props: {\n            data: {\n                type: Object,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                confirmReason: '',\n            };\n        },\n\n        methods: {\n            handleChangeStatus (operationCode) {\n                return TaskExecuteService.updateTaskExecutionStepOperate({\n                    id: this.data.stepInstanceId,\n                    operationCode,\n                    confirmReason: this.confirmReason,\n                }).then((data) => {\n                    this.$bkMessage({\n                        limit: 1,\n                        theme: 'success',\n                        message: '操作成功',\n                    });\n                    this.$emit('on-update', data);\n                    return true;\n                });\n            },\n            handleClose () {\n                this.$emit('on-close');\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .task-execute-bar-step-confirm-popover-view {\n        position: relative;\n        width: 472px;\n        background: #fff;\n\n        &.not-start {\n            &::before {\n                background: #dcdee5;\n                border-color: #dcdee5;\n            }\n\n            .confirm-wraper {\n                border-left-color: #dcdee5;\n            }\n        }\n\n        &.success {\n            &::before {\n                background: #2dcb9d;\n                border-color: #2dcb9d;\n            }\n\n            .confirm-wraper {\n                border-left-color: #2dcb9d;\n            }\n        }\n\n        &.confirm-forced {\n            &::before {\n                background: #ff5656;\n                border-color: #ff5656;\n            }\n\n            .confirm-wraper {\n                border-left-color: #ff5656;\n            }\n        }\n\n        &.middle {\n            &::before {\n                top: 50%;\n                transform: translateY(-50%) rotateZ(-45deg);\n            }\n        }\n\n        &.top {\n            &::before {\n                top: 10px;\n                transform: rotateZ(-45deg);\n            }\n        }\n\n        &.bottom {\n            &::before {\n                bottom: 20px;\n                transform: rotateZ(-45deg);\n            }\n        }\n\n        &::before {\n            position: absolute;\n            left: -6px;\n            width: 10px;\n            height: 10px;\n            background: #ffb848;\n            border: 1px solid #dcdee5;\n            border-color: #ffb848;\n            content: \"\";\n        }\n\n        .confirm-wraper {\n            position: relative;\n            padding: 20px 36px 24px 30px;\n            background: #fff;\n            border-left: 6px solid #ffb848;\n        }\n\n        .step-name {\n            font-size: 16px;\n            font-weight: bold;\n            line-height: 21px;\n            color: #313238;\n        }\n\n        .approval-info {\n            display: flex;\n            align-items: center;\n            flex-wrap: wrap;\n            padding-top: 4px;\n            font-size: 12px;\n            line-height: 20px;\n            color: #b2b5bd;\n        }\n\n        .approval-person {\n            display: flex;\n            flex-wrap: wrap;\n\n            .persion-label,\n            .person {\n                margin-top: 10px;\n            }\n\n            .role-flag {\n                margin-right: 4px;\n            }\n        }\n\n        .person {\n            display: inline-flex;\n            height: 22px;\n            padding: 0 6px;\n            margin-right: 6px;\n            font-size: 12px;\n            color: #63656e;\n            background: #f0f1f5;\n            border-radius: 2px;\n            align-items: center;\n        }\n\n        .approval-channel {\n            margin-top: 10px;\n        }\n\n        .confirm-reason,\n        .confirm-reason-text {\n            margin-top: 20px;\n        }\n\n        .confirm-reason-text {\n            font-size: 14px;\n            line-height: 22px;\n            color: #63656e;\n        }\n\n        .step-desc {\n            padding-top: 14px;\n            white-space: normal;\n        }\n\n        .step-action {\n            display: flex;\n            justify-content: flex-end;\n            margin-top: 20px;\n\n            .step-instance-action {\n                width: 76px;\n                height: 26px;\n                padding: 0;\n                margin-right: 0;\n                margin-left: 10px;\n                font-size: 12px;\n                border-radius: 2px;\n\n                &.confirm {\n                    color: #fff;\n                    background: #3a84ff;\n                }\n\n                &.confirm-forced {\n                    color: #63656e !important;\n                    background: #fff;\n                    border: 1px solid #c4c6cc;\n                }\n\n                &.retry {\n                    width: auto;\n                    padding: 0 14px;\n                    color: #fff;\n                    background: #3a84ff;\n                }\n\n                .job-icon {\n                    display: none;\n                }\n            }\n        }\n\n        .approval-close {\n            position: absolute;\n            top: 0;\n            right: 0;\n            padding: 10px;\n            font-size: 24px;\n            color: #c4c6cc;\n            cursor: pointer;\n        }\n    }\n</style>\n","<template>\n    <div class=\"task-execute-bar-step-description-popover\">\n        <div>\n            {{ data.typeDesc }}:<span class=\"value\">{{ data.name }}</span>\n        </div>\n        <div>\n            {{ '步骤状态' }}:<span class=\"value\" :class=\"[data.displayStyle]\">{{ data.statusDesc }}</span>\n        </div>\n        <div>\n            {{ '步骤耗时' }}:<span class=\"value\">{{ data.totalTimeText }}</span>\n        </div>\n    </div>\n</template>\n<script>\n    export default {\n        name: '',\n        props: {\n            data: {\n                type: Object,\n                required: true,\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .task-execute-bar-step-description-popover {\n        padding: 0.3rem 0.6rem;\n\n        &::before {\n            position: absolute;\n            top: 50%;\n            left: -6px;\n            width: 10px;\n            height: 10px;\n            margin-top: -8px;\n            background: #fff;\n            border: none;\n            border: 1px solid #dcdee5;\n            border-right: none;\n            border-bottom: none;\n            content: \"\";\n            transform: translateY(-50%) rotateZ(-45deg);\n        }\n\n        .value {\n            margin-left: 1em;\n\n            &.loading {\n                color: #3a84ff;\n            }\n\n            &.success {\n                color: #2dcb9d;\n            }\n\n            &.disabled {\n                color: #c4c6cc;\n            }\n\n            &.fail,\n            &.forced {\n                color: #ff5656;\n            }\n\n            &.confirm {\n                color: #ff9c01;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"task-execute-bar-step-description-popover\">\n        <div>\n            {{ data.typeDesc }}:<span class=\"value\">{{ data.name }}</span>\n        </div>\n        <div>\n            {{ '步骤状态' }}:<span class=\"value\">--</span>\n        </div>\n        <div>\n            {{ '步骤耗时' }}:<span class=\"value\">--</span>\n        </div>\n    </div>\n</template>\n<script>\n    export default {\n        name: '',\n        props: {\n            data: {\n                type: Object,\n                required: true,\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .task-execute-bar-step-description-popover {\n        padding: 0.3rem 0.6rem;\n\n        &::before {\n            position: absolute;\n            top: 50%;\n            left: -6px;\n            width: 10px;\n            height: 10px;\n            margin-top: -8px;\n            background: #fff;\n            border: none;\n            border: 1px solid #dcdee5;\n            border-right: none;\n            border-bottom: none;\n            content: \"\";\n            transform: translateY(-50%) rotateZ(-45deg);\n        }\n    }\n</style>\n","<template>\n    <div\n        class=\"task-execute-bar-step\"\n        :class=\"{\n            [data.displayStyle]: true,\n            active: data.stepInstanceId === activeId,\n        }\"\n        @mouseenter=\"handleShowPopover\"\n        @mouseleave=\"handleHidePopover\"\n        @click=\"handleSelect\">\n        <div class=\"step-wraper\">\n            <div class=\"step-icon\">\n                <Icon :type=\"data.icon\" />\n            </div>\n            <img\n                v-if=\"data.isDoing\"\n                class=\"loading-progress\"\n                src=\"/static/images/task-loading.png\">\n        </div>\n        <Icon :type=\"data.lastStepIcon\" svg class=\"step-next\" />\n        <component\n            v-show=\"isShowPopover\"\n            ref=\"popover\"\n            :is=\"popoverCom\"\n            :data=\"data\"\n            :class=\"['task-status-bar-step-popover', arrowPlacement]\"\n            :style=\"popoverStyles\"\n            @on-update=\"handleTaskStatusUpdate\"\n            @on-close=\"handleClosePopover\" />\n    </div>\n</template>\n<script>\n    import ApprovalView from './view/approval';\n    import NormalView from './view/normal';\n    import NotStartView from './view/no-start';\n\n    let activeHandler = null;\n\n    export default {\n        props: {\n            activeId: {\n                type: [String, Number],\n            },\n            data: {\n                type: Object,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                isShowPopover: false,\n                confirmReason: '',\n                popoverPosition: {\n                    top: 0,\n                    left: 0,\n                },\n                arrowPlacement: 'top',\n            };\n        },\n        computed: {\n            popoverCom () {\n                if (this.data.isApproval) {\n                    return ApprovalView;\n                }\n                if (this.data.isNotStart) {\n                    return NotStartView;\n                }\n                return NormalView;\n            },\n            popoverStyles () {\n                const { top, left, zIndex } = this.popoverPosition;\n                return {\n                    position: 'absolute',\n                    top: `${top}px`,\n                    left: `${left + 72}px`,\n                    'z-index': zIndex,\n                };\n            },\n        },\n        beforeDestroy () {\n            this.destroyePopover();\n        },\n        methods: {\n            handleSelect () {\n                this.$emit('on-select', this.data);\n            },\n            handleTaskStatusUpdate (payload) {\n                this.$emit('on-update', payload);\n            },\n            handleShowPopover () {\n                if (activeHandler) {\n                    activeHandler.handleClosePopover();\n                }\n                \n                this.isShowPopover = true;\n                activeHandler = this;\n                let offset = 0;\n                if (this.data.isApproval) {\n                    offset = 15;\n                }\n                this.$nextTick(() => {\n                    this.arrowPlacement = 'top';\n                    const position = {\n                        top: 0,\n                        left: 0,\n                        zIndex: window.__bk_zIndex_manager.nextZIndex(), // eslint-disable-line no-underscore-dangle\n                    };\n                    const $popoverTarget = this.$refs.popover.$el;\n                    const windowHeight = window.innerHeight;\n                    const { height } = $popoverTarget.getBoundingClientRect();\n                    const { top, left } = this.$el.getBoundingClientRect();\n                    position.left = left;\n                    position.top = top + offset;\n                    if (top + height + 20 > windowHeight) {\n                        this.arrowPlacement = 'bottom';\n                        position.top = top - height + 60;\n                    }\n                    if (position.top < 20) {\n                        this.arrowPlacement = 'middle';\n                        position.top = top - height / 2 + 30;\n                    }\n                    document.body.appendChild($popoverTarget);\n                    this.popoverPosition = position;\n                });\n            },\n            // 人工确认步骤——如果没有确认需要手动关闭\n            // 其它步骤鼠标离开自动关闭\n            handleHidePopover () {\n                if (this.data.isApproval && this.data.displayStyle !== 'success') {\n                    return;\n                }\n                this.isShowPopover = false;\n            },\n            handleClosePopover () {\n                this.isShowPopover = false;\n            },\n            destroyePopover () {\n                try {\n                    activeHandler = null;\n                    if (this.$refs.popover.$el && document.body.hasChildNodes(this.$refs.popover.$el)) {\n                        document.body.removeChild(this.$refs.popover.$el);\n                    }\n                } catch {}\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .task-execute-bar-step {\n        cursor: pointer;\n\n        &.start,\n        &.end {\n            cursor: default;\n\n            &:hover {\n                background: #fff;\n            }\n        }\n\n        &:hover {\n            background: #f0f1f5;\n        }\n\n        &.active {\n            background: #e1ecff;\n        }\n\n        &.loading {\n            color: #63656e;\n\n            .step-icon {\n                background: #3a84ff;\n            }\n\n            .time {\n                color: #3a84ff;\n            }\n        }\n\n        &.ingore {\n            .step-icon {\n                background: #abd88a;\n            }\n        }\n\n        &.disabled {\n            cursor: default;\n            background: transparent;\n\n            .step-icon {\n                background: #dcdee5;\n            }\n        }\n\n        &.fail,\n        &.forced,\n        &.confirm-forced {\n            color: #979ba5;\n\n            .step-icon {\n                background: #ff5656;\n            }\n        }\n\n        &.confirm {\n            color: #979ba5;\n\n            .step-icon {\n                background: #ff9c01;\n            }\n        }\n\n        .step-wraper {\n            position: relative;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            width: 60px;\n            height: 60px;\n        }\n\n        .step-icon {\n            display: flex;\n            width: 34px;\n            height: 34px;\n            font-size: 14px;\n            font-weight: 600;\n            color: #fff;\n            background: #2dcb9d;\n            border-radius: 50%;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .step-next {\n            position: absolute;\n            left: 50%;\n            font-size: 31px;\n            color: #c4c6cc;\n            transform: translate(-50%, -18px);\n        }\n\n        .loading-progress {\n            position: absolute;\n            top: 9px;\n            left: 9px;\n            display: block;\n            width: 42px;\n            height: 42px;\n            animation: \"ani-rotate\" 2s linear infinite;\n        }\n    }\n\n    .task-status-bar-step-popover {\n        /* position: relative; */\n        font-size: 14px;\n        line-height: 22px;\n        color: #63656e;\n        white-space: nowrap;\n        background: #fff;\n        border: 1px solid #dcdee5;\n        border-radius: 2px;\n        box-shadow: 0 0 5px 0 rgb(0 0 0 / 9%);\n\n        /* &:after{\n            content: '';\n            position: absolute;\n            top: 0;\n            left: -15px;\n            width: 20px;\n            height: 60px;\n        } */\n    }\n</style>\n","<template>\n    <div class=\"task-execution-step-wraper\" :class=\"{ column: taskExecutionDetail.taskExecution.isTask }\">\n        <div v-if=\"taskExecutionDetail.taskExecution.isTask\" class=\"task-process\">\n            <div class=\"process-wraper\">\n                <scroll-faker>\n                    <task-step-start />\n                    <task-step\n                        v-for=\"step in taskExecutionDetail.stepExecution\"\n                        :data=\"step\"\n                        :active-id=\"currentStepInstanceId\"\n                        @on-select=\"handleChangeStep\"\n                        @on-update=\"handleTaskStatusUpdate\"\n                        :key=\"step.stepInstanceId\" />\n                    <task-step-end :disable=\"!taskExecutionDetail.taskExecution.isSuccess\" />\n                </scroll-faker>\n            </div>\n            <div class=\"execution-process\">\n                {{ currentStepOrder }} / {{ taskExecutionDetail.totalStep }}\n            </div>\n        </div>\n        <div class=\"task-step-detail\">\n            <slot />\n        </div>\n        <div v-if=\"historyEnable\" class=\"execution-history\" :class=\"{ active: isShowHistory }\">\n            <div class=\"toggle-btn\" @click=\"handleShowHistory\">\n                <Icon class=\"toggle-flag\" type=\"angle-double-left\" />\n                <div class=\"return-edit\">{{ '返回编辑' }}</div>\n            </div>\n            <div class=\"history-content\">\n                <template v-if=\"taskExecutionDetail.taskExecution.isScript\">\n                    <div\n                        v-for=\"item in scriptHistoryList\"\n                        class=\"item\"\n                        :key=\"item.id\"\n                        @click=\"handleGoRedoScriptExec(item)\">\n                        {{ item.name }}\n                    </div>\n                </template>\n                <template v-if=\"taskExecutionDetail.taskExecution.isFile\">\n                    <div\n                        v-for=\"item in fileHistoryList\"\n                        class=\"item\"\n                        :key=\"item.id\"\n                        @click=\"handleGoRedoFileExec(item)\">\n                        {{ item.name }}\n                    </div>\n                </template>\n            </div>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import TaskExecuteService from '@service/task-execute';\n    import {\n        buildURLParams,\n    } from '@utils/assist';\n    import {\n        execScriptHistory,\n        pushFileHistory,\n    } from '@utils/cache-helper';\n    import TaskStep from './task-step/index';\n    import TaskStepStart from './task-step/start';\n    import TaskStepEnd from './task-step/end';\n    import mixins from './mixins';\n\n    export default {\n        name: '',\n        components: {\n            TaskStep,\n            TaskStepStart,\n            TaskStepEnd,\n        },\n        mixins: [\n            mixins,\n        ],\n        data () {\n            return {\n                isLoading: false,\n                isShow: false,\n                taskExecutionDetail: {\n                    isFinished: false,\n                    taskExecution: {},\n                    stepExecution: [],\n                },\n                scriptHistoryList: [{},{},{}],\n                fileHistoryList: [{},{},{}],\n                isShowHistory: false,\n                isFinished: false,\n                currentStepInstanceId: '',\n            };\n        },\n        computed: {\n            currentStepOrder () {\n                return _.findIndex(\n                    this.taskExecutionDetail.stepExecution,\n                    _ => _.stepInstanceId === this.currentStepInstanceId,\n                ) + 1;\n            },\n            historyEnable () {\n                if (this.taskExecutionDetail.taskExecution.isScript) {\n                    return this.scriptHistoryList.length > 0;\n                }\n                if (this.taskExecutionDetail.taskExecution.isFile) {\n                    return this.fileHistoryList.length > 0;\n                }\n                return false;\n            },\n        },\n        created () {\n            this.timer = '';\n\n            const { taskInstanceId } = this.$route.params;\n            const { stepInstanceId, retryCount = 0 } = this.$route.query;\n            \n            this.taskInstanceId = parseInt(taskInstanceId, 10);\n            this.stepInstanceId = parseInt(stepInstanceId, 10);\n            this.retryCount = parseInt(retryCount, 10);\n            \n            this.fetchData();\n        },\n        mounted () {\n            this.initHistory();\n            this.$once('hook:beforeDestroy', () => {\n                clearTimeout(this.timer);\n            });\n        },\n        methods: {\n            fetchData (trigger = false) {\n                this.isLoading = true;\n                TaskExecuteService.fetchTaskExecutionResult({\n                    id: this.taskInstanceId,\n                }).then((data) => {\n                    this.taskExecutionDetail = Object.freeze(data);\n                    if (!data.finished) {\n                        this.timer = setTimeout(() => {\n                            this.reLoading();\n                        }, 1000);\n                    }\n                    // 没有指定stepInstanceId默认取第一个步骤\n                    if (!this.stepInstanceId) {\n                        const [\n                            {\n                                stepInstanceId,\n                                retryCount,\n                            },\n                        ] = data.stepExecution;\n                        this.stepInstanceId = stepInstanceId;\n                        this.retryCount = retryCount;\n                    }\n                    this.currentStepInstanceId = this.stepInstanceId;\n                    this.$emit('on-init', {\n                        taskInstanceId: this.taskInstanceId,\n                        stepInstanceId: this.stepInstanceId,\n                        retryCount: this.retryCount,\n                        taskStepList: data.stepExecution,\n                        isTask: this.taskExecutionDetail.taskExecution.isTask,\n                    });\n                })\n                    .catch((error) => {\n                        if ([\n                            400,\n                            1244006,\n                        ].includes(error.code)) {\n                            setTimeout(() => {\n                                this.$router.push({\n                                    name: 'historyList',\n                                });\n                            }, 3000);\n                        }\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            // 作业执行状态轮询\n            reLoading () {\n                // 是作业类型的任务才会轮询作业的状态\n                if (!this.taskExecutionDetail.taskExecution.isTask) {\n                    return;\n                }\n                TaskExecuteService.fetchTaskExecutionResult({\n                    id: this.taskInstanceId,\n                }).then((data) => {\n                    this.taskExecutionDetail = Object.freeze(data);\n                    if (!data.finished) {\n                        this.$pollingQueueRun(this.reLoading);\n                    }\n                });\n            },\n            initHistory () {\n                this.scriptHistoryList = Object.freeze(execScriptHistory.getItem());\n                this.fileHistoryList = Object.freeze(pushFileHistory.getItem());\n            },\n            handleShowHistory () {\n                this.isShowHistory = !this.isShowHistory;\n            },\n            handleGoRedoScriptExec (payload) {\n                this.$router.push({\n                    name: 'fastExecuteScript',\n                    params: {\n                        taskInstanceId: payload.taskInstanceId,\n                    },\n                    query: {\n                        from: 'historyStep',\n                    },\n                });\n            },\n            handleGoRedoFileExec (payload) {\n                this.$router.push({\n                    name: 'fastPushFile',\n                    params: {\n                        taskInstanceId: payload.taskInstanceId,\n                    },\n                    query: {\n                        from: 'historyStep',\n                    },\n                });\n            },\n            handleChangeStep (step) {\n                if (step.stepInstanceId === this.currentStepInstanceId) {\n                    return;\n                }\n\n                if (step.isNotStart) {\n                    this.$bkMessage({\n                        theme: 'warning',\n                        message: '该步骤还未执行',\n                        limit: 1,\n                    });\n                    return;\n                }\n\n                if (step.isApproval) {\n                    this.$bkMessage({\n                        theme: 'warning',\n                        message: '人工确认步骤不支持查看步骤详情',\n                        limit: 1,\n                    });\n                    return;\n                }\n                \n                const { stepInstanceId, retryCount } = step;\n                this.currentStepInstanceId = stepInstanceId;\n                const query = buildURLParams({\n                    ...this.$route.query,\n                    stepInstanceId,\n                    retryCount,\n                });\n                window.history.replaceState({}, '', `?${query}`);\n                \n                this.$emit('on-init', {\n                    stepInstanceId,\n                    taskInstanceId: this.taskInstanceId,\n                    retryCount,\n                    taskStepList: this.taskExecutionDetail.stepExecution,\n                    isTask: this.taskExecutionDetail.taskExecution.isTask,\n                });\n            },\n            handleTaskStatusUpdate (payload) {\n                this.reLoading();\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    html[lang=\"en-US\"] {\n        .return-edit {\n            margin-top: 6px;\n            transform: rotate(90deg);\n        }\n    }\n\n    @keyframes ani-rotate {\n        to {\n            transform: rotateZ(360deg);\n        }\n    }\n\n    .task-execution-step-wraper {\n        background: #fff;\n\n        &.column {\n            display: flex;\n\n            .task-step-detail {\n                width: 0;\n            }\n        }\n\n        .task-process {\n            display: flex;\n            height: calc(100vh - 104px);\n            padding-bottom: 38px;\n            background: #fff;\n            border-right: 1px solid #e2e2e2;\n            flex-direction: column;\n            flex: 0 0 61px;\n\n            .process-wraper {\n                height: 100%;\n\n                .scroll-faker-content {\n                    position: relative;\n                }\n            }\n\n            .execution-process {\n                position: absolute;\n                right: 0;\n                bottom: 0;\n                left: 0;\n                width: 60px;\n                height: 28px;\n                font-size: 14px;\n                line-height: 28px;\n                color: #fff;\n                text-align: center;\n                background: rgb(0 0 0 / 25%);\n                user-select: none;\n            }\n        }\n\n        .task-step-detail {\n            flex: 1;\n            background: #fff;\n        }\n\n        .execution-history {\n            position: fixed;\n            top: 127px;\n            right: 0;\n            z-index: 999;\n            font-size: 12px;\n            line-height: 30px;\n            color: #c4c6cc;\n            background: #63656e;\n            border-bottom-left-radius: 2px;\n            transform: translateX(100%);\n            transition: all 0.35s;\n            user-select: none;\n\n            &.active {\n                transform: translateX(0);\n\n                .toggle-flag {\n                    transform: rotateZ(180deg);\n                }\n            }\n\n            .toggle-btn {\n                position: absolute;\n                top: 0;\n                left: -22px;\n                display: flex;\n                width: 22px;\n                height: 88px;\n                line-height: 13px;\n                color: #dcdee5;\n                text-align: center;\n                cursor: pointer;\n                background: #63656e;\n                border-right: 1px solid #757783;\n                border-bottom-left-radius: 8px;\n                border-top-left-radius: 8px;\n                flex-direction: column;\n                justify-content: center;\n\n                .toggle-flag {\n                    margin-bottom: 5px;\n                    color: #979ba5;\n                    transition: all 0.2s;\n                }\n            }\n\n            .history-content {\n                display: flex;\n                min-height: 90px;\n                padding: 12px 0;\n                flex-direction: column;\n                justify-content: center;\n            }\n\n            .item {\n                padding-right: 16px;\n                padding-left: 16px;\n                cursor: pointer;\n                transition: all 0.15s;\n\n                &:hover {\n                    color: #fff;\n                    background: #4f515a;\n                }\n            }\n        }\n    }\n</style>\n","\n<template>\n    <div\n        ref=\"target\"\n        class=\"step-execution-history-select\">\n        <span>{{ retryCountText }}</span>\n        <Icon type=\"down-small\" style=\"font-size: 16px;\" />\n        <div ref=\"content\" class=\"dropdown-menu\">\n            <div\n                v-for=\"item in executionList\"\n                :key=\"item.createTime\"\n                class=\"menu-item\"\n                :class=\"{\n                    active: item.retryCount === retryCount,\n                }\"\n                @click=\"handleSelectRetryCount(item.retryCount)\">\n                <div class=\"retry-count\">{{ item.text }}</div>\n                <div class=\"time\">{{ item.createTime }}</div>\n            </div>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import TaskExecuteService from '@service/task-execute';\n\n    const ordinalSuffixOf = (i) => {\n        const j = i % 10;\n        const k = i % 100;\n        if (j === 1 && k !== 11) {\n            return `${i} st`;\n        }\n        if (j === 2 && k !== 12) {\n            return `${i} nd`;\n        }\n        if (j === 3 && k !== 13) {\n            return `${i} rd`;\n        }\n        return `${i} th`;\n    };\n\n    export default {\n        name: '',\n        props: {\n            stepInstanceId: {\n                type: Number,\n                required: true,\n            },\n            retryCount: {\n                type: [Number, String],\n                default: 0,\n            },\n        },\n        data () {\n            return {\n                isNeedRender: false,\n                executionList: [{}, {}, {}],\n            };\n        },\n        computed: {\n            retryCountText () {\n                // eslint-disable-next-line no-plusplus\n                for (let i = 0; i < this.executionList.length; i++) {\n                    if (this.executionList[i].retryCount === this.retryCount) {\n                        return this.executionList[i].text;\n                    }\n                }\n                return 'LATEST';\n            },\n        },\n        watch: {\n            stepInstanceId: {\n                handler (stepInstanceId) {\n                    this.popperDestroy();\n                    if (!stepInstanceId) {\n                        return;\n                    }\n                    this.fetchStepExecutionHistory();\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.fetchStepExecutionHistory();\n        },\n        beforeDestroy () {\n            this.popperDestroy();\n        },\n        methods: {\n            /**\n             * @desc 组件外部调用api，刷新数据\n             */\n            reLoading () {\n                this.fetchStepExecutionHistory();\n            },\n            /**\n             * @desc 获取步骤执行历史\n             *\n             * retryCount的最大值显示为LATEST\n             * 如果重试次数大于0，显示retryCount切换列表\n             */\n            fetchStepExecutionHistory () {\n                // TaskExecuteService.fetchStepExecutionHistory({\n                //     stepInstanceId: this.stepInstanceId,\n                // }).then((data) => {\n                const data = [{\n                    retryCount: 5,\n                    createTime: '2018-01-01 12:00:00',\n                }];\n                const max = _.max(data.map(_ => _.retryCount));\n                const result = data.map((item) => {\n                    const {\n                        retryCount,\n                        createTime,\n                    } = item;\n\n                    const realIndex = retryCount + 1;\n                    return {\n                        retryCount,\n                        createTime,\n                        text: retryCount !== max ? ordinalSuffixOf(realIndex) : 'LATEST',\n                    };\n                });\n                this.executionList = Object.freeze(result);\n                // 重试次数大于1才需要显示\n                this.isNeedRender = this.executionList.length > 1;\n                if (this.isNeedRender) {\n                    this.$nextTick(() => {\n                        if (!this.popperInstance) {\n                            this.popperInstance = this.$bkPopover(this.$el, {\n                                theme: 'light step-execution-history-menu',\n                                arrow: false,\n                                interactive: true,\n                                placement: 'bottom-start',\n                                content: this.$refs.content,\n                                animation: 'slide-toggle',\n                                trigger: 'click',\n                                width: '240px',\n                            });\n                        }\n                    });\n                } else {\n                    this.popperDestroy();\n                }\n                // });\n            },\n            /**\n             * @desc 销毁popover实例\n             */\n            popperDestroy () {\n                if (this.popperInstance) {\n                    this.popperInstance.destroy();\n                    this.popperInstance = null;\n                }\n            },\n            /**\n             * @desc 切换重试次数\n             * @param retryCount [Number] 重试记录\n             *\n             * 切换成功后需要将retryCount的最新值更新到url上\n             */\n            handleSelectRetryCount (retryCount) {\n                debugger;\n                this.selectRetryCount = retryCount;\n                this.popperInstance && this.popperInstance.hide();\n                this.$emit('on-change', retryCount);\n                const searchParams = new URLSearchParams(window.location.search);\n                searchParams.set('retryCount', retryCount);\n                window.history.replaceState({}, '', `?${searchParams.toString()}`);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .step-execution-history-select {\n        position: relative;\n        display: flex;\n        height: 20px;\n        padding-right: 2px;\n        padding-left: 10px;\n        margin-left: 8px;\n        color: #63656e;\n        cursor: pointer;\n        background: #e6e7eb;\n        border-radius: 2px;\n        align-items: center;\n    }\n\n    .step-execution-history-menu-theme {\n        .menu-item {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            height: 32px;\n            padding: 0 10px;\n            font-size: 12px;\n            color: #979ba5;\n            cursor: pointer;\n\n            &:hover {\n                background: #f4f6fa;\n            }\n\n            &.active {\n                background: #eaf3ff;\n\n                .retry-count {\n                    color: #3a84ff;\n                }\n            }\n\n            .retry-count {\n                color: #63656e;\n            }\n        }\n\n        .tippy-content {\n            margin: 0 -0.6rem;\n        }\n    }\n</style>\n","<template>\n    <div class=\"step-execute-host-group\" :class=\"{ hide: isHide }\">\n        <div ref=\"groupTab\" class=\"group-tab\" :class=\"{ toggle: showGroupToggle }\">\n            <div\n                v-for=\"(item) in renderGroup\"\n                :key=\"item.resultType + item.tag\"\n                class=\"tab-item\"\n                :class=\"{ active: chooseGroupName === item.groupName }\"\n                @click=\"handleGroupChange(item)\">\n                <div class=\"group-name\" v-bk-overflow-tips>{{ item.groupName }}</div>\n                <Icon\n                    v-if=\"item.tagMaxLength\"\n                    class=\"max-length-info\"\n                    v-bk-tooltips=\"'分组标签长度最大支持256，超过会被自动截断，请留意！'\"\n                    type=\"info\" />\n                <div class=\"group-nums\">{{ item.agentTaskSize }}</div>\n            </div>\n            <div v-if=\"showGroupToggle\" class=\"group-toggle\" :class=\"groupToggleClass\">\n                <div class=\"tab-more\">\n                    <div class=\"group-holder\">{{ groupHolder }}</div>\n                    <Icon type=\"arrow-full-right\" class=\"toggle-flag\" />\n                </div>\n                <div class=\"dropdown-menu\">\n                    <div\n                        class=\"dropdowm-item\"\n                        v-for=\"(item, index) in toggleGroup\"\n                        :class=\"{ active: chooseGroupName === item.groupName }\"\n                        @click=\"handleGroupChange(item)\"\n                        :key=\"index\">\n                        <div class=\"group-name\" v-bk-overflow-tips>{{ item.groupName }}</div>\n                        <Icon\n                            v-if=\"item.tagMaxLength\"\n                            class=\"max-length-info\"\n                            v-bk-tooltips=\"'分组标签长度最大支持256，超过会被自动截断，请留意！'\"\n                            type=\"info\" />\n                        <div class=\"group-nums\">{{ item.agentTaskSize }}</div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n   \n    export default {\n        name: '',\n        props: {\n            data: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                isHide: true,\n                renderGroup: [],\n                toggleGroup: [],\n                chooseGroupName: '',\n            };\n        },\n        computed: {\n            groupHolder () {\n                if (this.toggleGroup.find(_ => _.groupName === this.chooseGroupName)) {\n                    return this.chooseGroupName;\n                }\n                return '更多分组';\n            },\n            showGroupToggle () {\n                return this.toggleGroup.length > 0;\n            },\n            groupToggleClass () {\n                if (this.toggleGroup.find(_ => _.groupName === this.chooseGroupName)) {\n                    return 'active';\n                }\n                return '';\n            },\n        },\n        watch: {\n            /**\n             * @desc 没有选中的分组和选中的分组不存在了，默认选中第一个\n             */\n            data: {\n                handler (data) {\n                    if (this.data.length < 1) {\n                        return;\n                    }\n                    // 没有选中的分组，默认选中第一个\n                    if (!this.chooseGroupName || !data.find(_ => _.groupName === this.chooseGroupName)) {\n                        this.handleGroupChange(data[0]);\n                    }\n                    this.isHide = true;\n                    this.renderGroup = Object.freeze(data);\n                    setTimeout(() => {\n                        this.initTab();\n                    }, 20);\n                },\n                immediate: true,\n            },\n        },\n        /**\n         * @desc 浏览器宽度变化时，重新计算分组的排版\n         */\n        mounted () {\n            const resizeHandler = _.throttle(() => {\n                this.renderGroup = this.data;\n                this.isHide = true;\n                this.timer = setTimeout(() => {\n                    this.initTab();\n                });\n            }, 100);\n            window.addEventListener('resize', resizeHandler);\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('resize', resizeHandler);\n                clearTimeout(this.timer);\n            });\n        },\n        methods: {\n            /**\n             * @desc 计算分组的排版，超过一行的分组聚合到最后\n             */\n            initTab () {\n                const { width } = this.$refs.groupTab.getBoundingClientRect();\n                const allGroup = [...this.$refs.groupTab.querySelectorAll('.tab-item')];\n                \n                let realTabCotentWidth = 0;\n                let realDisplayNum = 0;\n                // eslint-disable-next-line no-plusplus\n                for (realDisplayNum = 0; realDisplayNum < allGroup.length; realDisplayNum++) {\n                    const groupWidth = allGroup[realDisplayNum].getBoundingClientRect().width;\n                    if (realTabCotentWidth + groupWidth < width) {\n                        realTabCotentWidth += groupWidth;\n                        continue;\n                    } else {\n                        break;\n                    }\n                }\n                const isLast = realDisplayNum === allGroup.length - 1;\n                if (!isLast) {\n                    if (realTabCotentWidth + 124 > width) {\n                        realDisplayNum -= 1;\n                    }\n                }\n                this.renderGroup = Object.freeze(this.data.slice(0, realDisplayNum));\n                this.toggleGroup = Object.freeze(this.data.slice(realDisplayNum));\n                this.isHide = false;\n            },\n            /**\n             * @desc 切换分组\n             * @param {Object} group 最新选中的分组\n             */\n            handleGroupChange (group) {\n                this.chooseGroupName = group.groupName;\n                \n                this.$emit('on-change', {\n                    groupName: group.groupName,\n                    resultType: group.resultType || '',\n                    tag: group.tag,\n                });\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    @import \"@/css/mixins/scroll\";\n\n    .step-execute-host-group {\n        width: 100%;\n        padding: 0 24px;\n        background: #f5f6fa;\n        border-bottom: 1px solid #e2e2e2;\n\n        &.hide {\n            overflow: hidden;\n\n            .group-tab {\n                visibility: hidden;\n            }\n        }\n\n        .group-tab {\n            display: flex;\n            height: 40px;\n            color: #63656e;\n            visibility: visible;\n            transition: all 0.15s;\n\n            &.toggle {\n                .tab-item {\n                    margin-right: 0;\n                }\n            }\n\n            .tab-item,\n            .tab-more {\n                position: relative;\n                display: flex;\n                height: 41px;\n                padding: 0 20px;\n                font-size: 14px;\n                color: #63656e;\n                cursor: pointer;\n                border: 1px solid transparent;\n                border-top-right-radius: 6px;\n                border-top-left-radius: 6px;\n                align-items: center;\n                flex: 0 0 auto;\n            }\n\n            .tab-item {\n                &:hover,\n                &.active {\n                    color: #313238;\n\n                    .group-nums {\n                        color: #63656e;\n                    }\n                }\n\n                &.active {\n                    background: #fff;\n                    border-color: #dcdee5;\n                    border-bottom-color: #fff;\n                }\n            }\n\n            .tab-more {\n                justify-content: flex-end;\n            }\n\n            .group-name {\n                max-width: 225px;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n\n            .group-nums {\n                display: inline-block;\n                height: 16px;\n                min-width: 16px;\n                padding: 0 4px;\n                margin-left: 8px;\n                font-size: 12px;\n                font-weight: 500;\n                line-height: 16px;\n                color: #979ba5;\n                text-align: center;\n                background: #e6e7eb;\n                border-radius: 8px;\n            }\n\n            .max-length-info {\n                font-size: 16px;\n                color: #ea3636;\n            }\n        }\n\n        .group-toggle {\n            position: relative;\n            z-index: 999;\n\n            &:hover,\n            &.active {\n                .tab-more {\n                    color: #3a84ff;\n                }\n            }\n\n            &:hover {\n                .toggle-flag {\n                    transform: rotateZ(90deg);\n                }\n\n                .dropdown-menu {\n                    opacity: 100%;\n                    visibility: visible;\n                    transform: translateY(0);\n                }\n            }\n\n            .tab-more {\n                position: relative;\n                z-index: 99;\n                width: 124px;\n            }\n\n            .dropdown-menu {\n                position: absolute;\n                top: 50px;\n                right: 0;\n                width: 280px;\n                max-height: 300px;\n                padding: 6px 0;\n                overflow-y: scroll;\n                font-size: 12px;\n                background: #fff;\n                border: 1px solid #dcdee5;\n                opacity: 0%;\n                visibility: hidden;\n                transform: translateY(-15px);\n                transition: all 0.15s;\n\n                @mixin scroller;\n\n                &::before {\n                    position: absolute;\n                    top: -5px;\n                    right: 0;\n                    width: 124px;\n                    height: 8px;\n                    content: \"\";\n                }\n\n                .group-nums {\n                    margin-left: auto;\n                }\n            }\n\n            .dropdowm-item {\n                display: flex;\n                height: 32px;\n                padding: 0 10px;\n                cursor: pointer;\n                align-items: center;\n\n                &:hover,\n                &.active {\n                    color: #3a84ff;\n\n                    .group-nums {\n                        color: #fff;\n                        background: #3a84ff;\n                    }\n                }\n\n                &:hover {\n                    background: #f4f6fa;\n                }\n\n                &.active {\n                    background: #eaf3ff;\n                }\n            }\n\n            .toggle-flag {\n                margin-left: 2px;\n                transition: transform 0.15s;\n            }\n        }\n\n        .group-holder {\n            height: 19px;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            word-break: break-all;\n            white-space: nowrap;\n        }\n    }\n</style>\n","<template>\n    <div class=\"step-execute-host-list\" :style=\"styles\">\n        <list-head\n            class=\"ip-list-head\"\n            :columns=\"columnList\"\n            :show-columns=\"allShowColumn\"\n            @on-sort=\"handleSort\"\n            @on-copy=\"handleCopyIP\"\n            @on-show-setting=\"handleShowSetting\" />\n        <div ref=\"list\" class=\"ip-list-body\">\n            <scroll-faker @on-scroll=\"handleScroll\">\n                <list-body\n                    :columns=\"columnList\"\n                    :show-columns=\"allShowColumn\"\n                    :data=\"list\"\n                    @on-row-select=\"handleSelect\" />\n                <div v-if=\"hasMore\" ref=\"loading\" class=\"list-loading\">\n                    <div class=\"loading-flag\">\n                        <Icon type=\"loading-circle\" />\n                    </div>\n                    <div>{{ '加载中' }}</div>\n                </div>\n                <template v-if=\"list.length < 1 && !listLoading\">\n                    <Empty v-if=\"!searchValue\" style=\"height: 100%;\" />\n                    <Empty v-else type=\"search\" style=\"height: 100%;\">\n                        <div>\n                            <div style=\"font-size: 14px; color: #63656e;\">{{ '搜索结果为空' }}</div>\n                            <div style=\"margin-top: 8px; font-size: 12px; line-height: 16px; color: #979ba5;\">\n                                <span>{{ '可以尝试调整关键词' }}</span>\n                                <template>\n                                    <span>{{ '或' }}</span>\n                                    <bk-button\n                                        text\n                                        @click=\"handleClearSearch\">\n                                        {{ '清空搜索条件' }}\n                                    </bk-button>\n                                </template>\n                            </div>\n                        </div>\n                    </Empty>\n                </template>\n            </scroll-faker>\n        </div>\n        <div\n            v-show=\"isSetting\"\n            class=\"list-column-select\">\n            <div class=\"select-body\">\n                <div class=\"title\">{{ '字段显示设置' }}</div>\n                <bk-checkbox\n                    @click.native=\"handleToggleAll\"\n                    :indeterminate=\"isIndeterminate\"\n                    :checked=\"isAllColumn\">\n                    {{ '全选' }}\n                </bk-checkbox>\n                <bk-checkbox-group v-model=\"tempAllShowColumn\">\n                    <bk-checkbox\n                        class=\"select-column\"\n                        v-for=\"item in columnList\"\n                        :key=\"item.name\"\n                        :checked=\"item.checked\"\n                        \n                        :value=\"item.name\">\n                        {{ item.label }}\n                    </bk-checkbox>\n                </bk-checkbox-group>\n            </div>\n            <div class=\"select-footer\">\n                <bk-button\n                    theme=\"primary\"\n                    @click=\"handleSubmitSetting\">\n                    {{ '确定' }}\n                </bk-button>\n                <bk-button @click=\"handleHideSetting\">\n                    {{ '取消' }}\n                </bk-button>\n            </div>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import {\n        getOffset,\n    } from '@utils/assist';\n    import Empty from '@components/empty';\n    import ListHead from './list-head';\n    import ListBody from './list-body';\n\n    const COLUMN_CACHE_KEY = 'STEP_EXECUTE_IP_COLUMN';\n    const LIST_ROW_HEIGHT = 40; // 每列高度\n\n    export default {\n        name: '',\n        components: {\n            Empty,\n            ListHead,\n            ListBody,\n        },\n        props: {\n            name: {\n                type: [\n                    String,\n                    Number,\n                ],\n                required: true,\n            },\n            data: {\n                type: Array,\n                default: () => [],\n            },\n            listLoading: {\n                type: Boolean,\n                default: false,\n            },\n            paginationLoading: {\n                type: Boolean,\n                default: false,\n            },\n            total: {\n                type: Number,\n                default: 0,\n            },\n            searchValue: String,\n        },\n        data () {\n            let allShowColumn = [\n                'displayIp',\n                'totalTime',\n                'cloudAreaName',\n                'exitCode',\n            ];\n            if (localStorage.getItem(COLUMN_CACHE_KEY)) {\n                allShowColumn = JSON.parse(localStorage.getItem(COLUMN_CACHE_KEY));\n            }\n            return {\n                list: [{},{},{}],\n                columnList: Object.freeze([\n                    {\n                        label: 'IP',\n                        name: 'displayIp',\n                        width: '140',\n                        checked: true,\n                        disabled: true,\n                    },\n                    {\n                        label: '耗时(s)',\n                        name: 'totalTime',\n                        orderField: 'totalTime',\n                        order: '',\n                        width: '120',\n                        checked: true,\n                    },\n                    {\n                        label: '云区域',\n                        name: 'cloudAreaName',\n                        orderField: 'cloudAreaId',\n                        order: '',\n                        width: '',\n                        checked: true,\n                    },\n                    {\n                        label: '返回码',\n                        name: 'exitCode',\n                        orderField: 'exitCode',\n                        order: '',\n                        width: '114',\n                        checked: true,\n                    },\n                ]),\n                page: 1,\n                pageSize: 0,\n                isSetting: false,\n                allShowColumn,\n                tempAllShowColumn: allShowColumn,\n            };\n        },\n        computed: {\n            /**\n             * @desc 列选择是否半选状态\n             * @return {Boolean}\n             */\n            isIndeterminate () {\n                return this.tempAllShowColumn.length !== this.columnList.length;\n            },\n            /**\n             * @desc 列选择是否全选状态\n             * @return {Boolean}\n             */\n            isAllColumn () {\n                return this.tempAllShowColumn.length === this.columnList.length;\n            },\n            /**\n             * @desc IP 列表样式判断\n             * @return {Object}\n             */\n            styles () {\n                const width = 217 + (this.allShowColumn.length - 1) * 94;\n                return {\n                    width: `${width}px`,\n                };\n            },\n            /**\n             * @desc 列选择是否半选状态\n             * @return {Boolean}\n             */\n            hasMore () {\n                return this.page * this.pageSize < this.total;\n            },\n        },\n        \n        watch: {\n            /**\n             * @desc IP 列表名称变化时重置翻页\n             */\n            name () {\n                this.page = 1;\n            },\n            data: {\n                handler (data) {\n                    this.list = Object.freeze(data);\n                },\n                immediate: true,\n            },\n        },\n        mounted () {\n            this.calcPageSize();\n            window.addEventListener('resize', this.handleScroll);\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('resize', this.handleScroll);\n            });\n        },\n        methods: {\n            /**\n             * @desc 根据屏幕高度计算单页 pageSize\n             */\n            calcPageSize () {\n                const { top } = getOffset(this.$refs.list);\n                const windowHeight = window.innerHeight;\n                const listHeight = windowHeight - top - 20;\n                this.pageSize = parseInt(listHeight / LIST_ROW_HEIGHT + 6, 10);\n                this.$emit('on-pagination-change', this.pageSize);\n            },\n            /**\n             * @desc 滚动加载\n             */\n            handleScroll: _.throttle(function () {\n                if (!this.hasMore) {\n                    return;\n                }\n                const windowHeight = window.innerHeight;\n                const { top } = this.$refs.loading.getBoundingClientRect();\n                \n                if (top - 80 < windowHeight) {\n                    // 增加分页\n                    this.page += 1;\n                    this.$emit('on-pagination-change', this.page * this.pageSize);\n                }\n            }, 80),\n            /**\n             * @desc 复制ip\n             */\n            handleCopyIP () {\n                this.$emit('on-copy');\n            },\n            /**\n             * @desc 显示列配置面板\n             */\n            handleShowSetting () {\n                this.isSetting = true;\n            },\n            /**\n             * @desc 隐藏列配置面板\n             */\n            handleHideSetting () {\n                this.isSetting = false;\n            },\n            /**\n             * @desc 列配置面板全选状态切换\n             */\n            handleToggleAll () {\n                if (this.isAllColumn) {\n                    this.tempAllShowColumn = this.columnList.reduce((result, item) => {\n                        if (item.disabled) {\n                            result.push(item.name);\n                        }\n                        return result;\n                    }, []);\n                } else {\n                    this.tempAllShowColumn = this.columnList.map(item => item.name);\n                }\n            },\n            /**\n             * @desc 保存列配置\n             */\n            handleSubmitSetting () {\n                this.allShowColumn = [\n                    ...this.tempAllShowColumn,\n                ];\n                this.isSetting = false;\n                localStorage.setItem(COLUMN_CACHE_KEY, JSON.stringify(this.allShowColumn));\n            },\n            /**\n             * @desc 表格排序\n             * @param {Object} column 操作列数据\n             */\n            handleSort (column) {\n                const {\n                    orderField,\n                    order,\n                } = column;\n                const newOrder = order === 1 ? 0 : 1;\n                column.order = newOrder;\n                \n                this.columnList = Object.freeze(this.columnList.map((item) => {\n                    item.order = '';\n                    if (item.orderField === orderField) {\n                        item.order = newOrder;\n                    }\n                    return { ...item };\n                }));\n                this.$emit('on-sort', {\n                    orderField,\n                    order: newOrder,\n                });\n                this.$emit('on-pagination-change', this.pageSize);\n            },\n            /**\n             * @desc 选择表格一行数据\n             * @param {Object} row 选择数据\n             */\n            handleSelect (row) {\n                this.$emit('on-change', row);\n            },\n            /**\n             * @desc 清空搜索\n             */\n            handleClearSearch () {\n                this.$emit('on-clear-search');\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    @keyframes list-loading-ani {\n        0% {\n            transform: rotateZ(0);\n        }\n\n        100% {\n            transform: rotateZ(360deg);\n        }\n    }\n\n    .step-execute-host-list {\n        position: relative;\n        width: 287px;\n        height: 100%;\n        max-height: 100%;\n        min-height: 100%;\n        transition: all 0.3s;\n\n        .ip-list-body {\n            height: calc(100% - 41px);\n        }\n\n        .ip-table {\n            width: 100%;\n\n            th,\n            td {\n                height: 40px;\n                padding-left: 26px;\n                line-height: 40px;\n                text-align: left;\n                white-space: nowrap;\n                border-bottom: 1px solid #dcdee5;\n            }\n\n            th {\n                position: relative;\n                font-weight: normal;\n                color: #313238;\n\n                &.sort {\n                    cursor: pointer;\n                }\n\n                .sort-box {\n                    position: absolute;\n                    top: 0;\n                    display: inline-flex;\n                    height: 100%;\n                    margin-left: 9px;\n                    font-size: 6px;\n                    color: #c4c6cc;\n                    justify-content: center;\n                    flex-direction: column;\n\n                    .top,\n                    .bottom {\n                        width: 0;\n                        height: 0;\n                        margin: 1px 0;\n                        border: 5px solid transparent;\n\n                        &.active {\n                            color: #3a84ff;\n                        }\n                    }\n\n                    .top {\n                        border-bottom-color: currentcolor;\n                    }\n\n                    .bottom {\n                        border-top-color: currentcolor;\n                    }\n                }\n            }\n\n            td {\n                color: #63656e;\n                cursor: pointer;\n            }\n\n            tbody {\n                tr {\n                    &.active {\n                        background: #f0f1f5;\n\n                        .active-flag {\n                            font-size: 14px;\n                        }\n                    }\n\n                    .active-flag {\n                        padding: 0;\n                        font-size: 0;\n                        color: #979ba5;\n                        text-align: center;\n                    }\n                }\n            }\n\n            .copy-ip-btn {\n                margin-left: 8px;\n                font-size: 12px;\n                font-weight: normal;\n                color: #3a84ff;\n                cursor: pointer;\n            }\n\n            .list-action {\n                width: 40px;\n                height: 40px;\n                padding: 0;\n                font-size: 14px;\n                color: #979ba5;\n                text-align: center;\n                cursor: pointer;\n                border-left: 1px solid #dcdee5;\n            }\n\n            .success,\n            .fail,\n            .running,\n            .waiting {\n                &::before {\n                    display: inline-block;\n                    width: 3px;\n                    height: 12px;\n                    margin-right: 1em;\n                    margin-left: -3px;\n                    background: #2dc89d;\n                    content: \"\";\n                }\n            }\n\n            .fail {\n                &::before {\n                    background: #ea3636;\n                }\n            }\n\n            .running {\n                &::before {\n                    background: #699df4;\n                }\n            }\n\n            .waiting {\n                &::before {\n                    background: #dcdee5;\n                }\n            }\n        }\n\n        .list-loading {\n            display: flex;\n            height: 40px;\n            font-size: 12px;\n            color: #979ba5;\n            text-align: center;\n            align-items: center;\n            justify-content: center;\n\n            .loading-flag {\n                display: flex;\n                width: 20px;\n                height: 20px;\n                animation: list-loading-ani 1s linear infinite;\n                align-items: center;\n                justify-content: center;\n                transform-origin: center center;\n            }\n        }\n\n        .list-column-select {\n            position: absolute;\n            top: 45px;\n            left: 0;\n            z-index: 1;\n            width: 100%;\n            background: #fff;\n            box-shadow: 1px 1px 5px 0 #dcdee5;\n        }\n\n        .select-body {\n            padding: 15px 22px 30px;\n\n            .title {\n                margin-bottom: 22px;\n                font-size: 16px;\n                color: #313238;\n            }\n        }\n\n        .select-column {\n            margin-top: 20px;\n            margin-right: 36px;\n\n            &:last-child {\n                margin-right: 0;\n            }\n        }\n\n        .select-footer {\n            display: flex;\n            height: 50px;\n            background: #fafbfd;\n            border-top: 1px solid #dbdde4;\n            align-items: center;\n            justify-content: center;\n\n            .bk-button {\n                margin: 0 5px;\n            }\n        }\n    }\n</style>\n","<template>\n    <div\n        class=\"step-execute-script-log\"\n        v-bkloading=\"{\n            isLoading, opacity: .1,\n        }\">\n        <div class=\"log-wraper\">\n            <div v-once id=\"executeScriptLog\" style=\"height: 100%;\" />\n        </div>\n        <div class=\"log-status\" v-if=\"ip && isRunning\">\n            <div class=\"log-loading\">{{ '执行中' }}</div>\n        </div>\n        <div class=\"log-action-box\">\n            <div class=\"action-item\" v-bk-tooltips=\"backTopTips\" @click=\"handleScrollTop\">\n                <Icon type=\"up-to-top\" />\n            </div>\n            <div class=\"action-item action-bottom\" v-bk-tooltips=\"backBottomTips\" @click=\"handleScrollBottom\">\n                <Icon type=\"up-to-top\" />\n            </div>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import ace from 'ace/ace';\n    import 'ace/mode-text';\n    import 'ace/theme-monokai';\n    import 'ace/ext-searchbox';\n       import TaskExecuteService from '@service/task-execute';\n    import mixins from '../../mixins';\n\n    export default {\n        mixins: [\n            mixins,\n        ],\n        props: {\n            name: String,\n            stepInstanceId: {\n                type: Number,\n                required: true,\n            },\n            ip: {\n                type: String,\n            },\n            retryCount: {\n                type: Number,\n                required: true,\n            },\n            logFilter: {\n                type: String,\n                default: '',\n            },\n            fontSize: {\n                type: Number,\n                default: 12,\n            },\n            lineFeed: {\n                type: Boolean,\n                default: true,\n            },\n        },\n        data () {\n            return {\n                // 日志loading，切换主机的时候才显示\n                isLoading: true,\n                // 是否执行中\n                isRunning: false,\n                // 自动动滚动到底部\n                isWillAutoScroll: true,\n            };\n        },\n        watch: {\n            /**\n             * @desc 查看的日志目标改变，重新获取日志\n             *\n             * 日志目标改变，重置页面操作的数据\n             */\n            name: {\n                handler () {\n                    // 日志自动滚动\n                    this.isLoading = true;\n                    this.autoScrollTimeout();\n                    this.fetchLogContent();\n                },\n                immediate: true,\n            },\n            /**\n             * @desc 字体大小改变时虚拟滚动重新计算\n             */\n            fontSize: {\n                handler (fontSize) {\n                    this.editor.setFontSize(fontSize);\n                },\n            },\n            lineFeed: {\n                handler (lineFeed) {\n                    setTimeout(() => {\n                        this.editor && this.editor.setOptions({\n                            wrap: lineFeed ? 'free' : 'none',\n                        });\n                    });\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.backTopTips = {\n                content: '回到顶部',\n                placements: [\n                    'top',\n                ],\n                theme: 'light',\n            };\n            this.backBottomTips = {\n                content: '前往底部',\n                placements: [\n                    'top',\n                ],\n                theme: 'light',\n            };\n        },\n        mounted () {\n            this.initEditor();\n        },\n        methods: {\n            /**\n             * @desc 获取脚本日志\n             */\n            fetchLogContent () {\n                if (!this.ip) {\n                    this.isLoading = false;\n                    if (this.editor) {\n                        this.editor.setValue('');\n                        this.editor.clearSelection();\n                    }\n                    return;\n                }\n                TaskExecuteService.fetchLogContentOfIp({\n                    stepInstanceId: this.stepInstanceId,\n                    retryCount: this.retryCount,\n                    ip: this.ip,\n                })\n                    .then(({\n                        finished,\n                        logContent,\n                    }) => {\n                        this.isRunning = !finished;\n                        this.$nextTick(() => {\n                            this.editor.setValue(_.trim(logContent || '', '\\n'));\n                            this.editor.clearSelection();\n                        });\n                        // 当前主机执行结束\n                        if (!finished) {\n                            this.$pollingQueueRun(this.fetchLogContent);\n                        }\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            initEditor () {\n                const editor = ace.edit('executeScriptLog');\n                editor.getSession().setMode('ace/mode/text');\n                editor.setTheme('ace/theme/monokai');\n                editor.setOptions({\n                    fontSize: this.fontSize,\n                    wrapBehavioursEnabled: true,\n                    copyWithEmptySelection: true,\n                    useElasticTabstops: true,\n                    printMarginColumn: false,\n                    printMargin: 80,\n                    showPrintMargin: false,\n                    scrollPastEnd: 0.05,\n                    fixedWidthGutter: true,\n                });\n                editor.$blockScrolling = Infinity;\n                editor.setReadOnly(true);\n                const editorSession = editor.getSession();\n                // 自动换行时不添加缩进\n                editorSession.$indentedSoftWrap = false;\n                editorSession.on('changeScrollTop', (scrollTop) => {\n                    const {\n                        height,\n                        maxHeight,\n                    } = editor.renderer.layerConfig;\n                    this.isWillAutoScroll = height + scrollTop + 30 >= maxHeight;\n                });\n                this.editor = editor;\n                this.$once('hook:beforeDestroy', () => {\n                    editor.destroy();\n                    editor.container.remove();\n                });\n            },\n            /**\n             * @desc 外部调用\n             */\n            resize () {\n                this.$nextTick(() => {\n                    this.editor.resize();\n                });\n            },\n            /**\n             * @desc 日志滚动定时器\n             */\n            autoScrollTimeout () {\n                if (this.isWillAutoScroll && !this.isLoading) {\n                    this.handleScrollBottom();\n                }\n                setTimeout(() => {\n                    this.autoScrollTimer = this.autoScrollTimeout();\n                }, 1000);\n            },\n            /**\n             * @desc 回到日志顶部\n             */\n            handleScrollTop () {\n                this.editor.scrollToLine(0);\n            },\n            /**\n             * @desc 回到日志底部\n             */\n            handleScrollBottom () {\n                this.isWillAutoScroll = true;\n                this.editor.scrollToLine(Infinity);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    @keyframes script-execute-loading {\n        0% {\n            content: \".\";\n        }\n\n        30% {\n            content: \"..\";\n        }\n\n        60% {\n            content: \"...\";\n        }\n    }\n\n    .step-execute-script-log {\n        position: relative;\n        height: 100%;\n        max-height: 100%;\n        min-height: 100%;\n\n        .log-wraper {\n            position: absolute;\n            top: 0;\n            bottom: 20px;\n            left: 0;\n            width: 100%;\n            padding-right: 20px;\n            /* stylelint-disable selector-class-pattern */\n            .ace_editor {\n                overflow: unset;\n                line-height: 1.6;\n                color: #c4c6cc;\n                background: #1d1d1d;\n\n                .ace_gutter {\n                    padding-top: 4px;\n                    margin-bottom: -4px;\n                    color: #63656e;\n                    background: #292929;\n                }\n\n                .ace_scroller {\n                    padding-top: 4px;\n                    margin-bottom: -4px;\n                }\n\n                .ace_hidden-cursors .ace_cursor {\n                    opacity: 0% !important;\n                }\n\n                .ace_selected-word {\n                    background: rgb(135 139 145 / 25%);\n                }\n\n                .ace_scrollbar-v,\n                .ace_scrollbar-h {\n                    &::-webkit-scrollbar-thumb {\n                        background-color: #3b3c42;\n                        border: 1px solid #63656e;\n                    }\n\n                    &::-webkit-scrollbar-corner {\n                        background-color: transparent;\n                    }\n                }\n\n                .ace_scrollbar-v {\n                    margin-right: -20px;\n\n                    &::-webkit-scrollbar {\n                        width: 14px;\n                    }\n                }\n\n                .ace_scrollbar-h {\n                    margin-bottom: -20px;\n\n                    &::-webkit-scrollbar {\n                        height: 14px;\n                    }\n                }\n            }\n        }\n\n        .log-status {\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            padding-left: 20px;\n            color: #fff;\n        }\n\n        .log-loading {\n            &::after {\n                display: inline-block;\n                content: \".\";\n                animation: script-execute-loading 2s linear infinite;\n            }\n        }\n\n        .keyword {\n            color: #212124;\n            background: #f0dc73;\n        }\n\n        .log-action-box {\n            position: absolute;\n            right: 20px;\n            bottom: 20px;\n            z-index: 10;\n            display: flex;\n\n            .action-item {\n                position: relative;\n                display: flex;\n                width: 32px;\n                height: 32px;\n                margin-left: 12px;\n                font-size: 18px;\n                color: #000;\n                cursor: pointer;\n                background: rgb(255 255 255 / 80%);\n                border-radius: 50%;\n                align-items: center;\n                justify-content: center;\n\n                &:hover {\n                    background: rgb(255 255 255);\n                }\n\n                &.action-bottom {\n                    transform: rotateZ(180deg);\n                }\n            }\n        }\n    }\n</style>\n","\n\n<script>\n    const statusMap = {\n        1: 'waiting',\n        2: 'uploading',\n        3: 'downloading',\n        4: 'finished',\n        5: 'failed',\n    };\n\n    export default {\n        functional: true,\n        render (h, context) {\n            const { props, listeners, parent } = context;\n            const {\n                data,\n                openMemo,\n                renderContentMap,\n                isContentLoading,\n            } = props;\n            const isContentOpen = Boolean(openMemo[data.taskId]);\n\n            const classes = {\n                'step-detail-file-log-block': true,\n                [statusMap[data.status]]: true,\n                toggle: isContentOpen,\n            };\n            // 异步获取日志的loading状态\n            const logContent = renderContentMap[data.taskId] || data.logContent;\n            if (isContentLoading && !logContent) {\n                classes['content-loading'] = true;\n            }\n            const renderProgress = () => {\n                const wholeProgress = '*******************************************************************************************';\n                const process = parseInt(data.progress, 10) / 100;\n                return wholeProgress.slice(0, Math.floor(process * wholeProgress.length) || 1);\n            };\n            const handleToggle = () => {\n                listeners['on-toggle'](data.taskId, !isContentOpen);\n            };\n            return (\n            <div class={classes}>\n                <div class=\"log-header\" onClick={handleToggle}>\n                    <i class=\"job-icon job-icon-down-small log-toggle\" />\n                    <span>{'文件名' }：{ data.fileName }</span>\n                    <span>{'文件大小' }：{ data.fileSize }</span>\n                    <span>{'状态'}：<span class=\"status\">{ data.statusDesc }</span></span>\n                    <span>{'源服务器 IP' }：{ data.srcIp }</span>\n                    <span>{'速率' }：{ data.speed }</span>\n                    <span>{'进度' }：{ data.progress }</span>\n                </div>\n                {\n                    isContentOpen && (\n                        <div class=\"log-body\">\n                            <div class=\"log-content\">{ logContent }</div>\n                            <div class=\"log-process\">{ renderProgress() }</div>\n                        </div>\n                    )\n                }\n            </div>\n            );\n        },\n    };\n</script>\n<style lang='postcss'>\n    @keyframes file-loading-ani {\n        0% {\n            content: \"*\";\n        }\n\n        30% {\n            content: \"**\";\n        }\n\n        60% {\n            content: \"***\";\n        }\n    }\n\n    .step-detail-file-log-block {\n        padding-left: 48px;\n        margin-top: 10px;\n        font-size: 13px;\n        line-height: 18px;\n        color: #dcdee5;\n\n        &.toggle {\n            .log-body {\n                display: block;\n            }\n\n            .log-toggle {\n                transform: rotateZ(0);\n            }\n        }\n\n        &.waiting,\n        &.uploading,\n        &.downloading &.content-loading {\n            .log-process {\n                &::after {\n                    display: inline-block;\n                    content: \"*\";\n                    animation: file-loading-ani 2s linear infinite;\n                }\n            }\n        }\n\n        &.waiting {\n            .status {\n                color: #dcdee5;\n            }\n        }\n\n        &.uploading,\n        &.downloading {\n            .status {\n                color: #3a84ff;\n            }\n        }\n\n        &.failed {\n            .status {\n                color: #ea3636;\n            }\n        }\n\n        &.finished {\n            .status {\n                color: #3fc06d;\n            }\n        }\n\n        .log-header {\n            position: relative;\n            line-height: 24px;\n            white-space: nowrap;\n            cursor: pointer;\n\n            & > * {\n                margin-right: 40px;\n            }\n        }\n\n        .log-toggle {\n            position: absolute;\n            top: 0;\n            left: -34px;\n            font-size: 24px;\n            transform: rotateZ(-90deg);\n            transition: transform 0.15s;\n        }\n\n        .log-body {\n            display: none;\n        }\n\n        .log-content {\n            margin-top: 2px;\n            line-height: 22px;\n            color: #979ba5;\n            white-space: pre;\n        }\n    }\n</style>\n","<template>\n    <div\n        ref=\"contentBox\"\n        class=\"file-download-log\"\n        @scroll=\"handleScroll\"\n        v-bkloading=\"{ isLoading, opacity: .1 }\">\n        <div>\n            <file-item\n                v-for=\"(item, index) in renderList\"\n                :key=\"index\"\n                :index=\"index\"\n                :open-memo=\"openMemo\"\n                :data=\"item\"\n                :render-content-map=\"renderContentMap\"\n                :is-content-loading=\"isAsyncContentLoading\"\n                @on-toggle=\"handleToggle\" />\n        </div>\n        <div v-if=\"renderNums < contentList.length\" ref=\"load\" class=\"load-more\">\n            <div class=\"loading-flag\">\n                <Icon type=\"loading-circle\" />\n            </div>\n            <div>{{ '加载中' }}</div>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import TaskExecuteService from '@service/task-execute';\n    import {\n        getOffset,\n    } from '@utils/assist';\n    import mixins from '../../mixins';\n    import FileItem from './log-item';\n\n    export default {\n        name: '',\n        components: {\n            FileItem,\n        },\n        mixins: [\n            mixins,\n        ],\n        props: {\n            name: String,\n            stepInstanceId: {\n                type: Number,\n                required: true,\n            },\n            ip: {\n                type: String,\n            },\n            retryCount: {\n                type: Number,\n                required: true,\n            },\n            mode: {\n                type: String,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                // 基础信息loading\n                isLoading: true,\n                // 异步获取日志内容loading\n                isAsyncContentLoading: false,\n                // 文件基础信息列表\n                contentList: [{},{},{}],\n                // 一屏显示最小日志行数\n                onePageNums: 0,\n                // 前端分页页码\n                page: 0,\n                pageSize: 10,\n                // 被展开的日志记录\n                openMemo: {},\n                // 被展开的文件具体日志内容\n                renderContentMap: {},\n            };\n        },\n        computed: {\n            renderNums () {\n                return this.onePageNums + this.pageSize * this.page;\n            },\n            renderList () {\n                return this.contentList.slice(0, this.renderNums);\n            },\n        },\n        watch: {\n            /**\n             * @desc 查看的日志目标改变，重新获取日志\n             */\n            name: {\n                handler () {\n                    this.isLoading = true;\n                    this.isMemoChange = false;\n                    this.page = 0;\n\n                    this.fetchData();\n                    if (this.$refs.contentBox) {\n                        this.$refs.contentBox.scrollTop = 0;\n                    }\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            // 缓存是否有展开日志的操作\n            this.isMemoChange = false;\n            // 前端分页加载器，控制触发频率\n            this.timer = null;\n            // 日志列表中是否包含日志内容标记，如果不包含需要异步获取日志内容\n            this.includingLogContent = '';\n        },\n        mounted () {\n            this.calcFirstPageNums();\n            window.addEventListener('resize', this.handleScroll);\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('resize', this.handleScroll);\n            });\n        },\n        methods: {\n            /**\n             * @desc 获取文件日志\n             *\n             * 默认展开第一个文件的日志\n             * 如果文件信息里面不包含日志内容，需要异步获取文件内容\n             */\n            fetchData () {\n                if (!this.ip) {\n                    this.isLoading = false;\n                    this.contentList = [];\n                    return;\n                }\n                TaskExecuteService.fetchFileLogOfIp({\n                    stepInstanceId: this.stepInstanceId,\n                    retryCount: this.retryCount,\n                    ip: this.ip,\n                    mode: this.mode,\n                }).then((data) => {\n                    const {\n                        fileDistributionDetails,\n                        includingLogContent,\n                        finished,\n                    } = data;\n                    this.contentList = Object.freeze(fileDistributionDetails);\n                    this.includingLogContent = includingLogContent;\n                    // 初始展开第一个\n                    if (this.contentList.length > 0 && !this.isMemoChange) {\n                        this.openMemo = {\n                            [this.contentList[0].taskId]: true,\n                        };\n                        this.isMemoChange = true;\n                    }\n                    // 日志量大异步获取展开的文件\n                    this.fetchFileLogOfFile();\n                    // 主机还在执行轮询日志\n                    if (!finished) {\n                        this.$pollingQueueRun(this.fetchData);\n                    }\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 异步获取文件内容\n             *\n             * 如果日志列表中包含日志内容则不用重复获取\n             */\n            fetchFileLogOfFile: _.throttle(function () {\n                if (this.includingLogContent) {\n                    return;\n                }\n                this.isAsyncContentLoading = true;\n                TaskExecuteService.fetchFileLogOfFile({\n                    stepInstanceId: this.stepInstanceId,\n                    retryCount: this.retryCount,\n                    taskIds: Object.keys(this.openMemo),\n                }).then((data) => {\n                    this.renderContentMap = Object.freeze(data.reduce((result, item) => {\n                        result[item.taskId] = item.logContent;\n                        return result;\n                    }, {}));\n                })\n                    .finally(() => {\n                        this.isAsyncContentLoading = false;\n                    });\n            }, 500),\n            /**\n             * @desc 外部调用\n             */\n            resize () {\n                this.handleScroll();\n            },\n            /**\n             * @desc 计算首屏需要渲染的文件数\n             */\n            calcFirstPageNums () {\n                const windowHeight = window.innerHeight;\n                const { top } = getOffset(this.$refs.contentBox);\n                this.onePageNums = Math.ceil((windowHeight - top) / 34) + 3;\n            },\n            /**\n             * @desc 滚动分页加载\n             */\n            handleScroll: _.throttle(function () {\n                if (!this.$refs.load) {\n                    return;\n                }\n                const windowHeight = window.innerHeight;\n                const { top } = this.$refs.load.getBoundingClientRect();\n                if (windowHeight + 50 > top && !this.timer) {\n                    // 本地日志加载器\n                    this.timer = setTimeout(() => {\n                        this.page += 1;\n                        this.timer = 0;\n                    }, 350);\n                }\n            }, 80),\n            /**\n             * @desc 文件日志展开收起\n             *\n             * 展开时需要重新获取一次日志\n             */\n            handleToggle (taskId, toggle) {\n                const openMemo = { ...this.openMemo };\n                openMemo[taskId] = toggle;\n                this.openMemo = Object.freeze(openMemo);\n                if (toggle) {\n                    this.fetchFileLogOfFile();\n                }\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    @keyframes file-log-loading-ani {\n        0% {\n            transform: rotateZ(0);\n        }\n\n        100% {\n            transform: rotateZ(360deg);\n        }\n    }\n\n    .file-download-log {\n        height: 100%;\n        padding-top: 10px;\n        overflow-y: scroll;\n\n        &::-webkit-scrollbar {\n            width: 14px;\n        }\n\n        &::-webkit-scrollbar-thumb {\n            background-color: #3b3c42;\n            border: 1px solid #63656e;\n        }\n\n        &::-webkit-scrollbar-corner {\n            background-color: transparent;\n        }\n\n        .load-more {\n            display: flex;\n            align-items: center;\n            height: 20px;\n            padding-top: 20px;\n            padding-bottom: 24px;\n            padding-left: 44px;\n            color: #fff;\n\n            .loading-flag {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                width: 20px;\n                height: 20px;\n                transform-origin: center center;\n                animation: file-log-loading-ani 1s linear infinite;\n            }\n        }\n    }\n</style>\n","<template>\n    <div\n        class=\"step-execute-variable-view\"\n        v-bkloading=\"{ isLoading: isLoading, opacity: .1 }\">\n        <scroll-faker theme=\"dark\">\n            <table>\n                <thead>\n                    <tr>\n                        <td style=\"width: 90px;\">{{ '变量名称' }}</td>\n                        <td style=\"width: 90px;\">{{ '变量类型' }}</td>\n                        <td>{{ '变量值' }}</td>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr v-for=\"(item, index) in variableList\" :key=\"index\">\n                        <td>{{ item.name }}</td>\n                        <td>{{ item.typeText }}</td>\n                        <td class=\"variable-value\">{{ item.value }}</td>\n                    </tr>\n                </tbody>\n            </table>\n        </scroll-faker>\n    </div>\n</template>\n<script>\n    import TaskExecuteService from '@service/task-execute';\n    \n    export default {\n        name: '',\n        inheritAttrs: false,\n        props: {\n            name: String,\n            stepInstanceId: {\n                type: Number,\n                required: true,\n            },\n            ip: {\n                type: String,\n            },\n        },\n        data () {\n            return {\n                isLoading: true,\n                variableList: [{},{},{}],\n            };\n        },\n        watch: {\n            name: {\n                handler () {\n                    this.isLoading = true;\n                    this.fetchStepVariables();\n                },\n                immediate: true,\n            },\n        },\n        methods: {\n            // 步骤使用的变量\n            fetchStepVariables () {\n                if (!this.ip) {\n                    this.isLoading = false;\n                    return;\n                }\n                TaskExecuteService.fetchStepVariables({\n                    id: this.stepInstanceId,\n                    ip: this.ip,\n                }).then((data) => {\n                    this.variableList = Object.freeze(data);\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .step-execute-variable-view {\n        height: 100%;\n        padding: 0 20px;\n        font-family: Monaco, Menlo, \"Ubuntu Mono\", Consolas, source-code-pro, monospace;\n        color: #c4c6cc;\n        white-space: pre-line;\n\n        table {\n            width: 100%;\n        }\n\n        th,\n        td {\n            height: 40px;\n            padding-right: 10px;\n            border-bottom: 1px solid #3b3c42;\n        }\n\n        th {\n            color: #ccc;\n        }\n\n        td {\n            color: #979ba5;\n\n            &:first-child {\n                white-space: pre;\n            }\n\n            &.variable-value {\n                word-break: break-word;\n            }\n        }\n    }\n</style>\n","<template>\n    <div ref=\"infoBox\" class=\"step-execution-info-box\" :style=\"boxStyles\">\n        <div class=\"tab-container\">\n            <div class=\"tab-title\" :class=\"host.result\">\n                <span class=\"host-ip\">{{ host.displayIp || '--' }}</span>\n            </div>\n            <div class=\"split-line\" />\n            <div\n                v-if=\"!isFile\"\n                class=\"tab-item\"\n                :class=\"{ active: activePanel === 'scriptLog' }\"\n                @click=\"handleTogglePanel('scriptLog')\">\n                {{ '执行日志' }}\n            </div>\n            <template v-if=\"isFile\">\n                <div\n                    class=\"tab-item\"\n                    :class=\"{ active: activePanel === 'download' }\"\n                    @click=\"handleTogglePanel('download')\">\n                    {{ '下载信息' }}\n                </div>\n                <div\n                    class=\"tab-item\"\n                    :class=\"{ active: activePanel === 'upload' }\"\n                    @click=\"handleTogglePanel('upload')\">\n                    {{ '上传源信息' }}\n                </div>\n            </template>\n            <div\n                v-if=\"isTask && !isFile\"\n                class=\"tab-item\"\n                :class=\"{ active: activePanel === 'variable' }\"\n                @click=\"handleTogglePanel('variable')\">\n                {{ '变量明细' }}\n            </div>\n            <div class=\"extend-box\">\n                <div\n                    v-if=\"activePanel === 'scriptLog'\"\n                    class=\"extend-item\"\n                    v-bk-tooltips=\"'下载日志'\"\n                    @click=\"handleDownload\">\n                    <Icon type=\"download\" />\n                </div>\n                <div\n                    v-if=\"activePanel === 'scriptLog'\"\n                    class=\"extend-item\"\n                    @mouseenter=\"handleShowSetFont\"\n                    @mouseleave=\"handleHideSetFont\">Aa</div>\n                <div\n                    v-if=\"!isFullscreen\"\n                    class=\"extend-item\"\n                    v-bk-tooltips=\"'全屏'\"\n                    @click=\"handleFullscreen\">\n                    <Icon type=\"full-screen\" />\n                </div>\n                <div\n                    v-if=\"isFullscreen\"\n                    class=\"extend-item\"\n                    v-bk-tooltips=\"'还原'\"\n                    @click=\"handleExitFullscreen\">\n                    <Icon type=\"un-full-screen\" />\n                </div>\n                <div\n                    v-if=\"activePanel === 'scriptLog'\"\n                    class=\"extend-item\"\n                    style=\"padding-left: 16px; border-left: 1px solid #262626;\">\n                    <bk-switcher\n                        :value=\"isScriptLogLineFeed\"\n                        theme=\"primary\"\n                        size=\"small\"\n                        @change=\"handleScriptLogLineFeedChange\" />\n                    <span style=\"padding-left: 7px; font-size: 12px; color: #979ba5;\">{{ '自动换行' }}</span>\n                </div>\n            </div>\n        </div>\n        <div class=\"tab-content-wraper\" :style=\"contentStyles\">\n            <component\n                ref=\"view\"\n                :key=\"activePanel\"\n                :is=\"renderCom\"\n                :name=\"`${stepInstanceId}_${host.ip}_${retryCount}`\"\n                :step-instance-id=\"stepInstanceId\"\n                :ip=\"host.ip\"\n                :retry-count=\"retryCount\"\n                :font-size=\"fontSize\"\n                :mode=\"activePanel\"\n                :line-feed=\"isScriptLogLineFeed\"\n                v-bind=\"$attrs\"\n                v-on=\"$listeners\" />\n        </div>\n        <div\n            class=\"font-setting\"\n            :class=\"{ active: isFontSet }\"\n            @mouseenter=\"handleShowSetFont\"\n            @mouseleave=\"handleHideSetFont\">\n            <div class=\"font-setting-wraper\">\n                <div\n                    class=\"font-item\"\n                    :class=\"{ active: fontSize === 12 }\"\n                    style=\"font-size: 12px;\"\n                    @click=\"handleFontChange(12)\">Aa</div>\n                <div class=\"line\" />\n                <div\n                    class=\"font-item\"\n                    :class=\"{ active: fontSize === 13 }\"\n                    style=\"font-size: 13px;\"\n                    @click=\"handleFontChange(13)\">Aa</div>\n                <div class=\"line\" />\n                <div\n                    class=\"font-item\"\n                    :class=\"{ active: fontSize === 14 }\"\n                    style=\"font-size: 14px;\"\n                    @click=\"handleFontChange(14)\">Aa</div>\n            </div>\n        </div>\n    </div>\n</template>\n<script>\n       import TaskExecuteService from '@service/task-execute';\n    import ScriptLog from './script-log';\n    import FileLog from './file-log';\n    import VariableView from './variable-view';\n\n    const STEP_FONT_SIZE_KEY = 'step_execution_font_size';\n    const SCRIPT_LOG_AUTO_LINE_FEED = 'script_log_line_feed';\n\n    export default {\n        name: '',\n        inheritAttrs: false,\n        props: {\n            name: String,\n            host: {\n                type: Object,\n                required: true,\n            },\n            stepInstanceId: {\n                type: Number,\n            },\n            retryCount: {\n                type: Number,\n                required: true,\n            },\n            isTask: {\n                type: Boolean,\n                default: false,\n            },\n            isFile: {\n                type: Boolean,\n                default: false, // 展示文件日志\n            },\n        },\n        data () {\n            let fontSize = parseInt(localStorage.getItem(STEP_FONT_SIZE_KEY), 10);\n            if (!fontSize || fontSize < 12) {\n                fontSize = 12;\n            } else if (fontSize > 14) {\n                fontSize = 14;\n            }\n\n            return {\n                activePanel: '',\n                isFullscreen: false,\n                isFontSet: false,\n                fontSize,\n                isScriptLogLineFeed: Boolean(localStorage.getItem(SCRIPT_LOG_AUTO_LINE_FEED)),\n            };\n        },\n        computed: {\n            renderCom () {\n                const comMap = {\n                    scriptLog: ScriptLog,\n                    download: FileLog,\n                    upload: FileLog,\n                    variable: VariableView,\n                };\n                return comMap[this.activePanel];\n            },\n            boxStyles () {\n                if (this.isFullscreen) {\n                    return {\n                        position: 'fixed',\n                        top: 0,\n                        right: 0,\n                        bottom: 0,\n                        left: 0,\n                        zIndex: window.__bk_zIndex_manager.nextZIndex(), // eslint-disable-line no-underscore-dangle\n                    };\n                }\n                return {};\n            },\n            contentStyles () {\n                const lineHeightMap = {\n                    12: 20,\n                    13: 21,\n                    14: 22,\n                };\n                return {\n                    fontSize: `${this.fontSize}px`,\n                    lineHeight: `${lineHeightMap[this.fontSize]}px`,\n                };\n            },\n        },\n        watch: {\n            isFile: {\n                handler (isFile) {\n                    this.activePanel = isFile ? 'download' : 'scriptLog';\n                },\n                immediate: true,\n            },\n        },\n        beforeDestroy () {\n            this.handleExitFullscreen();\n        },\n        mounted () {\n            window.addEventListener('keyup', this.handleExitByESC);\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('keyup', this.handleExitByESC);\n            });\n        },\n        methods: {\n            /**\n             * @desc 切换面板\n             * @param {String} panel 选中的面板\n             */\n            handleTogglePanel (panel) {\n                this.activePanel = panel;\n            },\n            /**\n             * @desc 下载主机日志\n             */\n            handleDownload () {\n                TaskExecuteService.fetchStepExecutionLogFile({\n                    id: this.stepInstanceId,\n                    ip: this.host.ip,\n                }).then(() => {\n                    this.$bkMessage({\n                        theme: 'success',\n                        message: '导出日志操作成功',\n                    });\n                });\n            },\n            /**\n             * @desc 显示字体大小设置面板\n             */\n            handleShowSetFont () {\n                this.isFontSet = true;\n            },\n            /**\n             * @desc 隐藏字体大小设置面板\n             */\n            handleHideSetFont () {\n                this.isFontSet = false;\n            },\n            /**\n             * @desc 更新日志字体大小\n             */\n            handleFontChange (fontSize) {\n                this.fontSize = fontSize;\n                localStorage.setItem(STEP_FONT_SIZE_KEY, fontSize);\n            },\n            /**\n             * @desc 日志全屏\n             */\n            handleFullscreen () {\n                this.isFullscreen = true;\n                this.messageInfo('按 Esc 即可退出全屏模式');\n                this.infoBoxParentNode = this.$refs.infoBox.parentNode;\n                document.body.appendChild(this.$refs.infoBox);\n                this.$refs.view && this.$refs.view.resize();\n            },\n            /**\n             * @desc 退出日志全屏\n             */\n            handleExitFullscreen (event) {\n                this.isFullscreen = false;\n                if (this.infoBoxParentNode) {\n                    this.infoBoxParentNode.appendChild(this.$refs.infoBox);\n                    this.infoBoxParentNode = null;\n                }\n                setTimeout(() => {\n                    this.$refs.view && this.$refs.view.resize();\n                });\n            },\n            /**\n             * @desc esc键退出日志全屏\n             */\n            handleExitByESC (event) {\n                if (event.keyCode === 27) {\n                    this.handleExitFullscreen();\n                }\n            },\n            /**\n             * @desc 脚本日志自动换行\n             * @param {Boolean} lineFeed\n             */\n            handleScriptLogLineFeedChange  (lineFeed) {\n                this.isScriptLogLineFeed = lineFeed;\n                if (lineFeed) {\n                    localStorage.setItem(SCRIPT_LOG_AUTO_LINE_FEED, true);\n                } else {\n                    localStorage.removeItem(SCRIPT_LOG_AUTO_LINE_FEED);\n                }\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .step-execution-info-box {\n        position: relative;\n        height: 100%;\n\n        .tab-container {\n            position: relative;\n            z-index: 1;\n            display: flex;\n            font-size: 13px;\n            line-height: 42px;\n            color: #c4c6cc;\n            background: #2f3033;\n            box-shadow: 0 2px 4px 0 #000;\n            align-items: center;\n\n            .tab-title {\n                width: 166px;\n                font-size: 14px;\n                color: #dcdee5;\n                cursor: default;\n\n                &.success,\n                &.fail,\n                &.running,\n                &.waiting {\n                    &::before {\n                        display: inline-block;\n                        width: 3px;\n                        height: 12px;\n                        background: #2dc89d;\n                        content: \"\";\n                    }\n                }\n\n                &.fail {\n                    &::before {\n                        background: #ea3636;\n                    }\n                }\n\n                &.running {\n                    &::before {\n                        background: #699df4;\n                    }\n                }\n\n                &.waiting {\n                    &::before {\n                        background: #dcdee5;\n                    }\n                }\n\n                .host-ip {\n                    margin-left: 13px;\n                }\n            }\n\n            .split-line {\n                width: 1px;\n                height: 20px;\n                margin-right: -1px;\n                background: #63656e;\n            }\n\n            .tab-item {\n                position: relative;\n                height: 42px;\n                padding: 0 20px;\n                cursor: pointer;\n                user-select: none;\n\n                &.active {\n                    z-index: 1;\n                    color: #fff;\n                    background: #212124;\n\n                    &::before {\n                        position: absolute;\n                        top: 0;\n                        left: 0;\n                        width: 100%;\n                        height: 2px;\n                        background: #3a84ff;\n                        content: \"\";\n                    }\n                }\n            }\n\n            .extend-box {\n                display: flex;\n                margin-left: auto;\n                font-size: 18px;\n\n                .extend-item {\n                    display: flex;\n                    height: 42px;\n                    padding: 0 10px;\n                    margin-left: 2px;\n                    cursor: pointer;\n                    align-items: center;\n                    justify-content: center;\n                }\n            }\n        }\n\n        .tab-content-wraper {\n            flex: 1;\n            height: calc(100% - 42px);\n            background: #1d1d1d;\n        }\n\n        .font-setting {\n            position: absolute;\n            top: 55px;\n            right: 94px;\n            z-index: 1;\n            width: 160px;\n            color: #979ba5;\n            background: #2f3033;\n            border: 1px solid;\n            border-radius: 2px;\n            opacity: 0%;\n            visibility: hidden;\n            transform: translateY(-15px);\n            box-shadow: 0 2px 4px 0 rgb(0 0 0 / 50%);\n            transition: all 0.15s;\n            border-image-source: linear-gradient(#3b3c42, #292a2e);\n            border-image-slice: 1;\n            border-image-width: 1px;\n\n            &.active {\n                opacity: 100%;\n                visibility: visible;\n                transform: translateY(0);\n            }\n\n            .font-setting-wraper {\n                position: relative;\n                z-index: 1;\n                display: flex;\n                background: inherit;\n                align-items: center;\n            }\n\n            &::before {\n                position: absolute;\n                top: -20px;\n                right: 38px;\n                width: 42px;\n                height: 25px;\n                cursor: pointer;\n                content: \"\";\n            }\n\n            &::after {\n                position: absolute;\n                top: -5px;\n                left: 50%;\n                width: 11px;\n                height: 11px;\n                background: inherit;\n                border: 1px solid #3b3c42;\n                border-bottom: none;\n                border-left: none;\n                content: \"\";\n                transform: translateX(-50%) rotateZ(-45deg);\n            }\n\n            .font-item {\n                display: flex;\n                height: 42px;\n                cursor: pointer;\n                transition: all 0.15s;\n                align-items: center;\n                flex: 1;\n                justify-content: center;\n\n                &:hover,\n                &.active {\n                    color: #fafbfd;\n                }\n            }\n\n            .line {\n                width: 1px;\n                height: 18px;\n                background: #63656e;\n            }\n        }\n    }\n</style>\n","<template>\n    <div\n        ref=\"download\"\n        class=\"step-execute-log-export\"\n        :tippy-tips=\"isFile ? '分发文件步骤不支持日志导出' : ''\"\n        @click=\"handleShow\">\n        <div>{{ '导出日志' }}</div>\n        <div v-if=\"isShowThumProcess\" class=\"thum-precess-bar\" :class=\"boxClass\">\n            <div class=\"thum-precess\" :style=\"{ width: `${process * 100}%` }\" />\n        </div>\n        <div style=\"display: none;\">\n            <div ref=\"progress\" class=\"step-execute-log-package\" :class=\"boxClass\">\n                <div class=\"package-baseinfo\">\n                    <div class=\"package-size\">{{ '文件大小' }}: {{ fileSize | formFileSize }}</div>\n                    <div class=\"package-result\">\n                        <span v-if=\"packageStatus === 1\">{{ '打包中' }}…</span>\n                        <span v-if=\"packageStatus === 2\">{{ '打包中' }}…</span>\n                        <span v-if=\"packageStatus === 3\">\n                            <span>{{ '打包失败，' }}</span>\n                            <a @click=\"handleGetLogFilePackageResult\">{{ '重试' }}</a>\n                        </span>\n                        <span v-if=\"packageStatus === 4\">{{ '准备就绪' }}</span>\n                    </div>\n                </div>\n                <bk-progress\n                    :key=\"resetKey\"\n                    class=\"package-process\"\n                    size=\"small\"\n                    theme=\"primary\"\n                    :percent=\"process\"\n                    :show-text=\"false\" />\n                <div v-if=\"packageStatus === 1\" class=\"package-result-tips\">\n                    {{ '温馨提示：打包耗时会受到总的日志内容大小影响，请耐心等待' }}\n                </div>\n                <div v-if=\"packageStatus === 2\" class=\"package-result-tips\">\n                    {{ '温馨提示：文件打包中请勿关闭浏览器，以免导致任务中断' }}\n                </div>\n                <div v-if=\"packageStatus === 3\" class=\"package-result-tips\">\n                    {{ '日志文件打包超时，可能因为日志量过大，请选择单台日志下载' }}\n                </div>\n                <div v-if=\"packageStatus === 4\" class=\"package-result-tips\">\n                    <!-- eslint-disable-next-line max-len -->\n                    <span>{{ '日志压缩包已准备就绪，' }}{{ '是否' }}<a @click=\"handleDownload\">{{ '直接下载' }}</a></span>\n                    <bk-button\n                        style=\"margin-top: -5px; margin-left: auto;\"\n                        @click=\"handleGetLogFilePackageResult\"\n                        theme=\"primary\">\n                        {{ '重新打包' }}\n                    </bk-button>\n                </div>\n            </div>\n        </div>\n    </div>\n</template>\n<script>\n    import TaskExecuteService from '@service/task-execute';\n    import {\n        bytePretty,\n    } from '@utils/assist';\n\n    export default {\n        name: '',\n        filters: {\n            /**\n             * @desc 格式化文件大小显示\n             */\n            formFileSize (value) {\n                if (Number(value) < 1) {\n                    return '--';\n                }\n                return bytePretty(value);\n            },\n        },\n        props: {\n            isFile: Boolean,\n            stepInstanceId: {\n                type: Number,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                // 弹层显示状态标记\n                isPopoverShowFlag: false,\n                // 是否已经下载日志\n                isLogDownloaded: false,\n                fileSize: 0,\n                // 日志打包状态\n                packageStatus: 1,\n                // 打包进度，本地模拟\n                process: 0,\n            };\n        },\n        computed: {\n            boxClass () {\n                const classMap = {\n                    1: 'normal',\n                    2: 'packageing',\n                    3: 'failed',\n                    4: 'success',\n                };\n                return classMap[this.packageStatus];\n            },\n            /**\n             * @desc 日志文件打包完成但没有下载，并且弹层是关闭状态显示进度条缩略图\n             */\n            isShowThumProcess () {\n                return !this.isPopoverShowFlag && !this.isLogDownloaded && this.isPackageing;\n            },\n        },\n        created () {\n            this.isPackageing = false;\n            // api 标记重新打包\n            this.repackage = false;\n            // 用于重置 bk-progress\n            this.resetKey = 1;\n        },\n        mounted () {\n            this.initPopover();\n            this.taskQueue = [];\n        },\n        beforeDestroy () {\n            this.stopQueueRun();\n        },\n        methods: {\n            /**\n             * @desc 获取日志打包结果\n             *\n             * 打包过程没结束一直轮询状态\n             */\n            fetchLogFilePackageResult () {\n                TaskExecuteService.fetchLogFilePackageResult({\n                    stepInstanceId: this.stepInstanceId,\n                    repackage: this.repackage,\n                }).then((data) => {\n                    this.fileSize = data.fileSize || 0;\n                    this.packageStatus = data.status;\n                    if (this.packageStatus === 1 || this.packageStatus === 2) {\n                        this.pushQueue(this.fetchLogFilePackageResult);\n                    } else {\n                        this.stopQueueRun();\n                        // 打包成功完成任务进度条\n                        // 自动下载日志\n                        if (this.packageStatus === 4) {\n                            this.endProgress();\n                            this.handleDownload();\n                        }\n                    }\n                })\n                    .catch(() => {\n                        // 接口报错终止任务轮询\n                        this.stopQueueRun();\n                    })\n                    .finally(() => {\n                        this.repackage = false;\n                    });\n            },\n            /**\n             * @desc 弹层初始化\n             */\n            initPopover () {\n                this.popperInstance = this.$bkPopover(this.$refs.download, {\n                    arrow: true,\n                    placement: 'bottom',\n                    interactive: true,\n                    trigger: 'click',\n                    theme: 'light',\n                    animation: 'slide-toggle',\n                    distance: 30,\n                    content: this.$refs.progress,\n                    zIndex: window.__bk_zIndex_manager.nextZIndex(), // eslint-disable-line no-underscore-dangle\n                    onShow: () => {\n                        this.isPopoverShowFlag = true;\n                    },\n                    onHidden: () => {\n                        this.isPopoverShowFlag = false;\n                    },\n                });\n            },\n            /**\n             * @desc 推入轮询任务队列\n             */\n            pushQueue (task) {\n                if (!this.taskQueue) {\n                    this.taskQueue = [];\n                }\n                this.taskQueue.push(task);\n            },\n            /**\n             * @desc 开始轮询\n             */\n            startQueueRun () {\n                const nextTask = this.taskQueue.shift();\n                if (nextTask) {\n                    nextTask();\n                }\n                this.timer = setTimeout(() => {\n                    this.startQueueRun();\n                }, 1000);\n            },\n            /**\n             * @desc 终止轮询\n             */\n            stopQueueRun () {\n                this.stopQueueRunning = true;\n                clearTimeout(this.timer);\n            },\n            /**\n             * @desc 开始模拟任务进度\n             */\n            startProgress () {\n                if (this.process > 0.85) {\n                    return;\n                }\n                this.process += 0.05;\n                setTimeout(() => {\n                    this.startProgress();\n                }, 30);\n            },\n            /**\n             * @desc 任务进度完成\n             */\n            endProgress () {\n                this.process = 1;\n            },\n            /**\n             * @desc 显示弹层\n             *\n             * 如果没有开始打包过程则开始日志文件的打包\n             */\n            handleShow () {\n                if (!this.isPackageing) {\n                    this.isPackageing = true;\n                    this.handleGetLogFilePackageResult();\n                }\n            },\n            /**\n             * @desc 重新打包日志文件\n             *\n             * 重置打包状态\n             */\n            handleGetLogFilePackageResult () {\n                this.fileSize = 0;\n                this.packageStatus = 1;\n                this.process = 0;\n                this.resetKey += 1;\n                this.isLogDownloaded = false;\n                this.startQueueRun();\n                this.startProgress();\n                setTimeout(() => {\n                    this.repackage = true;\n                    this.fetchLogFilePackageResult();\n                }, 300);\n            },\n            /**\n             * @desc 下载日志打包文件\n             */\n            handleDownload () {\n                this.isLogDownloaded = true;\n                TaskExecuteService.fetchStepExecutionLogFile({\n                    id: this.stepInstanceId,\n                });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .step-execute-log-export {\n        position: relative;\n        height: 32px;\n        padding: 0 15px;\n        margin-left: 10px;\n        font-size: 14px;\n        line-height: 32px;\n        color: #63656e;\n        cursor: pointer;\n        background: #fafbfd;\n        border: 1px solid #c4c6cc;\n        border-radius: 2px;\n        user-select: none;\n        flex: 0 0 auto;\n\n        .thum-precess-bar {\n            position: absolute;\n            right: 0;\n            bottom: -1px;\n            left: 0;\n            height: 2px;\n            background: #dcdee5;\n            border-radius: 1px;\n\n            &.normal,\n            &.packageing {\n                .thum-precess {\n                    background: #3a84ff;\n                }\n            }\n\n            &.failed {\n                .thum-precess {\n                    background: #ea3636;\n                }\n            }\n\n            &.success {\n                .thum-precess {\n                    background: #2dcb56;\n                }\n            }\n\n            .thum-precess {\n                width: 50%;\n                height: 100%;\n                background: #3a84ff;\n                border-radius: 1px;\n            }\n        }\n    }\n\n    .step-execute-log-package {\n        position: relative;\n        width: 390px;\n        padding: 14px 17px;\n        font-size: 12px;\n        line-height: 16px;\n\n        &.failed {\n            .package-result,\n            .package-result-tips {\n                color: #ea3636;\n            }\n\n            .bk-progress .progress-inner {\n                background: #ea3636;\n            }\n        }\n\n        &.success {\n            .package-result {\n                color: #63656e;\n            }\n\n            .bk-progress .progress-inner {\n                background: #2dcb56;\n            }\n        }\n\n        .package-baseinfo {\n            display: flex;\n\n            .package-size {\n                margin-right: auto;\n            }\n\n            .package-result {\n                color: #979ba5;\n            }\n        }\n\n        .package-process {\n            margin-top: 10px;\n        }\n\n        .package-result-tips {\n            display: flex;\n            align-items: center;\n            margin-top: 13px;\n        }\n    }\n</style>\n","\n<template>\n    <div class=\"executive-history-step\">\n        task-status\n        <task-status ref=\"taskStatus\" @on-init=\"handleTaskInit\">\n            <div class=\"step-info-header\">\n                <div class=\"step-info-wraper\">\n                    <div class=\"step-type-text\">{{ stepTypeText }}</div>\n                    <div class=\"step-name-box\">\n                        <div class=\"step-name-text\">{{ data.name }}</div>\n                        <execution-history-select\n                            ref=\"executionHistorySelect\"\n                            :step-instance-id=\"params.id\"\n                            :retry-count=\"params.retryCount\"\n                            @on-change=\"handleRetryCountChange\" />\n                    </div>\n                </div>\n                步骤执行操作\n                <div class=\"step-action-box\">\n                    <step-action\n                        v-for=\"action in data.actions\"\n                        :name=\"action\"\n                        :key=\"action\"\n                        display-style=\"step-detail\"\n                        :confirm-handler=\"operationCode => handleStatusUpdate(operationCode)\" />\n                </div>\n                <div class=\"log-search-box\">\n                    <compose-form-item>\n                        <bk-select v-model=\"searchModel\" :clearable=\"false\" style=\"width: 100px;\">\n                            <bk-option id=\"log\" :name=\"'搜索日志'\" />\n                            <bk-option id=\"ip\" :name=\"'搜索 IP'\" />\n                        </bk-select>\n                        <bk-input\n                            :value=\"params.keyword\"\n                            key=\"log\"\n                            \n                            :tippy-tips=\"isFile ? '分发文件步骤不支持日志搜索' : ''\"\n                            right-icon=\"bk-icon icon-search\"\n                            style=\"width: 292px;\"\n                            @keyup=\"handleLogSearch\" />\n                        <bk-input\n                            :value=\"params.searchIp\"\n                            key=\"ip\"\n                            right-icon=\"bk-icon icon-search\"\n                            style=\"width: 292px;\"\n                            @keyup=\"handleIPSearch\" />\n                    </compose-form-item>\n                    <div v-if=\"isLogSearching\" class=\"search-loading\">\n                        <Icon class=\"loading-flag\" type=\"loading\" />\n                    </div>\n                    <div v-if=\"isIPSearching\" class=\"search-loading\">\n                        <Icon class=\"loading-flag\" type=\"loading\" />\n                    </div>\n                </div>\n                <export-log :step-instance-id=\"params.id\" :is-file=\"isFile\" />\n                <div class=\"task-instance-action\">\n                    <view-global-variable :task-instance-id=\"taskInstanceId\" />\n                    <view-operation-record :task-instance-id=\"taskInstanceId\" />\n                    <view-step-info :task-instance-id=\"taskInstanceId\" :step-instance-id=\"params.id\" />\n                </div>\n            </div>\n            主机分组\n            <group-tab\n                :data=\"data.resultGroups\"\n                @on-change=\"handelGroupChange\" />\n            <div class=\"detail-container\">\n                <div class=\"container-left\" v-bkloading=\"{ isLoading: isHostLoading }\">\n                    <!-- 主机列表 -->\n                    <!-- eslint-disable max-len -->\n                    <ip-list\n                        :name=\"`${data.stepInstanceId}_${dispalyGroup.groupName}_${params.retryCount}_${params.keyword}_${params.searchIp}`\"\n                        :total=\"dispalyGroup.agentTaskSize\"\n                        :list-loading=\"isLoading\"\n                        :pagination-loading=\"paginationChangeLoading\"\n                        :data=\"dispalyGroup.agentTaskExecutionDetail\"\n                        :search-value=\"`${params.keyword}_${params.searchIp}`\"\n                        @on-pagination-change=\"handlePaginationChange\"\n                        @on-copy=\"handleCopyHost\"\n                        @on-sort=\"handleSort\"\n                        @on-clear-search=\"handleClearSearch\"\n                        @on-change=\"handleHostChange\" />\n                </div>\n                <div class=\"container-right\">\n                    <!-- 执行日志 -->\n                    <execution-info\n                        :name=\"`${params.id}_${params.retryCount}_${dispalyGroup.groupName}_${currentHost.ip}_${params.keyword}`\"\n                        :step-instance-id=\"data.stepInstanceId\"\n                        :retry-count=\"params.retryCount\"\n                        :host=\"currentHost\"\n                        :log-filter=\"params.keyword\"\n                        :is-file=\"isFile\"\n                        :is-task=\"isTask\"\n                        @on-search=\"handleLogSearch\" />\n                </div>\n            </div>\n        </task-status>\n        步骤执行操作——强制终止\n        <execution-status-bar type=\"step\" :data=\"data\">\n            step-action\n            <step-action\n                name=\"forced\"\n                display-style=\"step-detail\"\n                key=\"forced\"\n                :confirm-handler=\"handleForceTask\"\n                @on-cancel=\"handleCancelForceTask\"\n                @on-show=\"handleStartForceTask\" />\n        </execution-status-bar>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import TaskExecuteService from '@service/task-execute';\n    import {\n        execCopy,\n    } from '@utils/assist';\n    import ComposeFormItem from '@components/compose-form-item';\n    import ExecutionStatusBar from '../common/execution-status-bar';\n    import StepAction from '../common/step-action';\n    import TaskStatus from './components/task-status';\n    import ExecutionHistorySelect from './components/execution-history-select';\n    import GroupTab from './components/group-tab';\n    import IpList from './components/ip-list';\n    import ExecutionInfo from './components/execution-info';\n    import ExportLog from './components/export-log';\n    import ViewGlobalVariable from './components/view-global-variable';\n    import ViewOperationRecord from './components/view-operation-record';\n    import ViewStepInfo from './components/view-step-info';\n    import mixins from './components/mixins';\n\n    export default {\n        name: 'StepExecuteDetail',\n        components: {\n            ComposeFormItem,\n            ExecutionStatusBar,\n            StepAction,\n            TaskStatus,\n            ExecutionHistorySelect,\n            GroupTab,\n            IpList,\n            ExecutionInfo,\n            ExportLog,\n            ViewGlobalVariable,\n            ViewOperationRecord,\n            ViewStepInfo,\n            \n        },\n        mixins: [\n            mixins,\n        ],\n        data () {\n            return {\n                isLoading: !true,\n                isLogSearching: false,\n                isIPSearching: false,\n                // 搜索模式\n                searchModel: 'log',\n                // 步骤所属作业的所有步骤列表\n                taskStepList: [{}, {}],\n                // 任务信息\n                data: {\n                    finished: false,\n                    resultGroups: [{}, {}],\n                    actions: [{}, {}],\n                    isForcedEnable: false,\n                },\n                // 接口参数\n                params: {\n                    id: 0,\n                    retryCount: '',\n                    maxIpsPerResultGroup: 0,\n                    keyword: '', // 日志的筛选值\n                    searchIp: '', // ip的筛选值\n                    orderField: '', // 排序字段\n                    order: '', // 排序字段，当前支持totalTime|cloudAreaId|exitCode\n                },\n                // 选中的分组信息\n                currentGroup: {\n                    resultType: '',\n                    tag: '',\n                },\n                // 选中的主机信息\n                currentHost: {\n                    ip: '',\n                    retryCount: 0,\n                },\n                // 作业执行步骤\n                isTask: false,\n                // 分发文件类型的步骤\n                isFile: false,\n                // 主机分页加载\n                paginationChangeLoading: false,\n            };\n        },\n        computed: {\n            /**\n             * @desc 骨架屏loading\n             */\n            isSkeletonLoading () {\n                return this.isLoading;\n            },\n            /**\n             * @desc 步骤类型描述\n             *\n             * 对作业里面的步骤需要显示当前步骤在作业中的索引\n             */\n            stepTypeText () {\n                let text = '';\n                if (this.isTask) {\n                    const index = _.findIndex(this.taskStepList, _ => _.stepInstanceId === this.params.id);\n                    if (index > -1) {\n                        text += `Step ${index + 1}/${this.taskStepList.length}`;\n                    }\n                }\n                if (this.isFile) {\n                    text = `${text} ${'分发文件'}`;\n                } else {\n                    text = `${text} ${'脚本执行'}`;\n                }\n                \n                return text;\n            },\n            /**\n             * @desc 如果任务已经结束重新获取任务详情时加上主机loading效果\n             *\n             * 主要用于任务结束后切换分组的场景\n             */\n            isHostLoading () {\n                return this.data.finished ? this.isLoading : false;\n            },\n            /**\n             * @desc 展示被选中的分组信息\n             */\n            dispalyGroup () {\n                const targetGroup = _.find(this.data.resultGroups, _ => _.groupName === this.currentGroup.groupName);\n                if (targetGroup) {\n                    return targetGroup;\n                }\n                return {\n                    agentTaskExecutionDetail: [],\n                    groupName: '',\n                };\n            },\n        },\n        created () {\n            this.taskInstanceId = 0;\n            this.isForceing = false;\n            this.$Progress.start();\n        },\n        beforeDestroy () {\n            this.$Progress.finish();\n        },\n        methods: {\n            /**\n             * @desc 步骤执行详情\n             *\n             * 1，任务没结束一直轮询\n             * 2，分组信息在执行过程中会变，如果已选中的分组不存在了自动选中第一个分组\n             */\n            fetchStep: _.debounce(function () {\n                if (this.params.id < 1 || this.params.maxIpsPerResultGroup < 1) {\n                    return;\n                }\n                \n                this.isLoading = true;\n                TaskExecuteService.fetchStepExecutionResult({\n                    ...this.params,\n                    resultType: this.currentGroup.resultType,\n                    tag: this.currentGroup.tag,\n                }).then((data) => {\n                    if (this.isForceing) {\n                        return;\n                    }\n                    this.data = Object.freeze(data);\n\n                    this.isFile = data.isFile;\n                    //  已选中的分组不存在了——默认选中第一个分组\n                    const { resultGroups } = data;\n                    if (!_.find(resultGroups, group => group.resultType === this.currentGroup.resultType\n                        && group.tag === this.currentGroup.tag)) {\n                        /* eslint-disable prefer-destructuring */\n                        this.currentGroup = resultGroups[0];\n                    }\n                    if (data.finished) {\n                        this.$Progress.finish();\n                        return;\n                    }\n                    \n                    this.$pollingQueueRun(this.fetchStep);\n                })\n                    .catch((error) => {\n                        if ([\n                            400,\n                            1244007,\n                        ].includes(error.code)) {\n                            setTimeout(() => {\n                                this.$router.push({\n                                    name: 'historyList',\n                                });\n                            }, 3000);\n                        }\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                        this.isLogSearching = false;\n                        this.isIPSearching = false;\n                        this.paginationChangeLoading = false;\n                    });\n            }, 30),\n            \n            /**\n             * @desc 步骤所属作业初始化\n             * @param {Object} payload 步骤信息\n             *\n             * 前置获取步骤关联的作业执行详情\n             */\n            handleTaskInit (payload) {\n                this.params = {\n                    ...this.params,\n                    id: payload.stepInstanceId,\n                    retryCount: payload.retryCount,\n                };\n                this.taskInstanceId = payload.taskInstanceId;\n                this.isTask = payload.isTask;\n                this.taskStepList = Object.freeze(payload.taskStepList);\n                this.fetchStep();\n            },\n            /**\n             * @desc 执行历史\n             * @param {Number} retryCount 重试次数\n             *\n             * 刷新步骤执行详情\n             */\n            handleRetryCountChange (retryCount) {\n                this.params = {\n                    ...this.params,\n                    retryCount,\n                };\n                this.fetchStep();\n            },\n            /**\n             * @desc 分组切换\n             * @param group [Number] 选中的分组\n             *\n             * 刷新步骤执行详情\n             *\n             */\n            handelGroupChange (group) {\n                this.currentGroup = group;\n                this.fetchStep();\n            },\n            /**\n             * @desc 选中主机\n             * @param {Object} host 选中的主机\n             */\n            handleHostChange (host) {\n                this.currentHost = Object.freeze(host);\n            },\n            /**\n             * @desc 组件列表分页\n             * @param {Number} pageSize 每页条数\n             */\n            handlePaginationChange (pageSize) {\n                this.params.maxIpsPerResultGroup = pageSize;\n                this.paginationChangeLoading = true;\n                this.fetchStep();\n            },\n            /**\n             * @desc 主机排序\n             * @param {Object} payload 排序信息\n             */\n            handleSort (payload) {\n                this.params = Object.assign({}, this.params, payload);\n                this.fetchStep();\n            },\n            /**\n             * @desc 清空搜索条件\n             */\n            handleClearSearch () {\n                this.params.keyword = '';\n                this.params.searchIp = '';\n                this.isLogSearching = true;\n                this.fetchStep();\n            },\n            /**\n             * @desc 复制所有主机IP\n             *\n             * 主机列表是分页加载，复制全部主机时需要全量请求一次\n             */\n            handleCopyHost () {\n                TaskExecuteService.fetchStepGroupHost({\n                    ...this.params,\n                    resultType: this.currentGroup.resultType,\n                    tag: this.currentGroup.tag,\n                }).then((data) => {\n                    if (data.length < 1) {\n                        this.$bkMessage({\n                            theme: 'warning',\n                            message: '暂无可复制IP',\n                            limit: 1,\n                        });\n                        return;\n                    }\n                    const ipText = data.map(item => item.ip).join('\\n');\n                    const successMessage = `${'复制成功'}（${data.length} ${'个'}IP）`;\n                    execCopy(ipText, successMessage);\n                });\n            },\n            /**\n             * @desc 导出脚本执行日志\n             */\n            handleExportExecutionLog () {\n                TaskExecuteService.fetchStepExecutionLogFile({\n                    id: this.params.id,\n                }).then(() => {\n                    this.$bkMessage({\n                        theme: 'success',\n                        message: '导出日志操作成功',\n                    });\n                });\n            },\n            /**\n             * @desc 开始强制终止\n             */\n            handleStartForceTask () {\n                this.isForceing = true;\n                this.$Progress.start();\n            },\n            /**\n             * @desc 取消强制终止\n             */\n            handleCancelForceTask () {\n                this.isForceing = false;\n                this.$Progress.start();\n                this.fetchStep();\n            },\n            /**\n             * @desc 强制终止任务\n             *\n             * 强制终止成功需要刷新作业的状态和执行历史记录\n             */\n            handleForceTask () {\n                this.$Progress.start();\n                return TaskExecuteService.updateTaskExecutionStepOperateTerminate({\n                    taskInstanceId: this.taskInstanceId,\n                }).then(() => {\n                    this.messageSuccess('操作成功');\n                    this.$refs.taskStatus.reLoading();\n                    this.$refs.executionHistorySelect.reLoading();\n                    this.fetchStep();\n                    return true;\n                });\n            },\n            /**\n             * @desc 更新步骤执行状态\n             * @param {Number} operationCode 状态码\n             *\n             * 强制终止成功需要刷新作业的状态和执行历史记录\n             */\n            handleStatusUpdate (operationCode) {\n                this.$Progress.start();\n                return TaskExecuteService.updateTaskExecutionStepOperate({\n                    id: this.params.id,\n                    operationCode,\n                }).then((data) => {\n                    this.params.retryCount = data.retryCount;\n                    this.$refs.taskStatus.reLoading();\n                    this.$refs.executionHistorySelect.reLoading();\n                    this.$bkMessage({\n                        limit: 1,\n                        theme: 'success',\n                        message: '操作成功',\n                    });\n                    this.fetchStep();\n                    return true;\n                });\n            },\n            /**\n             * @desc ip搜索\n             * @param {String} value 搜索值，支持模糊搜索\n             * @param {Object} event input交互事件\n             *\n             * 1，与日志搜索互斥\n             * 2，enter建触发搜索\n             * 3，重置页码（ip-list组件处理）\n             */\n            handleIPSearch (value, event) {\n                if (event.isComposing) {\n                    // 跳过输入法复合事件\n                    return;\n                }\n\n                // 输入框的值被清空直接触发搜索\n                // enter键开始搜索\n                if ((value === '' && value !== this.params.searchIp)\n                    || event.keyCode === 13) {\n                    this.params.keyword = '';\n                    this.params.searchIp = value;\n                    this.isIPSearching = true;\n                    this.fetchStep();\n                }\n            },\n            /**\n             * @desc 日志搜索\n             * @param {String} value 搜索值，支持模糊搜索\n             * @param {Object} event input交互事件\n             *\n             * 1，与ip搜索互斥\n             * 2，enter建触发搜索\n             * 3，重置页码（ip-list组件处理）\n             */\n            handleLogSearch (value, event) {\n                if (event.isComposing) {\n                    // 跳过输入法复合事件\n                    return;\n                }\n\n                // 输入框的值被清空直接触发搜索\n                // enter键开始搜索\n                if ((value === '' && value !== this.params.keyword)\n                    || event.keyCode === 13\n                    || event.type === 'click') {\n                    this.params.keyword = value;\n                    this.params.searchIp = '';\n                    this.isLogSearching = true;\n                    this.searchModel = 'log';\n                    this.fetchStep();\n                }\n            },\n            /**\n             * @desc 路由回退\n             */\n            routerBack () {\n                const { from } = this.$route.query;\n                if (from === 'historyTask') {\n                    this.$router.push({\n                        name: 'historyTask',\n                        params: {\n                            id: this.taskInstanceId,\n                        },\n                    });\n                    return;\n                }\n                if (from === 'plan') {\n                    // 保留执行方案到步骤详情的操作路径\n                    this.$router.push({\n                        name: 'historyTask',\n                        params: {\n                            id: this.taskInstanceId,\n                        },\n                        query: {\n                            from: 'plan',\n                        },\n                    });\n                    return;\n                }\n                if (from === 'fastExecuteScript') {\n                    this.$router.push({\n                        name: 'fastExecuteScript',\n                        query: {\n                            from: 'historyStep',\n                        },\n                    });\n                    return;\n                }\n                if (from === 'fastPushFile') {\n                    this.$router.push({\n                        name: 'fastPushFile',\n                        query: {\n                            from: 'historyStep',\n                        },\n                    });\n                    return;\n                }\n                this.$router.push({\n                    name: 'historyList',\n                });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    @import \"@/css/mixins/media\";\n\n    @keyframes search-loading {\n        0% {\n            transform: rotateZ(0);\n        }\n\n        100% {\n            transform: rotateZ(360deg);\n        }\n    }\n\n    .executive-history-step {\n        .step-info-header {\n            display: flex;\n            padding: 45px 24px 12px;\n            background: #f5f6fa;\n\n            .step-info-wraper {\n                flex: 1;\n                margin-top: -25px;\n\n                .step-type-text {\n                    font-size: 12px;\n                    line-height: 16px;\n                    color: #979ba5;\n                }\n\n                .step-name-box {\n                    display: flex;\n                    align-items: center;\n                    margin-top: 10px;\n                }\n\n                .step-name-text {\n                    height: 24px;\n                    max-width: calc(100% - 65px);\n                    overflow: hidden;\n                    font-size: 18px;\n                    line-height: 24px;\n                    color: #313238;\n                    text-overflow: ellipsis;\n                    white-space: nowrap;\n                }\n            }\n\n            .step-action-box {\n                display: flex;\n                flex: 0 0 auto;\n                justify-content: flex-end;\n                max-width: 360px;\n\n                .step-instance-action {\n                    border-radius: 2px;\n\n                    i {\n                        display: none;\n                    }\n                }\n            }\n\n            .log-search-box {\n                position: relative;\n                display: flex;\n                flex: 0 0 391px;\n                background: #fff;\n\n                .search-loading {\n                    position: absolute;\n                    top: 1px;\n                    right: 13px;\n                    bottom: 1px;\n                    display: flex;\n                    align-items: center;\n                    color: #c4c6cc;\n                    background: #fff;\n\n                    .loading-flag {\n                        animation: list-loading-ani 1s linear infinite;\n                    }\n                }\n            }\n\n            .task-instance-action {\n                display: flex;\n\n                .action-btn {\n                    display: flex;\n                    width: 32px;\n                    height: 32px;\n                    margin-left: 8px;\n                    font-size: 16px;\n                    color: #979ba5;\n                    cursor: pointer;\n                    background: #fff;\n                    border: 1px solid #c4c6cc;\n                    border-radius: 2px;\n                    align-items: center;\n                    justify-content: center;\n                }\n            }\n        }\n\n        .detail-container {\n            display: flex;\n            height: calc(100vh - 234px);\n            padding: 20px 24px;\n\n            .container-left {\n                height: 100%;\n                overflow: hidden;\n                background: #fff;\n                border: 1px solid #dcdee5;\n                border-bottom-left-radius: 2px;\n                border-top-left-radius: 2px;\n            }\n\n            .container-right {\n                display: flex;\n                width: 0;\n                height: 100%;\n                overflow: hidden;\n                flex-direction: column;\n                flex: 1;\n            }\n        }\n\n        .step-action {\n            display: flex;\n            align-items: center;\n\n            .action-btn {\n                display: flex;\n                height: 32px;\n                padding: 0 7px;\n                margin-left: 10px;\n                font-size: 19px;\n                color: #979ba5;\n                cursor: pointer;\n                background: #fff;\n                border-radius: 16px;\n                align-items: center;\n                justify-content: center;\n\n                &:hover {\n                    color: #3a84ff;\n                }\n            }\n        }\n    }\n</style>\n"],"names":[],"sourceRoot":""}