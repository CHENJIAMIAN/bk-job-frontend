{"version":3,"file":"static/css/twice.44b02c54e329068e3d64.css","mappings":"AAEA,qBAEI,cAAe,CADf,WAoNJ,CAjNI,yCAMI,wBAAyB,CACzB,iBAAkB,CAClB,qBAAsB,CAHtB,aAAc,CAHd,WAAa,CACb,eAAgB,CAChB,eAAgB,CAHhB,iBAAkB,CAQlB,4BA8KJ,CA5KI,wDAII,kBAAmB,CAHnB,YAAa,CAEb,aAAc,CADd,WAGJ,CAEA,2DAII,WAAY,CACZ,aAAc,CAHd,eAAgB,CAChB,aAAc,CAFd,iBAAkB,CAKlB,kDACJ,CAEA,2DAUI,WAAY,CAFZ,aAAc,CANd,oBAAqB,CAIrB,cAAe,CACf,gBAAiB,CAFjB,cAAe,CADf,eAAgB,CADhB,cAAe,CAFf,iBAAkB,CAQlB,qBAoBJ,CAjBI,sEAUI,sBAAuB,CACvB,WAAY,CAFZ,aAAc,CAFd,iBAAkB,CAFlB,WAAY,CAFZ,MAAO,CAKP,mBAAoB,CAIpB,YAAa,CANb,SAAU,CALV,iBAAkB,CAYlB,WAAY,CAXZ,KAAM,CAEN,UAYJ,CAIA,qEACI,mBAAoB,CACpB,kBA6BJ,CA3BI,gFACI,mBACJ,CAEA,gFAEI,cAAe,CADf,oBAEJ,CAEA,qFASI,sBAAuB,CACvB,WAAY,CAFZ,aAAc,CAFd,iBAAkB,CAFlB,WAAY,CAGZ,mBAAoB,CAIpB,YAAa,CANb,SAAU,CAJV,iBAAkB,CAWlB,WAAW,CAVX,KAAM,CACN,UAcJ,CAHI,gGACI,kBACJ,CAIR,iEACI,4BAKJ,CAHI,6EACI,eACJ,CAGJ,oEAOI,aAAc,CAEd,cAAe,CALf,oBAAqB,CACrB,cAAe,CACf,kBAAmB,CALnB,iBAAkB,CAElB,SAAU,CAKV,iBAAkB,CANlB,OAQJ,CAGJ,+DACI,aACJ,CAEA,wHAUI,kBAAmB,CACnB,iBAAiB,CAHjB,aAAc,CALd,oBAAqB,CAGrB,cAAe,CACf,gBAAiB,CAFjB,kBAAmB,CADnB,gBAAiB,CAFjB,iBAAkB,CAOlB,qBAWJ,CAPI,oIACI,kBAKJ,CAHI,0JACI,aACJ,CAIR,yDAMI,aAAc,CAHd,iBAAkB,CAElB,OAAQ,CADR,OA4BJ,CAxBI,uEAKI,aAAa,CADb,cAAe,CAFf,WAAY,CACZ,gBAAiB,CAFjB,UAUJ,CAJI,6EACI,aAAc,CACd,cACJ,CAGJ,8EAEI,cAAe,CADf,gBAAiB,CAEjB,2BAOJ,CALI,uFAEI,yBAA2B,CAC3B,8BAAgC,CAFhC,aAGJ,CAIR,4DAEI,UAAW,CADX,SAEJ,CAEA,kEACI,kBAAmB,CACnB,kBAAmB,CACnB,0CACJ,CAIA,iDAGI,yBAA2B,CAC3B,8BAAgC,CAFhC,aAAc,CADd,eAIJ,CAGJ,qCAMI,kBAAmB,CADnB,aAAc,CAJd,YAAa,CAEb,cAAe,CACf,gBAAiB,CAFjB,cAYJ,CANI,kDAII,cAAe,CAFf,WAAY,CACZ,gBAAiB,CAFjB,UAIJ,CCnNR,mBASI,wBAAyB,CACzB,iBAAkB,CAHlB,aAAc,CAFd,cAAe,CACf,gBAAiB,CAFjB,oBAAuB,CAFvB,eAAgB,CAShB,YAAa,CARb,aAAc,CAKd,kBAAmB,CAPnB,iBAAkB,CAWlB,WAwMJ,CAtMI,qCAGI,+BAA+B,CAF/B,qBAAsB,CACtB,mBAQJ,CALI,2CAGI,qCAAwC,CAFxC,aAAc,CACd,cAEJ,CAGJ,gCAII,QAAS,CAHT,gBAAiB,CACjB,eAAgB,CAGhB,iBAAkB,CAClB,eAAgB,CAHhB,SAAU,CAIV,kBA2DJ,CAvDI,0CACI,+BACJ,CAEA,kDAQI,kBAAmB,CAPnB,YAAa,CAMb,aAAc,CAEd,0BAA0B,CAN1B,eAAgB,CADhB,qBAAsB,CAItB,mBAAoB,CAFpB,sBAAuB,CACvB,kBA6CJ,CAvCI,8DACI,aAAc,CACd,kBACJ,CAEA,6DACI,YAAa,CAEb,MAAM,CADN,gBAOJ,CAJI,oEAEI,aAAc,CADd,oBAEJ,CAGJ,oEAII,aAAc,CADd,cAAe,CADf,gBAAiB,CADjB,iBAIJ,CAEA,6DAGI,aAAc,CAFd,cAAe,CACf,eAEJ,CAEA,0EAGI,wBAAyB,CAFzB,aAAc,CACd,cAEJ,CAEA,yDAEI,kBAAmB,CADnB,aAEJ,CAIR,mCAEI,gBAAiB,CADjB,cAAe,CAEf,iBACJ,CAEA,kCAEI,eAAiB,CACjB,gBAAiB,CAFjB,qBAGJ,CAEA,uCAOI,kBAAmB,CANnB,YAAa,CAIb,kBAAmB,CACnB,4BAA6B,CAH7B,gBAAiB,CADjB,kBAAmB,CAEnB,mBA0BJ,CArBI,mDAGI,4BAA6B,CAC7B,MAAM,CAFN,mBAAoB,CADpB,iBAmBJ,CAdI,yDAGI,qCAAwC,CAFxC,aAAc,CACd,cAEJ,CAEA,+DACI,8BACJ,CAEA,4DACI,aAAc,CACd,kBACJ,CAIR,qCACI,aACJ,CAEA,+CAEI,gBAAiB,CADjB,eAAgB,CAEhB,eAAgB,CAChB,iBAAkB,CAClB,eAgEJ,CA5DI,yEAOI,wBAAyB,CACzB,gBAAiB,CAFjB,aAAc,CAHd,cAAe,CACf,gBAAiB,CACjB,gBAAiB,CAHjB,cAAe,CADf,UA0DJ,CAjDI,mGAII,cAAc,CAHd,WAAY,CACZ,eAAgB,CAChB,kBAQJ,CALI,mNAGI,kBAAmB,CADnB,aAEJ,CAGJ,wMAEI,eAAgB,CAChB,kBACJ,CAEA,oGAGI,eAAiB,CADjB,iBAAkB,CAElB,gBAAiB,CACjB,kBAAmB,CAJnB,UAKJ,CAEA,oGACI,YAAa,CACb,eAAgB,CAEhB,eAAgB,CADhB,kBAkBJ,CAfI,gHAII,MAAO,CAHP,eAAgB,CAChB,sBAAuB,CACvB,kBAEJ,CAEA,sHAII,aAAc,CAEd,aAAc,CAHd,cAAe,CADf,gBAAiB,CADjB,gBAAiB,CAIjB,gBAEJ,CAOZ,4CACI,iBAAkB,CAClB,qCACJ,CCwSJ,6CACA,eACA,CAIA,oEACA,YACA,CAIA,6BAGA,mBADA,aADA,iBAiCA,CA7BA,6CAOA,sBACA,yBACA,kBAHA,eAJA,qBAEA,YAHA,kBAIA,sBAFA,UAoBA,CAZA,mDAMA,yBAEA,cADA,aAEA,WAJA,WAFA,SAFA,kBACA,QAQA,wBANA,SAOA,CAGA,+CAEA,eADA,eAEA,CAGA,sCAEA,mBAGA,mBAJA,aAGA,YADA,sBAYA,CARA,8CACA,aACA,CAEA,oDACA,cACA,cACA,CAGA,sCAEA,gBADA,WAEA,CAIA,0CACA,SAsBA,CApBA,gEACA,aAkBA,CAhBA,sEAIA,eAFA,eACA,iBAFA,cAcA,CATA,4EAEA,yBADA,aAEA,CAEA,kFAEA,yBADA,aAEA,CCzVA,kBAEA,gBADA,WAQA,CAJA,sDACA,aACA,CAFA,iDACA,aACA,CAFA,kDACA,aACA,CAFA,wCACA,aACA,CCnIA,oCACA,SACA,CAGA,oCACA,eACA,CCuFA,uBAKA,yBAHA,iBADA,kCAEA,mBACA,oBAMA,CAHA,oCACA,gBACA,CAKA,4BACA,GACA,uBACA,CACA,CAEA,aAIA,kBADA,eADA,YADA,iBA2FA,CAtFA,6BACA,kBAKA,CAHA,mDACA,YACA,CAIA,yEAEA,aACA,UACA,kBACA,CAGA,+BAKA,mBAJA,aACA,YAEA,iBADA,gBAGA,CAEA,yBACA,gBACA,uBACA,kBACA,CAEA,6DAOA,mBAFA,cAHA,aACA,YACA,eAEA,SAEA,CAEA,gCAIA,cADA,eADA,iBADA,iBAgBA,CAXA,2CACA,eACA,CAEA,sDACA,kBAKA,CAHA,8DACA,aACA,CAIA,6BACA,eACA,mBAEA,6BADA,eAWA,CARA,0CAEA,eADA,wBAMA,CAHA,gDACA,aACA,CAIA,+BAIA,gDAHA,kBAEA,WADA,OAGA,CAEA,6BACA,UACA,CCrRA,kKAEA,UACA,uBACA,CAKA,uEACA,UACA,2BACA,CAGA,gBASA,mBALA,SAGA,aAGA,uBALA,OAGA,gBAPA,eAEA,QADA,MAIA,YA2EA,CArEA,2BAMA,gBAHA,aAIA,sBAFA,aAJA,kBAGA,aAFA,SAMA,CAEA,4BAMA,mBADA,gCAHA,aACA,YACA,mBAHA,iBAsBA,CAfA,wCAOA,mBADA,mBAFA,WACA,eAJA,aAEA,YAKA,uBANA,UAOA,CAEA,sCACA,eACA,wBACA,CAGA,2BAIA,cAHA,aAIA,OAFA,eADA,iBAQA,CAHA,iCACA,gBACA,CAGA,6BACA,yBACA,CAEA,4BAKA,mBADA,mBAHA,aACA,YAIA,yBAHA,kBAIA,CAEA,0BAOA,0BAHA,SAEA,eADA,OAJA,kBAEA,QADA,KAMA,CAIA,kCAMA,aACA,yBAHA,OAIA,gBAPA,kBAEA,QADA,MAGA,SAsBA,CAjBA,uCACA,QACA,CAEA,6CACA,WACA,CAEA,0HAEA,uBACA,CAUA,0NACA,0BACA,CChEA,+CACA,WACA,CAGA,4BAeA,mBAHA,kBAFA,cACA,eANA,aAGA,eACA,gBAFA,YASA,uBAfA,kBAEA,WADA,QAWA,2BACA,+DARA,WAFA,SAoBA,CANA,2EAIA,mBADA,cADA,UAGA,CAGA,0CACA,mBAyBA,CAvBA,uDACA,YACA,CAEA,wEAKA,gBACA,yBACA,4CAHA,cAFA,eACA,iBAFA,UAiBA,CATA,qFAEA,eADA,iBAOA,CAJA,2FAEA,mBADA,aAEA,CC4DA,qBAGA,eADA,kBADA,iBAkBA,CAdA,uCACA,iBAKA,CAHA,6CACA,kBACA,CAGA,sCACA,kBAEA,WADA,MAEA,UACA,CAGA,iCAEA,aACA,YAEA,gBADA,eAHA,iBAYA,CALA,oDACA,UACA,kBACA,CAIA,2BAEA,iBADA,gBAEA,uBACA,kBACA,CAEA,gCAEA,mBAIA,cALA,aAIA,eADA,kBADA,cAwBA,CAnBA,6CAEA,eACA,UAFA,sBAGA,mBAEA,6BADA,eAMA,CAHA,mDACA,aACA,CAGA,8CAIA,4CADA,gBAFA,kBACA,OAGA,CAGA,+BAGA,YAFA,kBACA,UAyBA,CArBA,yDACA,8BACA,CAGA,gDAOA,mBAHA,SAMA,cAJA,aAGA,eADA,eAPA,kBAEA,QADA,MAGA,SAMA,CAEA,8CACA,WACA,CChSA,wBACA,aACA,qBAWA,CARA,2DACA,qBACA,CAEA,gDACA,eACA,CCqBA,YAQA,gBADA,eAHA,eAFA,YAGA,gBAFA,eAFA,kBAKA,oBA+BA,CA3BA,6BAWA,mBACA,yBACA,kBAHA,cADA,eALA,OACA,iBACA,gBAQA,aANA,kBADA,iBANA,kBAEA,QADA,KAaA,CAEA,oCAQA,mBAJA,WAGA,cAFA,SACA,iBALA,kBAEA,UADA,OAOA,CCgBA,4BAEA,mBADA,aAEA,sBACA,gBAKA,CAHA,uCACA,eACA,CAGA,4BAEA,cACA,mBAFA,UA2EA,CArEA,yDACA,WACA,CAIA,8DAQA,gCAJA,eACA,gBAHA,YAIA,iBAHA,eAIA,eAMA,CAHA,sFACA,iBACA,CAGA,+BAGA,mBAFA,cACA,kBAEA,CAEA,+BACA,oBACA,CAEA,wCACA,iBAyBA,CAvBA,iGAUA,kBAHA,eAHA,YAIA,iBAFA,iBADA,cAHA,kBAOA,kBANA,SAQA,2BACA,CAEA,gDAEA,mBADA,UAEA,CAEA,iDAEA,mBADA,aAEA,CAGA,uCAOA,4BACA,qBANA,oBACA,gBACA,uBAEA,mBADA,oBAIA,CAGA,sCACA,cACA,CAEA,qCAEA,mBACA,iBAFA,UAGA,CAEA,sCAIA,4CAFA,cADA,eAEA,qBAEA,CAEA,iCAOA,6BAHA,cAEA,eAJA,eADA,YAEA,iBAEA,iBAGA,CCzMA,4BAEA,mBAEA,eAHA,oBAEA,cAEA,CAEA,0CACA,mBA2BA,CAzBA,uDACA,YACA,CAEA,wEAOA,gBACA,yBACA,4CAJA,cAFA,eACA,iBAFA,eAIA,kBALA,UAmBA,CATA,4FACA,cAOA,CALA,qMAGA,mBADA,aAEA,CCkbA,6BACA,aACA,YACA,gBAuFA,CArFA,4CAIA,+BACA,aAHA,YACA,gBAFA,iBA2CA,CArCA,kEAGA,oBAFA,kBACA,SAEA,CAEA,gEACA,wBAqBA,CAnBA,wEAEA,iBADA,kBAEA,CAKA,0LACA,iCACA,CAEA,wFAIA,cAHA,gBACA,uBACA,kBAEA,CAIA,4DAIA,SACA,OAJA,kBAEA,QADA,KAIA,CAGA,wCACA,OACA,cAoCA,CA/BA,0HACA,iBACA,CAMA,2EACA,aACA,CAIA,qDACA,kBACA,CAEA,oDAEA,cADA,cAEA,CAEA,oDAEA,cADA,cAEA,CAEA,kDACA,cACA,CChVA,qCAEA,YACA,eAFA,iBA4BA,CAxBA,kDAGA,iBAFA,kBACA,SAEA,CAEA,yDACA,yBACA,eACA,CAGA,2DACA,yBACA,CAGA,qDAGA,OAEA,gBAJA,kBACA,QAEA,UAEA,CC5CA,yBACA,gBACA,iBA4BA,CA1BA,sCACA,iBACA,iBACA,CAEA,qCACA,gBAUA,CALA,oHACA,iBACA,CAKA,qCAEA,cADA,cAEA,CAEA,oCACA,cACA,CChBA,2BACA,iBA2CA,CAvCA,4DAEA,gBADA,aAEA,CAIA,yCAEA,mBADA,aAEA,eACA,CAEA,wCAGA,cAFA,aACA,iBAYA,CATA,sDAEA,cACA,eAFA,cAOA,CAHA,4DACA,aACA,CAIA,uCACA,gBAQA,CALA,wEAEA,gBADA,aAEA,CAKA,gDAEA,wBACA,CAEA,qBAGA,qBACA,YAHA,kBAIA,yDAHA,cAIA,CAEA,2BASA,mBACA,kBAHA,WANA,qBAIA,eAHA,YAIA,iBAHA,eACA,cAIA,kBAGA,0DACA,CChUA,iBAIA,cAHA,aACA,eACA,eAmBA,CAhBA,yBACA,aACA,CAEA,wBACA,aACA,CAEA,0BACA,aACA,CAEA,yBAEA,gBADA,aAEA,CCwCA,uDACA,yCACA,CClDA,aACA,+BACA,CAIA,oEACA,2BACA,CAGA,2CAKA,mBAEA,yDAJA,eACA,gBAFA,kCADA,iBAOA,CAEA,8DAGA,8BADA,+BADA,SAGA,CCiSA,mCAMA,+BADA,cAJA,wBACA,YACA,gBACA,4BAGA,CC5QA,mDACA,yCACA,CCiDA,qBAEA,yBADA,aAsBA,CAnBA,oCAQA,mBACA,gCAFA,cAHA,eACA,gBAHA,YAIA,iBAHA,kBAFA,iBASA,CAEA,gCACA,4BACA,CAEA,mCACA,YACA,CC8JA,cAIA,gBAHA,kBAEA,WADA,SA6EA,CAxEA,gDACA,YACA,CAGA,uCAEA,mBADA,aAEA,iBAKA,CAHA,oDACA,iBACA,CAGA,oCACA,WACA,CAIA,6CACA,eACA,CAIA,qDACA,aACA,CAKA,sEACA,kBACA,CAQA,gDACA,wBACA,4BACA,CAIA,0DACA,iBAiBA,CAfA,iEAUA,mBACA,kBAHA,WAIA,cANA,eAFA,YAGA,iBAFA,kBAJA,kBAQA,kBAPA,QAWA,2BAVA,UAWA,CC7QA,gBASA,gBALA,SAGA,aACA,sBAHA,OAJA,kBAEA,QADA,MAIA,SAiCA,CA5BA,gCAEA,mBAOA,gCADA,WAPA,aAEA,cAIA,eAHA,YAEA,mBADA,iBAaA,CAPA,oDAKA,cAFA,eACA,gBAFA,iBADA,eAKA,CAGA,gCAEA,mBAIA,mBALA,aAGA,YADA,yBAEA,kBAEA,CCgTA,mBACA,GACA,UACA,CAEA,GACA,SACA,CACA,CAEA,6BACA,GACA,oBACA,CAEA,IACA,oBACA,CAEA,IACA,oBACA,CAEA,IACA,oBACA,CAEA,GACA,kBACA,CACA,CAGA,qCAGA,kBADA,oBADA,iBAGA,iBAaA,CAXA,wDACA,OACA,CAEA,2CAKA,WAJA,qBAEA,YACA,sBAFA,OAIA,CAGA,6BACA,qBACA,YACA,gBACA,qBAkBA,CAhBA,6CACA,YACA,CAEA,gDACA,yBACA,CAEA,6CACA,SACA,CAEA,+CACA,aACA,wBACA,CAIA,mDAGA,aACA,sBAHA,kBACA,SAwBA,CApBA,kEAEA,mBADA,YAEA,CAEA,6DAOA,mBAFA,gCADA,+BADA,eAFA,aAKA,OAJA,YAMA,sBAMA,CAJA,oEACA,gBACA,+BACA,CAOA,sEAEA,mBADA,UAEA,CAIA,4BAEA,mBADA,YA0BA,CAvBA,yCAQA,8BADA,cAFA,eAJA,WAKA,gBAFA,iBADA,kBADA,iBAOA,8DACA,CAEA,wCASA,mBAFA,mBACA,kBAFA,cALA,aAIA,eAHA,YAEA,iBADA,aAOA,CAGA,iCAUA,yBACA,kBAFA,eAPA,qBAIA,YAFA,YAGA,iBAFA,gBAJA,kBAOA,sBALA,UAuBA,CAbA,uCAMA,yBAEA,cADA,aAEA,WAJA,WAFA,SAFA,kBACA,QAQA,kCACA,wBAPA,SAQA,CAGA,mCAEA,yBADA,sBAEA,2BAUA,CARA,2CACA,aACA,CAEA,+CACA,cACA,cACA,CAGA,iCASA,kBAFA,cACA,eAPA,aAIA,eAHA,YAIA,iBAFA,kBADA,aA6BA,CArBA,uCACA,kBACA,CAeA,2JACA,gCACA,CAIA,4BAGA,cADA,eADA,iBAGA,CAEA,2BACA,4BACA,CC1hBA,uDACA,eACA,CClDA,0BACA,aACA,OACA,kBAmDA,CAhDA,2DACA,kBAYA,CAVA,sEACA,kBAQA,CANA,4EAGA,cACA,YAFA,iBADA,UAIA,CAKA,yCAMA,uBAFA,WAFA,eACA,iBAFA,mBAIA,gBAMA,CAHA,oDACA,kBACA,CAGA,0CACA,OACA,eACA,CAGA,+DAEA,qBADA,aAEA,CAGA,0CAKA,cAFA,eACA,cAFA,mBADA,cAKA,CAIA,oCACA,gBACA,kBACA,CC7HA,yCAEA,mBAKA,kBAFA,cACA,eALA,aAGA,eADA,YAKA,8DAMA,CAJA,8CAEA,mBADA,gBAEA,CAGA,+CAEA,eADA,gBAEA,CCtDA,2BAIA,gBACA,yBAJA,sBAKA,CAEA,6BAKA,cAHA,eACA,gBACA,cAHA,kBAKA,CCmBA,qBAEA,mBADA,aAEA,WAKA,CAHA,uCACA,gCACA,CCeA,6CACA,WACA,CAGA,2BAeA,mBAHA,kBAFA,cACA,eANA,aAGA,eACA,gBAFA,YASA,uBAfA,kBAEA,WADA,QAWA,2BACA,+DARA,WAFA,SAoBA,CANA,yEAIA,mBADA,cADA,UAGA,CAGA,yCACA,mBAyBA,CAvBA,sDACA,YACA,CAEA,qEAKA,gBACA,yBACA,4CAHA,cAFA,eACA,iBAFA,UAiBA,CATA,kFAEA,eADA,iBAOA,CAJA,wFAEA,mBADA,aAEA,CC1GA,oBAEA,mBADA,aAEA,kBAkBA,CAhBA,+BACA,YAKA,CAHA,iCACA,gBACA,CAGA,8BACA,aACA,gBAKA,CAHA,gCACA,eACA,CC8CA,oDAIA,mBACA,gCAJA,aAEA,wBADA,mBA0DA,CArDA,8DAgBA,mBANA,mBAEA,4CAEA,2BADA,4BALA,cACA,eARA,aAKA,eAJA,YAKA,iBAFA,mBADA,kBADA,eAYA,mBAiBA,CAdA,qEAEA,gBACA,qBAFA,cAYA,CARA,+EAEA,mBADA,aAEA,CAEA,mFACA,UACA,CAIA,8DACA,gBACA,CAEA,8DAMA,mBACA,kBAFA,cAFA,eAFA,YAGA,iBAFA,cAMA,mBACA,CAEA,kEAEA,gDADA,aAEA,CCvFA,uBASA,uBACA,kBAJA,cAEA,eAPA,qBAEA,YAEA,iBADA,kBAGA,kBALA,UAqBA,CAXA,6BACA,cACA,CAEA,6BACA,kBAKA,CAHA,mCACA,aACA,CAIA,+BACA,aACA,qBAkBA,CAhBA,4CAGA,cAEA,eAJA,eACA,iBAEA,iBAWA,CARA,kDACA,aACA,CAEA,qDACA,cACA,kBACA,CC/BA,wCAEA,mBADA,aAEA,YACA,gBAeA,CAbA,mDAIA,sBACA,kBACA,uCAHA,iBADA,aADA,WAMA,CAEA,gDACA,qBACA,iBACA,CCPA,8DACA,WACA,CAKA,oBAIA,gBACA,8BAFA,YAFA,kBACA,WAuIA,CAlIA,4BAKA,mBACA,gCAFA,cADA,eADA,kBADA,gBAkCA,CA3BA,2CACA,aACA,eAwBA,CAtBA,qDAUA,mBAEA,4CAEA,2BADA,4BANA,cAEA,eAJA,eAHA,YAIA,iBAFA,mBADA,iBAKA,kBAOA,mBAdA,UAoBA,CAJA,4DAEA,gBADA,aAEA,CAKA,6BAIA,cADA,iBADA,gBADA,iBAyEA,CApEA,gCAEA,eACA,gBAFA,eAGA,CAEA,+BACA,cACA,CAEA,kCAKA,gBACA,yBACA,kBAJA,cADA,eADA,cAGA,kBAIA,CAGA,sCAUA,mBACA,YAJA,cANA,cAKA,iBAFA,gBACA,gBAFA,iBAKA,gBACA,gBAPA,UAUA,CAIA,mCAGA,cADA,kBADA,iBAoBA,CAhBA,0CAQA,mBACA,kBACA,WALA,WAFA,OAGA,iBALA,kBACA,QAKA,sBAHA,SAOA,CAEA,kDACA,eACA,CAIA,gCACA,aACA,CAEA,gCACA,cACA,CAGA,+BAWA,kBAHA,cAEA,eAJA,eADA,YAEA,iBANA,kBAEA,WAMA,kBAPA,SAEA,UAYA,CAHA,qCACA,wBACA,CC3GA,oDAEA,iCADA,kBAEA,CCuCA,oCACA,eACA,CCJA,0DAEA,iCADA,kBAEA,CC3FA,oCACA,aACA,CAIA,yCACA,0BACA,CAEA,wCAEA,oBADA,qBAEA,CC/CA,8BAKA,uBADA,cAHA,aACA,eAIA,yBAHA,gBAgBA,CAXA,uDACA,4BACA,CAEA,qDACA,+BAKA,CAHA,qEACA,UACA,CAIA,+BAOA,mBAJA,cAFA,aAQA,cADA,yBANA,kBAEA,iBAEA,gBADA,mBAKA,CAEA,iCAEA,cADA,OAEA,oBACA,CC+OA,mCACA,iBA0FA,CAxFA,yCAEA,eADA,iBAsBA,CAnBA,oHAEA,iBACA,CAEA,2DACA,iBAKA,CAHA,iEACA,kBACA,CAGA,0DACA,kBAEA,WADA,MAEA,UACA,CAGA,qDAGA,mBADA,aAGA,gBADA,eAEA,cALA,iBAoBA,CAZA,wEACA,UACA,kBACA,CAGA,iEACA,cAEA,eACA,+DAFA,kBAGA,CAGA,oDAGA,iBADA,gBADA,kBAGA,oBACA,CAEA,oDAEA,mBACA,sBAFA,aAKA,eAFA,YACA,iBAuBA,CApBA,iEAEA,cACA,eACA,UAHA,yBAIA,mBAEA,6BADA,eAMA,CAHA,uEACA,aACA,CAGA,kEAIA,4CADA,gBAFA,kBACA,OAGA,CAGA,mDACA,UACA,CC7KA,oBAEA,eADA,iBAmBA,CAhBA,sCAGA,kBADA,kBADA,eAOA,CAHA,4CACA,kBACA,CAGA,qCACA,kBAEA,WADA,MAEA,UACA,CAGA,gCAEA,aAEA,gBADA,eAFA,iBAWA,CALA,mDACA,UACA,kBACA,CAIA,0BACA,iBACA,eACA,CAEA,+BAEA,mBAIA,cALA,aAIA,eADA,kBADA,cAwBA,CAnBA,4CAEA,eACA,UAFA,sBAGA,mBAEA,6BADA,eAMA,CAHA,kDACA,aACA,CAGA,6CAIA,4CADA,gBAFA,kBACA,OAGA,CAGA,oCAGA,YAFA,kBACA,UAqBA,CAjBA,8DACA,8BACA,CAGA,qDAOA,mBAHA,SAMA,cAJA,aAGA,eADA,eAPA,kBAEA,QADA,MAGA,SAMA,CC5DA,yCACA,iBACA,CAEA,uCAGA,mBACA,6BAHA,YACA,gBAcA,CAVA,6CACA,kBACA,CAEA,uDACA,YAGA,iBADA,kBADA,kBAGA,CAIA,0DAGA,mBACA,6BAHA,YACA,gBAOA,CAHA,gEACA,kBACA,CAKA,6DACA,mBACA,4BAKA,CAHA,mEACA,kBACA,CAIA,0CAQA,mBAFA,mBACA,kBAFA,eAJA,aAGA,eAFA,YAOA,uBANA,cAWA,CAHA,gDACA,kBACA,CAKA,sEACA,oBACA,CAIA,+CACA,iBAeA,CAbA,4DAOA,mBAHA,SAMA,cACA,eALA,aAGA,eADA,eAPA,kBAEA,QADA,MAGA,SAOA,CAGA,6CACA,cACA,UACA,CCnLA,uCAKA,yBACA,kBAFA,cAFA,eACA,iBAIA,mBANA,UAyDA,CAjDA,6CACA,kBACA,CAEA,oFAEA,YAEA,kBADA,kBAEA,eACA,CAEA,0CAEA,cADA,eAEA,CAEA,0CAGA,6BADA,mBADA,eAGA,CAEA,mDAEA,iCADA,kBAEA,CAGA,2DAKA,cAEA,YANA,qBAEA,eADA,WAEA,cAEA,qBAEA,CAGA,mDACA,8DAOA,CALA,+DAEA,cACA,eAFA,cAGA,CAIA,4CAUA,mBAHA,mBACA,0BACA,kBAJA,cACA,eALA,aAGA,eAFA,YASA,uBARA,cAwBA,CAdA,8CAGA,cADA,eADA,gBAGA,CAEA,kDAEA,qBADA,aAMA,CAHA,oDACA,aACA,CCpLA,sCAGA,cADA,eADA,mBA0BA,CAtBA,kDAEA,iBADA,UAQA,CALA,qDAGA,yBADA,mBADA,eAGA,CAGA,kDAGA,cADA,mBAEA,iBAHA,WAIA,CAEA,kDACA,kBACA,oBACA,CCmBA,oCACA,eACA,CCEA,kBACA,kBACA,SAOA,CCQA,gGACA,WACA,CCtBA,gCACA,yBACA,kBACA,oCAoEA,CAjEA,4DAEA,UADA,WAEA,CAGA,uCAMA,gBACA,yBAGA,qCAFA,WAHA,YAFA,UAFA,kBACA,SAOA,wBALA,UAOA,CAEA,wCAGA,gBACA,kBAFA,kBADA,iBA4CA,CAvCA,gDAKA,gCADA,cADA,eADA,kBADA,kBAgBA,CAVA,qDAOA,yBACA,kBAFA,cALA,qBAGA,eAFA,YAGA,iBAFA,aAMA,CAGA,qDAEA,eACA,iBAFA,eAGA,CAEA,sDACA,aACA,CAEA,wDAOA,4BACA,qBANA,oBACA,gBACA,gBACA,uBACA,oBAGA,CCwQA,2CAGA,mBAFA,aACA,eAEA,gBAiPA,CA/OA,mEAIA,qBADA,eADA,kBADA,eAgBA,CAVA,qGACA,oBACA,CAIA,+FACA,kBACA,CAIA,oEAWA,mBALA,gBACA,yBACA,kBACA,sBAPA,aAEA,YACA,eAJA,kBASA,oBAPA,WAoBA,CAVA,0EACA,mBACA,oBAOA,CALA,+FACA,UAEA,mBADA,kBAEA,CAIA,0DAQA,mBAFA,mBACA,kBAFA,WAJA,aASA,cANA,eADA,YAMA,uBAEA,oBATA,UAUA,CAEA,gEAUA,mBACA,kBAHA,WACA,eAHA,eADA,YAEA,iBAKA,UAXA,kBAEA,WADA,SAYA,oBACA,oBAFA,kBATA,UAYA,CAEA,0DAKA,cAJA,aAKA,sBAHA,eACA,cAFA,iBAwBA,CAlBA,yEAMA,cADA,eAJA,YAEA,kBADA,gBAEA,gBAGA,uBACA,kBACA,CAEA,gFACA,YACA,gBACA,gBACA,uBACA,kBACA,CAGA,gEAGA,gBAFA,kBACA,WAgDA,CA7CA,oJAEA,cAWA,CATA,kUAGA,qBADA,aAMA,CAHA,0UACA,aACA,CAIA,yEASA,mBAHA,0BACA,kBACA,sBAHA,cAJA,aAGA,eADA,YAOA,uBARA,UAcA,CAJA,sFAEA,cADA,gBAEA,CAGA,2EASA,mBAFA,cAHA,aAEA,eAEA,uBAPA,kBAEA,YADA,QAQA,2BALA,UAMA,CAKA,0BAFA,oIAGA,WAcA,CAbA,CAEA,0BANA,oIAOA,WAUA,CATA,CAEA,0BAVA,oIAWA,WAMA,CALA,CAEA,0BAdA,oIAeA,WAEA,CADA,CAGA,2DACA,cA8DA,CA5DA,iEAMA,WADA,YAFA,OAFA,kBACA,MAEA,UAGA,CAGA,yFACA,oBAKA,CAHA,wGACA,kBACA,CAIA,8FAUA,mBAFA,WAGA,cALA,eADA,YAEA,iBANA,kBAEA,WAMA,kBAPA,SAEA,UAQA,CAGA,sLAGA,qBADA,iBAMA,CAHA,oNACA,kBACA,CAGA,2FACA,oBAaA,CAXA,0GACA,kBACA,CAGA,yPAEA,cACA,4BACA,CCpjBA,iCAGA,mBACA,eAHA,aACA,cAwBA,CApBA,yCACA,aACA,CAEA,wCACA,aACA,CAEA,0CACA,aACA,CAEA,yCAEA,gBADA,aAEA,CAEA,yCACA,iBACA,CAKA,6CACA,YACA,CAEA,8FAIA,gBAFA,kBACA,aAEA,CAEA,+CACA,SACA,CAEA,0FAEA,WADA,eAEA,eACA,CAEA,gEACA,SAaA,CAXA,8EACA,WASA,CAPA,0FACA,eACA,CAEA,gGACA,gBACA,CAIA,6CACA,aAGA,gBAFA,iBACA,gBAEA,CAEA,iDACA,YACA,CAEA,6CAUA,gCAFA,WAFA,eAJA,YAKA,iBAHA,iBACA,kBAFA,cAFA,kBAQA,eAEA,CAEA,2DAKA,cACA,eAFA,eAHA,kBAEA,QADA,MAKA,mBAKA,CAHA,iEACA,uBACA,CCrHA,iBAQA,gBADA,eAHA,eAFA,YAGA,iBAFA,eAFA,kBAKA,oBA0CA,CAtCA,uCAaA,mBACA,yBACA,kBAHA,cADA,eALA,OACA,iBACA,gBAQA,aANA,kBADA,iBANA,kBAEA,QADA,KAkBA,CAJA,6CACA,0BACA,kCACA,CAGA,8CAYA,uBARA,WAKA,cAHA,YADA,SAGA,gBADA,iBANA,kBAEA,UAOA,uBARA,QASA,kBAEA,CCgBA,kBAMA,kBAJA,aAGA,eADA,kBAHA,kBAEA,UAgFA,CAxEA,wIACA,oBACA,CAIA,6BAIA,uCACA,kBAFA,eADA,iBADA,UA0BA,CApBA,mCACA,kBACA,CAEA,sFAEA,aACA,qBACA,CAEA,4CAEA,YAGA,iBAFA,eACA,gBAEA,uBAEA,mBAPA,WAMA,mBAEA,CAGA,sEAEA,UAMA,CAJA,kHAEA,yBADA,eAEA,CAGA,kCAGA,OAFA,kBACA,KAEA,CAEA,oCACA,kBAKA,CAHA,0CACA,kBACA,CAGA,8BAMA,mBAIA,cACA,eANA,aAIA,eAFA,YACA,cAPA,kBAEA,QADA,MAEA,YAQA,CC+CA,kDAEA,6BACA,kBAFA,iBAqBA,CAjBA,8DACA,oBACA,CAEA,8DAWA,mBAFA,cACA,eALA,aAGA,eAFA,YACA,cANA,kBAEA,QADA,MAEA,YAQA,CAOA,wQACA,aACA,CAGA,qHACA,aACA,cACA,CAGA,8HAGA,iBACA,CAEA,oHAIA,kBADA,cAMA,CAHA,sIACA,kBACA,CAGA,6EAEA,YACA,gBACA,CAEA,uCAGA,iBAFA,gBACA,gBAEA,CAEA,sCAQA,mBAFA,mBACA,kBAFA,eAJA,aAGA,eAFA,YACA,iBA8BA,CAvBA,0DACA,aACA,CAEA,4CAEA,mBACA,aAFA,WAGA,CAEA,2DACA,MACA,CAEA,uDAMA,mBAFA,kBAHA,aAIA,OAFA,eADA,YAKA,sBACA,CAGA,gDAQA,mBAFA,mBACA,kBAFA,eAJA,aAGA,eAFA,YAOA,uBANA,cAiBA,CATA,sDAEA,mBADA,aAEA,CAEA,0DAEA,kBADA,gBAEA,CAKA,gDACA,4BACA,CAIA,iCAGA,YAFA,YACA,gBAaA,CAVA,uCACA,kBACA,CAEA,iDACA,YAGA,iBADA,kBADA,kBAGA,CCxTA,oBACA,gBAKA,CAHA,wCACA,kBACA,CCmMA,eACA,gBAKA,CAHA,mCACA,kBACA,CCpLA,iCASA,sBACA,mBAHA,cANA,qBAIA,eACA,iBAHA,gBADA,eAEA,cAIA,iBAGA,CAEA,oCACA,YACA,CCzHA,yBACA,cAaA,CAXA,oCACA,SACA,CAEA,+BACA,uBAKA,CAHA,0CACA,SACA,CCtBA,yBAEA,kBADA,gBAMA,CAHA,+BACA,kBACA,CCwLA,2BACA,MA6GA,CA3GA,iCAEA,gBACA,mBAFA,UAoDA,CA/CA,sDACA,4BACA,CAGA,wEAMA,sBAFA,eAFA,YACA,iBAEA,eAwBA,CArBA,gGAEA,kBADA,SAEA,CAEA,kGACA,SACA,CAEA,kGACA,SACA,CAEA,8FAEA,gBADA,qBAMA,CAHA,8JACA,gBACA,CAIA,oCAGA,gCADA,cADA,eAGA,CAEA,oCAEA,cADA,iBAEA,oBACA,CAKA,mEAEA,uBADA,qBAEA,CAEA,+DACA,YACA,CAGA,mDACA,kBACA,WACA,CAEA,4JAGA,eACA,CAMA,wGACA,SACA,CAGA,qDACA,kBACA,WACA,CAGA,yDACA,WACA,CAIA,iDACA,YACA,CAEA,iFAEA,cACA,CCnEA,mCACA,eACA,CAEA,mCAGA,cAFA,eACA,gBAkBA,CAfA,wCAEA,kBADA,iBAaA,CAVA,+CAMA,wBACA,kBACA,WAHA,WAFA,OAFA,kBACA,QAEA,SAKA,CAIA,mCAEA,cADA,cASA,CANA,8CAGA,cACA,eAFA,eADA,eAIA,CCrGA,mCAGA,cAFA,eACA,gBAmEA,CAhEA,wCAGA,kBADA,kBADA,iBAcA,CAVA,+CAMA,wBACA,kBACA,WAHA,WAFA,OAFA,kBACA,QAEA,SAKA,CAGA,qDAEA,eADA,UA6CA,CA1CA,gHAIA,gCAFA,YACA,cAEA,CAEA,wDACA,wBACA,CAEA,+DASA,kBADA,eAPA,aAEA,YAIA,iBAFA,eACA,gBAFA,eAFA,WA4BA,CAnBA,qEACA,kBAKA,CAHA,gFACA,aACA,CAGA,2EACA,gBACA,uBACA,kBACA,CAEA,0EACA,aAEA,cADA,gBAEA,CClMA,gCAEA,mBADA,aAEA,WAsBA,CApBA,6CACA,cACA,UAWA,CARA,2EACA,gBACA,CAGA,4DACA,gCACA,CAGA,8CACA,OAEA,iBADA,eAEA,CC1GA,mBACI,oBA4EJ,CA1EI,kTASI,UAAW,CAEX,gBAAiB,CADjB,UAEJ,CAEA,2WAUI,eACJ,CAEA,waAUI,SAAa,CADb,SAEJ,CAGI,0pBAYI,6BAA8B,CAC9B,0BAA2B,CAF3B,aAGJ,CAIA,+oBAYI,8BAA+B,CAD/B,2BAEJ,CCmQR,sEAEA,kBADA,WAEA,CAGA,8CAEA,aADA,iBAoCA,CAjCA,mEAMA,mBAFA,SAMA,cACA,eANA,aAIA,eAFA,uBANA,kBAEA,YADA,MAMA,UAIA,CAEA,iEACA,WAiBA,CAfA,0BAHA,iEAIA,WAcA,CAbA,CAEA,0BAPA,iEAQA,WAUA,CATA,CAEA,0BAXA,iEAYA,WAMA,CALA,CAEA,0BAfA,iEAgBA,WAEA,CADA,CCxBA,mEACA,WACA,CAGA,4BACA,WACA,CAGA,uCACA,WACA,CAMA,+CACA,WACA,CAGA,qCACA,wBACA,CAEA,uCACA,cACA,CAEA,6CACA,eACA,CAEA,qCACA,cAEA,iBADA,WAEA,CAGA,4EACA,WACA,CAIA,2BACA,8DASA,CANA,uCAGA,mCAFA,wBACA,kBAEA,CCvUA,4BACA,kBACA,CAEA,sCAEA,mBADA,aAEA,0BACA,CAEA,uCAEA,mBADA,aAEA,WACA,CAEA,qCAEA,iBADA,wBAEA,CAEA,6BAIA,cACA,eAHA,eACA,iBAFA,eAKA,CAGA,kBAGA,cAFA,eACA,gBAkBA,CAfA,uBAEA,kBADA,iBAaA,CAVA,8BAMA,wBACA,kBACA,WAHA,WAFA,OAFA,kBACA,QAEA,SAKA,CCqOA,4BAEA,kBADA,cAMA,CAHA,wCACA,iBACA,CC2EA,qEAEA,kBADA,WAEA,CAGA,wCAEA,cADA,eAEA,CAEA,8CAGA,mBADA,aADA,iBAaA,CATA,mEAEA,mBAIA,cACA,eANA,aAIA,eAFA,uBACA,eAIA,CChJA,kBACA,UASA,CAPA,2BACA,WACA,CAEA,iCACA,UACA,CAGA,4BACA,iBAgBA,CAdA,sCAEA,cADA,cAEA,CAEA,kCACA,qBAEA,gBADA,gBAEA,gBACA,uBAEA,mBADA,kBAEA,CAGA,8BAIA,mBAFA,aACA,kBAFA,iBA0CA,CArCA,0CACA,mBACA,8DAMA,CAJA,qGAEA,aACA,CAGA,mCAEA,kBADA,UAEA,CAEA,yCAEA,cADA,cAEA,CAEA,oCAKA,cAJA,qBAEA,gBADA,gBAEA,gBAEA,uBAEA,mBADA,kBAEA,CAEA,2CAIA,eADA,gBAFA,kBACA,OAGA,CCnTA,wBACA,aACA,OACA,eACA,gBAkBA,CAhBA,iCACA,qBACA,CAEA,uCAKA,uBAHA,cADA,kBAEA,iBACA,kBAEA,CAEA,wCAEA,cADA,QAEA,CC3EA,gDACA,wBAKA,CAHA,sDACA,oBACA,CCqCA,qBAGA,cAFA,OACA,eAEA,kBAgFA,CA5EA,wFACA,aACA,CAIA,0CACA,aACA,CAIA,yCACA,aACA,CAKA,mFACA,aACA,CAIA,0CACA,aACA,CAIA,0CACA,aACA,CAGA,4BAEA,mBADA,aAGA,eADA,iBAMA,CAHA,wCACA,WACA,CAGA,iCAMA,mBAHA,SAEA,aAEA,uBAHA,SAHA,kBACA,MAOA,2BADA,WAEA,CAEA,6BACA,iBACA,CAEA,2BACA,gBACA,kBAMA,CAJA,kCAEA,cADA,oBAEA,CAGA,2CACA,cACA,CClBA,qBACA,mBACA,CAEA,sBAUA,mBAFA,gBACA,mBAHA,cACA,eANA,aAIA,eAHA,YASA,uBAPA,kBADA,oBA+CA,CApCA,8BACA,kBACA,CAGA,kCACA,yBACA,CAEA,kCACA,wBACA,CAIA,4EAEA,qBADA,aAEA,CAOA,wIAEA,qBADA,aAEA,CAGA,wBAGA,cADA,eADA,gBAGA,CC7GA,0CACA,8BACA,CAEA,wBACA,gBACA,CCQA,oBACA,8BAKA,CAHA,2BACA,gBACA,CCzDA,sBAEA,kBADA,gBAMA,CAHA,4BACA,kBACA,CAGA,sBAEA,iBADA,gBAEA,eACA,eAeA,CAXA,2BACA,oBACA,CAEA,2BAIA,wBACA,kBAJA,qBAEA,WADA,SAIA,CCoBA,oDACA,YACA,CAEA,4GAIA,gBAFA,kBACA,aAEA,CAEA,sDACA,SACA,CAEA,iGAEA,WADA,eAEA,eACA,CAEA,uEACA,SAaA,CAXA,qFACA,WASA,CAPA,iGACA,eACA,CAEA,uGACA,gBACA,CAIA,oDACA,aAGA,gBAFA,iBACA,gBAEA,CAEA,wDACA,YACA,CAEA,oDAUA,gCAFA,WAFA,eAJA,YAKA,iBAHA,iBACA,kBAFA,cAFA,kBAQA,eAEA,CAEA,kEAKA,cACA,eAFA,eAHA,kBAEA,QADA,MAKA,mBAKA,CAHA,wEACA,uBACA,CC6iBA,eAEA,aACA,sBAFA,kBAGA,UA4DA,CA1DA,2BAGA,oDADA,kCADA,kBAgDA,CA1CA,0IACA,yBACA,wBACA,CAEA,4IACA,4BACA,CAIA,+DACA,UACA,CAIA,+DACA,WACA,CAIA,mKAIA,0BADA,oBAEA,CAEA,qDACA,g6BACA,CAEA,wDACA,gqBACA,CAEA,sDACA,w4BACA,CAIA,yBACA,8DAKA,CAHA,2CACA,cACA,CAIA,cAIA,mBACA,4CAFA,WAFA,aACA,cAoBA,CAfA,gCAOA,mBAFA,iCAFA,cACA,eAHA,aACA,eAIA,8DAQA,CALA,uCAEA,mBACA,6BAFA,UAGA,CAIA,aAEA,mBADA,YAWA,CARA,+BACA,OACA,eACA,CAEA,yBACA,yCACA,CAGA,eAMA,mBAIA,cALA,aAGA,eACA,cAFA,kBANA,kBAEA,QADA,MAEA,SAYA,CAJA,yBAEA,eADA,gBAEA,CAGA,sBAKA,gBACA,kBALA,kBAEA,WADA,SAKA,+DAHA,WAuEA,CAlEA,6BAMA,mBACA,WAFA,YAJA,kBAEA,WADA,SAMA,yBAJA,UAKA,CAEA,oCAEA,mBAKA,gCADA,cALA,aAIA,eAFA,YACA,cAkBA,CAbA,8CAUA,mBAHA,gBACA,yBACA,kBAJA,cACA,eALA,aAEA,YAQA,uBAPA,iBAFA,UAUA,CAGA,kCAKA,mBADA,cAFA,2BACA,eAFA,iBAwBA,CAlBA,wCAGA,mBAFA,aACA,WAEA,CAEA,gDAEA,gBACA,uBACA,mBAHA,WAIA,CAEA,kDAEA,cACA,eAFA,gBAGA,CAGA,qCAEA,oBADA,gBAEA,CCz1BA,8BAIA,mBAFA,aACA,gBAFA,iBAmJA,CA9IA,6CAEA,mBAKA,gBACA,uCAFA,cALA,aAIA,eAFA,YACA,iBAmBA,CAbA,yDAMA,mBALA,aAIA,eAHA,YAEA,iBADA,kBASA,CAJA,2DAEA,eADA,gBAEA,CAIA,gDAGA,aAFA,kBACA,SAoBA,CAjBA,sDAIA,mBADA,kBAFA,kBACA,WAUA,CANA,4DAIA,SAHA,kBAEA,QADA,KAGA,CAGA,uDACA,MACA,CAGA,6CAOA,mBADA,mBAEA,6BACA,wCANA,aACA,YACA,eAJA,kBACA,SAQA,CAEA,wCAMA,cAFA,eAHA,YAIA,iBAFA,kBADA,eASA,CAHA,uDACA,gBACA,CAGA,6FAIA,6BACA,+BAFA,wBADA,cAaA,CARA,iHACA,0BACA,8BACA,CAEA,mJACA,aACA,CAFA,yIACA,aACA,CAFA,2IACA,aACA,CAFA,uHACA,aACA,CAIA,oDAEA,uBACA,qBAFA,cAGA,mBAWA,CATA,0DAEA,qBADA,aAEA,CAEA,gEAEA,qBADA,aAEA,CAQA,8HACA,kBACA,CAGA,4DACA,YACA,CAEA,mEAEA,WADA,KAEA,CAGA,0CACA,mCACA,CAEA,uDAEA,6BADA,uBAEA,CAEA,2DAEA,6BADA,uBAEA,CCuLA,uCAQA,qBAJA,aAKA,uBAPA,SAIA,iBALA,kBAMA,2BAFA,YAFA,SAyBA,CAjBA,yDAOA,mBAvBA,cAoBA,eAxBA,aA0BA,eAvBA,eADA,YA0BA,uBALA,eAEA,mBAxBA,UAmCA,CANA,gEAEA,mBAEA,2BADA,4BAFA,aAIA,CAIA,2CACA,aAEA,OADA,qBAEA,CAEA,8CAMA,cAFA,eAHA,YAIA,iBAFA,gBADA,kBAKA,oBAGA,CCzXA,WACA,aACA,UAYA,CAVA,qBACA,MACA,CAEA,0BAEA,mBADA,aAEA,cACA,gBACA,CCuHA,wCAEA,mBADA,aAEA,YACA,kBAWA,CATA,0DACA,aACA,cACA,iBACA,CAEA,qDACA,YACA,CAGA,wBACA,WACA,CChCA,4BAEA,mBADA,8BA8BA,CA3BA,kCACA,kBACA,SAeA,CAbA,6CACA,kBACA,CAEA,qDACA,WACA,CAEA,sDACA,kBAEA,WADA,SAEA,CAGA,mCAMA,yBALA,kBAEA,QADA,MAGA,YADA,SAGA,CNvCA,4CAMA,gBADA,eAJA,oBACA,YAEA,cADA,kBA4BA,CAvBA,kDASA,mBAJA,mBACA,8BACA,2BAHA,WAHA,aAOA,cALA,eADA,YAQA,sBACA,CAEA,kDAQA,mBAHA,yBAEA,+BAFA,iBACA,4BALA,aACA,eACA,kBAMA,COxIA,oBAIA,eADA,kBAFA,gBACA,WAiBA,CAbA,0BACA,kBACA,CAEA,uCACA,eAOA,CAJA,4DACA,UACA,CAMA,gDACA,YACA,CAEA,oGAIA,gBAFA,kBACA,aAEA,CAEA,kDACA,SACA,CAEA,6FAEA,WADA,eAEA,eACA,CAEA,mEACA,SAaA,CAXA,iFACA,WASA,CAPA,6FACA,eACA,CAEA,mGACA,gBACA,CAIA,gDACA,aAGA,gBAFA,iBACA,gBAEA,CAEA,oDACA,YACA,CAEA,gDAUA,gCAFA,WAFA,eAJA,YAKA,iBAHA,iBACA,kBAFA,cAFA,kBAQA,eAEA,CAEA,qDAKA,cACA,eAFA,eAHA,kBAEA,QADA,MAKA,mBAKA,CAHA,2DACA,uBACA,CC0EA,oBACA,MAgGA,CA9FA,6CAEA,mBADA,aAEA,iBAKA,CAHA,6DACA,iBACA,CAGA,0BAGA,gBADA,iBADA,UAyCA,CApCA,+CACA,4BACA,CAGA,0DAMA,eAJA,YAEA,mBACA,kBAFA,gBAIA,eAKA,CAHA,kFACA,iBACA,CAGA,6BAGA,gCADA,cADA,eAGA,CAEA,6BACA,aASA,CAPA,wCACA,qBACA,eACA,gBACA,uBACA,kBACA,CAIA,uCACA,cASA,CAPA,6CACA,uBAKA,CAHA,+DACA,cACA,CAQA,gFACA,YACA,CAEA,0CAEA,iBADA,gBAEA,eACA,eAeA,CAXA,+CACA,oBACA,CAEA,+CAIA,wBACA,kBAJA,qBAEA,WADA,SAIA,CC5OA,2CACA,0BACA,CAEA,gDACA,eACA,CC4GA,0BACA,0BACA,CAEA,+BACA,eACA,CAEA,iCACA,cACA,cACA,CAEA,sCACA,oBAKA,CAHA,qDACA,aACA,CC1HA,+CACA,eACA,CAEA,mDAEA,mBADA,aAEA,eAEA,gBADA,eAmBA,CAhBA,yDAUA,mBAFA,mBACA,kBAFA,cANA,aAKA,eAJA,YAGA,kBADA,gBADA,aAQA,CAEA,kEACA,gBACA,CC9DA,qDACA,eACA,CCgCA,cAQA,mBAFA,2BACA,kBAHA,WACA,eAJA,aAEA,YAMA,uBAPA,UAwBA,CAfA,oBACA,yBACA,CAEA,2BAGA,eADA,YADA,UAGA,CAEA,0BAGA,eADA,YADA,UAGA,CC8YA,sCACA,aACA,sBACA,WA6CA,CA3CA,0BALA,sCAMA,WA0CA,CAzCA,CAEA,0BATA,sCAUA,WAsCA,CArCA,CAEA,0BAbA,sCAcA,WAkCA,CAjCA,CAEA,0BAjBA,sCAkBA,WA8BA,CA7BA,CApCA,yTAEA,mBACA,qBAFA,aAGA,CAEA,gTAEA,mBACA,mCAFA,aAGA,CAEA,+TACA,aACA,CAwCA,6JAIA,mBACA,kBACA,WALA,cACA,YACA,eAIA,CAMA,gCACA,iBAwBA,CAnBA,mIACA,mBACA,CAMA,kEAEA,mBACA,qBAFA,aAGA,CAIA,+CACA,eACA,CAGA,sCAEA,eADA,iBAiHA,CA9GA,6CAUA,mBACA,yBACA,kBAHA,cAHA,eACA,gBAHA,YADA,UAKA,iBAHA,cAJA,kBACA,MAWA,2BACA,CAEA,qDAEA,mBADA,WAUA,CAPA,4DACA,sBACA,CAEA,uEACA,YACA,CAIA,mHAEA,oBACA,CAEA,wDAEA,mBADA,aAEA,CAEA,0DAMA,mBAFA,SACA,aAGA,kBADA,mBANA,kBAEA,QADA,KAyCA,CAjCA,iEAKA,mBACA,WAHA,YACA,kBAHA,kBACA,SAKA,CAEA,0EAKA,mBACA,yBACA,kBALA,cAEA,YAHA,kBAEA,UAoBA,CAdA,gFAMA,sBAEA,cADA,aAEA,WAJA,WAFA,SAFA,kBACA,QAQA,iCAEA,wBADA,oBAPA,SASA,CAMA,4DAEA,mBACA,qBAFA,aAGA,CAEA,+DAEA,uBACA,qBAFA,aAGA,CAGA,8EACA,uBACA,oBAKA,CAHA,oFACA,kBACA,CAMA,mCACA,iBAiKA,CA9JA,yDACA,YACA,CAEA,6DACA,YACA,CA5NA,uDAEA,mBACA,qBAFA,aAGA,CAEA,oDAEA,mBACA,mCAFA,aAGA,CAEA,yDACA,aACA,CAmNA,iDAIA,gBACA,yBACA,kBACA,sBAJA,cAFA,aACA,WAgBA,CATA,wDACA,mBACA,oBAMA,CAJA,mEACA,mBACA,wBACA,CAIA,8CAMA,mBAFA,mBACA,+BAJA,aAOA,cALA,eADA,YAKA,sBAEA,CAEA,mDAMA,cAFA,aACA,eAJA,kBAEA,QADA,QAKA,0BACA,CAEA,8CAGA,mBADA,aAEA,iBAHA,iBAgBA,CAXA,8DAGA,eAFA,gBACA,gBAEA,uBACA,kBACA,CAEA,oDACA,aACA,CAGA,gDAKA,mBACA,kBAFA,WAHA,kBACA,YACA,SAIA,CAEA,mDAKA,mBAIA,cALA,aAIA,eAFA,YACA,kBANA,kBAEA,QADA,QAQA,2CAWA,CATA,8DAEA,eADA,uBAOA,CAJA,yIAEA,aACA,CAIA,gDACA,YACA,CAEA,kDAYA,mBAFA,mBACA,kBAHA,WAJA,aAGA,eADA,YAOA,uBAZA,kBAEA,WAMA,kBAPA,SAGA,UASA,CAEA,uDAUA,gBADA,cAFA,eAHA,YAIA,iBAFA,mBADA,cAJA,kBAEA,QADA,QASA,2CAuBA,CArBA,8DAMA,qDACA,WAJA,SACA,kBAHA,kBACA,OAMA,CAEA,6DAMA,gBACA,kBACA,WAHA,WAFA,UAFA,kBACA,QAOA,2BALA,SAMA,CAIA,kCASA,mBADA,0BAFA,cACA,eANA,aAIA,eAFA,YAOA,uBANA,gBAFA,UAuBA,CAbA,wCAEA,qBADA,aAMA,CAHA,qDACA,aACA,CAGA,+CAEA,cADA,gBAEA,CAIA,iCACA,cA+EA,CA7EA,uCAMA,WADA,YAFA,OAFA,kBACA,MAEA,UAGA,CAIA,6DAUA,mBAFA,WAGA,cALA,eADA,YAEA,iBANA,kBAEA,WAMA,kBAPA,SAEA,UAQA,CAGA,4KAGA,iBAWA,CATA,sNACA,oBACA,CAEA,6MAEA,mBACA,2BAFA,aAGA,CAIA,wEAEA,qBADA,aAEA,CAEA,qEAEA,mBACA,2BAFA,aAGA,CAEA,0EACA,4BACA,CAIA,6CAMA,eADA,kBAJA,kBAEA,QADA,QAKA,+BAHA,UAYA,CAPA,2DACA,aACA,CAEA,2DACA,aACA,CC9zBA,qCAKA,gBADA,gBADA,kBADA,mBADA,iBAkEA,CA5DA,qDASA,gBAHA,YAHA,OAOA,UAFA,kBADA,iBANA,kBACA,MASA,mBANA,WADA,WAkBA,CATA,oEACA,UAEA,oDADA,iBAEA,CAEA,sEACA,WACA,CAGA,mDAKA,gCADA,WAHA,aAEA,oBADA,gBAcA,CATA,+DAEA,eACA,cAFA,mBAGA,CAEA,8DACA,gBACA,CAGA,qDAGA,iBACA,gBAFA,mBADA,gBAMA,CAEA,oDAOA,mBADA,gBAJA,aACA,YAEA,kBADA,mBAHA,iBAOA,CClLA,yCAEA,mBAGA,cACA,eALA,aAEA,eACA,iBAGA,8DACA,CAEA,+CAEA,eADA,gBAEA,CCgIA,iBAEA,cAmCA,CAjCA,6CAHA,iBAuBA,CAjBA,2CACA,cACA,CAGA,+DACA,qCACA,CAGA,8CAKA,eAJA,kBAEA,UADA,QAEA,UAEA,CAGA,uBAGA,cAFA,eACA,gBAQA,CALA,iCAEA,cACA,eAFA,cAGA,CC6JA,iDAGA,mBADA,aADA,MAuBA,CAnBA,+DAaA,mBAJA,mBACA,kBAHA,WACA,eAPA,oBACA,aAIA,eAHA,YASA,uBAPA,iBADA,cAOA,8DAGA,CAEA,8DACA,YACA,CAGA,iDACA,aACA,WAiBA,CAfA,0BAJA,iDAKA,WAcA,CAbA,CAEA,0BARA,iDASA,WAUA,CATA,CAEA,0BAZA,iDAaA,WAMA,CALA,CAEA,0BAhBA,iDAiBA,WAEA,CADA,CAGA,oDACA,iBAYA,CAVA,iEAOA,gBACA,sBAFA,cAFA,eACA,cAJA,kBAEA,YADA,SAOA,CAGA,iDACA,gBACA,CAGA,uDAEA,mBACA,yBAFA,UAGA,CClGA,2CACA,YACA,CAEA,kCAEA,0CADA,0BAeA,CAXA,6DAEA,cADA,cAEA,CAEA,kEAEA,oBACA,eAFA,eAGA,CAIA,mCAGA,cAFA,eACA,gBAEA,CAEA,yCACA,aAEA,YACA,mBAFA,WAuBA,CAnBA,0BANA,yCAOA,WAkBA,CAjBA,CAEA,0BAVA,yCAWA,WAcA,CAbA,CAEA,0BAdA,yCAeA,WAUA,CATA,CAEA,0BAlBA,yCAmBA,WAMA,CALA,CAEA,qDACA,gBACA,CCpEA,6CACA,YACA,CAEA,oCAEA,0CADA,0BAeA,CAXA,+DAEA,cADA,cAEA,CAEA,oEAEA,oBACA,eAFA,eAGA,CAIA,qCAGA,cAFA,eACA,gBAEA,CAEA,2CAMA,cALA,aAGA,eACA,iBAFA,mBADA,WAyBA,CAnBA,0BARA,2CASA,WAkBA,CAjBA,CAEA,0BAZA,2CAaA,WAcA,CAbA,CAEA,0BAhBA,2CAiBA,WAUA,CATA,CAEA,0BApBA,2CAqBA,WAMA,CALA,CAEA,uDACA,gBACA,CCnSA,uBACA,YAqGA,CAnGA,+BACA,iBAeA,CAbA,4CACA,iBACA,CAGA,4DACA,wBACA,CAGA,6CACA,gBACA,CAGA,oCAGA,gBACA,yBAEA,cALA,kBAIA,oBAHA,SAuCA,CAjCA,iDACA,kBACA,CAEA,qDACA,cACA,CAEA,mDAcA,mBAJA,mBAEA,+BADA,4BAHA,WACA,eALA,aAGA,eADA,YASA,uBAdA,kBAEA,YADA,QAWA,2BARA,UAeA,CAHA,yDACA,kBACA,CAGA,kDACA,uBACA,CAGA,qCAIA,gBACA,yBACA,kBAEA,OALA,iBAFA,kBAMA,oBALA,SAmCA,CA3BA,mDACA,UACA,kBAKA,CAHA,0DACA,SACA,CAGA,gDAWA,mBADA,kBAFA,cACA,eALA,aAGA,eADA,YAMA,uBAXA,kBAEA,UADA,QAGA,UAYA,CAHA,sDACA,wBACA,CC9DA,0CACA,0BACA,CAEA,iDACA,yBACA,CCtDA,kCAYA,mBAJA,gBACA,yBACA,kBAJA,cACA,eANA,aAIA,eAFA,YACA,gBAOA,mBATA,WA4CA,CAhCA,6CASA,mBAFA,mBADA,WALA,aAIA,eAFA,YAOA,uBANA,kBAIA,mBANA,UASA,CAEA,6CAIA,cADA,eADA,iBADA,iBAIA,SACA,CAEA,wCACA,oBASA,CAPA,mDACA,kBACA,CAEA,mDACA,SACA,CCrFA,mCACA,kBA8BA,CA5BA,8CACA,eACA,CAEA,gDAIA,cACA,eAJA,aAEA,eADA,0BAQA,CAHA,sDACA,aACA,CAIA,sDACA,cACA,CAGA,yCAIA,cAFA,eACA,iBAFA,kBAIA,CC6IA,qDAKA,cAJA,aAEA,eACA,iBAFA,gBAaA,CARA,4DACA,aACA,CAEA,oEAEA,gBADA,UAEA,CAGA,uDACA,aACA,eAEA,cADA,eAmFA,CAhFA,sEAeA,mBAHA,yBACA,kBAHA,cACA,eATA,aAEA,YAIA,gBADA,iBADA,gBAGA,gBAJA,mBAJA,kBAaA,mBAXA,WAkEA,CApDA,qFAEA,mBAOA,mBADA,WAPA,aAGA,cAGA,eAFA,YAFA,uBAGA,iBAIA,kBACA,CAEA,sFAOA,gBACA,yBACA,kBALA,SAEA,YALA,kBAEA,UADA,QAGA,UAKA,CAEA,6EACA,oBAyBA,CAvBA,4FACA,kBACA,CAEA,6FACA,mBACA,oBAgBA,CAdA,mGAMA,sBAEA,cADA,aAEA,WAJA,WAFA,SAFA,kBACA,QAQA,iCAEA,wBADA,mBAPA,SASA,CAKA,sEAOA,mBADA,cAHA,eADA,gBADA,iBAGA,uBACA,kBAGA,CAGA,wDACA,eACA,CCnPA,yCAEA,kBADA,eAsEA,CAnEA,iDAOA,mBADA,mBAFA,cACA,eAJA,aACA,YACA,cAyBA,CAnBA,8DAKA,mBAJA,aAGA,eADA,YAGA,uBAJA,UAKA,CAEA,uDACA,cACA,CAEA,uDAIA,cAFA,eACA,gBAFA,gBAIA,CAGA,+CAGA,yBACA,kBAFA,cADA,UAmCA,CA9BA,qDACA,kBACA,CAEA,oGAEA,YACA,eACA,eACA,CAEA,kDAEA,cADA,eAEA,CAEA,kDACA,4BACA,CAEA,0DAOA,4BACA,qBANA,oBACA,gBACA,uBAEA,mBADA,oBAIA,CC7DA,oCACA,eACA,CCwLA,6CAEA,mBAIA,mBALA,aAGA,YADA,uBAEA,oBAEA,CCmsBA,8FACA,oBACA,CAMA,4CACA,kBACA,CAGA,gDAEA,mBAKA,gCADA,cALA,aAEA,YAEA,iBADA,iBAiBA,CAZA,uDACA,kBACA,CAEA,0DAIA,eAFA,iBADA,gBAEA,gBAEA,uBACA,kBACA,CAKA,gEACA,aACA,CAGA,+CACA,iCACA,CAEA,wDAIA,mBAEA,eAJA,aACA,OAEA,YAJA,iBAMA,CAEA,sDAEA,mBADA,aAIA,gBADA,kBADA,UAGA,CAEA,oDAOA,mBALA,cAGA,eACA,cALA,gBAEA,uBACA,kBAIA,CAEA,uDASA,mBADA,eAJA,aAUA,CAEA,6GAHA,mBAHA,kBAHA,WALA,oBADA,cAKA,eAHA,YASA,uBAPA,gBAMA,8DAkBA,CAbA,sDAQA,mBALA,UAUA,CAEA,0DAMA,cAHA,aAEA,eAHA,WAEA,aAHA,iBAWA,CAJA,kEAEA,cADA,oBAEA,CAGA,sDAEA,cADA,gBAEA","sources":["webpack://job/./src/components/jb-search-select/search-select/styles/search-select.css","webpack://job/./src/components/jb-search-select/search-select/styles/search-select-menu.css","webpack://job/./src/components/render-list/index.vue","webpack://job/./src/components/jb-search-select/index.vue","webpack://job/./src/components/jb-tag-select/index.vue","webpack://job/./src/components/jb-edit/tag.vue","webpack://job/./src/components/choose-ip/components/sideslider-box.vue","webpack://job/./src/components/choose-ip/components/action-extend.vue","webpack://job/./src/components/jb-edit/input.vue","webpack://job/./src/components/global-variable/layout.vue","webpack://job/./src/components/choose-ip/components/mult-input.vue","webpack://job/./src/components/choose-ip/components/host-table.vue","webpack://job/./src/components/choose-ip/components/dropdown-menu.vue","webpack://job/./src/components/choose-ip/components/render-business-topology.vue","webpack://job/./src/components/choose-ip/components/render-dynamic-business-topology.vue","webpack://job/./src/components/choose-ip/components/render-dynamic-group.vue","webpack://job/./src/components/choose-ip/components/render-ip-input.vue","webpack://job/./src/components/choose-ip/components/statistics-text.vue","webpack://job/./src/components/choose-ip/components/preview-group.vue","webpack://job/./src/components/jb-collapse-item/index.vue","webpack://job/./src/components/choose-ip/view/node.vue","webpack://job/./src/components/choose-ip/view/host-detail.vue","webpack://job/./src/components/choose-ip/view/host-search.vue","webpack://job/./src/components/choose-ip/server-panel.vue","webpack://job/./src/components/choose-ip/preview.vue","webpack://job/./src/components/choose-ip/index.vue","webpack://job/./src/components/global-variable/edit/host.vue","webpack://job/./src/components/global-variable/edit/index.vue","webpack://job/./src/components/global-variable/toggle-display.vue","webpack://job/./src/components/task-step/file/card-layout.vue","webpack://job/./src/components/task-step/common/error-handle.vue","webpack://job/./src/components/task-step/common/source-file/components/action-extend.vue","webpack://job/./src/components/list-action-layout/index.vue","webpack://job/./src/views/script-manage/common/script-related-info/index.vue","webpack://job/./src/components/list-operation-extend/index.vue","webpack://job/./src/components/apply-permission/apply-section.vue","webpack://job/./src/views/task-manage/common/variable-use-guide/index.vue","webpack://job/./src/views/task-manage/common/render-global-var/operation/string.vue","webpack://job/./src/views/task-manage/common/render-global-var/operation/host.vue","webpack://job/./src/views/task-manage/common/render-global-var/operation/array.vue","webpack://job/./src/components/detail-layout/index.vue","webpack://job/./src/components/detail-layout/item.vue","webpack://job/./src/components/jb-edit/textarea.vue","webpack://job/./src/components/jb-edit/host.vue","webpack://job/./src/views/task-manage/common/render-global-var/batch-operation/create-table-row.vue","webpack://job/./src/views/task-manage/common/render-global-var/batch-operation/index.vue","webpack://job/./src/views/task-manage/common/render-global-var/detail/index.vue","webpack://job/./src/views/task-manage/common/render-global-var/edit-of-plan/host.vue","webpack://job/./src/views/task-manage/common/render-global-var/edit-of-plan/array.vue","webpack://job/./src/views/task-manage/common/render-global-var/edit-of-plan/index.vue","webpack://job/./src/views/task-manage/common/render-global-var/popover-detail.vue","webpack://job/./src/views/task-manage/common/render-global-var/index.vue","webpack://job/./src/components/render-server-agent/index.vue","webpack://job/./src/components/smart-input/index.vue","webpack://job/./src/components/task-step/common/source-file/components/edit-file-path.vue","webpack://job/./src/components/task-step/common/source-file/view/server/index.vue","webpack://job/./src/components/task-step/common/source-file/view/source/components/choose-source-file/select-file-source.vue","webpack://job/./src/components/task-step/common/source-file/view/source/components/choose-source-file/select-file.vue","webpack://job/./src/components/task-step/common/source-file/view/source/components/choose-source-file/index.vue","webpack://job/./src/components/task-step/common/source-file/view/source/components/render-source-name.vue","webpack://job/./src/components/task-step/common/source-file/view/source/components/render-file-name.vue","webpack://job/./src/components/task-step/common/source-file/view/index.vue","webpack://job/./src/components/task-step/common/source-file/index.vue","webpack://job/./src/components/task-step/file/strategy/target-path.vue","webpack://job/./src/components/task-step/file/strategy/transfer-mode.vue","webpack://job/./src/components/compose-form-item/styles.css","webpack://job/./src/components/task-step/script/strategy/script-source-of-execution.vue","webpack://job/./src/components/task-step/common/execute-target/index.vue","webpack://job/./src/components/task-step/file/strategy/speed-limit.vue","webpack://job/./src/views/task-manage/common/render-task-step/task-step/components/distro-file.vue","webpack://job/./src/components/task-step/script/strategy/script-source-of-template.vue","webpack://job/./src/components/jb-user-selector/index.vue","webpack://job/./src/components/global-variable/view/index.vue","webpack://job/./src/views/executive-history/common/execution-status-bar/task.vue","webpack://job/./src/views/executive-history/common/execution-status-bar/index.vue","webpack://job/./src/views/executive-history/common/step-action/index.vue","webpack://job/./src/views/executive-history/common/global-variable.vue","webpack://job/./src/views/executive-history/common/operation-record.vue","webpack://job/./src/views/task-manage/common/render-task-step/task-step-view/components/render-file-path.vue","webpack://job/./src/views/task-manage/common/render-task-step/task-step-view/components/render-global-variable.vue","webpack://job/./src/components/ace-editor/index.vue","webpack://job/./src/views/script-manage/common/components/layout.vue","webpack://job/./src/views/script-manage/common/detail/index.vue","webpack://job/./src/components/task-step/script/strategy/script-param.vue","webpack://job/./src/views/task-manage/common/render-task-step/task-step/components/artificial.vue","webpack://job/./src/views/task-manage/common/render-task-step/task-step/index.vue","webpack://job/./src/views/task-manage/common/render-task-step/task-step-view/components/render-file-server.vue","webpack://job/./src/views/task-manage/common/render-task-step/task-step-view/components/render-source-file.vue","webpack://job/./src/views/task-manage/common/render-task-step/task-step-view/distro-file.vue","webpack://job/./src/views/task-manage/common/render-task-step/task-step-view/exec-script.vue","webpack://job/./src/views/task-manage/common/render-task-step/task-step-view/artificial.vue","webpack://job/./src/views/task-manage/common/render-task-step/task-step-view/index.vue","webpack://job/./src/components/back-top/index.vue","webpack://job/./src/views/task-manage/common/render-task-step/index.vue","webpack://job/./src/views/task-manage/common/plan/components/layout.vue","webpack://job/./src/views/task-manage/common/plan/components/toggle-display.vue","webpack://job/./src/views/task-manage/common/plan/components/edit-title.vue","webpack://job/./src/views/task-manage/common/plan/detail.vue","webpack://job/./src/views/task-manage/common/plan/edit.vue","webpack://job/./src/views/task-manage/common/plan/create.vue","webpack://job/./src/views/task-manage/common/plan/list/components/layout.vue","webpack://job/./src/views/task-manage/common/plan/list/components/template-select.vue","webpack://job/./src/views/task-manage/common/plan/list/components/batch-edit-gobal-variable/edit-value/components/render-global-variable/host.vue","webpack://job/./src/views/task-manage/common/plan/list/components/batch-edit-gobal-variable/edit-value/components/render-global-variable/index.vue","webpack://job/./src/views/task-manage/common/plan/list/components/batch-edit-gobal-variable/edit-value/index.vue","webpack://job/./src/views/task-manage/common/plan/list/components/batch-edit-gobal-variable/edit-preview/components/render-related-info.vue","webpack://job/./src/views/task-manage/common/plan/list/components/batch-edit-gobal-variable/edit-preview/index.vue","webpack://job/./src/views/task-manage/common/plan/list/components/batch-edit-gobal-variable/index.vue","webpack://job/./src/views/task-manage/common/plan/list/index.vue"],"sourcesContent":["@import \"@/css/mixins/scroll\";\n\n.jb-bk-search-select {\n    height: 32px;\n    font-size: 12px;\n\n    .search-select-wrap {\n        position: relative;\n        height: unset;\n        min-height: 32px;\n        overflow: hidden;\n        color: #63656e;\n        border: 1px solid #c4c6cc;\n        border-radius: 2px;\n        box-sizing: border-box;\n        transition: border 0.2s linear;\n\n        .search-prefix {\n            display: flex;\n            height: 100%;\n            flex: 0 0 auto;\n            align-items: center;\n        }\n\n        .search-tag-group {\n            position: relative;\n            min-height: 26px;\n            padding: 0 6px;\n            font-size: 0;\n            line-height: 0;\n            transition: max-height 0.15s cubic-bezier(0.4, 0, 0.2, 1);\n        }\n\n        .search-input-box {\n            position: relative;\n            display: inline-block;\n            min-width: 40px;\n            min-height: 22px;\n            margin-top: 4px;\n            font-size: 12px;\n            line-height: 22px;\n            color: #63656e;\n            vertical-align: middle;\n            border: none;\n\n            .input-box {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                padding: 0;\n                font-size: inherit;\n                line-height: inherit;\n                color: inherit;\n                background: transparent;\n                border: none;\n                outline: none;\n                resize: none;\n\n                @mixin scroller;\n            }\n        }\n\n        .search-tag-box {\n            .search-tag {\n                display: inline-flex;\n                padding-right: 20px;\n\n                .tag-label {\n                    word-break: keep-all;\n                }\n\n                .tag-value {\n                    word-break: break-all;\n                    cursor: pointer;\n                }\n\n                .tag-value-edit {\n                    position: absolute;\n                    top: 0;\n                    width: 100%;\n                    height: 100%;\n                    padding: 0;\n                    font-size: inherit;\n                    line-height: inherit;\n                    color: inherit;\n                    background: transparent;\n                    border: none;\n                    outline: none;\n                    resize: none;\n\n                    &::selection {\n                        background: #e1ecff;\n                    }\n                }\n            }\n\n            &.focused {\n                background: inherit !important;\n\n                .search-tag {\n                    padding-right: 0;\n                }\n            }\n\n            .tag-clear {\n                position: absolute;\n                top: 4px;\n                right: 3px;\n                display: inline-block;\n                font-size: 14px;\n                line-height: normal;\n                color: #979ba5;\n                text-align: center;\n                cursor: pointer;\n            }\n        }\n\n        .mult-tag-placeholder {\n            padding: 0 8px;\n        }\n\n        .search-tag-box,\n        .mult-tag-placeholder {\n            position: relative;\n            display: inline-block;\n            padding-left: 8px;\n            margin: 4px 6px 0 0;\n            font-size: 12px;\n            line-height: 22px;\n            color: #63656e;\n            vertical-align: middle;\n            background: #f0f1f5;\n            border-radius: 2px;\n\n            &:hover {\n                background: #dcdee5;\n\n                .tag-clear {\n                    color: #63656e;\n                }\n            }\n        }\n\n        .search-nextfix {\n            @extend .search-prefix;\n\n            position: absolute;\n            top: 6px;\n            right: 0;\n            color: #c4c6cc;\n\n            .search-clear {\n                width: 12px;\n                height: 12px;\n                margin-right: 6px;\n                font-size: 14px;\n                color: #c4c6cc;\n\n                &:hover {\n                    color: #979ba5;\n                    cursor: pointer;\n                }\n            }\n\n            .search-nextfix-icon {\n                margin-right: 8px;\n                font-size: 16px;\n                transition: color 0.2s linear;\n\n                &.is-focus {\n                    color: #3c96ff;\n                    background: #fff !important;\n                    border-color: #3c96ff !important;\n                }\n            }\n        }\n\n        &::-webkit-scrollbar {\n            width: 3px;\n            height: 5px;\n        }\n\n        &::-webkit-scrollbar-thumb {\n            background: #e6e9ea;\n            border-radius: 20px;\n            box-shadow: inset 0 0 6px rgb(204 204 204 / 30%);\n        }\n    }\n\n    &.focused {\n        .search-select-wrap {\n            overflow-y: auto;\n            color: #3c96ff;\n            background: #fff !important;\n            border-color: #3c96ff !important;\n        }\n    }\n\n    .bk-select-tips {\n        display: flex;\n        margin-top: 5px;\n        font-size: 12px;\n        line-height: 16px;\n        color: #ea3636;\n        align-items: center;\n\n        .select-tips {\n            width: 16px;\n            height: 16px;\n            margin-right: 5px;\n            font-size: 16px;\n        }\n    }\n}\n","@import \"@/css/mixins/scroll\";\n\n.jb-bk-search-list {\n    position: relative;\n    min-width: 230px;\n    padding: 6px 0;\n    margin: -0.3rem -0.6rem;\n    font-size: 12px;\n    line-height: 32px;\n    color: #63656e;\n    pointer-events: all;\n    border: 1px solid #dcdee5;\n    border-radius: 2px;\n    outline: none;\n    resize: none;\n\n    .search-condition {\n        padding: 0 10px 0 16px;\n        pointer-events: auto;\n        border-bottom: 1px solid #dcdee5;\n\n        &:hover {\n            color: #3a84ff;\n            cursor: pointer;\n            background-color: rgb(234 243 255 / 70%);\n        }\n    }\n\n    .search-menu {\n        max-height: 200px;\n        min-height: 32px;\n        padding: 0;\n        margin: 0;\n        overflow-x: hidden;\n        overflow-y: auto;\n        pointer-events: all;\n\n        @mixin scroller;\n\n        .is-group {\n            border-bottom: 1px solid #dcdee5;\n        }\n\n        .search-menu-item {\n            display: flex;\n            padding: 0 10px 0 16px;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n            pointer-events: auto;\n            flex: 1 0 32px;\n            align-items: center;\n            justify-content: flex-start;\n\n            &.is-disabled {\n                color: #c4c6cc;\n                cursor: not-allowed;\n            }\n\n            .item-name {\n                display: flex;\n                line-height: 32px;\n                flex: 1;\n\n                &-filter {\n                    display: inline-block;\n                    color: #313238;\n                }\n            }\n\n            .item-description {\n                padding-left: 10px;\n                margin-left: auto;\n                font-size: 12px;\n                color: #c4c6cc;\n            }\n\n            .item-icon {\n                font-size: 14px;\n                font-weight: bold;\n                color: #3a84ff;\n            }\n\n            &:not(.is-disabled):hover {\n                color: #3a84ff;\n                cursor: pointer;\n                background-color: #eaf3ff;\n            }\n\n            &.active {\n                color: #3a84ff;\n                background: #f4f6fa;\n            }\n        }\n    }\n\n    .search-loading {\n        padding: 0 16px;\n        line-height: 32px;\n        text-align: center;\n    }\n\n    .search--error {\n        padding: 0 10px 0 16px;\n        font-weight: bold;\n        line-height: 32px;\n    }\n\n    .search-list-footer {\n        display: flex;\n        margin-bottom: -6px;\n        line-height: 32px;\n        pointer-events: auto;\n        flex-direction: row;\n        justify-content: space-around;\n        align-items: center;\n\n        .footer-btn {\n            text-align: center;\n            pointer-events: auto;\n            border-top: 1px solid #dcdee5;\n            flex: 1;\n\n            &:hover {\n                color: #3a84ff;\n                cursor: pointer;\n                background-color: rgb(234 243 255 / 70%);\n            }\n\n            &:first-child {\n                border-right: 1px solid #dcdee5;\n            }\n\n            &.disabled {\n                color: #dcdee5;\n                cursor: not-allowed;\n            }\n        }\n    }\n\n    .search-menu-wrap {\n        padding: 6px 0;\n    }\n\n    .search-suggest-menu-wraper {\n        max-width: 500px;\n        max-height: 200px;\n        min-height: 32px;\n        overflow-x: hidden;\n        overflow-y: auto;\n\n        @mixin scroller;\n\n        .search-suggest-menu-list {\n            width: 100%;\n            max-width: 100%;\n            font-size: 12px;\n            line-height: 32px;\n            line-height: 16px;\n            color: #63656e;\n            border-collapse: collapse;\n            border-spacing: 0;\n\n            .search-suggest-menu-item {\n                height: 32px;\n                padding-top: 8px;\n                vertical-align: top;\n                cursor: pointer;\n\n                &.active,\n                &:hover {\n                    color: #3a84ff;\n                    background: #eaf3ff;\n                }\n            }\n\n            .search-suggest-item-label,\n            .search-suggest-item-value {\n                padding-top: 8px;\n                vertical-align: top;\n            }\n\n            .search-suggest-item-label {\n                width: 60px;\n                padding-left: 12px;\n                font-weight: bold;\n                text-align: right;\n                white-space: nowrap;\n            }\n\n            .search-suggest-item-value {\n                display: flex;\n                max-width: 300px;\n                padding-right: 12px;\n                overflow: hidden;\n\n                .value-text {\n                    overflow: hidden;\n                    text-overflow: ellipsis;\n                    white-space: nowrap;\n                    flex: 1;\n                }\n\n                .description-text {\n                    padding-left: 8px;\n                    margin-left: auto;\n                    font-size: 12px;\n                    color: #c4c6cc;\n                    text-align: right;\n                    flex: 0 0 auto;\n                }\n            }\n        }\n    }\n}\n\n.tippy-tooltip {\n    &.bk-search-select-theme-theme {\n        border-radius: 2px;\n        box-shadow: 0 3px 9px 0 rgb(0 0 0 / 10%);\n    }\n}\n","\n<template>\n    <div\n        ref=\"renderList\"\n        class=\"jb-render-list\"\n        v-test=\"{ type: 'data', value: 'table' }\"\n        v-bkloading=\"{ isLoading }\">\n        <bk-table\n            v-if=\"isRendered\"\n            v-bind=\"$attrs\"\n            v-on=\"$listeners\"\n            :default-sort=\"defaultSort\"\n            :data=\"data\"\n            :pagination=\"realPagination\"\n            :max-height=\"tableMaxHeight\"\n            width=\"100%\"\n            @sort-change=\"handleSort\"\n            @page-change=\"handlePageChange\"\n            @page-limit-change=\"handleLimitChange\">\n            <template slot=\"prepend\">\n                <div v-if=\"selectNums > 0\" class=\"jb-table-select-tips\">\n                    <!-- eslint-disable-next-line max-len -->\n                    <span>{{ '已选择'}}<span class=\"number strong\">{{ selectNums }}</span>{{ '条'}}</span>\n                    <span class=\"action-clear\" @click=\"handleClearAllSelect\">，{{ '清除所有勾选' }}</span>\n                </div>\n                <slot name=\"prepend\" />\n            </template>\n            <bk-table-column\n                v-if=\"selectable\"\n                :render-header=\"renderHeader\"\n                key=\"listSelect\"\n                width=\"70\">\n                <template slot-scope=\"{ row }\">\n                    <bk-checkbox\n                        :checked=\"!!rowSelectMemo[row[primaryKey]]\"\n                        @change=\"value => handleRowSelect(row, value)\" />\n                </template>\n            </bk-table-column>\n            <slot />\n            <div v-if=\"isRequesting\" slot=\"empty\" style=\"height: 200px;\" />\n            <Empty v-else-if=\"isSearching\" slot=\"empty\" type=\"search\">\n                <div>\n                    <div style=\"font-size: 14px; color: #63656e;\">{{ '搜索结果为空' }}</div>\n                    <div style=\"margin-top: 8px; font-size: 12px; line-height: 16px; color: #979ba5;\">\n                        <span>{{ '可以尝试调整关键词' }}</span>\n                        <template v-if=\"searchControl\">\n                            <span>{{ '或' }}</span>\n                            <bk-button\n                                text\n                                @click=\"handleClearSearch\">\n                                {{ '清空搜索条件' }}\n                            </bk-button>\n                        </template>\n                    </div>\n                </div>\n            </Empty>\n        </bk-table>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import Empty from '@components/empty';\n    import EventBus from '@utils/event-bus';\n    import {\n        getOffset,\n        buildURLParams,\n    } from '@utils/assist';\n    import { routerCache } from '@utils/cache-helper';\n\n    export default {\n        components: {\n            Empty,\n        },\n        inheritAttrs: false,\n        props: {\n            // 数据源\n            dataSource: {\n                type: Function,\n                required: true,\n            },\n            // 指定列表页面的name\n            name: String,\n            // 是否解析 URL 的 query\n            ignoreUrl: {\n                type: Boolean,\n                default: false,\n            },\n            // 是否可以选择行\n            selectable: {\n                type: Boolean,\n                default: false,\n            },\n            // 使用小型分页选择器\n            paginationSmall: {\n                type: Boolean,\n                default: false,\n            },\n            // data 数据的主键\n            primaryKey: {\n                type: String,\n                default: 'id',\n            },\n            // 获取列表的联动搜索控件\n            searchControl: {\n                type: Function,\n            },\n        },\n        data () {\n            return {\n                isRendered: false, // 组件是否已渲染\n                isRequesting: false, // api 数据请求中\n                isLoading: true, // api 数据加载中 (api 数据请求超过 300ms 才会显示 loading 效果)\n                isSearching: false, // 是否有搜索条件\n                data: [{},{},{}],\n                tableMaxHeight: '',\n                rowSelectMemo: Object.create(null),\n                selectNums: 0,\n                params: {},\n                pagination: {\n                    count: 0,\n                    current: 1,\n                    limit: 10,\n                },\n            };\n        },\n        computed: {\n            /**\n             * @desc 列表当前页是否全选\n             * @returns {Boolean}\n             */\n            isPageChecked () {\n                if (Object.keys(this.rowSelectMemo).length < 1) {\n                    return false;\n                }\n                let status = true;\n                // eslint-disable-next-line no-plusplus\n                for (let i = 0; i < this.data.length; i++) {\n                    if (!this.rowSelectMemo[this.data[i][this.primaryKey]]) {\n                        status = false;\n                        break;\n                    }\n                }\n                return status;\n            },\n            /**\n             * @desc 是否全选\n             * @returns {Boolean}\n             */\n            isWholeChecked () {\n                return this.selectNums > 0 && this.selectNums >= this.pagination.count;\n            },\n            /**\n             * @desc 列表分页的状态\n             * @returns {Object}\n             */\n            realPagination () {\n                return {\n                    ...this.pagination,\n                    small: this.paginationSmall,\n                };\n            },\n        },\n        watch: {\n            rowSelectMemo () {\n                this.selectNums = Object.keys(this.rowSelectMemo).length;\n                this.data = [\n                    ...this.data,\n                ];\n            },\n        },\n        created () {\n            // 页面回退时返回列表选择（url标记listSelectIds）\n            const { listSelectIds } = this.$route.query;\n            if (listSelectIds) {\n                listSelectIds.split(',').forEach((id) => {\n                    this.rowSelectMemo[this.primaryKey] = true;\n                });\n                setTimeout(() => {\n                    this.triggerSelectChange();\n                });\n            }\n            // render list内部的筛选参数排序、过滤\n            this.defaultSort = {};\n            this.requestParamsMemo = {};\n            if (!this.ignoreUrl) {\n                this.parseURL();\n            }\n        },\n        mounted () {\n            this.init();\n            this.$on('onFetch', (params) => {\n                if (params) {\n                    this.params = Object.freeze(params);\n                    if (!this.waitingInit) {\n                        this.pagination.current = 1;\n                    }\n                    this.waitingInit = false;\n                }\n                const pageSize = this.pagination.limit;\n                const start = parseInt(this.pagination.current - 1, 10) * pageSize;\n                \n                const requestParams = {\n                    ...this.defaultSortParams,\n                    ...this.params,\n                    pageSize,\n                    start,\n                };\n                if (!this.ignoreUrl) {\n                    // 缓存路由参数在回退时还原\n                    routerCache.setItem(this.$route.name, requestParams);\n                    window.history.replaceState({}, '', `?${buildURLParams(requestParams)}`);\n                }\n                \n                // 跨页全选时同样需要过滤\n                this.requestParamsMemo = requestParams;\n                this.isRequesting = true;\n                // this.$request(this.dataSource(requestParams, {\n                //     permission: 'page',\n                // }), () => {\n                //     this.isLoading = true;\n                // }).then((data) => {\n                const data = {\n                    data: [{}, {}, {}, {}, {}, {}, {}, {}, {}],\n                    total: 100,\n                };\n                this.pagination = {\n                    ...this.pagination,\n                    count: data.total || 0,\n                };\n                this.$emit('on-refresh', data);\n                // 延后表格数据的更新，保证 on-refresh 事件逻辑优先执行\n                setTimeout(() => {\n                    this.data = data.data;\n                    this.isSearching = !this.checkSearchEmpty();\n                });\n\n                // 重要！！！（列表 api 返回数据说明）\n                // existAny 表示资源总数是否为 0\n                // total 表示本次筛选结果数\n                if (!this.ignoreUrl\n                    && Object.prototype.hasOwnProperty.call(data, 'existAny')\n                    && !data.existAny) {\n                    // 被page-guide页面接收, 还没内容就显示引导页面\n                    EventBus.$emit('page-empty');\n                }\n                // })\n                // .finally(() => {\n                this.isLoading = false;\n                this.isRequesting = false;\n                // });\n            });\n        },\n        methods: {\n            /**\n             * @desc 计算默认分页、表格高度\n             */\n            init () {\n                const { top } = getOffset(this.$refs.renderList);\n                const windowHeight = window.innerHeight;\n                const tableHeadHeight = 42;\n                const paginationHeight = 63;\n                const windownOffsetBottom = 20;\n                const listTotalHeight = windowHeight - top - tableHeadHeight - paginationHeight - windownOffsetBottom;\n                const tableRowHeight = 42;\n                const limit = Math.floor(listTotalHeight / tableRowHeight);\n                const pageLimit = new Set([\n                    10, 20, 50, 100, limit,\n                ]);\n                if (!pageLimit.has(this.pagination.limit)) {\n                    pageLimit.add(this.pagination.limit);\n                }\n                this.pagination.limitList = [\n                    ...pageLimit,\n                ].sort((a, b) => a - b);\n                if (!this.waitingInit) {\n                    this.pagination.limit = limit;\n                }\n                this.tableMaxHeight = tableHeadHeight + tableRowHeight * limit + paginationHeight;\n                this.isRendered = true;\n            },\n            /**\n             * @desc 解析url\n             */\n            parseURL () {\n                this.URLQuery = this.$route.query;\n                const pageSize = ~~this.URLQuery.pageSize;\n                const start = ~~this.URLQuery.start;\n                this.waitingInit = false;\n                // 解析url的分页信息\n                if (pageSize) {\n                    this.pagination.current = parseInt(start / pageSize, 10) + 1;\n                    this.pagination.limit = pageSize;\n                    this.waitingInit = true;\n                }\n                // 解析url的排序信息\n                const { orderField, order } = this.URLQuery;\n                \n                if (orderField) {\n                    // table默认排序设置\n                    this.defaultSort.prop = orderField;\n                    this.defaultSort.order = ~~order ? 'ascending' : 'descending';\n                }\n                this.defaultSortParams = {};\n                \n                if (Object.prototype.hasOwnProperty.call(this.URLQuery, 'orderField')\n                    && Object.prototype.hasOwnProperty.call(this.URLQuery, 'order')) {\n                    // api默认排序参数\n                    this.defaultSortParams = {\n                        orderField,\n                        order,\n                    };\n                }\n            },\n            /**\n             * @desc 外部调用，重置 table 的选择状态\n             */\n            resetSelect () {\n                this.handleClearAllSelect();\n            },\n            /**\n             * @desc 跨页全选\n             */\n            fetchWhole () {\n                if (this.isWholeChecked) {\n                    return;\n                }\n                this.$request(this.dataSource({\n                    ...this.requestParamsMemo,\n                    pageSize: -1,\n                    start: -1,\n                }), () => {\n                    this.isLoading = true;\n                }).then((data) => {\n                    const rowSelectMemo = {};\n                    data.data.forEach((item) => {\n                        rowSelectMemo[item[this.primaryKey]] = item;\n                    });\n                    this.rowSelectMemo = Object.freeze(rowSelectMemo);\n                    this.triggerSelectChange();\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 自定义表头\n             */\n            renderHeader (h) {\n                const renderCheckbox = () => {\n                    if (this.isWholeChecked) {\n                        return (\n                        <div class=\"jb-whole-check\" onClick={this.handleClearAllSelect} />\n                        );\n                    }\n                    return (\n                    <bk-checkbox checked={this.isPageChecked} nativeOnClick={this.handlePageSelectToggle} />\n                    );\n                };\n                return (\n                <div class=\"select-cell\">\n                    {renderCheckbox()}\n                    <bk-popover\n                        placement=\"bottom-start\"\n                        theme=\"light jb-table-select-menu\"\n                        arrow={ false }\n                        size=\"regular\">\n                        <icon class=\"select-menu-flag\" type=\"down-small\" />\n                        <div slot=\"content\" class=\"jb-table-select-plan\">\n                            <div class=\"item\" onClick={this.handlePageSelect}>{'本页全选'}</div>\n                            <div class=\"item\" onClick={this.fetchWhole}>{'跨页全选'}</div>\n                        </div>\n                    </bk-popover>\n                </div>\n                );\n            },\n            /**\n             * @desc 触发行选中\n             */\n            triggerSelectChange () {\n                const result = [];\n                Object.keys(this.rowSelectMemo).forEach((idKey) => {\n                    if (_.isObject(this.rowSelectMemo[idKey])) {\n                        result.push(this.rowSelectMemo[idKey]);\n                    } else {\n                        // 如果是通过 url的查询参数listSelectIds还原选中状态\n                        // 这个时候没法获取到每一条的详细数据，只能返回基本数据{ id: 1 }\n                        result.push({\n                            [this.primaryKey]: idKey,\n                        });\n                    }\n                });\n                this.$emit('on-selection-change', result);\n            },\n            /**\n             * @desc 触发排序\n             * @param {Object} payload 表格行的数据\n             */\n            handleSort (payload) {\n                const sort = {\n                    descending: 0,\n                    ascending: 1,\n                };\n                if (payload.prop) {\n                    this.params = Object.freeze({\n                        ...this.params,\n                        orderField: payload.prop,\n                        order: sort[payload.order],\n                    });\n                } else {\n                    const params = {\n                        ...this.params,\n                    };\n                    delete params.orderField;\n                    delete params.order;\n                    this.params = Object.freeze(params);\n                }\n                \n                this.$emit('onFetch');\n            },\n            /**\n             * @desc 翻页\n             * @param {Number} value 最新展示页\n             */\n            handlePageChange (value) {\n                this.pagination.current = value;\n                this.$emit('onFetch');\n            },\n            /**\n             * @desc 每页条数\n             * @param {Number} value 最新每页展示条数\n             */\n            handleLimitChange (value) {\n                this.pagination.current = 1;\n                this.pagination.limit = value;\n                this.$emit('onFetch');\n            },\n            /**\n             * @desc 列表全选切换\n             */\n            handlePageSelectToggle () {\n                const rowSelectMemo = { ...this.rowSelectMemo };\n                this.data.forEach((item) => {\n                    if (this.isPageChecked) {\n                        delete rowSelectMemo[item[this.primaryKey]];\n                    } else {\n                        rowSelectMemo[item[this.primaryKey]] = item;\n                    }\n                });\n                this.rowSelectMemo = Object.freeze(rowSelectMemo);\n                this.triggerSelectChange();\n            },\n            /**\n             * @desc 列表单页全选切换\n             */\n            handlePageSelect () {\n                if (this.isPageChecked) {\n                    return;\n                }\n                const rowSelectMemo = { ...this.rowSelectMemo };\n                this.data.forEach((item) => {\n                    rowSelectMemo[item[this.primaryKey]] = item;\n                });\n                this.rowSelectMemo = Object.freeze(rowSelectMemo);\n\n                this.triggerSelectChange();\n            },\n            /**\n             * @desc 选择某一行\n             * @param {Object} row 表格行数据\n             * @param {Boolean} value 行的选中状态\n             */\n            handleRowSelect (row, value) {\n                const rowSelectMemo = { ...this.rowSelectMemo };\n                if (value) {\n                    rowSelectMemo[row[this.primaryKey]] = row;\n                } else {\n                    delete rowSelectMemo[row[this.primaryKey]];\n                }\n                this.rowSelectMemo = Object.freeze(rowSelectMemo);\n                this.triggerSelectChange();\n            },\n            /**\n             * @desc 清除选中状态\n             */\n            handleClearAllSelect () {\n                this.rowSelectMemo = Object.create(null);\n                this.triggerSelectChange();\n            },\n            /**\n             * @desc 检测搜索条件是否为空\n             * @returns {Boolean}\n             */\n            checkSearchEmpty () {\n                if (!this.searchControl || typeof this.searchControl !== 'function') {\n                    return false;\n                }\n                const searchControl = this.searchControl();\n                if (!searchControl || typeof searchControl.checkEmpty !== 'function') {\n                    return false;\n                }\n                return searchControl.checkEmpty();\n            },\n            /**\n             * @desc 清除列表筛选参数\n             */\n            handleClearSearch () {\n                const searchControl = this.searchControl();\n                if (typeof searchControl.reset === 'function') {\n                    searchControl.reset();\n                }\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .jb-render-list {\n        .bk-table-pagination-wrapper {\n            background: #fff;\n        }\n\n        .bk-table-body-wrapper {\n            td {\n                .bk-table-setting-content {\n                    display: none;\n                }\n            }\n        }\n\n        .select-cell {\n            position: relative;\n            display: flex;\n            align-items: center;\n\n            .jb-whole-check {\n                position: relative;\n                display: inline-block;\n                width: 16px;\n                height: 16px;\n                vertical-align: middle;\n                cursor: pointer;\n                background-color: #fff;\n                border: 1px solid #3a84ff;\n                border-radius: 2px;\n\n                &::after {\n                    position: absolute;\n                    top: 1px;\n                    left: 4px;\n                    width: 4px;\n                    height: 8px;\n                    border: 2px solid #3a84ff;\n                    border-top: 0;\n                    border-left: 0;\n                    content: \"\";\n                    transform: rotate(45deg);\n                }\n            }\n\n            .select-menu-flag {\n                margin-left: 4px;\n                font-size: 18px;\n            }\n        }\n\n        .jb-table-select-tips {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            height: 30px;\n            background: #ebecf0;\n\n            .strong {\n                color: inherit;\n            }\n\n            .action-clear {\n                color: #3a84ff;\n                cursor: pointer;\n            }\n        }\n\n        .bk-table-empty-block {\n            height: auto;\n            background: #fff;\n        }\n    }\n\n    .tippy-tooltip {\n        &.jb-table-select-menu-theme {\n            padding: 0;\n\n            .jb-table-select-plan {\n                padding: 5px 0;\n\n                .item {\n                    padding: 0 10px;\n                    font-size: 12px;\n                    line-height: 26px;\n                    cursor: pointer;\n\n                    &:hover {\n                        color: #3a84ff;\n                        background-color: #eaf3ff;\n                    }\n\n                    &.is-selected {\n                        color: #3a84ff;\n                        background-color: #f4f6fa;\n                    }\n                }\n            }\n        }\n    }\n</style>\n","<template>\n    <search-select\n        class=\"jb-search-select\"\n        ref=\"searchSelect\"\n        v-bind=\"$attrs\"\n        v-on=\"$listeners\"\n        :placeholder=\"placeholder\"\n        :data=\"data\"\n        :show-condition=\"false\"\n        :values=\"searchValue\"\n        @change=\"handleChange\" />\n</template>\n<script>\n    import _ from 'lodash';\n    import { userSearchCache } from '@utils/cache-helper';\n    import SearchSelect from './search-select';\n\n    const filterValue = (payload) => {\n        // 过滤空值，保证每项只会筛选一次\n        const result = _.cloneDeep(payload);\n        const valueMap = {};\n        const resultIdSet = new Set();\n        result.forEach((value) => {\n            if (!value) {\n                return;\n            }\n            if (resultIdSet.has(value.id)) {\n                // 删除旧的值，同一个ID再次被添加时保持添加顺序\n                resultIdSet.delete(value.id);\n            }\n            resultIdSet.add(value.id);\n            valueMap[value.id] = value;\n        });\n        return [...resultIdSet].map(key => Object.freeze(valueMap[key]));\n    };\n\n    export default {\n        name: 'JbSearchSelect',\n        components: {\n            SearchSelect,\n        },\n        props: {\n            data: {\n                type: Array,\n                default: () => [],\n            },\n            placeholder: {\n                type: String,\n                default: '',\n            },\n            value: {\n                type: Array,\n                default: () => [],\n            },\n            parseUrl: {\n                type: Boolean,\n                default: true,\n            },\n            // 外部设置的筛选值添加到已有筛选值后面\n            appendValue: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                searchValue: [],\n            };\n        },\n        watch: {\n            value: {\n                handler (val) {\n                    let oldSearchComponentValue = [];\n                    if (this.$refs.searchSelect) {\n                        oldSearchComponentValue = this.$refs.searchSelect.chipList;\n                    }\n                    this.searchValue = filterValue([...oldSearchComponentValue, ...val]);\n                },\n                immediate: true,\n            },\n            appendValue: {\n                handler (appendValue) {\n                    setTimeout(() => {\n                        if (!this.$refs.searchSelect) {\n                            return;\n                        }\n                        const appendMap = appendValue.reduce((result, item) => {\n                            result[item.id] = true;\n                            return result;\n                        }, {});\n                        const value = [];\n                        this.$refs.searchSelect.chipList.forEach((currentValue) => {\n                            if (!appendMap[currentValue.id]) {\n                                value.push(currentValue);\n                            }\n                        });\n\n                        this.searchValue = Object.freeze([...value, ...appendValue]);\n                    });\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            if (this.parseUrl) {\n                this.parseURLData();\n            }\n        },\n        methods: {\n            /**\n             * @desc 解析 URL 参数\n             */\n            parseURLData  () {\n                this.URLQuery = this.$route.query;\n\n                const defaultSearchComponentValue = [];\n                // 默认筛选数据\n                const defaultSearchValue = {};\n                const promiseStack = [];\n                // eslint-disable-next-line no-plusplus\n                for (let i = 0; i < this.data.length; i++) {\n                    const currentData = this.data[i];\n                    \n                    // 只解析存在于搜索配置中的字段\n                    if (!Object.prototype.hasOwnProperty.call(this.URLQuery, currentData.id)) {\n                        continue;\n                    }\n                    // 解析url中筛选项的值\n                    const currentURLParamValue = this.URLQuery[currentData.id];\n                    if (currentData.multiable) {\n                        defaultSearchValue[currentData.id] = currentURLParamValue.split(',');\n                    } else {\n                        defaultSearchValue[currentData.id] = currentURLParamValue;\n                    }\n\n                    let remoteHandler = Promise.resolve();\n                    \n                    if (currentData.remoteMethod) {\n                        remoteHandler = currentData.remoteMethod();\n                    } else if (currentData.children) {\n                        remoteHandler = Promise.resolve(currentData.children);\n                    } else {\n                        remoteHandler = Promise.resolve(currentURLParamValue);\n                    }\n\n                    const { id, name } = currentData;\n                    const urlSearchValue = this.URLQuery[id];\n\n                    remoteHandler.then((data) => {\n                        let currentSearchComponentValue = {};\n                        let searchValueArr = [];\n                        if (currentData.multiable) {\n                            searchValueArr = urlSearchValue.split(',');\n                        } else {\n                            searchValueArr = [urlSearchValue];\n                        }\n                        if (_.isArray(data)) {\n                            // 远程备选列表；本地备选列表\n                            const valueStack = [];\n                            searchValueArr.forEach((item) => {\n                                // 兼容筛选值已经被删掉的场景\n                                const childItem = data.find(_ => `${_.id}` === `${item}`);\n                                if (childItem) {\n                                    valueStack.push({\n                                        id: childItem.id,\n                                        name: childItem.name,\n                                    });\n                                }\n                            });\n                            if (valueStack.length < 1) {\n                                return;\n                            }\n                            \n                            currentSearchComponentValue = {\n                                id,\n                                name,\n                                values: valueStack,\n                            };\n                        } else {\n                            // 本地直接输入\n                            const valueStack = [];\n                            searchValueArr.forEach((item) => {\n                                // 兼容空值的情况\n                                if (item) {\n                                    valueStack.push({\n                                        id: item,\n                                        name: item,\n                                    });\n                                }\n                            });\n                            if (valueStack.length < 1) {\n                                return;\n                            }\n                            currentSearchComponentValue = {\n                                id,\n                                name,\n                                values: valueStack,\n                            };\n                        }\n                        defaultSearchComponentValue.push(currentSearchComponentValue);\n                    });\n                    promiseStack.push(remoteHandler);\n                }\n                Promise.all(promiseStack).finally(() => {\n                    let oldSearchComponentValue = [];\n                    if (this.$refs.searchSelect) {\n                        oldSearchComponentValue = this.$refs.searchSelect.chipList;\n                    }\n                    this.searchValue = filterValue([...oldSearchComponentValue, ...defaultSearchComponentValue]);\n                    setTimeout(() => {\n                        this.$emit('on-change', defaultSearchValue);\n                        this.$emit('input', defaultSearchValue);\n                    });\n                });\n            },\n            /**\n             * @desc 按 API 格式要求处理筛选值\n             * @params {Object} payload 筛选结果\n             */\n            handleChange (payload) {\n                const validValue = payload;\n                const result = {};\n                const defaultValueMap = val => val.id;\n                const trim = valueTarget => _.isString(valueTarget) ? _.trim(valueTarget) : valueTarget;\n                validValue.forEach((currentValue) => {\n                    const valueMap = typeof currentValue.map === 'function' ? currentValue.map : defaultValueMap;\n                    if (currentValue.multiable) {\n                        result[currentValue.id] = currentValue.values.map(item => trim(valueMap(item)));\n                    } else if (currentValue.values) {\n                        result[currentValue.id] = trim(valueMap(currentValue.values[0]));\n                    } else {\n                        result[currentValue.id] = trim(valueMap(currentValue));\n                    }\n                });\n                // 缓存用户筛选的数据\n                const userFieldArr = ['operator', 'creator', 'lastModifyUser'];\n                userFieldArr.forEach((userField) => {\n                    if (_.has(result, userField)) {\n                        userSearchCache.setItem(result[userField]);\n                    }\n                });\n                \n                this.$emit('on-change', result);\n                this.$emit('input', result);\n            },\n            /**\n             * @desc 外部调用——检查搜索条件是否为空\n             * @returns {Boolean}\n             */\n            checkEmpty () {\n                return this.$refs.searchSelect.chipList.length < 1;\n            },\n            /**\n             * @desc 外部调用——重置筛选条件\n             */\n            reset () {\n                this.searchValue = [];\n                this.$refs.searchSelect.reset();\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .jb-search-select {\n        z-index: 999;\n        background: #fff;\n\n        textarea {\n            &::placeholder {\n                color: #c4c6cc;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"job-tag-select\" v-bkloading=\"{ isLoading }\">\n        <bk-select\n            ref=\"select\"\n            searchable\n            multiple\n            display-tag\n            :clearable=\"false\"\n            :value=\"realValue\"\n            @change=\"handleChange\">\n            <bk-option\n                v-for=\"tagItem in list\"\n                :key=\"tagItem.id\"\n                :id=\"tagItem.id\"\n                :name=\"tagItem.name\" />\n            <template v-if=\"!publicScript\" slot=\"extension\">\n                <auth-component auth=\"tag/create\">\n                    <div @click=\"handleCreate\">\n                        <i class=\"bk-icon icon-plus-circle mr10\" />{{ '新建标签' }}\n                    </div>\n                    <div slot=\"forbid\">\n                        <i class=\"bk-icon icon-plus-circle mr10\" />{{ '新建标签' }}\n                    </div>\n                </auth-component>\n            </template>\n        </bk-select>\n        <lower-component level=\"custom\" :custom=\"isShowCreate\">\n            <operation-tag\n                v-model=\"isShowCreate\"\n                @on-change=\"handleTagNew\" />\n        </lower-component>\n    </div>\n</template>\n<script>\n    import PubliceTagManageService from '@service/public-tag-manage';\n    import TagManageService from '@service/tag-manage';\n    import { checkPublicScript } from '@utils/assist';\n    import OperationTag from '@components/operation-tag';\n\n    export default {\n        name: 'JbTagSelect',\n        components: {\n            OperationTag,\n        },\n        props: {\n            value: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                // tag 列表loading\n                isLoading: true,\n                // 新建 tag 弹框\n                isShowCreate: false,\n                realValue: [],\n                publicScript: true,\n                list: [{},{},{}],\n            };\n        },\n        watch: {\n            value: {\n                handler (value) {\n                    this.realValue = value.map(_ => _.id);\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.publicScript = checkPublicScript(this.$route);\n            \n            this.fetchData();\n        },\n        methods: {\n            /**\n             * @desc 获取 tag 列表\n             */\n            fetchData () {\n                this.isLoading = true;\n                const requestHandler = this.publicScript ? PubliceTagManageService.fetchTagList : TagManageService.fetchWholeList;\n                return requestHandler()\n                    .then((data) => {\n                        this.list = Object.freeze(data);\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 外部调用显示tag选择面板\n             */\n            show () {\n                this.$refs.select.show();\n            },\n            \n            /**\n             * @desc 更新选中的tag\n             */\n            handleChange (value) {\n                const valueMap = value.reduce((result, item) => {\n                    result[item] = true;\n                    return result;\n                }, {});\n                const result = [];\n                this.list.forEach((item) => {\n                    if (valueMap[item.id]) {\n                        result.push({ ...item });\n                    }\n                });\n                this.$emit('on-change', result);\n                this.$emit('change', result);\n                this.$emit('input', result);\n            },\n            /**\n             * @desc 显示新建tag弹框\n             */\n            handleCreate () {\n                this.$refs.select.close();\n                this.isShowCreate = true;\n            },\n            /**\n             * @desc 新建标签\n             * @param { Object } tag\n             */\n            handleTagNew (tag) {\n                this.fetchData()\n                    .then(() => {\n                        this.realValue.push(tag.id);\n                        this.isShowCreate = false;\n                        this.$refs.select.show();\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .job-tag-select {\n        .bk-select {\n            &.is-focus {\n                z-index: 9;\n            }\n        }\n\n        .bk-select-dropdown {\n            background: #fff;\n        }\n    }\n</style>\n","<template>\n    <div class=\"jb-edit-tag\" :class=\"{ shortcurt }\" @click.stop=\"\">\n        <div\n            v-if=\"!isEditing\"\n            class=\"render-value-box\"\n            @click.stop=\"handleTextClick\">\n            <div ref=\"content\" class=\"value-text\" v-bk-overflow-tips tag-edit-tag>\n                <slot v-bind:value=\"text\">{{ text || '--' }}</slot>\n            </div>\n            <template v-if=\"!isLoading\">\n                <div\n                    v-if=\"shortcurt\"\n                    class=\"tag-shortcurt-box\"\n                    @click.stop=\"\">\n                    <div class=\"shortcurt-action-btn\">\n                        <Icon type=\"copy\" @click=\"handleCopy\" />\n                        <Icon type=\"paste\" class=\"paste-btn\" @click=\"handlePaste\" />\n                    </div>\n                </div>\n                <div v-else class=\"tag-normal-box\">\n                    <Icon\n                        type=\"edit-2\"\n                        class=\"edit-action\"\n                        @click.self.stop=\"handleEdit\" />\n                </div>\n            </template>\n            <Icon\n                v-if=\"isLoading\"\n                type=\"loading-circle\"\n                class=\"tag-edit-loading\" />\n        </div>\n        <div v-else class=\"edit-value-box\">\n            <jb-tag-select\n                ref=\"tagSelect\"\n                :value=\"localValue\"\n                @on-change=\"handleTagValueChange\" />\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import { execCopy } from '@utils/assist';\n    import JbTagSelect from '@components/jb-tag-select';\n\n    let copyMemo = [];\n\n    const isEqual = (pre, next) => {\n        if (pre.length !== next.length) {\n            return false;\n        }\n        if (pre.length === 0) {\n            return true;\n        }\n        const preMap = pre.reduce((result, item) => {\n            result[item.id] = true;\n            return result;\n        }, {});\n        next.forEach((item) => {\n            delete preMap[item.id];\n        });\n        return Object.keys(preMap).length < 1;\n    };\n\n    export default {\n        name: 'JbEditTag',\n        components: {\n            JbTagSelect,\n        },\n        props: {\n            field: {\n                type: String,\n                required: true,\n            },\n            value: {\n                type: Array,\n                default: () => [],\n            },\n            // 显示复制粘贴按钮\n            shortcurt: {\n                type: Boolean,\n                default: false,\n            },\n            remoteHander: {\n                type: Function,\n                default: () => Promise.resolve(),\n            },\n            rules: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                isEditing: false,\n                isLoading: false,\n                localValue: this.value,\n            };\n        },\n        computed: {\n            /**\n             * @desc 标签显示文本\n             * @returns { String }\n             */\n            text () {\n                return this.localValue.map(_ => _.name).join('，');\n            },\n        },\n        watch: {\n            value: {\n                handler (value) {\n                    this.localValue = value;\n                    this.memoValue = [...this.value];\n                },\n                immediate: true,\n            },\n        },\n        mounted () {\n            document.body.addEventListener('click', this.hideEdit);\n            this.$once('hook:beforeDestroy', () => {\n                document.body.removeEventListener('click', this.hideEdit);\n            });\n        },\n        \n        methods: {\n            /**\n             * @desc 触发标签修改操作\n             */\n            triggerRemote () {\n                this.isEditing = false;\n                \n                if (isEqual(this.memoValue, this.localValue)) {\n                    return;\n                }\n                \n                this.isLoading = true;\n                \n                this.remoteHander({\n                    [this.field]: this.localValue.map(({ id }) => ({ id })),\n                }).then(() => {\n                    this.memoValue = this.localValue;\n                    this.messageSuccess('编辑成功');\n                    this.$emit('on-change', {\n                        [this.field]: this.localValue,\n                    });\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 切换编辑状态\n             */\n            hideEdit (event) {\n                if (!this.isEditing) return;\n                if (event.path && event.path.length > 0) {\n                    // eslint-disable-next-line no-plusplus\n                    for (let i = 0; i < event.path.length; i++) {\n                        const target = event.path[i];\n                        if (/tippy-popper/.test(target.className)\n                            || /job-tag-create-dialog/.test(target.className)) {\n                            return;\n                        }\n                    }\n                }\n                \n                this.triggerRemote();\n            },\n            /**\n             * @desc tag 值更新\n             * @param { Array } tagList\n             */\n            handleTagValueChange (tagList) {\n                this.localValue = Object.freeze(tagList);\n            },\n            /**\n             * @desc 编辑 tag\n             */\n            handleEdit () {\n                document.body.click();\n                this.$nextTick(() => {\n                    this.isEditing = true;\n                    setTimeout(() => {\n                        this.$refs.tagSelect.show();\n                    });\n                });\n            },\n            /**\n             * @desc 点击 tag 文本开始编辑状态\n             */\n            handleTextClick () {\n                if (!this.shortcurt) {\n                    return;\n                }\n                this.handleEdit();\n            },\n            /**\n             * @desc 复制 tag\n             */\n            handleCopy () {\n                if (this.localValue.length < 1) {\n                    this.$bkMessage({\n                        theme: 'warning',\n                        message: '标签为空',\n                    });\n                    return;\n                }\n                copyMemo = _.cloneDeep(this.localValue);\n                execCopy(this.text);\n            },\n            /**\n             * @desc 粘贴 tag\n             */\n            handlePaste () {\n                if (copyMemo.length < 1) {\n                    this.$bkMessage({\n                        theme: 'warning',\n                        message: '请先复制标签',\n                    });\n                    return;\n                }\n                this.localValue = [\n                    ...new Set([\n                        ...this.localValue,\n                        ...copyMemo,\n                    ]),\n                ];\n                this.triggerRemote();\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .edit-tag-column {\n        .cell {\n            overflow: initial;\n            line-height: 18px;\n            text-overflow: initial;\n            word-break: break-all;\n            -webkit-line-clamp: unset;\n\n            .jb-edit-tag {\n                margin-left: -4px;\n            }\n        }\n    }\n</style>\n<style lang='postcss'>\n    @keyframes tag-edit-loading {\n        to {\n            transform: rotateZ(360deg);\n        }\n    }\n\n    .jb-edit-tag {\n        position: relative;\n        height: 30px;\n        cursor: pointer;\n        border-radius: 2px;\n\n        &.shortcurt:hover {\n            background: #e1e2e6;\n\n            .shortcurt-action-btn {\n                display: flex;\n            }\n        }\n\n        &:hover {\n            .tag-normal-box,\n            .tag-shortcurt-box {\n                display: flex;\n                opacity: 100%;\n                transform: scale(1);\n            }\n        }\n\n        .render-value-box {\n            display: flex;\n            height: 30px;\n            padding-left: 4px;\n            line-height: 30px;\n            align-items: center;\n        }\n\n        .value-text {\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n        }\n\n        .tag-normal-box,\n        .tag-shortcurt-box {\n            display: none;\n            height: 30px;\n            min-width: 24px;\n            color: #979ba5;\n            opacity: 0%;\n            align-items: center;\n        }\n\n        .tag-shortcurt-box {\n            padding-right: 6px;\n            margin-left: auto;\n            font-size: 16px;\n            flex: 0 0 42px;\n\n            .paste-btn {\n                margin-left: 4px;\n            }\n\n            .shortcurt-action-btn {\n                align-items: center;\n\n                i:hover {\n                    color: #3a84ff;\n                }\n            }\n        }\n\n        .tag-normal-box {\n            font-size: 16px;\n            transform: scale(0);\n            transition: 0.15s;\n            transform-origin: left center;\n\n            .edit-action {\n                padding: 6px 15px 6px 2px;\n                cursor: pointer;\n\n                &:hover {\n                    color: #3a84ff;\n                }\n            }\n        }\n\n        .tag-edit-loading {\n            position: absolute;\n            top: 9px;\n            right: 10px;\n            animation: \"tag-edit-loading\" 1s linear infinite;\n        }\n\n        .edit-value-box {\n            width: 100%;\n        }\n    }\n</style>\n","<template>\n    <transition name=\"host-sideslider\" :duration=\"300\">\n        <div v-if=\"value\">\n            <div class=\"sideslider-box\" :style=\"styles\">\n                <div class=\"container\" @click.stop=\"\">\n                    <div class=\"box-header\">\n                        <div class=\"toggle-btn\" @click=\"handleClose\">\n                            <Icon class=\"btn-flag\" type=\"down-small\" />\n                        </div>\n                        <div class=\"box-title\">\n                            <slot name=\"title\" />\n                            <div class=\"desc\">\n                                <slot name=\"desc\" />\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"box-content\">\n                        <scroll-faker>\n                            <slot />\n                        </scroll-faker>\n                    </div>\n                    <div class=\"box-footer\">\n                        <bk-button theme=\"primary\" @click=\"handleClose\">{{ '关闭' }}</bk-button>\n                    </div>\n                </div>\n                <div class=\"box-mask\" @click=\"handleClose\" />\n            </div>\n        </div>\n    </transition>\n</template>\n<script>\n    export default {\n        name: '',\n        props: {\n            value: {\n                type: Boolean,\n                default: false,\n            },\n        },\n        data () {\n            return {\n                styles: {},\n            };\n        },\n        watch: {\n            value: {\n                handler (value) {\n                    if (value) {\n                        this.styles = {\n                            'z-index': window.__bk_zIndex_manager.nextZIndex(), // eslint-disable-line no-underscore-dangle\n                        };\n                    }\n                },\n                immediate: true,\n            },\n        },\n        methods: {\n            handleClose () {\n                this.$emit('input', false);\n                this.$emit('change', false);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .host-sideslider-enter-active,\n    .host-sideslider-leave-active {\n        .container,\n        .box-mask {\n            opacity: 100%;\n            transition: all 0.3s ease;\n        }\n    }\n\n    .host-sideslider-enter,\n    .host-sideslider-leave-to {\n        .container {\n            opacity: 0%;\n            transform: translateY(-15px);\n        }\n    }\n\n    .sideslider-box {\n        position: fixed;\n        top: 0;\n        right: 0;\n        bottom: 0;\n        left: 0;\n        z-index: 2000;\n        display: flex;\n        overflow: hidden;\n        align-items: center;\n        justify-content: center;\n\n        .container {\n            position: relative;\n            z-index: 1;\n            display: flex;\n            width: 1240px;\n            height: 754px;\n            background: #fff;\n            flex-direction: column;\n        }\n\n        .box-header {\n            position: relative;\n            display: flex;\n            height: 42px;\n            padding-right: 58px;\n            border-bottom: 1px solid #dcdee5;\n            align-items: center;\n\n            .toggle-btn {\n                display: flex;\n                width: 32px;\n                height: 100%;\n                color: #fff;\n                cursor: pointer;\n                background: #3a84ff;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .btn-flag {\n                font-size: 30px;\n                transform: rotateZ(-90deg);\n            }\n        }\n\n        .box-title {\n            display: flex;\n            padding-left: 20px;\n            font-size: 14px;\n            color: #313238;\n            flex: 1;\n\n            .desc {\n                margin-left: auto;\n            }\n        }\n\n        .box-content {\n            height: calc(100% - 100px);\n        }\n\n        .box-footer {\n            display: flex;\n            height: 60px;\n            padding-right: 24px;\n            background: #fafbfd;\n            align-items: center;\n            justify-content: flex-end;\n        }\n\n        .box-mask {\n            position: absolute;\n            top: 0;\n            right: 0;\n            bottom: 0;\n            left: 0;\n            cursor: pointer;\n            background: rgb(0 0 0 / 60%);\n        }\n    }\n\n    .choose-ip-dialog {\n        .sideslider-box {\n            position: absolute;\n            top: 0;\n            right: 0;\n            left: 0;\n            z-index: 9;\n            display: flex;\n            justify-content: flex-end;\n            overflow: hidden;\n\n            &.hide {\n                height: 0;\n            }\n\n            .container {\n                height: 100%;\n            }\n\n            .host-content-enter-active,\n            .host-content-leave-active {\n                transition: all 0.3s ease;\n            }\n\n            .host-content-enter,\n            .host-content-leave-to {\n                transform: translateX(100%);\n            }\n        }\n\n        .host-sideslider-enter,\n        .host-sideslider-leave-to {\n            .container {\n                transform: translateX(100%);\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"server-panel-action-extend\" @click.stop=\"\" @mouseleave=\"handleHide\">\n        <Icon type=\"more\" />\n        <div\n            ref=\"popoverContent\"\n            class=\"server-action-extend-content\"\n            @click=\"handleWraperClick\"\n            @mouseover=\"handleShow\"\n            @mouseleave=\"handleClose\">\n            <template v-if=\"copyable\">\n                <div class=\"action-item\" @click=\"handleCopyAll\">{{ '复制全部IP' }}</div>\n                <div class=\"action-item\" @click=\"handleCopyFail\">{{ '复制异常IP' }}</div>\n            </template>\n            <slot />\n        </div>\n    </div>\n</template>\n<script>\n    import {\n        execCopy,\n    } from '@utils/assist';\n   \n    const instanceMap = {};\n\n    export default {\n        name: 'ChooseIpExtendAction',\n        props: {\n            list: {\n                type: Array,\n                default: () => [],\n            },\n            invalidList: {\n                type: Array,\n                default: () => [],\n            },\n            copyable: {\n                type: Boolean,\n                default: false,\n            },\n        },\n        created () {\n            this.id = `action_extend_${Math.random()}_${Math.random()}`;\n        },\n        mounted () {\n            this.init();\n        },\n        beforeDestroy () {\n            instanceMap[this.id].hide();\n            delete instanceMap[this.id];\n        },\n        methods: {\n            /**\n             * @desc 弹层面板初始化\n             */\n            init () {\n                instanceMap[this.id] = this.$bkPopover(this.$el, {\n                    theme: 'server-panel-action-extend-popover',\n                    interactive: true,\n                    placement: 'bottom',\n                    content: this.$refs.popoverContent,\n                    trigger: 'mouseover',\n                    arrow: true,\n                    onShow: () => {\n                        Object.keys(instanceMap).forEach((key) => {\n                            if (key !== this.id) {\n                                instanceMap[key].hide();\n                            }\n                        });\n                    },\n                });\n            },\n            /**\n             * @desc 隐藏弹层面板\n             */\n            handleWraperClick () {\n                this.handleClose();\n            },\n            /**\n             * @desc 鼠标操作隐藏弹层面板\n             */\n            handleHide () {\n                this.leaveTimer = setTimeout(() => {\n                    this.handleClose();\n                }, 3000);\n            },\n            /**\n             * @desc 复制所有主机\n             */\n            handleCopyAll () {\n                if (this.list.length < 1 && this.invalidList.length < 1) {\n                    this.messageWarn('你还未选择主机');\n                    return;\n                }\n                let allIP = this.list.map(host => host.ip);\n                const allInvalidList = this.invalidList.map(host => host.ip);\n                allIP = [\n                    ...allIP, ...allInvalidList,\n                ];\n                execCopy(allIP.join('\\n'), `${'复制成功'}（${allIP.length}${'个IP'}）`);\n            },\n            /**\n             * @desc 复制异常主机\n             */\n            handleCopyFail () {\n                if (this.list.length < 1 && this.invalidList.length < 1) {\n                    this.messageWarn('你还未选择主机');\n                    return;\n                }\n                let allFailIp = [];\n                this.list.forEach((currentHost) => {\n                    if (!currentHost.alive) {\n                        allFailIp.push(currentHost.ip);\n                    }\n                });\n                if (allFailIp.length < 1 && this.invalidList.length < 1) {\n                    this.messageWarn('暂无异常主机');\n                    return;\n                }\n                const allInvalidList = this.invalidList.map(host => host.ip);\n                allFailIp = [\n                    ...allFailIp, ...allInvalidList,\n                ];\n                execCopy(allFailIp.join('\\n'), `${'复制成功'}（${allFailIp.length}${'个异常IP'}）`);\n            },\n            handleShow () {\n                clearTimeout(this.leaveTimer);\n            },\n            handleClose () {\n                instanceMap[this.id] && instanceMap[this.id].hide();\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    html[lang=\"en-US\"] {\n        .server-action-extend-content {\n            width: 154px;\n        }\n    }\n\n    .server-panel-action-extend {\n        position: absolute;\n        top: 50%;\n        right: 16px;\n        z-index: 9;\n        display: flex;\n        width: 30px;\n        height: 30px;\n        font-size: 16px;\n        font-weight: normal;\n        color: #979ba5;\n        cursor: pointer;\n        border-radius: 50%;\n        transform: translateY(-50%);\n        user-select: none;\n        align-items: center;\n        justify-content: center;\n\n        &:hover,\n        &.tippy-active {\n            z-index: 10;\n            color: #3a84ff;\n            background: #dcdee5;\n        }\n    }\n\n    .server-panel-action-extend-popover-theme {\n        padding: 0 !important;\n\n        .tippy-arrow {\n            display: none;\n        }\n\n        .server-action-extend-content {\n            width: 93px;\n            font-size: 14px;\n            line-height: 32px;\n            color: #63656e;\n            background: #fff;\n            border: 1px solid #f0f1f5;\n            box-shadow: 0 2px 1px 0 rgb(185 203 222 / 50%);\n\n            .action-item {\n                padding-left: 15px;\n                cursor: pointer;\n\n                &:hover {\n                    color: #3a84ff;\n                    background: #e5efff;\n                }\n            }\n        }\n    }\n\n</style>\n","<template>\n    <div\n        class=\"jb-edit-input\"\n        :class=\"mode\"\n        :key=\"value\">\n        <template v-if=\"!isEditing\">\n            <div\n                class=\"render-value-box\"\n                @click.stop=\"handleBlockShowEdit\">\n                <div class=\"value-text\" v-bk-overflow-tips>\n                    <slot v-bind:value=\"newVal\">\n                        <span>{{ newVal || '--' }}</span>\n                    </slot>\n                </div>\n                <div class=\"edit-action-box\">\n                    <Icon\n                        v-if=\"!isBlock && !isSubmiting\"\n                        type=\"edit-2\"\n                        class=\"edit-action\"\n                        @click.self.stop=\"handleShowEdit\" />\n                    <Icon\n                        v-if=\"isSubmiting\"\n                        type=\"loading-circle\"\n                        class=\"edit-loading\" />\n                </div>\n            </div>\n        </template>\n        <template v-else>\n            <div class=\"edit-value-box\" :class=\"{ 'edit-error': !!error }\" @click.stop=\"\">\n                <bk-input\n                    ref=\"input\"\n                    :value=\"newVal\"\n                    @change=\"handleInputChange\"\n                    @blur=\"handleInputBlur\"\n                    @keyup=\"handleInputEnter\" />\n                <div v-if=\"error\" class=\"input-edit-info\" v-bk-tooltips.top=\"error\">\n                    <Icon type=\"info\" />\n                </div>\n            </div>\n        </template>\n    </div>\n</template>\n<script>\n   \n    export default {\n        name: 'JbEditInput',\n        props: {\n            /**\n             * @value block 块级交互\n             * @value ‘’ 默认鼠标点击编辑按钮\n             */\n            mode: {\n                type: String,\n                default: '',\n            },\n            /**\n             * @desc 编辑操作对应的字段名称\n             */\n            field: {\n                type: String,\n                required: true,\n            },\n            /**\n             * @desc 默认值\n             */\n            value: {\n                type: String,\n                default: '',\n            },\n            /**\n             * @desc 宽度\n             */\n            width: {\n                type: String,\n                default: 'auto',\n            },\n            remoteHander: {\n                type: Function,\n                default: () => Promise.resolve(),\n            },\n            /**\n             * @desc 值验证规则\n             */\n            rules: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                newVal: this.value,\n                error: '',\n                isEditing: false,\n                isSubmiting: false,\n            };\n        },\n        computed: {\n            styles () {\n                return {\n                    width: this.width,\n                };\n            },\n            isBlock () {\n                return this.mode === 'block';\n            },\n        },\n        watch: {\n            value (newVal) {\n                this.newVal = newVal;\n            },\n        },\n        mounted () {\n            this.isValidatoring = false;\n            document.body.addEventListener('click', this.handleHideEdit);\n            this.$once('hook:beforeDestroy', () => {\n                document.body.removeEventListener('click', this.handleHideEdit);\n            });\n        },\n        methods: {\n            /**\n             * @desc 值验证\n             */\n            doValidator () {\n                const checkValidator = (rule, value) => new Promise((resolve, reject) => {\n                    if (rule.required && !value) {\n                        reject(rule.message);\n                    }\n                    // 通过自定义方法来检测\n                    if (rule.validator && (typeof rule.validator === 'function')) {\n                        const result = rule.validator(value);\n                        if (result.then) {\n                            result.then((data) => {\n                                if (data) {\n                                    return resolve();\n                                }\n                                return reject(rule.message);\n                            }).catch(() => {\n                                reject(rule.message);\n                            });\n                        } else if (result) {\n                            return resolve();\n                        } else {\n                            return reject(rule.message);\n                        }\n                    } else {\n                        resolve();\n                    }\n                });\n                \n                const allPromise = this.rules.map(rule => checkValidator(rule, this.newVal));\n                this.isValidatoring = true;\n                return Promise.all(allPromise).finally(() => {\n                    this.isValidatoring = false;\n                });\n            },\n            /**\n             * @desc 提交编辑\n             */\n            triggerChange () {\n                this.doValidator()\n                    .then(() => {\n                        this.isEditing = false;\n                        if (this.newVal === this.value) {\n                            return;\n                        }\n                        this.isSubmiting = true;\n                        this.remoteHander({\n                            [this.field]: this.newVal,\n                        }).then(() => {\n                            this.$emit('on-change', {\n                                [this.field]: this.newVal,\n                            });\n                            this.messageSuccess('编辑成功');\n                        })\n                            .catch(() => {\n                                this.newVal = this.value;\n                            })\n                            .finally(() => {\n                                this.isSubmiting = false;\n                            });\n                    })\n                    .catch((error) => {\n                        this.error = error;\n                    });\n            },\n            handleBlockShowEdit () {\n                if (!this.isBlock) {\n                    return;\n                }\n                this.handleShowEdit();\n            },\n            /**\n             * @desc 显示input\n             */\n            handleShowEdit () {\n                document.body.click();\n                this.isEditing = true;\n                this.$nextTick(() => {\n                    this.$refs.input.focus();\n                });\n            },\n            /**\n             * @desc input 值更新\n             * @param {String} value 最新输入值\n             */\n            handleInputChange (value) {\n                this.newVal = value.trim();\n            },\n            /**\n             * @desc input 失去焦点开始提交\n             */\n            handleInputBlur () {\n                this.triggerChange();\n            },\n            /**\n             * @desc input enter 提交\n             * @param {String} value 最新输入值\n             * @param {Object} event dom 事件\n             */\n            handleInputEnter (value, event) {\n                if (!this.isEditing) return;\n                if (event.key === 'Enter' && event.keyCode === 13) {\n                    this.triggerChange();\n                }\n            },\n            /**\n             * @desc 隐藏 input 框\n             * @param {Object} event dom 事件\n             */\n            handleHideEdit (event) {\n                if (this.isValidatoring || this.error) {\n                    return;\n                }\n                if (event.path && event.path.length > 0) {\n                    // eslint-disable-next-line no-plusplus\n                    for (let i = 0; i < event.path.length; i++) {\n                        const target = event.path[i];\n                        if (target.className === 'jb-edit-input') {\n                            return;\n                        }\n                    }\n                }\n                this.isEditing = false;\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .jb-edit-input {\n        &.block {\n            position: relative;\n            margin-left: -10px;\n            cursor: pointer;\n\n            .render-value-box {\n                padding-left: 10px;\n\n                &:hover {\n                    background: #f0f1f5;\n                }\n            }\n\n            .edit-action-box {\n                position: absolute;\n                top: 0;\n                right: 10px;\n                width: 16px;\n            }\n        }\n\n        .render-value-box {\n            position: relative;\n            display: flex;\n            height: 30px;\n            min-width: 36px;\n            min-height: 28px;\n\n            &:hover {\n                .edit-action {\n                    opacity: 100%;\n                    transform: scale(1);\n                }\n            }\n        }\n\n        .value-text {\n            overflow: hidden;\n            line-height: 30px;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n        }\n\n        .edit-action-box {\n            display: flex;\n            align-items: center;\n            min-height: 1em;\n            margin-right: auto;\n            font-size: 16px;\n            color: #979ba5;\n\n            .edit-action {\n                padding: 6px 0 6px 2px;\n                cursor: pointer;\n                opacity: 0%;\n                transform: scale(0);\n                transition: 0.15s;\n                transform-origin: left center;\n\n                &:hover {\n                    color: #3a84ff;\n                }\n            }\n\n            .edit-loading {\n                position: absolute;\n                top: 9px;\n                margin-left: 2px;\n                animation: rotate-loading 1s linear infinite;\n            }\n        }\n\n        .edit-value-box {\n            position: relative;\n            width: 100%;\n            font-size: 0;\n\n            &.edit-error {\n                .bk-form-input {\n                    border-color: #ea3636 !important;\n                }\n            }\n\n            .input-edit-info {\n                position: absolute;\n                top: 0;\n                right: 0;\n                bottom: 0;\n                z-index: 1;\n                display: flex;\n                align-items: center;\n                padding: 0 10px;\n                font-size: 16px;\n                color: #ea3636;\n            }\n\n            .bk-form-input {\n                height: 30px;\n            }\n        }\n    }\n</style>\n","<template>\n    <div ref=\"layout\" :class=\"classes\">\n        <slot />\n    </div>\n</template>\n<script>\n    export default {\n        name: 'GlobalVariableLayout',\n\n        props: {\n            type: {\n                type: String,\n                default: 'horizontal', // 水平：horizontal；垂直：vertical\n            },\n        },\n        computed: {\n            classes () {\n                const classes = {\n                    'global-variable-layout': true,\n                };\n                if (this.type !== 'horizontal') {\n                    classes.vertical = true;\n                }\n                return classes;\n            },\n        },\n        updated () {\n            const childrenNum = this.$slots.default;\n            if (this.childrenNum !== childrenNum) {\n                this.childrenNum = childrenNum;\n                this.init();\n            }\n        },\n        mounted  () {\n            if (this.type === 'horizontal') {\n                this.init();\n            }\n        },\n        methods: {\n            init () {\n                const isShowLayout = this.$refs.layout.getBoundingClientRect().width > 0;\n                if (!isShowLayout) {\n                    return;\n                }\n                const $formEle = this.$refs.layout;\n                let max = 0;\n                const $labelEleList = $formEle.querySelectorAll('.variable-name');\n                $labelEleList.forEach((item) => {\n                    const { width } = item.querySelector('span').getBoundingClientRect();\n                    max = Math.max(max, width);\n                });\n                $labelEleList.forEach((item) => {\n                    item.style.width = `${max}px`;\n                });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .global-variable-layout {\n        display: flex;\n        flex-direction: column;\n\n        &.vertical {\n            .global-variable-edit-box {\n                flex-direction: column;\n            }\n\n            .variable-name {\n                text-align: left;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"mult-input\">\n        <div\n            ref=\"input\"\n            class=\"input-text-area\"\n            contenteditable=\"true\"\n            :style=\"stylees\"\n            @input=\"handleInput\"\n            @focus=\"handleFocus\"\n            @blur=\"handleBlur\"\n            @paste=\"handlePaste\" />\n        <div v-if=\"showPlaceholder\" class=\"mult-input-placeholder\" @click=\"handleInputFocus\">{{ placeholder }}</div>\n    </div>\n</template>\n<script>\n    export default {\n        name: '',\n        props: {\n            value: {\n                type: String,\n                default: '',\n            },\n            placeholder: String,\n        },\n        data () {\n            return {\n                localValue: this.value,\n                focused: false,\n            };\n        },\n        computed: {\n            stylees () {\n                const styles = {};\n                if (this.focused) {\n                    styles['z-index'] = 9999;\n                } else {\n                    styles.height = '30px';\n                    styles.overflow = 'hidden';\n                    styles['white-space'] = 'pre';\n                    styles['text-overflow'] = 'ellipsis';\n                }\n                return styles;\n            },\n            showPlaceholder () {\n                if (this.focused) {\n                    return false;\n                }\n                return !this.localValue;\n            },\n        },\n        methods: {\n            handleInputFocus () {\n                this.$refs.input.focus();\n                setTimeout(() => {\n                    this.$refs.input.selectionStart = this.localValue.length;\n                    this.$refs.input.selectionEnd = this.localValue.length;\n                });\n            },\n            handleInput (event) {\n                const value = event.target.outerText;\n                this.localValue = value;\n                this.$emit('input', value);\n                this.$emit('change', value);\n            },\n            handleFocus () {\n                this.focused = true;\n            },\n            handleBlur () {\n                this.focused = false;\n                this.$refs.input.scrollTop = 0;\n            },\n            handlePaste (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                let text = '';\n                const event = (e.originalEvent || e);\n                if (event.clipboardData && event.clipboardData.getData) {\n                    text = event.clipboardData.getData('text/plain');\n                } else if (window.clipboardData && window.clipboardData.getData) {\n                    text = window.clipboardData.getData('Text');\n                }\n                if (document.queryCommandSupported('insertText')) {\n                    document.execCommand('insertText', false, text);\n                } else {\n                    document.execCommand('paste', false, text);\n                }\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .mult-input {\n        position: relative;\n        height: 30px;\n        padding: 0 10px;\n        font-size: 12px;\n        line-height: 1.5;\n        word-break: break-all;\n        cursor: pointer;\n        background: #fff;\n\n        .input-text-area {\n            position: absolute;\n            top: 0;\n            right: 0;\n            left: 0;\n            max-height: 300px;\n            min-height: 32px;\n            padding: 6px 10px;\n            overflow-y: scroll;\n            font-size: 12px;\n            color: #63656e;\n            background: inherit;\n            border: 1px solid #c4c6cc;\n            border-radius: 2px;\n            outline: none;\n        }\n\n        .mult-input-placeholder {\n            position: absolute;\n            top: 1px;\n            right: 1px;\n            bottom: 1px;\n            left: 1px;\n            padding: 6px 10px;\n            color: #c4c6cc;\n            background: inherit;\n        }\n    }\n</style>\n","<template>\n    <div class=\"choose-ip-host-table\" :class=\"{ empty: isEmpty }\">\n        <scroll-faker :style=\"styles\">\n            <table>\n                <template v-if=\"!$slots.default\">\n                    <thead>\n                        <th style=\"width: 20%;\">{{ '主机IP' }}</th>\n                        <th style=\"width: 20%;\">{{ '云区域' }}</th>\n                        <th style=\"width: 150px;\">{{ 'Agent 状态' }}</th>\n                        <th>{{ '主机名' }}</th>\n                        <th>{{ '操作系统名称' }}</th>\n                        <th v-if=\"editable\" class=\"action-column\">{{ '操作' }}</th>\n                    </thead>\n                    <slot name=\"appendBefore\" />\n                    <tbody v-if=\"renderList.length > 0\" class=\"valid-list\">\n                        <tr v-for=\"(row) in renderList\" :key=\"row.realId\" :class=\"diff[row.realId]\">\n                            <td class=\"table-cell\">\n                                <span\n                                    v-if=\"row.repeat\"\n                                    class=\"repeat\"\n                                    :tippy-tips=\"'指和其他主机的IP地址相同，但云区域不同'\">\n                                    {{ '重复' }}\n                                </span>\n                                <div class=\"cell-text\">{{ row.ip }}</div>\n                            </td>\n                            <td>\n                                <div class=\"cell-text\">{{ row.cloudAreaInfo.name || '--' }}</div>\n                            </td>\n                            <td>\n                                <span v-if=\"row.alive\">\n                                    <icon svg type=\"normal\" style=\"vertical-align: middle;\" />\n                                    <span style=\"vertical-align: middle;\">{{ '正常' }}</span>\n                                </span>\n                                <span v-else>\n                                    <icon svg type=\"abnormal\" style=\"vertical-align: middle;\" />\n                                    <span style=\"vertical-align: middle;\">{{ '异常' }}</span>\n                                </span>\n                            </td>\n                            <td>\n                                <div class=\"cell-text\">{{ row.ipDesc || '--' }}</div>\n                            </td>\n                            <td>\n                                <div class=\"cell-text\">{{ row.os || '--' }}</div>\n                            </td>\n                            <td v-if=\"editable\" class=\"action-column\">\n                                <bk-button text @click=\"handleRemove(row.realId)\">{{ '移除' }}</bk-button>\n                            </td>\n                        </tr>\n                    </tbody>\n                </template>\n                <template v-else>\n                    <slot name=\"appendBefore\" />\n                    <slot />\n                </template>\n            </table>\n            <div\n                v-if=\"isShowMorePage\"\n                class=\"list-more\"\n                @click=\"handlePage\">\n                {{ '查看更多' }}\n            </div>\n        </scroll-faker>\n        <empty v-if=\"isEmpty\" :type=\"emptyType\" />\n    </div>\n</template>\n<script>\n    import Empty from '@components/empty';\n\n    export default {\n        name: '',\n        components: {\n            Empty,\n        },\n        props: {\n            list: {\n                type: Array,\n                required: true,\n            },\n            editable: {\n                type: Boolean,\n                default: false,\n            },\n            maxHeight: {\n                type: Number,\n                default: -1,\n            },\n            appendNums: {\n                type: Number,\n                default: 0,\n            },\n            diff: {\n                type: Object,\n                default: () => ({}),\n            },\n            isSearch: {\n                type: Boolean,\n                default: false,\n            },\n        },\n        data () {\n            return {\n                page: 1,\n                offset: 30,\n            };\n        },\n        computed: {\n            styles () {\n                const style = {\n                    width: '100%',\n                };\n                if (this.list.length + this.appendNums > 10 && this.maxHeight > 0) {\n                    style.height = '410px';\n                }\n                return style;\n            },\n            renderList () {\n                return Object.freeze(this.list.slice(0, this.page * this.offset));\n            },\n            isShowMorePage () {\n                return this.renderList.length < this.list.length;\n            },\n            isEmpty () {\n                return this.list.length < 1 && !this.$slots.appendBefore;\n            },\n            emptyType () {\n                if (this.isSearch) {\n                    return 'search';\n                }\n                return '';\n            },\n        },\n        methods: {\n            handleRemove (id) {\n                this.$emit('on-change', id);\n            },\n            handlePage () {\n                this.page += 1;\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .choose-ip-host-table {\n        &.empty {\n            display: flex;\n            align-items: center;\n            flex-direction: column;\n            min-height: 300px;\n\n            .job-empty {\n                margin-top: 90px;\n            }\n        }\n\n        table {\n            width: 100%;\n            color: #63656e;\n            table-layout: fixed;\n\n            .valid-list {\n                tr:last-child {\n                    td {\n                        border: none;\n                    }\n                }\n            }\n\n            th,\n            td {\n                height: 41px;\n                padding: 0 10px;\n                font-size: 12px;\n                font-weight: normal;\n                line-height: 20px;\n                text-align: left;\n                border-bottom: 1px solid #e7e8ed;\n\n                &:first-child {\n                    padding-left: 60px;\n                }\n            }\n\n            th {\n                color: #313238;\n                white-space: nowrap;\n                background: #f5f6fa;\n            }\n\n            td {\n                word-break: break-all;\n            }\n\n            .table-cell {\n                position: relative;\n\n                .repeat,\n                .invalid {\n                    position: absolute;\n                    top: 10px;\n                    height: 18px;\n                    padding: 0 5px;\n                    margin-left: -6px;\n                    font-size: 12px;\n                    line-height: 18px;\n                    text-align: center;\n                    border-radius: 2px;\n                    transform: translateX(-100%);\n                }\n\n                .repeat {\n                    color: #fff;\n                    background: #fe9c00;\n                }\n\n                .invalid {\n                    color: #979ba5;\n                    background: #f0f1f5;\n                }\n            }\n\n            .cell-text {\n                /* stylelint-disable value-no-vendor-prefix */\n                display: -webkit-box;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                word-break: break-all;\n                white-space: normal;\n                -webkit-box-orient: vertical;\n                -webkit-line-clamp: 2;\n            }\n        }\n\n        .bk-button-text {\n            font-size: 12px;\n        }\n\n        .action-column {\n            width: 90px;\n            padding-right: 20px;\n            text-align: right;\n        }\n\n        .loading-status {\n            font-size: 16px;\n            color: #3a84ff;\n            vertical-align: middle;\n            animation: rotate-loading 1s linear infinite;\n        }\n\n        .list-more {\n            height: 40px;\n            font-size: 12px;\n            line-height: 40px;\n            color: #63656e;\n            text-align: center;\n            cursor: pointer;\n            border-top: 1px solid #e7e8ed;\n        }\n    }\n</style>\n","<template>\n    <div class=\"server-panel-dropdown-menu\" @click.stop=\"\" @mouseleave=\"handleHide\">\n        <slot />\n        <div class=\"server-dropdown-menu-content\" ref=\"popoverContent\" @mouseover=\"handleShow\" @mouseleave=\"handleClose\">\n            <slot name=\"menu\" />\n        </div>\n    </div>\n</template>\n<script>\n    const instanceMap = {};\n\n    export default {\n        name: 'JbPopoverConfirm',\n        created () {\n            this.id = `dropdown_menu_${Math.random()}_${Math.random()}`;\n        },\n        mounted () {\n            this.init();\n        },\n        beforeDestroy () {\n            instanceMap[this.id].hide();\n            delete instanceMap[this.id];\n        },\n        methods: {\n            init () {\n                instanceMap[this.id] = this.$bkPopover(this.$el, {\n                    theme: 'server-panel-dropdown-menu-popover',\n                    interactive: true,\n                    placement: 'bottom-start',\n                    content: this.$refs.popoverContent,\n                    trigger: 'mouseover',\n                    arrow: true,\n                    onShow: () => {\n                        Object.keys(instanceMap).forEach((key) => {\n                            if (key !== this.id) {\n                                instanceMap[key].hide();\n                            }\n                        });\n                    },\n                });\n            },\n            handleHide () {\n                this.leaveTimer = setTimeout(() => {\n                    instanceMap[this.id].hide();\n                }, 2000);\n            },\n            handleShow () {\n                clearTimeout(this.leaveTimer);\n            },\n            handleClose () {\n                instanceMap[this.id].hide();\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .server-panel-dropdown-menu {\n        display: inline-flex;\n        align-items: center;\n        font-size: 20px;\n        cursor: pointer;\n    }\n\n    .server-panel-dropdown-menu-popover-theme {\n        padding: 0 !important;\n\n        .tippy-arrow {\n            display: none;\n        }\n\n        .server-dropdown-menu-content {\n            width: 93px;\n            padding: 10px 0;\n            font-size: 14px;\n            line-height: 32px;\n            color: #63656e;\n            text-align: center;\n            background: #fff;\n            border: 1px solid #f0f1f5;\n            box-shadow: 0 1px 1px 0 rgb(185 203 222 / 50%);\n\n            .dropdown-menu-item {\n                cursor: pointer;\n\n                &:hover,\n                &.active {\n                    color: #3a84ff;\n                    background: #e5efff;\n                }\n            }\n        }\n    }\n\n</style>\n","<template>\n    <div class=\"choose-ip-business-topology\">\n        <div class=\"topology-data\" v-bkloading=\"{ isLoading: topologyLoading }\">\n            <div class=\"topology-node-search\">\n                <bk-input\n                    :placeholder=\"'搜索拓扑节点'\"\n                    right-icon=\"bk-icon icon-search\"\n                    @input=\"handleNodeSearch\" />\n            </div>\n            <div class=\"topology-node-tree\">\n                <scroll-faker>\n                    <div class=\"wraper\">\n                        <bk-big-tree\n                            ref=\"tree\"\n                            show-link-line\n                            selectable\n                            :expand-on-click=\"false\"\n                            @select-change=\"handleNodeChange\">\n                            <div class=\"node-box\" slot-scope=\"{ node, data }\">\n                                <div class=\"node-name\">{{ node.name }}</div>\n                                <div\n                                    v-if=\"node.level === 0\"\n                                    class=\"node-filter\"\n                                    @click=\"handleFilterEmptyToggle\">\n                                    <template v-if=\"isRenderEmptyTopoNode\">\n                                        <Icon type=\"eye-slash-shape\" />\n                                        <span>{{ '隐藏空节点' }}</span>\n                                    </template>\n                                    <template v-else>\n                                        <Icon type=\"eye-shape\" />\n                                        <span>{{ '恢复完整拓扑' }}</span>\n                                    </template>\n                                </div>\n                                <div class=\"node-count\">{{ data.payload.count }}</div>\n                            </div>\n                        </bk-big-tree>\n                    </div>\n                </scroll-faker>\n            </div>\n            <empty v-if=\"isNodeEmpty\" class=\"topology-empty\" />\n        </div>\n        <div class=\"host-list\">\n            <mult-input\n                :placeholder=\"'输入 主机 IP / 主机名 / 操作系统 / 云区域 进行搜索...'\"\n                class=\"host-search\"\n                @input=\"handleHostSearch\" />\n            <host-table\n                :list=\"renderList\"\n                :is-search=\"isSearch\"\n                v-bkloading=\"{ isLoading }\">\n                <thead>\n                    <tr>\n                        <th style=\"width: 10.2%;\">\n                            <bk-checkbox\n                                :value=\"isCheckedAll\"\n                                @click.native=\"handleToggleWholeAll\" />\n                        </th>\n                        <th style=\"width: 18.9%;\">{{ '主机IP' }}</th>\n                        <th style=\"width: 12.8%;\">{{ '云区域' }}</th>\n                        <th style=\"width: 13.4%;\">\n                            <div\n                                class=\"head-cell\"\n                                :class=\"{\n                                    'is-filtered': agentFilter !== '',\n                                }\">\n                                <span>{{ 'Agent 状态' }}</span>\n                                <dropdown-menu>\n                                    <Icon type=\"filter-fill\" class=\"filer-flag\" />\n                                    <div slot=\"menu\">\n                                        <div\n                                            class=\"dropdown-menu-item\"\n                                            :class=\"{ active: agentFilter === '' }\"\n                                            @click=\"handleAgentFiler('')\">\n                                            {{ '全部' }}\n                                        </div>\n                                        <div\n                                            class=\"dropdown-menu-item\"\n                                            :class=\"{ active: agentFilter === 0 }\"\n                                            @click=\"handleAgentFiler(0)\">\n                                            {{ '异常' }}\n                                        </div>\n                                        <div\n                                            class=\"dropdown-menu-item\"\n                                            :class=\"{ active: agentFilter === 1 }\"\n                                            @click=\"handleAgentFiler(1)\">\n                                            {{ '正常' }}\n                                        </div>\n                                    </div>\n                                </dropdown-menu>\n                            </div>\n                        </th>\n                        <th>{{ '主机名' }}</th>\n                        <th style=\"width: 14.7%;\">{{ '操作系统名称' }}</th>\n                    </tr>\n                </thead>\n                <tbody v-if=\"renderList.length > 0\">\n                    <template v-for=\"(row, index) in renderList\">\n                        <tr\n                            class=\"host-row\"\n                            :key=\"`${row.realId}_${index}`\"\n                            @click=\"handleHostCheck(row)\">\n                            <td>\n                                <bk-checkbox :checked=\"!!checkedMap[row.realId]\" />\n                            </td>\n                            <td>\n                                <div class=\"cell-text\">{{ row.displayIp }}</div>\n                            </td>\n                            <td>\n                                <div class=\"cell-text\">{{ row.cloudAreaInfo.name || '--' }}</div>\n                            </td>\n                            <td>\n                                <span v-if=\"row.alive\">\n                                    <icon svg type=\"normal\" style=\"vertical-align: middle;\" />\n                                    <span style=\"vertical-align: middle;\">{{ '正常' }}</span>\n                                </span>\n                                <span v-else>\n                                    <icon svg type=\"abnormal\" style=\"vertical-align: middle;\" />\n                                    <span style=\"vertical-align: middle;\">{{ '异常' }}</span>\n                                </span>\n                            </td>\n                            <td>\n                                <div class=\"cell-text\">{{ row.ipDesc || '--' }}</div>\n                            </td>\n                            <td>\n                                <div class=\"cell-text\">{{ row.os || '--' }}</div>\n                            </td>\n                        </tr>\n                    </template>\n                </tbody>\n            </host-table>\n            <div v-if=\"pagination.pageSize > 0\" style=\"padding: 16px 0;\">\n                <bk-pagination\n                    align=\"right\"\n                    show-total-count\n                    :show-limit=\"false\"\n                    :count=\"pagination.total\"\n                    :limit=\"pagination.pageSize\"\n                    :current.sync=\"pagination.page\"\n                    :limit-list=\"[pagination.pageSize]\"\n                    @change=\"handlePageChange\"\n                    small />\n            </div>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import AppManageService from '@service/app-manage';\n    import UserService from '@service/user';\n    import { topoNodeCache } from '@utils/cache-helper';\n    import Empty from '@components/empty';\n    import {\n        generateHostRealId,\n        parseIdInfo,\n        filterTopology,\n    } from './utils';\n    import MultInput from './mult-input';\n    import HostTable from './host-table';\n    import DropdownMenu from './dropdown-menu';\n\n    const ROOT_NODE_ID = `#${window.PROJECT_CONFIG.SCOPE_TYPE}#${window.PROJECT_CONFIG.SCOPE_ID}`;\n\n    export default {\n        name: '',\n        components: {\n            Empty,\n            MultInput,\n            HostTable,\n            DropdownMenu,\n        },\n        inheritAttrs: false,\n        props: {\n            topologyNodeTree: {\n                type: Array,\n                default: () => [],\n            },\n            topologyLoading: {\n                type: Boolean,\n                default: true,\n            },\n            ipList: {\n                type: Array,\n                default: () => [],\n            },\n            dialogHeight: {\n                type: Number,\n                required: true,\n            },\n        },\n        data () {\n            this.selfChange = false;\n            return {\n                isLoading: true,\n                isNodeEmpty: false,\n                // 展示空的拓扑节点\n                isRenderEmptyTopoNode: false,\n                // 登录用户\n                currentUser: {},\n                selectedNodeId: ROOT_NODE_ID,\n                renderList: [{},{},{}],\n                checkedMap: {},\n                isCheckedAll: false,\n                searchContent: '',\n                agentFilter: '',\n                pagination: {\n                    total: 0,\n                    page: 1,\n                    pageSize: 0,\n                },\n            };\n        },\n        computed: {\n            /**\n             * @desc 表格的全选状态\n             */\n            pageCheckInfo () {\n                const info = {\n                    indeterminate: false,\n                    checked: false,\n                };\n                const checkedNums = Object.keys(this.checkedMap).length;\n                info.indeterminate = checkedNums > 0;\n                info.checked = checkedNums > 0 && checkedNums >= this.pagination.total;\n                \n                return info;\n            },\n            isSearch () {\n                return [\n                    0, 1,\n                ].includes(this.agentFilter) || !!this.searchContent;\n            },\n        },\n        watch: {\n            /**\n             * @desc 选中的主机更新\n             */\n            ipList: {\n                handler (ipList) {\n                    if (this.selfChange) {\n                        this.selfChange = false;\n                        return;\n                    }\n                    const checkedMap = {};\n                    ipList.forEach((host) => {\n                        checkedMap[host.realId] = host;\n                    });\n                    this.pagination.page = 1;\n                    this.checkedMap = Object.freeze(checkedMap);\n                },\n                immediate: true,\n            },\n            topologyLoading (topologyLoading) {\n                if (!topologyLoading) {\n                    this.resetTopoTree();\n                }\n            },\n        },\n        created () {\n            this.fetchUserInfo();\n        },\n        mounted () {\n            this.calcPageSize();\n            // 根节点 ID 默认已知，主动拉取节点下面的主机\n            this.fetchTopologyHost();\n        },\n        methods: {\n            /**\n             * @desc 获取登陆用户信息\n             */\n            fetchUserInfo () {\n                UserService.fetchUserInfo()\n                    .then((data) => {\n                        this.currentUser = Object.freeze(data);\n                        this.isRenderEmptyTopoNode = topoNodeCache.getItem(data.username);\n                    });\n            },\n            /**\n             * @desc 获取拓扑节点下的主机列表\n             */\n            fetchTopologyHost: _.throttle(function () {\n                if (!this.selectedNodeId) {\n                    return;\n                }\n                const [objectId, instanceId] = parseIdInfo(this.selectedNodeId);\n                const { page, pageSize } = this.pagination;\n                this.isLoading = true;\n                AppManageService.fetchTopologyHost({\n                    appTopoNodeList: [{\n                        objectId,\n                        instanceId,\n                    },\n                    ],\n                    agentStatus: this.agentFilter,\n                    searchContent: this.searchContent,\n                    pageSize,\n                    start: (page - 1) * pageSize,\n                }).then((data) => {\n                    this.renderList = Object.freeze(data.data.map(host => Object.assign({\n                        realId: generateHostRealId(host),\n                    }, host)));\n                    this.pagination.total = data.total;\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            }, 300),\n            /**\n             * @desc 权限时获取拓扑节点下的所有主机\n             * @param {Boolean} check 列表全选状态\n             */\n            fetchTopologyHostWhole: _.throttle(function (check) {\n                if (!this.selectedNodeId) {\n                    return;\n                }\n                const [\n                    objectId,\n                    instanceId,\n                ] = parseIdInfo(this.selectedNodeId);\n                const checkedMap = {\n                    ...this.checkedMap,\n                };\n                this.isLoading = true;\n                AppManageService.fetchTopogyIPs({\n                    appTopoNodeList: [{\n                        objectId,\n                        instanceId,\n                    },\n                    ],\n                    agentStatus: this.agentFilter,\n                    searchContent: this.searchContent,\n                }).then((data) => {\n                    const list = data.data;\n                    list.forEach((realId) => {\n                        const [\n                            cloudAreaId,\n                            ip,\n                        ] = realId.split(':');\n                        if (check) {\n                            checkedMap[realId] = {\n                                ip,\n                                cloudAreaInfo: {\n                                    id: cloudAreaId,\n                                },\n                                realId,\n                            };\n                        } else {\n                            delete checkedMap[realId];\n                        }\n                    });\n                    this.checkedMap = Object.freeze(checkedMap);\n                    this.triggerChange();\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            }, 300),\n            /**\n             * @desc 初始化拓扑树\n             * @param {Array} expandIds 需要展开的节点\n             * @param {Boolean} emitEvent 选中节点时触发选中事件\n             */\n            resetTopoTree (expandIds, emitEvent = false) {\n                const topologyNodeTree = filterTopology(this.topologyNodeTree, this.isRenderEmptyTopoNode);\n                const expandIdArr = expandIds && expandIds.length > 0 ? expandIds : [this.selectedNodeId];\n                this.$refs.tree.setData(topologyNodeTree);\n                this.$nextTick(() => {\n                    if (topologyNodeTree.length < 1) {\n                        return;\n                    }\n                    this.$refs.tree.setSelected(this.selectedNodeId, {\n                        emitEvent,\n                    });\n                    expandIdArr.forEach((nodeId) => {\n                        this.$refs.tree.setExpanded(nodeId);\n                    });\n                });\n            },\n            /**\n             * @desc 计算PageSize\n             */\n            calcPageSize () {\n                const topOffset = 154;\n                const bottomOffset = 116;\n                const pageSize = Math.floor((this.dialogHeight - topOffset - bottomOffset) / 41);\n                this.pagination.pageSize = pageSize;\n            },\n            /**\n             * @desc 更新静态ip值\n             */\n            triggerChange () {\n                this.selfChange = true;\n                this.$emit('on-change', 'ipList', Object.values(this.checkedMap));\n            },\n            /**\n             * @desc 切换拓扑树中主机为空的节点\n             *\n             * 缓存状态，切换过程中保持节点的展开状态\n             */\n            handleFilterEmptyToggle (event) {\n                this.isRenderEmptyTopoNode = !this.isRenderEmptyTopoNode;\n                const selectNode = this.$refs.tree.getNodeById(this.selectedNodeId);\n                if (this.isRenderEmptyTopoNode) {\n                    // 显示所有节点，节点的选中状态不变\n                    event.stopPropagation();\n                    topoNodeCache.clearItem();\n                } else {\n                    // 隐藏空节点时，如果已选的节点将被隐藏自动切换为选中根节点\n                    if (selectNode.data.payload.count < 1) {\n                        this.selectedNodeId = ROOT_NODE_ID;\n                    } else {\n                        event.stopPropagation();\n                    }\n                    topoNodeCache.setItem(this.currentUser.username);\n                }\n                // 更新节点树时保留树中节点的展开状态\n                const expandIdArr = this.$refs.tree.nodes.reduce((result, node) => {\n                    if (node.expanded) {\n                        result.push(node.id);\n                    }\n                    return result;\n                }, []);\n                \n                this.resetTopoTree(expandIdArr, true);\n            },\n            /**\n             * @desc 搜索拓扑节点\n             * @param {String} value 筛选字符\n             */\n            handleNodeSearch: _.debounce(function (value) {\n                const data = this.$refs.tree.filter(value);\n                if (data.length > 0) {\n                    this.$nextTick(() => {\n                        this.$refs.tree.setSelected(data[0].id, {\n                            emitEvent: true,\n                        });\n                    });\n                }\n                this.isNodeEmpty = data.length < 1;\n            }, 300),\n            /**\n             * @desc 拓扑节点改变\n             * @param {Object} node 最新选中的拓扑节点\n             *\n             * 节点切换时重新拉取主机列表\n             */\n            handleNodeChange (node) {\n                this.selectedNodeId = node.id;\n                this.pagination.page = 1;\n                if (!node.expanded) {\n                    this.$refs.tree.setExpanded(this.selectedNodeId, {\n                        expanded: true,\n                    });\n                }\n                this.fetchTopologyHost();\n            },\n            /**\n             * @desc 搜索主机\n             * @param {String} str 筛选字符\n             */\n            handleHostSearch: _.debounce(function (str) {\n                const value = _.trim(str);\n                \n                // 前后两次搜索内容相同直接返回\n                if (this.searchContent === value) {\n                    return;\n                }\n                \n                // 搜索框内容为空格换行等空白符直接用空字符串搜索\n                const realValue = value.replace(/\\s/g, '');\n                this.searchContent = realValue ? value : '';\n                \n                this.pagination.page = 1;\n                this.fetchTopologyHost();\n            }, 300),\n            /**\n             * @desc Agent状态筛选\n             * @param {String} type 筛选字符\n             */\n            handleAgentFiler (type) {\n                this.pagination.page = 1;\n                this.agentFilter = type;\n                this.fetchTopologyHost();\n            },\n            /**\n             * @desc 全选节点下的所有主机\n             */\n            handleToggleWholeAll () {\n                this.isCheckedAll = !this.isCheckedAll;\n                this.fetchTopologyHostWhole(this.isCheckedAll);\n            },\n            /**\n             * @desc 选择单台主机\n             * @param {Object} host 主机信息\n             */\n            handleHostCheck (host) {\n                const checkedMap = Object.assign({}, this.checkedMap);\n                if (checkedMap[host.realId]) {\n                    delete checkedMap[host.realId];\n                } else {\n                    checkedMap[host.realId] = {\n                        ip: host.ip,\n                        cloudAreaInfo: {\n                            id: host.cloudAreaInfo.id,\n                        },\n                        realId: host.realId,\n                    };\n                }\n                this.checkedMap = Object.freeze(checkedMap);\n                this.triggerChange();\n            },\n            /**\n             * @desc 切换分页\n             * @param {Number} page 页码\n             */\n            handlePageChange (page) {\n                this.pagination.page = page;\n                this.fetchTopologyHost();\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .choose-ip-business-topology {\n        display: flex;\n        height: 100%;\n        padding-top: 20px;\n\n        .topology-data {\n            position: relative;\n            height: 100%;\n            overflow: hidden;\n            border-right: 1px solid #dcdee5;\n            flex: 0 0 33%;\n\n            .topology-node-search {\n                position: relative;\n                z-index: 1;\n                padding: 0 24px 20px;\n            }\n\n            .topology-node-tree {\n                height: calc(100% - 72px);\n\n                .wraper {\n                    padding-right: 24px;\n                    margin-left: 24px;\n                }\n\n                .bk-big-tree {\n                    overflow: unset;\n\n                    .bk-big-tree-node .node-content {\n                        overflow: unset;\n                    }\n\n                    .node-name {\n                        overflow: hidden;\n                        text-overflow: ellipsis;\n                        white-space: nowrap;\n                        flex: 0 1 auto;\n                    }\n                }\n            }\n\n            .topology-empty {\n                position: absolute;\n                top: 0;\n                right: 0;\n                bottom: 0;\n                left: 0;\n            }\n        }\n\n        .host-list {\n            flex: 2;\n            padding: 0 24px;\n\n            table {\n                th,\n                td {\n                    &:first-child {\n                        padding-left: 15px;\n                    }\n                }\n            }\n\n            .head-cell {\n                &.is-filtered {\n                    .filer-flag {\n                        color: #63656e;\n                    }\n                }\n            }\n\n            .host-search {\n                margin-bottom: 20px;\n            }\n\n            .check-flag {\n                font-size: 20px;\n                color: #63656e;\n            }\n\n            .filer-flag {\n                font-size: 12px;\n                color: #c4c6cc;\n            }\n\n            .host-row {\n                cursor: pointer;\n            }\n        }\n    }\n</style>\n","<template>\n    <div\n        class=\"choose-ip-dinamic-business-topology\"\n        v-bkloading=\"{\n            isLoading: topologyLoading,\n        }\">\n        <div class=\"node-search\">\n            <bk-input\n                :placeholder=\"'搜索拓扑节点'\"\n                right-icon=\"bk-icon icon-search\"\n                @input=\"handleSearch\" />\n        </div>\n        <empty v-if=\"emptyTopologyOfAllBusiness\" />\n        <template v-else>\n            <empty v-show=\"isSearchEmpty\" class=\"topology-empty\" />\n            <div class=\"topology-node-tree\">\n                <scroll-faker>\n                    <bk-big-tree\n                        ref=\"tree\"\n                        show-link-line\n                        show-checkbox\n                        :expand-on-click=\"false\"\n                        @check-change=\"handleCheckChange\">\n                        <div class=\"node-box\" slot-scope=\"{ node: nodeItem, data }\">\n                            <div class=\"node-name\">{{ data.name }}</div>\n                            <div\n                                v-if=\"nodeItem.level === 0\"\n                                class=\"node-filter\"\n                                @click=\"handleFilterEmptyToggle\">\n                                <template v-if=\"isRenderEmptyTopoNode\">\n                                    <Icon type=\"eye-slash-shape\" />\n                                    <span>{{ '隐藏空节点' }}</span>\n                                </template>\n                                <template v-else>\n                                    <Icon type=\"eye-shape\" />\n                                    <span>{{ '恢复完整拓扑' }}</span>\n                                </template>\n                            </div>\n                            <div class=\"node-count\">{{ data.payload.count }}</div>\n                        </div>\n                    </bk-big-tree>\n                </scroll-faker>\n            </div>\n            \n        </template>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import UserService from '@service/user';\n    import { topoNodeCache } from '@utils/cache-helper';\n    import Empty from '@components/empty';\n    import {\n        findAllChildNodeId,\n        resetTree,\n        parseIdInfo,\n        filterTopology,\n    } from './utils';\n\n    export default {\n        name: '',\n        components: {\n            Empty,\n        },\n        inheritAttrs: false,\n        props: {\n            topologyNodeTree: {\n                type: Array,\n                default: () => [],\n            },\n            topologyLoading: {\n                type: Boolean,\n                default: true,\n            },\n            topoNodeList: {\n                type: Array,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                currentUser: {},\n                isRenderEmptyTopoNode: false,\n                isSearchEmpty: false,\n                // 业务集下没有动态拓扑\n                emptyTopologyOfAllBusiness: window.PROJECT_CONFIG.SCOPE_TYPE === 'biz_set',\n            };\n        },\n        watch: {\n            /**\n             * @desc 更新 topo 树节点的选中状态\n             */\n            topoNodeList (newTopoNodeList, oldTopoNodeList) {\n                if (this.isSelfChange) {\n                    this.isSelfChange = false;\n                    return;\n                }\n                // 没有选中的节点时重置 topo 树节点的所有状态\n                if (newTopoNodeList.length < 1) {\n                    resetTree(this.topologyNodeTree, (node) => {\n                        this.$refs.tree.setChecked(node.id, {\n                            checked: false,\n                        });\n                        this.$refs.tree.setDisabled(node.id, {\n                            disabled: false,\n                        });\n                    });\n                    return;\n                }\n                this.recoverTreeState(newTopoNodeList, oldTopoNodeList);\n            },\n        },\n        created () {\n            this.isSelfChange = false;\n            this.isTreeRefresh = false;\n            this.fetchUserInfo();\n        },\n        mounted () {\n            if (this.emptyTopologyOfAllBusiness) {\n                return;\n            }\n            this.$nextTick(() => {\n                this.$refs.tree.setData(this.topologyNodeTree);\n                this.$refs.tree.setExpanded(this.topologyNodeTree[0].id, {\n                    expanded: true,\n                });\n                this.recoverTreeState(this.topoNodeList);\n            });\n        },\n        methods: {\n            /**\n             * @desc 获取登陆用户信息\n             */\n            fetchUserInfo () {\n                UserService.fetchUserInfo()\n                    .then((data) => {\n                        this.currentUser = Object.freeze(data);\n                        this.isRenderEmptyTopoNode = topoNodeCache.getItem(data.username);\n                    });\n            },\n            /**\n             * @desc 节点的选中状态改变\n             * @param {Array} newNode 最新选中的节点值\n             * @param {Array} oldNode 上次选中的节点值\n             *\n             * 外部传入值还原树的选中状态\n             */\n            recoverTreeState (newTopoNodeList, oldTopoNodeList = []) {\n                this.isSearchEmpty = this.topologyNodeTree.length < 1;\n                const isRemove = newTopoNodeList.length < oldTopoNodeList.length;\n                const oldNodeId = oldTopoNodeList.map(item => `#${item.type}#${item.id}`);\n                const newNodeId = newTopoNodeList.map(item => `#${item.type}#${item.id}`);\n                \n                if (isRemove) {\n                    // 外部删除操作\n                    const needRemoveCheckNode = _.difference(oldNodeId, newNodeId);\n                    this.isTreeRefresh = true;\n                    this.$refs.tree.setChecked(needRemoveCheckNode, {\n                        emitEvent: true,\n                        checked: false,\n                    });\n                } else {\n                    // 新增，只能出现在初始化的时候\n                    const needSelectNode = newNodeId;\n                    if (needSelectNode.length > 0) {\n                        this.isTreeRefresh = true;\n                        this.$refs.tree.setChecked(needSelectNode, {\n                            emitEvent: true,\n                            checked: true,\n                        });\n                    }\n                }\n            },\n            \n            handleFilterEmptyToggle (event) {\n                this.isRenderEmptyTopoNode = !this.isRenderEmptyTopoNode;\n                if (this.isRenderEmptyTopoNode) {\n                    // 显示所有节点，节点的选中状态不变\n                    event.stopPropagation();\n                    topoNodeCache.clearItem();\n                } else {\n                    topoNodeCache.setItem(this.currentUser.username);\n                }\n                // 更新节点树时保留树中节点的展开状态\n                const expandIdListMemo = this.$refs.tree.nodes.reduce((result, node) => {\n                    if (node.expanded) {\n                        result.push(node.id);\n                    }\n                    return result;\n                }, []);\n                // 过滤 topo 树\n                const topologyNodeTree = filterTopology(this.topologyNodeTree, this.isRenderEmptyTopoNode);\n                // 重新渲染 topo 树\n                this.$refs.tree.setData(topologyNodeTree);\n                this.$nextTick(() => {\n                    if (topologyNodeTree.length < 1) {\n                        return;\n                    }\n                    // 还原选中状态\n                    this.$refs.tree.setChecked(this.topoNodeList.map(item => `#${item.type}#${item.id}`), {\n                        emitEvent: false,\n                    });\n                    // 还原展开状态\n                    expandIdListMemo.forEach((nodeId) => {\n                        this.$refs.tree.setExpanded(nodeId);\n                    });\n                });\n            },\n            /**\n             * @desc 节点的选中状态改变\n             * @param {Array} allCheckNode 所有选中的节点\n             * @param {Object} node 当前操作的节点\n             */\n            handleCheckChange (allCheckNode, node) {\n                const filterCheckNode = (nodeList) => {\n                    const expireNodeMap = {};\n                    if (nodeList.length < 1) {\n                        return [];\n                    }\n                    const search = (list) => {\n                        let currentNode = null;\n                        let index = 0;\n                        while (index < list.length) {\n                            const currentNodeId = list[index];\n                            currentNode = this.$refs.tree.getNodeById(currentNodeId);\n                            if (!expireNodeMap[currentNodeId]) {\n                                break;\n                            }\n                            // eslint-disable-next-line no-plusplus\n                            index++;\n                        }\n                        if (index >= list.length) {\n                            return list;\n                        }\n                        \n                        const currentNodeChildIds = findAllChildNodeId(currentNode);\n                        const validList = _.difference(list, currentNodeChildIds);\n                        expireNodeMap[currentNode.id] = true;\n                        return search(validList);\n                    };\n                    return search(nodeList);\n                };\n                // 如果父级节点和子节点同时被添加过滤掉子节点\n                const checkNodeIds = filterCheckNode(allCheckNode);\n\n                if (this.isTreeRefresh) {\n                    this.isSelfChange = false;\n                    this.isTreeRefresh = false;\n                    return;\n                }\n                this.isSelfChange = true;\n                this.$emit('on-change', 'topoNodeList', checkNodeIds.map((item) => {\n                    const [type, id] = parseIdInfo(item);\n                    return {\n                        type,\n                        id,\n                    };\n                }));\n            },\n            /**\n             * @desc 拓扑节点搜索\n             * @param {String} value 筛选值\n             */\n            handleSearch: _.debounce(function (value) {\n                if (this.emptyTopologyOfAllBusiness) {\n                    return;\n                }\n                const data = this.$refs.tree.filter(value);\n                this.isSearchEmpty = data.length < 1;\n            }, 300),\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .choose-ip-dinamic-business-topology {\n        position: relative;\n        height: 100%;\n        padding: 0 24px;\n\n        .node-search {\n            position: relative;\n            z-index: 1;\n            padding-top: 20px;\n        }\n\n        .topology-node-tree {\n            height: calc(100% - 92px);\n            margin-top: 20px;\n        }\n\n        .node-box {\n            .node-count {\n                margin-left: 8px !important;\n            }\n        }\n\n        .topology-empty {\n            position: absolute;\n            right: 0;\n            left: 0;\n            width: 100%;\n            margin-top: 90px;\n        }\n    }\n</style>\n","<template>\n    <div class=\"choose-ip-dynamic-group\" v-bkloading=\"{ isLoading }\">\n        <div class=\"group-search\">\n            <bk-input\n                :placeholder=\"'搜索分组名称'\"\n                right-icon=\"bk-icon icon-search\"\n                @input=\"handleGroupSearch\" />\n        </div>\n        <template v-if=\"!isLoading\">\n            <div v-if=\"hasNotGroup\" class=\"group-empty\">\n                {{ '无数据' }}，<a :href=\"CMDBCreateGroupUrl\" target=\"_blank\">{{ '去创建' }}</a>\n            </div>\n            <div v-else class=\"group-list\">\n                <host-table :list=\"renderList\">\n                    <thead>\n                        <tr>\n                            <th style=\"width: 80px;\">\n                                <div class=\"head-cell\">\n                                    <bk-checkbox\n                                        v-bind=\"pageCheckInfo\"\n                                        @click.native=\"handleToggleWholeAll\" />\n                                </div>\n                            </th>\n                            <th style=\"width: 450px;\">{{ '分组名称' }}</th>\n                            <th>{{ '操作' }}</th>\n                        </tr>\n                    </thead>\n                    <tbody v-if=\"renderList.length > 0\">\n                        <template v-for=\"group in renderList\">\n                            <tr class=\"group-row\" :key=\"group.id\">\n                                <td @click=\"handleGroupCheck(group.id)\">\n                                    <bk-checkbox :checked=\"checkedMap[group.id]\" />\n                                </td>\n                                <td @click=\"handleGroupCheck(group.id)\">{{ group.name }}</td>\n                                <td>\n                                    <bk-button text @click=\"handlePreview(group)\">{{ '预览' }}</bk-button>\n                                </td>\n                            </tr>\n                        </template>\n                    </tbody>\n                </host-table>\n                <div v-if=\"pagination.pageSize > 0\" style=\"padding: 16px 0;\">\n                    <bk-pagination\n                        :count=\"pagination.total\"\n                        align=\"right\"\n                        show-total-count\n                        :show-limit=\"false\"\n                        :limit=\"pagination.pageSize\"\n                        :current.sync=\"pagination.page\"\n                        :limit-list=\"[pagination.pageSize]\"\n                        @change=\"handlePageChange\"\n                        small />\n                </div>\n            </div>\n        </template>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import AppService from '@service/app-manage';\n    import QueryGlobalSettingService from '@service/query-global-setting';\n    import {\n        encodeRegexp,\n    } from '@utils/assist';\n    import HostTable from './host-table';\n    \n    export default {\n        name: '',\n        components: {\n            HostTable,\n        },\n        inheritAttrs: false,\n        props: {\n            dynamicGroupList: {\n                type: Array,\n                required: true,\n            },\n            dialogHeight: {\n                type: Number,\n                required: true,\n            },\n        },\n        data () {\n            this.selfChange = false;\n            return {\n                isLoading: false,\n                isEmpty: false,\n                hasNotGroup: true,\n                list: [{},{},{}],\n                tempList: [{},{},{}],\n                checkedMap: {},\n                CMDBCreateGroupUrl: '',\n                pagination: {\n                    page: 1,\n                    pageSize: 0,\n                    total: 0,\n                },\n            };\n        },\n        computed: {\n            renderList  () {\n                const { page, pageSize } = this.pagination;\n                return Object.freeze(this.tempList.slice((page - 1) * pageSize, page * pageSize));\n            },\n            pageCheckInfo () {\n                const info = {\n                    indeterminate: false,\n                    checked: false,\n                };\n                const checkedNums = Object.keys(this.checkedMap).length;\n                info.indeterminate = checkedNums > 0;\n                info.checked = checkedNums > 0 && checkedNums >= this.pagination.total;\n                return info;\n            },\n        },\n        watch: {\n            dynamicGroupList: {\n                handler (dynamicGroupList) {\n                    if (this.selfChange) {\n                        this.selfChange = false;\n                        return;\n                    }\n                    const checkedMap = {};\n                    dynamicGroupList.forEach((groupId) => {\n                        checkedMap[groupId] = true;\n                    });\n                    this.pagination.page = 1;\n                    this.checkedMap = Object.freeze(checkedMap);\n                },\n                immediate: true,\n            },\n        },\n        mounted () {\n            this.calcPageSize();\n            this.fetchDynamicGroup();\n        },\n        methods: {\n            /**\n             * @desc 获取动态分组列表\n             *\n             * 动态分组列表为空可以跳转 cmdb 创建\n             */\n            fetchDynamicGroup () {\n                this.isLoading = true;\n                AppService.fetchDynamicGroup()\n                    .then((data) => {\n                        this.list = Object.freeze(data);\n                        this.tempList = Object.freeze(data);\n                        this.pagination.total = data.length;\n                        this.hasNotGroup = data.length < 1;\n                        if (this.hasNotGroup) {\n                            return this.fetchCMDBUrl();\n                        }\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 没有动态分组时可以去 cmdb 创建\n             */\n            fetchCMDBUrl () {\n                return QueryGlobalSettingService.fetchRelatedSystemUrls()\n                    .then((data) => {\n                        this.CMDBCreateGroupUrl = `${data.BK_CMDB_ROOT_URL}/#/business/${window.PROJECT_CONFIG.SCOPE_ID}/custom-query`;\n                    });\n            },\n            /**\n             * @desc 计算PageSize\n             */\n            calcPageSize () {\n                const topOffset = 154;\n                const bottomOffset = 116;\n                const pageSize = Math.floor((this.dialogHeight - topOffset - bottomOffset) / 40);\n                this.pagination.pageSize = pageSize;\n            },\n            /**\n             * @desc 动态分组值更新\n             */\n            trigger () {\n                this.selfChange = true;\n                this.$emit('on-change', 'dynamicGroupList', Object.keys(this.checkedMap));\n            },\n            /**\n             * @desc 本地搜索动态分组\n             * @param {String} value 搜索值\n             */\n            handleGroupSearch: _.debounce(function (value) {\n                if (!value.trim()) {\n                    this.tempList = this.list;\n                } else {\n                    const group = [];\n                    const searchRule = new RegExp(encodeRegexp(value), 'i');\n                    this.list.forEach((currentGroup) => {\n                        if (searchRule.test(currentGroup.name)) {\n                            group.push(currentGroup);\n                        }\n                    });\n                    this.tempList = Object.freeze(group);\n                }\n                \n                this.pagination.total = this.tempList.length;\n            }, 300),\n            /**\n             * @desc 列表跨页全选切换\n             */\n            handleToggleWholeAll () {\n                const checkedMap = {\n                    ...this.checkedMap,\n                };\n                const hasAllChecked = this.pageCheckInfo.checked;\n                this.tempList.forEach((current) => {\n                    if (!hasAllChecked) {\n                        checkedMap[current.id] = true;\n                    } else {\n                        delete checkedMap[current.id];\n                    }\n                });\n                this.checkedMap = Object.freeze(checkedMap);\n                this.trigger();\n            },\n            /**\n             * @desc 选中单个分组\n             * @param {Number} groupId\n             */\n            handleGroupCheck (groupId) {\n                const checkedMap = {\n                    ...this.checkedMap,\n                };\n                if (checkedMap[groupId]) {\n                    delete checkedMap[groupId];\n                } else {\n                    checkedMap[groupId] = true;\n                }\n                this.checkedMap = Object.freeze(checkedMap);\n                this.trigger();\n            },\n            /**\n             * @desc 预览单个分组的主机详情\n             * @param {Object} group\n             */\n            handlePreview (group) {\n                this.$emit('on-group-preview', {\n                    name: group.name,\n                    id: group.id,\n                });\n            },\n            /**\n             * @desc 列表翻页\n             * @param {Number} page\n             */\n            handlePageChange (page) {\n                this.pagination.page = page;\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .choose-ip-dynamic-group {\n        min-height: 100%;\n        padding: 20px 24px;\n\n        .group-empty {\n            margin-top: 180px;\n            text-align: center;\n        }\n\n        .group-list {\n            padding-top: 20px;\n\n            table {\n                th,\n                td {\n                    &:first-child {\n                        padding-left: 15px;\n                    }\n                }\n            }\n        }\n\n        .check-flag {\n            font-size: 20px;\n            color: #63656e;\n        }\n\n        .group-row {\n            cursor: pointer;\n        }\n    }\n</style>\n","<template>\n    <div class=\"choose-ip-server-ip-input\">\n        <div @click=\"handleInputClick\">\n            <bk-input\n                ref=\"input\"\n                type=\"textarea\"\n                :class=\"{\n                    'focus-error': isFocusError,\n                }\"\n                :rows=\"inputRows\"\n                :value=\"ipInputText\"\n                :placeholder=\"'请输入 IP 地址，多IP可用 空格 换行 ; , |分隔 \\n带云区域请用冒号分隔，如（ 0:192.168.1.101 ）'\"\n                @change=\"handleIPChange\" />\n        </div>\n        <div class=\"input-action\">\n            <div v-if=\"isError\" class=\"input-error\">\n                <div>{{ '以上内容存在错误：' }}</div>\n                <div v-if=\"invalidIPList.length > 0\">\n                    <span>{{ 'IP 在本业务下不存在' }}</span>\n                    <Icon\n                        type=\"ip-audit\"\n                        class=\"error-action\"\n                        v-bk-tooltips=\"'标识错误'\"\n                        @click=\"handleHighlightInvilad\" />\n                    <Icon\n                        type=\"delete\"\n                        class=\"error-action\"\n                        v-bk-tooltips=\"'一键清除'\"\n                        @click=\"handleRemoveInvalid\" />\n                </div>\n                <div v-if=\"invalidIPList.length > 0 && errorIPList.length > 0\">；</div>\n                <div v-if=\"errorIPList.length > 0\">\n                    <span>{{ '内容格式错误，无法识别' }}</span>\n                    <Icon\n                        type=\"ip-audit\"\n                        class=\"error-action\"\n                        v-bk-tooltips=\"'标识错误'\"\n                        @click=\"handleHightlightError\" />\n                    <Icon\n                        type=\"delete\"\n                        class=\"error-action\"\n                        v-bk-tooltips=\"'一键清除'\"\n                        @click=\"handleRemoveError\" />\n                </div>\n            </div>\n            <bk-button\n                class=\"submit-btn\"\n                theme=\"primary\"\n                outline\n                :loading=\"isSubmiting\"\n                @click=\"handleAddHost\">\n                <span>{{ '添加到已选择' }}</span>\n                <div\n                    v-if=\"inputItemList.length > 0\"\n                    ref=\"inputNumber\"\n                    class=\"server-input-number\">\n                    <span class=\"text\">{{ inputItemList.length }}</span>\n                </div>\n            </bk-button>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import AppManageService from '@service/app-manage';\n    import { encodeRegexp } from '@utils/assist';\n    import { generateHostRealId } from './utils';\n\n    export default {\n        name: '',\n        inheritAttrs: false,\n        props: {\n            previewId: {\n                type: String,\n                required: true,\n            },\n            dialogHeight: {\n                type: Number,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                isSubmiting: false,\n                ipInputText: '',\n                inputItemList: [{},{},{}],\n                invalidIPList: [{},{},{}],\n                errorIPList: [{},{},{}],\n                isFocusError: false,\n            };\n        },\n        computed: {\n            inputRows () {\n                const offsetTop = 65;\n                const offsetBottom = 130;\n                const inputPadding = 15;\n\n                return Math.floor((this.dialogHeight - offsetTop - offsetBottom - inputPadding) / 18);\n            },\n            isError () {\n                return this.invalidIPList.length > 0 || this.errorIPList.length > 0;\n            },\n        },\n        methods: {\n            /**\n             * @desc 更新输入框内容\n             */\n            updateInputValue () {\n                this.ipInputText = [\n                    ...this.invalidIPList,\n                    ...this.errorIPList,\n                ].join('\\n');\n                // fix: bk-input组件更新问题\n                setTimeout(() => {\n                    this.$refs.input.setCurValue(this.ipInputText);\n                });\n            },\n            /**\n             * @desc 用户点击输入框时切换选中文本样式\n             */\n            handleInputClick () {\n                this.isFocusError = false;\n            },\n            /**\n             * @desc 高亮输入框内无效的 IP 输入\n             */\n            handleHighlightInvilad () {\n                this.isFocusError = true;\n                const $inputEl = this.$refs.input.$el.querySelector('textarea');\n                const errorText = this.invalidIPList.join('\\n');\n                $inputEl.focus();\n                $inputEl.selectionStart = 0;\n                $inputEl.selectionEnd = errorText.length;\n            },\n            /**\n             * @desc 清空输入框内无效的 IP 输入\n             */\n            handleRemoveInvalid () {\n                this.invalidIPList = [];\n                this.updateInputValue();\n            },\n            /**\n             * @desc 高亮输入框内错误格式的 IP 输入\n             */\n            handleHightlightError () {\n                this.isFocusError = true;\n                const $inputEl = this.$refs.input.$el.querySelector('textarea');\n                $inputEl.focus();\n                const invalidText = this.invalidIPList.join('\\n');\n                const errorText = this.errorIPList.join('\\n');\n                const startIndex = invalidText.length > 0 ? invalidText.length + 1 : 0;\n                $inputEl.selectionStart = startIndex;\n                $inputEl.selectionEnd = startIndex + errorText.length;\n            },\n            /**\n             * @desc 清空输入框内错误格式的 IP 输入\n             */\n            handleRemoveError () {\n                this.errorIPList = [];\n                this.updateInputValue();\n            },\n            /**\n             * @desc 输入框值改变\n             * @param {String} value 用户输入值\n             */\n            handleIPChange: _.throttle(function (value) {\n                const realValue = _.trim(value);\n                this.invalidIPList = [];\n                this.errorIPList = [];\n                if (!realValue) {\n                    this.inputItemList = [];\n                    // 通知外部组件输入框没有值需要保存\n                    this.$emit('on-input-change', false);\n                } else {\n                    this.inputItemList = value.split(/[;,；，\\n|]+/).filter(_ => !!_);\n                    // 通知外部组件输入框有值还没被保存\n                    this.$emit('on-input-change', true);\n                }\n                // this.isError = false;\n            }, 60),\n            /**\n             * @desc 提交输入结果\n             */\n            handleAddHost () {\n                if (this.inputItemList.length < 1) {\n                    return;\n                }\n                const IPReg = /(((\\d+:)?)(?:(?:25[0-5]|2[0-4]\\d|((1\\d{2})|([1-9]?\\d)))\\.){3}(?:25[0-5]|2[0-4]\\d|((1\\d{2})|([1-9]?\\d))))/;\n                const ipList = [];\n                // 无法解析出 IP 的内容\n                const errorIPList = [];\n                this.inputItemList.forEach((IPText) => {\n                    const IPMatch = IPText.match(IPReg);\n                    if (IPMatch) {\n                        const [IPStr] = IPMatch;\n                        const errorIPRule = new RegExp(`([\\\\d:.]${encodeRegexp(IPStr)})|(${encodeRegexp(IPStr)}[\\\\d.])`);\n                        if (errorIPRule.test(IPText)) {\n                            // 无法完全正确的解析 IP（eq: 1.1.1.12.2.2.2，少了分隔造成的）\n                            errorIPList.push(IPText);\n                        } else {\n                            // 提取识别成功的 IP\n                            ipList.push(IPStr);\n                            // 将剩下的内容作为错误 IP 处理\n                            const errorText = IPText.replace(new RegExp(`(${encodeRegexp(IPStr)})|(\\\\s)`, 'g'), '');\n                            if (errorText) {\n                                errorIPList.push(errorText);\n                            }\n                        }\n                    } else {\n                        // 输入内容中不包含 IP\n                        errorIPList.push(IPText);\n                    }\n                });\n                \n                this.isSubmiting = true;\n\n                const params = {\n                    ipList,\n                };\n                if (window.IPInputScope) {\n                    params.actionScope = window.IPInputScope;\n                }\n\n                AppManageService.fetchHostOfHost(params)\n                    .then((data) => {\n                        // 输入的有效 IP\n                        const hostList = [];\n                        const hostIPMap = {};\n                        \n                        data.forEach((host) => {\n                            const {\n                                ip,\n                                cloudAreaInfo,\n                            } = host;\n                            hostList.push({\n                                realId: generateHostRealId(host),\n                                ip,\n                                cloudAreaInfo: {\n                                    id: cloudAreaInfo.id,\n                                },\n                            });\n                            // 记录 IP 和 云区域 ID + IP 组成的检索\n                            hostIPMap[ip] = true;\n                            hostIPMap[`${cloudAreaInfo.id}:${ip}`] = true;\n                        });\n                        // 提交输入内容\n                        if (hostList.length > 0) {\n                            this.$emit('on-change', 'ipInput', hostList);\n                        }\n                        // 正确的 IP 输入，但是 IP 不存于当前业务下\n                        this.invalidIPList = ipList.reduce((result, IPItem) => {\n                            if (!hostIPMap[IPItem]) {\n                                result.push(IPItem);\n                            }\n                            return result;\n                        }, []);\n                        this.errorIPList = errorIPList;\n                        // 提交成功后重置用户输入内容的分隔符解析\n                        this.inputItemList = [];\n                        \n                        this.updateInputValue();\n                        this.$emit('on-input-change', false);\n                    })\n                    .finally(() => {\n                        this.isSubmiting = false;\n                    });\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .choose-ip-server-ip-input {\n        padding: 20px 24px;\n\n        .focus-error {\n            textarea {\n                &::selection {\n                    color: #63656e;\n                    background: #fdd;\n                }\n            }\n        }\n\n        .input-action {\n            display: flex;\n            align-items: center;\n            margin-top: 20px;\n        }\n\n        .input-error {\n            display: flex;\n            margin-right: auto;\n            color: #ea3636;\n\n            .error-action {\n                font-size: 16px;\n                color: #63656e;\n                cursor: pointer;\n\n                &:hover {\n                    color: #3a84ff;\n                }\n            }\n        }\n\n        .submit-btn {\n            margin-left: auto;\n\n            &:hover {\n                .server-input-number .text {\n                    color: #3a84ff;\n                    background: #fff;\n                }\n            }\n        }\n    }\n\n    .server-input-number,\n    .server-input-number .text {\n        transition: transform 0.5s;\n    }\n\n    .server-input-number {\n        position: relative;\n        z-index: 999999;\n        display: inline-block;\n        height: 17px;\n        transition-timing-function: cubic-bezier(0.74, 0.95, 0.81, 0.92);\n    }\n\n    .server-input-number .text {\n        display: inline-block;\n        height: 17px;\n        min-width: 17px;\n        padding: 0 4px;\n        font-size: 12px;\n        line-height: 17px;\n        color: #fff;\n        text-align: center;\n        background: #3a84ff;\n        border-radius: 8px;\n        transition-timing-function: cubic-bezier(0, -1.12, 0.94, -1.07);\n    }\n</style>\n","<template>\n    <span class=\"statistics-text\">\n        <template v-if=\"data.success > 0\">\n            {{ '正常' }}:<span class=\"success number\">{{ data.success }}</span>\n        </template>\n        <template v-if=\"data.fail > 0\">\n            <span v-if=\"data.success > 0\" style=\"padding-left: 16px;\" />\n            {{ '异常' }}:<span class=\"error number\">{{ data.fail }}</span>\n        </template>\n    </span>\n</template>\n<script>\n    export default {\n        props: {\n            data: {\n                type: Object,\n                require: true,\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .statistics-text {\n        display: flex;\n        font-size: 12px;\n        font-weight: normal;\n        color: #63656e;\n\n        .strong {\n            color: #3a84ff;\n        }\n\n        .error {\n            color: #ea3636;\n        }\n\n        .success {\n            color: #3fc06d;\n        }\n\n        .number {\n            padding: 0 4px;\n            font-weight: bold;\n        }\n    }\n</style>\n","<template>\n    <sideslider-box class=\"server-group-host-preview\" :value=\"value\" @change=\"handleClose\">\n        <div slot=\"title\">{{ '分组预览' }}——{{ data.name }}</div>\n        <div slot=\"desc\">\n            <statistics-text :data=\"statisticsData\" />\n            <action-extend :list=\"list\" copyable />\n        </div>\n        <div class=\"preview-wraper\" v-bkloading=\"{ isLoading }\">\n            <host-table :list=\"list\" />\n        </div>\n    </sideslider-box>\n</template>\n<script>\n    import AppService from '@service/app-manage';\n    import HostTable from './host-table';\n    import SidesliderBox from './sideslider-box';\n    import StatisticsText from './statistics-text';\n    import ActionExtend from './action-extend';\n    import {\n        sortHost,\n        statisticsHost,\n    } from '../components/utils';\n\n    export default {\n        name: '',\n        components: {\n            HostTable,\n            SidesliderBox,\n            StatisticsText,\n            ActionExtend,\n        },\n        props: {\n            value: {\n                type: Boolean,\n                default: false,\n            },\n            data: {\n                type: Object,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                isLoading: false,\n                statisticsData: {},\n                list: [{},{},{}],\n            };\n        },\n        created () {\n            if (this.data.id) {\n                this.fetchDynamicGroup();\n            }\n        },\n        methods: {\n            fetchDynamicGroup () {\n                this.isLoading = true;\n                AppService.fetchHostOfDynamicGroup({\n                    id: this.data.id,\n                }).then((data) => {\n                    if (data.length < 1) {\n                        this.isError = true;\n                        return;\n                    }\n                    this.statisticsData = statisticsHost(data[0].ipListStatus);\n                    this.list = Object.freeze(sortHost(data[0].ipListStatus));\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            handleClose () {\n                this.list = [];\n                this.statisticsData = {};\n                this.$emit('input', false);\n                this.$emit('change', false);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .server-group-host-preview {\n        .choose-ip-host-table {\n            tr {\n                td {\n                    border-bottom: 1px solid #e7e8ed !important;\n                }\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"jb-collapse-item\">\n        <bk-collapse-item ref=\"collapseItem\" v-bind=\"$attrs\" v-on=\"$listeners\" hide-arrow>\n            <template #default>\n                <Icon :type=\"iconType\" />\n                <span style=\"display: none;\">{{ iconType }}</span>\n                <slot />\n            </template>\n            <template #content>\n                <slot name=\"content\" />\n            </template>\n        </bk-collapse-item>\n    </div>\n</template>\n<script>\n    export default {\n        inject: ['collapse'],\n        data () {\n            return {\n                iconType: 'arrow-full-right',\n            };\n        },\n        mounted () {\n            const unwatch = this.$watch(() => this.$refs.collapseItem.isActive, (newValue) => {\n                this.iconType = newValue ? 'arrow-full-down' : 'arrow-full-right';\n            }, {\n                immediate: true,\n            });\n            this.$once('hook:beforeDestroy', () => {\n                unwatch();\n            });\n        },\n    };\n</script>\n<style lang='postcss'>\n    .bk-collapse {\n        border-bottom: 1px solid #dcdee5;\n    }\n\n    .jb-collapse-item {\n        .bk-collapse-item-active {\n            .bk-collapse-item-header {\n                border-bottom-color: #dcdee5;\n            }\n        }\n\n        .bk-collapse-item-header {\n            position: relative;\n            overflow: initial;\n            font-size: 12px;\n            font-weight: 600;\n            background: #fafbfd;\n            border: 1px solid #dcdee5;\n            border-bottom-color: transparent;\n        }\n\n        .bk-collapse-item .bk-collapse-item-content {\n            padding: 0;\n            border-right: 1px solid #dcdee5;\n            border-left: 1px solid #dcdee5;\n        }\n    }\n\n</style>\n","<template>\n    <jb-collapse-item name=\"node\">\n        <span class=\"panel-title\">\n            <span>{{ '已选择'}}</span>\n            <span class=\"strong number\">{{ data.length }}</span>\n            <span>{{ '个节点'}}</span>\n        </span>\n        <action-extend v-if=\"editable\">\n            <div class=\"action-item\" @click=\"handleRemoveAll\">{{ '移除全部' }}</div>\n        </action-extend>\n        <template #content>\n            <div class=\"server-panel-node-view\" v-bkloading=\"{ isLoading }\">\n                <host-table\n                    v-if=\"!isRequestError\"\n                    :max-height=\"410\"\n                    :list=\"list\"\n                    :append-nums=\"invalidList.length\">\n                    <tbody\n                        v-if=\"invalidList.length > 0\"\n                        class=\"invalid-list\"\n                        slot=\"appendBefore\">\n                        <tr v-for=\"(row, index) in invalidList\" :key=\"`invalid_${index}`\">\n                            <td class=\"table-cell\">\n                                <span class=\"invalid\" v-bk-tooltips=\"'该节点在配置平台已被删除'\">\n                                    {{ '无效' }}\n                                </span>\n                                <span>{{ row.type }}#{{ row.id }}</span>\n                            </td>\n                            <td colspan=\"2\">--</td>\n                            <td v-if=\"editable\" class=\"action-column\">\n                                <bk-button\n                                    text\n                                    @click=\"handleInvalidRemove(index)\">\n                                    {{ '移除' }}\n                                </bk-button>\n                            </td>\n                        </tr>\n                    </tbody>\n                    <tbody class=\"valid-list\">\n                        <tr\n                            v-for=\"(row, index) in list\"\n                            :key=\"row.key\"\n                            :class=\"diff[row.key]\">\n                            <td\n                                style=\"width: 40%; cursor: pointer;\"\n                                @click=\"handleViewHostList(row.key)\">\n                                <div class=\"cell-text\">\n                                    {{ wholePathMap[row.key] || row.name }}\n                                </div>\n                            </td>\n                            <td style=\"width: 150px;\">\n                                <Icon\n                                    v-if=\"row.isHostLoading\"\n                                    class=\"loading-status\"\n                                    svg\n                                    type=\"sync-pending\" />\n                                <div\n                                    v-else\n                                    class=\"cell-text\">\n                                    <span>{{ '共' }}</span>\n                                    <span class=\"number strong\">{{ row.total }}</span>\n                                    <span>{{ '台主机'}}</span>\n                                </div>\n                            </td>\n                            <td @click=\"handleViewHostList(row.key)\">\n                                <statistics-text\n                                    v-if=\"!row.isHostLoading\"\n                                    style=\"cursor: pointer;\"\n                                    :data=\"row\" />\n                            </td>\n                            <td v-if=\"editable\" class=\"action-column\">\n                                <bk-button\n                                    text\n                                    @click=\"handleRemoveOne(index)\">\n                                    {{ '移除' }}\n                                </bk-button>\n                            </td>\n                        </tr>\n                    </tbody>\n                </host-table>\n                <bk-exception\n                    v-if=\"isRequestError\"\n                    type=\"500\"\n                    style=\"padding-bottom: 50px;\">\n                    <div style=\"display: flex; font-size: 14px;\">\n                        <span>数据拉取失败，请</span>\n                        <bk-button text @click=\"handleRefresh\">重试</bk-button>\n                    </div>\n                </bk-exception>\n            </div>\n        </template>\n    </jb-collapse-item>\n</template>\n<script>\n    import _ from 'lodash';\n    import AppService from '@service/app-manage';\n       import JbCollapseItem from '@components/jb-collapse-item';\n    import ActionExtend from '../components/action-extend';\n    import HostTable from '../components/host-table';\n    import StatisticsText from '../components/statistics-text';\n    import {\n        statisticsHost,\n    } from '../components/utils';\n\n    const genNodeKey = ({ objectId, instanceId }) => `#${objectId}#${instanceId}`;\n\n    export default {\n        name: 'ViewNode',\n        components: {\n            JbCollapseItem,\n            ActionExtend,\n            HostTable,\n            StatisticsText,\n        },\n        props: {\n            data: {\n                type: Array,\n                required: true,\n            },\n            editable: {\n                type: Boolean,\n                default: false,\n            },\n            diff: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                isLoading: false,\n                isNodeListLoading: true,\n                list: [{},{},{}],\n                invalidList: [{},{},{}],\n                wholePathMap: {},\n                isRequestError: false,\n            };\n        },\n        watch: {\n            data: {\n                handler (data) {\n                    if (this.isInnerChange) {\n                        this.isInnerChange = false;\n                        return;\n                    }\n                    if (data.length < 1) {\n                        this.list = [];\n                        return;\n                    }\n                    this.fetchNodeDetail();\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.isInnerChange = false;\n            // 缓存数据用查看节点的主机详情\n            this.nodeMap = {};\n        },\n        methods: {\n            /**\n             * 获取节点的信息\n             */\n            fetchNodeDetail () {\n                this.isLoading = true;\n                this.isNodeListLoading = true;\n                const wholeNodeMap = this.data.reduce((result, node) => {\n                    result[`#${node.type}#${node.id}`] = node;\n                    return result;\n                }, {});\n                \n                AppService.fetchNodePath(this.data)\n                    .then((data) => {\n                        this.nodeMap = {};\n                        const list = [];\n                        data.forEach((pathStack) => {\n                            // 无效节点对应的拓扑路径信息为 null\n                            if (!pathStack) {\n                                return;\n                            }\n                            const wholePath = pathStack.map(({ instanceName }) => instanceName).join(' / ');\n                            const currentNode = _.last(pathStack);\n                            const {\n                                objectId: type,\n                                instanceId: id,\n                            } = currentNode;\n                            const key = genNodeKey(currentNode);\n                            // 删除有返回结果的节点缓存\n                            delete wholeNodeMap[key];\n                            list.push({\n                                key,\n                                id,\n                                name: wholePath,\n                                type,\n                            });\n                        });\n                        // 没有查询到节点信息为无效节点\n                        this.invalidList = Object.freeze(Object.values(wholeNodeMap));\n                        // 有效节点列表\n                        this.list = Object.freeze(list);\n                        this.fetchHostOfNode();\n                    })\n                    .catch(() => {\n                        this.isRequestError = true;\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * 获取节点的主机信息\n             */\n            fetchHostOfNode () {\n                const nodeMap = this.list.reduce((result, item) => {\n                    result[item.key] = Object.assign({}, item, {\n                        isHostLoading: true,\n                    });\n                    return result;\n                }, {});\n                // 更新节点主机列表的loading状态\n                this.list = Object.freeze(Object.values(nodeMap));\n                AppService.fetchNodeInfo(this.list.map(({ id, type }) => ({\n                    id,\n                    type,\n                })))\n                    .then((data) => {\n                        this.nodeMap = {};\n                        data.forEach((item) => {\n                            const {\n                                nodeType: type,\n                                id,\n                                ipListStatus = [],\n                            } = item;\n                            const key = `#${type}#${id}`;\n\n                            const statisticsResult = statisticsHost(ipListStatus);\n\n                            nodeMap[key] = Object.assign({}, nodeMap[key], {\n                                ...statisticsResult,\n                                isHostLoading: false,\n                            });\n\n                            this.nodeMap[key] = Object.assign({}, nodeMap[key], {\n                                ...statisticsResult,\n                                host: Object.freeze(ipListStatus),\n                            });\n                        });\n                        this.list = Object.freeze(Object.values(nodeMap));\n                    })\n                    .finally(() => {\n                        this.isNodeListLoading = false;\n                    });\n            },\n            /**\n             * @desc 外部调用刷新节点的主机状态\n             */\n            refresh: _.debounce(function () {\n                if (this.isNodeListLoading) {\n                    return;\n                }\n                this.fetchHostOfNode();\n            }, 300),\n            /**\n             * @desc 外部调用获取所有节点下的主机\n             */\n            getAllHost () {\n                const stack = [];\n                for (const nodeId in this.nodeMap) {\n                    stack.push(...this.nodeMap[nodeId].host);\n                }\n                return stack;\n            },\n            /**\n             * @desc 外部调用移除所有无效的分组\n             */\n            removeAllInvalidHost () {\n                this.invalidList = [];\n                this.triggerChange();\n            },\n            triggerChange () {\n                this.isInnerChange = true;\n                this.$emit('on-change', [\n                    ...this.invalidList,\n                    ...this.list,\n                ]);\n            },\n            /**\n             * @desc 失败重试\n             */\n            handleRefresh () {\n                this.fetchNodeDetail();\n            },\n            /**\n             * @desc 移除无效节点\n             * @param {Number} index 节点索引\n             */\n            handleInvalidRemove (index) {\n                const invalidList = [\n                    ...this.invalidList,\n                ];\n                invalidList.splice(index, 1);\n                this.invalidList = Object.freeze(invalidList);\n                this.triggerChange();\n            },\n            /**\n             * @desc 移除所有节点\n             */\n            handleRemoveAll () {\n                if (this.data.length < 1) {\n                    this.messageSuccess('你还未选择节点');\n                    return;\n                }\n                // 内部显示删除\n                this.list = [];\n                this.nodeMap = {};\n                this.invalidList = [];\n                this.triggerChange();\n                this.messageSuccess('移除成功');\n            },\n            /**\n             * @desc 移除节点\n             * @param {Number} index 节点索引\n             */\n            handleRemoveOne (index) {\n                // 内部显示删除\n                const currentNode = this.list[index];\n                const list = [...this.list];\n                list.splice(index, 1);\n                this.list = Object.freeze(list);\n                delete this.nodeMap[currentNode.id];\n                this.triggerChange();\n                this.messageSuccess('移除成功');\n            },\n            /**\n             * @desc 查看阶段的主机详情\n             * @param {String} key 节点key\n             */\n            handleViewHostList (key) {\n                if (this.isNodeListLoading) {\n                    this.messageError('节点主机列表加载中');\n                    return;\n                }\n                this.$emit('on-view', Object.freeze(this.nodeMap[key]));\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .server-panel-node-view {\n        .cell-text {\n            display: block !important;\n            height: 20px;\n            text-align: left;\n            white-space: nowrap !important;\n            direction: rtl;\n            -webkit-line-clamp: 1 !important;\n        }\n    }\n</style>\n","<template>\n    <div class=\"choose-ip-host-detail\" ref=\"hostDetail\">\n        <sideslider-box :value=\"show\" @change=\"handleClose\">\n            <div slot=\"title\">{{ data.name }}</div>\n            <div slot=\"desc\">\n                <statistics-text slot=\"desc\" :data=\"data\" />\n                <action-extend :list=\"list\" copyable />\n            </div>\n            <host-table :list=\"list\" />\n        </sideslider-box>\n    </div>\n</template>\n<script>\n    import ActionExtend from '../components/action-extend';\n    import SidesliderBox from '../components/sideslider-box';\n    import StatisticsText from '../components/statistics-text';\n    import HostTable from '../components/host-table';\n    import {\n        sortHost,\n    } from '../components/utils';\n\n    export default {\n        name: 'HostDetail',\n        components: {\n            ActionExtend,\n            SidesliderBox,\n            StatisticsText,\n            HostTable,\n        },\n        model: {\n            prop: 'show',\n            event: 'input',\n        },\n        props: {\n            append: {\n                type: Function,\n                required: true,\n            },\n            show: {\n                type: Boolean,\n                default: false,\n            },\n            data: {\n                type: Object,\n                default: () => ({\n                    host: [],\n                }),\n            },\n        },\n        data () {\n            return {\n                list: [{},{},{}],\n            };\n        },\n        watch: {\n            data: {\n                handler (data) {\n                    if (!data.host) {\n                        this.list = [];\n                        return;\n                    }\n                    this.list = Object.freeze(sortHost(data.host));\n                },\n                immediate: true,\n            },\n        },\n        mounted () {\n            this.append().appendChild(this.$refs.hostDetail);\n            this.$once('hook:beforeDestroy', () => {\n                const $target = this.append();\n                if (this.append()) {\n                    $target.removeChild(this.$refs.hostDetail);\n                }\n            });\n        },\n        methods: {\n            handleClose () {\n                this.currentPage = 1;\n                this.$emit('input', false);\n                this.$emit('change', false);\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .choose-ip-host-detail {\n        .choose-ip-host-table {\n            tr {\n                td {\n                    border-bottom: 1px solid #e7e8ed !important;\n                }\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"server-search-panel\">\n        <div class=\"search-header\">\n            <span>\n                <span>{{ '已筛选出' }}<span class=\"strong number\">{{ list.length }}</span>{{ '个IP' }}</span>\n                <span v-if=\"statisticsData.fail\">（<span class=\"error\">{{ statisticsData.fail }}</span>{{ '台Agent异常' }}）</span>\n            </span>\n            <action-extend :list=\"list\" copyable>\n                <template v-if=\"editable\">\n                    <div class=\"action-item\" @click=\"handleRemoveAll\">{{ '移除全部' }}</div>\n                    <div class=\"action-item\" @click=\"handleRemoveFail\">{{ '移除异常' }}</div>\n                </template>\n            </action-extend>\n        </div>\n        <host-table :list=\"list\" editable is-search @on-change=\"handleRemoveOne\" />\n    </div>\n</template>\n<script>\n       import HostTable from '../components/host-table';\n    import ActionExtend from '../components/action-extend';\n    import {\n        sortHost,\n        statisticsHost,\n    } from '../components/utils';\n    \n    export default {\n        name: '',\n        components: {\n            HostTable,\n            ActionExtend,\n        },\n        props: {\n            data: {\n                type: Array,\n                required: true,\n            },\n            editable: {\n                type: Boolean,\n                default: false,\n            },\n        },\n        data () {\n            return {\n                list: [{},{},{}],\n                statisticsData: {},\n            };\n        },\n        computed: {\n            classes () {\n                return {\n                    scroll: this.data.length > 10,\n                };\n            },\n        },\n        watch: {\n            data: {\n                handler (host) {\n                    if (this.isInnerChange) {\n                        this.isInnerChange = false;\n                        return;\n                    }\n                    this.page = 1;\n                    this.list = Object.freeze(sortHost(host));\n                    this.statisticsData = statisticsHost(host);\n                },\n                immediate: true,\n            },\n        },\n\n        methods: {\n            /**\n             * @desc 删除所有筛选得到的主机\n             */\n            handleRemoveAll () {\n                if (this.list.length < 1) {\n                    this.messageSuccess('没有可移除主机');\n                    return;\n                }\n                const allList = this.list;\n                this.list = [];\n                this.isInnerChange = true;\n                this.$emit('on-change', allList);\n                this.messageSuccess('移除全部主机成功');\n            },\n            /**\n             * @desc 删除筛选结果中的异常主机\n             *\n             * 抛出change事件通知那些主机被删除\n             */\n            handleRemoveFail () {\n                const effectiveIp = [];\n                const failIp = [];\n                this.list.forEach((currentHost) => {\n                    if (currentHost.alive) {\n                        effectiveIp.push(currentHost);\n                    } else {\n                        failIp.push(currentHost);\n                    }\n                });\n                if (effectiveIp.length === this.list.length) {\n                    this.messageSuccess('没有可移除主机');\n                    return;\n                }\n                this.list = Object.freeze(effectiveIp);\n                this.isInnerChange = true;\n                this.$emit('on-change', failIp);\n                this.messageSuccess('移除异常主机成功');\n            },\n            /**\n             * @desc 删除单个主机\n             * @param {Number} hostRealId 主机的唯一标识\n             *\n             * 抛出change事件通知那些主机被删除\n             */\n            handleRemoveOne (hostRealId) {\n                // 内部显示删除\n                const newList = [];\n                let removeHost = null;\n                this.list.forEach((currentHost) => {\n                    if (currentHost.realId !== hostRealId) {\n                        newList.push(currentHost);\n                    } else {\n                        removeHost = currentHost;\n                    }\n                });\n                this.list = Object.freeze(newList);\n                if (!removeHost) {\n                    return;\n                }\n                \n                this.isInnerChange = true;\n                this.$emit('on-change', [\n                    removeHost,\n                ]);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .server-search-panel {\n        color: #63656e;\n        border: 1px solid #dcdee5;\n\n        .search-header {\n            position: relative;\n            height: 41px;\n            padding-left: 60px;\n            font-size: 12px;\n            font-weight: bold;\n            line-height: 41px;\n            color: #63656e;\n            background: #fafbfd;\n            border-bottom: 1px solid #dcdee5;\n        }\n\n        .list-more {\n            border-top: 1px solid #dcdee5;\n        }\n\n        .search-empty {\n            height: 240px;\n        }\n    }\n</style>\n","<template>\n    <div\n        class=\"server-panel\"\n        :class=\"classes\">\n        <div\n            v-if=\"needRender\"\n            class=\"server-result-wraper\">\n            <bk-collapse v-model=\"activePanel\">\n                <server-host\n                    v-if=\"hostList.length > 0 || renderWithEmpty\"\n                    ref=\"host\"\n                    :data=\"hostList\"\n                    :editable=\"editable\"\n                    :diff=\"hostDiff\"\n                    @on-change=\"handleHostChange\" />\n                <server-node\n                    v-if=\"nodeInfo.length > 0 || renderWithEmpty\"\n                    ref=\"node\"\n                    :data=\"nodeInfo\"\n                    :editable=\"editable\"\n                    :diff=\"nodeDiff\"\n                    @on-view=\"handleView\"\n                    @on-change=\"handleNodeChange\" />\n                <server-group\n                    v-if=\"groupList.length > 0 || renderWithEmpty\"\n                    ref=\"group\"\n                    :data=\"groupList\"\n                    :editable=\"editable\"\n                    :diff=\"groupDiff\"\n                    @on-view=\"handleView\"\n                    @on-change=\"handleGroupChange\" />\n            </bk-collapse>\n        </div>\n        <lower-component level=\"custom\" :custom=\"showDetail\">\n            <host-detail\n                v-model=\"showDetail\"\n                :data=\"viewInfo\"\n                :append=\"hostDetailAppend\" />\n        </lower-component>\n        <lower-component level=\"custom\" :custom=\"searchMode\">\n            <host-search\n                v-show=\"searchMode\"\n                :data=\"searchData\"\n                :editable=\"editable\"\n                @on-change=\"handleSearchChange\" />\n        </lower-component>\n    </div>\n</template>\n<script>\n    import { encodeRegexp } from '@utils/assist';\n    import TaskHostNodeModel from '@model/task-host-node';\n    import ServerNode from './view/node';\n    import ServerHost from './view/host';\n    import ServerGroup from './view/group';\n    import HostDetail from './view/host-detail';\n    import HostSearch from './view/host-search';\n    import { generateHostRealId } from './components/utils';\n\n    const addCollapsePanel = (target, name) => {\n        if (target.length > 0) {\n            return;\n        }\n        if (!target.includes(name)) {\n            target.push(name);\n        }\n    };\n\n    export default {\n        name: 'ServerPanel',\n        components: {\n            ServerNode,\n            ServerHost,\n            ServerGroup,\n            HostDetail,\n            HostSearch,\n        },\n        props: {\n            hostNodeInfo: {\n                type: Object,\n                default: () => new TaskHostNodeModel(),\n            },\n            // 可编辑\n            editable: {\n                type: Boolean,\n                default: false,\n            },\n            // 数据为空时是否显示\n            renderWithEmpty: {\n                type: Boolean,\n                default: false,\n            },\n            // 主机详情弹框的渲染位置\n            hostDetailAppend: {\n                type: Function,\n                default: () => document.querySelector('body'),\n            },\n            // 主机搜索模式\n            searchMode: {\n                type: Boolean,\n                default: false,\n            },\n            // 主机搜索的筛选值\n            searchData: {\n                type: Array,\n                default: () => [],\n            },\n            nodeDiff: {\n                type: Object,\n                default: () => ({}),\n            },\n            hostDiff: {\n                type: Object,\n                default: () => ({}),\n            },\n            groupDiff: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                activePanel: [],\n                showDetail: false,\n                viewInfo: {},\n                nodeInfo: [],\n                hostList: [{},{},{}],\n                groupList: [{},{},{}],\n                requestQueue: [],\n            };\n        },\n        computed: {\n            needRender () {\n                if (this.renderWithEmpty) {\n                    return true;\n                }\n                return this.nodeInfo.length || this.hostList.length || this.groupList.length;\n            },\n            classes () {\n                const stack = [];\n                if (this.searchMode) {\n                    stack.push('show-search');\n                }\n                return stack;\n            },\n        },\n        watch: {\n            hostNodeInfo: {\n                handler (hostNodeInfo) {\n                    const { dynamicGroupList, ipList, topoNodeList } = hostNodeInfo;\n                    this.hostList = Object.freeze(ipList);\n                    if (ipList.length > 0) {\n                        addCollapsePanel(this.activePanel, 'host');\n                    }\n                    this.nodeInfo = Object.freeze(topoNodeList);\n                    if (topoNodeList.length > 0) {\n                        addCollapsePanel(this.activePanel, 'node');\n                    }\n                    this.groupList = Object.freeze(dynamicGroupList);\n                    if (dynamicGroupList.length > 0) {\n                        addCollapsePanel(this.activePanel, 'group');\n                    }\n                },\n                immediate: true,\n            },\n        },\n        methods: {\n            /**\n             * @desc 供外部调用的api\n             * @param {Boolean} returnErrorIP true: 只返回返回异常主机ip；false: 返回所有主机ip\n             *\n             * 获取面板中的所有ip(主机)，根据ip去重\n             */\n            getAllIP (returnErrorIP = false) {\n                const allHostList = [];\n                if (this.$refs.host) {\n                    allHostList.push(...this.$refs.host.getAllHost());\n                }\n                if (this.$refs.node) {\n                    allHostList.push(...this.$refs.node.getAllHost());\n                }\n                if (this.$refs.group) {\n                    allHostList.push(...this.$refs.group.getAllHost());\n                }\n                const ipMap = {};\n                const errorIPMap = {};\n                allHostList.forEach((host) => {\n                    ipMap[host.ip] = 1;\n                    if (host.alive !== 1) {\n                        errorIPMap[host.ip] = 1;\n                    }\n                });\n                \n                // 异常主机包含无效主机\n                if (returnErrorIP) {\n                    return Object.keys(errorIPMap);\n                }\n                return Object.keys(ipMap);\n            },\n            /**\n             * @desc 供外部调用的api，支持搜索（操作的对象是已选的主机，不包含分组和节点）\n             * @param {String} filter 过滤项\n             *\n             * 获取主机面板中的所有主机信息，根据（ip + 云区域）去重\n             */\n            getAllHost (filter = '') {\n                if (filter.trim() === '') {\n                    return this.$refs.host.getAllHost();\n                }\n                if (!/^[0-9.]+$/g.test(filter)) {\n                    return [];\n                }\n                \n                const filterReg = new RegExp(`${encodeRegexp(filter.trim())}`);\n                const hostMap = {};\n                \n                if (this.$refs.host) {\n                    this.$refs.host.getAllHost().forEach((host) => {\n                        if (filterReg.test(host.ip)) {\n                            hostMap[generateHostRealId(host)] = host;\n                        }\n                    });\n                }\n                \n                return Object.values(hostMap);\n            },\n            /**\n             * @desc 外部调用——移除无效主机\n             */\n            removeAllInvalidHost () {\n                this.$refs.host && this.$refs.host.removeAllInvalidHost();\n                this.$refs.node && this.$refs.node.removeAllInvalidHost();\n                this.$refs.group && this.$refs.group.removeAllInvalidHost();\n            },\n            /**\n             * @desc 外部刷新主机状态接口\n             *\n             * 获取主机面板中的所有主机（主机），根据（ip + 云区域）去重\n             */\n            refresh () {\n                this.$refs.host && this.$refs.host.refresh();\n                this.$refs.node && this.$refs.node.refresh();\n                this.$refs.group && this.$refs.group.refresh();\n            },\n            /**\n             * @desc 触发值的改变\n             */\n            trigger () {\n                this.$emit('on-change', {\n                    ipList: this.hostList,\n                    topoNodeList: this.nodeInfo,\n                    dynamicGroupList: this.groupList,\n                });\n            },\n            /**\n             * @desc 面板的loading状态\n             * @param {Boolean} loading 每个面板的loading状态\n             */\n            handleLoading (loading) {\n                if (loading) {\n                    this.requestQueue.push(true);\n                } else {\n                    this.requestQueue.pop();\n                }\n            },\n            /**\n             * @desc 查看分组和节点下的主机列表\n             * @param {Boolean} payload 查看详情的数据\n             */\n            handleView (payload) {\n                this.showDetail = true;\n                this.viewInfo = Object.freeze(payload);\n            },\n            /**\n             * @desc 更新主机\n             * @param {Array} hostList 最新的主机列表\n             */\n            handleHostChange (hostList) {\n                this.hostList = Object.freeze(hostList);\n                this.trigger();\n            },\n            /**\n             * @desc 更新节点\n             * @param {Array} nodeInfo 最新的节点列表\n             */\n            handleNodeChange (nodeInfo) {\n                this.nodeInfo = Object.freeze(nodeInfo);\n                this.trigger();\n            },\n            /**\n             * @desc 更新分组\n             * @param {Array} groupList 最新的分组列表\n             */\n            handleGroupChange (groupList) {\n                this.groupList = Object.freeze(groupList);\n                this.trigger();\n            },\n            /**\n             * @desc 搜索主机面板删除了主机\n             * @param {Array} removeHostList 在搜索面板中被删除的主机\n             */\n            handleSearchChange (removeHostList) {\n                const removeHostMap = {};\n                removeHostList.forEach((item) => {\n                    removeHostMap[item.realId] = true;\n                });\n\n                const result = [];\n                this.$refs.host.list.forEach((currentHost) => {\n                    if (!removeHostMap[currentHost.realId]) {\n                        result.push(currentHost);\n                    }\n                });\n                this.hostList = Object.freeze(result);\n                this.trigger();\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .server-panel {\n        position: relative;\n        z-index: 1;\n        width: 100%;\n        background: #fff;\n\n        &.show-search {\n            .server-result-wraper {\n                display: none;\n            }\n        }\n\n        .bk-collapse-item-header {\n            display: flex;\n            align-items: center;\n            padding-left: 23px;\n\n            .panel-title {\n                padding-left: 23px;\n            }\n        }\n\n        .server-result-wraper {\n            height: 100%;\n        }\n\n        .choose-ip-host-table {\n            thead {\n                th {\n                    background: #fff;\n                }\n            }\n\n            .invalid-list {\n                td {\n                    color: #c4c6cc;\n                }\n            }\n\n            tbody:last-child {\n                tr:last-child {\n                    td {\n                        border-bottom: none;\n                    }\n                }\n            }\n        }\n\n        /* diff 样式 */\n        .choose-ip-host-table { /* stylelint-disable-line */\n            tr.delete {\n                * {\n                    color: #c4c6cc !important;\n                    text-decoration: line-through;\n                }\n            }\n\n            tr.new {\n                td:first-child {\n                    position: relative;\n\n                    &::before {\n                        position: absolute;\n                        top: 50%;\n                        width: 24px;\n                        height: 16px;\n                        margin-left: -32px;\n                        font-size: 12px;\n                        line-height: 16px;\n                        color: #fff;\n                        text-align: center;\n                        background: #f0c581;\n                        border-radius: 2px;\n                        content: \"new\";\n                        transform: translateY(-50%);\n                    }\n                }\n            }\n        }\n    }\n</style>\n","<template>\n    <div v-if=\"value\" id=\"chooseIPServerPreview\" class=\"server-preview\">\n        <div class=\"preview-header\">\n            <div>{{ '已选项预览' }}</div>\n            <div class=\"server-description\">\n                <span v-html=\"resultText\" />\n            </div>\n        </div>\n        <scroll-faker class=\"preview-content\" style=\"height: calc(100% - 118px);\">\n            <server-panel\n                :host-node-info=\"hostNodeInfo\"\n                :host-detail-append=\"getElementTarget\"\n                editable\n                render-with-empty\n                @on-change=\"handleServerPanelChange\" />\n        </scroll-faker>\n        <div class=\"preview-footer\">\n            <bk-button class=\"mr10\" theme=\"primary\" @click=\"handleSubmit\">{{ '确定' }}</bk-button>\n            <bk-button @click=\"handleClose\">{{ '关闭' }}</bk-button>\n        </div>\n    </div>\n</template>\n<script>\n/**\n     * 预览已选主机数据\n    */\n       import ServerPanel from './server-panel';\n\n    export default {\n        name: '',\n        components: {\n            ServerPanel,\n        },\n        props: {\n            value: {\n                type: Boolean,\n                default: false,\n            },\n            host: {\n                type: Array,\n                default: () => [],\n            },\n            node: {\n                type: Array,\n                default: () => [],\n            },\n            group: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                hostNodeInfoLocal: {},\n            };\n        },\n        computed: {\n            hostNodeInfo () {\n                return {\n                    ipList: this.host,\n                    dynamicGroupList: this.group,\n                    topoNodeList: this.node,\n                };\n            },\n            /**\n             * @desc 选择结果的展示\n             * @returns {String}\n             */\n            resultText () {\n                const {\n                    dynamicGroupList = [],\n                    ipList = [],\n                    topoNodeList = [],\n                } = this.hostNodeInfoLocal;\n\n                const result = [];\n                if (ipList.length > 0) {\n                    result.push(`<span class=\"strong number choose-host\">${ipList.length}</span>${'台主机'}`);\n                }\n                if (topoNodeList.length > 0) {\n                    result.push(`<span class=\"strong number choose-node\">${topoNodeList.length}</span>${'个节点'}`);\n                }\n                if (dynamicGroupList.length > 0) {\n                    result.push(`<span class=\"strong number choose-group\">${dynamicGroupList.length}</span>${'个分组'}`);\n                }\n                if (result.length < 1) {\n                    return `（${'暂无已选项'}）`;\n                }\n                return `（${result.join('，')}）`;\n            },\n        },\n        watch: {\n            hostNodeInfo: {\n                handler (hostNodeInfo) {\n                    this.hostNodeInfoLocal = Object.freeze(hostNodeInfo);\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.innerChange = false;\n        },\n        methods: {\n            getElementTarget () {\n                return document.querySelector('#chooseIPServerPreview');\n            },\n            handleServerPanelChange (hostNodeInfo) {\n                this.innerChange = true;\n                this.hostNodeInfoLocal = Object.freeze(hostNodeInfo);\n            },\n            handleSubmit () {\n                if (this.innerChange) {\n                    this.$emit('on-change', this.hostNodeInfoLocal);\n                }\n                this.handleClose();\n            },\n            handleClose () {\n                this.innerChange = false;\n                this.$emit('input', false);\n                this.$emit('change', false);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .server-preview {\n        position: absolute;\n        top: 0;\n        right: 0;\n        bottom: 0;\n        left: 0;\n        z-index: 9;\n        display: flex;\n        flex-direction: column;\n        background: #fff;\n\n        .preview-header {\n            display: flex;\n            align-items: center;\n            flex: 0 0 68px;\n            height: 68px;\n            padding-left: 24px;\n            margin-bottom: -1px;\n            font-size: 20px;\n            color: #000;\n            border-bottom: 1px solid #dcdee5;\n\n            .server-description {\n                padding-top: 6px;\n                margin-left: 12px;\n                font-size: 12px;\n                line-height: 1em;\n                color: #63656e;\n            }\n        }\n\n        .preview-footer {\n            display: flex;\n            align-items: center;\n            justify-content: flex-end;\n            height: 60px;\n            padding-right: 24px;\n            background: #fafbfd;\n        }\n    }\n</style>\n","<template>\n    <lower-component level=\"custom\" :custom=\"isShowDialog\">\n        <jb-dialog\n            v-model=\"isShowDialog\"\n            class=\"choose-ip-dialog\"\n            :mask-close=\"false\"\n            :esc-close=\"false\"\n            :draggable=\"false\"\n            :width=\"1240\"\n            :media=\"mediaWidth\">\n            <div class=\"choose-ip-container\" :style=\"containerStyles\">\n                <template v-if=\"isShowDialog\">\n                    <div class=\"action-tab\">\n                        <div class=\"tab-container\">\n                            <div class=\"tab-item\" :class=\"{ active: activeTab === 'static' }\" @click=\"handleTabChange('static')\">\n                                {{ '静态 - IP 选择' }}\n                            </div>\n                            <div class=\"tab-item\" :class=\"{ active: activeTab === 'dynamic' }\" @click=\"handleTabChange('dynamic')\">\n                                {{ '动态 - 拓扑选择' }}\n                            </div>\n                            <div class=\"tab-item\" :class=\"{ active: activeTab === 'group' }\" @click=\"handleTabChange('group')\">\n                                {{ '动态 - 分组选择' }}\n                            </div>\n                            <div class=\"tab-item\" :class=\"{ active: activeTab === 'input' }\" @click=\"handleTabChange('input')\">\n                                {{ '手动输入' }}\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"action-content\" :style=\"contentStyles\">\n                        <keep-alive>\n                            <component\n                                ref=\"dataTree\"\n                                :is=\"panelCom\"\n                                class=\"fade-in\"\n                                :preview-id=\"previewId\"\n                                :topology-node-tree=\"topologyNodeTree\"\n                                :ip-list=\"ipList\"\n                                :topo-node-list=\"topoNodeList\"\n                                :dynamic-group-list=\"dynamicGroupList\"\n                                :topology-loading=\"isLoading\"\n                                :dialog-height=\"dialogHeight\"\n                                @on-group-preview=\"handleGroupPreview\"\n                                @on-input-change=\"handleInputChange\"\n                                @on-input-animate=\"handleInputAnimate\"\n                                @on-change=\"handleChange\" />\n                        </keep-alive>\n                    </div>\n                </template>\n            </div>\n            <template v-if=\"showGroupPreview\">\n                <preview-group v-model=\"showGroupPreview\" :data=\"previewGroup\" />\n            </template>\n            <template v-if=\"showChoosePreview\">\n                <preview\n                    v-model=\"showChoosePreview\"\n                    :host=\"ipList\"\n                    :node=\"topoNodeList\"\n                    :group=\"dynamicGroupList\"\n                    @on-change=\"handlePreviewChange\">\n                    <div slot=\"desc\" v-html=\"actionResult\" />\n                </preview>\n            </template>\n            <template slot=\"footer\">\n                <span v-if=\"error\" class=\"ip-error\">{{ error }}</span>\n                <div\n                    :id=\"previewId\"\n                    class=\"choose-result\"\n                    :class=\"currentChangeClass\"\n                    v-html=\"actionResult\"\n                    @click=\"handleShowChoosePreview\" />\n                <jb-popover-confirm\n                    v-if=\"ipInputStatus\"\n                    :title=\"'操作确认'\"\n                    :content=\"'手动输入框有内容未添加到“已选择”列表，确认结束操作？'\"\n                    :confirm-handler=\"handleSubmit\">\n                    <bk-button class=\"mr10\" theme=\"primary\">{{ '确定' }}</bk-button>\n                </jb-popover-confirm>\n                <bk-button\n                    v-if=\"!ipInputStatus\"\n                    class=\"mr10\"\n                    theme=\"primary\"\n                    \n                    @click=\"handleSubmit\">\n                    {{ '确定' }}\n                </bk-button>\n                <bk-button @click=\"handleCancle\">{{ '取消' }}</bk-button>\n            </template>\n        </jb-dialog>\n    </lower-component>\n</template>\n<script>\n    import _ from 'lodash';\n    import AppService from '@service/app-manage';\n       import TaskHostNodeModel from '@model/task-host-node';\n    import {\n        bigTreeTransformTopologyOfTopology,\n        mergeInputHost,\n        mergeTopologyHost,\n        generateHostRealId,\n    } from './components/utils';\n    import RenderBusinessTopology from './components/render-business-topology';\n    import RenderDynamicBusinessTopology from './components/render-dynamic-business-topology';\n    import RenderDynamicGroup from './components/render-dynamic-group';\n    import RenderIpInput from './components/render-ip-input';\n    import PreviewGroup from './components/preview-group';\n    import SidesliderBox from './components/sideslider-box';\n    import Preview from './preview';\n\n    const DIALOG_FOOTER_HEIGHT = 58;\n    const CONTENT_TAB_HEIGHT = 42;\n\n    export default {\n        name: 'ChooseIp',\n        components: {\n            RenderBusinessTopology,\n            RenderDynamicBusinessTopology,\n            RenderDynamicGroup,\n            RenderIpInput,\n            PreviewGroup,\n            SidesliderBox,\n            Preview,\n        },\n        model: {\n            prop: 'show',\n            event: 'input',\n        },\n        props: {\n            // 显示弹框\n            show: {\n                type: Boolean,\n                default: false,\n            },\n            // 传入主机节点值\n            hostNodeInfo: {\n                type: Object,\n                default: () => new TaskHostNodeModel({}).hostNodeInfo,\n            },\n            // 是否必填\n            required: {\n                type: Boolean,\n                default: false,\n            },\n            // 错误提示\n            errorTips: {\n                type: String,\n                default: '服务器不能为空',\n            },\n        },\n        data () {\n            this.ipListTopolagyLast = [];\n            return {\n                isShowDialog: false,\n                isLoading: true,\n                isSubmitDisable: false,\n                // 预览结果\n                showChoosePreview: false,\n                // 预览节点合分组的主机详情\n                showGroupPreview: false,\n                activeTab: 'static',\n                // 弹框的高度\n                dialogHeight: 0,\n                topologyNodeTree: [],\n                topoNodeList: [{},{},{}],\n                ipList: [{},{},{}],\n                dynamicGroupList: [{},{},{}],\n                previewGroup: {},\n                error: '',\n                currentChangeClass: '',\n                //  手动的输入的内容是否提交\n                ipInputStatus: false,\n            };\n        },\n        computed: {\n            /**\n             * @desc 渲染tab组件\n             * @returns {Object}\n             */\n            panelCom () {\n                const comMap = {\n                    static: RenderBusinessTopology,\n                    dynamic: RenderDynamicBusinessTopology,\n                    group: RenderDynamicGroup,\n                    input: RenderIpInput,\n                };\n                return comMap[this.activeTab];\n            },\n            /**\n             * @desc 弹框内容区样式\n             * @returns {Object}\n             */\n            containerStyles () {\n                return {\n                    height: `${this.dialogHeight - DIALOG_FOOTER_HEIGHT}px`,\n                };\n            },\n            /**\n             * @desc tab内容区样式\n             * @returns {Object}\n             */\n            contentStyles () {\n                return {\n                    height: `${this.dialogHeight - DIALOG_FOOTER_HEIGHT - CONTENT_TAB_HEIGHT}px`,\n                };\n            },\n            /**\n             * @desc 主机是否为空\n             * @returns {Boolean}\n             */\n            isEmpty () {\n                return !this.topoNodeList.length && !this.ipList.length && !this.dynamicGroupList.length;\n            },\n            /**\n             * @desc 选择结果的展示\n             * @returns {String}\n             */\n            actionResult () {\n                const result = [];\n                if (this.ipList.length > 0) {\n                    result.push(`<span class=\"strong number choose-host\">${this.ipList.length}</span>${'台主机'}`);\n                }\n                if (this.topoNodeList.length > 0) {\n                    result.push(`<span class=\"strong number choose-node\">${this.topoNodeList.length}</span>${'个节点'}`);\n                }\n                if (this.dynamicGroupList.length > 0) {\n                    result.push(`<span class=\"strong number choose-group\">${this.dynamicGroupList.length}</span>${'个分组'}`);\n                }\n                if (result.length < 1) {\n                    return '';\n                }\n                let resultText = result.join('，');\n                if (resultText) {\n                    resultText = `<span>${'已选择'}：</span>${resultText}`;\n                }\n                return resultText;\n            },\n        },\n        watch: {\n            show: {\n                /**\n                 * @desc 每次打开重新拉取拓扑节点树\n                 * @param {Boolean} show 显示 ip 选择器\n                 */\n                handler (show) {\n                    if (show) {\n                        this.fetchTopologyWithCount();\n                    }\n                    this.ipInputStatus = false;\n                    this.isShowDialog = show;\n                    this.isSubmitDisable = false;\n                },\n                immediate: true,\n            },\n            hostNodeInfo: {\n                /**\n                 * @desc 处理默认值\n                 * @param {Object} hostNodeInfo 主机信息\n                 */\n                handler (hostNodeInfo) {\n                    if (this.isSelfChange) {\n                        this.isSelfChange = false;\n                        return;\n                    }\n                    const {\n                        dynamicGroupList = [],\n                        ipList = [],\n                        topoNodeList = [],\n                    } = hostNodeInfo;\n\n                    this.topoNodeList = Object.freeze([\n                        ...topoNodeList,\n                    ]);\n                    this.ipList = Object.freeze(ipList.map(host => Object.assign({\n                        realId: generateHostRealId(host),\n                        ...host,\n                    })));\n                    this.ipListTopolagyLast = this.ipList;\n                    this.dynamicGroupList = Object.freeze(dynamicGroupList);\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.previewId = `chooseIPPreview_${_.random(1, 99999999)}`;\n            this.isSelfChange = false;\n            this.hostInput = [];\n            this.mediaWidth = [\n                1240, 1400, 1560, 1720,\n            ];\n        },\n        mounted () {\n            this.calcDialogHeight();\n        },\n        methods: {\n            /**\n             * @desc 获取拓扑节点树\n             */\n            fetchTopologyWithCount () {\n                this.isLoading = true;\n                AppService.fetchTopologyWithCount()\n                    .then((data) => {\n                        this.topologyNodeTree = Object.freeze(bigTreeTransformTopologyOfTopology([\n                            data,\n                        ]));\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 动态计算弹框高度占浏览器窗口的 80%\n             */\n            calcDialogHeight () {\n                const dialogHeight = window.innerHeight * 0.8;\n                this.dialogHeight = dialogHeight < 660 ? 660 : dialogHeight;\n            },\n            /**\n             * @desc tab 面板切换\n             */\n            handleTabChange (payload) {\n                this.activeTab = payload;\n            },\n            /**\n             * @desc 选择值\n             * @param {String} field 更新的字段名\n             * @param {Any} value 字段值\n             *\n             * 静态 ip 选择和手动输入的结果需要合并\n             */\n            handleChange (field, value) {\n                this.error = '';\n                switch (field) {\n                    case 'ipList':\n                        this.ipList = Object.freeze(mergeTopologyHost(this.ipList, this.ipListTopolagyLast, value));\n                        this.ipListTopolagyLast = value;\n                        this.currentChangeClass = 'host';\n                        break;\n                    case 'ipInput':\n                        this.ipList = Object.freeze(mergeInputHost(this.ipList, value));\n                        this.currentChangeClass = 'host';\n                        break;\n                    case 'topoNodeList':\n                        this.topoNodeList = Object.freeze(value);\n                        this.currentChangeClass = 'node';\n                        break;\n                    case 'dynamicGroupList':\n                        this.dynamicGroupList = Object.freeze(value);\n                        this.currentChangeClass = 'group';\n                        break;\n                    default:\n                        return '';\n                }\n            },\n            /**\n             * @desc 手动输入的输入状态\n             *\n             * 有输入结果但是没有添加需要给出提示结果\n             */\n            handleInputChange (status) {\n                this.ipInputStatus = status;\n            },\n            /**\n             * @desc 手动输入的动画状态\n             * @param {Boolean} running 动画是否运行中\n             *\n             * 动画没结束禁止提交\n             */\n            handleInputAnimate (running) {\n                this.isSubmitDisable = running;\n            },\n            /**\n             * @desc 预览结果\n             */\n            handleShowChoosePreview () {\n                this.showChoosePreview = true;\n            },\n            /**\n             * @desc 手动输入的动画状态\n             * @param {Object} hostNodeInfo 主机信息\n             *\n             */\n            handlePreviewChange (hostNodeInfo) {\n                const {\n                    dynamicGroupList,\n                    ipList,\n                    topoNodeList,\n                } = hostNodeInfo;\n                this.topoNodeList = Object.freeze(topoNodeList);\n                this.ipList = Object.freeze(ipList);\n                this.dynamicGroupList = Object.freeze(dynamicGroupList);\n            },\n            /**\n             * @desc 查看分组的主机详情\n             * @param {Object} groupInfo 分组信息\n             *\n             */\n            handleGroupPreview (groupInfo) {\n                this.previewGroup = groupInfo;\n                this.showGroupPreview = true;\n            },\n            /**\n             * @desc 外部调用，重置选中状态\n             */\n            reset () {\n                this.topoNodeList = [];\n                this.ipList = [];\n                this.dynamicGroupList = [];\n            },\n            /**\n             * @desc 弹框关闭\n             */\n            close () {\n                this.activeTab = 'static';\n                this.$emit('on-cancel');\n                this.$emit('input', false);\n            },\n            /**\n             * @desc 提交操作结果\n             */\n            handleSubmit () {\n                return Promise.resolve()\n                    .then(() => {\n                        if (this.required && this.isEmpty) {\n                            this.error = '源文件的服务器列表不允许为空';\n                            return;\n                        }\n                        \n                        // 保证先关闭jb-popover-confirm，再关闭dialog\n                        Promise.resolve()\n                            .then(() => {\n                                this.isSelfChange = true;\n                                this.$emit('on-change', {\n                                    ipList: this.ipList,\n                                    topoNodeList: this.topoNodeList,\n                                    dynamicGroupList: this.dynamicGroupList,\n                                });\n                                this.close();\n                            });\n                    });\n            },\n            /**\n             * @desc 取消当前操作\n             *\n             * 重置默认数据\n             */\n            handleCancle () {\n                const {\n                    dynamicGroupList = [],\n                    ipList = [],\n                    topoNodeList = [],\n                } = this.hostNodeInfo;\n\n                this.topoNodeList = Object.freeze([\n                    ...topoNodeList,\n                ]);\n                this.ipList = Object.freeze(ipList.map(host => ({\n                    ...host,\n                    realId: generateHostRealId(host),\n                })));\n                this.dynamicGroupList = Object.freeze(dynamicGroupList);\n                this.ipListTopolagyLast = this.ipList;\n                this.isShowDialog = false;\n                this.close();\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    @keyframes fade-in {\n        from {\n            opacity: 10%;\n        }\n\n        to {\n            opacity: 100%;\n        }\n    }\n\n    @keyframes choose-result-ani {\n        0% {\n            transform: scale(1.5);\n        }\n\n        25% {\n            transform: scale(1.2);\n        }\n\n        50% {\n            transform: scale(1.4);\n        }\n\n        75% {\n            transform: scale(1.1);\n        }\n\n        100% {\n            transform: scale(0);\n        }\n    }\n\n    .choose-ip-dialog {\n        .bk-dialog-wrapper {\n            padding-top: 20px;\n            padding-bottom: 20px;\n            overflow-y: scroll;\n            text-align: center;\n\n            &::-webkit-scrollbar {\n                width: 0;\n            }\n\n            &::after {\n                display: inline-block;\n                width: 0;\n                height: 100%;\n                vertical-align: middle;\n                content: \"\";\n            }\n        }\n\n        .bk-dialog {\n            display: inline-block;\n            height: auto;\n            text-align: left;\n            vertical-align: middle;\n\n            .bk-dialog-tool {\n                display: none;\n            }\n\n            .bk-dialog-content {\n                margin-bottom: 0 !important;\n            }\n\n            .bk-dialog-body {\n                padding: 0;\n            }\n\n            .bk-dialog-footer {\n                display: flex;\n                justify-content: flex-end;\n            }\n        }\n\n        .choose-ip-container {\n            .action-tab {\n                position: relative;\n                z-index: 2;\n                display: flex;\n                flex-direction: column;\n\n                .tab-container {\n                    display: flex;\n                    background: #fafbfd;\n                }\n\n                .tab-item {\n                    display: flex;\n                    height: 42px;\n                    cursor: pointer;\n                    border-right: 1px solid #dcdee5;\n                    border-bottom: 1px solid #dcdee5;\n                    flex: 1;\n                    align-items: center;\n                    justify-content: center;\n\n                    &.active {\n                        background: #fff;\n                        border-bottom-color: transparent;\n                    }\n                }\n            }\n        }\n\n        .bk-big-tree-node.is-selected {\n            .node-box {\n                .node-count {\n                    color: #fff;\n                    background: #a3c5fd;\n                }\n            }\n        }\n\n        .node-box {\n            display: flex;\n            align-items: center;\n\n            .node-filter {\n                height: 1em;\n                padding-left: 7px;\n                margin-right: 10px;\n                margin-left: 10px;\n                font-size: 12px;\n                line-height: 1em;\n                color: #979ba5;\n                border-left: 1px solid #dcdee5;\n                user-select: none;\n            }\n\n            .node-count {\n                display: flex;\n                height: 17px;\n                padding: 0 4px;\n                margin-left: auto;\n                font-size: 12px;\n                color: #979ba5;\n                background: #f0f1f5;\n                border-radius: 2px;\n                align-items: center;\n            }\n        }\n\n        .line-checkbox {\n            position: relative;\n            display: inline-block;\n            width: 16px;\n            height: 16px;\n            overflow: hidden;\n            font-size: 0;\n            line-height: 18px;\n            vertical-align: middle;\n            cursor: pointer;\n            border: 1px solid #3a84ff;\n            border-radius: 2px;\n\n            &::after {\n                position: absolute;\n                top: 1px;\n                left: 4px;\n                width: 4px;\n                height: 8px;\n                border: 2px solid #3a84ff;\n                border-top: 0;\n                border-left: 0;\n                content: \"\";\n                transform: rotate(45deg) scaleY(1);\n                transform-origin: center;\n            }\n        }\n\n        .choose-all-tips {\n            height: 30px !important;\n            font-size: 12px !important;\n            text-align: center !important;\n\n            .strong {\n                color: inherit;\n            }\n\n            .all-change {\n                color: #3a84ff;\n                cursor: pointer;\n            }\n        }\n\n        .choose-result {\n            display: flex;\n            height: 32px;\n            padding: 0 4px;\n            margin-right: auto;\n            font-size: 14px;\n            line-height: 32px;\n            color: #63656e;\n            cursor: pointer;\n            border-radius: 2px;\n\n            &:hover {\n                background: #ebecf0;\n            }\n\n            &.host {\n                .choose-host {\n                    animation: choose-result-ani 0.35s;\n                }\n            }\n\n            &.node {\n                .choose-node {\n                    animation: choose-result-ani 0.35s;\n                }\n            }\n\n            &.group {\n                .choose-group {\n                    animation: choose-result-ani 0.35s;\n                }\n            }\n        }\n\n        .ip-error {\n            margin-right: 10px;\n            font-size: 12px;\n            color: #ff5656;\n        }\n\n        .fade-in {\n            animation: fade-in 0.6s linear;\n        }\n    }\n</style>\n","<template>\n    <div class=\"variable-type-host\" :class=\"{ 'variable-value-error': isError }\">\n        <div>\n            <div>\n                <bk-button\n                    class=\"mr10\"\n                    \n                    @click=\"handleChooseIp\"\n                    v-bk-tooltips=\"descPopover\">\n                    <Icon type=\"plus\" />\n                    {{ '添加服务器' }}\n                </bk-button>\n                <bk-button\n                    v-show=\"isNotEmpty\"\n                    \n                    @click=\"handleClear\">\n                    {{ '清空' }}\n                </bk-button>\n            </div>\n            <server-panel\n                v-show=\"isNotEmpty\"\n                ref=\"choostIP\"\n                class=\"host-value-panel\"\n                :host-node-info=\"hostNodeInfo\"\n                detail-fullscreen\n                :editable=\"!readonly\"\n                @on-change=\"handleChange\" />\n            <p v-if=\"isError\" class=\"variable-error\">{{ '该变量的值必填' }}</p>\n        </div>\n        <choose-ip\n            v-model=\"isShowChooseIp\"\n            :host-node-info=\"hostNodeInfo\"\n            @on-change=\"handleChange\" />\n    </div>\n</template>\n<script>\n    import TaskHostNodeModel from '@model/task-host-node';\n    import ChooseIp from '@components/choose-ip';\n    import ServerPanel from '@components/choose-ip/server-panel';\n\n    export default {\n        components: {\n            ChooseIp,\n            ServerPanel,\n        },\n        props: {\n            data: {\n                type: Object,\n                required: true,\n            },\n            readonly: {\n                type: Boolean,\n                default: false,\n            },\n        },\n        data () {\n            return {\n                isShowChooseIp: false,\n                hostNodeInfo: {},\n            };\n        },\n        computed: {\n            isNotEmpty () {\n                return !TaskHostNodeModel.isHostNodeInfoEmpty(this.hostNodeInfo);\n            },\n            isError () {\n                if (this.data.required !== 1) {\n                    return false;\n                }\n                return !this.isNotEmpty;\n            },\n            descPopover () {\n                return {\n                    theme: 'light',\n                    extCls: 'variable-desc-tippy',\n                    trigger: 'click mouseenter',\n                    hideOnClick: false,\n                    content: this.data.description,\n                    disabled: !this.data.description,\n                };\n            },\n        },\n        created () {\n            this.init();\n        },\n        methods: {\n            /**\n             * @desc 解析默认值\n             */\n            init () {\n                if (this.data.defaultTargetValue) {\n                    this.hostNodeInfo = this.data.defaultTargetValue.hostNodeInfo;\n                } else {\n                    this.hostNodeInfo = this.data.targetValue.hostNodeInfo;\n                }\n            },\n            /**\n             * @desc 外部调用——移除无效主机\n             */\n            removeAllInvalidHost () {\n                window.changeAlert = true;\n                this.$refs.choostIP.removeAllInvalidHost();\n            },\n            /**\n             * @desc 编辑主机列表\n             */\n            handleChooseIp () {\n                this.isShowChooseIp = true;\n            },\n            /**\n             * @desc 清空主机列表\n             */\n            handleClear () {\n                const { hostNodeInfo } = new TaskHostNodeModel({});\n                this.hostNodeInfo = hostNodeInfo;\n                window.changeAlert = true;\n            },\n            /**\n             * @desc 提交编辑的数据\n             */\n            handleChange (hostNodeInfo) {\n                this.hostNodeInfo = Object.freeze(hostNodeInfo);\n                window.changeAlert = true;\n            },\n            /**\n             * @desc 外部调用——还原默认值\n             */\n            reset () {\n                this.init();\n            },\n            /**\n             * @desc 外部调用——值验证\n             * @returns {Promise}\n             */\n            validate () {\n                const { type, id, name } = this.data;\n                \n                const data = {\n                    id,\n                    name,\n                    type,\n                    value: '',\n                    targetValue: {\n                        hostNodeInfo: this.hostNodeInfo,\n                    },\n                };\n                return new Promise((resolve, reject) => {\n                    if (this.isError) {\n                        return reject(new Error('host error'));\n                    }\n                    resolve(data);\n                });\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .variable-type-host {\n        .host-value-panel {\n            margin-top: 10px;\n        }\n    }\n\n</style>\n","<template>\n    <div class=\"global-variable-edit-box\" ref=\"varBox\" :class=\"boxClasses\">\n        <div class=\"variable-name\" ref=\"varName\">\n            <span class=\"name-text\">{{ data.name }}</span>\n        </div>\n        <div class=\"variable-value\" ref=\"varValue\">\n            <component\n                ref=\"target\"\n                :is=\"typeCom\"\n                :data=\"data\"\n                :placement=\"placement\"\n                v-bind=\"$attrs\"\n                v-on=\"$listeners\" />\n        </div>\n    </div>\n</template>\n<script>\n    import VariableModel from '@model/task/global-variable';\n    import TypeString from './string';\n    import TypeNamespace from './namespace';\n    import TypeHost from './host';\n    import TypePassword from './password';\n    import TypeArray from './array';\n\n    export default {\n        props: {\n            type: {\n                type: Number,\n                required: true,\n            },\n            data: {\n                type: Object,\n                required: true,\n            },\n            layout: {\n                type: String,\n                default: 'horizontal', // 水平：horizontal；垂直：vertical\n            },\n        },\n        data () {\n            return {\n                isError: false,\n                placement: '',\n            };\n        },\n        computed: {\n            typeCom () {\n                const comMap = {\n                    1: TypeString,\n                    2: TypeNamespace,\n                    3: TypeHost,\n                    4: TypePassword,\n                    5: TypeArray,\n                    6: TypeArray,\n                };\n                if (!Object.prototype.hasOwnProperty.call(comMap, this.type)) {\n                    return 'div';\n                }\n                \n                return comMap[this.type];\n            },\n            boxClasses () {\n                const classes = {\n                    'variable-required': this.data.required === 1,\n                };\n                if (this.layout === 'vertical') {\n                    classes.vertical = true;\n                }\n                return classes;\n            },\n        },\n        mounted () {\n            if (this.type === VariableModel.TYPE_HOST) {\n                this.placement = 'right';\n                return;\n            }\n            const containerWidth = this.$refs.varBox.clientWidth;\n            const labelWith = this.$refs.varName.clientWidth;\n            const valueWith = this.$refs.varValue.clientWidth;\n            this.placement = labelWith + valueWith + 220 > containerWidth ? 'top' : 'right';\n        },\n        methods: {\n            /**\n             * @desc 外部调用——移除主机变量中的无效主机\n             */\n            removeAllInvalidHost () {\n                this.$refs.target.removeAllInvalidHost && this.$refs.target.removeAllInvalidHost();\n            },\n            /**\n             * @desc 外部调用——移除主机变量中的无效主机\n             */\n            reset () {\n                this.$refs.target.reset();\n            },\n            validate () {\n                return this.$refs.target.validate()\n                    .then((data) => {\n                        this.isError = false;\n                        return Promise.resolve(data);\n                    })\n                    .catch((err) => {\n                        this.isError = true;\n                        document.querySelector('.variable-value-error').scrollIntoView();\n                        return Promise.reject(err);\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .global-variable-edit-box {\n        display: flex;\n        flex: 1;\n        margin-bottom: 20px;\n\n        &.variable-required {\n            .variable-name {\n                white-space: normal;\n\n                .name-text {\n                    margin-right: -10px;\n\n                    &::after {\n                        width: 10px;\n                        margin-left: 0.2em;\n                        color: #ea3636;\n                        content: \"*\";\n                    }\n                }\n            }\n        }\n\n        .variable-name {\n            padding-right: 28px;\n            font-size: 14px;\n            line-height: 32px;\n            color: #666;\n            text-align: right;\n            box-sizing: content-box;\n\n            .name-text {\n                white-space: nowrap;\n            }\n        }\n\n        .variable-value {\n            flex: 1;\n            max-width: 960px;\n        }\n\n        .variable-value-error {\n            .bk-form-input {\n                color: #ff5656;\n                border-color: #ff5656;\n            }\n        }\n\n        .variable-error {\n            margin-top: 4px;\n            margin-bottom: -6px;\n            font-size: 12px;\n            line-height: 1;\n            color: #ea3636;\n        }\n    }\n\n    .variable-desc-tippy {\n        .tippy-content {\n            max-width: 200px;\n            white-space: normal;\n        }\n    }\n</style>\n","<template>\n    <div class=\"toggle-display\">\n        <div\n            class=\"action\"\n            :class=\"{\n                open: isOpen,\n            }\"\n            @click=\"handleToggle\">\n            <template v-if=\"isOpen\">\n                <Icon type=\"angle-double-up\" class=\"toggle-arrow\" />\n                <span>{{ '收起未引用的变量' }} ({{ count }})</span>\n            </template>\n            <template v-else>\n                <Icon type=\"angle-double-down\" class=\"toggle-arrow\" />\n                <span>{{ '展开未引用的变量' }} ({{ count }})</span>\n            </template>\n        </div>\n        <div v-if=\"isOpen\">\n            <slot />\n        </div>\n    </div>\n</template>\n<script>\n    export default {\n        name: 'globalVariableToggleDisplay',\n        props: {\n            count: {\n                type: Number,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                isOpen: false,\n            };\n        },\n        methods: {\n            handleToggle () {\n                this.isOpen = !this.isOpen;\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .toggle-display {\n        .action {\n            display: flex;\n            align-items: center;\n            height: 32px;\n            font-size: 14px;\n            color: #3a84ff;\n            cursor: pointer;\n            border-radius: 2px;\n            user-select: none;\n\n            &.open {\n                padding-left: 8px;\n                background: #e1ecff;\n            }\n        }\n\n        .toggle-arrow {\n            margin-right: 3px;\n            font-size: 12px;\n        }\n    }\n</style>\n","\n\n<template functional>\n    <div class=\"card-box\">\n        <div class=\"card-title\">{{ props.title }}</div>\n        <slot />\n    </div>\n</template>\n\n<style lang='postcss' scoped>\n    .card-box {\n        padding: 12px 20px 10px;\n\n        /* box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.1); */\n        background: #fff;\n        border: 1px solid #dde4eb;\n    }\n\n    .card-title {\n        margin-bottom: 30px;\n        font-size: 14px;\n        font-weight: bold;\n        line-height: 1;\n        color: #63656e;\n    }\n</style>\n","<template>\n    <jb-form-item :label=\"'错误处理'\">\n        <div class=\"error-handle-wraper\">\n            <bk-checkbox\n                v-bk-tooltips=\"tips\"\n                :value=\"formData[field]\"\n                :true-value=\"1\"\n                :false-value=\"0\"\n                @change=\"handleChange\">\n                {{ '自动忽略错误' }}\n            </bk-checkbox>\n        </div>\n    </jb-form-item>\n</template>\n<script>\n   \n    export default {\n        name: '',\n        props: {\n            field: {\n                type: String,\n                required: true,\n            },\n            formData: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        created () {\n            this.tips = {\n                content: '步骤有执行失败的目标，将会自动忽略并进入下一步',\n                width: 310,\n                placement: 'right',\n            };\n        },\n        methods: {\n            handleChange (value) {\n                this.$emit('on-change', this.field, value);\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .error-handle-wraper {\n        display: flex;\n        align-items: center;\n        height: 100%;\n\n        .bk-checkbox-text {\n            border-bottom: 1px dashed #c4c6cc;\n        }\n    }\n</style>\n","<template>\n    <div class=\"source-file-action-extend\" @click.stop=\"\" @mouseleave=\"handleHide\">\n        <Icon type=\"more\" />\n        <div\n            ref=\"popoverContent\"\n            class=\"source-file-action-content\"\n            @click=\"handleWraperClick\"\n            @mouseover=\"handleShow\"\n            @mouseleave=\"handleClose\">\n            <slot />\n        </div>\n    </div>\n</template>\n<script>\n    const instanceMap = {};\n\n    export default {\n        name: 'SourceFileExtendAction',\n        created () {\n            this.id = `action_extend_${Math.random()}_${Date.now()}`;\n        },\n        mounted () {\n            this.init();\n        },\n        beforeDestroy () {\n            instanceMap[this.id].hide();\n            delete instanceMap[this.id];\n        },\n        methods: {\n            init () {\n                instanceMap[this.id] = this.$bkPopover(this.$el, {\n                    theme: 'source-file-action-extend-popover',\n                    interactive: true,\n                    placement: 'bottom',\n                    content: this.$refs.popoverContent,\n                    trigger: 'mouseover',\n                    arrow: true,\n                    onShow: () => {\n                        Object.keys(instanceMap).forEach((key) => {\n                            if (key !== this.id) {\n                                instanceMap[key].hide();\n                            }\n                        });\n                    },\n                });\n            },\n            handleWraperClick () {\n                this.handleClose();\n            },\n            handleHide () {\n                this.leaveTimer = setTimeout(() => {\n                    this.handleClose();\n                }, 3000);\n            },\n            handleShow () {\n                clearTimeout(this.leaveTimer);\n            },\n            handleClose () {\n                instanceMap[this.id] && instanceMap[this.id].hide();\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    html[lang=\"en-US\"] {\n        .source-file-action-content {\n            width: 154px;\n        }\n    }\n\n    .source-file-action-extend {\n        position: absolute;\n        top: 50%;\n        right: 16px;\n        z-index: 9;\n        display: flex;\n        width: 30px;\n        height: 30px;\n        font-size: 16px;\n        font-weight: normal;\n        color: #979ba5;\n        cursor: pointer;\n        border-radius: 50%;\n        transform: translateY(-50%);\n        user-select: none;\n        align-items: center;\n        justify-content: center;\n\n        &:hover,\n        &.tippy-active {\n            z-index: 10;\n            color: #3a84ff;\n            background: #dcdee5;\n        }\n    }\n\n    .source-file-action-extend-popover-theme {\n        padding: 0 !important;\n\n        .tippy-arrow {\n            display: none;\n        }\n\n        .source-file-action-content {\n            width: 93px;\n            font-size: 14px;\n            line-height: 32px;\n            color: #63656e;\n            background: #fff;\n            border: 1px solid #f0f1f5;\n            box-shadow: 0 2px 1px 0 rgb(185 203 222 / 50%);\n\n            .action-item {\n                padding-left: 15px;\n                cursor: pointer;\n\n                &:hover {\n                    color: #3a84ff;\n                    background: #e5efff;\n                }\n            }\n        }\n    }\n\n</style>\n","\n\n<template functional>\n    <div class=\"list-action-layout\">\n        <div class=\"right-box\">\n            <slot />\n        </div>\n        <div class=\"left-box\">\n            <slot name=\"right\" />\n        </div>\n    </div>\n</template>\n<style lang=\"postcss\">\n    .list-action-layout {\n        display: flex;\n        align-items: center;\n        margin-bottom: 20px;\n\n        .right-box {\n            display: flex;\n\n            & > * {\n                margin-right: 8px;\n            }\n        }\n\n        .left-box {\n            display: flex;\n            margin-left: auto;\n\n            & > * {\n                margin-left: 8px;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"render-related-script\">\n        <div class=\"tab-wraper\">\n            <div\n                class=\"tab-item\"\n                :class=\"{ active: listTab === 'template' }\"\n                @click=\"handleTabChange('template')\">\n                <div class=\"tab-name\">{{ '作业模板引用' }}</div>\n                <div class=\"tab-nums\">{{ info.relatedTaskTemplateNum }}</div>\n            </div>\n            <div\n                class=\"tab-item\"\n                :class=\"{ active: listTab === 'plan' }\"\n                @click=\"handleTabChange('plan')\">\n                <div class=\"tab-name\">{{ '执行方案引用' }}</div>\n                <div class=\"tab-nums\">{{ info.relatedTaskPlanNum }}</div>\n            </div>\n        </div>\n        <component\n            :is=\"listCom\"\n            :params=\"params\" />\n    </div>\n</template>\n<script>\n    import TemplateList from './template-list.vue';\n    import PlanList from './plan-list.vue';\n\n    export default {\n        name: 'RenderRelatedScript',\n        \n        props: {\n            mode: {\n                type: String,\n                validator (value) {\n                    return [\n                        'scriptList',\n                        'scriptVersionList',\n                    ].includes(value);\n                },\n                default: 'scriptList',\n            },\n            info: {\n                type: Object,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                listTab: 'template',\n            };\n        },\n        computed: {\n            listCom () {\n                const componentMap = {\n                    template: TemplateList,\n                    plan: PlanList,\n                };\n                return componentMap[this.listTab];\n            },\n            params () {\n                const params = {\n                    scriptId: this.info.id,\n                };\n                if (this.mode === 'scriptVersionList') {\n                    params.scriptVersionId = this.info.scriptVersionId;\n                }\n                return params;\n            },\n        },\n        methods: {\n            handleTabChange (tab) {\n                this.listTab = tab;\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .render-related-script {\n        .tab-wraper {\n            display: flex;\n            padding: 20px 30px 0;\n            margin: -20px -30px 20px;\n            background: #f5f6fa;\n            border-bottom: 1px solid #dcdee5;\n\n            .tab-item {\n                display: flex;\n                height: 32px;\n                padding: 0 12px;\n                margin-right: 20px;\n                margin-bottom: -1px;\n                font-size: 13px;\n                line-height: 32px;\n                color: #63656e;\n                cursor: pointer;\n                background: #e1e3eb;\n                border: 1px solid #e1e3eb;\n                border-bottom: none;\n                border-top-right-radius: 4px;\n                border-top-left-radius: 4px;\n                transition: all 0.15s;\n                align-items: center;\n\n                &.active {\n                    color: ##313238;\n                    background: #fff;\n                    border-color: #dcdee5;\n\n                    .tab-nums {\n                        color: #63656e;\n                        background: #ebecf0;\n                    }\n\n                    .loading-flag {\n                        color: #fff;\n                    }\n                }\n            }\n\n            .tab-name {\n                margin-right: 4px;\n            }\n\n            .tab-nums {\n                height: 16px;\n                padding: 0 4px;\n                font-size: 12px;\n                line-height: 16px;\n                color: #63656e;\n                background: #ebecf0;\n                border-radius: 8px;\n                transition: all 0.15s;\n            }\n\n            .loading-flag {\n                color: #3a84ff;\n                animation: sync-fetch-loading 1s linear infinite;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"list-operation-extend\">\n        <Icon type=\"more\" class=\"icon\" />\n        <div\n            ref=\"content\"\n            class=\"list-operation-extend-wrapper\"\n            @click=\"handleClick\">\n            <slot />\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n\n    const instanceMap = {};\n\n    export default {\n        created () {\n            this.id = `${_.random(1, 1000)}_${Date.now()}_PopoverRef`;\n            this.timer = '';\n        },\n        mounted () {\n            this.init();\n        },\n        methods: {\n            init () {\n                instanceMap[this.id] = this.$bkPopover(this.$el, {\n                    theme: 'list-operation-extend-popover light',\n                    interactive: true,\n                    placement: 'bottom',\n                    content: this.$refs.content,\n                    trigger: 'click',\n                    arrow: true,\n                    size: 'small',\n                    onShow: () => {\n                        Object.keys(instanceMap).forEach((key) => {\n                            if (key !== this.id) {\n                                instanceMap[key].hide();\n                            }\n                        });\n                    },\n                });\n            },\n            handleClick () {\n                instanceMap[this.id].hide();\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .list-operation-extend {\n        display: inline-block;\n        width: 32px;\n        height: 32px;\n        margin-left: -14px;\n        line-height: 30px;\n        color: #868b97;\n        text-align: center;\n        cursor: pointer;\n        background: transparent;\n        border-radius: 50%;\n\n        .icon {\n            font-size: 14px;\n        }\n\n        &:hover {\n            background: #dcdee5;\n\n            .icon {\n                color: #3a84ff;\n            }\n        }\n    }\n\n    .list-operation-extend-wrapper {\n        display: flex;\n        flex-direction: column;\n\n        .action-item {\n            font-size: 14px;\n            line-height: 32px;\n            color: #868b97;\n            text-align: center;\n            cursor: pointer;\n\n            &:hover {\n                color: #3a84ff;\n            }\n\n            &.disabled {\n                color: #dcdee5;\n                cursor: not-allowed;\n            }\n        }\n    }\n</style>\n","<template>\n    <div v-if=\"isNotPermission\" class=\"apply-permission-page\">\n        <div class=\"page-main\">\n            <ask-permission :permission-list=\"authResult.requiredPermissions\" />\n            <div class=\"footer\">\n                <bk-button theme=\"primary\" class=\"mr10\" @click=\"handleApply\" v-if=\"isAppleFlag\">{{ applyText }}</bk-button>\n                <bk-button theme=\"primary\" @click=\"handleReload\" v-else>{{ appliedText }}</bk-button>\n            </div>\n        </div>\n    </div>\n    <div v-else>\n        <slot />\n    </div>\n</template>\n<script>\n    import EventBus from '@utils/event-bus';\n       import AskPermission from './index';\n\n    export default {\n        components: {\n            AskPermission,\n        },\n        data () {\n            return {\n                isAppleFlag: true,\n                isNotPermission: false,\n            };\n        },\n        created () {\n            this.applyText = '去申请';\n            this.appliedText = '已申请';\n            EventBus.$once('permission-catch', this.permissionHold);\n            this.$once('hook:beforeDestroy', () => {\n                EventBus.$off('permission-catch', this.permissionHold);\n            });\n        },\n        methods: {\n            /**\n             * @desc 捕获权限异常\n             */\n            permissionHold (authResult) {\n                this.isNotPermission = true;\n                this.authResult = authResult;\n            },\n            /**\n             * @desc 跳转权限中心\n             */\n            handleApply () {\n                window.open(this.authResult.applyUrl, '_blank');\n                this.isAppleFlag = false;\n            },\n            /**\n             * @desc 已申请刷新页面\n             */\n            handleReload () {\n                location.reload();\n            },\n            \n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .apply-permission-page {\n        display: flex;\n        align-items: center;\n        height: 100%;\n        margin-top: -30px;\n\n        .page-main {\n            width: 768px;\n            padding: 24px;\n            margin: 60px auto;\n            background-color: #fff;\n            border-radius: 2px;\n            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 5%);\n        }\n\n        .footer {\n            margin: 24px auto 6px;\n            text-align: center;\n        }\n    }\n</style>\n","<template>\n    <div class=\"variable-use-guide\">\n        <div class=\"header\">\n            <div>{{ '使用指引' }}</div>\n            <div class=\"tab-container\">\n                <div\n                    class=\"tab-item\"\n                    :class=\"{ active: tab === 'global' }\"\n                    @click=\"handleTabToggle('global')\">\n                    {{ '全局变量'}}\n                </div>\n                <div\n                    class=\"tab-item\"\n                    :class=\"{ active: tab === 'magic' }\"\n                    @click=\"handleTabToggle('magic')\">\n                    {{ '魔法变量' }}\n                </div>\n            </div>\n        </div>\n        <scroll-faker style=\"height: calc(100% - 88px);\">\n            <div class=\"content\">\n                <div v-html=\"contentHtml\" style=\"margin-top: -24px;\" />\n            </div>\n        </scroll-faker>\n        <div class=\"close-btn\" @click=\"handleClose\">\n            <Icon type=\"close\" />\n        </div>\n    </div>\n</template>\n<script>\n    import 'highlight.js/styles/googlecode.css';\n    import globalVariable from './global-variable.md';\n    import globalVariableEN from './global-variable.en.md';\n    import magicVariable from './magic-variable.md';\n    import magicVariableEN from './magic-variable.en.md';\n\n    export default {\n        name: '',\n        data () {\n            return {\n                tab: 'global',\n            };\n        },\n        computed: {\n            contentHtml () {\n                const contentMap = {\n                    global: globalVariableEN,\n                    magic: magicVariableEN,\n                };\n                if ('zh-CN' === 'zh-CN') {\n                    Object.assign(contentMap, {\n                        global: globalVariable,\n                        magic: magicVariable,\n                    });\n                }\n                return contentMap[this.tab];\n            },\n        },\n        methods: {\n            handleTabToggle (tab) {\n                this.tab = tab;\n                console.log('fromasasd = =', this.tab);\n            },\n            handleClose () {\n                this.$emit('on-close');\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    html[lang=\"en-US\"] {\n        .variable-use-guide {\n            .tab-container {\n                .tab-item {\n                    width: 120px;\n                }\n            }\n        }\n    }\n\n    .variable-use-guide {\n        position: relative;\n        width: 366px;\n        height: 100%;\n        background: #fff;\n        border-left: 1px solid #dcdee5;\n\n        .header {\n            padding-top: 16px;\n            padding-left: 20px;\n            font-size: 16px;\n            color: #313238;\n            background: #f0f1f5;\n            border-bottom: 1px solid #dcdee5;\n\n            .tab-container {\n                display: flex;\n                margin-top: 15px;\n\n                .tab-item {\n                    width: 84px;\n                    height: 35px;\n                    margin-right: 8px;\n                    margin-bottom: -1px;\n                    font-size: 13px;\n                    line-height: 35px;\n                    color: #63656e;\n                    text-align: center;\n                    cursor: pointer;\n                    background: #dcdee5;\n                    border: 1px solid #dcdee5;\n                    border-bottom: none;\n                    border-top-right-radius: 4px;\n                    border-top-left-radius: 4px;\n                    transition: all 0.1s;\n\n                    &.active {\n                        color: #313238;\n                        background: #fff;\n                    }\n                }\n            }\n        }\n\n        .content {\n            padding: 15px 20px;\n            overflow: hidden;\n            line-height: 18px;\n            color: #63656e;\n\n            h1 {\n                margin-top: 24px;\n                font-size: 13px;\n                font-weight: bold;\n            }\n\n            p {\n                margin-top: 6px;\n            }\n\n            code {\n                padding: 0 4px;\n                font-size: 12px;\n                color: #ea3636;\n                white-space: nowrap;\n                background: #fffafa;\n                border: 1px solid #ffecec;\n                border-radius: 2px;\n            }\n\n            pre {\n                code {\n                    display: block;\n                    width: 100%;\n                    padding: 8px 12px;\n                    margin-top: 10px;\n                    overflow-x: auto;\n                    line-height: 22px;\n                    color: #6a9a7b;\n                    text-align: left;\n                    white-space: pre;\n                    background: #f5f6fa;\n                    border: none;\n                }\n            }\n\n            ul {\n                & > li {\n                    position: relative;\n                    padding-left: 11px;\n                    color: #313238;\n\n                    &::before {\n                        position: absolute;\n                        top: 6px;\n                        left: 0;\n                        width: 5px;\n                        height: 5px;\n                        margin-right: 6px;\n                        vertical-align: middle;\n                        background: #979ba5;\n                        border-radius: 50%;\n                        content: \"\";\n                    }\n\n                    &:nth-child(n+2) {\n                        margin-top: 20px;\n                    }\n                }\n            }\n\n            ol {\n                color: #63656e;\n            }\n\n            li {\n                margin-top: 6px;\n            }\n        }\n\n        .close-btn {\n            position: absolute;\n            top: 10px;\n            right: 10px;\n            width: 26px;\n            height: 26px;\n            font-size: 18px;\n            line-height: 26px;\n            color: #979ba5;\n            text-align: center;\n            cursor: pointer;\n            border-radius: 50%;\n\n            &:hover {\n                background-color: #dcdee5;\n            }\n        }\n    }\n</style>\n","<template>\n    <jb-form :model=\"formData\" :rules=\"rules\" ref=\"varStringForm\">\n        <jb-form-item :label=\"'变量名称'\" required property=\"name\">\n            <jb-input\n                v-model=\"formData.name\"\n                :placeholder=\"'变量名仅支持大小写英文字母或下划线 [必填]'\"\n                :maxlength=\"30\" />\n        </jb-form-item>\n        <jb-form-item\n            ref=\"defaultValue\"\n            :label=\"'初始值'\"\n            :desc=\"'仅作用于创建执行方案时的初始变量值，后续更改不会同步到执行方案'\"\n            property=\"defaultValue\">\n            <bk-input\n                class=\"var-default-value\"\n                :placeholder=\"'请输入变量的初始值 [可选]'\"\n                v-model=\"formData.defaultValue\" />\n        </jb-form-item>\n        <jb-form-item :label=\"'变量描述'\">\n            <bk-input\n                v-model=\"formData.description\"\n                type=\"textarea\"\n                :placeholder=\"'这里可以备注变量的用途、使用说明等信息 [可选]'\"\n                maxlength=\"100\" />\n        </jb-form-item>\n        <jb-form-item ext-cls=\"changeable-cls\">\n            <bk-checkbox\n                v-model=\"formData.changeable\"\n                :true-value=\"1\"\n                :false-value=\"0\"\n                v-bk-tooltips.right=\"'变量的值在执行中可变'\">\n                {{ '赋值可变' }}\n            </bk-checkbox>\n        </jb-form-item>\n        <jb-form-item style=\"margin-bottom: 0;\">\n            <bk-checkbox\n                v-model=\"formData.required\"\n                :true-value=\"1\"\n                :false-value=\"0\">\n                {{ '执行时必填' }}\n            </bk-checkbox>\n        </jb-form-item>\n    </jb-form>\n</template>\n<script>\n       import {\n        globalVariableNameRule,\n    } from '@utils/validator';\n    import JbInput from '@components/jb-input';\n\n    export default {\n        name: 'VarString',\n        components: {\n            JbInput,\n        },\n        props: {\n            variable: {\n                type: Array,\n                default () {\n                    return [];\n                },\n            },\n            data: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                formData: { ...this.data },\n            };\n        },\n        created () {\n            this.rules = {\n                name: [\n                    {\n                        required: true,\n                        message: '变量名称必填',\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: globalVariableNameRule.validator,\n                        message: globalVariableNameRule.message,\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: val => !this.variable.some(item => item.name === val),\n                        message: '变量名称已存在，请重新输入',\n                        trigger: 'blur',\n                    },\n                ],\n            };\n        },\n        methods: {\n            submit () {\n                return this.$refs.varStringForm.validate()\n                    .then(() => {\n                        this.$emit('on-change', {\n                            ...this.formData,\n                            type: 1,\n                        });\n                    }, validator => Promise.reject(validator.content));\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .changeable-cls {\n        .bk-form-checkbox .bk-checkbox-text {\n            padding-bottom: 2px;\n            border-bottom: 1px dashed #c4c6cc;\n        }\n    }\n</style>\n","<template>\n    <div>\n        <jb-form ref=\"varHostForm\" :model=\"formData\" :rules=\"rules\">\n            <jb-form-item :label=\"'变量名称'\" required :property=\"'name'\">\n                <jb-input\n                    v-model=\"formData.name\"\n                    :maxlength=\"30\"\n                    :placeholder=\"'变量名仅支持大小写英文字母或下划线 [必填]'\" />\n            </jb-form-item>\n            <jb-form-item\n                ref=\"defaultTargetValue\"\n                :label=\"'初始值'\"\n                :desc=\"'仅作用于创建执行方案时的初始变量值，后续更改不会同步到执行方案'\"\n                property=\"defaultTargetValue\">\n                <div>\n                    <bk-button class=\"mr10\" @click=\"handleOpenChooseIp\">\n                        <Icon type=\"plus\" />\n                        {{ '选择主机' }}\n                    </bk-button>\n                    <bk-button v-if=\"isShowClear\" @click=\"handleClearDefault\">\n                        {{ '清空' }}\n                    </bk-button>\n                </div>\n                <server-panel\n                    v-if=\"isShowClear\"\n                    class=\"view-server-panel\"\n                    :host-node-info=\"formData.defaultTargetValue.hostNodeInfo\"\n                    editable\n                    detail-fullscreen\n                    @on-change=\"handleHostChange\" />\n            </jb-form-item>\n            <jb-form-item :label=\"'变量描述'\">\n                <bk-input\n                    v-model=\"formData.description\"\n                    :placeholder=\"'这里可以备注变量的用途、使用说明等信息 [可选]'\"\n                    type=\"textarea\"\n                    maxlength=\"100\" />\n            </jb-form-item>\n            <jb-form-item style=\"margin-bottom: 0;\">\n                <bk-checkbox v-model=\"formData.required\" :true-value=\"1\" :false-value=\"0\">\n                    {{ '执行时必填' }}\n                </bk-checkbox>\n            </jb-form-item>\n        </jb-form>\n        <choose-ip\n            v-model=\"isShowChooseIp\"\n            :host-node-info=\"formData.defaultTargetValue.hostNodeInfo\"\n            @on-change=\"handleHostChange\" />\n    </div>\n</template>\n<script>\n       import TaskGlobalVariableModel from '@model/task/global-variable';\n    import TaskHostNodeModel from '@model/task-host-node';\n    import {\n        globalVariableNameRule,\n    } from '@utils/validator';\n    import JbInput from '@components/jb-input';\n    import ChooseIp from '@components/choose-ip';\n    import ServerPanel from '@components/choose-ip/server-panel';\n\n    export default {\n        name: 'VarHost',\n        components: {\n            JbInput,\n            ChooseIp,\n            ServerPanel,\n        },\n        props: {\n            variable: {\n                type: Array,\n                default: () => [],\n            },\n            data: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                formData: { ...this.data },\n                isShowChooseIp: false,\n            };\n        },\n        computed: {\n            /**\n             * @desc 显示清空按钮\n             * @returns { Boolean }\n             */\n            isShowClear () {\n                return !TaskHostNodeModel.isHostNodeInfoEmpty(this.formData.defaultTargetValue.hostNodeInfo);\n            },\n        },\n        created () {\n            this.rules = {\n                name: [\n                    {\n                        required: true,\n                        message: '变量名称必填',\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: globalVariableNameRule.validator,\n                        message: globalVariableNameRule.message,\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: val => !this.variable.some(item => item.name === val),\n                        message: '变量名称已存在，请重新输入',\n                        trigger: 'blur',\n                    },\n                ],\n            };\n        },\n        methods: {\n            /**\n             * @desc 编辑主机信息\n             * @param { hostNodeInfo } 主机信息\n             */\n            handleHostChange (hostNodeInfo) {\n                this.formData.defaultTargetValue.hostNodeInfo = hostNodeInfo;\n            },\n            /**\n             * @desc 显示 IP 选择器\n             */\n            handleOpenChooseIp () {\n                this.isShowChooseIp = true;\n            },\n            /**\n             * @desc 清空主机信息\n             */\n            handleClearDefault () {\n                const { hostNodeInfo } = new TaskHostNodeModel({});\n                this.formData.defaultTargetValue.hostNodeInfo = hostNodeInfo;\n            },\n            /**\n             * @desc 保存变量\n             */\n            submit () {\n                return this.$refs.varHostForm.validate()\n                    .then(() => {\n                        this.$emit('on-change', {\n                            ...this.formData,\n                            type: TaskGlobalVariableModel.TYPE_HOST,\n                        });\n                    }, validator => Promise.reject(validator.content));\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\" scoped>\n    .view-server-panel {\n        margin-top: 10px;\n    }\n</style>\n","<template>\n    <jb-form :model=\"formData\" :rules=\"rules\" ref=\"varArrayForm\">\n        <jb-form-item :label=\"'数组类型'\" required property=\"name\">\n            <div class=\"array-type-group\">\n                <bk-radio-group :value=\"arrayType\" @change=\"handleArrayTypeChange\">\n                    <bk-radio-button\n                        class=\"item\"\n                        :value=\"5\"\n                        >\n                        {{ '关联数组' }}\n                    </bk-radio-button>\n                    <bk-radio-button\n                        class=\"item\"\n                        :value=\"6\"\n                        >\n                        {{ '索引数组' }}\n                    </bk-radio-button>\n                </bk-radio-group>\n            </div>\n        </jb-form-item>\n        <jb-form-item :label=\"'变量名称'\" required property=\"name\">\n            <jb-input\n                v-model=\"formData.name\"\n                :placeholder=\"'变量名仅支持大小写英文字母或下划线 [必填]'\"\n                :maxlength=\"30\" />\n        </jb-form-item>\n        <jb-form-item\n            ref=\"defaultValue\"\n            :label=\"'初始值'\"\n            :desc=\"'仅作用于创建执行方案时的初始变量值，后续更改不会同步到执行方案'\"\n            property=\"defaultValue\">\n            <bk-input\n                class=\"var-default-value\"\n                :placeholder=\"'请输入变量的初始值 [可选]'\"\n                v-model=\"formData.defaultValue\" />\n        </jb-form-item>\n        <jb-form-item :label=\"'变量描述'\">\n            <bk-input\n                v-model=\"formData.description\"\n                type=\"textarea\"\n                :placeholder=\"'这里可以备注变量的用途、使用说明等信息 [可选]'\"\n                maxlength=\"100\" />\n        </jb-form-item>\n        <jb-form-item class=\"form-item-changeable\">\n            <bk-checkbox\n                v-model=\"formData.changeable\"\n                :true-value=\"1\"\n                :false-value=\"0\"\n                v-bk-tooltips.right=\"'变量的值在执行中可变'\">\n                {{ '赋值可变' }}\n            </bk-checkbox>\n        </jb-form-item>\n        <jb-form-item style=\"margin-bottom: 0;\">\n            <bk-checkbox\n                v-model=\"formData.required\"\n                :true-value=\"1\"\n                :false-value=\"0\">\n                {{ '执行时必填' }}\n            </bk-checkbox>\n        </jb-form-item>\n    </jb-form>\n</template>\n<script>\n       import {\n        globalVariableNameRule,\n    } from '@utils/validator';\n    import JbInput from '@components/jb-input';\n\n    export default {\n        name: 'VarArray',\n        components: {\n            JbInput,\n        },\n        props: {\n            variable: {\n                type: Array,\n                default () {\n                    return [];\n                },\n            },\n            data: {\n                type: Object,\n                default () {\n                    return {};\n                },\n            },\n        },\n        data () {\n            return {\n                arrayType: 5,\n                formData: { ...this.data },\n            };\n        },\n        computed: {\n            isEdit () {\n                return !!this.data.name;\n            },\n        },\n        watch: {\n            data: {\n                handler (data) {\n                    if (data.name) {\n                        this.arrayType = data.type;\n                    }\n                },\n                immediate: true,\n            },\n            \n        },\n        created () {\n            this.rules = {\n                name: [\n                    {\n                        required: true,\n                        message: '变量名称必填',\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: globalVariableNameRule.validator,\n                        message: globalVariableNameRule.message,\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: val => !this.variable.some(item => item.name === val),\n                        message: '变量名称已存在，请重新输入',\n                        trigger: 'blur',\n                    },\n                ],\n            };\n        },\n        methods: {\n            handleArrayTypeChange (value) {\n                this.arrayType = value;\n            },\n            submit () {\n                return this.$refs.varArrayForm.validate()\n                    .then(() => {\n                        this.$emit('on-change', {\n                            ...this.formData,\n                            type: this.arrayType,\n                        });\n                    }, validator => Promise.reject(validator.content));\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .form-item-changeable {\n        .bk-form-checkbox .bk-checkbox-text {\n            padding-bottom: 2px;\n            border-bottom: 1px dashed #c4c6cc;\n        }\n    }\n\n    .array-type-group {\n        position: relative;\n        z-index: 1;\n\n        .item {\n            .bk-radio-button-text {\n                width: 108px;\n            }\n        }\n    }\n</style>\n","<template>\n    <div ref=\"detailLayout\" class=\"jb-detail-layout\" :class=\"[mode, layout]\">\n        <slot />\n    </div>\n</template>\n<script>\n    export default {\n        name: 'JbDetailLayout',\n        props: {\n            mode: {\n                type: String,\n                default: 'normal', // normal, see\n            },\n            layout: {\n                type: String,\n                default: 'horizontal', // horizontal, vertical\n            },\n            isWarp: {\n                type: Boolean,\n            },\n        },\n        created () {\n            this.childrenNum = this.$slots.default;\n        },\n        updated () {\n            const childrenNum = this.$slots.default;\n            if (this.childrenNum !== childrenNum) {\n                this.init();\n                this.childrenNum = childrenNum;\n            }\n        },\n        mounted () {\n            const isShowLayout = this.$refs.detailLayout.getBoundingClientRect().width > 0;\n            if (isShowLayout) {\n                this.init();\n            }\n        },\n        methods: {\n            init () {\n                if (this.layout === 'vertical') {\n                    return;\n                }\n                const $layoutEle = this.$refs.detailLayout;\n                const $layoutDetailList = $layoutEle.querySelectorAll('.detail-label');\n\n                let max = 0;\n                $layoutDetailList.forEach((item) => {\n                    const { width } = item.getBoundingClientRect();\n                    max = Math.max(max, width);\n                });\n                $layoutDetailList.forEach((item) => {\n                    item.style.width = `${max}px`;\n                });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .jb-detail-layout {\n        &.see {\n            .detail-label {\n                color: #b2b5bd;\n            }\n        }\n\n        &.vertical {\n            .detail-label {\n                justify-content: flex-start;\n            }\n\n            .detail-item {\n                flex-direction: column;\n                align-items: stretch;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"detail-item\" :class=\"`design-layout-${layout}`\">\n        <div class=\"detail-label\">\n            <span>{{ label }}</span>\n        </div>\n        <div class=\"detail-content\">\n            <slot />\n        </div>\n    </div>\n</template>\n<script>\n    export default {\n        name: '',\n        props: {\n            label: {\n                type: String,\n                default: '',\n            },\n            layout: {\n                type: String,\n                default: '', // horizontal, vertical\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .detail-item {\n        display: flex;\n        font-size: 14px;\n        line-height: 32px;\n        color: #313238;\n        align-items: flex-start;\n        justify-content: flex-end;\n\n        &.design-layout-horizontal {\n            flex-direction: row !important;\n        }\n\n        &.design-layout-vertical {\n            flex-direction: column !important;\n\n            .detail-content {\n                width: 100%;\n            }\n        }\n    }\n\n    .detail-label {\n        display: flex;\n        padding-right: 2px;\n        color: #63656e;\n        text-align: right;\n        word-break: keep-all;\n        white-space: pre;\n        align-items: center;\n        justify-content: flex-end;\n        flex: 0 0 auto;\n    }\n\n    .detail-content {\n        flex: 1;\n        color: #63656e;\n        word-break: break-all;\n    }\n</style>\n","<template>\n    <div class=\"jb-edit-textarea\" :class=\"mode\">\n        <div\n            v-if=\"!isEditing\"\n            class=\"render-value-box\"\n            @click.stop=\"handleBlockShowEdit\">\n            <div\n                class=\"render-text-box\"\n                ref=\"valueTextBox\"\n                @copy=\"handleCopy\"\n                :style=\"boxStyles\">\n                <slot v-bind:value=\"newVal\">{{ renderText }}</slot>\n                <span\n                    v-if=\"isShowMore\"\n                    class=\"text-whole\"\n                    @click.stop=\"handleExpandAll\">\n                    <template v-if=\"isExpand\">\n                        <Icon type=\"angle-double-up\" style=\"font-size: 12px;\" />\n                        <span>收起</span>\n                    </template>\n                    <template v-else>\n                        <Icon type=\"angle-double-down\" style=\"font-size: 12px;\" />\n                        <span>展开</span>\n                    </template>\n                </span>\n            </div>\n            <div v-if=\"!readonly\" class=\"edit-action-box\">\n                <Icon\n                    v-if=\"!isBlock && !isSubmiting\"\n                    type=\"edit-2\"\n                    class=\"edit-action\"\n                    @click.self.stop=\"handleShowInput\" />\n                <Icon\n                    v-if=\"isSubmiting\"\n                    type=\"loading-circle\"\n                    class=\"edit-loading\" />\n            </div>\n        </div>\n        <div v-else @click.stop=\"\">\n            <jb-textarea\n                v-model=\"newVal\"\n                class=\"edit-value-box\"\n                ref=\"input\"\n                :rows=\"rows\"\n                v-bind=\"$attrs\"\n                @blur=\"handleInputBlur\" />\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import JbTextarea from '@components/jb-textarea';\n\n    export default {\n        name: 'JbEditTextarea',\n        components: {\n            JbTextarea,\n        },\n        props: {\n            /**\n             * @value block 块级交互\n             * @value ‘’ 默认鼠标点击编辑按钮\n             */\n            mode: {\n                type: String,\n                default: '',\n            },\n            field: {\n                type: String,\n                required: true,\n            },\n            value: {\n                type: String,\n                default: '',\n            },\n            // 忽略换行强制文本在一行显示\n            singleRowRender: {\n                type: Boolean,\n                default: false,\n            },\n            rows: {\n                type: Number,\n                default: 3,\n            },\n            remoteHander: {\n                type: Function,\n                default: () => Promise.resolve(),\n            },\n            rules: {\n                type: Array,\n                default: () => [],\n            },\n            readonly: {\n                type: Boolean,\n                default: false,\n            },\n        },\n        data () {\n            return {\n                isEditing: false,\n                isSubmiting: false,\n                isExpand: false,\n                newVal: this.value,\n                renderLength: 0,\n            };\n        },\n        computed: {\n            renderText () {\n                if (this.newVal.length === this.renderLength) {\n                    return this.newVal;\n                }\n                if (this.isExpand) {\n                    return this.newVal;\n                }\n                if (this.renderLength < 1) { \n                    if (!this.newVal) {\n                        return '--';\n                    }\n                    return this.newVal;\n                }\n                return `${this.newVal.slice(0, this.renderLength)}...`;\n            },\n            isShowMore () {\n                return this.newVal.length > this.renderLength && this.renderLength > 0;\n            },\n            boxStyles () {\n                const styles = {\n                    'max-height': this.isExpand ? 'unset' : '78px',\n                };\n                if (this.singleRowRender) {\n                    styles.height = '26px';\n                    styles['max-width'] = '100%';\n                    styles['text-overflow'] = 'ellipsis';\n                    styles['white-space'] = 'nowrap';\n                }\n                return styles;\n            },\n            isBlock () {\n                return this.mode === 'block';\n            },\n        },\n        watch: {\n            value: {\n                handler (newVal) {\n                    this.newVal = newVal;\n                    if (this.newVal) {\n                        this.calcEllTextLength();\n                    }\n                },\n                immediate: true,\n            },\n        },\n        mounted () {\n            document.body.addEventListener('click', this.handleHideInput);\n            this.$once('hook:beforeDestroy', () => {\n                document.body.removeEventListener('click', this.handleHideInput);\n            });\n        },\n        methods: {\n            /**\n             * @desc 计算默认展示的文本宽度\n             *\n             * settimeout 保证计算过程在组件渲染之后\n             */\n            calcEllTextLength () {\n                if (this.$slots.default) {\n                    return;\n                }\n                if (this.isExpand) {\n                    return;\n                }\n                setTimeout(() => {\n                    const valLength = this.newVal.length;\n                    const $el = document.createElement('div');\n                    $el.style.opacity = 0;\n                    $el.style.zIndex = '-1';\n                    if (this.singleRowRender) {\n                        $el.style.wordBreak = 'keep-all';\n                        $el.style.whiteSpace = 'pre';\n                    }\n                    \n                    this.$refs.valueTextBox.appendChild($el);\n\n                    const lineHeight = 24;\n                    const maxLine = 3;\n                    const maxHeight = lineHeight * maxLine;\n                    let realHeight = 0;\n                    let realLength = 1;\n                \n                    const calcLength = () => {\n                        const text = this.newVal.slice(0, realLength);\n                        $el.innerText = `${text} 展开展开`;\n                        Promise.resolve()\n                            .then(() => {\n                                realHeight = $el.getBoundingClientRect().height;\n                                if (realHeight <= maxHeight && realLength < valLength) {\n                                    realLength += 2;\n                                    calcLength();\n                                }\n                            });\n                    };\n                    calcLength();\n                    setTimeout(() => {\n                        this.renderLength = 0;\n                        if (realHeight > lineHeight) {\n                            this.renderLength = realLength >= valLength ? valLength : realLength - 4;\n                        }\n                        this.$refs.valueTextBox.removeChild($el);\n                    });\n                });\n            },\n            /**\n             * @desc 切换编辑状态\n             */\n            handleBlockShowEdit () {\n                if (!this.isBlock) {\n                    return;\n                }\n                this.handleShowInput();\n            },\n            /**\n             * @desc 开始编辑\n             *\n             * 阻止事件的冒泡\n             * 手动触发body的 click 事件，\n             */\n            handleShowInput () {\n                document.body.click();\n                this.isEditing = true;\n                this.$nextTick(() => {\n                    this.$refs.input.focus();\n                });\n            },\n            /**\n             * @desc 输入框失去焦点\n             *\n             * 值没有改变不需要提交\n             */\n            handleInputBlur () {\n                this.isEditing = false;\n                if (this.newVal === this.value) {\n                    return;\n                }\n                this.isSubmiting = true;\n                // this.remoteHander({\n                //     [this.field]: this.newVal,\n                // }).then(() => {\n                this.$emit('on-change', {\n                    [this.field]: this.newVal,\n                });\n                this.calcEllTextLength();\n                this.messageSuccess('编辑成功');\n                // })\n                //     .finally(() => {\n                this.isSubmiting = false;\n                // });\n            },\n            /**\n             * @desc 退出编辑状态\n             */\n            handleHideInput (event) {\n                if (event.path && event.path.length > 0) {\n                    // eslint-disable-next-line no-plusplus\n                    for (let i = 0; i < event.path.length; i++) {\n                        const target = event.path[i];\n                        if (target.className === 'jb-edit-textarea') {\n                            return;\n                        }\n                    }\n                }\n                this.isEditing = false;\n            },\n            /**\n             * @desc 复制内容\n             * @param { Object } event 复制事件\n             *\n             * 删除内容的开头和结尾的换行符\n             */\n            handleCopy (event) {\n                const clipboardData = event.clipboardData || window.clipboardData;\n                if (!clipboardData) {\n                    return;\n                }\n                let text = window.getSelection().toString();\n                if (text && text.indexOf(this.renderText) > -1) {\n                    text = this.value;\n                }\n                if (text) {\n                    event.preventDefault();\n                    clipboardData.setData('text/plain', _.trim(text, '\\n'));\n                }\n            },\n            /**\n             * @desc 查看态的文本展开收起\n             */\n            handleExpandAll () {\n                this.isExpand = !this.isExpand;\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .jb-edit-textarea {\n        position: relative;\n\n        &.block {\n            position: relative;\n            cursor: pointer;\n\n            .render-value-box,\n            .edit-value-box {\n                margin-left: -10px;\n            }\n\n            .render-value-box {\n                padding-left: 10px;\n\n                &:hover {\n                    background: #f0f1f5;\n                }\n            }\n\n            .edit-action-box {\n                position: absolute;\n                top: 0;\n                right: 10px;\n                width: 16px;\n            }\n        }\n\n        .render-value-box {\n            position: relative;\n            display: flex;\n            align-items: center;\n            min-width: 30px;\n            min-height: 30px;\n            padding: 3px 0;\n\n            &:hover {\n                .edit-action {\n                    opacity: 1;\n                    transform: scale(1);\n                }\n            }\n\n            .text-whole {\n                color: #3a84ff;\n                white-space: nowrap;\n                cursor: pointer;\n                user-select: none;\n            }\n        }\n\n        .render-text-box {\n            position: relative;\n            overflow: hidden;\n            line-height: 24px;\n            white-space: pre-wrap;\n        }\n\n        .edit-action-box {\n            display: flex;\n            align-items: center;\n            align-self: flex-start;\n            height: 26px;\n            margin-right: auto;\n            font-size: 16px;\n\n            .edit-action {\n                padding: 4px 15px 4px 2px;\n                color: #979ba5;\n                cursor: pointer;\n                opacity: 0;\n                transform: scale(0);\n                transition: 0.15s;\n                transform-origin: left center;\n\n                &:hover {\n                    color: #3a84ff;\n                }\n            }\n\n            .edit-loading {\n                position: absolute;\n                top: 8px;\n                margin-left: 2px;\n                animation: rotate-loading 1s linear infinite;\n            }\n        }\n\n        .edit-value-box {\n            width: 100%;\n        }\n    }\n</style>\n","<template>\n    <div class=\"jb-edit-host\" :class=\"mode\">\n        <div class=\"render-value-box\" @click.stop=\"handleBlockShowEdit\">\n            <div class=\"value-text\">\n                <slot v-bind:value=\"localValue\">\n                    <div v-html=\"renderHtml\" style=\"margin-left: -4px;\" />\n                </slot>\n            </div>\n            <div class=\"edit-action-box\">\n                <Icon\n                    v-if=\"!isBlock && !isSubmiting\"\n                    type=\"edit-2\"\n                    class=\"edit-action\"\n                    @click.self.stop=\"handleShowEdit\" />\n                <Icon\n                    v-if=\"isSubmiting\"\n                    type=\"loading-circle\"\n                    class=\"edit-loading\" />\n            </div>\n        </div>\n        <choose-ip\n            v-model=\"isShowChooseIp\"\n            :host-node-info=\"localValue.hostNodeInfo\"\n            @on-change=\"handleHostChange\" />\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import TaskHostNodeModel from '@model/task-host-node';\n    import ChooseIp from '@components/choose-ip';\n\n    export default {\n        name: 'JbEditHost',\n        components: {\n            ChooseIp,\n        },\n        props: {\n            /**\n             * @value block 块级交互\n             * @value ‘’ 默认鼠标点击编辑按钮\n             */\n            mode: {\n                type: String,\n                default: 'block',\n            },\n            /**\n             * @desc 编辑操作对应的字段名称\n             */\n            field: {\n                type: String,\n                required: true,\n            },\n            /**\n             * @desc 默认值\n             */\n            value: {\n                type: Object,\n                default: new TaskHostNodeModel({}),\n            },\n            /**\n             * @desc 宽度\n             */\n            width: {\n                type: String,\n                default: 'auto',\n            },\n            remoteHander: {\n                type: Function,\n                default: () => Promise.resolve(),\n            },\n            /**\n             * @desc 值验证规则\n             */\n            rules: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                localValue: this.value,\n                isShowChooseIp: false,\n                error: '',\n                isEditing: false,\n                isSubmiting: false,\n            };\n        },\n        computed: {\n            renderHtml () {\n                if (!this.localValue) {\n                    return '--';\n                }\n                const {\n                    dynamicGroupList,\n                    ipList,\n                    topoNodeList,\n                } = this.localValue.hostNodeInfo || {};\n                const strs = [];\n                if (ipList.length > 0) {\n                    strs.push(`<span class=\"number strong\">${ipList.length}</span>${'台主机'}`);\n                }\n                if (topoNodeList.length > 0) {\n                    strs.push(`<span class=\"number strong\">${topoNodeList.length}</span>${'个节点'}`);\n                }\n                if (dynamicGroupList.length > 0) {\n                    strs.push(`<span class=\"number strong\">${dynamicGroupList.length}</span>${'个分组'}`);\n                }\n                return strs.length > 0 ? strs.join('\\n') : '--';\n            },\n            styles () {\n                return {\n                    width: this.width,\n                };\n            },\n            isBlock () {\n                return this.mode === 'block';\n            },\n        },\n        watch: {\n            value: {\n                handler (value) {\n                    this.localValue = Object.freeze(_.cloneDeep(value));\n                },\n                immediate: true,\n            },\n        },\n        methods: {\n            /**\n             * @desc 值验证\n             */\n            doValidator () {\n                const checkValidator = (rule, value) => new Promise((resolve, reject) => {\n                    if (rule.required && !value) {\n                        reject(rule.message);\n                    }\n                    // 通过自定义方法来检测\n                    if (rule.validator && (typeof rule.validator === 'function')) {\n                        const result = rule.validator(value);\n                        if (result.then) {\n                            result.then((data) => {\n                                if (data) {\n                                    return resolve();\n                                }\n                                return reject(rule.message);\n                            }).catch(() => {\n                                reject(rule.message);\n                            });\n                        } else if (result) {\n                            return resolve();\n                        } else {\n                            return reject(rule.message);\n                        }\n                    } else {\n                        resolve();\n                    }\n                });\n                \n                const allPromise = this.rules.map(rule => checkValidator(rule, this.localValue));\n                this.isValidatoring = true;\n                return Promise.all(allPromise).finally(() => {\n                    this.isValidatoring = false;\n                });\n            },\n            /**\n             * @desc 提交编辑\n             */\n            triggerChange () {\n                this.doValidator()\n                    .then(() => {\n                        this.isEditing = false;\n                        if (this.localValue === this.value) {\n                            return;\n                        }\n                        this.isSubmiting = true;\n                        this.remoteHander({\n                            [this.field]: this.localValue,\n                        }).then(() => {\n                            this.$emit('on-change', {\n                                [this.field]: this.localValue,\n                            });\n                            this.messageSuccess('编辑成功');\n                        })\n                            .catch(() => {\n                                this.localValue = this.value;\n                            })\n                            .finally(() => {\n                                this.isSubmiting = false;\n                            });\n                    })\n                    .catch((error) => {\n                        this.error = error;\n                    });\n            },\n            handleBlockShowEdit () {\n                if (!this.isBlock) {\n                    return;\n                }\n                this.handleShowEdit();\n            },\n            /**\n             * @desc 显示input\n             */\n            handleShowEdit () {\n                document.body.click();\n                this.isShowChooseIp = true;\n            },\n            \n            handleHostChange (hostNodeInfo) {\n                this.localValue = Object.freeze({\n                    ...this.localValue,\n                    hostNodeInfo,\n                });\n                this.triggerChange();\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .jb-edit-host {\n        &.block {\n            position: relative;\n            cursor: pointer;\n\n            .render-value-box {\n                padding-top: 5px;\n                padding-left: 10px;\n                margin-left: -10px;\n\n                &:hover {\n                    background: #f0f1f5;\n                }\n            }\n\n            .edit-action-box {\n                position: absolute;\n                top: 0;\n                right: 10px;\n                width: 16px;\n            }\n        }\n\n        .render-value-box {\n            position: relative;\n            display: flex;\n            min-width: 36px;\n            min-height: 28px;\n\n            &:hover {\n                .edit-action {\n                    opacity: 1;\n                    transform: scale(1);\n                }\n            }\n        }\n\n        .value-text {\n            line-height: 18px;\n            white-space: pre;\n        }\n\n        .edit-action-box {\n            display: flex;\n            align-items: center;\n            min-height: 1em;\n            margin-right: auto;\n            font-size: 16px;\n            color: #979ba5;\n\n            .edit-action {\n                padding: 6px 0 6px 2px;\n                cursor: pointer;\n                opacity: 0;\n                transform: scale(0);\n                transition: 0.15s;\n                transform-origin: left center;\n\n                &:hover {\n                    color: #3a84ff;\n                }\n            }\n\n            .edit-loading {\n                position: absolute;\n                top: 9px;\n                margin-left: 2px;\n                animation: rotate-loading 1s linear infinite;\n            }\n        }\n\n        .edit-value-container {\n            position: relative;\n            width: 100%;\n            font-size: 0;\n\n            &.edit-error {\n                .bk-form-input {\n                    border-color: #ea3636 !important;\n                }\n            }\n\n            .input-edit-info {\n                position: absolute;\n                top: 0;\n                right: 0;\n                bottom: 0;\n                z-index: 1;\n                display: flex;\n                align-items: center;\n                padding: 0 10px;\n                font-size: 16px;\n                color: #ea3636;\n            }\n        }\n    }\n</style>\n","<template>\n    <tr class=\"global-variable-create-row\">\n        <td>\n            <bk-select\n                class=\"offset-left\"\n                :clearable=\"false\"\n                :value=\"formData.type\"\n                @change=\"value => handleChange('type', value)\">\n                <bk-option\n                    v-for=\"item in typeList\"\n                    :key=\"item.id\"\n                    :id=\"item.id\"\n                    :name=\"item.name\" />\n            </bk-select>\n        </td>\n        <td>\n            <div\n                class=\"variable-name-box offset-left\"\n                :class=\"{\n                    'edit-error': isNameError,\n                }\">\n                <bk-input\n                    :value=\"formData.name\"\n                    @blur=\"handleShowNameError\"\n                    @change=\"value => handleChange('name', value)\" />\n                <Icon\n                    v-if=\"isNameError\"\n                    v-bk-tooltips=\"errorNameText\"\n                    type=\"info\"\n                    class=\"input-error\" />\n            </div>\n        </td>\n        <td>\n            <template v-if=\"isHostVarialbe\">\n                <div\n                    v-if=\"formData.defaultTargetValue.isEmpty\"\n                    class=\"add-host-btn offset-left\"\n                    @click=\"handleShowChooseIp\">\n                    <Icon type=\"plus\" style=\"margin-right: 6px;\" />\n                    {{ '添加服务器' }}\n                </div>\n                <jb-edit-host\n                    v-else\n                    field=\"defaultTargetValue\"\n                    :value=\"formData.defaultTargetValue\" />\n            </template>\n            <template v-else>\n                <bk-input\n                    class=\"offset-left\"\n                    :value=\"formData.defaultValue\"\n                    @change=\"value => handleChange('defaultValue', value)\" />\n            </template>\n        </td>\n        <td>\n            <jb-textarea\n                class=\"offset-left\"\n                :value=\"formData.description\"\n                @change=\"value => handleChange('description', value)\" />\n        </td>\n        <td>\n            <bk-checkbox\n                v-if=\"withChangable\"\n                :value=\"formData.changeable\"\n                @change=\"value => handleChange('changeable', value)\"\n                :true-value=\"1\"\n                :false-value=\"0\" />\n            <span v-else>--</span>\n        </td>\n        <td>\n            <bk-checkbox\n                :value=\"formData.required\"\n                @change=\"value => handleChange('required', value)\"\n                :true-value=\"1\"\n                :false-value=\"0\" />\n        </td>\n        <td class=\"action-row\">\n            <Icon type=\"add-fill\" @click=\"handleCreate\" class=\"action-btn\" />\n            <Icon type=\"reduce-fill\" @click=\"handleDelete\" class=\"action-btn\" />\n        </td>\n        <choose-ip\n            v-model=\"isShowChooseIp\"\n            :host-node-info=\"formData.defaultTargetValue.hostNodeInfo\"\n            @on-change=\"handleHostChange\" />\n    </tr>\n</template>\n<script>\n    import _ from 'lodash';\n       import { globalVariableNameRule } from '@utils/validator';\n    import GlobalVariableModel from '@model/task/global-variable';\n    import ChooseIp from '@components/choose-ip';\n    import JbEditHost from '@components/jb-edit/host';\n    import { createVariable } from '../util';\n\n    export default {\n        name: '',\n        components: {\n            ChooseIp,\n            JbEditHost,\n        },\n        props: {\n            variableNameList: {\n                type: Array,\n            },\n            data: {\n                type: Object,\n                require: true,\n            },\n        },\n        data () {\n            return {\n                formData: _.cloneDeep(this.data),\n                isShowChooseIp: false,\n                isShowNameError: false,\n                errorNameText: '',\n            };\n        },\n        computed: {\n            /**\n             * @desc 是否有赋值可变选项\n             * @returns { Boolean }\n             */\n            withChangable () {\n                return [\n                    GlobalVariableModel.TYPE_STRING,\n                    GlobalVariableModel.TYPE_RELATE_ARRAY,\n                    GlobalVariableModel.TYPE_INDEX_ARRAY,\n                ].includes(this.formData.type);\n            },\n            /**\n             * @desc 主机变量\n             * @returns { Boolean }\n             */\n            isHostVarialbe () {\n                return [\n                    GlobalVariableModel.TYPE_HOST,\n                ].includes(this.formData.type);\n            },\n            /**\n             * @desc 变量名验证失败\n             * @returns { Boolean }\n             */\n            isNameError () {\n                return this.isShowNameError && this.errorNameText;\n            },\n        },\n        created () {\n            this.typeList = [\n                {\n                    id: GlobalVariableModel.TYPE_STRING,\n                    name: '字符串',\n                },\n                {\n                    id: GlobalVariableModel.TYPE_NAMESPACE,\n                    name: '命名空间',\n                },\n                {\n                    id: GlobalVariableModel.TYPE_HOST,\n                    name: '主机列表',\n                },\n                {\n                    id: GlobalVariableModel.TYPE_PASSWORD,\n                    name: '密文',\n                },\n                {\n                    id: GlobalVariableModel.TYPE_RELATE_ARRAY,\n                    name: '关联数组',\n                },\n                {\n                    id: GlobalVariableModel.TYPE_INDEX_ARRAY,\n                    name: '索引数组',\n                },\n            ];\n        },\n        methods: {\n            /**\n             * @desc 验证变量名\n             */\n            validate () {\n                this.isShowNameError = true;\n                this.errorNameText = '';\n                if (!this.formData.name) {\n                    this.errorNameText = '变量名称必填';\n                }\n                if (!globalVariableNameRule.validator(this.formData.name)) {\n                    this.errorNameText = globalVariableNameRule.message;\n                }\n                if (this.variableNameList.includes(this.formData.name)) {\n                    this.errorNameText = '变量名称已存在，请重新输入';\n                }\n                if (this.errorNameText) {\n                    return Promise.reject(new Error(this.errorNameText));\n                }\n                return Promise.resolve();\n            },\n            /**\n             * @desc 触发 change 事件\n             */\n            triggerChange () {\n                this.$emit('on-change', this.formData);\n            },\n            /**\n             * @desc name 编辑框失去焦点时进行验证\n             */\n            handleShowNameError () {\n                this.validate();\n            },\n            /**\n             * @desc 设置主机变量的值\n             */\n            handleShowChooseIp () {\n                this.isShowChooseIp = true;\n            },\n            /**\n             * @desc 更新主机变量\n             * @param { Object } hostNodeInfo 主机信息\n             */\n            handleHostChange (hostNodeInfo) {\n                this.formData.defaultTargetValue.hostNodeInfo = hostNodeInfo;\n                this.triggerChange();\n            },\n            /**\n             * @desc 字段值更新\n             * @param { String } field 字段名\n             * @param { Any } value 字段值\n             */\n            handleChange (field, value) {\n                if (field === 'type') {\n                    this.formData = createVariable(this.formData.id);\n                }\n                this.formData[field] = value;\n                this.isShowNameError = false;\n                this.triggerChange();\n            },\n            /**\n             * @desc 添加新变量\n             */\n            handleCreate () {\n                this.$emit('on-append');\n            },\n            /**\n             * @desc 删除自己\n             */\n            handleDelete () {\n                this.$emit('on-delete');\n            },\n            \n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .global-variable-create-row {\n        .offset-left {\n            margin-left: -10px;\n        }\n\n        .bk-select {\n            height: 30px;\n            line-height: 30px;\n            background: #f7f8fa;\n            border: 1px solid transparent;\n\n            &:hover {\n                background: #f0f1f5;\n            }\n\n            .bk-select-name {\n                height: 30px;\n                padding-right: 16px;\n                padding-left: 10px;\n                line-height: 30px;\n            }\n        }\n\n        .bk-input-text {\n            .bk-form-input {\n                height: 30px;\n                line-height: 30px;\n                background: #f7f8fa;\n                border: 1px solid transparent;\n\n                &:hover {\n                    background: #f0f1f5;\n                }\n            }\n        }\n\n        .job-textarea {\n            .job-textarea-edit {\n                background: #f7f8fa;\n                border: 1px solid transparent;\n\n                &:hover {\n                    background: #f0f1f5;\n                }\n            }\n        }\n\n        .add-host-btn {\n            display: flex;\n            height: 30px;\n            padding: 0 10px;\n            font-size: 12px;\n            cursor: pointer;\n            background: #f7f8fa;\n            border-radius: 2px;\n            align-items: center;\n            justify-content: center;\n\n            &:hover {\n                background: #f0f1f5;\n            }\n        }\n\n        .edit-error {\n            .bk-input-text {\n                .bk-form-input {\n                    border-color: #ea3636;\n                }\n            }\n        }\n\n        .variable-name-box {\n            position: relative;\n\n            .input-error {\n                position: absolute;\n                top: 0;\n                right: 0;\n                bottom: 0;\n                z-index: 1;\n                display: flex;\n                align-items: center;\n                padding: 0 10px;\n                font-size: 16px;\n                color: #ea3636;\n                cursor: pointer;\n            }\n        }\n\n        .bk-form-control {\n            display: block;\n            width: auto;\n        }\n    }\n</style>\n","<template>\n    <div class=\"global-bariable-batch-operation\">\n        <table>\n            <thead>\n                <tr>\n                    <th style=\"width: 130px;\">{{ '变量类型' }}<span class=\"require-flag\" /></th>\n                    <th>{{ '变量名称' }}<span class=\"require-flag\" /></th>\n                    <th>\n                        <span v-bk-tooltips=\"'请输入变量的初始值 [可选]'\" class=\"hover-tips\">\n                            {{ '初始值' }}\n                        </span>\n                    </th>\n                    <th style=\"width: 320px;\">{{ '变量描述' }}</th>\n                    <th style=\"width: 80px;\">\n                        <span v-bk-tooltips=\"'变量的值在执行中可变'\" class=\"hover-tips\">\n                            {{ '赋值可变' }}\n                        </span>\n                    </th>\n                    <th style=\"width: 100px;\">{{ '执行时必填' }}</th>\n                    <th style=\"width: 80px;\">{{ '操作' }}</th>\n                </tr>\n            </thead>\n            <template v-for=\"(variableItem, index) in variableList\">\n                <render-table-row\n                    v-if=\"variableItem.id > 0 && variableItem.delete !== 1\"\n                    ref=\"variableEdit\"\n                    :variable-name-list=\"calcExcludeNameList(variableItem)\"\n                    :data=\"variableItem\"\n                    :key=\"variableItem.id\"\n                    @on-change=\"value => handleChange(index, value)\"\n                    @on-delete=\"handleDelete(index)\"\n                    @on-append=\"handleAppendVariable(index)\" />\n                <!-- 自定义表格进行, 行内增删 -->\n                <create-table-row\n                    v-else-if=\"variableItem.id < 0\"\n                    ref=\"variableCreate\"\n                    :key=\"variableItem.id\"\n                    :variable-name-list=\"calcExcludeNameList(variableItem)\"\n                    :data=\"variableItem\"\n                    @on-change=\"value => handleChange(index, value)\"\n                    @on-delete=\"handleDelete(index)\"\n                    @on-append=\"handleAppendVariable(index)\" />\n            </template>\n        </table>\n        <div\n            v-if=\"isEmpty\"\n            class=\"empty-box\"\n            @click=\"handleAppendVariable(0)\">\n            <Icon type=\"add-fill\" />\n            <span>{{ '全局变量' }}</span>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import GlobalVariableModel from '@model/task/global-variable';\n    import RenderTableRow from './render-table-row.vue';\n    import CreateTableRow from './create-table-row.vue';\n    import { createVariable } from '../util';\n\n    export default {\n        name: '',\n        components: {\n            RenderTableRow,\n            CreateTableRow,\n        },\n        props: {\n            variable: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                variableList: _.cloneDeep(this.variable),\n            };\n        },\n        computed: {\n            isEmpty () {\n                // eslint-disable-next-line no-plusplus\n                for (let i = 0; i < this.variableList.length; i++) {\n                    if (!this.variableList[i].delete) {\n                        return false;\n                    }\n                }\n                return true;\n            },\n        },\n        methods: {\n            /**\n             * @desc 不包含当前索引变量的变量名列表\n             * @param { Object } variableData 变量数据\n             * @returns { Array }\n             *\n             * 不包含变量名为空和已删除的变量\n             */\n            calcExcludeNameList (variableData) {\n                return this.variableList.reduce((result, item) => {\n                    if (variableData.id !== item.id\n                        && item.name\n                        && item.delete !== 1) {\n                        result.push(item.name);\n                    }\n                    return result;\n                }, []);\n            },\n            /**\n             * @desc 更新变量信息\n             * @param {Number} index 编辑的变量索引\n             * @param {Object} variableData 全局变量数据\n             */\n            handleChange (index, variableData) {\n                const variableList = [...this.variableList];\n                const variable = new GlobalVariableModel(variableData);\n                variableList.splice(index, 1, variable);\n                this.variableList = variableList;\n                window.changeAlert = true;\n            },\n            /**\n             * @desc 删除指定索引的变量\n             * @param {Number} index 编辑的变量索引\n             */\n            handleDelete (index) {\n                const variableList = [...this.variableList];\n                const editVariable = variableList[index];\n                if (editVariable.id > 0) {\n                    // 删除已存在的变量——设置delete\n                    editVariable.delete = 1;\n                } else {\n                    // 删除新建的变量——直接删除\n                    variableList.splice(index, 1);\n                }\n                this.variableList = variableList;\n                window.changeAlert = true;\n            },\n            /**\n             * @desc 在指定索引位置添加一个新变量\n             * @param {Number} index 编辑的变量索引\n             */\n            handleAppendVariable (index) {\n                this.variableList.splice(index + 1, 0, createVariable());\n                window.changeAlert = true;\n            },\n            /**\n             * @desc 提交编辑\n             * @returns {Promise}\n             */\n            submit () {\n                const queue = [];\n                if (this.$refs.variableEdit) {\n                    queue.push(...this.$refs.variableEdit.map(item => item.validate()));\n                }\n                if (this.$refs.variableCreate) {\n                    queue.push(...this.$refs.variableCreate.map(item => item.validate()));\n                }\n                return Promise.all(queue)\n                    .then(() => this.$emit('on-change', this.variableList));\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .global-bariable-batch-operation {\n        table {\n            width: 100%;\n            font-size: 12px;\n            line-height: 18px;\n            color: #63656e;\n            border: 1px solid #dcdee5;\n            border-radius: 2px;\n            table-layout: fixed;\n\n            thead {\n                background: #fafbfd;\n            }\n\n            th,\n            td {\n                height: 41px;\n                padding-right: 5px;\n                padding-left: 15px;\n                text-align: left;\n            }\n\n            th {\n                font-weight: normal;\n                color: #313238;\n            }\n\n            td {\n                padding-top: 5px;\n                padding-bottom: 5px;\n                border-top: 1px solid #dcdee5;\n            }\n\n            .hover-tips {\n                padding-bottom: 2px;\n                border-bottom: 1px dashed #c4c6cc;\n            }\n\n            .require-flag {\n                &::after {\n                    display: inline-block;\n                    height: 8px;\n                    font-size: 12px;\n                    line-height: 1;\n                    color: #ea3636;\n                    vertical-align: middle;\n                    content: \"*\";\n                }\n            }\n\n            .action-row {\n                user-select: none;\n\n                .action-btn {\n                    font-size: 18px;\n                    color: #c4c6cc;\n                    cursor: pointer;\n                }\n            }\n        }\n\n        .empty-box {\n            display: flex;\n            height: 32px;\n            margin-top: 6px;\n            font-size: 12px;\n            color: #979ba5;\n            cursor: pointer;\n            background: #fcfdff;\n            border: 1px dashed #c4c6cc;\n            border-radius: 2px;\n            align-items: center;\n            justify-content: center;\n\n            i {\n                margin-right: 7px;\n                font-size: 14px;\n                color: #c4c6cc;\n            }\n\n            &:hover {\n                color: #3a84ff;\n                border-color: #3a84ff;\n\n                i {\n                    color: #3a84ff;\n                }\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"job-variable-detail\">\n        <table class=\"info-table\">\n            <tr\n                v-for=\"(item, index) in describeMap\"\n                :key=\"index\"\n                class=\"variable-item\">\n                <td class=\"info-label\">{{ item.label }}</td>\n                <td class=\"info-value\">\n                    <jb-edit-textarea :field=\"item.filed\" :value=\"data[item.filed]\" readonly />\n                </td>\n            </tr>\n        </table>\n        <template v-if=\"data.isHost\">\n            <server-panel\n                style=\"margin-top: 20px;\"\n                detail-fullscreen\n                :host-node-info=\"data.defaultTargetValue.hostNodeInfo\" />\n        </template>\n    </div>\n</template>\n<script>\n       import GlobalVariableModel from '@model/task/global-variable';\n    import ServerPanel from '@components/choose-ip/server-panel';\n    import JbEditTextarea from '@components/jb-edit/textarea';\n\n    const type = () => ({ label: '变量类型', filed: 'typeText' });\n    const name = () => ({ label: '变量名称', filed: 'name' });\n    const defaultValue = (defaultField = '初始值') => ({ label: defaultField, filed: 'valueText' });\n    const description = () => ({ label: '变量描述', filed: 'description' });\n    const changeable = () => ({ label: '赋值可变', filed: 'changeableText' });\n    const required = () => ({ label: '必填', filed: 'requiredText' });\n\n    const generateVariableDescribeMap = (defaultField = '初始值') => ({\n        [GlobalVariableModel.TYPE_STRING]: [type(), name(), defaultValue(defaultField), description(), changeable(), required()],\n        [GlobalVariableModel.TYPE_NAMESPACE]: [type(), name(), defaultValue(defaultField), description(), required()],\n        [GlobalVariableModel.TYPE_HOST]: [type(), name(), defaultValue(defaultField), description(), required()],\n        [GlobalVariableModel.TYPE_PASSWORD]: [type(), name(), defaultValue(defaultField), description(), required()],\n        [GlobalVariableModel.TYPE_RELATE_ARRAY]: [type(), name(), defaultValue(defaultField), description(), required()],\n        [GlobalVariableModel.TYPE_INDEX_ARRAY]: [type(), name(), defaultValue(defaultField), description(), required()],\n    });\n    \n    export default {\n        name: 'GlobalVarView',\n        components: {\n            ServerPanel,\n            JbEditTextarea,\n        },\n        props: {\n            data: {\n                type: Object,\n                default () {\n                    return {};\n                },\n            },\n            defaultField: {\n                type: String,\n                default: '初始值',\n            },\n        },\n        computed: {\n            describeMap () {\n                return generateVariableDescribeMap(this.defaultField)[this.data.type];\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .job-variable-detail {\n        padding-bottom: 20px;\n        font-size: 14px;\n        color: #63656e;\n\n        .info-table {\n            width: 100%;\n            line-height: 24px;\n\n            td {\n                padding-top: 9px;\n                padding-bottom: 9px;\n                border: 1px solid #dde4eb;\n            }\n        }\n\n        .info-label {\n            width: 110px;\n            padding-right: 20px;\n            color: #b2b5bd;\n            text-align: right;\n        }\n\n        .info-value {\n            padding-left: 21px;\n            word-break: break-all;\n        }\n    }\n</style>\n","<template>\n    <jb-form :model=\"formData\" ref=\"varHostForm\">\n        <jb-form-item :label=\"'变量名称'\">\n            <bk-input v-model=\"formData.name\" disabled />\n        </jb-form-item>\n        <jb-form-item :label=\"'变量值'\">\n            <section>\n                <bk-button @click=\"handleShowChooseIp\">\n                    <Icon type=\"plus\" />\n                    {{ '选择主机' }}\n                </bk-button>\n                <bk-button style=\"margin-left: 10px;\" v-if=\"isShowClear\" @click=\"handleClear\">\n                    {{ '清空' }}\n                </bk-button>\n            </section>\n            <server-panel\n                class=\"view-server-panel\"\n                :host-node-info=\"formData.defaultTargetValue.hostNodeInfo\"\n                editable\n                detail-fullscreen\n                @on-change=\"handleHostChange\" />\n        </jb-form-item>\n        <jb-form-item :label=\"'变量描述'\">\n            <bk-input v-model=\"formData.description\" disabled type=\"textarea\" :row=\"5\" maxlength=\"100\" />\n        </jb-form-item>\n        <jb-form-item>\n            <bk-checkbox v-model=\"formData.required\" disabled :true-value=\"1\" :false-value=\"0\">{{ '必填' }}</bk-checkbox>\n        </jb-form-item>\n        <choose-ip\n            v-model=\"isShowChooseIp\"\n            :host-node-info=\"formData.defaultTargetValue.hostNodeInfo\"\n            @on-change=\"handleHostChange\" />\n    </jb-form>\n</template>\n<script>\n    import TaskGlobalVariableModel from '@model/task/global-variable';\n    import TaskHostNodeModel from '@model/task-host-node';\n    import ChooseIp from '@components/choose-ip';\n    import ServerPanel from '@components/choose-ip/server-panel';\n\n    const getDefaultData = () => ({\n        id: 0,\n        delete: 0,\n        // 变量名\n        name: '',\n        // 执行目标信息\n        defaultTargetValue: {\n            hostNodeInfo: {},\n            variable: '',\n        },\n        // 变量描述\n        description: '',\n        // 必填 0-非必填 1-必填\n        required: 0,\n    });\n\n    export default {\n        name: 'VarHost',\n        components: {\n            ChooseIp,\n            ServerPanel,\n        },\n        props: {\n            data: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                formData: {},\n                isShowChooseIp: false,\n            };\n        },\n        computed: {\n            isShowClear () {\n                return !TaskHostNodeModel.isHostNodeInfoEmpty(this.formData.defaultTargetValue.hostNodeInfo);\n            },\n        },\n        watch: {\n            data: {\n                handler (data) {\n                    this.formData = new TaskGlobalVariableModel(data);\n                },\n                immediate: true,\n            },\n        },\n        methods: {\n            handleHostChange (hostNodeInfo) {\n                this.formData.defaultTargetValue.hostNodeInfo = Object.freeze(hostNodeInfo);\n            },\n            handleShowChooseIp () {\n                this.isShowChooseIp = true;\n            },\n\n            handleClear () {\n                const { hostNodeInfo } = new TaskHostNodeModel({});\n                this.formData.defaultTargetValue.hostNodeInfo = hostNodeInfo;\n            },\n            submit () {\n                return Promise.resolve({\n                    ...this.formData,\n                    type: TaskGlobalVariableModel.TYPE_HOST,\n                });\n            },\n\n            reset () {\n                this.formData = new TaskGlobalVariableModel(getDefaultData);\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\" scoped>\n    .view-server-panel {\n        margin-top: 10px;\n    }\n</style>\n","<template>\n    <jb-form :model=\"formData\" ref=\"varArrayForm\">\n        <jb-form-item :label=\"'数组类型'\">\n            <div class=\"array-type-group\">\n                <bk-radio-group :value=\"arrayType\">\n                    <bk-radio-button\n                        class=\"item\"\n                        :value=\"5\"\n                        >\n                        {{ '关联数组' }}\n                    </bk-radio-button>\n                    <bk-radio-button\n                        class=\"item\"\n                        :value=\"6\"\n                        >\n                        {{ '索引数组' }}\n                    </bk-radio-button>\n                </bk-radio-group>\n            </div>\n        </jb-form-item>\n        <jb-form-item :label=\"'变量名称'\">\n            <bk-input v-model=\"formData.name\" disabled />\n        </jb-form-item>\n        <jb-form-item :label=\"'变量值'\">\n            <bk-input\n                v-model=\"formData.defaultValue\"\n                :native-attributes=\"{ autofocus: 'autofocus' }\" />\n        </jb-form-item>\n        <jb-form-item :label=\"'变量描述'\">\n            <bk-input v-model=\"formData.description\" disabled type=\"textarea\" :row=\"5\" maxlength=\"100\" />\n        </jb-form-item>\n        <jb-form-item>\n            <bk-checkbox\n                v-model=\"formData.changeable\"\n                disabled\n                :true-value=\"1\"\n                :false-value=\"0\">\n                {{ '赋值可变' }}\n            </bk-checkbox>\n        </jb-form-item>\n        <jb-form-item>\n            <bk-checkbox\n                v-model=\"formData.required\"\n                disabled\n                :true-value=\"1\"\n                :false-value=\"0\">\n                {{ '必填' }}\n            </bk-checkbox>\n        </jb-form-item>\n    </jb-form>\n</template>\n<script>\n    const getDefaultData = () => ({\n        id: 0,\n        delete: 0,\n        // 变量名\n        name: '',\n        // 默认值\n        defaultValue: '',\n        // 变量描述\n        description: '',\n        // 赋值可变 0-不可变 1-可变\n        changeable: 0,\n        // 必填 0-非必填 1-必填\n        required: 0,\n    });\n    export default {\n        name: 'VarString',\n        props: {\n            data: {\n                type: Object,\n                default () {\n                    return {};\n                },\n            },\n        },\n        data () {\n            return {\n                arrayType: 5,\n                formData: getDefaultData(),\n            };\n        },\n        watch: {\n            data: {\n                handler (value) {\n                    if (Object.keys(value).length) {\n                        const { name, defaultValue, description, changeable, required, id, type } = value;\n                        this.formData = {\n                            name,\n                            defaultValue,\n                            description,\n                            changeable,\n                            required,\n                            id,\n                            delete: value.delete,\n                        };\n                        this.arrayType = type;\n                    }\n                },\n                immediate: true,\n            },\n        },\n        methods: {\n            submit () {\n                return Promise.resolve({\n                    ...this.formData,\n                    type: this.arrayType,\n                });\n            },\n\n            reset () {\n                this.formData = getDefaultData();\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .array-type-group {\n        position: relative;\n        z-index: 1;\n\n        .item {\n            .bk-radio-button-text {\n                width: 108px;\n            }\n        }\n    }\n</style>\n","<template>\n    <jb-form form-type=\"vertical\">\n        <jb-form-item\n            :label=\"'变量类型'\"\n            required\n            :desc=\"nametips\">\n            <bk-radio-group v-model=\"globalType\">\n                <bk-radio-button\n                    class=\"item\"\n                    value=\"string\"\n                    \n                    :name=\"'字符串'\">\n                    {{ '字符串' }}\n                </bk-radio-button>\n                <bk-radio-button\n                    class=\"item\"\n                    value=\"namespace\"\n                    >\n                    {{ '命名空间' }}\n                </bk-radio-button>\n                <bk-radio-button\n                    class=\"item\"\n                    value=\"host\"\n                    >\n                    {{ '主机列表' }}\n                </bk-radio-button>\n                <bk-radio-button\n                    class=\"item\"\n                    value=\"password\"\n                    >\n                    {{ '密文' }}\n                </bk-radio-button>\n                <bk-radio-button\n                    class=\"item\"\n                    value=\"array\"\n                    >\n                    {{ '数组' }}\n                </bk-radio-button>\n            </bk-radio-group>\n        </jb-form-item>\n        <component\n            ref=\"handler\"\n            :is=\"globalVarCom\"\n            :variable=\"variable\"\n            :data=\"data\" />\n    </jb-form>\n</template>\n<script>\n       import VarString from './string';\n    import VarNamespace from './namespace';\n    import VarHost from './host';\n    import VarPassword from './password';\n    import VarArray from './array';\n\n    export default {\n        name: 'GlobalVar',\n        components: {\n            VarString,\n            VarNamespace,\n            VarHost,\n            VarPassword,\n            VarArray,\n        },\n        props: {\n            variable: {\n                type: Array,\n                default () {\n                    return [];\n                },\n            },\n            data: {\n                type: Object,\n                default () {\n                    return {};\n                },\n            },\n        },\n        data () {\n            return {\n                globalType: 'string',\n            };\n        },\n        computed: {\n            globalVarCom () {\n                const globalVarMap = {\n                    string: VarString,\n                    namespace: VarNamespace,\n                    host: VarHost,\n                    password: VarPassword,\n                    array: VarArray,\n                };\n                if (!Object.prototype.hasOwnProperty.call(globalVarMap, this.globalType)) {\n                    return 'div';\n                }\n                return globalVarMap[this.globalType];\n            },\n            isTypeDisabled () {\n                return !!Object.keys(this.data).length;\n            },\n        },\n        watch: {\n            data: {\n                handler (value) {\n                    if (Object.keys(value).length) {\n                        this.globalType = value.typeDescription;\n                    }\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.nametips = {\n                theme: 'dark',\n                content: '在步骤参数或脚本内使用 ${变量名} 即可获取到变量值',\n                width: 200,\n            };\n        },\n        methods: {\n            submit () {\n                return this.$refs.handler.submit()\n                    .then((data) => {\n                        this.$emit('on-change', data);\n                    });\n            },\n            reset () {\n                this.globalType = 1;\n                return this.$refs.handler.reset();\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .variable-type-wraper {\n        .item {\n            .bk-radio-button-text {\n                width: 108px;\n            }\n        }\n    }\n</style>\n","<template>\n    <div\n        ref=\"detail\"\n        class=\"global-variable-popover-detail\"\n        :class=\"classes\"\n        :style=\"styles\">\n        <div class=\"wraper\">\n            <div class=\"header\">\n                <span>{{ data.name }}</span>\n                <span\n                    v-if=\"editOfPlan && !selectValue.includes(data.name)\"\n                    class=\"tag\">\n                    {{ '未引用' }}\n                </span>\n            </div>\n            <detail-layout>\n                <detail-item :label=\"'变量类型：'\">\n                    {{ data.typeText }}\n                </detail-item>\n                <detail-item :label=\"`${defaultField}：`\">\n                    {{ data.valueText }}\n                </detail-item>\n                <detail-item :label=\"'变量描述：'\">\n                    {{ data.description || '--' }}\n                </detail-item>\n                <detail-item :label=\"'必填：'\">\n                    {{ data.requiredText }}\n                </detail-item>\n                <detail-item :label=\"'赋值可变：'\">\n                    {{ data.changeableText }}\n                </detail-item>\n            </detail-layout>\n        </div>\n    </div>\n</template>\n<script>\n       import DetailLayout from '@components/detail-layout';\n    import DetailItem from '@components/detail-layout/item';\n\n    export default {\n        name: 'GlobalVariablePopoverDetail',\n        components: {\n            DetailLayout,\n            DetailItem,\n        },\n        props: {\n            data: {\n                type: Object,\n                required: true,\n            },\n            selectValue: {\n                type: Array,\n                required: true,\n            },\n            editOfPlan: {\n                type: Boolean,\n                DEFAULT: false,\n            },\n            defaultField: {\n                type: String,\n                default: '初始值',\n            },\n        },\n        data () {\n            return {\n                position: 'left',\n                width: 300,\n                top: 0,\n                left: 0,\n            };\n        },\n        computed: {\n            classes () {\n                return {\n                    [`arrow-position-${this.position}`]: true,\n                };\n            },\n            styles () {\n                return {\n                    position: 'absolute',\n                    top: `${this.top}px`,\n                    left: `${this.left}px`,\n                    'z-index': window.__bk_zIndex_manager.nextZIndex(), // eslint-disable-line no-underscore-dangle\n                    width: `${this.width}px`,\n                };\n            },\n        },\n        mounted () {\n            this.init();\n        },\n        beforeDestroy () {\n            try {\n                if (this.$refs.detail && document.body.hasChildNodes(this.$refs.detail)) {\n                    document.body.removeChild(this.$refs.detail);\n                }\n            } catch (error) {}\n        },\n        methods: {\n            init () {\n                const windowWidth = window.innerWidth;\n                const $target = document.querySelector(`#globalVariableWithName_${this.data.name}`);\n                const { top, left } = $target.getBoundingClientRect();\n                this.top = top + 50;\n                this.left = left - 11;\n                if (windowWidth <= left + this.width) {\n                    this.left = left - 150;\n                    this.position = 'right';\n                }\n                document.body.appendChild(this.$refs.detail);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .global-variable-popover-detail {\n        border: 1px solid #dcdee5;\n        border-radius: 2px;\n        box-shadow: 0 0 5px 0 rgb(0 0 0 / 9%);\n\n        &.arrow-position-right {\n            &::before {\n                right: 128px;\n                left: unset;\n            }\n        }\n\n        &::before {\n            position: absolute;\n            top: -5px;\n            left: 20px;\n            width: 11px;\n            height: 11px;\n            background: #fff;\n            border: 1px solid #dcdee5;\n            content: \"\";\n            transform: rotateZ(45deg);\n            box-shadow: 0 0 5px 0 rgb(0 0 0 / 9%);\n        }\n\n        .wraper {\n            position: relative;\n            padding: 12px 13px;\n            background: #fff;\n            border-radius: 2px;\n\n            .header {\n                padding-bottom: 8px;\n                margin-bottom: 8px;\n                font-size: 14px;\n                color: #313238;\n                border-bottom: 1px solid #f0f1f5;\n\n                .tag {\n                    display: inline-block;\n                    height: 18px;\n                    padding: 0 6px;\n                    font-size: 12px;\n                    line-height: 18px;\n                    color: #979ba5;\n                    background-color: #f0f1f5;\n                    border-radius: 2px;\n                }\n            }\n\n            .detail-item {\n                margin-bottom: 0;\n                font-size: 12px;\n                line-height: 20px;\n            }\n\n            .detail-label {\n                color: #b2b5bd;\n            }\n\n            .detail-content {\n                /* stylelint-disable value-no-vendor-prefix */\n                display: -webkit-box;\n                max-height: 60px;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                word-break: break-all;\n                -webkit-box-orient: vertical;\n                -webkit-line-clamp: 3;\n            }\n        }\n    }\n</style>\n","<template>\n    <div id=\"templateVariableRender\">\n        <div v-if=\"showEmpty\">--</div>\n        <template v-else>\n            <div class=\"variable-batch-action\">\n                <bk-button\n                    v-if=\"isOperation\"\n                    text\n                    @click=\"handleShowBatchOperation\">\n                    <Icon type=\"bulk-edit\" />\n                    {{ '批量编辑' }}\n                </bk-button>\n                <bk-button\n                    v-if=\"isEditOfPlan\"\n                    text\n                    @click=\"handleShowBatchEditOfPlan\">\n                    <Icon type=\"bulk-edit\" />\n                    {{ '批量编辑变量值' }}\n                </bk-button>\n            </div>\n            <div class=\"task-global-variable-box\">\n                <template v-for=\"(item, index) in variable\">\n                    <div\n                        v-if=\"item.delete !== 1\"\n                        :key=\"`${item.name}_${index}`\"\n                        class=\"render-global-variable\"\n                        :class=\"[\n                            {\n                                'step-mode-diff': isDiff,\n                            },\n                            isSelect ?\n                                selectValue.includes(item.name) ? 'selected' : 'not-selected'\n                                : '',\n                        ]\">\n                        <div\n                            class=\"global-variable-content\"\n                            :class=\"[diff[item.id] && diff[item.id].type]\"\n                            @mouseenter=\"handleShowPopoverDetail(item)\"\n                            @mouseleave=\"handleHidePopoverDetail\"\n                            @click=\"handlerOperation(item, index)\">\n                            <div\n                                :id=\"`globalVariableWithName_${item.name}`\"\n                                class=\"variable-type\">\n                                <Icon :type=\"item.icon\" />\n                            </div>\n                            <div class=\"variable-info\">\n                                <div class=\"variable-name\">{{ item.name }}</div>\n                                <div class=\"variable-description\">{{ item.valueText }}</div>\n                            </div>\n                            <Icon\n                                v-if=\"isOperation\"\n                                type=\"close\"\n                                class=\"variable-delete-btn\"\n                                @click.stop=\"handleDelete(index)\" />\n                        </div>\n                    </div>\n                </template>\n                <div\n                    v-if=\"isOperation\"\n                    key=\"create\"\n                    class=\"global-variable-new\">\n                    <div\n                        class=\"new-btn\"\n                        v-test=\"{ type: 'button', value: 'create_global_variable' }\"\n                        @click=\"handleCreate\">\n                        <Icon type=\"plus\" class=\"create-flag\" />\n                        <span>{{ '全局变量' }}</span>\n                    </div>\n                    <div\n                        class=\"use-guide\"\n                        :class=\"{\n                            active: isShowUseGuide,\n                        }\"\n                        v-bk-tooltips=\"'使用指引'\"\n                        @click.stop=\"handleUseGuideToggle\">\n                        <Icon type=\"help-document-fill\" />\n                    </div>\n                </div>\n            </div>\n            <popover-detail\n                v-if=\"currentPopoverDetail.name\"\n                :data=\"currentPopoverDetail\"\n                :select-value=\"selectValue\"\n                :edit-of-plan=\"isEditOfPlan\"\n                :default-field=\"defaultField\" />\n            <element-teleport\n                v-if=\"isOperation\"\n                target=\"#templateOperationLayoutRight\">\n                <variable-use-guide\n                    v-if=\"isShowUseGuide\"\n                    @on-close=\"handleUseGuideClose\" />\n            </element-teleport>\n            <jb-sideslider\n                v-if=\"isView || isEditOfPlan\"\n                :is-show.sync=\"isShowDetail\"\n                :title=\"'查看全局变量'\"\n                :show-footer=\"false\"\n                ref=\"variableView\"\n                :media=\"detailMedia\">\n                <detail\n                    v-if=\"isShowDetail\"\n                    :data=\"currentData\"\n                    :default-field=\"defaultField\" />\n            </jb-sideslider>\n            <jb-sideslider\n                v-if=\"isEditOfPlan\"\n                :is-show.sync=\"isShowEditOfPlan\"\n                :title=\"'编辑全局变量'\"\n                :width=\"960\">\n                <edit-of-plan\n                    v-if=\"isShowEditOfPlan\"\n                    ref=\"planGlobalVar\"\n                    :data=\"currentData\"\n                    @on-change=\"handlePlanEditSubmit\" />\n            </jb-sideslider>\n            <jb-sideslider\n                v-if=\"isEditOfPlan\"\n                :is-show.sync=\"isShowBatchEditOfPlan\"\n                :title=\"'批量编辑变量值'\"\n                :width=\"960\"\n                :ok-text=\"'确定'\"\n                footer-offset-target=\"variable-value\">\n                <batch-edit-of-plan\n                    v-if=\"isShowBatchEditOfPlan\"\n                    ref=\"planGlobalVar\"\n                    :selected-list=\"selectValue\"\n                    :variable-list=\"variable\"\n                    @on-change=\"handleBatchPlanEditSubmit\" />\n            </jb-sideslider>\n            <jb-sideslider\n                v-if=\"isOperation\"\n                :is-show.sync=\"isShowOperation\"\n                v-bind=\"operationSideSliderInfo\"\n                :width=\"960\">\n                <operation\n                    v-if=\"isShowOperation\"\n                    ref=\"globalVar\"\n                    :variable=\"realVariable\"\n                    :data=\"currentData\"\n                    @on-change=\"handleOperationSubmit\" />\n            </jb-sideslider>\n            <jb-sideslider\n                v-if=\"isOperation\"\n                :is-show.sync=\"isShowBatchOperation\"\n                :title=\"'批量编辑变量'\"\n                :media=\"batchOperationMediaQuery\">\n                <batch-operation\n                    v-if=\"isShowBatchOperation\"\n                    :variable=\"variable\"\n                    @on-change=\"handleBatchOperationSubmit\" />\n            </jb-sideslider>\n        </template>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import VariableModel from '@model/task/global-variable';\n    import VariableUseGuide from '@/views/task-manage/common/variable-use-guide';\n    import Operation from './operation';\n    import BatchOperation from './batch-operation';\n    import Detail from './detail';\n    import EditOfPlan from './edit-of-plan';\n    import BatchEditOfPlan from './batch-edit-of-plan';\n    import PopoverDetail from './popover-detail';\n\n    export default {\n        name: 'RenderGlobalVar',\n        components: {\n            VariableUseGuide,\n            Operation,\n            BatchOperation,\n            Detail,\n            EditOfPlan,\n            BatchEditOfPlan,\n            PopoverDetail,\n        },\n        props: {\n            list: {\n                type: Array,\n                required: true,\n            },\n            /*\n             * @value ''：仅可查看详情\n             * @value 'operate': 可编辑可新建可删除\n             * @value 'select': 选择模式\n             * @value 'editOfPlan'：不可删除，使用执行方案的编辑功能\n             * @value 'viewOfPlan': 执行方案的查看功能\n             * @value 'diff'：diff场景\n             */\n            mode: {\n                type: String,\n                default: '',\n            },\n            selectValue: {\n                type: Array,\n                default: () => [],\n            },\n            defaultField: {\n                type: String,\n                default: '初始值',\n            },\n            diff: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                isShowDetail: false,\n                isShowUseGuide: false,\n                isShowOperation: false,\n                isShowBatchOperation: false,\n                isShowEditOfPlan: false,\n                isShowBatchEditOfPlan: false,\n                variable: [],\n                currentPopoverDetail: {},\n                currentData: {},\n                currentIndex: -1,\n                currentOperation: 'create',\n                detailMedia: [],\n            };\n        },\n        computed: {\n            /**\n             * @desc 展示数据为空时的文本\n             * @returns { Boolean }\n             */\n            showEmpty () {\n                if (this.isOperation) {\n                    return false;\n                }\n                return this.variable.length < 1;\n            },\n            /**\n             * @desc 新建、编辑全局变量\n             * @returns { Boolean }\n             */\n            isOperation () {\n                return this.mode === 'operate';\n            },\n            /**\n             * @desc 选择全局变量\n             * @returns { Boolean }\n             */\n            isSelect () {\n                return this.mode === 'select' || this.mode === 'editOfPlan';\n            },\n            /**\n             * @desc 编辑执行方案中的全局变量\n             * @returns { Boolean }\n             */\n            isEditOfPlan () {\n                return this.mode === 'editOfPlan';\n            },\n            /**\n             * @desc 查看全局变量\n             * @returns { Boolean }\n             */\n            isView () {\n                return !this.mode;\n            },\n            /**\n             * @desc 插卡全局变量同步对比差异\n             * @returns { Boolean }\n             */\n            isDiff () {\n                return this.mode === 'diff';\n            },\n            /**\n             * @desc 展示的全局变量不包含已删除\n             * @returns { Array }\n             */\n            realVariable () {\n                // 过滤掉已经删除的变量\n                const validVariable = this.variable.filter(item => !item.delete);\n                // 编辑操作不包含正在编辑的变量\n                if (this.currentOperation === 'edit') {\n                    return validVariable.filter(item => item.name !== this.currentData.name);\n                }\n                return validVariable;\n            },\n            /**\n             * @desc 变量编辑侧栏的展示信息\n             * @returns { Object }\n             */\n            operationSideSliderInfo () {\n                if (Object.keys(this.currentData).length < 1) {\n                    return {\n                        title: '新建全局变量',\n                        okText: '提交',\n                    };\n                }\n                return {\n                    title: '编辑全局变量',\n                    okText: '保存',\n                };\n            },\n        },\n        watch: {\n            list: {\n                handler (value) {\n                    this.variable = _.cloneDeep(value);\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.batchOperationMediaQuery = [1080, 1280, 1520, 1800];\n        },\n        methods: {\n            /**\n             * @desc 更新外部数据\n             */\n            triggerChange () {\n                this.$emit('on-change', this.variable);\n            },\n            /**\n             * @desc 显示全局变量详情tips\n             * @param {Object} variableInfo 全局变量详情\n             */\n            handleShowPopoverDetail (variableInfo) {\n                this.currentPopoverDetail = variableInfo;\n            },\n            /**\n             * @desc 隐藏全局变量详情tips\n             */\n            handleHidePopoverDetail () {\n                this.currentPopoverDetail = {};\n            },\n            /**\n             * @desc 批量编辑\n             */\n            handleShowBatchOperation () {\n                this.isShowBatchOperation = true;\n            },\n            /**\n             * @desc 批量编辑执行方案中变量值\n             */\n            handleShowBatchEditOfPlan () {\n                this.isShowBatchEditOfPlan = true;\n            },\n            /**\n             * @desc 点击全局变量\n             * @param {Object} variableInfo 全局变量详情\n             * @param {Index} index 点击变量的索引\n             */\n            handlerOperation (variableInfo, index) {\n                this.currentData = variableInfo;\n                if (this.isView) {\n                    this.detailMedia = variableInfo.type === VariableModel.TYPE_HOST ? [960] : [600, 660, 720, 780];\n                    this.isShowDetail = true;\n                    return;\n                }\n                this.currentOperation = 'edit';\n                this.currentIndex = index;\n                if (this.isEditOfPlan) {\n                    this.isShowEditOfPlan = true;\n                    return;\n                }\n                this.isShowOperation = true;\n            },\n            /**\n             * @desc 删除全局变量\n             * @param {Number} index 删除变量的索引\n             */\n            handleDelete (index) {\n                this.$bkInfo({\n                    title: '确定删除该全局变量？',\n                    subTitle: '若该变量被步骤引用，请及时检查并更新步骤设置',\n                    confirmFn: () => {\n                        const currentVar = this.variable[index];\n                        if (currentVar.id > 0) {\n                            // 删除已存在的变量\n                            //  —设置delete\n                            currentVar.delete = 1;\n                        } else {\n                            // 删除新建的变量\n                            //  —直接删除\n                            this.variable.splice(index, 1);\n                        }\n                        this.triggerChange();\n                    },\n                });\n            },\n            /**\n             * @desc 显示新建全局变量弹层\n             */\n            handleCreate () {\n                this.currentOperation = 'create';\n                this.currentData = {};\n                this.isShowOperation = true;\n                this.$refs.globalVar && this.$refs.globalVar.reset();\n            },\n            /**\n             * @desc 执行方案全局变量编辑\n             * @param {Object} payload 全局变量数据\n             */\n            handlePlanEditSubmit (payload) {\n                const variable = new VariableModel(payload);\n                this.variable.splice(this.currentIndex, 1, variable);\n                this.triggerChange();\n            },\n            /**\n             * @desc 批量编辑执行方案全局变量\n             * @param {Array} variableList 全局变量列表\n             */\n            handleBatchPlanEditSubmit (variableList) {\n                const variables = variableList.map(item => new VariableModel(item));\n                this.variable = variables;\n                this.triggerChange();\n            },\n            /**\n             * @desc 全局变量编辑\n             * @param {Object} payload 全局变量数据\n             */\n            handleOperationSubmit (payload) {\n                const payloadModel = new VariableModel(payload);\n                if (this.currentOperation === 'create') {\n                    // 新建变量——追加\n                    this.variable.push(payloadModel);\n                } else {\n                    // 编辑变量——替换\n                    this.variable.splice(this.currentIndex, 1, payloadModel);\n                }\n                this.triggerChange();\n                this.currentOperation = '';\n            },\n            /**\n             * @desc 全局变量批量编辑\n             * @param {Array} variableList 全局变量数据\n             */\n            handleBatchOperationSubmit (variableList) {\n                this.variable = variableList;\n                this.triggerChange();\n            },\n            handleUseGuideToggle () {\n                this.isShowUseGuide = !this.isShowUseGuide;\n            },\n            handleUseGuideClose () {\n                this.isShowUseGuide = false;\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    @import \"@/css/mixins/media\";\n\n    .task-global-variable-box {\n        display: flex;\n        flex-wrap: wrap;\n        align-items: center;\n        margin-top: -10px;\n\n        .render-global-variable {\n            margin-top: 10px;\n            margin-right: 10px;\n            cursor: pointer;\n            border-color: #3a84ff;\n\n            &.selected {\n                .global-variable-content {\n                    border-color: #3a84ff;\n                }\n            }\n\n            &.not-selected {\n                .variable-type {\n                    background: #dcdee5;\n                }\n            }\n        }\n\n        .global-variable-content {\n            position: relative;\n            display: flex;\n            width: 160px;\n            height: 50px;\n            padding: 0 10px;\n            background: #fff;\n            border: 1px solid #c4c6cc;\n            border-radius: 2px;\n            box-sizing: border-box;\n            transition: all 0.15s;\n            align-items: center;\n\n            &:hover {\n                background: #e1ecff;\n                border-color: #3a84ff;\n\n                .variable-delete-btn {\n                    opacity: 100%;\n                    visibility: visible;\n                    transform: scale(1);\n                }\n            }\n        }\n\n        .variable-type {\n            display: flex;\n            width: 30px;\n            height: 30px;\n            font-size: 18px;\n            color: #fff;\n            background: #3a84ff;\n            border-radius: 2px;\n            align-items: center;\n            justify-content: center;\n            flex: 0 0 30px;\n            transition: all 0.15s;\n        }\n\n        .variable-delete-btn {\n            position: absolute;\n            top: -9px;\n            right: -9px;\n            width: 18px;\n            height: 18px;\n            font-size: 14px;\n            line-height: 18px;\n            color: #fff;\n            cursor: pointer;\n            background: #c4c6cc;\n            border-radius: 50%;\n            opacity: 0%;\n            visibility: hidden;\n            transform: scale(0.8);\n            transition: all 0.25s;\n        }\n\n        .variable-info {\n            display: flex;\n            padding-left: 10px;\n            font-size: 12px;\n            line-height: 1;\n            color: #979ba5;\n            flex-direction: column;\n\n            .variable-name {\n                height: 16px;\n                max-width: 100px;\n                margin-bottom: 2px;\n                overflow: hidden;\n                font-size: 14px;\n                color: #63656e;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n\n            .variable-description {\n                height: 14px;\n                max-width: 138px;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n        }\n\n        .global-variable-new {\n            position: relative;\n            width: 160px;\n            margin-top: 10px;\n\n            .new-btn,\n            .use-guide {\n                cursor: pointer;\n\n                &:hover,\n                &.active {\n                    color: #3a84ff;\n                    border-color: #3a84ff;\n\n                    i {\n                        color: #3a84ff;\n                    }\n                }\n            }\n\n            .new-btn {\n                display: flex;\n                width: 100%;\n                height: 50px;\n                font-size: 14px;\n                color: #979ba5;\n                border: 1px dashed #c4c6cc;\n                border-radius: 2px;\n                box-sizing: border-box;\n                align-items: center;\n                justify-content: center;\n\n                .create-flag {\n                    margin-right: 5px;\n                    color: #c4c6cc;\n                }\n            }\n\n            .use-guide {\n                position: absolute;\n                top: 50%;\n                right: -29px;\n                display: flex;\n                width: 30px;\n                font-size: 14px;\n                color: #979ba5;\n                justify-content: center;\n                align-items: center;\n                transform: translateY(-50%);\n            }\n        }\n\n        .global-variable-content,\n        .global-variable-new {\n            @media (--small-viewports) {\n                width: 160px;\n            }\n\n            @media (--medium-viewports) {\n                width: 180px;\n            }\n\n            @media (--large-viewports) {\n                width: 200px;\n            }\n\n            @media (--huge-viewports) {\n                width: 220px;\n            }\n        }\n\n        .step-mode-diff {\n            cursor: default;\n\n            &::after {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                content: \"\";\n            }\n\n            .global-variable-content {\n                &.same {\n                    border-color: #c4c6cc;\n\n                    .variable-type {\n                        background: #979ba5;\n                    }\n                }\n\n                &.new {\n                    &::after {\n                        position: absolute;\n                        top: -6px;\n                        right: -6px;\n                        width: 28px;\n                        height: 14px;\n                        font-size: 12px;\n                        line-height: 14px;\n                        color: #fff;\n                        text-align: center;\n                        background: #ffa86e;\n                        content: \"new\";\n                    }\n                }\n\n                &.new,\n                &.different {\n                    position: relative;\n                    border-color: #f9c9a9;\n\n                    .variable-type {\n                        background: #f5c09e;\n                    }\n                }\n\n                &.delete {\n                    border-color: #dcdee5;\n\n                    .variable-type {\n                        background: #dcdee5;\n                    }\n\n                    .variable-info {\n                        .variable-name,\n                        .variable-description {\n                            color: #c4c6cc;\n                            text-decoration: line-through;\n                        }\n                    }\n                }\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"render-server-agent\">\n        <Icon\n            v-if=\"isLoading\"\n            class=\"rotate-loading\"\n            svg\n            type=\"sync-pending\" />\n        <div\n            v-else\n            class=\"agent-text\"\n            @click=\"handleShowDetail\">\n            <div v-if=\"data.normalNum > 0\">\n                {{ '正常' }}:<span class=\"success number\">{{ data.normalNum }}</span>\n            </div>\n            <div v-if=\"data.abnormalNum > 0\">\n                <span v-if=\"data.normalNum > 0\" class=\"splite\" />\n                {{ '异常' }}:<span class=\"error number\">{{ data.abnormalNum }}</span>\n            </div>\n            <span v-if=\"isEmpty\">--</span>\n        </div>\n        <lower-component level=\"custom\" :custom=\"isShowDetail\">\n            <jb-dialog\n                v-model=\"isShowDetail\"\n                :width=\"1020\"\n                :ok-text=\"'关闭'\"\n                class=\"render-server-detail-dialog\">\n                <template #header>\n                    <div class=\"variable-title\">\n                        <span>{{ title }}</span>\n                        <i class=\"global-variable-dialog-close bk-icon icon-close\" @click=\"handleClose\" />\n                    </div>\n                </template>\n                <div class=\"content-wraper\">\n                    <scroll-faker>\n                        <server-panel\n                            detail-mode=\"dialog\"\n                            :host-node-info=\"hostNodeInfo\" />\n                    </scroll-faker>\n                </div>\n            </jb-dialog>\n        </lower-component>\n    </div>\n</template>\n<script>\n    import AppManageService from '@service/app-manage';\n    import TaskHostNodeModel from '@model/task-host-node';\n    import ServerPanel from '@components/choose-ip/server-panel';\n    \n    export default {\n        name: '',\n        components: {\n            ServerPanel,\n        },\n        props: {\n            title: {\n                type: String,\n                required: true,\n            },\n            hostNodeInfo: {\n                type: Object,\n                required: true,\n            },\n            separator: {\n                type: String,\n                default: '，',\n            },\n        },\n        data () {\n            return {\n                isLoading: false,\n                isShowDetail: false,\n                data: {\n                    normalNum: 0,\n                    abnormalNum: 0,\n                },\n            };\n        },\n        computed: {\n            isEmpty () {\n                return TaskHostNodeModel.isHostNodeInfoEmpty(this.hostNodeInfo);\n            },\n        },\n        watch: {\n            hostNodeInfo () {\n                this.fetchData();\n            },\n        },\n        created () {\n            this.fetchData();\n        },\n        methods: {\n            fetchData () {\n                if (this.isEmpty || this.isLoading) {\n                    this.isLoading = false;\n                    return;\n                }\n                this.isLoading = true;\n                const { dynamicGroupList, ipList, topoNodeList } = this.hostNodeInfo;\n                AppManageService.fetchHostStatistics({\n                    appTopoNodeList: topoNodeList.map(topo => ({\n                        objectId: topo.type,\n                        instanceId: topo.id,\n                    })),\n                    dynamicGroupIds: dynamicGroupList,\n                    ipList: ipList.map(host => `${host.cloudAreaInfo.id}:${host.ip}`),\n                }).then((data) => {\n                    this.data = data;\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            handleShowDetail () {\n                this.isShowDetail = true;\n            },\n            handleClose () {\n                this.isShowDetail = false;\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .render-server-agent {\n        .agent-text {\n            display: flex;\n            flex-wrap: wrap;\n            align-items: center;\n            cursor: pointer;\n\n            .strong {\n                color: #3a84ff;\n            }\n\n            .error {\n                color: #ea3636;\n            }\n\n            .success {\n                color: #3fc06d;\n            }\n\n            .number {\n                padding: 0 4px;\n                font-weight: bold;\n            }\n\n            .splite {\n                padding-left: 16px;\n            }\n        }\n    }\n\n    .render-server-detail-dialog {\n        .bk-dialog-tool {\n            display: none;\n        }\n\n        .bk-dialog-header,\n        .bk-dialog-footer {\n            position: relative;\n            z-index: 99999;\n            background: #fff;\n        }\n\n        .bk-dialog-header {\n            padding: 0;\n        }\n\n        .bk-dialog-wrapper .bk-dialog-header .bk-dialog-header-inner {\n            font-size: 20px;\n            color: #000;\n            text-align: left;\n        }\n\n        .bk-dialog-wrapper .bk-dialog-body {\n            padding: 0;\n\n            .server-panel {\n                height: 100%;\n\n                &.show-detail {\n                    overflow: hidden;\n                }\n\n                .host-detail.show {\n                    padding-left: 20%;\n                }\n            }\n        }\n\n        .content-wraper {\n            height: 450px;\n            max-height: 450px;\n            min-height: 450px;\n            margin-top: -1px;\n        }\n\n        button[name=\"cancel\"] {\n            display: none;\n        }\n\n        .variable-title {\n            position: relative;\n            height: 68px;\n            padding-top: 0;\n            padding-bottom: 0;\n            padding-left: 25px;\n            font-size: 20px;\n            line-height: 68px;\n            color: #000;\n            text-align: left;\n            border-bottom: 1px solid #dcdee5;\n        }\n\n        .global-variable-dialog-close {\n            position: absolute;\n            top: 0;\n            right: 0;\n            font-size: 32px;\n            color: #c4c6cc;\n            cursor: pointer;\n            transition: all 0.15s;\n\n            &:hover {\n                transform: rotateZ(90deg);\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"job-smart-input\">\n        <div\n            ref=\"input\"\n            class=\"job-smart-input-area\"\n            contenteditable=\"true\"\n            spellcheck=\"false\"\n            :style=\"stylees\"\n            @input=\"handleInput\"\n            @focus=\"handleFocus\"\n            @blur=\"handleBlur\"\n            @paste=\"handlePaste\" />\n        <div v-if=\"showPlaceholder\" class=\"job-smart-input-placeholder\" @click=\"handleInputFocus\">{{ placeholder }}</div>\n    </div>\n</template>\n<script>\n    export default {\n        name: '',\n        props: {\n            value: {\n                type: String,\n                default: '',\n            },\n            placeholder: String,\n            resize: {\n                type: Boolean,\n                default: false,\n            },\n        },\n        data () {\n            return {\n                localValue: this.value,\n                focused: false,\n            };\n        },\n        computed: {\n            stylees () {\n                const styles = {};\n                if (this.focused) {\n                    styles['z-index'] = 1999;\n                } else {\n                    styles.height = '30px';\n                    styles.overflow = 'hidden';\n                    styles['white-space'] = 'pre';\n                    styles['text-overflow'] = 'ellipsis';\n                }\n                return styles;\n            },\n            showPlaceholder () {\n                if (this.focused) {\n                    return false;\n                }\n                return !this.localValue;\n            },\n        },\n        mounted () {\n            this.init();\n        },\n        methods: {\n            init () {\n                this.$refs.input.innerText = this.value;\n            },\n            focus () {\n                this.$refs.input.focus();\n            },\n            handleInputFocus () {\n                this.focus();\n                setTimeout(() => {\n                    this.$refs.input.selectionStart = this.localValue.length;\n                    this.$refs.input.selectionEnd = this.localValue.length;\n                });\n            },\n            handleInput (event) {\n                const value = event.target.outerText;\n                this.localValue = value.trim();\n                this.$emit('input', this.localValue);\n                this.$emit('change', this.localValue);\n            },\n            handleFocus () {\n                this.focused = true;\n            },\n            handleBlur () {\n                this.focused = false;\n                this.$refs.input.scrollTop = 0;\n                this.$emit('blur', this.localValue);\n            },\n            handlePaste (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                let text = '';\n                const event = (e.originalEvent || e);\n                if (event.clipboardData && event.clipboardData.getData) {\n                    text = event.clipboardData.getData('text/plain');\n                } else if (window.clipboardData && window.clipboardData.getData) {\n                    text = window.clipboardData.getData('Text');\n                }\n                if (document.queryCommandSupported('insertText')) {\n                    document.execCommand('insertText', false, text);\n                } else {\n                    document.execCommand('paste', false, text);\n                }\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    @import \"@/css/mixins/scroll\";\n\n    .job-smart-input {\n        position: relative;\n        height: 30px;\n        padding: 0 10px;\n        font-size: 12px;\n        line-height: 18px;\n        word-break: break-all;\n        cursor: pointer;\n        background: #fff;\n\n        .job-smart-input-area {\n            @mixin scroller;\n\n            position: absolute;\n            top: 0;\n            right: 0;\n            left: 0;\n            max-height: 300px;\n            min-height: 32px;\n            padding: 6px 10px;\n            overflow-y: scroll;\n            font-size: 12px;\n            color: #63656e;\n            background: inherit;\n            border: 1px solid #c4c6cc;\n            border-radius: 2px;\n            outline: none;\n\n            &:focus {\n                background: #fff !important;\n                border: 1px solid #3a84ff !important;\n            }\n        }\n\n        .job-smart-input-placeholder {\n            position: absolute;\n            top: 1px;\n            right: 1px;\n            bottom: 1px;\n            left: 1px;\n            height: 30px;\n            padding: 6px 10px;\n            overflow: hidden;\n            color: #c4c6cc;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n            background: transparent;\n        }\n    }\n</style>\n","<template>\n    <div\n        ref=\"editBox\"\n        class=\"edit-source-file\"\n        :class=\"{ 'path-error': !!error }\"\n        :data-error=\"error\">\n        <template v-if=\"mode === 'edit'\">\n            <div class=\"path-text\" :style=\"styles\" @click=\"handleShowEdit\">\n                <bk-popover placement=\"right\">\n                    <div v-for=\"(item, index) in displayRows\" :key=\"index\" class=\"path-text-row\">\n                        {{ item }}\n                    </div>\n                    <div v-if=\"hasMore\">...</div>\n                    <ul slot=\"content\" class=\"source-file-tips-box\">\n                        <li\n                            v-for=\"(item, index) in renderValue\"\n                            :key=\"index\"\n                            class=\"row\">\n                            <span class=\"dot\" />\n                            {{ item }}\n                        </li>\n                    </ul>\n                </bk-popover>\n            </div>\n            <smart-input\n                v-if=\"showEdit\"\n                ref=\"pathEdit\"\n                class=\"file-path-edit\"\n                :placeholder=\"'Enter 换行可输入多个路径'\"\n                :value=\"tempValue\"\n                @input=\"handleEditChange\"\n                @blur=\"handleEditSubmit\" />\n        </template>\n        <template v-if=\"mode === 'input'\">\n            <smart-input\n                class=\"file-path-create\"\n                ref=\"pathSubmit\"\n                :placeholder=\"'Enter 换行可输入多个路径'\"\n                @input=\"handleCreateSubmit\"\n                @blur=\"handleCreteaBlur\" />\n        </template>\n        <div v-if=\"error\" class=\"error-flag\" v-bk-tooltips=\"error\">\n            <Icon type=\"info\" />\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import SmartInput from '@components/smart-input';\n    import {\n        filePathRule,\n    } from '@utils/validator';\n\n    const formatValue = str => str.split('\\n').reduce((result, item) => {\n        const realValue = _.trim(item);\n        if (realValue) {\n            result.push(realValue);\n        }\n        return result;\n    }, []);\n\n    const DISPLAY_ROW_NUMS = 3;\n\n    export default {\n        name: '',\n\n        components: {\n            SmartInput,\n        },\n        props: {\n            value: {\n                type: Array,\n                default: '',\n            },\n            mode: {\n                type: String,\n                default: 'edit',\n            },\n        },\n        data () {\n            return {\n                showEdit: false,\n                isError: false,\n                renderValue: [],\n                tempValue: '',\n                error: '',\n            };\n        },\n        computed: {\n            displayRows () {\n                return this.renderValue.slice(0, DISPLAY_ROW_NUMS);\n            },\n            hasMore () {\n                return this.renderValue.length > DISPLAY_ROW_NUMS;\n            },\n            styles () {\n                if (this.showEdit) {\n                    return {\n                        visibility: 'hidden',\n                    };\n                }\n                return {\n                    visibility: 'visible',\n                };\n            },\n        },\n        watch: {\n            value: {\n                handler  (newValue) {\n                    this.renderValue = newValue;\n                    this.tempValue = newValue.join('\\n');\n                },\n                immediate: true,\n            },\n        },\n        methods: {\n            handleShowEdit () {\n                this.showEdit = true;\n                this.$nextTick(() => {\n                    this.$refs.pathEdit.focus();\n                });\n            },\n            handleEditChange (value) {\n                this.error = '';\n                if (!value) {\n                    this.error = '路径不能为空';\n                }\n                this.tempValue = value;\n            },\n            handleEditSubmit () {\n                if (this.error) {\n                    this.$refs.pathEdit.focused = true;\n                    return;\n                }\n                \n                const realValue = formatValue(this.tempValue);\n                \n                const hasError = !realValue.every(item => filePathRule.validator(item));\n                if (hasError) {\n                    this.error = '路径格式不正确';\n                    this.showEdit = true;\n                    this.$refs.pathEdit.focused = true;\n                    return;\n                }\n                this.showEdit = false;\n                this.renderValue = realValue;\n                this.$emit('on-change', realValue);\n            },\n            handleCreateSubmit (value) {\n                this.tempValue = value;\n                const realValue = formatValue(this.tempValue);\n                const isError = !realValue.every(item => filePathRule.validator(item));\n                if (isError) {\n                    this.error = '路径格式不正确';\n                    return;\n                }\n                this.error = '';\n                this.renderValue = realValue;\n                this.$emit('on-change', realValue);\n            },\n            handleCreteaBlur () {\n                if (this.error) {\n                    this.$refs.pathSubmit.focused = true;\n                }\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    @import \"@/css/mixins/scroll\";\n\n    .edit-source-file {\n        position: relative;\n        display: flex;\n        width: 100%;\n        margin-left: -10px;\n        font-size: 12px;\n        border-radius: 2px;\n\n        &.path-error {\n            .file-path-edit,\n            .file-path-create {\n                .job-smart-input-area {\n                    border-color: #ea3636;\n                }\n            }\n        }\n\n        .path-text {\n            width: 100%;\n            padding: 6px 10px;\n            cursor: pointer;\n            border: 1px solid transparent !important;\n            border-radius: 2px;\n\n            &:hover {\n                background: #f0f1f5;\n            }\n\n            .bk-tooltip,\n            .bk-tooltip-ref {\n                display: flex;\n                flex-direction: column;\n            }\n\n            .path-text-row {\n                width: 100%;\n                height: 18px;\n                max-width: 100%;\n                overflow: hidden;\n                line-height: 18px;\n                text-overflow: ellipsis;\n                word-break: keep-all;\n                white-space: normal;\n            }\n        }\n\n        .file-path-edit,\n        .file-path-create {\n            width: 100%;\n\n            .job-smart-input-area {\n                min-height: 30px;\n                border-color: transparent;\n            }\n        }\n\n        .file-path-edit {\n            position: absolute;\n            top: 0;\n            left: 0;\n        }\n\n        .file-path-create {\n            background: #f7f8fa;\n\n            &:hover {\n                background: #f0f1f5;\n            }\n        }\n\n        .error-flag {\n            position: absolute;\n            top: 0;\n            right: 0;\n            z-index: 1999;\n            display: flex;\n            align-items: center;\n            height: 30px;\n            padding: 0 6px;\n            font-size: 16px;\n            color: #ea3636;\n            cursor: pointer;\n        }\n    }\n\n    .source-file-tips-box {\n        max-width: 300px;\n        max-height: 280px;\n        min-width: 60px;\n        overflow-y: auto;\n\n        @mixin scroller;\n\n        .row {\n            word-break: break-all;\n        }\n\n        .dot {\n            display: inline-block;\n            width: 6px;\n            height: 6px;\n            background: currentColor;\n            border-radius: 50%;\n        }\n    }\n</style>\n","<template>\n    <div class=\"server-file-edit-box\" v-bkloading=\"{ isLoading }\">\n        <table>\n            <thead>\n                <th>{{ '文件路径' }}</th>\n                <th>{{ '服务器列表' }}</th>\n                <th>{{ 'Agent 状态' }}</th>\n                <th>{{ '服务器账号' }}</th>\n                <th>{{ '操作' }}</th>\n            </thead>\n            <tbody>\n                <tr v-for=\"(row, index) in serverFileList\" :key=\"index\">\n                    <td>\n                        <edit-file-path\n                            :value=\"row.fileLocation\"\n                            @on-change=\"value => handleFilePathEdit(value, index)\" />\n                    </td>\n                    <td>\n                        <!-- 编辑主机变量 -->\n                        <div\n                            v-if=\"row.isVar\"\n                            class=\"global-variable-render-box\"\n                            :class=\"{ 'value-error': !row.host.variable }\"\n                            style=\"margin-left: -10px;\">\n                            <bk-select\n                                class=\"variable-edit-select\"\n                                :value=\"row.host.variable\"\n                                :clearable=\"false\"\n                                @change=\"value => handleVariableChange(value, index)\"\n                                searchable>\n                                <bk-option\n                                    v-for=\"(option, variableIndex) in variable\"\n                                    :key=\"variableIndex\"\n                                    :id=\"option.name\"\n                                    :name=\"option.name\" />\n                            </bk-select>\n                            <Icon\n                                v-if=\"!row.host.variable\"\n                                type=\"info\"\n                                class=\"error-tips\"\n                                v-bk-tooltips=\"'全局变量被删除，重新设置'\" />\n                        </div>\n                        <!-- 手动添加主机 -->\n                        <div\n                            v-else\n                            class=\"server-edit-btn\"\n                            @click=\"handleHostEdit(index)\"\n                            v-html=\"row.serverDesc\" />\n                    </td>\n                    <td>\n                        <!-- 展示服务器列表主机信息 -->\n                        <render-server-agent\n                            v-if=\"!row.isVar\"\n                            :title=\"`${'服务器文件-服务器列表'}`\"\n                            :host-node-info=\"row.host.hostNodeInfo\"\n                            key=\"host\"\n                            :separator=\"agentSeparator\" />\n                        <!-- 展示变量的主机信息 -->\n                        <render-server-agent\n                            v-else\n                            :title=\"`${'全局变量'} - ${row.host.variable}`\"\n                            :host-node-info=\"findVariableValue(row.serverDesc)\"\n                            :key=\"row.serverDesc\"\n                            :separator=\"agentSeparator\" />\n                    </td>\n                    <td>\n                        <account-select\n                            class=\"account-add-btn\"\n                            :value=\"row.account\"\n                            type=\"system\"\n                            @change=\"value => handleAccountChange(value, index)\" />\n                    </td>\n                    <td>\n                        <bk-button text @click=\"handlerRemove(index)\">\n                            {{ '移除' }}\n                        </bk-button>\n                    </td>\n                </tr>\n            </tbody>\n            <component\n                :is=\"addCom\"\n                key=\"add\"\n                v-bind=\"$attrs\"\n                :data=\"serverFileList\"\n                :account=\"accountList\"\n                :variable=\"variable\"\n                @on-change=\"handleAddSave\"\n                @on-cancel=\"handleAddCancel\" />\n        </table>\n        <lower-component level=\"custom\" :custom=\"isShowChooseIp\">\n            <choose-ip\n                v-model=\"isShowChooseIp\"\n                required\n                :host-node-info=\"currentHost\"\n                @on-change=\"handleHostChange\" />\n        </lower-component>\n    </div>\n</template>\n<script>\n    import { mapMutations } from 'vuex';\n    import AccountManageService from '@service/account-manage';\n    import TaskHostNodeModel from '@model/task-host-node';\n    import ChooseIp from '@components/choose-ip';\n    import RenderServerAgent from '@components/render-server-agent';\n    import AccountSelect from '@components/account-select';\n    import AddOnlyHost from './only-host';\n    import AddHostAndVariable from './host-and-variable';\n    import EditFilePath from '../../components/edit-file-path';\n\n    export default {\n        name: 'SourceFileServer',\n        components: {\n            ChooseIp,\n            RenderServerAgent,\n            AccountSelect,\n            AddOnlyHost,\n            AddHostAndVariable,\n            EditFilePath,\n        },\n        inheritAttrs: false,\n        props: {\n            data: {\n                type: Array,\n                required: true,\n            },\n            mode: {\n                type: String,\n                default: '',\n            },\n            variable: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                isLoading: true,\n                serverFileList: [{},{},{}],\n                currentHost: {},\n                accountList: [{},{},{}],\n                isShowChooseIp: false,\n                currentIndex: 0,\n            };\n        },\n        computed: {\n            addCom () {\n                if (this.isLoading) {\n                    return 'div';\n                }\n                if (this.mode === 'onlyHost') {\n                    return AddOnlyHost;\n                }\n                return AddHostAndVariable;\n            },\n            agentSeparator () {\n                if (this.mode === 'onlyHost') {\n                    return '、';\n                }\n                return '\\n';\n            },\n        },\n        watch: {\n            data: {\n                handler (newData) {\n                    if (this.innerChange) {\n                        this.innerChange = false;\n                        return;\n                    }\n                    this.serverFileList = newData;\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.fetchAccount();\n            this.editNewSourceFile(false);\n        },\n        methods: {\n            ...mapMutations('distroFile', [\n                'editNewSourceFile',\n            ]),\n            /**\n             * @desc 获取系统账号列表\n             */\n            fetchAccount () {\n                AccountManageService.fetchAccountWhole({\n                    category: 1,\n                }).then((data) => {\n                    this.accountList = data;\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 从全局变量列表中查找指定全局变量的值\n             * @param {String} variableName 全局变量名\n             */\n            findVariableValue (variableName) {\n                const curVariable = this.variable.find(item => item.name === variableName);\n                if (!curVariable) {\n                    const {\n                        hostNodeInfo,\n                    } = new TaskHostNodeModel({});\n                    return hostNodeInfo;\n                }\n                return curVariable.defaultTargetValue.hostNodeInfo;\n            },\n            /**\n             * @desc 服务器文件更新\n             */\n            triggerChange () {\n                this.innerChange = true;\n                this.$emit('on-change', [\n                    ...this.serverFileList,\n                ]);\n            },\n            /**\n             * @desc 编辑服务器文件的路径\n             * @param {Array} fileLocation 服务器文件\n             * @param {Number} index 编辑中的服务器文件的索引\n             */\n            handleFilePathEdit (fileLocation, index) {\n                this.serverFileList[index].fileLocation = fileLocation;\n                this.triggerChange();\n            },\n            /**\n             * @desc 开始编辑服务器文件的主机——显示ip选择器弹框\n             * @param {Number} index 编辑中的服务器文件的索引\n             */\n            handleHostEdit (index) {\n                this.isShowChooseIp = true;\n                this.currentIndex = index;\n                this.currentHost = this.data[index].host.hostNodeInfo;\n            },\n            /**\n             * @desc 更新编辑服务器文件的主机\n             * @param {Object} hostNodeInfo 服务器主机信息\n             */\n            handleHostChange (hostNodeInfo) {\n                this.serverFileList[this.currentIndex].host.hostNodeInfo = hostNodeInfo;\n                this.triggerChange();\n            },\n            /**\n             * @desc 更新编辑服务器文件的全局变量\n             * @param {Array} variable 服务器主机信息\n             * @param {Number} index 编辑中的服务器文件的索引\n             */\n            handleVariableChange (variable, index) {\n                this.serverFileList[index].host.variable = variable;\n                this.triggerChange();\n            },\n            /**\n             * @desc 开始编辑服务器文件的服务器账号\n             * @param {Number} index 编辑中的服务器文件的索引\n             */\n            handleEditAccount (index) {\n                this.serverFileList[index].isEditAccount = true;\n                this.editAccountIndex = index;\n                this.triggerChange();\n            },\n            /**\n             * @desc 更新编辑服务器文件的服务器账号\n             * @param {Number} account 服务器账号id\n             * @param {Number} index 编辑中的服务器文件的索引\n             */\n            handleAccountChange (account, index) {\n                const serverFile = this.serverFileList[index];\n                serverFile.account = account;\n                this.triggerChange();\n            },\n            /**\n             * @desc 删除指定的服务器文件\n             * @param {Number} index 服务器文件的索引\n             */\n            handlerRemove (index) {\n                this.serverFileList.splice(index, 1);\n                this.triggerChange();\n            },\n            /**\n             * @desc 添加一条服务器文件\n             * @param {Object} serverFile 服务器文件\n             */\n            handleAddSave (serverFile) {\n                this.serverFileList.push(serverFile);\n                this.triggerChange();\n            },\n            /**\n             * @desc 取消添加一条服务器文件\n             */\n            handleAddCancel () {\n                if (this.serverFileList.length < 1) {\n                    this.$emit('on-close');\n                }\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .server-file-edit-box {\n        .global-variable-render-box {\n            position: relative;\n            border: 1px solid transparent;\n            border-radius: 2px;\n\n            &.value-error {\n                border-color: #ea3636;\n            }\n\n            .error-tips {\n                position: absolute;\n                top: 0;\n                right: 0;\n                z-index: 1999;\n                display: flex;\n                height: 30px;\n                padding: 0 6px;\n                font-size: 16px;\n                color: #ea3636;\n                cursor: pointer;\n                align-items: center;\n            }\n        }\n\n        .variable-edit-select,\n        .account-add-btn {\n            &:hover,\n            &.is-focus {\n                .bk-select-angle {\n                    display: block;\n                }\n            }\n\n            .bk-select-angle {\n                display: none;\n                font-size: 20px;\n            }\n        }\n\n        .account-add-btn,\n        .server-edit-btn,\n        .server-add-only-host-btn {\n            margin-left: -10px;\n        }\n\n        .server-add-btn,\n        .server-edit-btn,\n        .server-add-host {\n            cursor: pointer;\n            border-radius: 2px;\n\n            &:hover {\n                background: #f0f1f5;\n            }\n        }\n\n        .server-add-btn,\n        .server-add-host {\n            height: 30px;\n            line-height: 30px;\n        }\n\n        .server-edit-btn {\n            min-height: 30px;\n            padding: 5px 10px;\n            line-height: 20px;\n        }\n\n        .server-add-btn {\n            display: flex;\n            height: 30px;\n            margin-left: -10px;\n            font-size: 12px;\n            cursor: pointer;\n            background: #f7f8fa;\n            border-radius: 2px;\n            align-items: center;\n\n            .server-type-select {\n                flex: 0 0 auto;\n            }\n\n            .line {\n                height: 16px;\n                background: #dcdee5;\n                flex: 0 0 1px;\n            }\n\n            .server-add-variable {\n                flex: 1;\n            }\n\n            .server-add-host {\n                display: flex;\n                height: 30px;\n                font-size: 12px;\n                border-radius: 2px;\n                flex: 1;\n                align-items: center;\n                justify-content: center;\n            }\n        }\n\n        .server-add-only-host-btn {\n            display: flex;\n            height: 30px;\n            padding: 0 10px;\n            font-size: 12px;\n            cursor: pointer;\n            background: #f7f8fa;\n            border-radius: 2px;\n            align-items: center;\n            justify-content: center;\n\n            &:hover {\n                color: #979ba5;\n                background: #f0f1f5;\n            }\n\n            .add-flag {\n                margin-right: 6px;\n                margin-bottom: 2px;\n            }\n        }\n\n        .create-server-file {\n            tr {\n                td {\n                    border-top: 1px solid #dcdee5;\n                }\n            }\n        }\n\n        .bk-select {\n            height: 30px;\n            line-height: 30px;\n            border: none;\n\n            &:hover {\n                background: #f0f1f5;\n            }\n\n            .bk-select-name {\n                height: 30px;\n                padding-right: 16px;\n                padding-left: 10px;\n                line-height: 30px;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"sleect-source-file\">\n        <list-action-layout>\n            <jb-breadcrumb :width=\"645\">\n                <jb-breadcrumb-item>\n                    <Icon type=\"folder-open\" style=\"font-size: 20px;\" />\n                    <span>{{ '请选择文件源' }}</span>\n                </jb-breadcrumb-item>\n            </jb-breadcrumb>\n            <template #right>\n                <jb-input\n                    :placeholder=\"'搜索“所有文件源”'\"\n                    right-icon=\"bk-icon icon-search\"\n                    style=\"width: 480px;\"\n                    @change=\"handleSearch\" />\n            </template>\n        </list-action-layout>\n        <bk-table\n            :data=\"tableData\"\n            max-height=\"500\"\n            :highlight-current-row=\"true\"\n            v-bkloading=\"{ isLoading }\">\n            <bk-table-column width=\"50\">\n                <template slot-scope=\"{ row }\">\n                    <span v-html=\"row.publicFlagHtml\" />\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                :label=\"'文件源别名'\"\n                prop=\"alias\"\n                sortable>\n                <template slot-scope=\"{ row }\">\n                    <auth-button\n                        v-if=\"row.isAvailable\"\n                        auth=\"file_source/view\"\n                        :permission=\"row.canView\"\n                        :resource-id=\"row.id\"\n                        text\n                        @click=\"handleGoBucket(row)\">\n                        {{ row.alias }}\n                    </auth-button>\n                    <span\n                        v-else\n                        v-bk-tooltips=\"'接入点异常，暂时不可用'\">\n                        <bk-button disabled text>{{ row.alias }}</bk-button>\n                    </span>\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                :label=\"'文件源标识'\"\n                prop=\"code\"\n                show-overflow-tooltip\n                sortable />\n            <bk-table-column\n                :label=\"'状态'\"\n                prop=\"status\">\n                <template slot-scope=\"{ row }\">\n                    <Icon :type=\"row.statusIcon\" svg />\n                    {{ row.statusText }}\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                :label=\"'类型'\"\n                prop=\"create_time\">\n                <template slot-scope=\"{ row }\">\n                    {{ row.storageTypeText }}\n                </template>\n            </bk-table-column>\n            <bk-table-column\n                :label=\"'更新人'\"\n                prop=\"creator\" />\n            <bk-table-column\n                :label=\"'更新时间'\"\n                prop=\"lastModifyTime\" />\n        </bk-table>\n    </div>\n</template>\n<script>\n    import FileSourceManageService from '@service/file-source-manage';\n    import ListActionLayout from '@components/list-action-layout';\n    \n    export default {\n        components: {\n            ListActionLayout,\n        },\n        data () {\n            return {\n                isLoading: false,\n                tableData: [],\n                searchParams: [],\n            };\n        },\n        created () {\n            this.fetchData();\n        },\n        methods: {\n            /**\n             * @desc 获取文件源数据列表\n             */\n            fetchData () {\n                this.isLoading = true;\n                FileSourceManageService.availableSourceList(this.searchParams).then(({ data }) => {\n                    this.tableData = Object.freeze(data);\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n\n            /**\n             * @desc 过滤表格数据\n             * @param {String} alias 列表筛选值\n             *\n             * 重新拉取数据\n             */\n            handleSearch (alias) {\n                this.searchParams = {\n                    alias,\n                };\n                this.fetchData();\n            },\n\n            /**\n             * @desc 对话框页面显示跳转到bucket存储桶列表模板\n             * @param {Object} fileSource 选中的文件源数据\n             *\n             * 选中数据与将要跳转的组件名称传递到父组件\n             */\n            handleGoBucket (fileSource) {\n                this.$emit('on-source-change', fileSource);\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .sleect-source-file {\n        padding-top: 14px;\n\n        .list-action-layout {\n            margin-bottom: 14px;\n        }\n    }\n</style>\n","\n<template>\n    <div class=\"select-bucket\">\n        <list-action-layout>\n            <jb-breadcrumb\n                :width=\"645\"\n                @on-last=\"handleBackLast\"\n                :key=\"`${fileSourceInfo.alias}_${path}`\">\n                <jb-breadcrumb-item>\n                    <Icon type=\"folder-open\" style=\"font-size: 20px;\" />\n                    <span @click=\"handleGoSourceList\">{{ '文件源列表' }}</span>\n                </jb-breadcrumb-item>\n                <jb-breadcrumb-item>\n                    <span @click=\"handlePathLocation('')\">{{ fileSourceInfo.alias }}</span>\n                </jb-breadcrumb-item>\n                <jb-breadcrumb-item v-for=\"(item) in pathStack\" :key=\"item.path\">\n                    <span @click=\"handlePathLocation(item.path)\">{{ item.name }}</span>\n                </jb-breadcrumb-item>\n            </jb-breadcrumb>\n            <template #right>\n                <jb-input\n                    :placeholder=\"'搜索关键字'\"\n                    right-icon=\"bk-icon icon-search\"\n                    style=\"width: 480px;\"\n                    enter-trigger\n                    @submit=\"handleSearch\" />\n            </template>\n        </list-action-layout>\n        <div v-bkloading=\"{ isLoading }\">\n            <bk-table\n                :pagination=\"pagination\"\n                :data=\"tableData\"\n                @page-change=\"handlePageChange\">\n                <template v-for=\"(column, index) in renderColumns\">\n                    <render-file-list-column\n                        :column=\"column\"\n                        :row-selection=\"rowSelectMemo\"\n                        :render-header=\"renderHeader\"\n                        :link-handler=\"handleLink\"\n                        :select-handler=\"handleRowSelect\"\n                        :key=\"`${path}_${index}_${isLoading}_${wholeTableRowSelect}`\" />\n                </template>\n            </bk-table>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import FileService from '@service/file';\n    import ListActionLayout from '@components/list-action-layout';\n    import RenderFileListColumn, {\n        checkIsCheckboxColumn,\n        parseCondition,\n    } from '@components/render-file-list-column';\n\n    export default {\n        components: {\n            ListActionLayout,\n            RenderFileListColumn,\n        },\n        props: {\n            fileSourceId: {\n                type: Number,\n                required: true,\n            },\n            fileLocation: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                isLoading: false,\n                renderColumns: {},\n                tableData: [],\n                path: '',\n                name: '',\n                pagination: {\n                    count: 0,\n                    current: 1,\n                    limit: 10,\n                    'limit-list': [10],\n                    small: true,\n                    'show-total-count': true,\n                    'show-limit': false,\n                },\n                rowSelectMemo: {},\n                fileSourceInfo: { alias: 'alias' },\n            };\n        },\n        computed: {\n            /**\n             * @desc 面包屑路径\n             * @return {Array}\n             */\n            pathStack () {\n                return this.path.split('/').reduce((result, item) => {\n                    if (item) {\n                        const last = result.length > 0 ? result[result.length - 1].path : '';\n                         \n                        result.push({\n                            path: `${last}${item}/`,\n                            name: item,\n                        });\n                    }\n                    return result;\n                }, []);\n            },\n            /**\n             * @desc 列表选择状态\n             * @return {Object}\n             */\n            isPageCheckedInfo () {\n                let checkNums = 0;\n                let dirNums = 0;\n                const listNums = this.tableData.length;\n                if (Object.keys(this.rowSelectMemo).length > 0) {\n                    // eslint-disable-next-line no-plusplus\n                    for (let i = 0; i < listNums; i++) {\n                        const currentRow = this.tableData[i];\n                        if (currentRow.dir) {\n                            dirNums += 1;\n                            continue;\n                        }\n                        if (this.rowSelectMemo[currentRow.completePath]) {\n                            checkNums += 1;\n                        }\n                    }\n                }\n                return {\n                    checked: listNums > 0 && checkNums + dirNums === listNums,\n                    indeterminate: listNums > 0 && checkNums > 0,\n                };\n            },\n        },\n        watch: {\n            fileLocation: {\n                /**\n                 * @desc 编辑状态处理默认显示路径\n                 */\n                handler (fileLocation) {\n                    if (this.isInnerChange) {\n                        this.isInnerChange = false;\n                        return;\n                    }\n\n                    this.rowSelectMemo = Object.freeze(fileLocation.reduce((result, item) => {\n                        result[item] = true;\n                        return result;\n                    }, {}));\n                    const getLength = path => path.split('/').length;\n                    // 查找最短文件路径\n                    if (fileLocation.length > 0) {\n                        let [shortestPath] = fileLocation;\n                        fileLocation.forEach((currentFileLocation) => {\n                            if (getLength(shortestPath) > getLength(currentFileLocation)) {\n                                shortestPath = currentFileLocation;\n                            }\n                        });\n                        this.path = shortestPath.split('/').slice(0, -1)\n                            .join('/');\n                    }\n                    setTimeout(() => {\n                        this.fetchData();\n                    });\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.wholeTableRowSelect = false;\n            this.isInnerChange = false;\n        },\n        methods: {\n            /**\n             * @desc 获取bucket存储桶数据列表\n             */\n            fetchData () {\n                this.isLoading = true;\n                FileService.fetchgetListFileNode({\n                    fileSourceId: this.fileSourceId,\n                    path: this.path,\n                    name: this.name,\n                    pageSize: this.pagination.limit,\n                    start: parseInt(this.pagination.current - 1, 10) * this.pagination.limit,\n                }).then((data) => {\n                    this.tableData = Object.freeze(data.data);\n                    // 不显示文件操作列\n                    this.renderColumns = Object.freeze(data.metaData.properties.filter(_ => _.type !== 'buttonGroup'));\n                    this.fileSourceInfo = Object.freeze(data.fileSourceInfo);\n                    this.pagination = {\n                        ...this.pagination,\n                        count: data.total,\n                    };\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            renderHeader (h) {\n                return (\n                <bk-checkbox value={this.wholeTableRowSelect} onChange={this.handlePageSelectToggle} />\n                );\n            },\n            /**\n             * @desc 重置文件筛选条件\n             */\n            resetSearchParams () {\n                this.wholeTableRowSelect = false;\n                this.name = '';\n                this.pagination.current = 1;\n            },\n            triggerChange () {\n                this.isInnerChange = true;\n                this.$emit('on-file-change', Object.keys(this.rowSelectMemo));\n            },\n            /**\n             * @desc 文件路径返回上一级\n             */\n            handleBackLast () {\n                const lastPath = this.pathStack[this.pathStack.length - 2];\n                this.handlePathLocation(lastPath.path);\n            },\n            /**\n             * @desc 对话框页面显示跳转到文件源列表模板\n             *\n             * 重置已选的文件源\n             */\n            handleGoSourceList () {\n                this.$emit('on-source-change', {\n                    id: '',\n                });\n            },\n            /**\n             * @desc 面包屑切换列表\n             * @param {String} path 文件路径\n             *\n             * 重置 name 筛选\n             * 重置翻页\n             */\n            handlePathLocation (path) {\n                if (_.trim(path, '/') === _.trim(this.path, '/')) {\n                    return;\n                }\n                this.resetSearchParams();\n                this.path = path;\n                this.fetchData();\n            },\n            /**\n             * @desc 行数据跳转链接\n             * @param {String} path 文件路径\n             *\n             * 重置 name 筛选\n             * 重置翻页\n             */\n            handleLink (path) {\n                this.resetSearchParams();\n                this.path = path;\n                this.fetchData();\n            },\n            /**\n             * @desc 文件搜索\n             * @param {String} name 文件名\n             *\n             * 重置翻页\n             */\n            handleSearch (name) {\n                this.resetSearchParams();\n                this.name = name;\n                this.fetchData();\n            },\n            /**\n             * @desc 切换表格的全选状态\n             * @param {Boolean} isChecked 最新选中状态\n             */\n            handlePageSelectToggle (isChecked) {\n                this.isLoading = true;\n                FileService.fetchgetListFileNode({\n                    fileSourceId: this.fileSourceId,\n                    path: this.path,\n                    name: this.name,\n                    pageSize: -1,\n                    start: 0,\n                }).then((data) => {\n                    const tableData = data.data;\n                    const renderColumns = data.metaData.properties;\n\n                    const selectColumn = renderColumns.find(({ type }) => checkIsCheckboxColumn(type));\n                    if (!selectColumn) {\n                        return;\n                    }\n\n                    const rowSelectMemo = Object.assign({}, this.rowSelectMemo);\n\n                    tableData.forEach((rowData) => {\n                        if (!isChecked) {\n                            delete rowSelectMemo[rowData.completePath];\n                        } else if (parseCondition(selectColumn.enable, rowData)) {\n                            rowSelectMemo[rowData.completePath] = true;\n                        }\n                    });\n                    this.rowSelectMemo = Object.freeze(rowSelectMemo);\n                    this.triggerChange();\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 单行数据切换\n             * @param {String} completePath 最新展示页\n             * @param {Boolean} isChecked 最新选中状态\n             */\n            handleRowSelect (completePath, isChecked) {\n                const rowSelectMemo = Object.assign({}, this.rowSelectMemo);\n                if (isChecked) {\n                    rowSelectMemo[completePath] = true;\n                } else {\n                    delete rowSelectMemo[completePath];\n                }\n                this.rowSelectMemo = Object.freeze(rowSelectMemo);\n                this.triggerChange();\n            },\n            /**\n             * @desc 翻页\n             * @param {Number} current 最新展示页\n             */\n            handlePageChange (current) {\n                this.pagination.current = current;\n                this.fetchData();\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .select-bucket {\n        padding-top: 14px;\n\n        .list-action-layout {\n            margin-bottom: 14px;\n        }\n    }\n</style>\n","<template>\n    <jb-dialog\n        :value=\"value\"\n        class=\"choose-source-file\"\n        header-position=\"left\"\n        :esc-close=\"false\"\n        :mask-close=\"false\"\n        :width=\"1200\"\n        :title=\"'选择文件源文件'\"\n        @input=\"handleCancle\">\n        <div v-bkloading=\"{ isLoading }\">\n            <component\n                v-if=\"value\"\n                :is=\"panelCom\"\n                class=\"dialog-content\"\n                :file-source-id=\"fileSourceId\"\n                :file-location=\"fileLocation\"\n                @on-source-change=\"handleSourceChange\"\n                @on-file-change=\"handelFileChange\" />\n        </div>\n        <template #footer>\n            <bk-button\n                class=\"mr10\"\n                theme=\"primary\"\n                \n                @click=\"handleSubmit\">\n                <span>{{ '添加' }}</span>\n                <span v-if=\"!isSelectedEmpty\" class=\"result-nums\">{{ fileLocation.length }}</span>\n            </bk-button>\n            <bk-button @click=\"handleCancle\">{{ '取消' }}</bk-button>\n        </template>\n    </jb-dialog>\n</template>\n<script>\n    import SourceFileVO from '@domain/variable-object/source-file';\n    import SelectFileSource from './select-file-source';\n    import SelectFile from './select-file';\n\n    const SELECT_FILE_SOURCE = 'selectFileSource';\n    const SELECT_FILE = 'selectFile';\n    \n    export default {\n        components: {\n            SelectFileSource,\n            SelectFile,\n        },\n        props: {\n            value: {\n                type: Boolean,\n                defaule: false,\n            },\n            sourceFile: {\n                type: Object,\n                defaule: () => ({}),\n            },\n        },\n        data () {\n            return {\n                isLoading: false,\n                selectStep: SELECT_FILE_SOURCE,\n                fileSourceId: '',\n                fileLocation: [],\n            };\n        },\n        computed: {\n            panelCom () {\n                if (!this.fileSourceId) {\n                    return SelectFileSource;\n                }\n                const comMap = {\n                    [SELECT_FILE_SOURCE]: SelectFileSource,\n                    [SELECT_FILE]: SelectFile,\n                };\n                return comMap[this.selectStep];\n            },\n            isSelectedEmpty () {\n                return this.fileLocation.length < 1;\n            },\n        },\n        watch: {\n            value: {\n                /**\n                 * @desc 显示源文件选择框\n                 *\n                 * 1，有指定fileSourceId进入编辑状态\n                 * 解析fileSourceId、bucketName，定位到已选的文件夹\n                 * 2，没有指定fileSourceId进行新建状态\n                 *  先选择文件源\n                 *\n                 */\n                handler (value) {\n                    if (!value) {\n                        return;\n                    }\n                    if (this.sourceFile.fileSourceId) {\n                        const {\n                            fileSourceId,\n                            fileLocation,\n                        } = this.sourceFile;\n                        this.fileSourceId = fileSourceId;\n                        this.fileLocation = fileLocation;\n                        this.selectStep = SELECT_FILE;\n                    } else {\n                        this.fileSourceId = '';\n                        this.fileLocation = [];\n                        this.selectStep = SELECT_FILE_SOURCE;\n                    }\n                },\n                immediate: true,\n            },\n        },\n        methods: {\n            /**\n             * @desc 选中文件源\n             * @param {Object} fileSource 选中的文件源\n             *\n             * 选中fileSource时列表需要切换成bucket列表\n             *\n             */\n            handleSourceChange (fileSource) {\n                this.fileSourceId = fileSource.id;\n                this.selectStep = SELECT_FILE;\n                this.fileLocation = [];\n            },\n            /**\n             * @desc 选中文件\n             * @param {Array} fileLocation 选中的文件源\n             */\n            handelFileChange (fileLocation) {\n                this.fileLocation = Object.freeze([...fileLocation]);\n            },\n\n            /**\n             * @desc 确认按钮事件\n             *\n             * 选中文件后,过滤重新选择的文件与已选中文件\n             * 数据传递到父组件,关闭对话框\n             */\n            handleSubmit () {\n                const fileSourceObj = new SourceFileVO({\n                    fileSourceId: this.fileSourceId,\n                    fileType: 3,\n                    fileLocation: this.fileLocation,\n                });\n                this.$emit('on-change', fileSourceObj);\n                this.handleCancle();\n            },\n\n            /**\n             * @desc 取消按钮事件\n             */\n            handleCancle () {\n                this.$emit('input', false);\n            },\n\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .choose-source-file {\n        .result-nums {\n            display: inline-block;\n            min-width: 18px;\n            min-height: 18px;\n            padding: 0 5px;\n            font-size: 12px;\n            line-height: 18px;\n            color: #3a84ff;\n            text-align: center;\n            background-color: #fff;\n            border-radius: 10px;\n        }\n\n        .dialog-content {\n            height: 570px;\n        }\n    }\n</style>\n","<template>\n    <div class=\"render-file-source-name\" v-bkloading=\"{ isLoading }\">\n        <div @click=\"handleGoFileSource(fileSourceId)\">\n            {{ fileSourceAlias || '--' }}\n            <Icon type=\"edit\" class=\"link-flag\" svg />\n        </div>\n    </div>\n</template>\n<script>\n    import FileManageService from '@service/file-source-manage';\n\n    export default {\n        props: {\n            fileSourceId: {\n                type: Number,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                isLoading: false,\n                fileSourceAlias: '',\n            };\n        },\n        created () {\n            this.fetchSourceFileInfo();\n        },\n        methods: {\n            /**\n             * @desc 通过文件源id获取文件详细信息\n             */\n            fetchSourceFileInfo () {\n                FileManageService.getSourceInfo({\n                    id: this.fileSourceId,\n                }).then((data) => {\n                    this.fileSourceAlias = data.alias;\n                });\n            },\n            /**\n             * @desc 新窗口打开文件源列表页面\n             */\n            handleGoFileSource () {\n                const { href } = this.$router.resolve({\n                    name: 'fileList',\n                    query: {\n                        fileSourceId: this.fileSourceId,\n                    },\n                });\n                window.open(href, '_blank');\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .render-file-source-name {\n        cursor: pointer;\n\n        .link-flag {\n            opacity: 0%;\n        }\n\n        &:hover {\n            color: #3a84ff !important;\n\n            .link-flag {\n                opacity: 100%;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"render-source-file-name\">\n        <bk-popover placement=\"left\">\n            <div v-for=\"(item, fileIndex) in renderData\" :key=\"fileIndex\" class=\"path-text-row\">\n                {{ item }}\n            </div>\n            <div v-if=\"hasMore\">...</div>\n            <ul slot=\"content\" class=\"source-file-tips-box\">\n                <li v-for=\"(item, fileIndex) in data\" :key=\"fileIndex\" class=\"row\">\n                    <span class=\"dot\" />\n                    {{ item }}\n                </li>\n            </ul>\n        </bk-popover>\n    </div>\n</template>\n<script>\n    const DISPLAY_ROW_NUMS = 3;\n\n    export default {\n        name: '',\n        props: {\n            data: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {};\n        },\n        computed: {\n            renderData () {\n                return this.data.slice(0, DISPLAY_ROW_NUMS);\n            },\n            hasMore () {\n                return this.data.length > DISPLAY_ROW_NUMS;\n            },\n        },\n        methods: {},\n    };\n</script>\n<style lang=\"postcss\">\n    @import \"@/css/mixins/scroll\";\n\n    .render-source-file-name {\n        padding: 6px 10px;\n        margin-left: -10px;\n\n        &:hover {\n            background: #f0f1f5;\n        }\n    }\n\n    .source-file-tips-box {\n        max-width: 300px;\n        max-height: 280px;\n        min-width: 60px;\n        overflow-y: auto;\n\n        @mixin scroller;\n\n        .row {\n            word-break: break-all;\n        }\n\n        .dot {\n            display: inline-block;\n            width: 6px;\n            height: 6px;\n            background: currentColor;\n            border-radius: 50%;\n        }\n    }\n</style>\n","<template>\n    <div\n        v-show=\"isShow\"\n        class=\"source-file-edit-view-box\"\n        :class=\"mode ? mode : 'normal'\">\n        <bk-collapse v-model=\"activeResult\">\n            <jb-collapse-item\n                v-show=\"isShowLocalFile\"\n                content-hidden-type=\"hidden\"\n                name=\"local\"\n                :active=\"activeResult\">\n                <span>\n                    <span>{{ '已选择'}}<span class=\"number strong\">{{ localFileList.length }}</span>{{ '个本地文件' }}</span>\n                    <action-extend>\n                        <div class=\"action-item\" @click=\"handleRemoveAllLocal\">{{ '移除全部' }}</div>\n                    </action-extend>\n                </span>\n                <template #content>\n                    <local-file\n                        ref=\"localFile\"\n                        v-bind=\"$attrs\"\n                        :data=\"localFileList\"\n                        @on-change=\"handleLocalFileChange\" />\n                </template>\n            </jb-collapse-item>\n            <jb-collapse-item\n                v-show=\"isShowSourceFile\"\n                content-hidden-type=\"hidden\"\n                name=\"source\"\n                :active=\"activeResult\">\n                <span>{{ '已选择'}}<span class=\"number strong\">{{ sourceFileList.length }}</span>{{ '个源文件文件' }}</span>\n                <template #content>\n                    <source-file\n                        ref=\"sourceFile\"\n                        :data=\"sourceFileList\"\n                        @on-change=\"handleSourceFileChange\" />\n                </template>\n            </jb-collapse-item>\n            <jb-collapse-item\n                v-show=\"isShowServerFile\"\n                content-hidden-type=\"hidden\"\n                name=\"server\"\n                :active=\"activeResult\">\n                <span>{{ '已选择'}}<span class=\"number strong\">{{ serverFileList.length }}</span>{{ '个服务器文件' }}</span>\n                <template #content>\n                    <server-file\n                        v-bind=\"$attrs\"\n                        :mode=\"mode\"\n                        :data=\"serverFileList\"\n                        @on-change=\"handleServerFileChange\"\n                        @on-close=\"handleServerClose\" />\n                </template>\n            </jb-collapse-item>\n        </bk-collapse>\n    </div>\n</template>\n<script>\n    import JbCollapseItem from '@components/jb-collapse-item';\n    import ActionExtend from '../components/action-extend';\n    import LocalFile from './local';\n    import ServerFile from './server';\n    import SourceFile from './source';\n\n    export default {\n        name: 'SourceFileView',\n        components: {\n            JbCollapseItem,\n            ActionExtend,\n            LocalFile,\n            ServerFile,\n            SourceFile,\n        },\n        inheritAttrs: false,\n        model: {\n            prop: 'showAddServerFile',\n            event: 'update',\n        },\n        props: {\n            showAddServerFile: {\n                type: Boolean,\n                default: false,\n            },\n            isAddSourceFile: {\n                type: Boolean,\n                defaule: false,\n            },\n            /**\n             * @desc 文件来源使用场景\n             * @value onlyhost 快速执行执行场景，只会使用服务器主机\n             * @value normal 作业文件分发步骤，使用主机和主机变量\n             */\n            mode: {\n                type: String,\n                default: '',\n            },\n            data: {\n                type: Array,\n                default: () => [],\n            },\n            account: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                activeResult: [],\n                localFileList: [{},{},{}],\n                serverFileList: [{},{},{}],\n                sourceFileList: [{},{},{}],\n            };\n        },\n        computed: {\n            isShow () {\n                return this.isShowLocalFile || this.isShowServerFile || this.isShowSourceFile;\n            },\n            isShowLocalFile () {\n                return this.localFileList.length > 0;\n            },\n            isShowServerFile () {\n                return this.showAddServerFile;\n            },\n            isShowSourceFile () {\n                return this.sourceFileList.length > 0;\n            },\n        },\n        watch: {\n            data: {\n                handler (allSourceFile) {\n                    if (this.isInnerChange) {\n                        this.isInnerChange = false;\n                        return;\n                    }\n                    this.activeResult = [];\n                    this.localFileList = [];\n                    this.serverFileList = [];\n                    this.sourceFileList = [];\n                    allSourceFile.forEach((item) => {\n                        if (item.isServerFile) {\n                            this.serverFileList.push(item);\n                        } else if (item.isLocalFile) {\n                            this.localFileList.push(item);\n                        } else if (item.isSourceFile) {\n                            this.sourceFileList.push(item);\n                        }\n                    });\n                    if (this.localFileList.length > 0) {\n                        this.activeResult.push('local');\n                    }\n                    if (this.showAddServerFile || this.serverFileList.length > 0) {\n                        this.activeResult.push('server');\n                    }\n                    if (this.sourceFileList.length > 0) {\n                        this.activeResult.push('source');\n                    }\n                },\n                immediate: true,\n            },\n            showAddServerFile (value) {\n                if (value) {\n                    this.activeResult.push('server');\n                }\n            },\n            isAddSourceFile (value) {\n                if (value) this.activeResult.push('source');\n            },\n        },\n        methods: {\n            trigger () {\n                this.isInnerChange = true;\n                this.$emit('on-change', [...this.localFileList, ...this.serverFileList, ...this.sourceFileList]);\n            },\n            /**\n             * @desc 隐藏添加服务器文件输入框\n             */\n            handleServerClose () {\n                this.$emit('update', false);\n            },\n            /**\n             * @desc 服务器文件更新\n             * @param {Array} serverFileList\n             */\n            handleServerFileChange (serverFileList) {\n                if (serverFileList.length > 0) {\n                    this.activeResult = [...new Set([...this.activeResult, 'server'])];\n                }\n                this.serverFileList = Object.freeze(serverFileList);\n                this.trigger();\n            },\n            /**\n             * @desc 添加文件源文件\n             */\n            handleAddSourceFile () {\n                this.$refs.sourceFile.handleShowSourceDialog();\n            },\n            /**\n             * @desc 文件源文件更新\n             * @param {Array} sourceFileList\n             */\n            handleSourceFileChange (sourceFileList) {\n                if (sourceFileList.length > 0) {\n                    this.activeResult = [...new Set([...this.activeResult, 'source'])];\n                }\n                this.sourceFileList = Object.freeze(sourceFileList);\n                this.trigger();\n            },\n            /**\n             * @desc 开始上传本地文件\n             */\n            startUploadLocalFile () {\n                this.$refs.localFile.startUpload();\n            },\n            /**\n             * @desc 本地文件更新\n             * @param {Array} localFileList\n             */\n            handleLocalFileChange (localFileList) {\n                if (localFileList.length > 0) {\n                    this.activeResult = [...new Set([...this.activeResult, 'local'])];\n                }\n                this.localFileList = Object.freeze(localFileList);\n                this.trigger();\n            },\n            /**\n             * @desc 移除所有本地文件\n             */\n            handleRemoveAllLocal () {\n                this.localFileList = [];\n                this.trigger();\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n.source-file-edit-view-box {\n    flex: 1;\n\n    table {\n        width: 100%;\n        background: #fff;\n        table-layout: fixed;\n\n        tr:nth-child(n + 2) {\n            td {\n                border-top: 1px solid #dcdee5;\n            }\n        }\n\n        th,\n        td {\n            height: 41px;\n            padding: 5px 10px;\n            font-size: 12px;\n            text-align: left;\n            box-sizing: border-box;\n\n            &:first-child {\n                width: 40%;\n                padding-left: 60px;\n            }\n\n            &:nth-child(2) {\n                width: 15%;\n            }\n\n            &:nth-child(4) {\n                width: 20%;\n            }\n\n            &:last-child {\n                width: 105px !important;\n                text-align: left;\n\n                .bk-button-text ~ .bk-button-text {\n                    margin-left: 10px;\n                }\n            }\n        }\n\n        th {\n            font-weight: normal;\n            color: #313238;\n            border-bottom: 1px solid #dcdee5;\n        }\n\n        td {\n            line-height: 18px;\n            color: #63656e;\n            word-break: break-all;\n        }\n    }\n\n    &.normal {\n        .render-server-agent {\n            .agent-text {\n                flex-direction: column;\n                align-items: flex-start;\n            }\n\n            .splite {\n                display: none;\n            }\n        }\n\n        .upload-progress {\n            position: absolute;\n            width: 160px;\n        }\n\n        .file-server-agent,\n        .server-edit-btn,\n        .file-edit-server {\n            white-space: pre;\n        }\n    }\n    /* stylelint-disable selector-class-pattern */\n    &.onlyHost {\n        th,\n        td {\n            &:nth-child(3) {\n                width: 20%;\n            }\n        }\n\n        .upload-progress {\n            position: absolute;\n            width: 257px;\n        }\n\n        .sep-location {\n            &::before {\n                content: \"，\";\n            }\n        }\n    }\n\n    .bk-table-empty-block {\n        display: none;\n    }\n\n    .bk-button,\n    .bk-button-text {\n        font-size: 12px;\n    }\n}\n</style>\n","<template>\n    <div>\n        <jb-form-item\n            ref=\"item\"\n            :label=\"'源文件'\"\n            required\n            :property=\"field\"\n            :rules=\"rules\">\n            <div>\n                <bk-button\n                    class=\"mr10\"\n                    @click=\"handleAddServerFile\">\n                    <Icon type=\"plus\" />\n                    {{ '添加服务器文件' }}\n                </bk-button>\n                <bk-button\n                    v-if=\"ENABLE_FEATURE_FILE_MANAGE\"\n                    class=\"mr10\"\n                    @click=\"handleAddSourceFile\">\n                    <Icon type=\"plus\" />\n                    {{ '添加文件源文件' }}\n                </bk-button>\n                <bk-button\n                    class=\"mr10\"\n                    :loading=\"isConfigLoading\"\n                    @click=\"handlerUploadLocalFile\">\n                    <Icon type=\"plus\" />\n                    {{ '添加本地文件' }}\n                </bk-button>\n                <span class=\"source-file-tips\">\n                    {{ '添加本地文件会有同名文件覆盖风险' }}\n                    <Icon\n                        type=\"info\"\n                        class=\"tips-flag\"\n                        v-bk-tooltips=\"uploadFileTipsConfig\" />\n                </span>\n            </div>\n            <view-file\n                v-show=\"showFileView\"\n                v-model=\"isAddServerFile\"\n                ref=\"serverFileView\"\n                class=\"source-file-view\"\n                :data=\"sourceFileList\"\n                v-bind=\"$attrs\"\n                @on-change=\"handleSourceFileChange\" />\n        </jb-form-item>\n        <div id=\"uploadFileTips\" class=\"upload-file-tips\">\n            <div class=\"row\">{{ '支持中文文件名，本地上传文件大小不能超过' }} {{ fileMaxUploadSize }}</div>\n            <div class=\"row\">{{ '文件名支持使用通配符，如： /tmp/jobsvr_2020*'}}</div>\n            <div class=\"row\">{{ '文件名支持正则表达式写法以匹配多个文件，文件名前 需加 REGEX: 前缀，如：/tmp/REGEX:myfile-[A-Za-z]{0,10}'}}</div>\n            <div class=\"row\">{{ '如需分发文件目录，文件名请以/结束' }}</div>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import { mapMutations } from 'vuex';\n       import QuertGlobalSettingService from '@service/query-global-setting';\n    import ViewFile from './view';\n\n    export default {\n        name: 'SourceFileBase',\n        components: {\n            ViewFile,\n        },\n        inheritAttrs: false,\n        props: {\n            field: {\n                type: String,\n                default: '',\n            },\n            data: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                isConfigLoading: true,\n                isAddServerFile: false,\n                sourceFileList: [{},{},{}],\n                showFileView: false,\n                fileMaxUploadSize: '2GB',\n                ENABLE_FEATURE_FILE_MANAGE: false,\n            };\n        },\n        watch: {\n            data: {\n                handler (newSourceFileList) {\n                    if (this.isSelfChange) {\n                        this.isSelfChange = false;\n                        return;\n                    }\n                    if (newSourceFileList.length < 1 && this.sourceFileList.length > 0) {\n                        this.sourceFileList = [];\n                        return;\n                    }\n                    if (this.sourceFileList.length < 1) {\n                        this.sourceFileList = _.cloneDeep(newSourceFileList);\n                        this.isAddServerFile = this.sourceFileList.some(item => item.isServerFile);\n                    }\n                },\n                immediate: true,\n            },\n            sourceFileList (sourceFileList) {\n                if (sourceFileList.length > 0) {\n                    this.$refs.item.clearValidator();\n                }\n            },\n        },\n        created () {\n            this.rules = [\n                {\n                    validator: () => {\n                        if (this.sourceFileList.length < 1) {\n                            this.updateFileUploadFailed(false);\n                            this.updateFileUploading(false);\n                        }\n                        return this.sourceFileList.length;\n                    },\n                    message: '源文件必填',\n                    trigger: 'blur',\n                },\n                {\n                    validator: () => {\n                        // eslint-disable-next-line no-plusplus\n                        for (let i = 0; i < this.sourceFileList.length; i++) {\n                            const currentFile = this.sourceFileList[i];\n                            if (currentFile.isLocalFile\n                                && currentFile.uploadStatus === 'danger') {\n                                // 标记有本地文件上传失败\n                                this.updateFileUploadFailed(true);\n                                return false;\n                            }\n                        }\n                        this.updateFileUploadFailed(false);\n                        return true;\n                    },\n                    message: '本地源文件上传失败',\n                    trigger: 'blur',\n                },\n                {\n                    validator: () => {\n                        // eslint-disable-next-line no-plusplus\n                        for (let i = 0; i < this.sourceFileList.length; i++) {\n                            const currentFile = this.sourceFileList[i];\n                            if (currentFile.isLocalFile\n                                && currentFile.uploadStatus === 'primary') {\n                                // 标记有本地文件正在上传\n                                this.updateFileUploading(true);\n                                return false;\n                            }\n                        }\n                        this.updateFileUploading(false);\n                        return true;\n                    },\n                    message: '本地源文件上传未完成',\n                    trigger: 'change',\n                },\n                {\n                    validator: () => {\n                        // eslint-disable-next-line no-plusplus\n                        for (let i = 0; i < this.sourceFileList.length; i++) {\n                            const currentFile = this.sourceFileList[i];\n                            if (!currentFile.isServerFile) {\n                                continue;\n                            }\n                            // 服务器文件路径不能为空\n                            if (currentFile.fileLocation.length < 1) {\n                                return false;\n                            }\n                        }\n                        return true;\n                    },\n                    message: '服务器源文件路径必填',\n                    trigger: 'change',\n                },\n                {\n                    validator: () => {\n                        // eslint-disable-next-line no-plusplus\n                        for (let i = 0; i < this.sourceFileList.length; i++) {\n                            const currentFile = this.sourceFileList[i];\n                            if (!currentFile.isServerFile) {\n                                continue;\n                            }\n                            // 如果服务器列表使用的是主机变量\n                            if (currentFile.isVar && currentFile.host.isEmpty) {\n                                return false;\n                            }\n                        }\n                        return true;\n                    },\n                    message: '服务器源文件中服务器列表不能为空',\n                    trigger: 'change',\n                },\n            ];\n            this.uploadFileTipsConfig = {\n                allowHtml: true,\n                width: '335px',\n                theme: 'light',\n                trigger: 'mouseenter',\n                content: '#uploadFileTips',\n                placement: 'right-start',\n            };\n            this.fetchJobConfig();\n        },\n        mounted () {\n            const unWatch = this.$watch(() => this.$refs.serverFileView.isShow, (value) => {\n                this.showFileView = value;\n            }, {\n                immediate: true,\n            });\n            this.$once('hook:beforeDestroy', () => {\n                unWatch();\n            });\n        },\n        methods: {\n            ...mapMutations('distroFile', [\n                'updateFileUploading',\n                'updateFileUploadFailed',\n            ]),\n            /**\n             * @desc 获取系统配置\n             *\n             * 本地文件上传大小限制\n             */\n            fetchJobConfig () {\n                this.isConfigLoading = true;\n                QuertGlobalSettingService.fetchJobConfig()\n                    .then((data) => {\n                        const { amount, unit } = data.FILE_UPLOAD_SETTING;\n                        this.fileMaxUploadSize = `${amount}${unit}`;\n                        this.ENABLE_FEATURE_FILE_MANAGE = data.ENABLE_FEATURE_FILE_MANAGE;\n                    })\n                    .finally(() => {\n                        this.isConfigLoading = false;\n                    });\n            },\n            /**\n             * @desc 触发change事件\n             */\n            triggerChange () {\n                this.isSelfChange = true;\n                this.$emit('on-change', this.sourceFileList);\n            },\n            /**\n             * @desc 显示添加服务器文件输入框\n             */\n            handleAddServerFile () {\n                this.isAddServerFile = true;\n            },\n            /**\n             * @desc 显示添加文件源文件弹框\n             */\n            handleAddSourceFile () {\n                this.$refs.serverFileView.handleAddSourceFile();\n            },\n            /**\n             * @desc 选择本地文件开始上传\n             */\n            handlerUploadLocalFile () {\n                this.isAddLocalFile = true;\n                this.$refs.serverFileView.startUploadLocalFile();\n            },\n            /**\n             * @desc 更新文件来源的值\n             * @param {Array} souceFileList 文件源文件\n             */\n            handleSourceFileChange (souceFileList) {\n                this.sourceFileList = Object.freeze(souceFileList);\n                this.triggerChange();\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .source-file-view {\n        margin-top: 16px;\n    }\n\n    .upload-file-tips {\n        font-size: 12px;\n        line-height: 16px;\n        color: #63656e;\n\n        .row {\n            position: relative;\n            padding-left: 12px;\n\n            &::before {\n                position: absolute;\n                top: 6px;\n                left: 0;\n                width: 4px;\n                height: 4px;\n                background: currentcolor;\n                border-radius: 50%;\n                content: \"\";\n            }\n        }\n    }\n\n    .source-file-tips {\n        font-size: 12px;\n        color: #979ba5;\n\n        .tips-flag {\n            margin-left: 8px;\n            font-size: 14px;\n            color: #c4c6cc;\n            cursor: pointer;\n        }\n    }\n\n</style>\n","<template>\n    <div>\n        <jb-form-item\n            :label=\"'目标路径'\"\n            required\n            :property=\"field\"\n            :rules=\"rules\">\n            <div\n                class=\"form-item-content\"\n                @mouseenter=\"handleMouseenter\"\n                @mouseleave=\"handleMouseleave\">\n                <bk-input\n                    ref=\"input\"\n                    :placeholder=\"'请填写分发路径'\"\n                    @focus=\"handleInputFocus\"\n                    @blur=\"handleInputBlur\"\n                    @change=\"handleChange\"\n                    :value=\"formData[field]\" />\n            </div>\n        </jb-form-item>\n        <div style=\"display: none;\">\n            <div\n                ref=\"targetPathTips\"\n                class=\"target-path-tips\"\n                @mouseleave=\"handleMouseleave\"\n                @mouseenter=\"handleTipsMouseenter\">\n                <div class=\"row\">{{ '传输至linux服务器需以\\/开头的绝对路径，如：/data/xx' }}</div>\n                <div class=\"row\">{{ '传输至Windows服务器需包含盘符开头，如：D:\\\\tmp\\\\' }}</div>\n                <div class=\"row\">\n                    <div>{{ '目标路径支持的内置变量：（点击可直接复制使用）' }}</div>\n                    <table class=\"target-path-demo\">\n                        <thead>\n                            <tr>\n                                <th>{{ '变量名称' }}</th>\n                                <th>{{ '含义' }}</th>\n                                <th>{{ '示例' }}</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            <tr>\n                                <td @click=\"handleCopy('[FILESRCIP]')\">\n                                    <div class=\"copy-box\">\n                                        <span class=\"copy-value\">[FILESRCIP]</span>\n                                        <span class=\"copy-tips\">{{ '点击复制' }}</span>\n                                    </div>\n                                </td>\n                                <td>{{ '源服务器IP' }}</td>\n                                <td>0_192.168.0.100</td>\n                            </tr>\n                            <tr>\n                                <td @click=\"handleCopy('[DATE:yyyy-MM-dd]')\">\n                                    <div class=\"copy-box\">\n                                        <span class=\"copy-value\">[DATE:yyyy-MM-dd]</span>\n                                        <span class=\"copy-tips\">{{ '点击复制' }}</span>\n                                    </div>\n                                </td>\n                                <td>{{ '当前日期' }}</td>\n                                <td>2021-01-01</td>\n                            </tr>\n                        </tbody>\n                    </table>\n                </div>\n                <div class=\"row\">{{ '（日期变量可传入标准的日期时间格式，如 yyyy-MM-dd_HH:mm:ss）' }}</div>\n            </div>\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import Tippy from 'bk-magic-vue/lib/utils/tippy';\n       import {\n        execCopy,\n    } from '@utils/assist';\n    import {\n        filePathRule,\n    } from '@utils/validator';\n\n    export default {\n        props: {\n            field: {\n                type: String,\n                required: true,\n            },\n            formData: {\n                type: Object,\n                default: () => ({}),\n            },\n            tipsPlacement: {\n                type: String,\n                default: 'right-start',\n            },\n        },\n        watch: {\n            tipsPlacement (tipsPlacement) {\n                this.popperInstance && this.popperInstance.set({\n                    placement: tipsPlacement,\n                });\n            },\n        },\n        created () {\n            this.rules = [\n                {\n                    required: true,\n                    message: '目标路径必填',\n                    trigger: 'blur',\n                },\n                {\n                    validator: filePathRule.validator,\n                    message: '目标路径格式错误',\n                    trigger: 'blur',\n                },\n            ];\n            this.isMouseenter = false;\n        },\n        beforeDestroy () {\n            if (this.popperInstance) {\n                this.popperInstance.hide();\n                this.popperInstance.destroy();\n            }\n        },\n        methods: {\n            /**\n             * @desc 显示tips\n             */\n            showTips () {\n                if (!this.popperInstance) {\n                    this.popperInstance = Tippy(this.$refs.input.$el, {\n                        arrow: true,\n                        placement: this.tipsPlacement,\n                        trigger: 'manual',\n                        theme: 'light',\n                        interactive: true,\n                        hideOnClick: false,\n                        animation: 'slide-toggle',\n                        lazy: false,\n                        size: 'small',\n                        boundary: 'window',\n                        distance: 20,\n                        zIndex: window.__bk_zIndex_manager.nextZIndex(), // eslint-disable-line no-underscore-dangle\n                    });\n                    this.popperInstance.setContent(this.$refs.targetPathTips);\n                }\n                \n                this.popperInstance.show();\n            },\n            /**\n             * @desc 隐藏tips\n             */\n            hideTips () {\n                if (this.isMouseenter) {\n                    return;\n                }\n                this.popperInstance.hide();\n            },\n            /**\n             * @desc 鼠标移入的时候显示tips\n             */\n            handleMouseenter () {\n                clearTimeout(this.hideTimer);\n                this.showTips();\n            },\n            /**\n             * @desc 鼠标移出的时候隐藏tips\n             */\n            handleMouseleave () {\n                this.isMouseenter = false;\n                this.hideTimer = setTimeout(() => {\n                    if (!this.isInputFocus) {\n                        this.hideTips();\n                    }\n                }, 100);\n            },\n            /**\n             * @desc 获得焦点是显示ips\n             */\n            handleInputFocus () {\n                this.isInputFocus = true;\n                this.showTips();\n            },\n            /**\n             * @desc 失去焦点是显示ips\n             */\n            handleInputBlur () {\n                this.isInputFocus = false;\n                this.hideTips();\n            },\n            /**\n             * @desc 鼠标在tips内部时取消隐藏tips定时器\n             */\n            handleTipsMouseenter () {\n                clearTimeout(this.hideTimer);\n                this.isMouseenter = true;\n            },\n            /**\n             * @desc 复制变量\n             * @param {String} variable 目标路径支持的内置变量\n             */\n            handleCopy (variable) {\n                execCopy(variable);\n            },\n            /**\n             * @desc 更新字段值\n             */\n            handleChange (value) {\n                this.$emit('on-change', this.field, _.trim(value));\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .target-path-tips {\n        font-size: 12px;\n        line-height: 16px;\n        color: #63656e;\n\n        .row {\n            position: relative;\n            padding-left: 12px;\n            margin-bottom: 6px;\n\n            &::before {\n                position: absolute;\n                top: 6px;\n                left: 0;\n                width: 4px;\n                height: 4px;\n                background: currentColor;\n                border-radius: 50%;\n                content: \"\";\n            }\n        }\n\n        .target-path-demo {\n            width: 100%;\n            margin-top: 6px;\n\n            th,\n            td {\n                height: 40px;\n                padding: 0 10px;\n                border-bottom: 1px solid #dfe0e5;\n            }\n\n            th {\n                background-color: #fafbfd;\n            }\n\n            .copy-box {\n                display: flex;\n                width: 160px;\n                height: 26px;\n                padding: 0 10px;\n                margin: 0 -10px;\n                overflow: hidden;\n                line-height: 26px;\n                cursor: pointer;\n                border-radius: 2px;\n\n                &:hover {\n                    background: #f0f1f5;\n\n                    .copy-tips {\n                        display: block;\n                    }\n                }\n\n                .copy-value {\n                    overflow: hidden;\n                    text-overflow: ellipsis;\n                    white-space: nowrap;\n                }\n\n                .copy-tips {\n                    display: none;\n                    margin-left: auto;\n                    flex: 0 0 auto;\n                }\n            }\n        }\n    }\n</style>\n","<template>\n    <jb-form-item :label=\"'传输模式'\" required>\n        <div class=\"form-item-content\">\n            <div class=\"file-step-transfer-mode-wraper\">\n                <bk-radio-group class=\"radio-check\" :value=\"formData[field]\" @change=\"handleChange\">\n                    <bk-radio v-bk-tooltips=\"constraintTips\" :value=\"2\">{{ '强制模式' }}</bk-radio>\n                    <bk-radio v-bk-tooltips=\"strictTips\" :value=\"1\">{{ '严谨模式' }}</bk-radio>\n                </bk-radio-group>\n            </div>\n        </div>\n    </jb-form-item>\n</template>\n<script>\n   \n    export default {\n        name: '',\n        props: {\n            field: {\n                type: String,\n                required: true,\n            },\n            formData: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                radioValue: 2,\n            };\n        },\n        computed: {\n            // radio 选择框的值是-1表示是保险模式\n            // 保险模式有两种类型可选\n            showSelectCheck () {\n                return this.radioValue === -1;\n            },\n        },\n        watch: {\n            formData: {\n                // 值是3、4归类为保险模式\n                handler  (formData) {\n                    const transferMode = parseInt(formData[this.field], 10);\n                    if ([\n                        3,\n                        4,\n                    ].includes(transferMode)) {\n                        this.radioValue = -1;\n                    } else {\n                        this.radioValue = transferMode;\n                    }\n                },\n                immediate: true,\n                deep: true,\n            },\n        },\n        created () {\n            this.strictTips = {\n                content: '严谨判断目标路径是否存在，若不存在将直接终止任务。',\n                width: 180,\n            };\n            this.constraintTips = {\n                content: '不论目标路径是否存在，都将强制按照用户填写的目标路径进行传输（路径不存在会自动创建）。',\n                width: 210,\n            };\n            this.safeTips = {\n                content: '避免因源或目标机器有同名文件时被覆盖，该模式下将按用户选择的规则在目标路径后面追加创建相应的文件夹。',\n                width: 210,\n            };\n        },\n        methods: {\n            handleChange (transferMode) {\n                const realValue = transferMode === -1 ? 3 : transferMode;\n                this.$emit('on-change', this.field, realValue);\n            },\n            handleSelectChange (transferMode) {\n                this.$emit('on-change', this.field, transferMode);\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .file-step-transfer-mode-wraper {\n        display: flex;\n        align-items: center;\n        height: 32px;\n\n        .radio-check {\n            flex: 0 0 auto;\n            width: auto;\n\n            .bk-form-radio {\n                &:nth-child(n+2) {\n                    margin-left: 32px;\n                }\n            }\n\n            .bk-radio-text {\n                border-bottom: 1px dashed #c4c6cc;\n            }\n        }\n\n        .select-check {\n            flex: 1;\n            min-width: 295px;\n            margin-left: 12px;\n        }\n    }\n</style>\n",".compose-form-item {\n    display: inline-block;\n\n    & > .bk-form-control,\n    & > .bk-select,\n    & > .bk-cascade,\n    & > .bk-color-picker,\n    & > .bk-date-picker,\n    & > .bk-tag-input,\n    & > .bk-tag-selector,\n    & > .search-select-wrap,\n    & > .bk-button {\n        float: left;\n        width: auto;\n        margin-left: -1px;\n    }\n\n    .bk-form-input,\n    .bk-form-password,\n    .bk-form-textarea,\n    .bk-select,\n    .bk-cascade,\n    .bk-color-picker,\n    .bk-date-picker .bk-date-picker-editor,\n    .bk-tag-input,\n    .bk-search-select,\n    .bk-button {\n        border-radius: 0;\n    }\n\n    .bk-form-control.control-active,\n    .bk-select.is-focus,\n    .bk-cascade.is-focus,\n    .bk-color-picker.bk-color-picker-show-dropdown,\n    .bk-color-picker:hover,\n    .bk-date-picker .bk-date-picker-editor:focus,\n    .bk-tag-input.active,\n    .bk-tag-selector,\n    .bk-search-select.is-focus {\n        z-index: 0;\n        opacity: 100%;\n    }\n\n    .compose-form-item-first {\n        .bk-form-input,\n        .bk-form-password,\n        .bk-form-textarea,\n        &.bk-select,\n        &.bk-cascade,\n        &.bk-color-picker,\n        &.bk-date-picker .bk-date-picker-editor,\n        &.bk-tag-input,\n        .bk-tag-input,\n        .bk-search-select,\n        .bk-button {\n            margin-left: 0;\n            border-bottom-left-radius: 2px;\n            border-top-left-radius: 2px;\n        }\n    }\n\n    .compose-form-item-last {\n        .bk-form-input,\n        .bk-form-password,\n        .bk-form-textarea,\n        &.bk-select,\n        &.bk-cascade,\n        &.bk-color-picker,\n        &.bk-date-picker .bk-date-picker-editor,\n        &.bk-tag-input,\n        .bk-tag-input,\n        .bk-search-select,\n        .bk-button {\n            border-top-right-radius: 2px;\n            border-bottom-right-radius: 2px;\n        }\n    }\n}\n","<template>\n    <div class=\"script-source-of-execution\">\n        <jb-form-item class=\"script-source-item\" :label=\"'脚本来源'\" required>\n            <bk-radio-group @change=\"handleScriptSourceChange\" :value=\"scriptSource\">\n                <bk-radio-button value=\"local\">{{ '手工录入' }}</bk-radio-button>\n                <bk-radio-button value=\"refer\">{{ '脚本引用' }}</bk-radio-button>\n            </bk-radio-group>\n        </jb-form-item>\n        <jb-form-item\n            ref=\"scriptId\"\n            v-if=\"isScriptRefer\"\n            :label=\"'脚本引用'\"\n            required\n            property=\"scriptId\"\n            :rules=\"rules\">\n            <div class=\"form-item-content refer-script-box\">\n                <compose-form-item>\n                    <bk-select\n                        style=\"width: 120px;\"\n                        @change=\"handleReferScriptTypeChange\"\n                        :value=\"referType\"\n                        :clearable=\"false\">\n                        <bk-option :id=\"2\" :name=\"'业务脚本'\">{{ '业务脚本' }}</bk-option>\n                        <bk-option :id=\"3\" :name=\"'公共脚本'\">{{ '公共脚本' }}</bk-option>\n                    </bk-select>\n                    <bk-select\n                        :key=\"referType\"\n                        :placeholder=\"'选择引用脚本'\"\n                        class=\"refer-script-list\"\n                        :value=\"formData[scriptVersionIdField]\"\n                        @change=\"handleScriptVersionIdChange\"\n                        :clearable=\"false\"\n                        searchable>\n                        <auth-option\n                            v-for=\"option in scripListDisplay\"\n                            :key=\"option.scriptVersionId\"\n                            :id=\"option.scriptVersionId\"\n                            :permission=\"option.canView\"\n                            :resource-id=\"option.id\"\n                            :name=\"option.name\"\n                            :auth=\"authView\" />\n                        <template slot=\"extension\">\n                            <auth-component :auth=\"authCreate\">\n                                <div @click=\"handleGoCreate\" style=\"cursor: pointer;\">\n                                    <i class=\"bk-icon icon-plus-circle mr10\" />{{ newBtnText }}\n                                </div>\n                                <div slot=\"forbid\">\n                                    <i class=\"bk-icon icon-plus-circle mr10\" />{{ newBtnText }}\n                                </div>\n                            </auth-component>\n                        </template>\n                    </bk-select>\n                </compose-form-item>\n                <div\n                    v-if=\"formData[scriptVersionIdField]\"\n                    class=\"refer-script-detail\"\n                    :tippy-tips=\"'脚本详情'\"\n                    @click=\"handleGoScriptDetail\">\n                    <Icon type=\"jump\" />\n                </div>\n            </div>\n        </jb-form-item>\n    </div>\n</template>\n<script>\n       import ScriptService from '@service/script-manage';\n    import PublicScriptService from '@service/public-script-manage';\n    import TaskStepModel from '@model/task/task-step';\n    import ComposeFormItem from '@components/compose-form-item';\n\n    export default {\n        components: {\n            ComposeFormItem,\n        },\n        props: {\n            // 脚本来源字段名\n            scriptSourceField: {\n                type: String,\n                required: true,\n            },\n            // 脚本id字段名\n            scriptIdField: {\n                type: String,\n                required: true,\n            },\n            // 脚本版本id字段名\n            scriptVersionIdField: {\n                type: String,\n            },\n            // 脚本内容字段名\n            contentField: {\n                type: String,\n                required: true,\n            },\n            // 脚本语言字段名\n            languageField: {\n                type: String,\n                required: true,\n            },\n            formData: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                scripList: [{},{},{}],\n                publicScripList: [{},{},{}],\n                scriptSource: 'local',\n                referType: 2,\n            };\n        },\n        computed: {\n            /**\n             * @desc 使用脚本资源需要的权限\n             * @returns {String}\n             */\n            authView () {\n                return this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS\n                    ? 'script/view'\n                    : 'public_script/view';\n            },\n            /**\n             * @desc 脚本新建的权限\n             * @returns { String }\n             */\n            authCreate () {\n                return this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS\n                    ? 'script/create'\n                    : 'public_script/create';\n            },\n            /**\n             * @desc 引用脚本类型\n             * @returns { Boolean }\n             */\n            isScriptRefer () {\n                return this.scriptSource === 'refer';\n            },\n            /**\n             * @desc 脚本列表\n             * @returns { Array }\n             */\n            scripListDisplay () {\n                const scriptSource = this.formData[this.scriptSourceField];\n                \n                if (scriptSource === TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS) {\n                    return this.scripList;\n                }\n                if (scriptSource === TaskStepModel.scriptStep.TYPE_SOURCE_PUBLIC) {\n                    return this.publicScripList;\n                }\n                return [];\n            },\n            /**\n             * @desc 按钮的文本\n             * @returns { String }\n             */\n            newBtnText () {\n                return this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS\n                    ? '新建业务脚本'\n                    : '新建公共脚本';\n            },\n            /**\n             * @desc 表单想验证规则\n             * @returns { Array }\n             *\n             * 引用类型的脚本时 scriptId 不能为空\n             */\n            rules () {\n                if (this.isScriptRefer) {\n                    return [{\n                        required: true,\n                        message: '请选择引用脚本',\n                        trigger: 'blur',\n                    }];\n                }\n                return [];\n            },\n        },\n        watch: {\n            formData: {\n                handler () {\n                    this.initScriptSource();\n                },\n                immediate: true,\n            },\n            'formData.scriptId' (value) {\n                if (value) {\n                    this.$refs.scriptId.clearValidator();\n                }\n            },\n        },\n        created () {\n            if (this.formData[this.scriptVersionIdField]) {\n                this.handleScriptVersionIdChange(this.formData[this.scriptVersionIdField]);\n            }\n            this.fetchScriptList();\n            this.fetchPublicScriptList();\n        },\n        methods: {\n            /**\n             * @desc 获取业务脚本列表\n             */\n            fetchScriptList () {\n                ScriptService.getOnlineScriptList()\n                    .then((data) => {\n                        this.scripList = data;\n                    });\n            },\n            /**\n             * @desc 获公共脚本列表\n             */\n            fetchPublicScriptList () {\n                PublicScriptService.getOnlineScriptList()\n                    .then((data) => {\n                        this.publicScripList = data;\n                    });\n            },\n            /**\n             * @desc 初始化脚本来源\n             */\n            initScriptSource () {\n                if (this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_LOCAL) {\n                    this.scriptSource = 'local';\n                    return;\n                }\n                this.scriptSource = 'refer';\n                // 如果是引用脚本，还需初始化引用类型\n                this.referType = this.formData[this.scriptSourceField];\n            },\n            /**\n             * @desc 更新脚本来源\n             * @param {String} source 脚本来源\n             */\n            handleScriptSourceChange (source) {\n                // 脚本来源改变重置脚本相关的信息\n                const scriptSource = source === 'local'\n                    ? TaskStepModel.scriptStep.TYPE_SOURCE_LOCAL\n                    : TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS;\n                this.$emit('on-reset', {\n                    [this.scriptSourceField]: scriptSource,\n                    [this.scriptIdField]: '',\n                    [this.scriptVersionIdField]: '',\n                });\n            },\n            /**\n             * @desc 更新脚本引用来源类型\n             * @param {String} scriptSource 脚本引用来源类型\n             */\n            handleReferScriptTypeChange (scriptSource) {\n                if (scriptSource === this.formData[this.scriptSourceField]) {\n                    return;\n                }\n                this.$emit('on-reset', {\n                    [this.scriptSourceField]: scriptSource,\n                    [this.scriptIdField]: '',\n                    [this.scriptVersionIdField]: '',\n                });\n            },\n            /**\n             * @desc 更新脚本引用版本\n             * @param {String} scriptVersionId 脚本引用来源类型\n             */\n            handleScriptVersionIdChange (scriptVersionId) {\n                if (!scriptVersionId) {\n                    return;\n                }\n\n                this.$emit('on-reset', {\n                    isScriptContentLoading: true,\n                });\n                ScriptService.versionDetail({\n                    id: scriptVersionId,\n                }).then(({ id, content, type, publicScript }) => {\n                    let scriptSource = TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS;\n                    if (publicScript) {\n                        scriptSource = TaskStepModel.scriptStep.TYPE_SOURCE_PUBLIC;\n                    }\n                    this.$emit('on-reset', {\n                        [this.scriptSourceField]: scriptSource,\n                        [this.scriptIdField]: id,\n                        [this.contentField]: content,\n                        [this.languageField]: type,\n                        [this.scriptVersionIdField]: scriptVersionId,\n                    });\n                })\n                    .finally(() => {\n                        this.$emit('on-reset', {\n                            isScriptContentLoading: false,\n                        });\n                    });\n            },\n            /**\n             * @desc 跳转到选择的脚本版本详情\n             */\n            handleGoScriptDetail () {\n                const routerName = this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_PUBLIC\n                    ? 'publicScriptVersion'\n                    : 'scriptVersion';\n\n                const { href } = this.$router.resolve({\n                    name: routerName,\n                    params: {\n                        id: this.formData[this.scriptIdField],\n                    },\n                    query: {\n                        scriptVersionId: this.formData[this.scriptVersionIdField],\n                    },\n                });\n                \n                window.open(href);\n            },\n            /**\n             * @desc 跳转新建脚本页面\n             */\n            handleGoCreate () {\n                const routerName = this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_PUBLIC\n                    ? 'createPublicScript'\n                    : 'createScript';\n\n                const { href } = this.$router.resolve({\n                    name: routerName,\n                });\n                \n                window.open(href);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    @import \"@/css/mixins/media\";\n\n    .script-source-of-execution {\n        .script-source-item {\n            .bk-radio-button-text {\n                width: 120px;\n                text-align: center;\n            }\n        }\n\n        .refer-script-box {\n            position: relative;\n            display: flex;\n\n            .refer-script-detail {\n                position: absolute;\n                top: 0;\n                right: -40px;\n                bottom: 0;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                width: 40px;\n                font-size: 16px;\n                color: #3a84ff;\n                cursor: pointer;\n            }\n\n            .refer-script-list {\n                width: calc(500px - 120px);\n\n                @media (--small-viewports) {\n                    width: calc(500px - 120px);\n                }\n\n                @media (--medium-viewports) {\n                    width: calc(560px - 120px);\n                }\n\n                @media (--large-viewports) {\n                    width: calc(620px - 120px);\n                }\n\n                @media (--huge-viewports) {\n                    width: calc(680px - 120px);\n                }\n            }\n        }\n    }\n</style>\n","<template>\n    <div\n        class=\"task-step-execute-target\"\n        :class=\"{\n            'only-host': mode === 'onlyHost',\n        }\">\n        <jb-form-item\n            :label=\"'目标服务器'\"\n            required\n            ref=\"targetServerRef\"\n            :property=\"property\"\n            :rules=\"rules\">\n            <div style=\"display: flex;\">\n                <template v-if=\"mode === 'onlyHost'\">\n                    <!-- 快速执行场景只能操作主机列表 -->\n                    <bk-button class=\"mr10\" @click=\"handleShowChooseIp\">\n                        <Icon type=\"plus\" />\n                        {{ '添加服务器' }}\n                    </bk-button>\n                </template>\n                <template v-else>\n                    <!-- 作业步骤场景可以切换主机列表和主机变量 -->\n                    <compose-form-item>\n                        <bk-select\n                            :style=\"targetSelectorStyle\"\n                            :value=\"targetType\"\n                            :clearable=\"false\"\n                            @change=\"handleTargetTypeChange\">\n                            <bk-option id=\"variable\" :name=\"'全局变量'\" />\n                            <bk-option id=\"hostNodeInfo\" :name=\"'手动添加'\" />\n                        </bk-select>\n                        <template v-if=\"isGolbalVariableType\">\n                            <bk-select\n                                class=\"server-global-variable-select\"\n                                :placeholder=\"'请选择主机列表变量'\"\n                                :value=\"localVariable\"\n                                @change=\"handleVariableChange\"\n                                :clearable=\"false\">\n                                <bk-option\n                                    v-for=\"(item, index) in variable\"\n                                    :key=\"index\"\n                                    :id=\"item.name\"\n                                    :name=\"item.name\" />\n                            </bk-select>\n                        </template>\n                        <template v-else>\n                            <bk-button class=\"w120 mr10\" @click=\"handleShowChooseIp\">\n                                <Icon type=\"plus\" />\n                                {{ '添加服务器' }}\n                            </bk-button>\n                        </template>\n                    </compose-form-item>\n                </template>\n                <template v-if=\"isShowServerAction\">\n                    <bk-dropdown-menu>\n                        <bk-button class=\"mr10\" type=\"primary\" slot=\"dropdown-trigger\">\n                            <span>{{ '复制IP' }}</span>\n                            <Icon type=\"down-small\" class=\"action-flag\" />\n                        </bk-button>\n                        <ul class=\"bk-dropdown-list\" slot=\"dropdown-content\">\n                            <li><a @click=\"handleCopyAll\">{{ '全部IP' }}</a></li>\n                            <li><a @click=\"handleCopyFail\">{{ '异常IP' }}</a></li>\n                        </ul>\n                    </bk-dropdown-menu>\n                    <bk-button class=\"mr10\" @click=\"handleClearAll\">\n                        <span>{{ '清空' }}</span>\n                    </bk-button>\n                    <bk-button type=\"primary\" @click=\"handleRefreshHost\">\n                        {{ '刷新状态' }}\n                    </bk-button>\n                </template>\n                <bk-input\n                    v-if=\"isShowHostSearchInput\"\n                    class=\"ip-search\"\n                    :value=\"searchText\"\n                    :placeholder=\"'筛选主机'\"\n                    right-icon=\"bk-icon icon-search\"\n                    @change=\"handleHostSearch\" />\n            </div>\n            <lower-component level=\"custom\" :custom=\"isShowServerPanel\">\n                <server-panel\n                    v-show=\"isShowServerPanel\"\n                    ref=\"serverPanel\"\n                    class=\"view-server-panel\"\n                    :host-node-info=\"localHost\"\n                    :search-mode=\"Boolean(searchText)\"\n                    :search-data=\"searchData\"\n                    editable\n                    @on-change=\"handleHostChange\" />\n            </lower-component>\n        </jb-form-item>\n        <choose-ip\n            v-model=\"isShowChooseIp\"\n            :host-node-info=\"localHost\"\n            @on-change=\"handleHostChange\" />\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import TaskHostNodeModel from '@model/task-host-node';\n       import { execCopy } from '@utils/assist';\n    import ComposeFormItem from '@components/compose-form-item';\n    import ChooseIp from '@components/choose-ip';\n    import ServerPanel from '@components/choose-ip/server-panel';\n\n    export default {\n        components: {\n            ComposeFormItem,\n            ChooseIp,\n            ServerPanel,\n        },\n        inheritAttrs: false,\n        props: {\n            taskHostNode: {\n                type: Object,\n                required: true,\n            },\n            variable: {\n                type: Array,\n                default: () => [],\n            },\n            property: {\n                type: String,\n            },\n            mode: {\n                type: String,\n                default: '', // onlyHost: 快速执行只可以选择主机列表\n            },\n        },\n        data () {\n            return {\n                isShowChooseIp: false,\n                searchText: '',\n                isSearchMode: false,\n                searchData: [],\n                targetType: 'variable', // variable：主机变量；hostNodeInfo：手动添加\n                localVariable: '',\n                localHost: {},\n            };\n        },\n        computed: {\n            /**\n             * @desc 执行目标是否是全局变量\n             * @returns {Boolean}\n             */\n            isGolbalVariableType () {\n                return this.targetType === 'variable';\n            },\n            /**\n             * @desc 是否显示主机结果面板\n             * @returns {Boolean}\n             */\n            isShowServerPanel () {\n                if (this.isGolbalVariableType) {\n                    return false;\n                }\n                return !TaskHostNodeModel.isHostNodeInfoEmpty(this.localHost);\n            },\n            /**\n             * @desc 是否显示主机结果快捷操作\n             * @returns {Boolean}\n             */\n            isShowServerAction () {\n                if (this.isGolbalVariableType) {\n                    return false;\n                }\n                return !TaskHostNodeModel.isHostNodeInfoEmpty(this.localHost);\n            },\n            /**\n             * @desc 清除异常主机是否可用\n             * @returns {Boolean}\n             */\n            isClearFailDisabled () {\n                return this.localHost.ipList.length < 1;\n            },\n            /**\n             * @desc 选择的主机才显示主机搜索框\n             * @returns {Boolean}\n             */\n            isShowHostSearchInput () {\n                if (this.isGolbalVariableType) {\n                    return false;\n                }\n                return this.localHost.ipList.length > 0;\n            },\n            /**\n             * @desc 切换执行目标选择的展示样式\n             * @returns {Object}\n             */\n            targetSelectorStyle () {\n                return {\n                    width: 'zh-CN' === 'en-US' ? '156px' : '120px',\n                };\n            },\n        },\n        watch: {\n            taskHostNode: {\n                handler (taskHostNode) {\n                    const {\n                        hostNodeInfo,\n                        variable,\n                    } = taskHostNode;\n\n                    this.localHost = hostNodeInfo;\n                    this.localVariable = variable;\n                    if (this.mode !== 'onlyHost') {\n                        // 编辑态，执行目标为服务器列表\n                        if (!TaskHostNodeModel.isHostNodeInfoEmpty(this.localHost)) {\n                            this.targetType = 'hostNodeInfo';\n                        }\n                    } else {\n                        this.targetType = 'hostNodeInfo';\n                    }\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            // 执行目标是主机变量\n            if (this.isGolbalVariableType) {\n                if (this.localVariable) {\n                    // 编辑态\n                    // 如果被引用的主机变量被删除，则将执行目标的值重置为空\n                    // 主机变量被删除\n                    if (!this.variable.find(_ => _.name === this.localVariable)) {\n                        setTimeout(() => {\n                            this.handleVariableChange('');\n                        });\n                    }\n                } else {\n                    // 主机变量为空，默认选中第一个\n                    if (this.variable.length > 0) {\n                        setTimeout(() => {\n                            this.handleVariableChange(this.variable[0].name);\n                        });\n                    }\n                }\n            }\n            \n            this.rules = [\n                {\n                    validator: () => {\n                        if (this.isGolbalVariableType) {\n                            return Boolean(this.localVariable);\n                        }\n                        return !TaskHostNodeModel.isHostNodeInfoEmpty(this.localHost);\n                    },\n                    message: '目标服务器必填',\n                    trigger: 'change',\n                },\n            ];\n        },\n        methods: {\n            /**\n             * @desc 执行目标值更新\n             */\n            triggerChange () {\n                const taskHostNode = new TaskHostNodeModel({});\n                if (this.isGolbalVariableType) {\n                    taskHostNode.variable = this.localVariable;\n                } else {\n                    taskHostNode.hostNodeInfo = this.localHost;\n                }\n                if (!taskHostNode.isEmpty) {\n                    this.$refs.targetServerRef.clearValidator();\n                }\n                this.$emit('on-change', Object.freeze(taskHostNode));\n            },\n            /**\n             * @desc 执行目标类型改变\n             */\n            handleTargetTypeChange (value) {\n                this.targetType = value;\n                this.triggerChange();\n            },\n            /**\n             * @desc 弹出ip选择器弹层\n             */\n            handleShowChooseIp () {\n                this.isShowChooseIp = true;\n                this.searchText = '';\n            },\n            /**\n             * @desc 选择全局变量\n             * @param {String} value 全局变量名\n             */\n            handleVariableChange (value) {\n                this.localVariable = value;\n                this.triggerChange();\n            },\n            /**\n             * @desc 主机值更新\n             * @param {Object} hostNodeInfo 主机信息\n             */\n            handleHostChange (hostNodeInfo) {\n                this.localHost = Object.freeze(hostNodeInfo);\n                this.triggerChange();\n            },\n            /**\n             * @desc 复制所有主机\n             */\n            handleCopyAll () {\n                const allIP = this.$refs.serverPanel.getAllIP();\n                if (allIP.length < 1) {\n                    this.messageWarn('你还未选择主机');\n                    return;\n                }\n                \n                execCopy(allIP.join('\\n'), `${'复制成功'}（${allIP.length}${'个IP'}）`);\n            },\n            /**\n             * @desc 复制所有异常主机\n             */\n            handleCopyFail () {\n                const allFailIP = this.$refs.serverPanel.getAllIP(true);\n                if (allFailIP.length < 1) {\n                    this.messageWarn('暂无异常主机');\n                    return;\n                }\n                \n                execCopy(allFailIP.join('\\n'), `${'复制成功'}（${allFailIP.length}${'个IP'}）`);\n            },\n            /**\n             * @desc 复制所有主机数据\n             */\n            handleClearAll () {\n                const { hostNodeInfo } = new TaskHostNodeModel({});\n                this.localHost = Object.freeze(hostNodeInfo);\n                this.messageSuccess('清空成功');\n                this.triggerChange();\n            },\n            /**\n             * @desc 刷新所有主机的状态信息\n             */\n            handleRefreshHost () {\n                this.$refs.serverPanel.refresh();\n            },\n            /**\n             * @desc 筛选主机\n             * @param {String} search 筛选值\n             */\n            handleHostSearch (search) {\n                this.searchText = _.trim(search);\n                this.searchData = Object.freeze(this.$refs.serverPanel.getAllHost(search));\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    html[lang=\"en-US\"] {\n        .compose-form-item {\n            .server-global-variable-select {\n                width: 341px;\n            }\n        }\n\n        .ip-search {\n            width: 162px;\n        }\n\n        .only-host {\n            .ip-search {\n                width: 314px;\n            }\n        }\n    }\n\n    .task-step-execute-target {\n        &.only-host {\n            .ip-search {\n                width: 620px;\n            }\n        }\n\n        .bk-button {\n            font-size: 14px !important;\n        }\n\n        .action-flag {\n            font-size: 18px;\n        }\n\n        .view-server-panel {\n            margin-top: 14px;\n        }\n\n        .ip-search {\n            flex: 0 0 auto;\n            width: 245px;\n            margin-left: auto;\n        }\n\n        .compose-form-item {\n            .server-global-variable-select {\n                width: 376px;\n            }\n        }\n    }\n\n    .execute-target-host-clear {\n        user-select: none;\n\n        .disabled {\n            a {\n                color: #c4c6cc !important;\n                cursor: not-allowed;\n                background-color: #fafafa !important;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"push-speed-limit\">\n        <jb-form-item :label=\"label\">\n            <div class=\"speed-limit-wraper\">\n                <div class=\"speed-limit-content form-item-content\">\n                    <bk-checkbox :value=\"enabled\" @change=\"handleEnableChange\">\n                        {{ '启用限速' }}\n                    </bk-checkbox>\n                    <bk-input v-show=\"enabled\" class=\"speed-limit-input\" @change=\"handleChange\" :value=\"formData[field]\">\n                        <template slot=\"append\">\n                            <div class=\"group-text\">MB/s</div>\n                        </template>\n                    </bk-input>\n                </div>\n                <Icon v-show=\"enabled\" type=\"info\" class=\"tips-flag\" v-bk-tooltips=\"speedLimitTipsConfig\" />\n            </div>\n        </jb-form-item>\n        <div id=\"targetPathTips\" class=\"speed-limit-tips\">\n            <div class=\"row\">{{ '请根据机器的网卡情况酌情配置速率，以免影响其他服务的正常使用；' }}</div>\n            <div class=\"row\">{{ '未开启时，将按 Agent 默认配置规则限速 （Agent会根据机器资源使用情况，有自身保护机制）' }}</div>\n        </div>\n    </div>\n</template>\n<script>\n   \n    export default {\n        name: '',\n        props: {\n            field: {\n                type: String,\n                required: true,\n            },\n            label: {\n                type: String,\n                default: '限速',\n            },\n            formData: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                enabled: false,\n            };\n        },\n        watch: {\n            formData: {\n                handler (formData) {\n                    if (formData[this.field] > 0) {\n                        this.enabled = true;\n                    }\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.speedLimitTipsConfig = {\n                allowHtml: true,\n                width: '325px',\n                theme: 'light',\n                trigger: 'mouseenter',\n                content: '#targetPathTips',\n                placement: 'right-start',\n                delay: [0, 10000000],\n            };\n        },\n        methods: {\n            handleEnableChange (enabled) {\n                this.enabled = enabled;\n                this.$emit('on-change', this.field, enabled ? 10 : 0);\n            },\n            handleChange (value) {\n                this.$emit('on-change', this.field, value);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .push-speed-limit {\n        .bk-label {\n            white-space: normal;\n        }\n\n        .speed-limit-wraper {\n            display: flex;\n            align-items: center;\n            justify-content: flex-start;\n        }\n\n        .speed-limit-content {\n            display: flex;\n            align-items: center;\n            height: 32px;\n        }\n\n        .speed-limit-input {\n            width: calc(100% - 100px);\n            margin-left: auto;\n        }\n\n        .tips-flag {\n            margin-left: 8px;\n            font-size: 14px;\n            line-height: 32px;\n            color: #c4c6cc;\n            cursor: pointer;\n        }\n    }\n\n    .speed-limit-tips {\n        font-size: 12px;\n        line-height: 16px;\n        color: #63656e;\n\n        .row {\n            position: relative;\n            padding-left: 12px;\n\n            &::before {\n                position: absolute;\n                top: 6px;\n                left: 0;\n                width: 4px;\n                height: 4px;\n                background: currentColor;\n                border-radius: 50%;\n                content: \"\";\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"step-distro-file\">\n        <jb-form ref=\"form\" :model=\"formData\" fixed :label-width=\"formMarginLeftWidth\">\n            <card-layout :title=\"'基本信息'\" class=\"block\">\n                <item-factory\n                    name=\"stepName\"\n                    field=\"name\"\n                    :placeholder=\"'推荐按步骤实际处理的场景行为来取名...'\"\n                    :form-data=\"formData\"\n                    @on-change=\"handleChange\" />\n                <item-factory\n                    name=\"timeout\"\n                    field=\"timeout\"\n                    :form-data=\"formData\"\n                    @on-change=\"handleChange\" />\n                <item-factory\n                    name=\"errorHandle\"\n                    field=\"ignoreError\"\n                    :form-data=\"formData\"\n                    @on-change=\"handleChange\" />\n                <item-factory\n                    name=\"speedLimit\"\n                    field=\"uploadSpeedLimit\"\n                    :label=\"'上传限速'\"\n                    :form-data=\"formData\"\n                    @on-change=\"handleChange\" />\n                <item-factory\n                    name=\"speedLimit\"\n                    field=\"downloadSpeedLimit\"\n                    :label=\"'下载限速'\"\n                    :form-data=\"formData\"\n                    @on-change=\"handleChange\" />\n            </card-layout>\n            <card-layout :title=\"'文件来源'\" class=\"block\">\n                <item-factory\n                    name=\"sourceFileOfTemplate\"\n                    field=\"fileSourceList\"\n                    :variable=\"variable\"\n                    :form-data=\"formData\"\n                    @on-change=\"handleChange\" />\n            </card-layout>\n            <card-layout :title=\"'传输目标'\" class=\"block\">\n                <item-factory\n                    ref=\"targetPath\"\n                    name=\"targetPath\"\n                    field=\"path\"\n                    tips-placement=\"top\"\n                    :form-data=\"formData\"\n                    @on-change=\"handleChange\" />\n                <item-factory\n                    name=\"transferMode\"\n                    field=\"transferMode\"\n                    :form-data=\"formData\"\n                    @on-change=\"handleChange\" />\n                <item-factory\n                    name=\"executeAccount\"\n                    field=\"account\"\n                    :form-data=\"formData\"\n                    @on-change=\"handleChange\" />\n                <item-factory\n                    name=\"targetServerOfTemplate\"\n                    field=\"server\"\n                    :variable=\"variable\"\n                    :form-data=\"formData\"\n                    @on-change=\"handleChange\" />\n            </card-layout>\n        </jb-form>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import { mapState } from 'vuex';\n    import TaskStepModel from '@model/task/task-step';\n    import TaskHostNodeModel from '@model/task-host-node';\n    import CardLayout from '@components/task-step/file/card-layout';\n    import ItemFactory from '@components/task-step/file/item-factory';\n    import {\n        genDefaultName,\n        compareHost,\n        detectionSourceFileDupLocation,\n    } from '@utils/assist';\n\n    const getDefaultData = () => ({\n        id: 0,\n        // 步骤名称\n        name: genDefaultName('步骤分发文件'),\n        // 源文件列表\n        fileSourceList: [{},{},{}],\n        // 超时\n        timeout: 7200,\n        // 上传文件限速\n        uploadSpeedLimit: 0,\n        // 传输模式： 1 - 严谨模式； 2 - 强制模式；3 - 安全模式\n        transferMode: 2,\n        // 忽略错误 0 - 不忽略 1 - 忽略\n        ignoreError: 0,\n        // 下载文件限速\n        downloadSpeedLimit: 0,\n\n        // 目标路径，通过三个输入框（account、path、server）赋值\n        // 最终组合成一个 fileDestination\n        // fileDestination: {\n        //     account: '', // 执行账号\n        //     path: '', // 目标路径\n        //     server: {} // 执行目标\n        // }\n        account: '',\n        path: '',\n        server: new TaskHostNodeModel({}),\n    });\n\n    export default {\n        name: '',\n        components: {\n            CardLayout,\n            ItemFactory,\n        },\n        inheritAttrs: false,\n        props: {\n            variable: {\n                type: Array,\n                default: () => [],\n            },\n            data: {\n                type: Object,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                formData: getDefaultData(),\n            };\n        },\n        computed: {\n            ...mapState('distroFile', {\n                isEditNewSourceFile: state => state.isEditNewSourceFile,\n                isLocalFileUploading: state => state.isLocalFileUploading,\n                isLocalFileUploadFailed: state => state.isLocalFileUploadFailed,\n            }),\n            formMarginLeftWidth () {\n                return 'zh-CN' === 'en-US' ? 140 : 110;\n            },\n        },\n        watch: {\n            data: {\n                handler (newData) {\n                    if (_.isEmpty(newData)) {\n                        return;\n                    }\n                    const {\n                        account,\n                        path,\n                        server,\n                    } = newData.fileDestination;\n\n                    const originData = { ...newData };\n                    delete originData.fileDestination;\n\n                    this.formData = {\n                        ...this.formData,\n                        ...originData,\n                        account,\n                        path,\n                        server,\n                    };\n                    setTimeout(() => {\n                        this.$refs.form.validate();\n                    });\n                },\n                immediate: true,\n            },\n        },\n        mounted () {\n            window.IPInputScope = 'FILE_DISTRIBUTION';\n            this.$once('hook:beforeDestroy', () => {\n                window.IPInputScope = '';\n            });\n        },\n        methods: {\n            /**\n             * @desc 表单字段更新\n             * @param {String} field 字段名\n             * @param {Any} value 字段值\n             */\n            handleChange (field, value) {\n                this.formData[field] = value;\n            },\n            /**\n             * @desc 提交表单\n             *\n             * 1，首先检测是否有没保存的源文件\n             * 2，表单验证\n             *   - 表单验证失败检测是否有本地文件上传未完成或者本地文件上传失败\n             */\n            submit () {\n                return Promise.resolve()\n                    // 检测没有保存的源文件\n                    .then(() => new Promise((resolve, reject) => {\n                        if (!this.isEditNewSourceFile) {\n                            return resolve();\n                        }\n                        this.$bkInfo({\n                            title: '您有未保存的源文件',\n                            type: 'warning',\n                            okText: '继续提交',\n                            cancelText: '去保存',\n                            confirmFn: () => {\n                                resolve();\n                            },\n                            cancelFn: () => {\n                                reject(new Error('save'));\n                            },\n                        });\n                    }))\n                    // 检测服务器源文件的主机和执行目标服务器主机相同\n                    .then(() => new Promise((resolve, reject) => {\n                        let sameHost = false;\n                        // eslint-disable-next-line no-plusplus\n                        for (let i = 0; i < this.formData.fileSourceList.length; i++) {\n                            const currentFileSource = this.formData.fileSourceList[i];\n                            // 服务器源文件\n                            if (currentFileSource.fileType === TaskStepModel.fileStep.TYPE_SERVER) {\n                                if (compareHost(this.formData.server, currentFileSource.host)) {\n                                    sameHost = true;\n                                    break;\n                                }\n                            }\n                        }\n                        if (sameHost) {\n                            this.$bkInfo({\n                                title: '源和目标服务器相同',\n                                subTitle: '检测到文件传输源和目标服务器是同一批，若是单台建议使用本地 cp 方式效率会更高，请问你是否确定参数无误？',\n                                width: 500,\n                                okText: '好的，我调整一下',\n                                cancelText: '是的，确定无误',\n                                confirmFn: () => {\n                                    reject(new Error('save'));\n                                },\n                                cancelFn: () => {\n                                    resolve();\n                                },\n                            });\n                        } else {\n                            resolve();\n                        }\n                    }))\n                    // 检测源文件的同名文件和目录\n                    .then(() => new Promise((resolve, reject) => {\n                        if (detectionSourceFileDupLocation(this.formData.fileSourceList)) {\n                            // 有重名目录和文件\n                            this.$bkInfo({\n                                title: '源文件可能出现同名',\n                                subTitle: '多文件源传输场景下容易出现同名文件覆盖的问题，你可以在目标路径中使用 [源服务器IP] 的变量来尽可能规避风险。',\n                                okText: '好的，我调整一下',\n                                cancelText: '已知悉，确定执行',\n                                closeIcon: false,\n                                width: 500,\n                                confirmFn: () => {\n                                    // 聚焦到目标路径输入框\n                                    this.$refs.targetPath.$el.scrollIntoView();\n                                    this.$refs.targetPath.$el.querySelector('.bk-form-input').focus();\n                                    reject(new Error('transferMode change'));\n                                },\n                                cancelFn: () => {\n                                    resolve();\n                                },\n                            });\n                        } else {\n                            resolve();\n                        }\n                    }))\n                    // 提交步骤\n                    .then(() => {\n                        const {\n                            id,\n                            name,\n                            timeout,\n                            uploadSpeedLimit,\n                            downloadSpeedLimit,\n                            transferMode,\n                            ignoreError,\n                            fileSourceList,\n                            account,\n                            path,\n                            server,\n                        } = this.formData;\n\n                        const result = {\n                            id,\n                            name,\n                            delete: 0,\n                            type: 2,\n                            fileStepInfo: {\n                                timeout,\n                                uploadSpeedLimit,\n                                downloadSpeedLimit,\n                                transferMode,\n                                ignoreError,\n                                fileSourceList,\n                                fileDestination: {\n                                    account,\n                                    path,\n                                    server,\n                                },\n                                \n                            },\n                        };\n                        return this.$refs.form.validate()\n                            // 表单验证通过直接提交\n                            .then(() => {\n                                this.$emit('on-change', result, true);\n                            })\n                            // 表单验证失败时，检测本地文件上传状态\n                            .catch(() => new Promise((resolve, reject) => {\n                                let confirmInfo = null;\n                                const handleClose = () => {\n                                    confirmInfo.close();\n                                    reject(new Error('not save'));\n                                };\n                                const subHeader = () => (\n                                <div>\n                                    <div style=\"text-align: center\">\n                                        <bk-button\n                                            onClick={handleClose}\n                                            style=\"width: 96px\"\n                                            theme=\"primary\">\n                                            { '去处理' }\n                                        </bk-button>\n                                    </div>\n                                </div>\n                                );\n                                if (this.isLocalFileUploading) {\n                                    confirmInfo = this.$bkInfo({\n                                        type: 'error',\n                                        title: '本地源文件上传未完成',\n                                        subHeader: subHeader(),\n                                        showFooter: false,\n                                    });\n                                } else if (this.isLocalFileUploadFailed) {\n                                    confirmInfo = this.$bkInfo({\n                                        type: 'error',\n                                        title: '本地源文件上传失败',\n                                        subHeader: subHeader(),\n                                        showFooter: false,\n                                    });\n                                } else {\n                                    this.$emit('on-change', result, false);\n                                    resolve();\n                                }\n                            }));\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .step-distro-file {\n        .card-box {\n            padding-left: 0;\n            margin-bottom: 6px;\n\n            .card-title {\n                padding-left: 30px;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"script-source-of-template\">\n        <jb-form-item class=\"script-source-item\" :label=\"'脚本来源'\" required>\n            <bk-radio-group @change=\"handleScriptSourceChange\" :value=\"sourceType\">\n                <bk-radio-button value=\"local\">{{ '手工录入' }}</bk-radio-button>\n                <bk-radio-button value=\"refer\">{{ '脚本引用' }}</bk-radio-button>\n            </bk-radio-group>\n        </jb-form-item>\n        <jb-form-item\n            ref=\"scriptId\"\n            :label=\"'脚本引用'\"\n            v-show=\"isScriptRefer\"\n            required\n            property=\"scriptId\"\n            :rules=\"rules\">\n            <div class=\"refer-script-item\">\n                <compose-form-item class=\"form-item-content\" type=\"select\">\n                    <bk-select\n                        style=\"width: 120px;\"\n                        @change=\"handleReferScriptTypeChange\"\n                        :value=\"referType\"\n                        :clearable=\"false\">\n                        <bk-option\n                            :id=\"2\"\n                            :name=\"'业务脚本'\">\n                            {{ '业务脚本' }}\n                        </bk-option>\n                        <bk-option\n                            :id=\"3\"\n                            :name=\"'公共脚本'\">\n                            {{ '公共脚本' }}\n                        </bk-option>\n                    </bk-select>\n                    <bk-select\n                        :placeholder=\"'选择引用脚本'\"\n                        style=\"width: 375px;\"\n                        :value=\"formData[scriptVersionIdField]\"\n                        @change=\"handleScriptVersionIdChange\"\n                        :clearable=\"false\"\n                        searchable>\n                        <component\n                            :is=\"scriptGroupComponent\"\n                            v-for=\"(group, index) in scriptListDisplay\"\n                            :name=\"index === 0 ? '当前脚本' : '其它脚本'\"\n                            :key=\"index\">\n                            <auth-option\n                                v-for=\"(option, itemIndex) in group\"\n                                :key=\"`${option.scriptVersionId}_${itemIndex}`\"\n                                :id=\"option.scriptVersionId\"\n                                :name=\"option.name\"\n                                :permission=\"option.canView\"\n                                :resource-id=\"option.id\"\n                                :auth=\"authView\" />\n                        </component>\n                        <template slot=\"extension\">\n                            <auth-component :auth=\"authCreate\">\n                                <div @click=\"handleGoCreate\" style=\"cursor: pointer;\">\n                                    <i class=\"bk-icon icon-plus-circle mr10\" />{{ newBtnText }}\n                                </div>\n                                <div slot=\"forbid\">\n                                    <i class=\"bk-icon icon-plus-circle mr10\" />{{ newBtnText }}\n                                </div>\n                            </auth-component>\n                        </template>\n                    </bk-select>\n                </compose-form-item>\n                <Icon\n                    v-if=\"formData[scriptStatusField]\"\n                    type=\"script-update\"\n                    class=\"update-flag\"\n                    :tippy-tips=\"'引用脚本待更新'\" />\n                <div\n                    v-if=\"formData[scriptVersionIdField]\"\n                    class=\"refer-script-detail\"\n                    :tippy-tips=\"'脚本详情'\"\n                    @click=\"handleGoScriptDetail\">\n                    <Icon type=\"jump\" />\n                </div>\n            </div>\n        </jb-form-item>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import ScriptManageService from '@service/script-manage';\n    import PublicScriptManageService from '@service/public-script-manage';\n    import TaskStepModel from '@model/task/task-step';\n    import ComposeFormItem from '@components/compose-form-item';\n\n    export default {\n        components: {\n            ComposeFormItem,\n        },\n        props: {\n            // 脚本来源字段名\n            scriptSourceField: {\n                type: String,\n                required: true,\n            },\n            // 脚本id字段名\n            scriptIdField: {\n                type: String,\n                required: true,\n            },\n            // 脚本版本id字段名\n            scriptVersionIdField: {\n                type: String,\n            },\n            // 脚本内容字段名\n            contentField: {\n                type: String,\n                required: true,\n            },\n            languageField: {\n                type: String,\n                required: true,\n            },\n            // 脚本语言字段名\n            scriptStatusField: {\n                type: String,\n                required: true,\n            },\n            formData: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                defaultScript: {},\n                scriptGroup: [],\n                publicScriptGroup: [],\n                sourceType: 'local',\n                referType: 2,\n            };\n        },\n        computed: {\n            /**\n             * @desc 使用脚本资源需要的权限\n             */\n            authView () {\n                return this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS\n                    ? 'script/view'\n                    : 'public_script/view';\n            },\n            /**\n             * @desc 脚本新建的权限\n             * @returns { String }\n             */\n            authCreate () {\n                return this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS\n                    ? 'script/create'\n                    : 'public_script/create';\n            },\n            /**\n             * @desc 脚本下拉列表显示格式\n             * @returns { String }\n             */\n            scriptGroupComponent () {\n                if (this.scriptListDisplay.length > 1) {\n                    return 'bk-option-group';\n                }\n                return 'div';\n            },\n            /**\n             * @desc 引用脚本类型\n             * @returns { Boolean }\n             */\n            isScriptRefer () {\n                return this.sourceType === 'refer';\n            },\n            /**\n             * @desc 脚本列表\n             * @returns { Array }\n             */\n            scriptListDisplay () {\n                const scriptSource = this.formData[this.scriptSourceField];\n                \n                if (scriptSource === TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS) {\n                    return this.scriptGroup;\n                }\n                if (scriptSource === TaskStepModel.scriptStep.TYPE_SOURCE_PUBLIC) {\n                    return this.publicScriptGroup;\n                }\n                return [];\n            },\n            /**\n             * @desc 按钮的文本\n             * @returns { String }\n             */\n            newBtnText () {\n                return this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS\n                    ? '新建业务脚本'\n                    : '新建公共脚本';\n            },\n            /**\n             * @desc 表单想验证规则\n             * @returns { Array }\n             *\n             * 引用类型的脚本时 scriptId 不能为空\n             */\n            rules () {\n                if (this.isScriptRefer) {\n                    return [{\n                        required: true,\n                        message: '请选择引用脚本',\n                        trigger: 'blur',\n                    }];\n                }\n                return [];\n            },\n        },\n        watch: {\n            formData: {\n                handler () {\n                    this.initScriptSource();\n                },\n                immediate: true,\n            },\n            'formData.scriptId' (value) {\n                if (value) {\n                    this.$refs.scriptId.clearValidator();\n                }\n            },\n        },\n        created () {\n            this.scriptListMemo = [];\n            this.publicScriptListMemo = [];\n            this.initScriptContent();\n            this.fetchScriptList();\n            this.fetchPublicScriptList();\n        },\n        methods: {\n            /**\n             * @desc 获取业务脚本列表\n             */\n            fetchScriptList () {\n                ScriptManageService.getOnlineScriptList()\n                    .then((data) => {\n                        this.scriptGroup = [data];\n                        this.scriptListMemo = data;\n                        this.composeGroup();\n                    });\n            },\n            /**\n             * @desc 获公共脚本列表\n             */\n            fetchPublicScriptList () {\n                PublicScriptManageService.getOnlineScriptList()\n                    .then((data) => {\n                        this.publicScriptGroup = [data];\n                        this.publicScriptListMemo = data;\n                        this.composeGroup();\n                    });\n            },\n            /**\n             * @desc 获取指定的脚本版本数据\n             * @param {Object} params 脚本数据\n             */\n            fetchScriptVersionDetail (params) {\n                return ScriptManageService.versionDetail(params);\n            },\n            /**\n             * @desc 初始化脚本来源\n             */\n            initScriptSource () {\n                if (this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_LOCAL) {\n                    this.sourceType = 'local';\n                    return;\n                }\n                this.sourceType = 'refer';\n                // 如果是引用脚本，还需初始化引用类型\n                this.referType = this.formData[this.scriptSourceField];\n            },\n            /**\n             * @desc 初始化脚本内容\n             */\n            initScriptContent () {\n                // 有默认的脚本版本，获取对应版本的脚本内容\n                if (!this.formData[this.scriptIdField] && !this.formData[this.scriptVersionIdField]) {\n                    return;\n                }\n                this.$emit('on-reset', {\n                    isScriptContentLoading: true,\n                });\n                this.fetchScriptVersionDetail({\n                    id: this.formData[this.scriptVersionIdField],\n                }).then((script) => {\n                    const { content, publicScript } = script;\n                    const scriptSource = publicScript\n                        ? TaskStepModel.scriptStep.TYPE_SOURCE_PUBLIC\n                        : TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS;\n                    this.defaultScript = script;\n                    this.composeGroup();\n                    this.$emit('on-reset', {\n                        [this.contentField]: content,\n                        [this.scriptSourceField]: scriptSource,\n                    });\n                })\n                    .finally(() => {\n                        this.$emit('on-reset', {\n                            isScriptContentLoading: false,\n                        });\n                    });\n            },\n            /**\n             * @desc 脚本版本有更新时需要将最新的脚本版本组合到脚本列表中\n             */\n            composeGroup () {\n                if (!this.defaultScript.id) {\n                    return;\n                }\n                const { publicScript } = this.defaultScript;\n                const targetList = publicScript\n                    ? _.cloneDeep(this.publicScriptListMemo)\n                    : _.cloneDeep(this.scriptListMemo);\n                if (targetList.length < 1) {\n                    return;\n                }\n                if (!this.formData[this.scriptStatusField]) {\n                    this.scriptGroup = Object.freeze([this.scriptListMemo]);\n                    this.publicScriptGroup = Object.freeze([this.publicScriptListMemo]);\n                    return;\n                }\n                const currentScriptList = [];\n                const oldVersionScript = {\n                    ...this.defaultScript,\n                    name: `${this.defaultScript.name}（${'当前版本'}）`,\n                };\n                currentScriptList.push(oldVersionScript);\n                const [newVersionScript] = _.remove(targetList, item => item.id === oldVersionScript.id);\n                if (newVersionScript) {\n                    newVersionScript.name = `${newVersionScript.name}（${'新版本'}）`;\n                    currentScriptList.unshift(newVersionScript);\n                }\n                \n                if (publicScript) {\n                    this.scriptGroup = Object.freeze([this.scriptListMemo]);\n                    this.publicScriptGroup = Object.freeze([currentScriptList, targetList]);\n                } else {\n                    this.scriptGroup = Object.freeze([currentScriptList, targetList]);\n                    this.publicScriptGroup = Object.freeze([this.publicScriptListMemo]);\n                }\n            },\n            /**\n             * @desc 更新脚本来源\n             * @param {String} source 脚本来源\n             */\n            handleScriptSourceChange (source) {\n                // 脚本来源改变重置脚本相关的信息\n                const scriptSource = source === 'local'\n                    ? TaskStepModel.scriptStep.TYPE_SOURCE_LOCAL\n                    : TaskStepModel.scriptStep.TYPE_SOURCE_BUSINESS;\n                this.$emit('on-reset', {\n                    [this.scriptIdField]: '',\n                    [this.scriptVersionIdField]: '',\n                    [this.scriptSourceField]: scriptSource,\n                });\n            },\n            /**\n             * @desc 更新脚本引用来源类型\n             * @param {String} scriptSource 脚本引用来源类型\n             */\n            handleReferScriptTypeChange (scriptSource) {\n                this.$emit('on-reset', {\n                    [this.scriptSourceField]: scriptSource,\n                    [this.scriptIdField]: '',\n                    [this.scriptVersionIdField]: '',\n                });\n            },\n            /**\n             * @desc 更新脚本引用版本\n             * @param {String} scriptVersionId 脚本引用来源类型\n             */\n            handleScriptVersionIdChange (scriptVersionId) {\n                if (!scriptVersionId) {\n                    return;\n                }\n                this.$emit('on-reset', {\n                    isScriptContentLoading: true,\n                });\n                this.fetchScriptVersionDetail({\n                    id: scriptVersionId,\n                }).then(({ id, type, content }) => {\n                    this.$emit('on-reset', {\n                        [this.scriptIdField]: id,\n                        [this.contentField]: content,\n                        [this.languageField]: type,\n                        [this.scriptVersionIdField]: scriptVersionId,\n                        [this.scriptStatusField]: 0,\n                        isScriptContentLoading: false,\n                    });\n                })\n                    .finally(() => {\n                        this.$emit('on-reset', {\n                            isScriptContentLoading: false,\n                        });\n                    });\n            },\n            /**\n             * @desc 跳转到选择的脚本版本详情\n             */\n            handleGoScriptDetail () {\n                const routerName = this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_PUBLIC\n                    ? 'publicScriptVersion'\n                    : 'scriptVersion';\n\n                const router = this.$router.resolve({\n                    name: routerName,\n                    params: {\n                        id: this.formData[this.scriptIdField],\n                    },\n                    query: {\n                        scriptVersionId: this.formData[this.scriptVersionIdField],\n                    },\n                });\n                window.open(router.href);\n            },\n            /**\n             * @desc 跳转新建脚本页面\n             */\n            handleGoCreate () {\n                const routerName = this.formData[this.scriptSourceField] === TaskStepModel.scriptStep.TYPE_SOURCE_PUBLIC\n                    ? 'createPublicScript'\n                    : 'createScript';\n\n                const { href } = this.$router.resolve({\n                    name: routerName,\n                });\n                \n                window.open(href);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .script-source-of-template {\n        .script-source-item {\n            .bk-radio-button-text {\n                width: 120px;\n                text-align: center;\n            }\n        }\n\n        .update-flag {\n            margin-left: 4px;\n            color: #ff5656;\n        }\n\n        .refer-script-item {\n            position: relative;\n            display: flex;\n            align-items: center;\n\n            .refer-script-detail {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                margin-left: 4px;\n                font-size: 16px;\n                color: #3a84ff;\n                cursor: pointer;\n            }\n        }\n    }\n</style>\n","<template>\n    <div\n        class=\"jb-user-selector\"\n        :class=\"{ disabled: isLoading }\"\n        v-bkloading=\"{ isLoading }\">\n        <user-selector\n            v-if=\"!isLoading\"\n            v-bind=\"$attrs\"\n            :value=\"defaultValue\"\n            :disabled-users=\"disabledUsers\"\n            :list-scroll-height=\"300\"\n            :history-key=\"historyKey\"\n            :default-alternate=\"formatDefaultAlternate\"\n            :fuzzy-search-method=\"handleFuzzySearch\"\n            :render-tag=\"renderTag\"\n            :render-list=\"renterMerberItem\"\n            @change=\"handleChange\" />\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import NotifyService from '@service/notify';\n    import { encodeRegexp } from '@utils/assist';\n    import UserSelector from '@blueking/user-selector';\n\n    const CACHE_KEY = 'job-user-selector-cache';\n\n    export default {\n        name: 'JobUserSelector',\n        components: {\n            UserSelector,\n        },\n        props: {\n            // 已选 user\n            user: {\n                type: Array,\n                default: () => [],\n            },\n            // 已选 role\n            role: {\n                type: Array,\n                default: () => [],\n            },\n            // 筛选时每页条数\n            limit: {\n                type: Number,\n                default: 10,\n            },\n            // 支持选择角色\n            showRole: {\n                type: Boolean,\n                default: true,\n            },\n            // 在下拉面板中显示禁用用户\n            showDisableUser: {\n                type: Boolean,\n                default: true,\n            },\n            // 不在下拉列表中显示设置的 user\n            filterList: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                isLoading: false,\n                checkedUserNums: 0,\n                roleList: [{},{},{}],\n                defaultValue: [],\n                disabledUsers: [],\n            };\n        },\n        computed: {\n            realLimit () {\n                return this.limit + this.checkedUserNums;\n            },\n        },\n        watch: {\n            user: {\n                handler () {\n                    let valueList = [...this.user];\n                    if (this.showRole) {\n                        valueList = [...this.role].concat(valueList);\n                    }\n                    this.defaultValue = valueList.filter(name => !this.filterList.includes(name));\n                },\n                immediate: true,\n            },\n            role: {\n                handler () {\n                    const valueList = [\n                        ...this.role,\n                        ...this.user,\n                    ];\n                    this.defaultValue = valueList.filter(name => !this.filterList.includes(name));\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.historyKey = CACHE_KEY;\n            this.roleCacheMap = {};\n            this.fetchRoleList();\n        },\n        methods: {\n            /**\n             * @desc 获取角色列表\n             *\n             * 如果不需要显示角色则不用请求接口\n             */\n            fetchRoleList () {\n                if (!this.showRole) {\n                    return;\n                }\n                this.isLoading = true;\n                NotifyService.fetchRoleList()\n                    .then((data) => {\n                        const roleList = [];\n                        const roleCacheMap = {};\n                        data.forEach((role) => {\n                            if (this.filterList.includes(role.code)) {\n                                return;\n                            }\n                            roleList.push({\n                                display_name: role.name,\n                                username: role.code,\n                                type: 'role',\n                            });\n                            roleCacheMap[role.code] = role.name;\n                        });\n                        // 角色列表\n                        this.roleList = Object.freeze(roleList);\n                        this.roleCacheMap = roleCacheMap;\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 检测用户是否被过滤掉\n             * @param { String } username\n             * @returns { Boolean }\n             */\n            checkUsernameFilter (username) {\n                return this.filterList.includes(username);\n            },\n            /**\n             * @desc 输入框获得焦点时面板数据\n             *\n             * 显示角色列表，显示用户最近输入缓存\n             */\n            formatDefaultAlternate () {\n                const stack = [];\n                \n                if (this.roleList.length > 0) {\n                    stack.push({\n                        display_name: '角色',\n                        username: 'role',\n                        children: _.cloneDeep(this.roleList),\n                    });\n                }\n\n                // 最近选择的数据\n                if (localStorage.getItem(this.historyKey)) {\n                    const historyList = JSON.parse(localStorage.getItem(this.historyKey)) || [];\n                    // 只显示最近输入的用户\n                    const children = historyList.reduce((result, item) => {\n                        if (item.type === 'user'\n                            && !this.checkUsernameFilter(item.username)) {\n                            result.push(item);\n                        }\n                        return result;\n                    }, []);\n                    stack.push({\n                        display_name: '最近输入',\n                        username: 'history',\n                        children,\n                    });\n                }\n                return stack;\n            },\n            /**\n             * @desc 模糊搜索\n             * @param { String } keyword 用户搜索关键字\n             */\n            handleFuzzySearch (keyword) {\n                const params = {\n                    limit: this.realLimit,\n                    prefixStr: keyword,\n                };\n                const formatData = (target) => {\n                    const stack = [];\n                    // 匹配角色\n                    if (this.showRole) {\n                        const filterReg = new RegExp(encodeRegexp(keyword));\n                        const filterRoleList = this.roleList.filter(role => filterReg.test(role.display_name)\n                            || filterReg.test(role.username));\n                        if (filterRoleList.length > 0) {\n                            stack.push({\n                                display_name: '角色',\n                                username: 'role',\n                                children: filterRoleList,\n                            });\n                        }\n                    }\n                    // 用户接口数据为空\n                    if (target.length < 1) {\n                        return stack;\n                    }\n                    \n                    this.disabledUsers = [];\n                    const userList = [];\n                \n                    target.forEach((curUser) => {\n                        // 被过滤掉的用户\n                        if (this.filterList.includes(curUser.englishName)) {\n                            return;\n                        }\n                        // 黑名单用户\n                        if (!this.showDisableUser && !curUser.enable) {\n                            return;\n                        }\n                        if (!curUser.enable) {\n                            this.disabledUsers.push(curUser.englishName);\n                        }\n                        userList.push({\n                            display_name: curUser.englishName,\n                            username: curUser.englishName,\n                            type: 'user',\n                        });\n                    });\n                \n                    stack.push({\n                        display_name: '用户',\n                        username: 'user',\n                        children: Object.freeze(userList),\n                    });\n                    return stack;\n                };\n                return NotifyService.fetchAllUsers(params)\n                    .then(data => ({\n                        next: false,\n                        results: formatData(data, keyword),\n                    }));\n            },\n            renderTag (h, node) {\n                let { username } = node;\n                let iconType = 'user';\n                // 角色\n                if (this.roleCacheMap[node.username]) {\n                    username = this.roleCacheMap[node.username];\n                    iconType = 'user-group-gray';\n                }\n                \n                return (\n                    <div class='jb-user-seletor-member-tag' key={node.index} title={username}>\n                        <icon type={iconType} class='tag-icon' />\n                        <span class='text'>{username}</span>\n                    </div>\n                );\n            },\n            renterMerberItem (h, payload) {\n                const curData = payload.user;\n                \n                const renderLogoHtml = () => {\n                    if (curData.logo) {\n                        return (\n                            <img class='img' src={curData.logo} />\n                        );\n                    }\n                    return (\n                        <icon type={curData.type === 'role' ? 'user-group-gray' : 'user'} class='item-icon' />\n                    );\n                };\n\n                const isDisabled = payload.disabled;\n                const isEnLang = 'zh-CN' === 'en-US';\n\n                const renderForbidHtml = () => {\n                    if (isDisabled) {\n                        return (\n                            <icon type={isEnLang ? 'forbid-en' : 'forbid'} class='forbid-icon' svg />\n                        );\n                    }\n                    return '';\n                };\n                \n                return (\n                    <div\n                        class={{\n                            'jb-user-selector-member-item': true,\n                            'is-disabled': isDisabled,\n                        }}\n                        title={curData.display_name}>\n                        {renderLogoHtml()}\n                        <span class='text'>{curData.display_name}</span>\n                        {renderForbidHtml()}\n                    </div>\n                );\n            },\n            handleChange (payload) {\n                const role = [];\n                const user = [];\n                payload.forEach((item) => {\n                    if (this.roleCacheMap[item]) {\n                        role.push(item);\n                    } else {\n                        user.push(item);\n                    }\n                });\n                this.checkedUserNums = user.length;\n                this.$emit('on-change', user, role);\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .jb-user-selector {\n        width: 100%;\n\n        &.disabled {\n            height: 32px;\n        }\n\n        .user-selector {\n            width: 100%;\n        }\n    }\n\n    .jb-user-seletor-member-tag {\n        padding-right: 2px;\n\n        .tag-icon {\n            font-size: 16px;\n            color: #979ba5;\n        }\n\n        .text {\n            display: inline-block;\n            max-width: 150px;\n            margin-left: 4px;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n            vertical-align: top;\n        }\n    }\n\n    .jb-user-selector-member-item {\n        position: relative;\n        display: flex;\n        padding-left: 10px;\n        align-items: center;\n\n        &.is-disabled {\n            cursor: not-allowed;\n            user-select: none;\n\n            .text,\n            .item-icon {\n                color: #c4c6cc;\n            }\n        }\n\n        .img {\n            width: 20px;\n            border-radius: 50%;\n        }\n\n        .item-icon {\n            font-size: 20px;\n            color: #979ba5;\n        }\n\n        .text {\n            display: inline-block;\n            max-width: 150px;\n            margin-left: 5px;\n            overflow: hidden;\n            color: #63656e;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n            vertical-align: top;\n        }\n\n        .forbid-icon {\n            position: absolute;\n            right: 0;\n            margin-left: 4px;\n            font-size: 30px;\n        }\n    }\n</style>\n","<template>\n    <div class=\"global-variable-detail\" :class=\"classes\">\n        <div class=\"variable-name\">\n            <span>{{ data.name }}：</span>\n        </div>\n        <div class=\"variable-value\">\n            <component\n                ref=\"value\"\n                :is=\"typeCom\"\n                :data=\"data\"\n                v-bind=\"$attrs\"\n                v-on=\"$listeners\" />\n        </div>\n    </div>\n</template>\n<script>\n    import TypeText from './text';\n    import TypeHost from './host';\n\n    export default {\n        props: {\n            type: {\n                type: Number,\n                required: true,\n            },\n            valueWidth: {\n                type: String,\n                default: '500px',\n            },\n            data: {\n                type: Object,\n                required: true,\n            },\n            layout: {\n                type: String,\n                default: 'horizontal', // 水平：horizontal；垂直：vertical\n            },\n        },\n        data () {\n            return {\n                isError: false,\n                isEmpty: false,\n            };\n        },\n        computed: {\n            typeCom () {\n                const comMap = {\n                    1: TypeText,\n                    2: TypeText,\n                    3: TypeHost,\n                    4: TypeText,\n                    5: TypeText,\n                    6: TypeText,\n                };\n                if (!Object.prototype.hasOwnProperty.call(comMap, this.type)) {\n                    return 'div';\n                }\n                \n                return comMap[this.type];\n            },\n            classes () {\n                const classes = {};\n                if (this.isEmpty) {\n                    return classes;\n                }\n                if (this.layout === 'vertical') {\n                    classes.vertical = true;\n                }\n                return classes;\n            },\n        },\n        mounted () {\n            const unWatch = this.$watch(() => this.$refs.value.isEmpty, (value) => {\n                this.isEmpty = Boolean(value);\n            }, {\n                immediate: true,\n            });\n            this.$once('hook:beforeDestroy', () => {\n                unWatch();\n            });\n        },\n    };\n</script>\n<style lang='postcss'>\n    .global-variable-detail {\n        display: flex;\n        flex: 1;\n        font-size: 14px;\n        line-height: 36px;\n\n        &.vertical {\n            flex-direction: column;\n        }\n\n        .variable-name {\n            padding-right: 2px;\n            color: #b2b5bd;\n            text-align: right;\n            white-space: normal;\n            box-sizing: content-box;\n        }\n\n        .variable-value {\n            flex: 1 0;\n            color: #63656e;\n        }\n    }\n</style>\n","\n\n<template functional>\n    <div class=\"task-exection-status-bar\">\n        <div v-if=\"props.data.name\" class=\"title\">\n            （<div class=\"title-text\">{{ props.data.name }}</div>）\n        </div>\n        <div class=\"status-box\">\n            <div class=\"status\">\n                <span>{{ '状态'}}：</span>\n                <span class=\"status-text\">{{ props.data.statusDesc }}</span>\n            </div>\n            <div class=\"time\">\n                <span>{{ '总耗时' }}：</span>\n                <span\n                    class=\"value\"\n                    :style=\"{\n                        width: `${((props.data.totalTimeText && props.data.totalTimeText.length) || 1) * 9}px`,\n                    }\">\n                    {{ props.data.totalTimeText }}\n                </span>\n            </div>\n            <div class=\"action\">\n                <slot />\n            </div>\n        </div>\n    </div>\n</template>\n<style lang='postcss'>\n    .task-exection-status-bar {\n        .step-instance-action {\n            border: 1px solid #c4c6cc;\n\n            &:hover {\n                border-color: #ea3636;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"exection-status-bar\" :class=\"[data.displayStyle]\">\n        <component :is=\"themeCom\" :data=\"data\" :title-max-width=\"titleMaxWidth\">\n            <slot />\n        </component>\n    </div>\n</template>\n<script>\n    import Task from './task';\n    import Step from './step';\n\n    export default {\n        name: '',\n        components: {\n            Task,\n            Step,\n        },\n        props: {\n            type: {\n                type: String,\n                required: true,\n            },\n            data: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                titleMaxWidth: 100,\n                offsetRight: 'unset',\n                initialStatusWidth: 0,\n            };\n        },\n        computed: {\n            themeCom () {\n                const comMap = {\n                    task: Task,\n                    step: Step,\n                };\n                if (!Object.prototype.hasOwnProperty.call(comMap, this.type)) {\n                    return 'div';\n                }\n                return comMap[this.type];\n            },\n        },\n        mounted () {\n            const $container = document.querySelector('#sitePageTitle');\n            const containerWidth = $container.getBoundingClientRect().width;\n            const $target = document.querySelector('#siteHeaderStatusBar');\n\n            $target.appendChild(this.$el);\n            const statusWidth = $target.getBoundingClientRect().width;\n            if (!this.initialStatusWidth) {\n                this.initialStatusWidth = statusWidth;\n            }\n            \n            const titleMaxWidth = containerWidth - statusWidth - 40;\n            this.titleMaxWidth = titleMaxWidth < 100 ? 100 : titleMaxWidth;\n\n            this.$once('hook:beforeDestroy', () => {\n                if (!this.$el) {\n                    return;\n                }\n                try {\n                    $target.removeChild(this.$el);\n                } catch {}\n            });\n        },\n    };\n</script>\n<style lang='postcss'>\n    .exection-status-bar {\n        flex: 1;\n        font-size: 14px;\n        color: #63656e;\n        white-space: nowrap;\n\n        &.fail,\n        &.confirm-forced {\n            .status-text {\n                color: #ea3636;\n            }\n        }\n\n        &.loading {\n            .status-text {\n                color: #3a84ff;\n            }\n        }\n\n        &.ingore {\n            .status-text {\n                color: #abd88a;\n            }\n        }\n\n        &.success,\n        &.forced {\n            .status-text {\n                color: #2dcb8d;\n            }\n        }\n\n        &.confirm {\n            .status-text {\n                color: #ff9c01;\n            }\n        }\n\n        &.disable {\n            .status-text {\n                color: #c4c6cc;\n            }\n        }\n\n        .title {\n            display: flex;\n            align-items: center;\n            margin-right: 54px;\n            font-size: 12px;\n\n            .title-text {\n                height: 21px;\n            }\n        }\n\n        .status-box {\n            position: absolute;\n            top: 0;\n            bottom: 0;\n            left: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            width: 500px;\n            transform: translateX(-50%);\n        }\n\n        .status {\n            margin-right: 30px;\n        }\n\n        .time {\n            min-width: 120px;\n            padding-right: 10px;\n\n            .value {\n                display: inline-block;\n                color: #313238;\n            }\n        }\n\n        .step-instance-action {\n            margin-right: 0;\n        }\n    }\n</style>\n","<template>\n    <jb-popover-confirm\n        class=\"step-action-confirm\"\n        :title=\"confirmInfo.title\"\n        :content=\"confirmInfo.desc\"\n        :confirm-handler=\"handleConfirm\"\n        @show=\"handleConfirmShow\"\n        @cancel=\"handleConfirmCancel\">\n        <component\n            :is=\"actionCom\"\n            class=\"step-instance-action\"\n            :class=\"displayStyle\" />\n    </jb-popover-confirm>\n</template>\n<script>\n       import ActionConfirm from './confirm';\n    import ActionConfirmForced from './confirm-forced';\n    import ActionConfirmRetry from './confirm-retry';\n    import ActionAllRetry from './all-retry';\n    import ActionFailIpRetry from './fail-ip-retry';\n    import ActionSkip from './skip';\n    import ActionForced from './forced';\n    import ActionForcedRetry from './forced-retry';\n    import ActionForcedSkip from './forced-skip';\n    import ActionNext from './next';\n\n    const ACTION_FAIL_IP_RETRY = 2;\n    const ACTION_SKIP = 3;\n    const ACTION_CONFIRM = 6;\n    const ACTION_ALL_RETRY = 8;\n    const ACTION_CONFIRM_FORCED = 9;\n    const ACTION_CONFIRM_RETRY = 10;\n    const ACTION_NEXT = 11;\n    const ACTION_FORCED_SKIP = 12;\n\n    const actionMap = {\n        confirm: {\n            operationCode: ACTION_CONFIRM,\n            title: '确定继续执行？',\n            desc: '将继续执行后面的步骤',\n        },\n        confirmForced: {\n            operationCode: ACTION_CONFIRM_FORCED,\n            title: '确定终止流程？',\n            desc: '人工确认步骤终止后，需「重新发起确认」才可恢复',\n        },\n        confirmRetry: {\n            operationCode: ACTION_CONFIRM_RETRY,\n            title: '确定重新发起确认？',\n            desc: '将会再次发送消息通知相关的确认人',\n        },\n        allRetry: {\n            operationCode: ACTION_ALL_RETRY,\n            title: '确定全部重试？',\n            desc: '该步骤的所有IP 都将重新执行',\n        },\n        failIpRetry: {\n            operationCode: ACTION_FAIL_IP_RETRY,\n            title: '确定失败IP重试？',\n            desc: '仅作用于本次执行失败的 IP',\n        },\n        skip: {\n            operationCode: ACTION_SKIP,\n            title: '确定进入下一步？',\n            desc: '跳过当前步骤进入下一步',\n        },\n        forced: {\n            operationCode: '',\n            title: '确定终止执行任务？',\n            desc: '终止动作仅对当前还未执行完成的IP有效',\n        },\n        forcedRetry: {\n            operationCode: ACTION_ALL_RETRY,\n            title: '确定重试并继续？',\n            desc: '该步骤的所有IP 都将重新执行',\n        },\n        forcedSkip: {\n            operationCode: ACTION_FORCED_SKIP,\n            title: '确定跳过并进入下一步？',\n            desc: '将不再等待强制终止动作的结果，直接进入下一步',\n        },\n        next: {\n            operationCode: ACTION_NEXT,\n            title: '确定进入下一步？',\n            desc: '跳过当前步骤进入下一步',\n        },\n    };\n\n    export default {\n        props: {\n            name: {\n                type: String,\n                required: true,\n            },\n            displayStyle: {\n                type: String,\n                default: 'task',\n            },\n            confirmHandler: {\n                type: Function,\n                default: () => {},\n            },\n        },\n        computed: {\n            actionCom () {\n                const comMap = {\n                    confirm: ActionConfirm,\n                    confirmForced: ActionConfirmForced,\n                    confirmRetry: ActionConfirmRetry,\n                    allRetry: ActionAllRetry,\n                    failIpRetry: ActionFailIpRetry,\n                    skip: ActionSkip,\n                    forced: ActionForced,\n                    forcedRetry: ActionForcedRetry,\n                    forcedSkip: ActionForcedSkip,\n                    next: ActionNext,\n                };\n                return comMap[this.name];\n            },\n            confirmInfo () {\n                return actionMap[this.name];\n            },\n        },\n        methods: {\n            handleConfirm () {\n                return this.confirmHandler(this.confirmInfo.operationCode);\n            },\n            handleConfirmShow () {\n                this.$emit('on-show');\n            },\n            handleConfirmCancel () {\n                this.$emit('on-cancel');\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .step-action-confirm {\n        display: inline-flex;\n    }\n\n    .step-instance-action {\n        display: flex;\n        height: 32px;\n        padding: 0 12px 0 8px;\n        margin-right: 10px;\n        font-size: 14px;\n        color: #63656e;\n        cursor: pointer;\n        background: #fff;\n        border-radius: 16px;\n        align-items: center;\n        justify-content: center;\n\n        &:hover {\n            i {\n                color: currentColor;\n            }\n        }\n\n        &.task-detail {\n            box-shadow: 0 2px 6px #ddd;\n        }\n\n        &.step-detail {\n            border: 1px solid #c4c6cc;\n        }\n\n        &.stop,\n        &.confirm-forced {\n            &:hover {\n                color: #ea3636;\n                border-color: #c4c6cc;\n            }\n        }\n\n        &.retry,\n        &.skip,\n        &.next,\n        &.confirm {\n            &:hover {\n                color: #3a84ff;\n                border-color: #3a84ff;\n            }\n        }\n\n        i {\n            margin-right: 6px;\n            font-size: 16px;\n            color: #979ba5;\n        }\n    }\n</style>\n","<template>\n    <div class=\"execute-global-variable\" v-bkloading=\"{ isLoading }\">\n        <template v-if=\"!isLoading\">\n            <global-variable-layout v-if=\"taskVariables.length > 0\">\n                <global-variable\n                    v-for=\"variable in taskVariables\"\n                    ref=\"variable\"\n                    :type=\"variable.type\"\n                    :key=\"variable.id\"\n                    :layout=\"variable.type === 3 ? 'vertical' : ''\"\n                    :data=\"variable\" />\n            </global-variable-layout>\n            <empty v-else class=\"empty\" />\n        </template>\n    </div>\n</template>\n<script>\n    import TaskExecuteService from '@service/task-execute';\n    import TaskHostNodeModel from '@model/task-host-node';\n    import GlobalVariableLayout from '@components/global-variable/layout';\n    import GlobalVariable from '@components/global-variable/view';\n    import Empty from '@components/empty';\n\n    export default {\n        name: '',\n        components: {\n            GlobalVariableLayout,\n            GlobalVariable,\n            Empty,\n        },\n        props: {\n            id: {\n                type: [Number, String],\n                default: 0,\n            },\n        },\n        data () {\n            return {\n                isLoading: false,\n                taskVariables: [{}, {}, {}],\n            };\n        },\n        computed: {\n            isShowVar () {\n                return this.taskVariables.length > 0;\n            },\n        },\n        watch: {\n            id: {\n                handler  (id) {\n                    if (!id) {\n                        return;\n                    }\n                    this.fetchTaskVariables(id);\n                },\n                immediate: true,\n            },\n        },\n        methods: {\n            fetchTaskVariables (id) {\n                this.$request(TaskExecuteService.fetchStepInstanceParam({\n                    id,\n                }), () => {\n                    this.isLoading = true;\n                }).then((data) => {\n                    this.taskVariables = Object.freeze(data.map(({ id, name, type, value, targetValue }) => ({\n                        id,\n                        name,\n                        type,\n                        defaultValue: value,\n                        defaultTargetValue: new TaskHostNodeModel(targetValue || {}),\n                    })));\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .execute-global-variable {\n        min-height: calc(100vh - 120px);\n    }\n\n    .empty {\n        padding-top: 80px;\n    }\n</style>\n","<template>\n    <div class=\"job-execute-record\" v-bkloading=\"{ isLoading }\">\n        <template v-if=\"!isLoading\">\n            <bk-table v-if=\"data.length > 0\" :data=\"data\">\n                <bk-table-column :label=\"'时间'\" prop=\"createTime\" width=\"180\" />\n                <bk-table-column :label=\"'操作人'\" prop=\"operator\" width=\"120\" />\n                <bk-table-column :label=\"'操作'\" prop=\"operationName\" width=\"120\" />\n                <bk-table-column\n                    :label=\"'步骤'\"\n                    prop=\"stepName\"\n                    show-overflow-tooltip\n                    class-name=\"step-name\" />\n                <bk-table-column :label=\"'详情'\">\n                    <template slot-scope=\"{ row }\">\n                        <bk-button\n                            v-if=\"row.detailEnable\"\n                            theme=\"primary\"\n                            text\n                            @click=\"handleView(row)\">{{ row.detail }}</bk-button>\n                        <div v-else>{{ row.detail }}</div>\n                    </template>\n                </bk-table-column>\n            </bk-table>\n            <empty v-else class=\"empty\" />\n        </template>\n    </div>\n</template>\n<script>\n       import TaskExecuteService from '@service/task-execute';\n    import Empty from '@components/empty';\n\n    export default {\n        name: '',\n        components: {\n            Empty,\n        },\n        props: {\n            id: {\n                type: [Number, String],\n                default: 0,\n            },\n            from: {\n                type: String,\n                default: '',\n            },\n        },\n        data () {\n            return {\n                isLoading: true,\n                data: [{},{},{}],\n            };\n        },\n        created () {\n            this.fetchTaskOperationLog();\n        },\n        methods: {\n            fetchTaskOperationLog (id) {\n                this.$request(TaskExecuteService.fetchTaskOperationLog({\n                    id: this.id,\n                }), () => {\n                    this.isLoading = true;\n                }).then((data) => {\n                    this.data = data;\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            handleView (payload) {\n                const routerInfo = {\n                    name: 'historyStep',\n                    params: {\n                        taskInstanceId: payload.taskInstanceId,\n                    },\n                    query: {\n                        stepInstanceId: payload.stepInstanceId,\n                        retryCount: payload.retry,\n                        from: this.from || this.$route.query.from,\n                    },\n                };\n                // 跳转路由没变\n                const { stepInstanceId, retryCount = 0 } = this.$route.query;\n                if (parseInt(stepInstanceId, 10) === payload.stepInstanceId\n                    && parseInt(retryCount, 10) === payload.retry) {\n                    this.messageWarn('正在查看');\n                    return;\n                }\n                \n                this.$emit('on-change');\n                this.$router.push(routerInfo);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .job-execute-record {\n        min-height: calc(100vh - 120px);\n\n        .empty {\n            padding-top: 80px;\n        }\n    }\n</style>\n","<template>\n    <div class=\"render-file-path-box\">\n        <bk-popover placement=\"left\">\n            <div v-for=\"(item, fileIndex) in renderData\" :key=\"fileIndex\" class=\"path-text-row\">\n                {{ item }}\n            </div>\n            <div v-if=\"hasMore\">...</div>\n            <ul slot=\"content\" class=\"source-file-tips-box\">\n                <li v-for=\"(item, fileIndex) in data\" :key=\"fileIndex\" class=\"row\">\n                    <span class=\"dot\" />\n                    {{ item }}\n                </li>\n            </ul>\n        </bk-popover>\n    </div>\n</template>\n<script>\n    const DISPLAY_ROW_NUMS = 3;\n\n    export default {\n        name: '',\n        props: {\n            data: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {};\n        },\n        computed: {\n            renderData () {\n                return this.data.slice(0, DISPLAY_ROW_NUMS);\n            },\n            hasMore () {\n                return this.data.length > DISPLAY_ROW_NUMS;\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    @import \"@/css/mixins/scroll\";\n\n    .render-file-path-box {\n        padding: 6px 10px;\n        margin-left: -10px;\n\n        &:hover {\n            background: #f0f1f5;\n        }\n    }\n\n    .source-file-tips-box {\n        max-width: 300px;\n        max-height: 280px;\n        min-width: 60px;\n        overflow-y: auto;\n\n        @mixin scroller;\n\n        .row {\n            word-break: break-all;\n        }\n\n        .dot {\n            display: inline-block;\n            width: 6px;\n            height: 6px;\n            background: currentColor;\n            border-radius: 50%;\n        }\n    }\n</style>\n","<template>\n    <div class=\"step-view-global-variable\" @click=\"handlerView\">\n        <div class=\"flag\">\n            <Icon type=\"host\" />\n        </div>\n        <div class=\"name\" :title=\"name\">{{ name }}</div>\n        <jb-dialog\n            v-model=\"isShowDetail\"\n            :title=\"title\"\n            :width=\"1020\"\n            :ok-text=\"'关闭'\"\n            class=\"global-host-variable-detail-dialog\">\n            <template #header>\n                <div class=\"variable-title\">\n                    <span>{{ title }}</span>\n                    <i class=\"global-variable-dialog-close bk-icon icon-close\" @click=\"handleClose\" />\n                </div>\n            </template>\n            <div class=\"content-wraper\">\n                <Empty v-if=\"isEmpty\" :title=\"'变量值为空'\" style=\"height: 100%;\" />\n                <scroll-faker v-else>\n                    <server-panel\n                        detail-mode=\"dialog\"\n                        :host-node-info=\"hostNodeInfo\" />\n                </scroll-faker>\n            </div>\n        </jb-dialog>\n    </div>\n</template>\n<script>\n       import TaskHostNodeModel from '@model/task-host-node';\n    import ScrollFaker from '@components/scroll-faker';\n    import ServerPanel from '@components/choose-ip/server-panel';\n    import Empty from '@components/empty';\n\n    export default {\n        name: 'StepViewGlobalVariable',\n        components: {\n            ScrollFaker,\n            ServerPanel,\n            Empty,\n        },\n        props: {\n            type: {\n                type: String,\n                default: '',\n            },\n            name: {\n                type: String,\n                required: true,\n            },\n            data: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            const { hostNodeInfo } = new TaskHostNodeModel({});\n            \n            return {\n                isShowDetail: false,\n                hostNodeInfo,\n            };\n        },\n        computed: {\n            title () {\n                if (this.type) {\n                    return this.type;\n                }\n                return `${'全局变量'} - ${this.name}`;\n            },\n            isEmpty () {\n                return TaskHostNodeModel.isHostNodeInfoEmpty(this.hostNodeInfo);\n            },\n        },\n        methods: {\n            handlerView () {\n                const curVariable = this.data.find(item => item.name === this.name);\n                this.hostNodeInfo = Object.freeze(curVariable.defaultTargetValue.hostNodeInfo);\n                \n                this.isShowDetail = true;\n            },\n            handleClose () {\n                this.isShowDetail = false;\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .global-host-variable-detail-dialog {\n        .bk-dialog-tool {\n            display: none;\n        }\n\n        .bk-dialog-header,\n        .bk-dialog-footer {\n            position: relative;\n            z-index: 99999;\n            background: #fff;\n        }\n\n        .bk-dialog-header {\n            padding: 0;\n        }\n\n        .bk-dialog-wrapper .bk-dialog-header .bk-dialog-header-inner {\n            font-size: 20px;\n            color: #000;\n            text-align: left;\n        }\n\n        .bk-dialog-wrapper .bk-dialog-body {\n            padding: 0;\n\n            .server-panel {\n                height: 100%;\n\n                &.show-detail {\n                    overflow: hidden;\n                }\n\n                .host-detail.show {\n                    padding-left: 20%;\n                }\n            }\n        }\n\n        .content-wraper {\n            height: 450px;\n            max-height: 450px;\n            min-height: 450px;\n            margin-top: -1px;\n        }\n\n        button[name=\"cancel\"] {\n            display: none;\n        }\n\n        .variable-title {\n            position: relative;\n            height: 68px;\n            padding-top: 0;\n            padding-bottom: 0;\n            padding-left: 25px;\n            font-size: 20px;\n            line-height: 68px;\n            color: #000;\n            text-align: left;\n            border-bottom: 1px solid #dcdee5;\n        }\n\n        .global-variable-dialog-close {\n            position: absolute;\n            top: 0;\n            right: 0;\n            font-size: 32px;\n            color: #c4c6cc;\n            cursor: pointer;\n            transition: all 0.15s;\n\n            &:hover {\n                transform: rotateZ(90deg);\n            }\n        }\n    }\n</style>\n<style lang='postcss' scoped>\n    .step-view-global-variable {\n        display: inline-flex;\n        height: 24px;\n        padding-right: 10px;\n        line-height: 1;\n        cursor: pointer;\n        background: #fff;\n\n        .flag {\n            display: flex;\n            height: 24px;\n            font-size: 13px;\n            color: #fff;\n            background: #3a84ff;\n            border-bottom-left-radius: 2px;\n            border-top-left-radius: 2px;\n            flex: 0 0 24px;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .name {\n            display: flex;\n            padding: 0 10px;\n            white-space: nowrap;\n            border: 1px solid #dcdee5;\n            border-left: none;\n            border-top-right-radius: 2px;\n            border-bottom-right-radius: 2px;\n            align-items: center;\n        }\n    }\n</style>\n","<template>\n    <div ref=\"aceEditor\" class=\"jd-ace-editor\" :style=\"{ height: `${height}px` }\">\n        <div\n            ref=\"contentWrapper\"\n            class=\"jb-ace-content\"\n            :class=\"{ readonly }\"\n            :style=\"boxStyle\"\n            v-bkloading=\"{ isLoading: isLoading, opacity: 0.2 }\">\n            <div\n                v-if=\"showTabHeader\"\n                class=\"jb-ace-title\"\n                :style=\"{ height: `${tabHeight}px` }\">\n                <template v-for=\"(val, key) in tabList\">\n                    <div\n                        class=\"jb-ace-mode-item\"\n                        @click=\"handleLangChange(key)\"\n                        :key=\"val\"\n                        :class=\"{ 'active': currentLang === key }\">\n                        {{ key }}\n                    </div>\n                </template>\n            </div>\n            <div class=\"jb-ace-main\">\n                <div class=\"ace-edit-content\">\n                    <div :id=\"selfId\" :style=\"editorStyle\" />\n                </div>\n                <div class=\"right-side-panel\">\n                    <slot name=\"side\" />\n                </div>\n            </div>\n            <div class=\"jb-ace-action\" :style=\"{ height: `${tabHeight}px` }\">\n                <slot name=\"action\" />\n                <template v-if=\"!readonly && !isFullScreen\">\n                    <Icon\n                        type=\"upload\"\n                        @click=\"handleUploadScript\"\n                        v-bk-tooltips=\"'上传脚本'\" />\n                    <Icon\n                        type=\"history\"\n                        @click.stop=\"handleShowHistory\"\n                        v-bk-tooltips=\"'历史缓存'\" />\n                </template>\n                <Icon\n                    v-if=\"!isFullScreen\"\n                    type=\"full-screen\"\n                    v-bk-tooltips=\"'全屏'\"\n                    @click=\"handleFullScreen\" />\n                <Icon\n                    v-if=\"isFullScreen\"\n                    type=\"un-full-screen\"\n                    v-bk-tooltips=\"'还原'\"\n                    @click=\"handleExitFullScreen\" />\n            </div>\n            <div\n                v-if=\"isShowHistoryPanel\"\n                ref=\"historyPanel\"\n                class=\"jb-ace-history-panel\"\n                @click.stop=\"\">\n                <div class=\"panel-header\">\n                    <div>{{ '历史缓存' }}</div>\n                    <div class=\"save-btn\" @click.stop=\"handleSaveHistory\">{{ '手动保存' }}</div>\n                </div>\n                <div v-if=\"historyList.length > 0\" style=\"max-height: 250px;\">\n                    <scroll-faker>\n                        <div class=\"panel-body\">\n                            <div v-for=\"item in historyList\" :key=\"item.name\" class=\"item\">\n                                <div class=\"history-name\" v-bk-overflow-tips>{{ item.name }}</div>\n                                <div class=\"history-action\" @click=\"handleChangeValueFromHistory(item)\">{{ '载入' }}</div>\n                            </div>\n                        </div>\n                    </scroll-faker>\n                </div>\n                <empty v-else class=\"history-empty\" :width=\"100\" />\n            </div>\n            <input\n                ref=\"upload\"\n                type=\"file\"\n                style=\"position: absolute; width: 0; height: 0;\"\n                @change=\"handleStartUpload\">\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import { Base64 } from 'js-base64';\n    import ace from 'ace/ace';\n    import 'ace/mode-sh';\n    import 'ace/snippets/sh';\n    import 'ace/mode-batchfile';\n    import 'ace/snippets/batchfile';\n    import 'ace/mode-perl';\n    import 'ace/snippets/perl';\n    import 'ace/mode-python';\n    import 'ace/snippets/python';\n    import 'ace/mode-powershell';\n    import 'ace/snippets/powershell';\n    import 'ace/mode-sql';\n    import 'ace/snippets/sql';\n    import 'ace/theme-monokai';\n    import 'ace/ext-error_marker';\n    import 'ace/ext-language_tools';\n    import 'ace/ext-keybinding_menu';\n    import 'ace/ext-elastic_tabstops_lite';\n    import ScriptTemplateService from '@service/script-template';\n    import ScriptService from '@service/script-manage';\n    import PublicScriptService from '@service/public-script-manage';\n    import UserService from '@service/user';\n    import ScrollFaker from '@components/scroll-faker';\n    import Empty from '@components/empty';\n    import {\n        formatScriptTypeValue,\n        prettyDateTimeFormat,\n    } from '@utils/assist';\n    import DefaultScript from './default-script';\n\n    export const builtInScript = Object.keys(DefaultScript).reduce((result, item) => {\n        result[item] = Base64.encode(DefaultScript[item]);\n        return result;\n    }, {});\n\n    const languageTools = ace.require('ace/ext/language_tools');\n\n    const TAB_HEIGHT = 40;\n    const LANG_MAP = {\n        Shell: 'sh',\n        Bat: 'batchfile',\n        Perl: 'perl',\n        Python: 'python',\n        Powershell: 'powershell',\n        SQL: 'sql',\n    };\n    const LOCAL_STORAGE_KEY = 'ace_editor_history';\n    \n    const escapeHTML = str => str.replace(/&/g, '&#38;').replace(/\"/g, '&#34;')\n        .replace(/'/g, '&#39;')\n        .replace(/</g, '&#60;');\n    const HTMLEncode = (value) => {\n        const temp = document.createElement('textarea');\n        temp.value = value;\n        return temp.value;\n    };\n    \n    export default {\n        name: 'AceEditor',\n        components: {\n            ScrollFaker,\n            Empty,\n        },\n        inheritAttrs: false,\n        props: {\n            // 脚本内容\n            value: {\n                type: String,\n            },\n            height: {\n                type: Number,\n                default: 480,\n            },\n            // 只读模式\n            readonly: {\n                type: Boolean,\n                default: false,\n            },\n            readonlyTips: {\n                type: String,\n                default: '只读模式不支持编辑',\n            },\n            // 当前的脚本语言\n            lang: {\n                type: String,\n                required: true,\n            },\n            // 可支持切换的脚本类型（array：显示tab; string: 不显示tab）\n            options: {\n                type: [\n                    String,\n                    Array,\n                ],\n                default: () => Object.keys(LANG_MAP),\n            },\n            // 默认脚本是否显示用户自定义内容，默认为 true\n            customEnable: {\n                type: Boolean,\n                default: true,\n            },\n            // 自定义全局变量\n            constants: {\n                type: Array,\n                default: () => [],\n            },\n            // 切换脚本语言前的确认动作\n            beforeLangChange: {\n                type: Function,\n                default: () => Promise.resolve(),\n            },\n        },\n        data () {\n            return {\n                isLoading: false,\n                content: '',\n                currentLang: this.lang,\n                isFullScreen: false,\n                isShowHistoryPanel: false,\n                tabHeight: TAB_HEIGHT,\n                historyList: [{},{},{}],\n                currentUser: {},\n            };\n        },\n        computed: {\n            /**\n             * @desc 脚本编辑器块的样式\n             * @returns {Object}\n            */\n            boxStyle () {\n                const style = {\n                    position: 'absolute',\n                    top: 0,\n                    left: 0,\n                    width: '100%',\n                    height: '100%',\n                };\n                if (this.isFullScreen) {\n                    style.position = 'fixed';\n                    style.zIndex = window.__bk_zIndex_manager.nextZIndex(); // eslint-disable-line no-underscore-dangle\n                    style.height = '100vh';\n                }\n                return style;\n            },\n            /**\n             * @desc 脚本输入区的样式\n             * @returns {Object}\n            */\n            editorStyle () {\n                const tabHeight = this.showTabHeader ? TAB_HEIGHT : 0;\n                return {\n                    height: this.isFullScreen ? `calc(100vh - ${tabHeight}px)` : `${this.height - tabHeight}px`,\n                };\n            },\n            /**\n             * @desc 是否显示脚本类型切换 TAB, 当options 配置 String 时不显示\n             * @returns {Boolean}\n            */\n            showTabHeader () {\n                return typeof this.options !== 'string';\n            },\n            /**\n             * @desc 显示类型显示列表\n             * @returns {Object}\n            */\n            tabList () {\n                if (!Array.isArray(this.options)) {\n                    return [];\n                }\n                return this.options.reduce((res, item) => {\n                    if (Object.prototype.hasOwnProperty.call(LANG_MAP, item)) {\n                        res[item] = LANG_MAP[item];\n                    }\n                    return res;\n                }, {});\n            },\n            /**\n             * @desc 脚本编辑器语言模式\n             * @returns {String}\n            */\n            mode () {\n                return `ace/mode/${LANG_MAP[this.currentLang]}`;\n            },\n        },\n        watch: {\n            value: {\n                handler (value) {\n                    // 只读模式没有默认值，直接使用输入值\n                    if (this.readonly) {\n                        this.editor.setValue(Base64.decode(value));\n                        this.editor.clearSelection();\n                    }\n                    // 外部传入空置直接清空编辑器\n                    if (value === '' && this.content !== '') {\n                        this.editor.setValue('');\n                        return;\n                    }\n                    const parseValue = Base64.decode(value);\n                    // 避免编辑造成的重复更新\n                    if (this.content !== parseValue) {\n                        this.editor.setValue(parseValue);\n                        this.editor.clearSelection();\n                    }\n                },\n            },\n            lang (newLang) {\n                if (this.currentLang !== newLang) {\n                    this.currentLang = newLang;\n                    setTimeout(() => {\n                        this.editor.getSession().setMode(this.mode);\n                    });\n                }\n            },\n            readonly (readonly) {\n                this.editor.setReadOnly(readonly);\n            },\n            constants: {\n                handler () {\n\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.selfId = `ace_editor_${_.random(1, 1000)}_${Date.now()}`;\n            this.valueMemo = {};\n            this.hasChanged = false;\n            this.historyEnable = false;\n            this.historyTimer = '';\n            this.fetchUserInfo();\n            this.fetchTemplate();\n            this.syntaxCheck = _.debounce((content) => {\n                ScriptService.getScriptValidation({\n                    content,\n                    scriptType: formatScriptTypeValue(this.currentLang),\n                }).then((data) => {\n                    // 高危语句报错状态需要全局保存\n                    this.$store.commit('setScriptCheckError', _.some(data, _ => _.isDangerous));\n                    this.editor.getSession().setAnnotations(data);\n                });\n            }, 300);\n\n            // 自定义语法提示\n            this.completer = {\n                getCompletions: (editor, session, pos, prefix, callback) => {\n                    const keywords = this.constants.map(item => ({\n                        name: item.name,\n                        value: `$\\{${item.name}}`,\n                        caption: item.name,\n                        meta: 'Global Variable',\n                        type: item.typeDescription,\n                        description: item.description,\n                        score: 1000, // 让自定义全局变量排在最上面\n                    }));\n                    callback(null, keywords);\n                },\n                getDocTooltip (item) {\n                    if (item.meta === 'Global Variable' && item.description) {\n                        item.docHTML = [\n                            '<b>description</b>',\n                            '<hr />',\n                            escapeHTML(item.description),\n                        ].join('');\n                    }\n                },\n            };\n        },\n        beforeDestroy () {\n            this.handleExitFullScreen();\n        },\n        mounted () {\n            this.initEditor();\n            languageTools.addCompleter(this.completer);\n            document.body.addEventListener('click', this.handleHideHistory);\n            document.body.addEventListener('keyup', this.handleExitByESC);\n            this.$once('hook:beforeDestroy', () => {\n                clearTimeout(this.historyTimer);\n                if (this.isChange) {\n                    this.pushLocalStorage();\n                }\n                _.remove(this.editor.completers, _ => _ === this.completer);\n                document.body.removeEventListener('click', this.handleHideHistory);\n                document.body.removeEventListener('keyup', this.handleExitByESC);\n            });\n        },\n        methods: {\n            /**\n             * @desc 获取登陆用户信息\n             */\n            fetchUserInfo () {\n                UserService.fetchUserInfo()\n                    .then((data) => {\n                        this.currentUser = Object.freeze(data);\n                    });\n            },\n            /**\n             * @desc 获取默认脚本\n             */\n            fetchTemplate () {\n                this.isLoading = true;\n                const handlePromise = this.customEnable ? ScriptTemplateService.fetchTemplate() : Promise.resolve([]);\n                handlePromise.then((data) => {\n                    const customScriptMap = data.reduce((result, item) => {\n                        result[formatScriptTypeValue(item.scriptLanguage)] = Base64.decode(item.scriptContent);\n                        return result;\n                    }, {});\n                    this.defaultScriptMap = Object.assign({}, DefaultScript, customScriptMap);\n                        \n                    // 只读或有传入值默认脚本使用prop.value\n                    // 其它情况使用脚本编辑器提供的默认值\n                    this.content = this.readonly || this.value\n                        ? Base64.decode(this.value || '')\n                        : this.defaultScriptMap[this.lang];\n                    this.editor.setValue(this.content);\n                    this.editor.scrollToLine(Infinity);\n                    this.editor.clearSelection();\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 初始化脚本编辑器\n             */\n            initEditor () {\n                const editor = ace.edit(this.selfId);\n                editor.getSession().setMode(this.mode);\n                editor.setOptions({\n                    fontSize: 13,\n                    enableBasicAutocompletion: true,\n                    enableLiveAutocompletion: true,\n                    enableSnippets: true,\n                    wrapBehavioursEnabled: true,\n                    autoScrollEditorIntoView: true,\n                    copyWithEmptySelection: true,\n                    useElasticTabstops: true,\n                    printMarginColumn: true,\n                    printMargin: 80,\n                    scrollPastEnd: 0.2,\n                });\n                editor.setTheme('ace/theme/monokai');\n                editor.setShowPrintMargin(false);\n                editor.$blockScrolling = Infinity;\n                editor.setReadOnly(this.readonly);\n                \n                editor.on('change', () => {\n                    this.content = editor.getValue();\n                    const content = Base64.encode(this.content);\n                    if (this.content && !this.readonly) {\n                        this.syntaxCheck(content);\n                    }\n                    this.editor.getSession().setAnnotations([]);\n                    if (this.historyEnable) {\n                        this.hasChanged = true;\n                    }\n                    this.$emit('input', content);\n                    this.$emit('change', content);\n                });\n                editor.on('focus', () => {\n                    this.historyEnable = true;\n                });\n                editor.on('paste', (event) => {\n                    event.text = HTMLEncode(event.text);\n                });\n                // 先保存 editor 在设置 value\n                this.editor = editor;\n                \n                this.$once('hook:beforeDestroy', () => {\n                    editor.destroy();\n                    editor.container.remove();\n                });\n                \n                this.watchEditAction();\n\n                const $handler = document.querySelector(`#${this.selfId}`);\n                $handler.addEventListener('keydown', this.handleReadonlyWarning);\n                this.$once('hook:beforeDestroy', () => {\n                    $handler.removeEventListener('keydown', this.handleReadonlyWarning);\n                });\n            },\n            /**\n             * @desc 外部调用\n             */\n            resize () {\n                this.$nextTick(() => {\n                    this.editor.resize();\n                });\n            },\n            /**\n             * @desc 外部调用-设置脚本编辑器内容\n             * @param {String} 经过 base64 编码的脚本内容\n             */\n            setValue (value) {\n                this.editor.setValue(Base64.decode(value));\n                this.editor.clearSelection();\n                this.editor.scrollToLine(Infinity);\n            },\n            /**\n             * @desc 外部调用-重置脚本编辑内容使用默认脚本\n             */\n            resetValue () {\n                this.editor.setValue(this.defaultScriptMap[this.lang]);\n                this.editor.clearSelection();\n                this.editor.scrollToLine(Infinity);\n            },\n            /**\n             * @desc 监听脚本的编辑状态\n             *\n             * 每分钟自动缓存一次\n             */\n            watchEditAction () {\n                if (this.readonly) {\n                    return;\n                }\n                this.historyTimer = setTimeout(() => {\n                    if (this.historyEnable && this.hasChanged) {\n                        this.pushLocalStorage();\n                    }\n                    this.hasChanged = false;\n                    this.watchEditAction();\n                }, 60000);\n            },\n            /**\n             * @desc 缓存脚本内容\n             * @param {String} type 缓存类型（自动缓存、手动换粗）\n             */\n            pushLocalStorage (type = '自动保存') {\n                // 当前脚本内容为空不缓存\n                if (!this.value) {\n                    return;\n                }\n                // eslint-disable-next-line max-len\n                const newCacheKey = `${type}_${window.PROJECT_CONFIG.SCOPE_TYPE}_${window.PROJECT_CONFIG.SCOPE_ID}_${this.currentUser.username}_${prettyDateTimeFormat(Date.now())}`;\n                let historyList = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));\n                if (!_.isArray(historyList)) {\n                    historyList = [];\n                }\n                if (historyList.length > 0) {\n                    // 最新缓存内容和上一次缓存内容相同不缓存\n                    if (historyList[0].content === this.value) {\n                        return;\n                    }\n                }\n                historyList.unshift({\n                    name: newCacheKey,\n                    content: this.value,\n                    lang: this.lang,\n                });\n                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(historyList.slice(0, 25)));\n            },\n            /**\n             * @desc readonly模式下键盘操作提示\n             * @param {Object} event keydown事件\n             */\n            handleReadonlyWarning (event) {\n                if (!this.readonly) {\n                    return;\n                }\n                const { target } = event;\n                // 脚本编辑器获得焦点的状态\n                if (target.type !== 'textarea') {\n                    return;\n                }\n                \n                if ([\n                    'Escape',\n                    'Meta',\n                    'ShiftLeft',\n                    'ShiftRight',\n                    'ControlLeft',\n                    'ControlRight',\n                    'AltLeft',\n                    'AltRight',\n                ].includes(event.code)) {\n                    return;\n                }\n                if ((event.metaKey || event.ctrlKey)\n                    && !['KeyV', 'KeyX'].includes(event.code)) {\n                    return;\n                }\n                this.messageWarn(this.readonlyTips);\n            },\n            /**\n             * @desc 脚本语言切换\n             * @param {String} newLang 脚本语言\n             */\n            handleLangChange (newLang) {\n                if (this.readonly || this.currentLang === newLang) {\n                    return;\n                }\n                const result = this.beforeLangChange();\n                Promise.resolve()\n                    .then(() => {\n                        if (typeof result.then === 'function') {\n                            return result;\n                        }\n                        return result ? Promise.resolve() : Promise.reject(new Error('error'));\n                    })\n                    .then(() => {\n                        this.$emit('on-mode-change', newLang);\n                        // 切换语言时缓存上一语言的脚本内容\n                        this.valueMemo[this.currentLang] = this.content;\n\n                        this.currentLang = newLang;\n                        this.editor.getSession().setMode(this.mode);\n                        if (Object.prototype.hasOwnProperty.call(this.valueMemo, this.currentLang)) {\n                            // 使用新脚本语言的上一次缓存内容\n                            this.editor.setValue(this.valueMemo[this.currentLang]);\n                        } else {\n                            // 使用新脚本语言的默认内容\n                            this.editor.setValue(this.defaultScriptMap[this.currentLang]);\n                        }\n                        this.editor.clearSelection();\n                    });\n            },\n            /**\n             * @desc 显示脚本缓存面板\n             */\n            handleShowHistory () {\n                const historyList = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));\n                if (_.isArray(historyList)) {\n                    this.historyList = Object.freeze(historyList);\n                } else {\n                    this.historyList = [];\n                }\n                this.isShowHistoryPanel = true;\n            },\n            /**\n             * @desc 隐藏脚本缓存面板\n             */\n            handleHideHistory () {\n                this.isShowHistoryPanel = false;\n            },\n            /**\n             * @desc 使用缓存的脚本内容\n             * @param {Object} payload 缓存的脚本信息\n             */\n            handleChangeValueFromHistory (payload) {\n                // 切换脚本类型tab\n                this.$emit('on-mode-change', payload.lang);\n                // 更新脚本内容\n                this.editor.setValue(Base64.decode(payload.content));\n                this.editor.clearSelection();\n                this.handleHideHistory();\n            },\n            /**\n             * @desc 手动缓存脚本内容\n             */\n            handleSaveHistory: _.debounce(function () {\n                this.pushLocalStorage('手动保存');\n                this.handleShowHistory();\n            }, 300),\n            /**\n             * @desc 触发脚本上传\n             */\n            handleUploadScript () {\n                this.$refs.upload.click();\n            },\n            /**\n             * @desc 开始上传\n             * @param {Object} event input文件选中事件\n             */\n            handleStartUpload (event) {\n                const { files } = event.target;\n                if (!files.length) {\n                    return;\n                }\n                const fileName = files[0].name;\n                const fileSuffixes = fileName.substr(fileName.lastIndexOf('.') + 1);\n                const langMap = {\n                    sh: 'Shell',\n                    bat: 'Bat',\n                    pl: 'Perl',\n                    py: 'Python',\n                    ps1: 'powershell',\n                    sql: 'SQL',\n                };\n                if (!langMap[fileSuffixes]) {\n                    this.$bkMessage({\n                        theme: 'error',\n                        message: '脚本类型不支持',\n                    });\n                    return;\n                }\n                this.isLoading = true;\n                const params = new FormData();\n                params.append('script', files[0]);\n                PublicScriptService.getUploadContent(params)\n                    .then((data) => {\n                        this.handleLangChange(langMap[fileSuffixes]);\n                        this.editor.setValue(Base64.decode(data.content));\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n                this.$refs.upload.value = '';\n            },\n            /**\n             * @desc 切换编辑的全屏状态\n             *\n             * 全屏时需要把dom移动到body下面\n             */\n            handleFullScreen () {\n                this.isFullScreen = true;\n                this.messageInfo('按 Esc 即可退出全屏模式');\n                document.body.appendChild(this.$refs.contentWrapper);\n                this.$nextTick(() => {\n                    this.editor.resize();\n                });\n            },\n            /**\n             * @desc 退出编辑的全屏状态\n             *\n             * 退出全屏时需要要把dom还原到原有位置\n             */\n            handleExitFullScreen () {\n                this.isFullScreen = false;\n                this.$refs.aceEditor.appendChild(this.$refs.contentWrapper);\n                this.$nextTick(() => {\n                    this.editor.resize();\n                });\n            },\n            /**\n             * @desc esc快捷键退出编辑的全屏状态\n             */\n            handleExitByESC (event) {\n                if (event.code !== 'Escape' || !this.isFullScreen) {\n                    return;\n                }\n                this.handleExitFullScreen();\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .jd-ace-editor {\n        position: relative;\n        display: flex;\n        flex-direction: column;\n        width: 100%;\n        /* stylelint-disable selector-class-pattern */\n        .ace_editor {\n            padding-right: 14px;\n            overflow: unset;\n            font-family: Menlo, Monaco, Consolas, Courier, monospace;\n\n            .ace_scrollbar-v,\n            .ace_scrollbar-h {\n                &::-webkit-scrollbar-thumb {\n                    background-color: #3b3c42;\n                    border: 1px solid #63656e;\n                }\n\n                &::-webkit-scrollbar-corner {\n                    background-color: transparent;\n                }\n            }\n\n            .ace_scrollbar-v {\n                &::-webkit-scrollbar {\n                    width: 14px;\n                }\n            }\n\n            .ace_scrollbar-h {\n                &::-webkit-scrollbar {\n                    height: 14px;\n                }\n            }\n\n            .ace_gutter-cell {\n                &.ace_info,\n                &.ace_warning,\n                &.ace_error {\n                    background-size: 12px;\n                    background-position-x: 4px;\n                }\n\n                &.ace_info {\n                    background-image: url(\"/static/images/ace-editor/info.png\");\n                }\n\n                &.ace_warning {\n                    background-image: url(\"/static/images/ace-editor/warning.png\");\n                }\n\n                &.ace_error {\n                    background-image: url(\"/static/images/ace-editor/error.png\");\n                }\n            }\n        }\n\n        .readonly {\n            filter: grayscale(0%) brightness(80%) saturate(70%) opacity(95%);\n\n            .jb-ace-mode-item {\n                cursor: default;\n            }\n        }\n    }\n\n    .jb-ace-title {\n        display: flex;\n        font-size: 14px;\n        color: #fff;\n        background: #202024;\n        box-shadow: 0 2px 4px 0 \"rgba(0, 0, 0, 16%)\";\n\n        .jb-ace-mode-item {\n            display: flex;\n            padding: 0 22px;\n            color: #979ba5;\n            cursor: pointer;\n            border-top: 2px solid transparent;\n            user-select: none;\n            align-items: center;\n\n            &.active {\n                color: #fff;\n                background: #313238;\n                border-top: 2px solid #3a84ff;\n            }\n        }\n    }\n\n    .jb-ace-main {\n        display: flex;\n        background: #272822;\n\n        .ace-edit-content {\n            flex: 1;\n            overflow: hidden;\n        }\n\n        .bk-loading {\n            background: \"rgba(0, 0, 0, 80%)\" !important;\n        }\n    }\n\n    .jb-ace-action {\n        position: absolute;\n        top: 0;\n        right: 0;\n        z-index: 1;\n        display: flex;\n        align-items: center;\n        padding-right: 9px;\n        font-size: 16px;\n        line-height: 1;\n        color: #c4c6cc;\n\n        .job-icon {\n            padding: 10px 9px;\n            cursor: pointer;\n        }\n    }\n\n    .jb-ace-history-panel {\n        position: absolute;\n        top: 40px;\n        right: 10px;\n        width: 350px;\n        background: #fff;\n        border-radius: 2px;\n        user-select: none;\n\n        &::before {\n            position: absolute;\n            top: -4px;\n            right: 45px;\n            width: 10px;\n            height: 10px;\n            background: inherit;\n            content: \"\";\n            transform: rotateZ(-45deg);\n        }\n\n        .panel-header {\n            display: flex;\n            align-items: center;\n            height: 60px;\n            padding: 0 20px;\n            font-size: 14px;\n            color: #313238;\n            border-bottom: 1px solid #e7e7e7;\n\n            .save-btn {\n                display: flex;\n                width: 86px;\n                height: 32px;\n                margin-left: auto;\n                color: #63656e;\n                cursor: pointer;\n                background: #fff;\n                border: 1px solid #c4c6cc;\n                border-radius: 2px;\n                align-items: center;\n                justify-content: center;\n            }\n        }\n\n        .panel-body {\n            padding: 10px 20px;\n            font-family: 'MicrosoftYaHei'; /* stylelint-disable-line */\n            font-size: 12px;\n            color: #4f5050;\n            background: #fafbfd;\n\n            .item {\n                display: flex;\n                height: 32px;\n                align-items: center;\n            }\n\n            .history-name {\n                width: 255px;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n\n            .history-action {\n                margin-left: auto;\n                color: #3a84ff;\n                cursor: pointer;\n            }\n        }\n\n        .history-empty {\n            padding-top: 44px;\n            padding-bottom: 85px;\n        }\n    }\n</style>\n","<template>\n    <div ref=\"layout\" class=\"script-version-manage-layout\">\n        <div class=\"layout-header\">\n            <div class=\"header-title\">\n                <slot name=\"title\" />\n            </div>\n            <div class=\"sub-header\">\n                <slot name=\"sub-header\" />\n            </div>\n        </div>\n        <div\n            ref=\"content\"\n            class=\"layout-container\"\n            :style=\"contentStyles\">\n            <resizeable-box\n                v-if=\"$slots.left\"\n                class=\"left\"\n                free-position=\"right\">\n                <slot name=\"left\" />\n            </resizeable-box>\n            <div class=\"right\">\n                <slot />\n            </div>\n        </div>\n        <div class=\"layout-footer\">\n            <slot name=\"footer\" />\n        </div>\n    </div>\n</template>\n<script>\n    import { getOffset } from '@utils/assist';\n\n    const PAGE_PADDING_BOTTOM = 20;\n\n    export default {\n        name: '',\n        data () {\n            return {\n                showContent: !this.loading,\n                offsetLeft: 0,\n                contentOffsetTop: 0,\n                footerHeight: 46,\n            };\n        },\n        computed: {\n            contentStyles () {\n                const offset = this.contentOffsetTop + PAGE_PADDING_BOTTOM + this.footerHeight;\n                return {\n                    height: `calc(100vh - ${offset}px)`,\n                };\n            },\n        },\n        mounted () {\n            this.contentOffsetTop = getOffset(this.$refs.content).top;\n        },\n    };\n</script>\n<style lang='postcss'>\n    .script-version-manage-layout {\n        position: relative;\n        height: 100vh;\n        overflow: hidden;\n        background: #292929;\n\n        .layout-header {\n            display: flex;\n            align-items: center;\n            height: 40px;\n            padding-left: 16px;\n            font-size: 14px;\n            color: #c4c6cc;\n            background: #333;\n            box-shadow: 0 2px 4px 0 rgb(0 0 0 / 16%);\n\n            .sub-header {\n                display: flex;\n                height: 100%;\n                padding-right: 40px;\n                margin-left: auto;\n                font-size: 16px;\n                align-items: center;\n\n                i {\n                    padding: 10px 9px;\n                    cursor: pointer;\n                }\n            }\n        }\n\n        .layout-container {\n            position: relative;\n            z-index: 0;\n            display: flex;\n\n            .left {\n                position: relative;\n                width: 312px;\n                padding: 12px 16px;\n                background: #292929;\n\n                .line {\n                    position: absolute;\n                    top: 0;\n                    right: 0;\n                    bottom: 0;\n                }\n            }\n\n            .right {\n                flex: 1;\n            }\n        }\n\n        .layout-footer {\n            position: relative;\n            z-index: 2;\n            display: flex;\n            height: 46px;\n            padding: 0 16px;\n            background: #242424;\n            align-items: center;\n            border-top: 1px solid #141414;\n            box-shadow: 0 -2px 4px 0 rgb(0 0 0 / 16%);\n        }\n\n        .bk-label {\n            height: 16px;\n            min-height: 16px;\n            margin-bottom: 8px;\n            font-size: 12px;\n            line-height: 16px;\n            color: #c4c6cc;\n\n            .bk-label-text {\n                line-height: 16px;\n            }\n        }\n\n        .bk-form-input,\n        .bk-form-textarea {\n            font-size: 12px;\n            color: #c4c6cc !important;\n            background: #292929 !important;\n            border-color: #63656e !important;\n\n            &[readonly] {\n                background: #333 !important;\n                border-color: #424242 !important;\n            }\n\n            &::placeholder {\n                color: #63656e;\n            }\n        }\n\n        .bk-button {\n            &.bk-default {\n                color: #979ba5;\n                background: transparent;\n                border-color: #5c5e66;\n                transition: all 0.15s;\n\n                &:hover {\n                    color: #b1b6c2;\n                    border-color: #878b94;\n                }\n\n                &.is-disabled {\n                    color: #63656e;\n                    border-color: #36373d;\n                }\n            }\n        }\n        /* stylelint-disable selector-class-pattern */\n        .jd-ace-editor {\n            .ace_editor {\n                background: #1a1a1a;\n\n                .ace_gutter {\n                    background: #1a1a1a;\n                }\n            }\n\n            .jb-ace-action {\n                display: none;\n            }\n\n            .jb-ace-history-panel {\n                top: 0;\n                right: 42px;\n            }\n        }\n\n        .bk-loading {\n            background: rgb(0 0 0 / 80%) !important;\n        }\n\n        span[data-script-status] {\n            color: #c4c6cc !important;\n            background: #63656e !important;\n        }\n\n        span[data-script-status=\"1\"] {\n            color: #59b383 !important;\n            background: #1f4d29 !important;\n        }\n    }\n</style>\n","<template>\n    <layout class=\"script-manage-detail-box\">\n        <div slot=\"title\">\n            <span>{{ scriptInfo.version }}</span>\n            <span class=\"script-status\" v-html=\"scriptInfo.statusHtml\" />\n        </div>\n        <template slot=\"sub-header\">\n            <span style=\"font-size: 12px; color: #63656e;\">\n                <span>{{ scriptInfo.lastModifyUser }}</span>\n                <span>|</span>\n                <span>{{ scriptInfo.lastModifyTime }}</span>\n            </span>\n            <Icon\n                v-if=\"contentTab === 'content'\"\n                type=\"full-screen\"\n                v-bk-tooltips=\"'全屏'\"\n                @click=\"handleFullScreen\"\n                v-test=\"{ type: 'button', value: 'scriptEditFullscreen' }\" />\n        </template>\n        <div class=\"content-tab\">\n            <div\n                class=\"content-tab-item\"\n                :class=\"{ active: contentTab === 'content' }\"\n                @click=\"handleChangeDispaly('content')\"\n                v-test=\"{ type: 'button', value: 'scriptContentTab' }\">\n                {{ '脚本内容' }}\n            </div>\n            <div\n                class=\"content-tab-item\"\n                :class=\"{ active: contentTab === 'log' }\"\n                @click=\"handleChangeDispaly('log')\"\n                v-test=\"{ type: 'button', value: 'scriptVersionLogTab' }\">\n                {{ '版本日志' }}\n            </div>\n        </div>\n        <div class=\"version-content\">\n            <div ref=\"content\" class=\"content-dispaly\" :style=\"contentStyles\">\n                <keep-alive v-if=\"contentHeight > 0\">\n                    <component\n                        ref=\"aceEditor\"\n                        :is=\"contentCom\"\n                        readonly\n                        :height=\"contentHeight\"\n                        :value=\"scriptInfo.content\"\n                        :lang=\"scriptInfo.typeName\"\n                        :options=\"scriptInfo.typeName\"\n                        :version-desc=\"scriptInfo.versionDesc\" />\n                </keep-alive>\n            </div>\n        </div>\n        <template #footer>\n            <auth-button\n                v-if=\"scriptInfo.isOnline\"\n                key=\"execute\"\n                :permission=\"scriptInfo.canManage\"\n                auth=\"script/execute\"\n                :resource-id=\"scriptInfo.id\"\n                class=\"w120 mr10\"\n                theme=\"primary\"\n                :loading=\"isExceLoading\"\n                @click=\"handleGoExce\"\n                v-test=\"{ type: 'button', value: 'execScript' }\">\n                {{ '去执行' }}\n            </auth-button>\n            <jb-popover-confirm\n                v-if=\"!scriptInfo.isOnline\"\n                key=\"online\"\n                class=\"mr10\"\n                :title=\"'确定上线该版本？'\"\n                :content=\"'上线后，之前的线上版本将被置为「已下线」状态，但不影响作业使用'\"\n                \n                :confirm-handler=\"handleOnline\">\n                <auth-button\n                    :permission=\"scriptInfo.canManage\"\n                    :resource-id=\"scriptInfo.id\"\n                    auth=\"script/edit\"\n                    theme=\"primary\"\n                    class=\"w120\"\n                    \n                    v-test=\"{ type: 'button', value: 'onlineScript' }\">\n                    {{ '上线' }}\n                </auth-button>\n            </jb-popover-confirm>\n            <span\n                v-if=\"!scriptInfo.isDraft\"\n                key=\"create\"\n                :tippy-tips=\"isCopyCreateDisabled ? '已有[未上线]版本' : ''\">\n                <auth-button\n                    :permission=\"scriptInfo.canClone\"\n                    :resource-id=\"scriptInfo.id\"\n                    auth=\"script/clone\"\n                    \n                    class=\"w120 mr10\"\n                    @click=\"handleCopyAndCreate(scriptInfo)\"\n                    v-test=\"{ type: 'button', value: 'copyCreateScript' }\">\n                    {{ '复制并新建' }}\n                </auth-button>\n            </span>\n            <bk-button\n                class=\"mr10\"\n                @click=\"handleDebugScript\"\n                v-test=\"{ type: 'button', value: 'debugScript' }\">\n                {{ '调试' }}\n            </bk-button>\n            <span\n                v-if=\"scriptInfo.isOnline\"\n                key=\"sync\"\n                class=\"mr10\"\n                :tippy-tips=\"!scriptInfo.syncEnabled ? '所有关联作业模板已是当前版本' : ''\">\n                <auth-button\n                    :permission=\"scriptInfo.canManage\"\n                    :resource-id=\"scriptInfo.id\"\n                    auth=\"script/edit\"\n                    \n                    @click=\"handleGoSync\"\n                    v-test=\"{ type: 'button', value: 'syncScript' }\">\n                    {{ '同步' }}\n                </auth-button>\n            </span>\n            <auth-button\n                v-if=\"scriptInfo.isDraft\"\n                key=\"edit\"\n                :permission=\"scriptInfo.canManage\"\n                :resource-id=\"scriptInfo.id\"\n                auth=\"script/edit\"\n                class=\"mr10\"\n                @click=\"handleEdit(scriptInfo)\"\n                v-test=\"{ type: 'button', value: 'editScript' }\">\n                {{ '编辑' }}\n            </auth-button>\n            <jb-popover-confirm\n                v-if=\"scriptInfo.isVersionEnableRemove\"\n                key=\"delete\"\n                class=\"mr10\"\n                :title=\"'确定删除该版本？'\"\n                :content=\"'删除后不可恢复，请谨慎操作！'\"\n                :confirm-handler=\"handleRemove\">\n                <auth-button\n                    :permission=\"scriptInfo.canManage\"\n                    :resource-id=\"scriptInfo.id\"\n                    auth=\"script/delete\"\n                    v-test=\"{ type: 'button', value: 'deleteScript' }\">\n                    {{ '删除' }}\n                </auth-button>\n            </jb-popover-confirm>\n            <jb-popover-confirm\n                v-if=\"scriptInfo.isOnline\"\n                key=\"offline\"\n                style=\"margin-left: auto;\"\n                :title=\"'确定禁用该版本？'\"\n                :content=\"'一旦禁用成功，线上引用该版本的作业脚本步骤都会执行失败，请务必谨慎操作！'\"\n                :confirm-handler=\"handleOffline\">\n                <auth-button\n                    :permission=\"scriptInfo.canManage\"\n                    :resource-id=\"scriptInfo.id\"\n                    auth=\"script/edit\"\n                    v-test=\"{ type: 'button', value: 'offlineScript' }\">\n                    {{ '禁用' }}\n                </auth-button>\n            </jb-popover-confirm>\n        </template>\n    </layout>\n</template>\n<script>\n    import _ from 'lodash';\n       import ScriptService from '@service/script-manage';\n    import PublicScriptService from '@service/public-script-manage';\n    import {\n        checkPublicScript,\n        getOffset,\n    } from '@utils/assist';\n    import { debugScriptCache } from '@utils/cache-helper';\n    import AceEditor from '@components/ace-editor';\n    import DetailLayout from '@components/detail-layout';\n    import DetailItem from '@components/detail-layout/item';\n    import JbPopoverConfirm from '@components/jb-popover-confirm';\n    import Layout from '../components/layout';\n    import RenderLog from './components/render-log';\n\n    export default {\n        name: '',\n        components: {\n            AceEditor,\n            DetailLayout,\n            DetailItem,\n            JbPopoverConfirm,\n            Layout,\n            RenderLog,\n        },\n        inheritAttrs: false,\n        props: {\n            scriptVersionList: {\n                type: Array,\n                default: () => [],\n            },\n            scriptInfo: {\n                type: Object,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                isLoading: false,\n                isExceLoading: false,\n                contentTab: 'content',\n                contentHeight: 0,\n            };\n        },\n        computed: {\n            contentCom () {\n                const comMap = {\n                    content: AceEditor,\n                    log: RenderLog,\n                };\n                return comMap[this.contentTab];\n            },\n            /**\n             * @desc 已存在未上线版本不允许新建版本\n             * @returns { Boolean }\n             */\n            isCopyCreateDisabled () {\n                return !!_.find(this.scriptVersionList, scriptVersion => scriptVersion.isDraft);\n            },\n            contentStyles () {\n                return {\n                    height: `${this.contentHeight}px`,\n                };\n            },\n        },\n        watch: {\n            scriptInfo () {\n                this.contentTab = 'content';\n            },\n        },\n        created () {\n            this.publicScript = checkPublicScript(this.$route);\n            this.serviceHandler = this.publicScript ? PublicScriptService : ScriptService;\n            window.addEventListener('resize', this.init);\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('resize', this.init);\n            });\n        },\n        mounted () {\n            this.calcContentHeight();\n            const handleResize = _.throttle(this.calcContentHeight, 60);\n            window.addEventListener('resize', handleResize);\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('resize', handleResize);\n            });\n        },\n        methods: {\n            /**\n             * @desc 计算内容区高度\n             */\n            calcContentHeight () {\n                const contentOffsetTop = getOffset(this.$refs.content).top;\n                this.contentHeight = window.innerHeight - contentOffsetTop - 20;\n            },\n            handleFullScreen () {\n                if (this.contentTab === 'content') {\n                    this.$refs.aceEditor.handleFullScreen();\n                }\n            },\n            /**\n             * @desc 脚本内容和脚本版本日志切换\n             * @param {String} tab 切换面板\n             */\n            handleChangeDispaly (tab) {\n                this.contentTab = tab;\n            },\n            /**\n             * @desc 上线脚本\n             */\n            handleOnline () {\n                return this.serviceHandler.scriptVersionOnline({\n                    id: this.scriptInfo.id,\n                    versionId: this.scriptInfo.scriptVersionId,\n                }).then(() => {\n                    this.messageSuccess('操作成功');\n                    this.$emit('on-edit-change');\n                });\n            },\n            /**\n             * @desc 删除脚本\n             */\n            handleRemove () {\n                return this.serviceHandler.scriptVersionRemove({\n                    versionId: this.scriptInfo.scriptVersionId,\n                }).then(() => {\n                    this.messageSuccess('删除成功');\n                    // 如果删除的是最后一个版本，成功后跳转到脚本列表\n                    if (this.scriptVersionList.length < 2) {\n                        const routerName = this.publicScript ? 'publicScriptList' : 'scriptList';\n                        this.$router.push({\n                            name: routerName,\n                        });\n                    } else {\n                        setTimeout(() => {\n                            this.$emit('on-delete', true);\n                        });\n                    }\n                });\n            },\n            /**\n             * @desc 下线脚本\n             */\n            handleOffline () {\n                return this.serviceHandler.scriptVersionOffline({\n                    id: this.scriptInfo.id,\n                    versionId: this.scriptInfo.scriptVersionId,\n                }).then(() => {\n                    this.messageSuccess('操作成功');\n                    this.$emit('on-edit-change');\n                });\n            },\n            /**\n             * @desc 复制新建\n             */\n            handleCopyAndCreate () {\n                this.$emit('on-go-copy-create', {\n                    scriptVersionId: this.scriptInfo.scriptVersionId,\n                });\n            },\n            /**\n             * @desc 调整到快速执行脚本页面调试脚本\n             */\n            handleDebugScript () {\n                debugScriptCache.setItem(this.scriptInfo.content);\n                const { href } = this.$router.resolve({\n                    name: 'fastExecuteScript',\n                    query: {\n                        model: 'debugScript',\n                    },\n                });\n                window.open(href);\n            },\n            /**\n             * @desc 同步脚本\n             */\n            handleGoSync () {\n                const routerName = this.publicScript ? 'scriptPublicSync' : 'scriptSync';\n                this.$router.push({\n                    name: routerName,\n                    params: {\n                        scriptId: this.scriptInfo.id,\n                        scriptVersionId: this.scriptInfo.scriptVersionId,\n                    },\n                });\n            },\n            /**\n             * @desc 编辑脚本\n             */\n            handleEdit (payload) {\n                this.$emit('on-go-edit', {\n                    scriptVersionId: this.scriptInfo.scriptVersionId,\n                });\n            },\n            /**\n             * @desc 调整到快速执行脚本页面执行脚本\n             */\n            handleGoExce () {\n                this.$router.push({\n                    name: 'fastExecuteScript',\n                    params: {\n                        taskInstanceId: 0,\n                        scriptVersionId: this.scriptInfo.scriptVersionId,\n                    },\n                    query: {\n                        from: 'scriptVersion',\n                    },\n                });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    @import \"@/css/mixins/scroll\";\n\n    %tab-item {\n        display: flex;\n        width: 94px;\n        height: 35px;\n        font-size: 13px;\n        color: #979ba5;\n        align-items: center;\n    }\n\n    .script-manage-detail-box {\n        .content-tab {\n            position: absolute;\n            left: 50%;\n            z-index: 0;\n            display: flex;\n            width: 250px;\n            margin-top: -35px;\n            transform: translateX(-50%);\n            align-content: center;\n            justify-content: center;\n\n            .content-tab-item {\n                @extend %tab-item;\n\n                padding-left: 0;\n                cursor: pointer;\n                transition: all 0.1s;\n                flex: 0 0 120px;\n                align-items: center;\n                justify-content: center;\n\n                &.active {\n                    color: #dcdee5;\n                    background: #242424;\n                    border-top-right-radius: 6px;\n                    border-top-left-radius: 6px;\n                }\n            }\n        }\n\n        .version-content {\n            display: flex;\n            flex-direction: column;\n            flex: 1;\n        }\n\n        .render-version-log {\n            height: 100%;\n            padding: 12px 10px;\n            overflow-y: auto;\n            font-size: 12px;\n            line-height: 20px;\n            color: #63656e;\n            white-space: pre-line;\n\n            @mixin scroller;\n        }\n    }\n</style>\n","<template>\n    <jb-form-item :label=\"'脚本参数'\">\n        <div class=\"muti-item\">\n            <jb-input\n                :placeholder=\"'脚本执行时传入的参数，同脚本在终端执行时的传参格式，如：./test.sh xxxx xxx xxx'\"\n                @change=\"handleParamChange\"\n                :type=\"paramType\"\n                :value=\"formData[paramField]\"\n                :maxlength=\"5000\" />\n            <bk-checkbox\n                class=\"muti-checkbox\"\n                :value=\"formData[secureField]\"\n                :true-value=\"1\"\n                :false-value=\"0\"\n                @change=\"handleSecureParam\">\n                {{ '敏感参数' }}\n            </bk-checkbox>\n        </div>\n    </jb-form-item>\n</template>\n<script>\n    import JbInput from '@components/jb-input';\n\n    export default {\n        components: {\n            JbInput,\n        },\n        props: {\n            paramField: {\n                type: String,\n                required: true,\n            },\n            secureField: {\n                type: String,\n                required: true,\n            },\n            formData: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        computed: {\n            paramType () {\n                return this.formData[this.secureField] ? 'password' : 'text';\n            },\n        },\n        methods: {\n            handleParamChange (value) {\n                this.$emit('on-change', this.paramField, value);\n            },\n            handleSecureParam (value) {\n                this.$emit('on-change', this.secureField, value);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .muti-item {\n        display: flex;\n        width: 100%;\n\n        .jb-input {\n            flex: 1;\n        }\n\n        .muti-checkbox {\n            display: flex;\n            align-items: center;\n            flex: 0 0 auto;\n            margin-left: 10px;\n        }\n    }\n</style>\n","<template>\n    <div>\n        <jb-form ref=\"form\" :model=\"formData\" :rules=\"rules\" fixed :label-width=\"110\">\n            <item-factory\n                name=\"stepName\"\n                field=\"name\"\n                :placeholder=\"'推荐按步骤实际处理的场景行为来取名...'\"\n                :form-data=\"formData\"\n                @on-change=\"handleNameChange\" />\n            <jb-form-item :label=\"'确认人'\" :required=\"true\" property=\"approvalUser\">\n                <jb-user-selector\n                    :placeholder=\"'输入确认人'\"\n                    class=\"input\"\n                    :user=\"formData.approvalUser.userList\"\n                    :role=\"formData.approvalUser.roleList\"\n                    :filter-list=\"['JOB_EXTRA_OBSERVER']\"\n                    @on-change=\"handleApprovalUserChange\" />\n            </jb-form-item>\n            <jb-form-item :label=\"'通知方式'\">\n                <div class=\"notify-channel-wraper\">\n                    <bk-checkbox\n                        @click.native=\"handleToggleAllChannel\"\n                        :checked=\"isChannelAll\"\n                        :indeterminate=\"isChannelIndeterminate\">\n                        {{ '全部' }}\n                    </bk-checkbox>\n                    <bk-checkbox-group v-model=\"formData.notifyChannel\" class=\"all-channel\">\n                        <bk-checkbox\n                            v-for=\"channel in channleList\"\n                            :key=\"channel.code\"\n                            :value=\"channel.code\">\n                            {{ channel.name }}\n                        </bk-checkbox>\n                    </bk-checkbox-group>\n                </div>\n            </jb-form-item>\n            <jb-form-item :label=\"'确认描述'\">\n                <bk-input class=\"input\" type=\"textarea\" v-model=\"formData.approvalMessage\" :maxlength=\"1000\" />\n            </jb-form-item>\n        </jb-form>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import QueryGlobalSettingService from '@service/query-global-setting';\n    import JbUserSelector from '@components/jb-user-selector';\n    import ItemFactory from '@components/task-step/file/item-factory';\n    import { genDefaultName } from '@utils/assist';\n\n    const getDefaultData = () => ({\n        id: 0,\n        // 步骤名称\n        name: genDefaultName('步骤人工确认'),\n        // 删除标记\n        delete: 0,\n        // 审批消息\n        approvalMessage: '',\n        // 审批类型 暂未启用 1-任意人审批 2-所有人审批\n        approvalType: 1,\n        // 审批人\n        approvalUser: {\n            roleList: [\n                'JOB_RESOURCE_TRIGGER_USER',\n            ],\n            userList: [{},{},{}],\n        },\n        notifyChannel: [],\n    });\n    export default {\n        name: '',\n        components: {\n            JbUserSelector,\n            ItemFactory,\n        },\n        inheritAttrs: false,\n        props: {\n            data: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                formData: getDefaultData(),\n                channleList: [{},{},{}],\n            };\n        },\n        computed: {\n            isChannelAll () {\n                if (this.channleList.length < 1) {\n                    return false;\n                }\n                return this.formData.notifyChannel.length === this.channleList.length;\n            },\n            isChannelIndeterminate () {\n                if (this.formData.notifyChannel.length < 1) {\n                    return false;\n                }\n                return this.formData.notifyChannel.length !== this.channleList.length;\n            },\n        },\n        watch: {\n            data: {\n                handler (newData) {\n                    if (_.isEmpty(newData)) {\n                        return;\n                    }\n                    this.formData = {\n                        ...this.formData,\n                        ...newData,\n                    };\n                    setTimeout(() => {\n                        this.$refs.form.validate();\n                    });\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.rules = {\n                approvalUser: [\n                    {\n                        validator: approvalUser => approvalUser.roleList.length + approvalUser.userList.length > 0,\n                        message: '确认人必填',\n                        trigger: 'blur',\n                    },\n                ],\n            };\n            this.fetchAllChannel();\n        },\n        methods: {\n            fetchAllChannel () {\n                QueryGlobalSettingService.fetchActiveNotifyChannel()\n                    .then((data) => {\n                        this.channleList = data;\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            handleToggleAllChannel () {\n                if (this.isChannelAll) {\n                    this.formData.notifyChannel = [];\n                } else {\n                    this.formData.notifyChannel = this.channleList.map(_ => _.code);\n                }\n            },\n            handleNameChange (field, name) {\n                this.formData[field] = name.trim();\n            },\n            \n            handleApprovalUserChange (user, role) {\n                this.formData.approvalUser.roleList = role;\n                this.formData.approvalUser.userList = user;\n            },\n            submit () {\n                const {\n                    name,\n                    id,\n                    approvalMessage,\n                    approvalType,\n                    approvalUser,\n                    notifyChannel,\n                } = this.formData;\n\n                const result = {\n                    id,\n                    name,\n                    delete: this.formData.delete,\n                    type: 3,\n                    approvalStepInfo: {\n                        approvalMessage,\n                        approvalType,\n                        approvalUser,\n                        notifyChannel,\n                    },\n                };\n\n                return this.$refs.form.validate()\n                    .then(() => {\n                        this.$emit('on-change', result, true);\n                    }, () => {\n                        this.$emit('on-change', result, false);\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .notify-channel-wraper {\n        display: flex;\n        align-items: center;\n        height: 32px;\n        white-space: nowrap;\n\n        .bk-form-checkbox {\n            display: flex;\n            flex: 0 0 auto;\n            margin-right: 40px;\n        }\n\n        .all-channel {\n            display: flex;\n        }\n    }\n\n    .input {\n        width: 495px;\n    }\n</style>\n","<template>\n    <div class=\"task-step-operation-wraper\">\n        <div class=\"left\" :style=\"leftStyles\">\n            <scroll-faker>\n                <div class=\"container\">\n                    <jb-form fixed :label-width=\"formMarginLeftWidth\">\n                        <bk-form-item :label=\"'步骤类型'\" required>\n                            <bk-select\n                                v-model=\"taskStepType\"\n                                :clearable=\"false\"\n                                \n                                class=\"form-item-content\">\n                                <bk-option id=\"1\" :name=\"'执行脚本'\" />\n                                <bk-option id=\"2\" :name=\"'分发文件'\" />\n                                <bk-option id=\"3\" :name=\"'人工确认'\" />\n                            </bk-select>\n                        </bk-form-item>\n                    </jb-form>\n                    <component\n                        ref=\"handler\"\n                        :is=\"stepCom\"\n                        :data=\"stepData\"\n                        v-bind=\"$attrs\"\n                        v-on=\"$listeners\" />\n                </div>\n            </scroll-faker>\n            <bk-button\n                text\n                class=\"variable-guide-btn\"\n                @click=\"handleShowVariableGuide\">\n                <Icon type=\"book\" />\n                {{ '变量使用指引' }}\n            </bk-button>\n        </div>\n        <div v-if=\"isShowVariableGuide\" class=\"right\">\n            <variable-use-guide @on-close=\"handleHideVariableGuide\" />\n        </div>\n    </div>\n</template>\n<script>\n    import VariableUseGuide from '@/views/task-manage/common/variable-use-guide';\n    import StepDistroFile from './components/distro-file';\n    import StepExecScript from './components/exec-script';\n    import StepArificial from './components/artificial';\n\n    export default {\n        components: {\n            StepDistroFile,\n            StepExecScript,\n            StepArificial,\n            VariableUseGuide,\n        },\n        inheritAttrs: false,\n        props: {\n            data: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                taskStepType: '',\n                isShowVariableGuide: false,\n            };\n        },\n        computed: {\n            /**\n             * @desc 步骤渲染组件\n             * @returns { Object }\n             */\n            stepCom () {\n                const taskStepMap = {\n                    1: StepExecScript,\n                    2: StepDistroFile,\n                    3: StepArificial,\n                };\n                if (!Object.prototype.hasOwnProperty.call(taskStepMap, this.taskStepType)) {\n                    return 'div';\n                }\n                return taskStepMap[this.taskStepType];\n            },\n            /**\n             * @desc 步骤数据\n             * @returns { Object }\n             */\n            stepData () {\n                const stepDataMap = {\n                    1: 'scriptStepInfo',\n                    2: 'fileStepInfo',\n                    3: 'approvalStepInfo',\n                };\n                const currentKey = stepDataMap[this.taskStepType];\n                if (!Object.prototype.hasOwnProperty.call(this.data, currentKey)\n                    || !Object.keys(this.data[currentKey]).length) {\n                    return {};\n                }\n                const { name, id } = this.data;\n                return {\n                    name,\n                    id,\n                    ...this.data[currentKey],\n                };\n            },\n            /**\n             * @desc 步骤类型不可编辑\n             * @returns { Boolean }\n             */\n            isStepTypeReadOnly () {\n                return !!Object.keys(this.data).length;\n            },\n            leftStyles () {\n                const styles = {\n                    width: '100%',\n                };\n                if (this.isShowVariableGuide) {\n                    styles.width = 'calc(100% - 366px)';\n                }\n                return styles;\n            },\n            formMarginLeftWidth () {\n                return 'zh-CN' === 'en-US' && this.taskStepType === 2 ? 140 : 110;\n            },\n        },\n        watch: {\n            data: {\n                handler (value) {\n                    if (Object.keys(value).length) {\n                        this.taskStepType = this.data.type;\n                        return;\n                    }\n                    this.taskStepType = 1;\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.originWraperWidth = 0;\n        },\n        mounted () {\n            const $targetSideslider = document.querySelector('#taskStepOperationSideslider');\n            $targetSideslider.querySelector('.jb-sideslider-footer').style.paddingLeft = `${this.formMarginLeftWidth + 30}px`;\n        },\n        methods: {\n            handleShowVariableGuide () {\n                if (this.isShowVariableGuide) {\n                    return;\n                }\n                const $targetSideslider = document.querySelector('#taskStepOperationSideslider');\n                const $wraper = $targetSideslider.querySelector('.bk-sideslider-wrapper');\n                $wraper.style.transition = 'width 0.1s';\n                setTimeout(() => {\n                    const {\n                        width,\n                    } = $wraper.getBoundingClientRect();\n                    this.originWraperWidth = width;\n                    $wraper.style.width = `${width + 366}px`;\n                    this.isShowVariableGuide = true;\n                });\n            },\n            handleHideVariableGuide () {\n                const $targetSideslider = document.querySelector('#taskStepOperationSideslider');\n                const $wraper = $targetSideslider.querySelector('.bk-sideslider-wrapper');\n                $wraper.style.width = `${this.originWraperWidth}px`;\n                this.isShowVariableGuide = false;\n            },\n            submit () {\n                return this.$refs.handler.submit && this.$refs.handler.submit();\n            },\n            reset () {\n                this.taskStepType = '';\n                return this.$refs.handler.reset && this.$refs.handler.reset();\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .task-step-operation-wraper {\n        max-height: calc(100vh - 155px);\n        margin-right: -30px;\n\n        .left {\n            position: relative;\n            z-index: 0;\n\n            .container {\n                padding-right: 30px;\n            }\n\n            .form-item-content {\n                width: 495px;\n            }\n\n            .variable-guide-btn {\n                position: absolute;\n                top: -10px;\n                right: 30px;\n            }\n        }\n\n        .right {\n            position: absolute;\n            top: 0;\n            right: 0;\n            z-index: 0;\n            width: 366px;\n            height: calc(100% - 56px);\n        }\n    }\n</style>\n","<template>\n    <div class=\"render-file-server\">\n        <div class=\"server-agent-text\" v-html=\"data.serverDesc\" @click=\"handlerView\" />\n        <jb-dialog\n            v-model=\"isShowDetail\"\n            :width=\"1020\"\n            :ok-text=\"'关闭'\"\n            class=\"step-view-server-detail-dialog\">\n            <template #header>\n                <div class=\"variable-title\">\n                    <span>{{ '服务器文件-服务器列表' }}</span>\n                    <i class=\"server-detail-close bk-icon icon-close\" @click=\"handleClose\" />\n                </div>\n            </template>\n            <div class=\"content-wraper\">\n                <scroll-faker>\n                    <server-panel\n                        detail-mode=\"dialog\"\n                        :host-node-info=\"hostNodeInfo\" />\n                </scroll-faker>\n            </div>\n        </jb-dialog>\n    </div>\n</template>\n<script>\n    import TaskHostNodeModel from '@model/task-host-node';\n    import ScrollFaker from '@components/scroll-faker';\n    import ServerPanel from '@components/choose-ip/server-panel';\n\n    export default {\n        name: '',\n        components: {\n            ScrollFaker,\n            ServerPanel,\n        },\n        props: {\n            data: {\n                type: Object,\n                required: true,\n            },\n        },\n        data () {\n            const { hostNodeInfo } = new TaskHostNodeModel({});\n            return {\n                isShowDetail: false,\n                hostNodeInfo,\n            };\n        },\n\n        methods: {\n            handlerView () {\n                this.hostNodeInfo = this.data.host.hostNodeInfo;\n                this.isShowDetail = true;\n            },\n            handleClose () {\n                this.isShowDetail = false;\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .render-file-server {\n        min-height: 30px;\n        padding: 5px;\n        margin-left: -10px;\n        cursor: pointer;\n\n        &:hover {\n            background: #f0f1f5;\n        }\n\n        .server-agent-text {\n            white-space: pre;\n\n            .sep-location {\n                &::before {\n                    content: \"\";\n                }\n            }\n        }\n    }\n\n    .step-view-server-detail-dialog {\n        .bk-dialog-tool {\n            display: none;\n        }\n\n        .bk-dialog-header,\n        .bk-dialog-footer {\n            position: relative;\n            z-index: 99999;\n            background: #fff;\n        }\n\n        .bk-dialog-header {\n            padding: 0;\n        }\n\n        .bk-dialog-wrapper .bk-dialog-header .bk-dialog-header-inner {\n            font-size: 20px;\n            color: #000;\n            text-align: left;\n        }\n\n        .bk-dialog-wrapper .bk-dialog-body {\n            padding: 0;\n\n            .server-panel {\n                height: 100%;\n\n                &.show-detail {\n                    overflow: hidden;\n                }\n\n                .host-detail.show {\n                    padding-left: 20%;\n                }\n            }\n        }\n\n        .content-wraper {\n            height: 450px;\n            max-height: 450px;\n            min-height: 450px;\n            margin-top: -1px;\n        }\n\n        button[name=\"cancel\"] {\n            display: none;\n        }\n\n        .variable-title {\n            position: relative;\n            height: 68px;\n            padding-top: 0;\n            padding-bottom: 0;\n            padding-left: 25px;\n            font-size: 20px;\n            line-height: 68px;\n            color: #000;\n            text-align: left;\n            border-bottom: 1px solid #dcdee5;\n        }\n\n        .server-detail-close {\n            position: absolute;\n            top: 0;\n            right: 0;\n            font-size: 32px;\n            color: #c4c6cc;\n            cursor: pointer;\n            transition: all 0.15s;\n\n            &:hover {\n                transform: rotateZ(90deg);\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"render-server-file\">\n        <bk-collapse\n            v-if=\"isShowLocalFile || isShowServerFile || isShowSourceFile\"\n            class=\"host-detail\"\n            v-model=\"activeResult\">\n            <jb-collapse-item\n                v-if=\"isShowLocalFile\"\n                name=\"local\"\n                :active=\"activeResult\">\n                <span class=\"collapse-title\">{{ '已选择' }}<span class=\"number strong\">{{ localFileList.length }}</span>{{ '个本地文件' }}</span>\n                <template #content>\n                    <table>\n                        <tbody>\n                            <tr v-for=\"(row, index) in localFileList\" :key=\"index\">\n                                <td style=\"width: 40%; word-break: break-all;\">{{ row.fileLocationText }}</td>\n                                <td>{{ row.fileSizeText }}</td>\n                            </tr>\n                        </tbody>\n                    </table>\n                </template>\n            </jb-collapse-item>\n            <jb-collapse-item\n                v-if=\"isShowSourceFile\"\n                name=\"source\"\n                :active=\"activeResult\">\n                <span class=\"collapse-title\">{{ '已选择' }}<span class=\"number strong\">{{ sourceFileList.length }}</span>{{ '个文件源文件' }}</span>\n                <template #content>\n                    <table>\n                        <thead>\n                            <th style=\"width: 40%;\">{{ '文件名称' }}</th>\n                            <th>{{ '文件源'}}</th>\n                        </thead>\n                        <tbody class=\"source-file-list\">\n                            <tr v-for=\"(row, index) in sourceFileList\" :key=\"index\">\n                                <td>\n                                    <render-file-path :data=\"row.fileLocation\" />\n                                </td>\n                                <td>\n                                    <span class=\"source-file-alias\" @click=\"handleGoSource(row, index)\">\n                                        {{ fileSourceAliasList[index] }}\n                                        <Icon type=\"edit\" class=\"source-file-icon\" svg />\n                                    </span>\n                                </td>\n                            </tr>\n                        </tbody>\n                    </table>\n                </template>\n            </jb-collapse-item>\n            <jb-collapse-item\n                v-if=\"isShowServerFile\"\n                name=\"server\"\n                :active=\"activeResult\">\n                <span class=\"collapse-title\">{{ '已选择' }}<span class=\"number strong\">{{ serverFileList.length }}</span>{{ '个服务器文件' }}</span>\n                <template #content>\n                    <table>\n                        <thead>\n                            <th style=\"width: 40%;\">{{ '文件路径' }}</th>\n                            <th style=\"width: 15%;\">{{ '服务器列表' }}</th>\n                            <th>{{ 'Agent 状态' }}</th>\n                            <th style=\"width: 20%;\">{{ '服务器账号' }}</th>\n                        </thead>\n                        <tbody>\n                            <tr v-for=\"(row, index) in serverFileList\" :key=\"index\">\n                                <td>\n                                    <render-file-path :data=\"row.fileLocation\" />\n                                </td>\n                                <template v-if=\"row.isVar\">\n                                    <td>\n                                        <render-global-variable\n                                            :name=\"row.serverDesc\"\n                                            :data=\"variable\" />\n                                    </td>\n                                    <td>\n                                        <render-server-agent\n                                            :title=\"`${'全局变量'} - ${row.host.variable}`\"\n                                            :host-node-info=\"findVariableValue(row.host.variable)\" />\n                                    </td>\n                                </template>\n                                <template v-else>\n                                    <td>\n                                        <render-file-server :data=\"row\" />\n                                    </td>\n                                    <td>\n                                        <render-server-agent\n                                            :title=\"'服务器文件-服务器列表'\"\n                                            :host-node-info=\"row.host.hostNodeInfo\" />\n                                    </td>\n                                </template>\n                                <td>{{ findAccountAlias(row.account) }}</td>\n                            </tr>\n                        </tbody>\n                    </table>\n                </template>\n            </jb-collapse-item>\n        </bk-collapse>\n    </div>\n</template>\n<script>\n    import FileManageService from '@service/file-source-manage';\n    import TaskHostNodeModel from '@model/task-host-node';\n    import SourceFileVO from '@domain/variable-object/source-file';\n    import JbCollapseItem from '@components/jb-collapse-item';\n    import RenderServerAgent from '@components/render-server-agent';\n    import RenderFilePath from './render-file-path';\n    import RenderGlobalVariable from './render-global-variable';\n    import RenderFileServer from './render-file-server';\n\n    export default {\n        name: '',\n        components: {\n            JbCollapseItem,\n            RenderServerAgent,\n            RenderFilePath,\n            RenderGlobalVariable,\n            RenderFileServer,\n        },\n        props: {\n            data: {\n                type: Array,\n                default: () => [],\n            },\n            variable: {\n                type: Array,\n                default: () => [],\n            },\n            account: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                activeResult: [],\n                localFileList: [{},{},{}],\n                serverFileList: [{},{},{}],\n                sourceFileList: [{},{},{}],\n                fileSourceIdsList: [{},{},{}], // 文件源ID\n                fileSourceAliasList: [{},{},{}], // 文件源名称\n            };\n        },\n        computed: {\n            isShowLocalFile () {\n                return this.localFileList.length > 0;\n            },\n            isShowServerFile () {\n                return this.serverFileList.length > 0;\n            },\n            isShowSourceFile () {\n                return this.sourceFileList.length > 0;\n            },\n        },\n        watch: {\n            data: {\n                handler (fileList) {\n                    fileList.forEach((fileItem) => {\n                        const fileSource = new SourceFileVO(fileItem);\n                        if (fileSource.isServerFile) {\n                            this.serverFileList.push(fileSource);\n                        } else if (fileSource.isLocalFile) {\n                            this.localFileList.push(fileSource);\n                        } else if (fileSource.isSourceFile) {\n                            this.sourceFileList.push(fileSource);\n                            const idLists = []; // 文件源ID\n                            this.sourceFileList.forEach((e) => {\n                                idLists.push(e.fileSourceId);\n                                this.fileSourceIdsList = idLists;\n                            });\n                        }\n                        if (this.localFileList.length > 0) {\n                            this.activeResult = ['local'];\n                        } else if (this.serverFileList.length > 0) {\n                            this.activeResult = ['server'];\n                        }\n                    });\n                },\n                immediate: true,\n            },\n            // 根据文件源ID获取文件源Alias\n            fileSourceIdsList: {\n                handler (newVal) {\n                    if (newVal.length) {\n                        const promiseList = newVal.map(id => FileManageService.getSourceInfo({\n                            id,\n                        }));\n                        Promise.all(promiseList).then((res) => {\n                            res.forEach((e) => {\n                                this.fileSourceAliasList.push(e.alias);\n                            });\n                        });\n                    }\n                },\n                immediate: true,\n            },\n        },\n        methods: {\n            findVariableValue (variable) {\n                const curVariable = this.variable.find(item => item.name === variable);\n                if (!curVariable) {\n                    const { hostNodeInfo } = new TaskHostNodeModel({});\n                    return hostNodeInfo;\n                }\n                return curVariable.defaultTargetValue.hostNodeInfo;\n            },\n            findAccountAlias (payload) {\n                const accountData = this.account.find(item => item.id === payload);\n                if (accountData) {\n                    return accountData.alias;\n                }\n                return '';\n            },\n            handleGoSource (payload, index) {\n                const { fileSourceId } = payload;\n                const sourceAlias = this.fileSourceAliasList[index];\n                const { href } = this.$router.resolve({\n                    name: 'bucketList',\n                    query: {\n                        fileSourceId,\n                        sourceAlias,\n                    },\n                });\n                window.open(href, '_blank');\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    @import \"@/css/mixins/scroll\";\n\n    .render-server-file {\n        flex: 1;\n\n        .bk-collapse-item-header {\n            display: flex;\n            align-items: center;\n            padding-left: 23px;\n\n            .collapse-title {\n                padding-left: 23px;\n            }\n        }\n\n        table {\n            width: 100%;\n            line-height: 20px;\n            background: #fff;\n\n            tr:nth-child(n+2) {\n                td {\n                    border-top: 1px solid #dcdee5;\n                }\n            }\n\n            th,\n            td {\n                height: 42px;\n                padding-top: 5px;\n                padding-bottom: 5px;\n                padding-left: 16px;\n                font-size: 12px;\n                text-align: left;\n\n                &:first-child {\n                    padding-left: 60px;\n                }\n            }\n\n            th {\n                font-weight: normal;\n                color: #313238;\n                border-bottom: 1px solid #dcdee5;\n            }\n\n            td {\n                color: #63656e;\n\n                .file-path {\n                    display: inline-block;\n                    max-width: 100%;\n                    overflow: hidden;\n                    text-overflow: ellipsis;\n                    white-space: nowrap;\n                }\n            }\n        }\n\n        .source-file-alias {\n            cursor: pointer;\n\n            &:hover {\n                color: #3a84ff !important;\n\n                .source-file-icon {\n                    display: inline;\n                }\n            }\n        }\n\n        .source-file-icon {\n            display: none;\n        }\n\n        .bk-table-empty-block {\n            display: none;\n        }\n\n        .source-file-tips-box {\n            max-width: 300px;\n            max-height: 280px;\n            min-width: 60px;\n            overflow-y: auto;\n\n            @mixin scroller;\n\n            .row {\n                word-break: break-all;\n            }\n\n            .dot {\n                display: inline-block;\n                width: 6px;\n                height: 6px;\n                background: currentColor;\n                border-radius: 50%;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"distro-file-view\" :class=\"{ loading: isLoading }\" v-bkloading=\"{ isLoading }\">\n        <detail-item :label=\"'超时时长：'\">{{ stepInfo.timeout }} (s)</detail-item>\n        <detail-item :label=\"'错误处理：'\">{{ stepInfo.ignoreErrorText }}</detail-item>\n        <detail-item :label=\"'上传限速：'\">{{ stepInfo.uploadSpeedLimitText }}</detail-item>\n        <detail-item :label=\"'下载限速：'\">{{ stepInfo.downloadSpeedLimitText }}</detail-item>\n        <detail-item :label=\"'文件来源：'\" layout=\"vertical\">\n            <render-source-file\n                v-if=\"!isLoading\"\n                :data=\"stepInfo.fileSourceList\"\n                :variable=\"variable\"\n                :account=\"account\" />\n        </detail-item>\n        <detail-item :label=\"'目标路径：'\">{{ stepInfo.fileDestination.path }}</detail-item>\n        <detail-item :label=\"'传输模式：'\">{{ stepInfo.transferModeText }}</detail-item>\n        <detail-item :label=\"'执行帐号：'\">{{ executeAccountText }}</detail-item>\n        <detail-item v-if=\"stepInfo.fileDestination.server.variable\" :label=\"'执行目标：'\">\n            <render-global-variable\n                :type=\"'执行目标'\"\n                :data=\"variable\"\n                :name=\"stepInfo.fileDestination.server.variable\" />\n        </detail-item>\n        <detail-item v-else :label=\"'执行目标：'\" layout=\"vertical\">\n            <server-panel\n                detail-fullscreen\n                :host-node-info=\"stepInfo.fileDestination.server.hostNodeInfo\" />\n        </detail-item>\n    </div>\n</template>\n<script>\n    import AccountManageService from '@service/account-manage';\n    import ServerPanel from '@components/choose-ip/server-panel';\n    import RenderSourceFile from './components/render-source-file';\n    import DetailItem from '@components/detail-layout/item';\n    import RenderGlobalVariable from './components/render-global-variable';\n\n    export default {\n        name: '',\n        components: {\n            ServerPanel,\n            RenderSourceFile,\n            RenderGlobalVariable,\n            DetailItem,\n        },\n        props: {\n            data: {\n                type: Object,\n                default: () => ({}),\n            },\n            variable: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                isLoading: true,\n                stepInfo: {},\n                executeAccountText: '',\n                account: [],\n            };\n        },\n        created () {\n            this.stepInfo = Object.freeze(this.data.fileStepInfo);\n            this.fetchAccount();\n        },\n        methods: {\n            fetchAccount () {\n                this.isLoading = true;\n                AccountManageService.fetchAccountWhole()\n                    .then((data) => {\n                        this.account = data;\n                        const accountData = data.find(item => item.id === this.stepInfo.fileDestination.account);\n                        if (accountData) {\n                            this.executeAccountText = accountData.alias;\n                        } else {\n                            this.executeAccountText = '--';\n                        }\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\" scoped>\n    .distro-file-view {\n        &.loading {\n            height: calc(100vh - 100px);\n        }\n\n        .detail-item {\n            margin-bottom: 0;\n        }\n    }\n</style>\n","<template>\n    <div class=\"exec-script-view\" :class=\"{ loading: isLoading }\" v-bkloading=\"{ isLoading }\">\n        <detail-item :label=\"'脚本来源：'\">\n            {{ stepInfo.scriptSourceText }}\n        </detail-item>\n        <detail-item v-if=\"isReferScript\" :label=\"'脚本引用：'\">\n            <span>{{ scriptName }}</span>\n            <Icon\n                class=\"script-detail\"\n                type=\"jump\"\n                v-bk-tooltips=\"'脚本详情'\"\n                @click=\"handleGoScriptDetail\" />\n            <div\n                v-if=\"stepInfo.isNeedUpdate || stepInfo.isDisabled\"\n                class=\"script-update-flag\">\n                <span v-html=\"stepInfo.scriptStatusHtml\" />\n                <bk-button\n                    v-if=\"stepInfo.isNeedUpdate\"\n                    text\n                    @click=\"handleGoScriptVersion\">\n                    {{ '版本对比' }}\n                </bk-button>\n                <bk-button text @click=\"handleUpdateScript\">\n                    {{ '去更新' }}\n                </bk-button>\n            </div>\n        </detail-item>\n        <detail-item :label=\"'脚本内容：'\" layout=\"vertical\">\n            <ace-editor\n                :value=\"stepInfo.content\"\n                :lang=\"language\"\n                :options=\"languageOption\"\n                readonly />\n        </detail-item>\n        <div>\n            <detail-item :label=\"'脚本参数：'\">\n                <jb-edit-textarea field=\"scriptParam\" :value=\"stepInfo.scriptParam\" readonly />\n            </detail-item>\n            <detail-item :label=\"'超时时长：'\">{{ stepInfo.timeout }}（s）</detail-item>\n            <detail-item :label=\"'错误处理：'\">{{ stepInfo.ignoreErrorText }}</detail-item>\n            <detail-item :label=\"'执行账号：'\">{{ executeAccountText }}</detail-item>\n        </div>\n        <detail-item v-if=\"stepInfo.executeTarget.variable\" :label=\"'执行目标：'\">\n            <render-global-variable\n                :type=\"'执行目标'\"\n                :name=\"stepInfo.executeTarget.variable\"\n                :data=\"variable\" />\n        </detail-item>\n        <detail-item v-else :label=\"'执行目标：'\" layout=\"vertical\">\n            <server-panel\n                detail-fullscreen\n                :host-node-info=\"stepInfo.executeTarget.hostNodeInfo\" />\n        </detail-item>\n    </div>\n</template>\n<script>\n    import ScriptService from '@service/script-manage';\n    import AccountManageService from '@service/account-manage';\n    import AceEditor from '@components/ace-editor';\n    import ServerPanel from '@components/choose-ip/server-panel';\n    import DetailItem from '@components/detail-layout/item';\n    import JbEditTextarea from '@components/jb-edit/textarea';\n    import RenderGlobalVariable from './components/render-global-variable';\n    import {\n        formatScriptTypeValue,\n    } from '@utils/assist';\n\n    export default {\n        name: '',\n        components: {\n            AceEditor,\n            ServerPanel,\n            DetailItem,\n            JbEditTextarea,\n            RenderGlobalVariable,\n            \n        },\n        props: {\n            data: {\n                type: Object,\n                default: () => ({}),\n            },\n            variable: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                stepInfo: {},\n                executeAccountText: '',\n                language: '',\n                scriptName: '',\n                scriptInfo: {},\n                isShowScriptSource: false,\n                requestQueue: [],\n            };\n        },\n        computed: {\n            isLoading () {\n                return this.requestQueue.length > 0;\n            },\n            isReferScript () {\n                return this.data.scriptStepInfo.scriptSource && this.data.scriptStepInfo.scriptSource !== 1;\n            },\n        },\n        created () {\n            this.stepInfo = Object.freeze(this.data.scriptStepInfo);\n            this.language = formatScriptTypeValue(this.stepInfo.scriptLanguage);\n            this.languageOption = [\n                this.language,\n            ];\n            if (this.stepInfo.scriptVersionId) {\n                this.fetchScriptDetail();\n            }\n            this.fetchAccount();\n        },\n        methods: {\n            /**\n             * @desc 更新脚本版本获取版本详情\n             */\n            fetchScriptDetail () {\n                this.requestQueue.push(true);\n                ScriptService.versionDetail({\n                    id: this.stepInfo.scriptVersionId,\n                }).then((data) => {\n                    this.scriptName = data.name;\n                    this.stepInfo.content = data.content;\n                    this.scriptInfo = Object.freeze(data);\n                })\n                    .finally(() => {\n                        this.requestQueue.pop();\n                    });\n            },\n            /**\n             * @desc 获取完整的账号列表\n             */\n            fetchAccount () {\n                this.requestQueue.push(true);\n                AccountManageService.fetchAccountWhole()\n                    .then((data) => {\n                        const accountData = data.find(item => item.id === this.stepInfo.account);\n                        if (accountData) {\n                            this.executeAccountText = accountData.alias;\n                        } else {\n                            this.executeAccountText = '--';\n                        }\n                    })\n                    .finally(() => {\n                        this.requestQueue.pop();\n                    });\n            },\n            /**\n             * @desc 新开窗口跳转脚本版本列表\n             */\n            handleGoScriptDetail () {\n                const routerName = this.scriptInfo.publicScript ? 'publicScriptVersion' : 'scriptVersion';\n\n                const router = this.$router.resolve({\n                    name: routerName,\n                    params: {\n                        id: this.stepInfo.scriptId,\n                    },\n                    query: {\n                        scriptVersionId: this.scriptInfo.scriptVersionId,\n                    },\n                });\n                window.open(router.href);\n            },\n            /**\n             * @desc 脚本版本对比\n             */\n            handleGoScriptVersion () {\n                const routerName = this.isReferPublicScript ? 'publicScriptVersion' : 'scriptVersion';\n                const { href } = this.$router.resolve({\n                    name: routerName,\n                    params: {\n                        id: this.stepInfo.scriptId,\n                    },\n                });\n                window.open(href);\n            },\n            /**\n             * @desc 编辑作业模板，更新步骤引用的脚本版本\n             */\n            handleUpdateScript () {\n                this.$router.push({\n                    name: 'templateEdit',\n                    params: {\n                        id: this.$route.params.id,\n                        stepId: this.data.id,\n                    },\n                    query: {\n                        from: 'templateDetail',\n                    },\n                });\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .exec-script-view {\n        &.loading {\n            height: calc(100vh - 100px);\n        }\n\n        .detail-item {\n            margin-bottom: 0;\n        }\n\n        .script-detail {\n            color: #3a84ff;\n            cursor: pointer;\n        }\n\n        .script-update-flag {\n            display: inline-block;\n\n            .script-update {\n                color: #ff5656;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"artificial-view\" v-bkloading=\"{ isLoading }\">\n        <detail-item :label=\"'确认人：'\">\n            <div class=\"approval-wraper\">\n                <div v-for=\"role in renderRoleList\" :key=\"role\" class=\"item\">\n                    <Icon type=\"user-group-gray\" class=\"approval-flag\" />\n                    {{ role }}\n                </div>\n                <div v-for=\"user in stepInfo.approvalUser.userList\" :key=\"user\" class=\"item\">\n                    <Icon type=\"user\" class=\"approval-flag\" />\n                    {{ user }}\n                </div>\n            </div>\n        </detail-item>\n        <detail-item :label=\"'通知方式：'\">{{ renderChannel }}</detail-item>\n        <detail-item :label=\"'确认描述：'\">{{ stepInfo.approvalMessage || '--' }}</detail-item>\n    </div>\n</template>\n<script>\n    import QueryGlobalSettingService from '@service/query-global-setting';\n    import NotifyService from '@service/notify';\n    import DetailItem from '@components/detail-layout/item';\n\n    export default {\n        name: '',\n        components: {\n            DetailItem,\n        },\n        inheritAttrs: false,\n        props: {\n            data: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                isLoading: true,\n                stepInfo: {},\n                renderRoleList: [{},{},{}],\n                renderChannel: '',\n            };\n        },\n        created () {\n            this.stepInfo = Object.freeze(this.data.approvalStepInfo);\n            Promise.all([\n                this.fetchRoleList(),\n                this.fetchAllChannel(),\n            ]).finally(() => {\n                this.isLoading = false;\n            });\n        },\n        methods: {\n            fetchRoleList () {\n                NotifyService.fetchRoleList()\n                    .then((data) => {\n                        const roleMap = {};\n                        data.forEach((role) => {\n                            roleMap[role.code] = role.name;\n                        });\n                        // 过滤掉已经被删除的角色分组\n                        this.renderRoleList = this.stepInfo.approvalUser.roleList.reduce((result, item) => {\n                            if (roleMap[item]) {\n                                result.push(roleMap[item]);\n                            }\n                            return result;\n                        }, []);\n                    });\n            },\n            fetchAllChannel () {\n                if (this.stepInfo.notifyChannel.length < 1) {\n                    this.renderChannel = '--';\n                    return Promise.resolve();\n                }\n                QueryGlobalSettingService.fetchActiveNotifyChannel()\n                    .then((data) => {\n                        const channelMap = {};\n                        data.forEach((channel) => {\n                            channelMap[channel.code] = channel.name;\n                        });\n                        const channel = this.stepInfo.notifyChannel.reduce((result, item) => {\n                            // 过滤掉已经被删除的通知渠道\n                            if (channelMap[item]) {\n                                result.push(channelMap[item]);\n                            }\n                            return result;\n                        }, []);\n                        if (channel.length < 1) {\n                            this.renderChannel = '--';\n                        }\n                        this.renderChannel = channel.join('，');\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .artificial-view {\n        .detail-item {\n            margin-bottom: 0;\n        }\n\n        .approval-wraper {\n            display: flex;\n            align-items: center;\n            flex-wrap: wrap;\n            min-height: 34px;\n            margin-top: -5px;\n\n            .item {\n                display: flex;\n                height: 20px;\n                padding: 0 6px;\n                margin-top: 10px;\n                margin-right: 10px;\n                font-size: 12px;\n                color: #63656e;\n                background: #f0f1f5;\n                border-radius: 2px;\n                align-items: center;\n            }\n\n            .approval-flag {\n                margin-right: 4px;\n            }\n        }\n    }\n</style>\n","<template>\n    <detail-layout mode=\"see\" class=\"detail-layout-wrapper\">\n        <detail-item :label=\"'步骤类型：'\">{{ stepTypeText }}</detail-item>\n        <detail-item :label=\"'步骤名称：'\">{{ data.name }}</detail-item>\n        <component\n            ref=\"stepCom\"\n            :is=\"stepCom\"\n            :variable=\"variable\"\n            :data=\"data\" />\n    </detail-layout>\n</template>\n<script>\n       import DetailLayout from '@components/detail-layout';\n    import DetailItem from '@components/detail-layout/item';\n    import StepDistroFile from './distro-file';\n    import StepExecScript from './exec-script';\n    import StepArificial from './artificial';\n\n    const STEP_TYPE_LIST = {\n        1: '执行脚本',\n        2: '分发文件',\n        3: '人工确认',\n    };\n\n    export default {\n        components: {\n            StepDistroFile,\n            StepExecScript,\n            StepArificial,\n            DetailLayout,\n            DetailItem,\n        },\n        props: {\n            variable: {\n                type: Array,\n                default: () => [],\n            },\n            data: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        computed: {\n            stepTypeText () {\n                return STEP_TYPE_LIST[this.data.type];\n            },\n            stepCom () {\n                const taskStepMap = {\n                    1: StepExecScript,\n                    2: StepDistroFile,\n                    3: StepArificial,\n                };\n                if (!Object.prototype.hasOwnProperty.call(taskStepMap, this.data.type)) {\n                    return 'div';\n                }\n                return taskStepMap[this.data.type];\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\" scoped>\n    .detail-layout-wrapper {\n        .detail-item {\n            margin-bottom: 0;\n        }\n    }\n</style>\n","<template>\n    <div\n        v-if=\"isShow\"\n        v-bk-tooltips=\"'回到顶部'\"\n        class=\"job-back-top\"\n        :class=\"classes\"\n        :style=\"styles\"\n        @click=\"handleBackTop\">\n        <Icon type=\"up-to-top\" />\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import {\n        scrollTopSmooth,\n    } from '@utils/assist';\n\n    export default {\n        name: '',\n        props: {\n            // 可滚动容器元素\n            target: {\n                type: Function,\n                default: () => document.querySelector('.jb-navigation-main').querySelector('.scroll-faker-content'),\n            },\n            size: {\n                type: String,\n                default: 'normal',\n            },\n            fixed: {\n                type: Boolean,\n                default: true,\n            },\n        },\n        data () {\n            return {\n                isShow: false,\n            };\n        },\n        computed: {\n            classes () {\n                return `theme-${this.size}`;\n            },\n            styles () {\n                if (!this.fixed) {\n                    return {};\n                }\n                return {\n                    position: 'fixed',\n                    right: '34px',\n                    bottom: '92px',\n                };\n            },\n        },\n        mounted () {\n            this.smartPosition();\n            window.addEventListener('resize', this.smartPosition);\n            const observer = new MutationObserver((payload) => {\n                this.smartPosition();\n            });\n            observer.observe(this.target(), {\n                subtree: true,\n                childList: true,\n                attributeName: true,\n                characterData: true,\n            });\n            this.$once('hook:beforeDestroy', () => {\n                observer.takeRecords();\n                observer.disconnect();\n                window.removeEventListener('resize', this.smartPosition);\n            });\n        },\n        methods: {\n            /**\n             * @desc 计算位置\n             */\n            smartPosition: _.debounce(function () {\n                const $srollContainer = this.target();\n                if (!$srollContainer) {\n                    return;\n                }\n                const selfHeight = $srollContainer.getBoundingClientRect().height;\n                const { scrollHeight } = $srollContainer;\n                this.isShow = scrollHeight > selfHeight + 30;\n            }, 300),\n            /**\n             * @desc 点击按钮目标容器滚动到顶部\n             */\n            handleBackTop () {\n                const $srollContainer = this.target();\n                scrollTopSmooth($srollContainer, 0);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .job-back-top {\n        display: flex;\n        width: 28px;\n        height: 28px;\n        color: #fff;\n        cursor: pointer;\n        background: rgb(0 0 0 / 25%);\n        border-radius: 50%;\n        align-items: center;\n        justify-content: center;\n\n        &:hover {\n            background: rgb(0 0 0 / 40%);\n        }\n\n        &.theme-normal {\n            width: 36px;\n            height: 36px;\n            font-size: 20px;\n        }\n\n        &.theme-small {\n            width: 28px;\n            height: 28px;\n            font-size: 16px;\n        }\n    }\n</style>\n","<template>\n    <div id=\"templateStepRender\">\n        <div class=\"task-step-container\" :class=\"stepContainerClasses\">\n            <template v-for=\"(step, index) in steps\">\n                <components\n                    v-if=\"step.delete !== 1\"\n                    :is=\"stepBoxCom\"\n                    :list=\"[step]\"\n                    :group=\"{\n                        name: 'step',\n                        pull: 'clone',\n                        put: dragStartIndex !== index,\n                    }\"\n                    :key=\"`${index}_${step.id}`\"\n                    @start=\"handleDragStart(index)\"\n                    :move=\"handleDragMove\"\n                    @add=\"handleDragAdd(index)\"\n                    :index=\"index\"\n                    class=\"step-drag-box\"\n                    :class=\"{\n                        sort: isOperation && dragStartIndex > -1,\n                    }\">\n                    <div\n                        class=\"step-content-wraper\"\n                        :class=\"{\n                            'step-mode-diff': isDiff,\n                            'select': isSelect,\n                            'not-select': isSelect && !selectValue.includes(step.id),\n                            active: index === currentIndex,\n                        }\"\n                        :order=\"genOrder()\">\n                        <div\n                            class=\"render-task-step\"\n                            :class=\"[diff[step.id] && diff[step.id].type]\">\n                            <div class=\"step-content\" @click=\"handleStepClick(index)\">\n                                <div class=\"step-icon\">\n                                    <Icon :type=\"step.icon\" />\n                                </div>\n                                <div class=\"step-name\">\n                                    <div class=\"step-name-text\">{{ step.name || '--' }}</div>\n                                    <!-- 执行脚本，引用脚本的状态 -->\n                                    <div v-html=\"step.scriptStatusHtml\" />\n                                </div>\n                                <Icon v-if=\"isOperation\" type=\"move\" class=\"draggable-flag\" />\n                            </div>\n                            <div v-if=\"isOperation\" class=\"step-operation\">\n                                <Icon\n                                    type=\"plus-circle\"\n                                    class=\"operation\"\n                                    @click=\"handleShowCreate(index)\" />\n                                <Icon\n                                    type=\"minus-circle\"\n                                    class=\"operation\"\n                                    @click=\"handleDel(index)\" />\n                                <Icon\n                                    type=\"edit-2\"\n                                    class=\"operation\"\n                                    @click=\"handleShowEdit(index)\" />\n                                <Icon\n                                    type=\"step-copy\"\n                                    class=\"operation\"\n                                    :tippy-tips=\"'克隆步骤'\"\n                                    @mouseover=\"handleCloneStepHover(index, true)\"\n                                    @mouseout=\"handleCloneStepHover(index, false)\"\n                                    @click=\"handleCloneStep(index)\" />\n                            </div>\n                            <div v-if=\"isSelect\" class=\"select-flag\" @click=\"handleStepSelect(step)\">\n                                <div class=\"select-checked\" />\n                            </div>\n                            <template v-if=\"isEdit\">\n                                <!-- 编辑状态的新建步骤需要标记出来 -->\n                                <div v-if=\"!step.id\" class=\"step-new-flag\">new</div>\n                            </template>\n                            <!-- 本地验证不通过标记 -->\n                            <div v-if=\"step.localValidator === false\" class=\"need-validate-falg\">\n                                {{ '待补全' }}\n                            </div>\n                        </div>\n                        <!-- 执行方案同步diff标记 -->\n                        <div class=\"diff-order\" v-if=\"diff[step.id] && diff[step.id].type === 'move'\">\n                            <div v-if=\"diff[step.id].value !== 0\" class=\"order-change\">\n                                <Icon :type=\"`${diff[step.id].value < 0 ? 'down-arrow' : 'up-arrow'}`\" />\n                                {{ Math.abs(diff[step.id].value) }}\n                            </div>\n                            <span v-else class=\"order-normal\">-</span>\n                        </div>\n                    </div>\n                </components>\n            </template>\n            <div\n                v-if=\"isOperation\"\n                class=\"step-create-btn\"\n                key=\"create\"\n                v-test=\"{ type: 'button', value: 'create_step' }\"\n                @click=\"handleShowCreate(-1)\">\n                <Icon type=\"plus\" class=\"action-flag\" />\n                {{ '作业步骤'}}\n            </div>\n        </div>\n        <lower-component v-if=\"isView\">\n            <jb-sideslider\n                :is-show.sync=\"isShowDetail\"\n                :title=\"'查看作业步骤'\"\n                :show-footer=\"false\"\n                :quick-close=\"true\"\n                :width=\"896\"\n                :media=\"mediaQueryMap\">\n                <task-step-view\n                    v-if=\"isShowDetail\"\n                    ref=\"stepViewRef\"\n                    :variable=\"hostVariables\"\n                    :data=\"detailInfo\" />\n            </jb-sideslider>\n        </lower-component>\n        <lower-component v-if=\"isOperation\">\n            <jb-sideslider\n                id=\"taskStepOperationSideslider\"\n                :is-show.sync=\"isShowOperation\"\n                v-bind=\"operationSideSliderInfo\"\n                :width=\"916\"\n                :media=\"mediaQueryMap\">\n                <task-step-operation\n                    v-if=\"isShowOperation\"\n                    ref=\"taskStep\"\n                    :variable=\"hostVariables\"\n                    :script-variables=\"scriptVariables\"\n                    :data=\"operationData\"\n                    @on-change=\"handleTaskStepSubmit\" />\n            </jb-sideslider>\n        </lower-component>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n       import Draggable from 'vuedraggable';\n    import TaskStepModel from '@model/task/task-step';\n    import JbSideslider from '@components/jb-sideslider';\n    import TaskStepOperation from './task-step';\n    import TaskStepView from './task-step-view';\n\n    export default {\n        name: 'RenderTaskStep',\n        components: {\n            Draggable,\n            JbSideslider,\n            TaskStepOperation,\n            TaskStepView,\n        },\n        props: {\n            list: {\n                type: Array,\n                required: true,\n            },\n            /*\n             * @value '': 仅可查看详情\n             * @value 'operate': 可编辑可新建可删除\n             * @value 'select': 选择模式\n             * @value 'diff': diff场景\n             */\n            mode: {\n                type: String,\n                default: '',\n            },\n            selectValue: {\n                type: Array,\n                default: () => [],\n            },\n            // 全局变量 list\n            variable: {\n                type: Array,\n                default: () => [],\n            },\n            diff: {\n                type: Object,\n                default: () => ({}),\n            },\n        },\n        data () {\n            return {\n                steps: [],\n                isShowOperation: false,\n                isShowDetail: false,\n                isShowClone: false,\n                operationType: '',\n                currentIndex: -1,\n                operationData: {},\n                detailInfo: {},\n                dragStartIndex: -1,\n                mediaQueryMap: [1000, 1100, 1200, 1300],\n            };\n        },\n        computed: {\n            /**\n             * @desc 步骤有id说明是编辑状态\n             * @return {Boolean}\n             */\n            isEdit () {\n                // eslint-disable-next-line no-plusplus\n                for (let i = 0; i < this.list.length; i++) {\n                    if (this.list[i].id) {\n                        return true;\n                    }\n                }\n                return false;\n            },\n            /**\n             * @desc 操作模板步骤（新建、编辑）\n             * @return {Boolean}\n             */\n            isOperation () {\n                return this.mode === 'operation';\n            },\n            /**\n             * @desc 选择模板步骤（用于编辑执行的场景）\n             * @return {Boolean}\n             */\n            isSelect () {\n                return this.mode === 'select';\n            },\n            /**\n             * @desc 查看作业模板步骤\n             * @return {Boolean}\n             */\n            isView () {\n                return !this.mode || this.mode === 'select';\n            },\n            /**\n             * @desc 作业模板步骤同比查看差异\n             * @return {Boolean}\n             */\n            isDiff () {\n                return this.mode === 'diff';\n            },\n            /**\n             * @desc 作业模板步骤可以编辑时需要能拖动排序\n             * @return {String}\n             */\n            stepBoxCom () {\n                if (this.isOperation) {\n                    return 'draggable';\n                }\n                return 'div';\n            },\n            /**\n             * @desc 步骤编辑的样式 class\n             * @return {Object}\n             */\n            stepContainerClasses () {\n                const classes = {};\n                if (!this.isShowOperation && !this.isShowDetail && !this.isShowClone) {\n                    return classes;\n                }\n                classes[this.operationType] = true;\n                return classes;\n            },\n            /**\n             * @desc 步骤的执行目标只能选中主机变量\n             * @return {Array}\n             */\n            hostVariables () {\n                return this.variable.filter(item => !item.delete && item.isHost);\n            },\n            /**\n             * @desc 脚本步骤中脚本内容可使用非主机变量\n             * @return {Array}\n             */\n            scriptVariables () {\n                return this.variable.filter(item => !item.delete && !item.isHost);\n            },\n            /**\n             * @desc 步骤操作弹层的信息\n             * @return {Object}\n             */\n            operationSideSliderInfo () {\n                if (this.operationType === 'create') {\n                    return {\n                        title: '新建作业步骤',\n                        okText: '提交',\n                    };\n                }\n                return {\n                    title: '编辑作业步骤',\n                    okText: '保存',\n                };\n            },\n        },\n        watch: {\n            list: {\n                handler (list) {\n                    if (this.isOperation) {\n                        if (list.length < 1) {\n                            this.steps = [];\n                            return;\n                        }\n                    }\n                    this.steps = Object.freeze([...list]);\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            // 重新计算每个步骤的索引值（被删除的步骤不被显示）\n            this.order = 0;\n        },\n        beforeUpdate () {\n            // 重新计算每个步骤的索引值（被删除的步骤不被显示）\n            this.order = 0;\n        },\n        methods: {\n            /**\n             * @desc 外部调用——点击指定 index 的步骤\n             */\n            clickStepByIndex (index) {\n                this.handleStepClick(index);\n            },\n            genOrder () {\n                this.order += 1;\n                return this.order;\n            },\n            /**\n             * @desc 鼠标点击某个步骤\n             * @param {Object} payload 点击的模板步骤数据\n             * @param {Number} index 点击的模板步骤索引\n             */\n            handleStepClick (index) {\n                if (this.isOperation) {\n                    // 编辑步骤\n                    this.handleShowEdit(index);\n                    return;\n                }\n                // 查看步骤详情\n                this.currentIndex = index;\n                this.operationType = 'detail';\n                this.detailInfo = this.steps[index];\n                this.isShowDetail = true;\n            },\n            /**\n             * @desc 操作执行方案步骤时，选择作业模板的步骤\n             * @param {Object} step 点击的模板步骤数据\n             */\n            handleStepSelect (step) {\n                this.$emit('on-select', step);\n            },\n            /**\n             * @desc 显示编辑作业模板步骤的弹层\n             * @param {Number} index 点击的模板步骤索引\n             */\n            handleShowEdit (index) {\n                this.operationType = 'edit';\n                this.currentIndex = index;\n                this.operationData = this.steps[index];\n                this.isShowOperation = true;\n            },\n            /**\n             * @desc 鼠标hover克隆按钮时需要显示克隆步骤的placeholder\n             * @param {Number} index 点击的模板步骤索引\n             * @param {Boolean} isHover 鼠标的hover状态\n             */\n            handleCloneStepHover (index, isHover) {\n                if (isHover) {\n                    this.currentIndex = index;\n                    this.operationType = 'clone';\n                    this.isShowClone = true;\n                } else {\n                    this.currentIndex = -1;\n                    this.operationType = '';\n                    this.isShowClone = false;\n                }\n            },\n            /**\n             * @desc 克隆作业模板步骤\n             * @param {Number} index 点击的模板步骤索引\n             */\n            handleCloneStep (index) {\n                const steps = [...this.steps];\n\n                let newStep = {\n                    ...steps[index],\n                };\n                newStep.id = 0;\n                newStep.name = `${newStep.name}_copy`;\n                newStep = new TaskStepModel(newStep, true);\n                steps.splice(index + 1, 0, newStep);\n\n                this.steps = Object.freeze(steps);\n                this.handleCloneStepHover(-1, false);\n                this.$emit('on-change', steps);\n            },\n            /**\n             * @desc 点击作业模板新建按钮在对应步骤后面追加一个新步骤\n             * @param {Number} index 点击的模板步骤索引\n             */\n            handleShowCreate (index) {\n                this.operationType = 'create';\n                this.currentIndex = index;\n                this.operationData = {};\n                this.isShowOperation = true;\n            },\n            /**\n             * @desc 删除作业模板新建\n             * @param {Number} index 将要的模板步骤索引\n             */\n            handleDel (index) {\n                this.$bkInfo({\n                    title: '确定删除该步骤？',\n                    subTitle: '删除之后不可恢复，请谨慎操作！',\n                    confirmFn: () => {\n                        const steps = [...this.steps];\n\n                        const currentStep = steps[index];\n                        if (currentStep.id > 0) {\n                            // 删除已存在的步骤\n                            //  —设置delete\n                            currentStep.delete = 1;\n                        } else {\n                            // 删除新建的步骤\n                            //  —直接删除\n                            steps.splice(index, 1);\n                        }\n\n                        this.steps = Object.freeze(steps);\n                        this.$emit('on-change', steps);\n                    },\n                });\n            },\n            /**\n             * @desc 提交作业模板步骤的操作\n             * @param {Number} payload 将要的模板步骤索引\n             * @param {Boolean} localValidator 表单验证结果\n             */\n            handleTaskStepSubmit (payload, localValidator) {\n                const operationStep = new TaskStepModel(payload);\n                const steps = [...this.steps];\n\n                // 重要！！！\n                // 新建脚本过程中不做验证，但要给出验证不通过的标记\n                operationStep.localValidator = localValidator;\n\n                if (this.operationType === 'create') {\n                    if (this.currentIndex === -1) {\n                        steps.push(operationStep);\n                    } else {\n                        steps.splice(this.currentIndex + 1, 0, operationStep);\n                    }\n                } else {\n                    steps.splice(this.currentIndex, 1, operationStep);\n                }\n\n                this.steps = Object.freeze(steps);\n                this.$emit('on-change', steps);\n            },\n            /**\n             * @desc 选中拖动的作业模板步骤\n             * @param {Number} index 拖动的模板步骤索引\n             */\n            handleDragStart (index) {\n                this.dragStartIndex = index;\n            },\n            /**\n             * @desc 拖动作业模板步骤\n             * @param {Object} event 拖动事件\n             * @return {Boolean}\n             */\n            handleDragMove: _.throttle(function (event) {\n                this.dragFutureIndex = event.draggedContext.futureIndex;\n                return true;\n            }, 30),\n            /**\n             * @desc 拖动结束\n             * @param {Number} index 拖动的模板步骤索引\n             */\n            handleDragAdd (index) {\n                if (this.dragStartIndex === index) {\n                    return;\n                }\n                if (this.dragStartIndex - index === 1) {\n                    if (this.dragFutureIndex === 1) {\n                        return;\n                    }\n                }\n                if (this.dragStartIndex - index === -1) {\n                    if (this.dragFutureIndex === 0) {\n                        return;\n                    }\n                }\n                const steps = [...this.steps];\n\n                const startStep = steps[this.dragStartIndex];\n                steps.splice(this.dragStartIndex, 1);\n                steps.splice(index, 0, startStep);\n\n                this.dragStartIndex = -1;\n                this.steps = Object.freeze(steps);\n                this.$emit('on-change', steps);\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    @import \"@/css/mixins/media\";\n\n    @mixin step-active {\n        .step-content {\n            color: #3a84ff;\n            background: #e1ecff;\n            border-color: #3a84ff;\n        }\n\n        .step-icon {\n            color: #3a84ff;\n            background: #e1ecff;\n            border-color: transparent !important;\n        }\n\n        .draggable-flag {\n            display: block;\n        }\n    }\n\n    .task-step-container {\n        display: flex;\n        flex-direction: column;\n        width: 500px;\n\n        @media (--small-viewports) {\n            width: 500px;\n        }\n\n        @media (--medium-viewports) {\n            width: 560px;\n        }\n\n        @media (--large-viewports) {\n            width: 620px;\n        }\n\n        @media (--huge-viewports) {\n            width: 680px;\n        }\n\n        &.detail,\n        &.edit,\n        &.create {\n            .step-content-wraper {\n                &.active {\n                    .render-task-step {\n                        @include step-active;\n                    }\n                }\n            }\n        }\n\n        &.create,\n        &.clone {\n            .step-content-wraper {\n                &.active {\n                    &::after {\n                        display: block;\n                        height: 42px;\n                        margin-top: 10px;\n                        background: #e1ecff;\n                        border-radius: 2px;\n                        content: \"\";\n                    }\n                }\n            }\n        }\n    }\n\n    .step-drag-box {\n        position: relative;\n\n        &:hover,\n        &.sort {\n            .step-content-wraper {\n                &::before {\n                    content: attr(order);\n                }\n            }\n        }\n\n        &:hover {\n            .step-content-wraper {\n                &::before {\n                    color: #3a84ff;\n                    background: #e1ecff;\n                    border-color: #3a84ff;\n                }\n            }\n        }\n\n        & ~ .step-drag-box {\n            margin-top: 10px;\n        }\n    }\n\n    .step-content-wraper {\n        position: relative;\n        cursor: pointer;\n\n        &::before {\n            position: absolute;\n            top: 0;\n            left: -2px;\n            height: 16px;\n            padding: 0 5px;\n            font-size: 12px;\n            font-weight: bold;\n            line-height: 16px;\n            color: #63656e;\n            background: #f0f1f5;\n            border: 1px solid #c4c6cc;\n            border-radius: 2px;\n            transform: translateX(-100%);\n        }\n\n        &.sortable-ghost {\n            height: 42px;\n            background: #e1ecff;\n\n            &::before {\n                content: none !important;\n            }\n\n            .render-task-step {\n                display: none;\n            }\n        }\n\n        &.select {\n            .step-content,\n            .step-icon {\n                border-color: #3a84ff;\n            }\n\n            .step-icon {\n                color: #3a84ff;\n                background: #e1ecff;\n            }\n\n            .select-flag {\n                position: absolute;\n                top: 0;\n                right: 0;\n                bottom: 0;\n                display: flex;\n                align-items: center;\n                padding-right: 22px;\n                padding-left: 20px;\n\n                &::before {\n                    position: absolute;\n                    width: 1px;\n                    height: 22px;\n                    margin-left: -22px;\n                    background: #d8d8d8;\n                    content: \"\";\n                }\n\n                .select-checked {\n                    position: relative;\n                    display: block;\n                    width: 18px;\n                    height: 18px;\n                    background: #3a84ff;\n                    border: 1px solid #3a84ff;\n                    border-radius: 50%;\n\n                    &::after {\n                        position: absolute;\n                        top: 1px;\n                        left: 5px;\n                        width: 4px;\n                        height: 8px;\n                        border: 2px solid #fff;\n                        border-top: 0;\n                        border-left: 0;\n                        content: \"\";\n                        transform: rotate(45deg) scale(1);\n                        transition: all 0.15s;\n                        transform-origin: center;\n                    }\n                }\n            }\n        }\n\n        &.not-select {\n            .step-icon {\n                color: #c4c6cc;\n                background: #f0f1f5;\n                border-color: #dcdee5;\n            }\n\n            .step-content {\n                color: #979ba5;\n                background: transparent;\n                border-color: #dcdee5;\n            }\n\n            .select-flag {\n                .select-checked {\n                    background: transparent;\n                    border-color: #c4c6cc;\n\n                    &::after {\n                        transform: scale(0);\n                    }\n                }\n            }\n        }\n    }\n\n    .render-task-step {\n        position: relative;\n\n        &:hover {\n            .step-operation {\n                display: flex;\n            }\n\n            .need-validate-falg {\n                display: none;\n            }\n\n            @include step-active;\n        }\n\n        .step-content {\n            display: flex;\n            height: 42px;\n            color: #63656e;\n            background: #fff;\n            border: 1px solid #c4c6cc;\n            border-radius: 2px;\n            box-sizing: border-box;\n\n            &.active {\n                background: #e1ecff;\n                border-color: #3a84ff;\n\n                .step-icon {\n                    background: inherit;\n                    border-color: transparent;\n                }\n            }\n        }\n\n        .step-icon {\n            display: flex;\n            height: 100%;\n            font-size: 16px;\n            background: #f0f1f5;\n            border-right: 1px solid #c4c6cc;\n            align-items: center;\n            justify-content: center;\n            flex: 0 0 42px;\n        }\n\n        .draggable-flag {\n            position: absolute;\n            top: 50%;\n            right: 0;\n            display: none;\n            font-size: 33px;\n            color: #3a84ff;\n            transform: translateY(-50%);\n        }\n\n        .step-name {\n            position: relative;\n            display: flex;\n            align-items: center;\n            padding-left: 9px;\n\n            .step-name-text {\n                max-width: 400px;\n                overflow: hidden;\n                font-size: 14px;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n\n            &:hover {\n                color: #3a84ff;\n            }\n        }\n\n        .step-update {\n            position: absolute;\n            right: -14px;\n            width: 6px;\n            height: 6px;\n            background: #ff5656;\n            border-radius: 50%;\n        }\n\n        .step-operation {\n            position: absolute;\n            top: 50%;\n            right: 0;\n            display: none;\n            align-items: center;\n            height: 40px;\n            padding-left: 12px;\n            font-size: 18px;\n            color: #c4c6cc;\n            transform: translateX(100%) translateY(-50%);\n\n            .operation {\n                padding: 12px 8px 12px 0;\n                cursor: pointer;\n\n                &.active,\n                &:hover {\n                    color: #3a84ff;\n                }\n            }\n        }\n\n        .select-flag {\n            display: none;\n        }\n\n        .step-new-flag {\n            position: absolute;\n            top: -7px;\n            right: -8px;\n            display: flex;\n            width: 32px;\n            height: 16px;\n            font-size: 12px;\n            color: #fff;\n            text-align: center;\n            background: #3a84ff;\n            border-radius: 2px;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .need-validate-falg {\n            position: absolute;\n            top: 50%;\n            right: 0;\n            height: 18px;\n            padding: 0 4px;\n            margin-right: -12px;\n            font-size: 12px;\n            line-height: 18px;\n            color: #ea3636;\n            background: #fdd;\n            transform: translateY(-50%) translateX(100%);\n\n            &::before {\n                position: absolute;\n                width: 0;\n                height: 0;\n                margin-left: -22px;\n                border: 9px solid transparent;\n                border-right-color: #fdd;\n                content: \"\";\n            }\n\n            &::after {\n                position: absolute;\n                top: 50%;\n                left: -4px;\n                width: 4px;\n                height: 4px;\n                background: #fff;\n                border-radius: 50%;\n                content: \"\";\n                transform: translateY(-50%);\n            }\n        }\n    }\n\n    .step-create-btn {\n        display: flex;\n        width: 100%;\n        height: 42px;\n        margin-top: 10px;\n        font-size: 14px;\n        color: #979ba5;\n        cursor: pointer;\n        border: 1px dashed #c4c6cc;\n        align-items: center;\n        justify-content: center;\n\n        &:hover {\n            color: #3a84ff;\n            border-color: #3a84ff;\n\n            .action-flag {\n                color: #3a84ff;\n            }\n        }\n\n        .action-flag {\n            margin-right: 5px;\n            color: #c4c6cc;\n        }\n    }\n\n    /* diff 对比的样式 */\n    .step-mode-diff {\n        cursor: default;\n\n        &::after {\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            content: \"\";\n        }\n\n        .render-task-step {\n            &.new {\n                &::after {\n                    position: absolute;\n                    top: -6px;\n                    right: -6px;\n                    width: 28px;\n                    height: 14px;\n                    font-size: 12px;\n                    line-height: 14px;\n                    color: #fff;\n                    text-align: center;\n                    background: #ffa86e;\n                    content: \"new\";\n                }\n            }\n\n            &.new,\n            &.move,\n            &.different {\n                position: relative;\n\n                .step-content {\n                    border-color: #f9c9a9;\n                }\n\n                .step-icon {\n                    color: #f5c09e;\n                    background: #ffefe4;\n                    border-right-color: #f9c9a9;\n                }\n            }\n\n            &.delete {\n                .step-content {\n                    color: #c4c6cc;\n                    border-color: #dcdee5;\n                }\n\n                .step-icon {\n                    color: #dcdee5;\n                    background: #f5f7fa;\n                    border-right-color: #dcdee5;\n                }\n\n                .step-name-text {\n                    text-decoration: line-through;\n                }\n            }\n        }\n\n        .diff-order {\n            position: absolute;\n            top: 50%;\n            right: 0;\n            width: 50px;\n            padding-left: 15px;\n            font-size: 14px;\n            transform: translate(100%, -50%);\n\n            .order-change {\n                color: #f98d45;\n            }\n\n            .order-normal {\n                color: #63656e;\n            }\n        }\n    }\n</style>\n","<template>\n    <div ref=\"layout\" class=\"plan-action-layout\" :style=\"layoutStyles\">\n        <div class=\"loading-wraper\" :class=\"{ 'loading-hidden': showContent }\">\n            <div class=\"loading-content\">\n                <content-loader\n                    :height=\"455\"\n                    :width=\"580\"\n                    :speed=\"2\"\n                    primary-color=\"#EBECF3\"\n                    secondary-color=\"#F6F7FB\">\n                    <rect x=\"0\" y=\"0\" width=\"128\" height=\"16\" rx=\"1\" />\n                    <rect x=\"0\" y=\"148\" width=\"128\" height=\"16\" rx=\"1\" />\n                    <rect x=\"0\" y=\"180\" width=\"620\" height=\"42\" rx=\"2\" />\n                    <rect x=\"0\" y=\"232\" width=\"620\" height=\"42\" rx=\"2\" />\n                    <rect x=\"0\" y=\"284\" width=\"620\" height=\"42\" rx=\"2\" />\n                    <rect x=\"0\" y=\"336\" width=\"620\" height=\"42\" rx=\"2\" />\n                    <rect x=\"0\" y=\"388\" width=\"620\" height=\"42\" rx=\"2\" />\n                    <rect x=\"0\" y=\"28\" width=\"128\" height=\"16\" rx=\"1\" />\n                    <rect x=\"0\" y=\"56\" width=\"200\" height=\"50\" rx=\"1\" />\n                    <rect x=\"210\" y=\"56\" width=\"200\" height=\"50\" rx=\"1\" />\n                    <rect x=\"420\" y=\"56\" width=\"200\" height=\"50\" rx=\"1\" />\n                </content-loader>\n            </div>\n        </div>\n        <div class=\"layout-title\">\n            <slot name=\"title\">\n                <div class=\"title-text\">{{ title }}</div>\n            </slot>\n            <div class=\"sub-title\">\n                <slot name=\"sub-title\" />\n            </div>\n        </div>\n        <div ref=\"content\" class=\"content-wraper\" :style=\"contentStyles\">\n            <slot />\n        </div>\n        <div class=\"layout-footer\" :style=\"footerStyles\">\n            <slot name=\"footer\" />\n        </div>\n        <back-top v-if=\"showContent\" :target=\"getBackTopTarget\" />\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import { ContentLoader } from 'vue-content-loader';\n    import { getOffset } from '@utils/assist';\n    import BackTop from '@components/back-top';\n\n    export default {\n        name: '',\n        components: {\n            ContentLoader,\n            BackTop,\n        },\n        props: {\n            title: String,\n            mode: String,\n            planName: String,\n            loading: {\n                type: Boolean,\n                default: false,\n            },\n            bottomOffset: {\n                type: Number,\n                default: 0,\n            },\n        },\n        data () {\n            return {\n                showContent: !this.loading,\n                layoutOffsetTop: 0,\n                contentOffsetTop: 0,\n                footerOffsetLeft: 0,\n                isFooterFixed: false,\n            };\n        },\n        computed: {\n            layoutStyles () {\n                return {\n                    height: `calc(100vh - ${this.layoutOffsetTop}px - ${this.bottomOffset}px)`,\n                };\n            },\n            contentStyles () {\n                return {\n                    'max-height': `calc(100vh - ${this.contentOffsetTop}px - 60px - ${this.bottomOffset}px)`,\n                };\n            },\n            footerStyles () {\n                const styles = {\n                    'padding-left': `${this.footerOffsetLeft}px`,\n                };\n                if (!this.isFooterFixed) {\n                    return styles;\n                }\n                return {\n                    ...styles,\n                    'box-shadow': '0px -2px 4px 0px rgba(0, 0, 0, 0.06)',\n                };\n            },\n        },\n        watch: {\n            loading (loading) {\n                if (loading) {\n                    this.showContent = false;\n                    this.time = Date.now();\n                    return;\n                }\n                \n                const spaceTime = Date.now() - this.time;\n                setTimeout(() => {\n                    this.showContent = true;\n                }, spaceTime > 800 ? 0 : 1000 - spaceTime);\n            },\n        },\n        created () {\n            this.time = Date.now();\n        },\n        mounted () {\n            window.addEventListener('resize', this.init);\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('resize', this.init);\n            });\n            this.init();\n        },\n        updated: _.debounce(function () {\n            this.init();\n        }, 500),\n        methods: {\n            init () {\n                if (!this.$refs.layout || !this.$refs.content || !document.querySelector('#templateStepRender')) {\n                    return;\n                }\n                const offset = getOffset(this.$refs.layout);\n                this.layoutOffsetTop = offset.top;\n                this.contentOffsetTop = getOffset(this.$refs.content).top;\n                setTimeout(() => {\n                    const contentScrollHeight = this.$refs.content.scrollHeight;\n                    const contentHeight = this.$refs.content.getBoundingClientRect().height;\n                    this.isFooterFixed = contentScrollHeight > contentHeight;\n                    const layoutOffsetLeft = this.$refs.layout.getBoundingClientRect().left;\n                    const offsetTargetOffsetLeft = document.querySelector('#templateStepRender').getBoundingClientRect().left;\n                    this.footerOffsetLeft = offsetTargetOffsetLeft - layoutOffsetLeft;\n                });\n            },\n            getBackTopTarget () {\n                return this.$refs.content;\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    @import \"@/css/mixins/scroll\";\n\n    .plan-action-layout {\n        position: relative;\n        padding-right: 24px;\n        padding-left: 24px;\n        overflow: hidden;\n        background: #fff;\n\n        .loading-wraper {\n            position: absolute;\n            top: 0;\n            left: 0;\n            z-index: 999;\n            width: 100%;\n            height: 100%;\n            padding-top: 40px;\n            padding-left: 40px;\n            background: #fff;\n            opacity: 100%;\n            visibility: visible;\n\n            &.loading-hidden {\n                opacity: 0%;\n                visibility: hidden;\n                transition: visibility 0.7s linear, opacity 0.5s linear;\n            }\n\n            .loading-content {\n                width: 580px;\n            }\n        }\n\n        .layout-title {\n            display: flex;\n            padding-top: 30px;\n            padding-bottom: 16px;\n            color: #000;\n            border-bottom: 1px solid #f0f1f5;\n\n            .title-text {\n                padding-bottom: 14px;\n                font-size: 18px;\n                line-height: 1;\n            }\n\n            .sub-title {\n                margin-left: auto;\n            }\n        }\n\n        .content-wraper {\n            padding-top: 24px;\n            padding-right: 40px;\n            margin-right: 2px;\n            overflow-y: auto;\n\n            @mixin scroller;\n        }\n\n        .layout-footer {\n            position: relative;\n            display: flex;\n            height: 60px;\n            margin-right: -24px;\n            margin-left: -24px;\n            background: #fff;\n            align-items: center;\n        }\n    }\n</style>\n","<template>\n    <div class=\"toggle-display\">\n        <div class=\"action\" @click=\"handleToggle\">\n            <template v-if=\"isOpen\">\n                <Icon type=\"angle-double-up\" class=\"toggle-arrow\" />\n                <span>{{ '收起未引用的变量' }} ({{ count }})</span>\n            </template>\n            <template v-else>\n                <Icon type=\"angle-double-down\" class=\"toggle-arrow\" />\n                <span>{{ '展开未引用的变量' }} ({{ count }})</span>\n            </template>\n        </div>\n        <div v-show=\"isOpen\">\n            <slot />\n        </div>\n    </div>\n</template>\n<script>\n    export default {\n        name: 'ToggleDisplay',\n        props: {\n            count: {\n                type: Number,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                isOpen: false,\n            };\n        },\n        methods: {\n            handleToggle () {\n                this.isOpen = !this.isOpen;\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .toggle-display {\n        .action {\n            display: flex;\n            align-items: center;\n            font-size: 14px;\n            line-height: 19px;\n            color: #3a84ff;\n            cursor: pointer;\n            user-select: none;\n        }\n\n        .toggle-arrow {\n            margin-right: 3px;\n            font-size: 12px;\n        }\n    }\n</style>\n","<template>\n    <div ref=\"box\" class=\"plan-edit-title\" @click.stop=\"\">\n        <div\n            v-if=\"isEditing\"\n            class=\"input-box\"\n            :class=\"{\n                'validate-error': !!errorInfo,\n            }\">\n            <jb-input\n                ref=\"input\"\n                v-model=\"localValue\"\n                :style=\"{\n                    width: `${inputWidth}px`,\n                }\"\n                :native-attributes=\"{\n                    spellcheck: false,\n                    autofocus: true,\n                }\"\n                :placeholder=\"'推荐按照该执行方案提供的使用场景来取名...'\"\n                enter-trigger\n                :maxlength=\"60\"\n                behavior=\"simplicity\"\n                @input=\"handleInput\"\n                @submit=\"handleSubmit\" />\n            <i\n                v-if=\"errorInfo\"\n                v-bk-tooltips=\"errorInfo\"\n                class=\"edit-status-flag bk-icon icon-exclamation-circle-shape\"\n                style=\"color: #ea3636;\" />\n            <Icon\n                v-if=\"isSubmiting\"\n                type=\"loading-circle\"\n                class=\"edit-status-flag rotate-loading\"\n                style=\"color: #979ba5;\" />\n        </div>\n        <div\n            v-else\n            ref=\"text\"\n            class=\"text\">\n            <span>{{ localValue }}</span>\n            <Icon\n                class=\"edit-btn\"\n                type=\"edit-2\"\n                @click=\"handleEdit\" />\n        </div>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import TaskPlanService from '@service/task-plan';\n       import { calcTextWidth, getOffset } from '@utils/assist';\n    import { planNameRule } from '@utils/validator';\n\n    export default {\n        name: '',\n        props: {\n            data: {\n                type: Object,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                isSubmiting: false,\n                isEditing: false,\n                inputWidth: 'auto',\n                localValue: '',\n                errorInfo: '',\n            };\n        },\n        watch: {\n            /**\n             * @desc 更新执行方案的名称\n             */\n            data: {\n                handler  () {\n                    this.localValue = this.data.name || '';\n                    this.localValueMemo = this.localValue;\n                },\n                immediate: true,\n            },\n        },\n        mounted () {\n            document.body.addEventListener('click', this.hideCallback);\n            this.$once('hook:beforeDestroy', () => {\n                document.body.removeEventListener('click', this.hideCallback);\n            });\n        },\n        methods: {\n            /**\n             * @desc 切换编辑状态\n             */\n            hideCallback () {\n                if (!this.isEditing) {\n                    return;\n                }\n                this.handleSubmit();\n            },\n            /**\n             * @desc 开始编辑\n             */\n            handleEdit () {\n                this.isSubmiting = false;\n                this.isEditing = true;\n                this.errorInfo = '';\n                this.inputWidth = this.$refs.text.getBoundingClientRect().width;\n                // 输入框自动获取焦点\n                setTimeout(() => {\n                    this.$refs.input.$el.querySelector('.bk-form-input').focus();\n                });\n            },\n            /**\n             * @desc 用户输入时自适应输入框宽度\n             * @param { String } value 输入值\n             */\n            handleInput: _.throttle(function (value) {\n                const windowClienWidth = window.innerWidth;\n                const offset = 60;\n                const width = calcTextWidth(value, this.$refs.box) + offset;\n                const { left } = getOffset(this.$refs.box);\n                const maxWidth = windowClienWidth - left - 230;\n                if (width <= maxWidth && width > this.inputWidth) {\n                    this.inputWidth = width;\n                }\n            }, 60),\n            /**\n             * @desc 提交编辑值\n             */\n            handleSubmit () {\n                this.errorInfo = '';\n                // 值没变\n                if (this.localValueMemo === this.localValue) {\n                    this.isEditing = false;\n                    return;\n                }\n                // 值检验\n                if (!this.localValue) {\n                    this.errorInfo = '方案名称必填';\n                } else if (!planNameRule.validator(this.localValue)) {\n                    this.errorInfo = planNameRule.message;\n                }\n                if (this.errorInfo) {\n                    return;\n                }\n                \n                this.isSubmiting = true;\n                // 重名检测\n                TaskPlanService.planCheckName({\n                    templateId: this.data.templateId,\n                    planId: this.data.id,\n                    name: this.localValue,\n                }).then((checkResult) => {\n                    if (!checkResult) {\n                        this.isSubmiting = false;\n                        this.errorInfo = '方案名称已存在，请重新输入';\n                        return;\n                    }\n                    \n                    TaskPlanService.planUpdate({\n                        id: this.data.id,\n                        templateId: this.data.templateId,\n                        name: this.localValue,\n                        variables: this.data.variableList,\n                        enableSteps: this.data.stepList.reduce((result, step) => {\n                            if (step.enable) {\n                                result.push(step.id);\n                            }\n                            return result;\n                        }, []),\n                    }).then(() => {\n                        this.localValueMemo = this.localValue;\n                        this.isEditing = false;\n                        this.$emit('on-edit-success');\n                        this.messageSuccess('执行方案名称编辑成功');\n                    });\n                });\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .plan-edit-title {\n        position: relative;\n        font-size: 14px;\n\n        .input-box {\n            position: relative;\n\n            .bk-form-input {\n                font-size: 14px;\n            }\n\n            &.validate-error {\n                .only-bottom-border {\n                    border-bottom-color: #ea3636 !important;\n                }\n            }\n\n            .edit-status-flag {\n                position: absolute;\n                top: 8px;\n                right: 8px;\n                z-index: 10;\n                font-size: 16px;\n            }\n        }\n\n        .text {\n            font-size: 18px;\n            line-height: 32px;\n            color: #313238;\n\n            .edit-btn {\n                font-size: 15px;\n                color: #979ba5;\n                cursor: pointer;\n            }\n        }\n    }\n</style>\n","<template>\n    <permission-section :key=\"id\">\n        <div class=\"task-plan-view-box\">\n            <layout\n                v-bind=\"$attrs\"\n                :title=\"planInfo.name\"\n                :plan-name=\"planInfo.name\"\n                :loading=\"isLoading\">\n                <div slot=\"title\" class=\"view-title\">\n                    <edit-title\n                        :data=\"planInfo\"\n                        @on-edit-success=\"handleEditSuccess\" />\n                    <span\n                        v-if=\"planInfo.cronJobCount > 0\"\n                        class=\"cron-job-tag\"\n                        v-bk-tooltips.html=\"`\n                            <div>${'有'} ${planInfo.cronJobCount} ${'个定时任务'}</div>\n                            <div>${'点击前往查看'}</div>\n                        `\"\n                        @click=\"handleGoCronList\">\n                        <Icon type=\"job-timing\" svg />\n                        <span style=\"margin-left: 2px;\">{{ planInfo.cronJobCount }}</span>\n                    </span>\n                </div>\n                <div slot=\"sub-title\" class=\"link-wraper\">\n                    <auth-button\n                        :resource-id=\"templateId\"\n                        auth=\"job_template/view\"\n                        text\n                        @click=\"handleGoTemplate\">\n                        <span>{{ '所属作业模板' }}</span>\n                        <Icon type=\"jump\" />\n                    </auth-button>\n                </div>\n                <jb-form form-type=\"vertical\">\n                    <jb-form-item\n                        :label=\"'全局变量'\"\n                        style=\"margin-bottom: 30px;\">\n                        <render-global-var\n                            :key=\"id\"\n                            :list=\"usedVariableList\"\n                            :default-field=\"'变量值'\" />\n                        <toggle-display\n                            v-if=\"unusedVariableList.length > 0\"\n                            :count=\"unusedVariableList.length\"\n                            style=\"margin-top: 20px;\">\n                            <render-global-var\n                                :key=\"id\"\n                                :list=\"unusedVariableList\"\n                                :default-field=\"'变量值'\"\n                                style=\"margin-top: 18px;\" />\n                        </toggle-display>\n                    </jb-form-item>\n                    <jb-form-item :label=\"'执行步骤'\">\n                        <render-task-step\n                            :key=\"id\"\n                            :list=\"planInfo.enableStepList\"\n                            :variable=\"planInfo.variableList\" />\n                    </jb-form-item>\n                </jb-form>\n                <template #footer>\n                    <div class=\"action-box\">\n                        <bk-button\n                            theme=\"primary\"\n                            class=\"w120 mr10\"\n                            :loading=\"execLoading\"\n                            @click=\"handleExec\"\n                            v-test=\"{ type: 'button', value: 'execPlan' }\">\n                            {{ '去执行' }}\n                        </bk-button>\n                        <bk-popover placement=\"top\">\n                            <auth-button\n                                class=\"mr10\"\n                                :permission=\"planInfo.canEdit\"\n                                :resource-id=\"id\"\n                                auth=\"job_plan/edit\"\n                                @click=\"handleEdit\"\n                                v-test=\"{ type: 'button', value: 'editPlan' }\">\n                                <span>{{ '编辑' }}</span>\n                                <span style=\"font-size: 12px; color: #979ba5;\">\n                                    ({{ planInfo.enableStepNums }}/{{ planInfo.templateStepNums }})\n                                </span>\n                            </auth-button>\n                            <div slot=\"content\">\n                                <p>{{ '共有' }} {{ planInfo.templateStepNums }} {{ '个步骤，' }}</p>\n                                <!-- eslint-disable-next-line max-len -->\n                                <p>{{ '当前已选中' }} {{ planInfo.enableStepNums }} {{ '个'}}</p>\n                            </div>\n                        </bk-popover>\n                        <auth-button\n                            class=\"mr10\"\n                            auth=\"cron/create\"\n                            @click=\"handleGoCron\"\n                            v-test=\"{ type: 'button', value: 'createCrontab' }\">\n                            {{ '定时执行' }}\n                        </auth-button>\n                        <span :tippy-tips=\"!planInfo.needUpdate ? '无需同步' : ''\">\n                            <auth-button\n                                class=\"action-update\"\n                                \n                                :resource-id=\"id\"\n                                auth=\"job_plan/sync\"\n                                @click=\"handleSync\"\n                                v-test=\"{ type: 'button', value: 'syncPlan' }\">\n                                <span>{{ '去同步' }}</span>\n                                <div v-if=\"planInfo.needUpdate\" class=\"update-flag\">\n                                    <Icon type=\"sync-8\" :tippy-tips=\"'未同步'\" />\n                                </div>\n                            </auth-button>\n                        </span>\n                        <jb-popover-confirm\n                            class=\"action-del\"\n                            :title=\"'确定删除该执行方案？'\"\n                            :content=\"'若已设置了定时任务，需要先删除才能操作'\"\n                            :confirm-handler=\"handleDelete\">\n                            <auth-button\n                                class=\"delete-btn\"\n                                :permission=\"planInfo.canDelete\"\n                                :resource-id=\"id\"\n                                auth=\"job_plan/delete\"\n                                v-test=\"{ type: 'button', value: 'deletePlan' }\">\n                                {{ '删除' }}\n                            </auth-button>\n                        </jb-popover-confirm>\n                    </div>\n                </template>\n            </layout>\n        </div>\n    </permission-section>\n</template>\n<script>\n       import TaskPlanService from '@service/task-plan';\n    import TaskExecuteService from '@service/task-execute';\n    import { findUsedVariable } from '@utils/assist';\n    import PermissionSection from '@components/apply-permission/apply-section';\n    import RenderGlobalVar from '../render-global-var';\n    import RenderTaskStep from '../render-task-step';\n    import Layout from './components/layout';\n    import ToggleDisplay from './components/toggle-display';\n    import EditTitle from './components/edit-title.vue';\n\n    export default {\n        name: '',\n        components: {\n            PermissionSection,\n            RenderGlobalVar,\n            RenderTaskStep,\n            ToggleDisplay,\n            Layout,\n            EditTitle,\n        },\n        props: {\n            id: {\n                type: [Number, String],\n                required: true,\n            },\n            templateId: {\n                type: [Number, String],\n                required: true,\n            },\n        },\n        data () {\n            return {\n                planInfo: {\n                    variableList: [{},{},{}],\n                    enableStepList: [{},{},{}],\n                },\n                usedVariableList: [{},{},{}],\n                unusedVariableList: [{},{},{}],\n                isLoading: true,\n                execLoading: false,\n                deleteLoading: false,\n            };\n        },\n        \n        watch: {\n            id: {\n                handler (value) {\n                    this.fetchData(value);\n                },\n                immediate: true,\n            },\n        },\n        methods: {\n            /**\n             * @desc 获取执行方案详情\n             */\n            fetchData () {\n                this.isLoading = true;\n                TaskPlanService.fetchPlanDetailInfo({\n                    id: this.id,\n                    templateId: this.templateId,\n                }, {\n                    permission: 'catch',\n                }).then((data) => {\n                    this.planInfo = Object.freeze(data);\n                    // 处理执行方案步骤中变量的使用情况\n                    const planStepList = data.stepList.filter(({ enable }) => enable === 1);\n                    const usedVariableNameMap = findUsedVariable(planStepList).reduce((result, variableName) => {\n                        result[variableName] = true;\n                        return result;\n                    }, {});\n\n                    const usedVariableList = [];\n                    const unusedVariableList = [];\n                    data.variableList.forEach((variable) => {\n                        if (usedVariableNameMap[variable.name]) {\n                            usedVariableList.push(variable);\n                        } else {\n                            unusedVariableList.push(variable);\n                        }\n                    });\n                    this.usedVariableList = Object.freeze(usedVariableList);\n                    this.unusedVariableList = Object.freeze(unusedVariableList);\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 立即执行执行方案\n             */\n            fetchTaskExecution () {\n                this.execLoading = true;\n                TaskExecuteService.taskExecution({\n                    taskId: this.id,\n                    taskVariables: [],\n                }).then(({ taskInstanceId }) => {\n                    this.$bkMessage({\n                        theme: 'success',\n                        message: '操作成功',\n                    });\n                    this.$router.push({\n                        name: 'historyTask',\n                        params: {\n                            id: taskInstanceId,\n                        },\n                        query: {\n                            from: this.$route.name,\n                        },\n                    });\n                })\n                    .finally(() => {\n                        this.execLoading = false;\n                    });\n            },\n            /**\n             * @desc 外部调用——刷新接口数据\n             */\n            refresh () {\n                this.fetchData();\n            },\n            /**\n             * @desc 编辑执行方案\n             */\n            handleEdit () {\n                this.$emit('on-edit', {\n                    id: this.templateId,\n                    active: this.id,\n                });\n            },\n            /**\n             * @desc 执行方案编辑成功\n             */\n            handleEditSuccess () {\n                this.$emit('on-edit-success');\n            },\n            /**\n             * @desc 查看执行方案关联的定时任务列表\n             */\n            handleGoCronList () {\n                const { href } = this.$router.resolve({\n                    name: 'cronList',\n                    query: {\n                        planId: this.id,\n                    },\n                });\n                window.open(href);\n            },\n            /**\n             * @desc 查看执行方案关联的作业模板详情\n             */\n            handleGoTemplate () {\n                const { href } = this.$router.resolve({\n                    name: 'templateDetail',\n                    params: {\n                        id: this.templateId,\n                    },\n                });\n                window.open(href);\n            },\n            /**\n             * 以当前执行方案新建定时任务\n             */\n            handleGoCron () {\n                const { href } = this.$router.resolve({\n                    name: 'cronList',\n                    query: {\n                        mode: 'create',\n                        templateId: this.templateId,\n                        planId: this.id,\n                    },\n                });\n                window.open(href);\n            },\n            /**\n             * @desc 删除执行方案\n             */\n            handleDelete () {\n                return TaskPlanService.planDelete({\n                    id: this.id,\n                    templateId: this.templateId,\n                }).then(() => {\n                    this.$bkMessage({\n                        theme: 'success',\n                        message: '操作成功',\n                    });\n                    setTimeout(() => {\n                        this.$emit('on-delete');\n                    });\n                    return true;\n                });\n            },\n            /**\n             * @desc 同步执行方案\n             */\n            handleSync () {\n                this.$router.push({\n                    name: 'syncPlan',\n                    params: {\n                        id: this.id,\n                        templateId: this.templateId,\n                    },\n                    query: {\n                        from: this.$route.name,\n                    },\n                });\n            },\n            /**\n             * @desc 执行\n             *\n             * 执行方案中没有变量——直接执行\n             * 执行方案中有变量——跳转到设置变量页面\n             */\n            handleExec () {\n                if (!this.planInfo.variableList.length) {\n                    this.$bkInfo({\n                        title: '确认执行？',\n                        subTitle: '未设置全局变量，点击确认将直接执行。',\n                        confirmFn: () => {\n                            this.fetchTaskExecution();\n                        },\n                    });\n                    return;\n                }\n                this.$router.push({\n                    name: 'settingVariable',\n                    params: {\n                        id: this.id,\n                        templateId: this.templateId,\n                    },\n                    query: {\n                        from: this.$route.name,\n                    },\n                });\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    @import \"@/css/mixins/media\";\n\n    .task-plan-view-box {\n        .view-title {\n            flex: 1;\n            display: flex;\n            align-items: center;\n\n            .cron-job-tag {\n                display: inline-flex;\n                display: flex;\n                height: 16px;\n                padding: 0 4px;\n                margin-left: 14px;\n                font-size: 12px;\n                color: #fff;\n                cursor: pointer;\n                background: #3a84ff;\n                border-radius: 8px;\n                user-select: none;\n                justify-content: center;\n                align-items: center;\n            }\n\n            .link-wraper {\n                display: flex;\n            }\n        }\n\n        .action-box {\n            display: flex;\n            width: 500px;\n\n            @media (--small-viewports) {\n                width: 500px;\n            }\n\n            @media (--medium-viewports) {\n                width: 560px;\n            }\n\n            @media (--large-viewports) {\n                width: 620px;\n            }\n\n            @media (--huge-viewports) {\n                width: 680px;\n            }\n        }\n\n        .action-update {\n            position: relative;\n\n            .update-flag {\n                position: absolute;\n                top: -10px;\n                right: -10px;\n                font-size: 16px;\n                line-height: 0;\n                color: #ea3636;\n                background: #fff;\n                border: 2px solid #fff;\n            }\n        }\n\n        .action-del {\n            margin-left: auto;\n        }\n\n        .delete-btn {\n            &:hover {\n                color: #fff;\n                background: #ea3636;\n                border-color: transparent;\n            }\n        }\n    }\n</style>\n","<template>\n    <layout\n        v-bind=\"$attrs\"\n        class=\"task-plan-edit-box\"\n        :plan-name=\"name\"\n        :loading=\"isLoading\">\n        <jb-form\n            slot=\"title\"\n            ref=\"titleForm\"\n            style=\"width: 100%;\"\n            :model=\"formData\">\n            <jb-form-item\n                :rules=\"rules.name\"\n                property=\"name\"\n                error-display-type=\"tooltips\"\n                style=\"margin-bottom: 0;\">\n                <jb-input\n                    v-model=\"formData.name\"\n                    class=\"name-input\"\n                    behavior=\"simplicity\"\n                    :placeholder=\"'推荐按照该执行方案提供的使用场景来取名...'\"\n                    :native-attributes=\"{\n                        spellcheck: false,\n                        autofocus: true,\n                    }\"\n                    :maxlength=\"60\" />\n            </jb-form-item>\n        </jb-form>\n        <jb-form\n            ref=\"editPlanForm\"\n            :model=\"formData\"\n            :rules=\"rules\"\n            form-type=\"vertical\"\n            v-test=\"{ type: 'form', value: 'editPlan' }\">\n            <jb-form-item style=\"margin-bottom: 40px;\">\n                <div class=\"section-title\">\n                    <span>{{ '全局变量' }}</span>\n                    <span>（ {{ selectedVariable.length }} / {{ globalVariableList.length }} ）</span>\n                </div>\n                <render-global-var\n                    :key=\"id\"\n                    :list=\"globalVariableList\"\n                    :select-value=\"selectedVariable\"\n                    @on-change=\"handleVariableChange\"\n                    :default-field=\"'变量值'\"\n                    mode=\"editOfPlan\" />\n            </jb-form-item>\n            <jb-form-item\n                :rules=\"rules.enableSteps\"\n                property=\"enableSteps\">\n                <div class=\"task-step-selection\">\n                    <div class=\"section-title\">\n                        <span>{{ '选择执行步骤' }}</span>\n                        <span>（ {{ formData.enableSteps.length }} / {{ taskStepList.length }} ）</span>\n                    </div>\n                    <div class=\"step-check\">\n                        <bk-button\n                            v-if=\"hasSelectAll\"\n                            text\n                            @click=\"handleDeselectAll\">\n                            {{ '取消全选' }}\n                        </bk-button>\n                        <bk-button\n                            v-else\n                            text\n                            @click=\"handleSelectAll\">\n                            {{ '全选' }}\n                        </bk-button>\n                    </div>\n                </div>\n                <render-task-step\n                    :key=\"id\"\n                    :list=\"taskStepList\"\n                    :select-value=\"formData.enableSteps\"\n                    :variable=\"globalVariableList\"\n                    mode=\"select\"\n                    @on-select=\"handleSelectStep\" />\n            </jb-form-item>\n        </jb-form>\n        <template #footer>\n            <span v-bk-tooltips=\"isSubmitDisable ? '请至少勾选一个执行步骤' : ''\">\n                <bk-button\n                    theme=\"primary\"\n                    class=\"w120 mr10\"\n                    \n                    :loading=\"submitLoading\"\n                    @click=\"handleSumbit\"\n                    v-test=\"{ type: 'button', value: 'editPlanSave' }\">\n                    {{ '保存' }}\n                </bk-button>\n            </span>\n            <bk-button\n                @click=\"handleCancle\"\n                v-test=\"{ type: 'button', value: 'editPlanCancel' }\">\n                {{ '取消' }}\n            </bk-button>\n        </template>\n    </layout>\n</template>\n<script>\n       import TaskPlanService from '@service/task-plan';\n    import {\n        findUsedVariable,\n        leaveConfirm,\n    } from '@utils/assist';\n    import { planNameRule } from '@utils/validator';\n    import RenderGlobalVar from '../../common/render-global-var';\n    import RenderTaskStep from '../../common/render-task-step';\n    import Layout from './components/layout';\n\n    const getDefaultData = () => ({\n        id: 0,\n        name: '',\n        enableSteps: [],\n        templateId: 0,\n        variables: [],\n    });\n\n    export default {\n        name: '',\n        components: {\n            Layout,\n            RenderGlobalVar,\n            RenderTaskStep,\n        },\n        props: {\n            id: {\n                type: [\n                    Number,\n                    String,\n                ],\n                required: true,\n            },\n            templateId: {\n                type: [\n                    Number,\n                    String,\n                ],\n                required: true,\n            },\n        },\n        data () {\n            return {\n                name: '',\n                formData: getDefaultData(),\n                globalVariableList: [{},{},{}],\n                taskStepList: [{},{},{}],\n                isLoading: true,\n                submitLoading: false,\n            };\n        },\n        computed: {\n            /**\n             * @desc 查找步骤中已使用的变量\n             * @return {Array}\n             */\n            selectedVariable () {\n                const selectedSteps = this.taskStepList.filter(step => this.formData.enableSteps.includes(step.id));\n                return findUsedVariable(selectedSteps);\n            },\n            /**\n             * @desc 已选中所有步骤\n             * @return {Boolean}\n             */\n            hasSelectAll () {\n                return this.formData.enableSteps.length >= this.taskStepList.length;\n            },\n            /**\n             * @desc 禁用提交按钮\n             * @returns { Boolean }\n             */\n            isSubmitDisable () {\n                return this.formData.enableSteps.length < 1;\n            },\n        },\n        watch: {\n            id: {\n                handler (value) {\n                    this.formData.id = value;\n                    this.fetchData();\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.rules = {\n                name: [\n                    {\n                        required: true,\n                        message: '方案名称必填',\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: planNameRule.validator,\n                        message: planNameRule.message,\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: name => TaskPlanService.planCheckName({\n                            templateId: this.templateId,\n                            planId: this.formData.id,\n                            name,\n                        }),\n                        message: '方案名称已存在，请重新输入',\n                        trigger: 'blur',\n                    },\n                ],\n                enableSteps: [\n                    {\n                        validator: () => this.formData.enableSteps.length,\n                        message: '执行步骤必填',\n                        trigger: 'blur',\n                    },\n                ],\n            };\n            \n            this.formData.templateId = this.templateId;\n        },\n        methods: {\n            /**\n             * @desc 获取执行方案详情\n             */\n            fetchData () {\n                this.isLoading = true;\n                TaskPlanService.fetchPlanEditInfo({\n                    id: this.formData.id,\n                    templateId: this.templateId,\n                }).then((data) => {\n                    const { variableList, stepList, name } = data;\n                    this.globalVariableList = variableList;\n                    this.taskStepList = stepList;\n                    \n                    this.name = name;\n                    this.formData.enableSteps = data.enableStepId;\n                    this.formData.variables = variableList;\n                    this.formData.name = name;\n                })\n                    .catch((error) => {\n                        if ([\n                            1,\n                            400,\n                        ].includes(error.code)) {\n                            setTimeout(() => {\n                                this.$router.push({\n                                    name: 'taskList',\n                                });\n                            }, 3000);\n                        }\n                    })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 外部调用——刷新接口数据\n             */\n            refresh () {\n                this.fetchData();\n            },\n            /**\n             * @desc 检测执行方案是否重名\n             * @param {String} name\n             */\n            checkName (name) {\n                return TaskPlanService.planCheckName({\n                    templateId: this.templateId,\n                    planId: this.formData.id,\n                    name,\n                });\n            },\n            /**\n             * @desc 编辑执行方案的变量\n             * @param {Array} variables\n             */\n            handleVariableChange (variables) {\n                window.changeAlert = true;\n                this.formData.variables = variables;\n            },\n            /**\n             * @desc 选中所有步骤\n             */\n            handleSelectAll () {\n                this.formData.enableSteps = this.taskStepList.map(item => item.id);\n            },\n            /**\n             * @desc 清空步骤的选中状态\n             */\n            handleDeselectAll () {\n                this.formData.enableSteps = [];\n            },\n            /**\n             * @desc 选中步骤\n             * @param {Object} stepData 步骤数据\n             */\n            handleSelectStep (stepData) {\n                const index = this.formData.enableSteps.findIndex(item => item === stepData.id);\n\n                if (index > -1) {\n                    this.formData.enableSteps.splice(index, 1);\n                    return;\n                }\n                \n                this.formData.enableSteps.push(stepData.id);\n\n                if (this.formData.enableSteps.length) {\n                    this.$refs.editPlanForm.clearError('enableSteps');\n                }\n            },\n            /**\n             * @desc 提交新建执行方案\n             */\n            handleSumbit () {\n                this.submitLoading = true;\n                Promise.all([\n                    this.$refs.titleForm.validate(),\n                    this.$refs.editPlanForm.validate(),\n                ]).then(() => TaskPlanService.planUpdate(this.formData)\n                    .then(() => {\n                        window.changeAlert = false;\n                        this.$emit('on-edit-success');\n                        this.$bkMessage({\n                            theme: 'success',\n                            message: '操作成功',\n                        });\n                        this.handleCancle();\n                    }))\n                    .finally(() => {\n                        this.submitLoading = false;\n                    });\n            },\n            /**\n             * @desc 取消编辑\n             */\n            handleCancle () {\n                leaveConfirm()\n                    .then(() => {\n                        this.$emit('on-edit-cancle');\n                    });\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    @import \"@/css/mixins/media\";\n\n    .task-plan-edit-box {\n        .variable-batch-action {\n            margin: 4px 0;\n        }\n\n        .layout-title {\n            padding-bottom: 0 !important;\n            border-bottom-color: transparent !important;\n\n            .name-input {\n                .bk-form-input {\n                    font-size: 18px;\n                    color: #313238;\n                }\n\n                .only-bottom-border {\n                    padding-top: 9px;\n                    padding-bottom: 16px;\n                    padding-left: 0;\n                }\n            }\n        }\n\n        .section-title {\n            font-size: 14px;\n            line-height: 19px;\n            color: #313238;\n        }\n\n        .task-step-selection {\n            display: flex;\n            width: 500px;\n            height: 19px;\n            margin-bottom: 16px;\n\n            @media (--small-viewports) {\n                width: 500px;\n            }\n\n            @media (--medium-viewports) {\n                width: 560px;\n            }\n\n            @media (--large-viewports) {\n                width: 620px;\n            }\n\n            @media (--huge-viewports) {\n                width: 680px;\n            }\n\n            .step-check {\n                margin-left: auto;\n            }\n        }\n    }\n\n</style>\n","<template>\n    <layout\n        class=\"task-plan-create-box\"\n        v-bind=\"$attrs\"\n        :loading=\"isLoading\">\n        <jb-form\n            slot=\"title\"\n            ref=\"titleForm\"\n            style=\"width: 100%;\"\n            :model=\"formData\">\n            <jb-form-item\n                :rules=\"rules.name\"\n                property=\"name\"\n                error-display-type=\"tooltips\"\n                style=\"margin-bottom: 0;\">\n                <jb-input\n                    v-model=\"formData.name\"\n                    class=\"name-input\"\n                    behavior=\"simplicity\"\n                    :placeholder=\"'推荐按照该执行方案提供的使用场景来取名...'\"\n                    :maxlength=\"60\"\n                    :native-attributes=\"{\n                        spellcheck: false,\n                        autofocus: true,\n                    }\"\n                    @change=\"handleNameChange\" />\n            </jb-form-item>\n        </jb-form>\n        <jb-form\n            ref=\"createPlanForm\"\n            :model=\"formData\"\n            form-type=\"vertical\">\n            <jb-form-item style=\"margin-bottom: 40px;\">\n                <div class=\"section-title\">\n                    <span>{{ '全局变量' }}</span>\n                    <span>（ {{ selectedVariable.length }} / {{ globalVariableList.length }} ）</span>\n                </div>\n                <render-global-var\n                    :key=\"templateId\"\n                    :list=\"globalVariableList\"\n                    :select-value=\"selectedVariable\"\n                    mode=\"editOfPlan\"\n                    :default-field=\"'变量值'\"\n                    @on-change=\"handleVariableChange\" />\n            </jb-form-item>\n            <jb-form-item\n                :rules=\"rules.enableSteps\"\n                property=\"enableSteps\">\n                <div class=\"task-step-selection\">\n                    <div class=\"section-title\">\n                        <span>{{ '选择执行步骤' }}</span>\n                        <span>（ {{ formData.enableSteps.length }} / {{ taskStepList.length }} ）</span>\n                    </div>\n                    <div class=\"step-check\">\n                        <bk-button\n                            v-if=\"hasSelectAll\"\n                            text\n                            @click=\"handleDeselectAll\">\n                            {{ '取消全选' }}\n                        </bk-button>\n                        <bk-button\n                            v-else\n                            text\n                            @click=\"handleSelectAll\">\n                            {{ '全选' }}\n                        </bk-button>\n                    </div>\n                </div>\n                <render-task-step\n                    :key=\"templateId\"\n                    :list=\"taskStepList\"\n                    :select-value=\"formData.enableSteps\"\n                    :variable=\"globalVariableList\"\n                    mode=\"select\"\n                    @on-select=\"handleSelectStep\" />\n            </jb-form-item>\n        </jb-form>\n        <template #footer>\n            <span v-bk-tooltips=\"isSubmitDisable ? '请至少勾选一个执行步骤' : ''\">\n                <bk-button\n                    theme=\"primary\"\n                    class=\"w120 mr10\"\n                    :loading=\"submitLoading\"\n                    \n                    @click=\"handleSumbit\"\n                    v-test=\"{ type: 'button', value: 'createPlanSubmit' }\">\n                    {{ '提交' }}\n                </bk-button>\n            </span>\n            <bk-button\n                @click=\"handleReset\"\n                v-test=\"{ type: 'button', value: 'createPlanReset' }\">\n                {{ '重置' }}\n            </bk-button>\n        </template>\n    </layout>\n</template>\n<script>\n       import TaskManageService from '@service/task-manage';\n    import ExecPlanService from '@service/task-plan';\n    import {\n        genDefaultName,\n        findUsedVariable,\n    } from '@utils/assist';\n    import { planNameRule } from '@utils/validator';\n    import JbForm from '@components/jb-form';\n    import RenderGlobalVar from '../../common/render-global-var';\n    import RenderTaskStep from '../../common/render-task-step';\n    import Layout from './components/layout';\n    \n    const getDefaultData = () => ({\n        id: 0,\n        name: genDefaultName('执行方案'),\n        enableSteps: [],\n        templateId: 0,\n        variables: [],\n    });\n    \n    export default {\n        name: '',\n        components: {\n            JbForm,\n            Layout,\n            RenderGlobalVar,\n            RenderTaskStep,\n        },\n        props: {\n            templateId: {\n                type: [\n                    Number,\n                    String,\n                ],\n                required: true,\n            },\n            firstPlan: {\n                type: Boolean,\n                default: true,\n            },\n        },\n        data () {\n            return {\n                formData: getDefaultData(),\n                globalVariableList: [{},{},{}],\n                taskStepList: [{},{},{}],\n                isLoading: true,\n                submitLoading: false,\n            };\n        },\n        computed: {\n            /**\n             * @desc 查找步骤中已使用的变量\n             * @return {Array}\n             */\n            selectedVariable () {\n                const selectedSteps = this.taskStepList.filter(step => this.formData.enableSteps.includes(step.id));\n                return findUsedVariable(selectedSteps);\n            },\n            /**\n             * @desc 已选中所有步骤\n             * @return {Boolean}\n             */\n            hasSelectAll () {\n                return this.formData.enableSteps.length >= this.taskStepList.length;\n            },\n            /**\n             * @desc 禁用提交按钮\n             * @returns { Boolean }\n             */\n            isSubmitDisable () {\n                return this.formData.enableSteps.length < 1;\n            },\n        },\n        created () {\n            this.rules = {\n                name: [\n                    {\n                        required: true,\n                        message: '方案名称必填',\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: planNameRule.validator,\n                        message: planNameRule.message,\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: name => ExecPlanService.planCheckName({\n                            templateId: this.formData.templateId,\n                            planId: this.formData.id,\n                            name,\n                        }),\n                        message: '方案名称已存在，请重新输入',\n                        trigger: 'blur',\n                    },\n                ],\n                enableSteps: [\n                    {\n                        validator: () => this.formData.enableSteps.length > 0,\n                        message: '执行步骤必填',\n                        trigger: 'blur',\n                    },\n                ],\n            };\n            this.formData.templateId = this.templateId;\n            this.generatorFormData = () => getDefaultData();\n            this.fetchData();\n        },\n        methods: {\n            /**\n             * @desc 获取选中模板的信息\n             *\n             * 如果模板关联的执行方案为空，初始化执行方案的 name 为作业模板的 name\n             */\n            fetchData () {\n                TaskManageService.taskDetail({\n                    id: this.formData.templateId,\n                }).then((data) => {\n                    const { variables, stepList, name } = data;\n                    this.globalVariableList = Object.freeze(variables);\n                    this.taskStepList = Object.freeze(stepList);\n                    \n                    // 新建执行方案默认值处理\n                    let planName = genDefaultName('执行方案');\n                    if (this.firstPlan) {\n                        // 第一个执行方案名默认和模板名相同\n                        planName = name;\n                    }\n                    this.generatorFormData = () => ({\n                        id: 0,\n                        name: planName,\n                        templateId: this.formData.templateId,\n                        enableSteps: stepList.map(item => item.id),\n                        variables: [\n                            ...variables,\n                        ],\n                    });\n                    this.$emit('on-name-change', planName);\n                    // 初始化新建执行方案\n                    this.formData = this.generatorFormData();\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 外部调用——刷新接口数据\n             */\n            refresh () {\n                this.fetchData();\n            },\n            /**\n             * @desc 执行方案名更新\n             * @param {String} name\n             */\n            handleNameChange (name) {\n                this.formData.name = name;\n                this.$emit('on-name-change', name);\n            },\n            /**\n             * @desc 选中所有步骤\n             */\n            handleSelectAll () {\n                this.formData.enableSteps = this.taskStepList.map(item => item.id);\n            },\n            /**\n             * @desc 清空步骤的选中状态\n             */\n            handleDeselectAll () {\n                this.formData.enableSteps = [];\n            },\n            /**\n             * @desc 编辑执行方案的变量\n             * @param {Array} variables\n             */\n            handleVariableChange (variables) {\n                this.formData.variables = variables;\n            },\n            /**\n             * @desc 选中步骤\n             * @param {Object} stepData 步骤数据\n             */\n            handleSelectStep (stepData) {\n                const index = this.formData.enableSteps.findIndex(item => item === stepData.id);\n\n                if (index > -1) {\n                    this.formData.enableSteps.splice(index, 1);\n                    return;\n                }\n\n                this.formData.enableSteps.push(stepData.id);\n\n                if (this.formData.enableSteps.length) {\n                    this.$refs.createPlanForm.clearError('enableSteps');\n                }\n            },\n            /**\n             * @desc 提交新建执行方案\n             */\n            handleSumbit () {\n                this.submitLoading = true;\n                Promise.all([\n                    this.$refs.titleForm.validate(),\n                    this.$refs.createPlanForm.validate(),\n                ]).then(() => ExecPlanService.planUpdate(this.formData)\n                    .then((data) => {\n                        window.changeAlert = false;\n                        this.$bkMessage({\n                            theme: 'success',\n                            message: '操作成功',\n                        });\n                        this.$emit('on-create', data);\n                    }))\n                    .finally(() => {\n                        this.submitLoading = false;\n                    });\n            },\n            /**\n             * @desc 重置表单数据\n             */\n            handleReset () {\n                this.formData = this.generatorFormData();\n                this.$refs.createPlanForm.clearError();\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    @import \"@/css/mixins/media\";\n\n    .task-plan-create-box {\n        .variable-batch-action {\n            margin: 4px 0;\n        }\n\n        .layout-title {\n            padding-bottom: 0 !important;\n            border-bottom-color: transparent !important;\n\n            .name-input {\n                .bk-form-input {\n                    font-size: 18px;\n                    color: #313238;\n                }\n\n                .only-bottom-border {\n                    padding-top: 9px;\n                    padding-bottom: 16px;\n                    padding-left: 0;\n                }\n            }\n        }\n\n        .section-title {\n            font-size: 14px;\n            line-height: 19px;\n            color: #313238;\n        }\n\n        .task-step-selection {\n            display: flex;\n            width: 500px;\n            margin-bottom: 14px;\n            font-size: 16px;\n            line-height: 21px;\n            color: #313238;\n\n            @media (--small-viewports) {\n                width: 500px;\n            }\n\n            @media (--medium-viewports) {\n                width: 560px;\n            }\n\n            @media (--large-viewports) {\n                width: 620px;\n            }\n\n            @media (--huge-viewports) {\n                width: 680px;\n            }\n\n            .step-check {\n                margin-left: auto;\n            }\n        }\n    }\n</style>\n","<template>\n    <div ref=\"layout\" class=\"plan-list-page-layout\" :class=\"{ toggled: isOpen }\">\n        <div class=\"layout-left\">\n            <div class=\"left-wraper\" :style=\"styles\">\n                <slot />\n            </div>\n            <div v-if=\"flod\" class=\"toggle-button\" @click=\"handleToggle\">\n                <Icon type=\"down-small\" class=\"toggle-arrow\" />\n            </div>\n        </div>\n        <div v-if=\"flod\" class=\"layout-right\">\n            <div class=\"right-wraper\" :class=\"{ active: isShowRight }\">\n                <slot v-if=\"isShowRight\" name=\"flod\" />\n            </div>\n            <div class=\"close-btn\" @click=\"handleClose\">\n                <Icon type=\"close-big\" />\n            </div>\n        </div>\n    </div>\n</template>\n<script>\n    import {\n        leaveConfirm,\n    } from '@utils/assist';\n\n    export default {\n        name: '',\n        props: {\n            flod: {\n                type: Boolean,\n                default: false,\n            },\n        },\n        data () {\n            return {\n                isShowRight: false,\n                isOpen: false,\n                layoutWidth: 'auto',\n            };\n        },\n        computed: {\n            styles () {\n                if (this.flod) {\n                    return {\n                        width: '370px',\n                    };\n                }\n                return {\n                    width: this.layoutWidth,\n                };\n            },\n        },\n        watch: {\n            flod: {\n                handler (flod) {\n                    if (flod) {\n                        setTimeout(() => {\n                            this.isShowRight = flod;\n                        }, 110);\n                    } else {\n                        this.isShowRight = false;\n                    }\n                },\n                immediate: true,\n            },\n        },\n        mounted () {\n            this.calcWidth();\n            window.addEventListener('resize', this.calcWidth);\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('resize', this.calcWidth);\n            });\n        },\n        methods: {\n            calcWidth () {\n                const layoutWidth = this.$refs.layout.getBoundingClientRect().width;\n                this.layoutWidth = `${layoutWidth}px`;\n            },\n            handleToggle () {\n                this.isOpen = !this.isOpen;\n            },\n            handleClose () {\n                leaveConfirm()\n                    .then(() => {\n                        this.isOpen = false;\n                        this.$emit('on-flod');\n                        this.$emit('update:flod', false);\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .plan-list-page-layout {\n        display: flex;\n\n        &.toggled {\n            margin-left: -24px;\n\n            .left-wraper {\n                width: 0 !important;\n            }\n\n            .toggle-button {\n                .toggle-arrow {\n                    transform: rotateZ(-90deg);\n                }\n            }\n\n            .layout-right {\n                margin-left: 24px;\n            }\n        }\n\n        .layout-left {\n            position: relative;\n            z-index: 9;\n            background: #fff;\n            border: 1px solid #dfe0e5;\n            transition: all 0.15s;\n            flex: 0 0 auto;\n\n            .left-wraper {\n                transition: all 0.1s;\n            }\n\n            .bk-table::before {\n                content: unset;\n            }\n\n            .toggle-button {\n                position: absolute;\n                top: 50%;\n                right: -14px;\n                display: flex;\n                width: 14px;\n                height: 64px;\n                font-size: 24px;\n                color: #fff;\n                cursor: pointer;\n                background: #dcdee5;\n                border-top-right-radius: 6px;\n                border-bottom-right-radius: 6px;\n                transform: translateY(-50%);\n                align-items: center;\n                justify-content: center;\n\n                &:hover {\n                    background: #c4c6cc;\n                }\n            }\n\n            .toggle-arrow {\n                transform: rotateZ(90deg);\n            }\n        }\n\n        .layout-right {\n            position: relative;\n            z-index: 1;\n            margin-left: 10px;\n            background: #fff;\n            border: 1px solid #dfe0e5;\n            border-radius: 2px;\n            transition: all 0.15s;\n            flex: 1;\n\n            .right-wraper {\n                opacity: 0%;\n                transition: all 0.5s;\n\n                &.active {\n                    opacity: 100%;\n                }\n            }\n\n            .close-btn {\n                position: absolute;\n                top: 8px;\n                right: 8px;\n                display: flex;\n                width: 26px;\n                height: 26px;\n                font-size: 16px;\n                color: #c4c6cc;\n                cursor: pointer;\n                border-radius: 50%;\n                align-items: center;\n                justify-content: center;\n\n                &:hover {\n                    background-color: #f0f1f5;\n                }\n            }\n        }\n    }\n</style>\n","<template>\n    <jb-dialog\n        :value=\"value\"\n        class=\"template-select-dialog\"\n        :title=\"'新建执行方案'\"\n        header-position=\"left\"\n        render-directive=\"if\"\n        :mask-close=\"false\"\n        :esc-close=\"false\"\n        :width=\"480\"\n        :draggable=\"false\"\n        @cancel=\"handleCancel\">\n        <jb-form ref=\"form\" :model=\"formData\" form-type=\"vertical\" :rules=\"rules\">\n            <jb-form-item :label=\"'作业模板'\" required property=\"templateId\">\n                <bk-select\n                    v-model=\"formData.templateId\"\n                    :placeholder=\"'请选择作业模板'\"\n                    :clearable=\"false\"\n                    searchable\n                    :remote-method=\"fetchData\">\n                    <bk-option\n                        v-for=\"item in templateList\"\n                        :key=\"item.id\"\n                        :id=\"item.id\"\n                        :name=\"item.name\" />\n                    <template slot=\"extension\">\n                        <auth-component auth=\"job_template/create\">\n                            <div @click=\"handleCreate\" style=\"cursor: pointer;\">\n                                <i class=\"bk-icon icon-plus-circle\" />{{ '新建模板' }}\n                            </div>\n                            <div slot=\"forbid\">\n                                <i class=\"bk-icon icon-plus-circle\" />{{ '新建模板' }}\n                            </div>\n                        </auth-component>\n                    </template>\n                </bk-select>\n            </jb-form-item>\n        </jb-form>\n        <div slot=\"footer\">\n            <auth-button\n                :resource-id=\"formData.templateId\"\n                :auth=\"formData.templateId ? 'job_plan/create' : ''\"\n                theme=\"primary\"\n                \n                class=\"mr10\"\n                @click=\"handleSubmit\">\n                {{ '确定' }}\n            </auth-button>\n            <bk-button @click=\"handleCancel\">{{ '取消' }}</bk-button>\n        </div>\n    </jb-dialog>\n</template>\n<script>\n       import TaskManageService from '@service/task-manage';\n    import {\n        leaveConfirm,\n    } from '@utils/assist';\n\n    export default {\n        name: '',\n        props: {\n            value: {\n                type: Boolean,\n                default: false,\n            },\n        },\n        data () {\n            return {\n                templateList: [{},{},{}],\n                formData: {\n                    templateId: '',\n                },\n            };\n        },\n        watch: {\n            value: {\n                handler  (value) {\n                    if (value) {\n                        this.fetchData();\n                    }\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.rules = {\n                templateId: [\n                    {\n                        required: true,\n                        message: '请选择作业模板',\n                        trigger: 'blur',\n                    },\n                ],\n            };\n        },\n        methods: {\n            fetchData (search) {\n                TaskManageService.taskList({\n                    name: search,\n                    start: 0,\n                    pageSize: 10,\n                }).then((data) => {\n                    this.templateList = Object.freeze(data.data);\n                });\n            },\n            handleCreate () {\n                const router = this.$router.resolve({\n                    name: 'templateCreate',\n                });\n                window.open(router.href);\n            },\n            handleSubmit () {\n                this.$refs.form.validate()\n                    .then(() => {\n                        window.changeAlert = false;\n                        this.handleCancel();\n                        this.$emit('on-change', this.formData.templateId);\n                    });\n            },\n            handleCancel () {\n                leaveConfirm()\n                    .then(() => {\n                        this.$emit('input', false);\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .template-select-dialog {\n        .bk-dialog-header {\n            padding-bottom: 0 !important;\n        }\n\n        .bk-form-item:last-child {\n            margin-bottom: 0 !important;\n        }\n    }\n</style>\n","<template>\n    <div>\n        <div class=\"name\">\n            <span>{{ data.name }}</span>\n            <span class=\"remove-flag\" @click=\"handleRemove\">\n                <Icon type=\"reduce-fill\" />\n            </span>\n        </div>\n        <div>\n            <bk-button v-if=\"isValueEmpty\" @click=\"handleChooseIp\" style=\"width: 160px;\">\n                <Icon type=\"plus\" />\n                {{ '添加服务器' }}\n            </bk-button>\n            <div v-else class=\"host-value-text\" @click=\"handleChooseIp\">\n                <div class=\"host-type\">\n                    <Icon type=\"host\" />\n                </div>\n                <div>\n                    {{ valueText }}\n                </div>\n                <Icon class=\"host-edit\" type=\"edit-2\" />\n            </div>\n        </div>\n        <choose-ip\n            v-model=\"isShowChooseIp\"\n            :host-node-info=\"hostNodeInfo\"\n            @on-change=\"handleChange\" />\n    </div>\n</template>\n<script>\n    import TaskHostNodeModel from '@model/task-host-node';\n    import ChooseIp from '@components/choose-ip';\n\n    export default {\n        components: {\n            ChooseIp,\n        },\n        props: {\n            data: {\n                type: Object,\n                required: true,\n            },\n            value: {\n                type: Object,\n                default: () => new TaskHostNodeModel({}),\n            },\n        },\n        data () {\n            return {\n                isShowChooseIp: false,\n                hostNodeInfo: {},\n            };\n        },\n        computed: {\n            isValueEmpty () {\n                return TaskHostNodeModel.isHostNodeInfoEmpty(this.value.hostNodeInfo);\n            },\n            valueText  () {\n                return new TaskHostNodeModel(this.value).text;\n            },\n        },\n        \n        methods: {\n            handleRemove () {\n                this.$emit('on-remove');\n            },\n            handleChooseIp () {\n                this.isShowChooseIp = true;\n                this.hostNodeInfo = this.value.hostNodeInfo;\n            },\n            handleClear () {\n                this.$emit('on-change', new TaskHostNodeModel({}));\n            },\n            handleChange (hostNodeInfo) {\n                this.$emit('on-change', {\n                    hostNodeInfo,\n                });\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .host-value-text {\n        display: flex;\n        width: 333px;\n        height: 32px;\n        overflow: hidden;\n        font-size: 12px;\n        color: #63656e;\n        cursor: pointer;\n        background: #fff;\n        border: 1px solid #c4c6cc;\n        border-radius: 3px;\n        transition: all 0.1s;\n        align-items: center;\n\n        .host-type {\n            display: flex;\n            width: 32px;\n            height: 32px;\n            margin-right: 10px;\n            font-size: 17px;\n            color: #fff;\n            background: #c4c6cc;\n            transition: all 0.1s;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .host-edit {\n            margin-right: 8px;\n            margin-left: auto;\n            font-size: 16px;\n            color: #3a84ff;\n            opacity: 0%;\n        }\n\n        &:hover {\n            border-color: #3a84ff;\n\n            .host-type {\n                background: #3a84ff;\n            }\n\n            .host-edit {\n                opacity: 100%;\n            }\n        }\n    }\n</style>\n","<template>\n    <comoponent\n        :is=\"com\"\n        class=\"global-variable-batch-edit-render\"\n        :data=\"data\"\n        v-bind=\"$attrs\"\n        v-on=\"$listeners\" />\n</template>\n<script>\n    import GlobalVariableModel from '@model/task/global-variable';\n    import TextType from './text';\n    import HostType from './host';\n    import PasswordType from './password';\n\n    export default {\n        name: '',\n        props: {\n            data: {\n                type: Object,\n                required: true,\n            },\n        },\n        data () {\n            return {};\n        },\n        computed: {\n            com () {\n                const comMap = {\n                    [GlobalVariableModel.TYPE_STRING]: TextType,\n                    [GlobalVariableModel.TYPE_NAMESPACE]: TextType,\n                    [GlobalVariableModel.TYPE_PASSWORD]: PasswordType,\n                    [GlobalVariableModel.TYPE_RELATE_ARRAY]: TextType,\n                    [GlobalVariableModel.TYPE_INDEX_ARRAY]: TextType,\n                    [GlobalVariableModel.TYPE_HOST]: HostType,\n                };\n                return comMap[this.data.type];\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .global-variable-batch-edit-render {\n        margin-bottom: 20px;\n\n        &:last-child {\n            margin-bottom: 0;\n        }\n\n        .remove-flag {\n            display: none;\n            padding: 10px 10px 10px 4px;\n            font-size: 14px;\n            color: #c4c6cc;\n            cursor: pointer;\n\n            &:hover {\n                color: #ea3636;\n            }\n        }\n\n        &:hover {\n            .remove-flag {\n                display: inline;\n            }\n        }\n\n        .name {\n            margin-bottom: 10px;\n            font-size: 14px;\n            line-height: 19px;\n            color: #63656e;\n        }\n    }\n</style>\n","<template>\n    <div class=\"batch-edit-plan-global-variable\">\n        <div class=\"action-target-info\">\n            <span class=\"label\">{{ '更新范围' }}</span>\n            <span class=\"content-split\">:</span>\n            <span>\n                <span>{{ '已选' }}</span>\n                <span class=\"number strong\">{{ planList.length }}</span>\n                <span>{{ '个执行方案，' }}{{ '来自' }}</span>\n                <span class=\"number strong\">{{ relatedTemplateNums }}</span>\n                <span>{{ '个作业模板' }}</span>\n            </span>\n        </div>\n        <div class=\"action-target-info\" style=\"margin-top: 10px;\">\n            <span class=\"label\">{{ '选择变量' }}</span>\n            <span class=\"content-split\" style=\"color: #ea3636;\">*</span>\n            <span>{{ selectResultText }}，</span>\n            <bk-button v-if=\"isHasSelectedAll\" text @click=\"handleCancleSelectAll\">{{ '取消全选' }}</bk-button>\n            <bk-button v-else text @click=\"handleSelectAll\">{{ '全选' }}</bk-button>\n        </div>\n        <div class=\"global-variable-list\">\n            <div\n                v-for=\"(variableData, key) in globalVariableMap\"\n                :key=\"key\"\n                class=\"variable-item\"\n                :class=\"{ active: !!selectVariableMap[key] }\"\n                @click=\"handleVariableSelect(key)\">\n                <div class=\"variable-type\">\n                    <Icon :type=\"variableData.icon\" />\n                </div>\n                <div v-bk-overflow-tips class=\"variable-name\">{{ variableData.name }}</div>\n                <div class=\"select-checked\" />\n            </div>\n        </div>\n        <div v-if=\"isSelectNotEmpty\" class=\"global-variable-value\">\n            <template v-for=\"(variableData, key) in globalVariableMap\">\n                <render-global-variable\n                    v-if=\"selectVariableMap[key]\"\n                    :key=\"key\"\n                    :value=\"selectVariableValueMap[key]\"\n                    :data=\"variableData\"\n                    @on-change=\"value => handleValueChange(key, value)\"\n                    @on-remove=\"handleRemoveSelect(key)\" />\n            </template>\n        </div>\n    </div>\n</template>\n<script>\n       import TaskHostNodeModel from '@model/task-host-node';\n    import RenderGlobalVariable from './components/render-global-variable';\n    import {\n        genGlobalVariableKey,\n    } from '../utils';\n\n    export default {\n        name: '',\n        components: {\n            RenderGlobalVariable,\n        },\n        inheritAttrs: false,\n        props: {\n            planList: {\n                type: Array,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                relatedTemplateNums: 0,\n                globalVariableMap: {},\n                selectVariableMap: {},\n                selectVariableValueMap: {},\n            };\n        },\n        computed: {\n            isHasSelectedAll () {\n                const selectNums = Object.values(this.selectVariableMap).length;\n                if (selectNums < 1) {\n                    return false;\n                }\n                return selectNums === Object.values(this.globalVariableMap).length;\n            },\n            selectResultText () {\n                return `${'已选'} ${Object.values(this.selectVariableMap).length} / ${Object.values(this.globalVariableMap).length}`;\n            },\n            isSelectNotEmpty () {\n                return Object.values(this.selectVariableMap).length > 0;\n            },\n        },\n        created () {\n            this.traverPlanList();\n        },\n        methods: {\n            /**\n             * @desc 遍历执行方案全局变量\n             */\n            traverPlanList () {\n                const templateIdMap = {};\n                const globalVariableMap = {};\n                this.planList.forEach((planData) => {\n                    templateIdMap[planData.templateId] = true;\n                    planData.variableList.forEach((variableData) => {\n                        globalVariableMap[genGlobalVariableKey(variableData)] = variableData;\n                    });\n                });\n               \n                this.relatedTemplateNums = Object.values(templateIdMap).length;\n                this.globalVariableMap = Object.freeze(globalVariableMap);\n            },\n            /**\n             * @desc 编辑全局变量值更新\n             */\n            triggerChange () {\n                window.changeAlert = true;\n                this.$emit('on-edit-change', Object.assign({}, this.selectVariableValueMap));\n            },\n            /**\n             * @desc 外部调用，获取需要更新的执行方案\n             * @return {Object} 需要更新的执行方案列表\n             */\n            getEditValue () {\n                return Object.assign({}, this.selectVariableValueMap);\n            },\n            /**\n             * @desc 单次选中全局变量\n             * @param {String} key 全局变量的key\n             */\n            handleVariableSelect (key) {\n                const selectVariableMap = Object.assign({}, this.selectVariableMap);\n                const selectVariableValueMap = Object.assign({}, this.selectVariableValueMap);\n                if (selectVariableMap[key]) {\n                    // 删除选择\n                    delete selectVariableMap[key];\n                    // 删除值\n                    delete selectVariableValueMap[key];\n                } else {\n                    // 选中变量\n                    selectVariableMap[key] = true;\n                    // 初始化选中变量值\n                    if (this.globalVariableMap[key].isHost) {\n                        selectVariableValueMap[key] = new TaskHostNodeModel({});\n                    } else {\n                        selectVariableValueMap[key] = '';\n                    }\n                }\n                this.selectVariableMap = Object.freeze(selectVariableMap);\n                this.selectVariableValueMap = Object.freeze(selectVariableValueMap);\n                this.triggerChange();\n            },\n            /**\n             * @desc 全选全局变量\n             */\n            handleSelectAll () {\n                const selectVariableMap = {};\n                const selectVariableValueMap = {};\n                for (const key in this.globalVariableMap) {\n                    // 选中变量\n                    selectVariableMap[key] = true;\n                    // 初始化选中变量值\n                    if (this.globalVariableMap[key].isHost) {\n                        selectVariableValueMap[key] = new TaskHostNodeModel({});\n                    } else {\n                        selectVariableValueMap[key] = '';\n                    }\n                }\n                this.selectVariableMap = Object.freeze(selectVariableMap);\n                this.selectVariableValueMap = Object.freeze(selectVariableValueMap);\n                this.triggerChange();\n            },\n            /**\n             * @desc 取消全选全局变量\n             */\n            handleCancleSelectAll () {\n                // 删除选择\n                this.selectVariableMap = {};\n                // 删除值\n                this.selectVariableValueMap = {};\n                this.triggerChange();\n            },\n            /**\n             * @desc 取消选择单个全局变量\n             * @param {String} key 全局变量的key\n             *\n             * 取消选择时需要清除已编辑的值\n             */\n            handleRemoveSelect (key) {\n                // 删除选择\n                const selectVariableMap = Object.assign({}, this.selectVariableMap);\n                delete selectVariableMap[key];\n                this.selectVariableMap = Object.freeze(selectVariableMap);\n                // 删除值\n                const selectVariableValueMap = Object.assign({}, this.selectVariableValueMap);\n                delete selectVariableValueMap[key];\n                this.selectVariableValueMap = Object.freeze(selectVariableValueMap);\n                this.triggerChange();\n            },\n            /**\n             * @desc 编辑单个全局变量的值\n             * @param {String} key 全局变量的key\n             * @param {Any} value 全局变量的value\n             */\n            handleValueChange (key, value) {\n                this.selectVariableValueMap = Object.freeze(Object.assign({}, this.selectVariableValueMap, {\n                    [key]: value,\n                }));\n                this.triggerChange();\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .batch-edit-plan-global-variable {\n        .action-target-info {\n            display: flex;\n            padding-top: 20px;\n            font-size: 14px;\n            line-height: 20px;\n            color: #63656e;\n\n            .label {\n                color: #313238;\n            }\n\n            .content-split {\n                width: 18px;\n                text-align: left;\n            }\n        }\n\n        .global-variable-list {\n            display: flex;\n            flex-wrap: wrap;\n            padding-top: 4px;\n            margin: 0 -5px;\n\n            .variable-item {\n                position: relative;\n                display: flex;\n                width: 160px;\n                height: 32px;\n                padding-right: 26px;\n                margin-top: 12px;\n                margin-right: 5px;\n                margin-left: 5px;\n                overflow: hidden;\n                color: #63656e;\n                cursor: pointer;\n                border: 1px solid #dcdee5;\n                border-radius: 2px;\n                transition: all 0.1s;\n                align-items: center;\n\n                .variable-type {\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    flex: 0 0 32px;\n                    height: 100%;\n                    margin-left: -1px;\n                    font-size: 17px;\n                    color: #fff;\n                    background: #d3d5db;\n                    transition: all 0.1s;\n                }\n\n                .select-checked {\n                    position: absolute;\n                    top: 9px;\n                    right: 6px;\n                    bottom: 0;\n                    width: 14px;\n                    height: 14px;\n                    background: #fff;\n                    border: 1px solid #c4c6cc;\n                    border-radius: 50%;\n                }\n\n                &.active {\n                    border-color: #3a84ff;\n\n                    .variable-type {\n                        background: #3a84ff;\n                    }\n\n                    .select-checked {\n                        background: #3a84ff;\n                        border-color: #3a84ff;\n\n                        &::after {\n                            position: absolute;\n                            top: 2px;\n                            left: 4px;\n                            width: 3px;\n                            height: 6px;\n                            border: 1px solid #fff;\n                            border-top: 0;\n                            border-left: 0;\n                            content: \"\";\n                            transform: rotate(45deg) scale(1);\n                            transition: all 0.1s;\n                            transform-origin: center;\n                        }\n                    }\n                }\n            }\n\n            .variable-name {\n                padding-left: 6px;\n                overflow: hidden;\n                font-size: 13px;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n                flex: 0 1 auto;\n                align-items: center;\n            }\n        }\n\n        .global-variable-value {\n            margin-top: 30px;\n        }\n    }\n</style>\n","<template>\n    <div class=\"preview-render-ralated\">\n        <div class=\"header\" @click=\"handleToggle\">\n            <div class=\"toggle-flag\">\n                <Icon v-if=\"isShowRelateList\" type=\"arrow-full-down\" />\n                <Icon v-else type=\"arrow-full-right\" />\n            </div>\n            <div class=\"type\">\n                <Icon :type=\"globalVariableInfo.icon\" />\n            </div>\n            <div class=\"name\">{{ globalVariableInfo.name }}</div>\n        </div>\n        <table v-if=\"isShowRelateList\">\n            <thead>\n                <tr>\n                    <th style=\"width: 230px;\">{{ '执行方案' }}</th>\n                    <th style=\"width: 205px;\">{{ '作业模板' }}</th>\n                    <th style=\"width: 185px;\">{{ '原始值' }}</th>\n                    <th>{{ '更新值' }}</th>\n                </tr>\n            </thead>\n            <tbody>\n                <tr v-for=\"relateData in relateList\" :key=\"relateData.id\">\n                    <td>\n                        <div v-bk-overflow-tips class=\"cell-text\">{{ relateData.plan.name }}</div>\n                    </td>\n                    <td>\n                        <div v-bk-overflow-tips class=\"cell-text\">{{ relateData.plan.templateName }}</div>\n                    </td>\n                    <td>\n                        <div v-bk-overflow-tips class=\"cell-text\">{{ relateData.globalVariable.valueText }}</div>\n                    </td>\n                    <td>\n                        <div v-bk-overflow-tips class=\"cell-text\">{{ latestValueText }}</div>\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n</template>\n<script>\n    import GlobalVariableModel from '@model/task/global-variable';\n\n    export default {\n        name: '',\n        props: {\n            relateList: Array,\n            latestValue: [String, Object],\n        },\n        data () {\n            return {\n                isShowRelateList: false,\n            };\n        },\n        computed: {\n            globalVariableInfo () {\n                return this.relateList[0].globalVariable;\n            },\n            latestValueText () {\n                const latestGlobalVariableData = { ...this.globalVariableInfo };\n                if (this.globalVariableInfo.isHost) {\n                    latestGlobalVariableData.defaultTargetValue = this.latestValue;\n                } else {\n                    latestGlobalVariableData.defaultValue = this.latestValue;\n                }\n                return new GlobalVariableModel(latestGlobalVariableData).valueText;\n            },\n        },\n        methods: {\n            handleToggle () {\n                this.isShowRelateList = !this.isShowRelateList;\n            },\n        },\n    };\n</script>\n<style lang='postcss' scoped>\n    .preview-render-ralated {\n        margin-top: 13px;\n        border-radius: 2px;\n\n        .header {\n            display: flex;\n            height: 42px;\n            padding: 0 10px;\n            color: #979ba5;\n            cursor: pointer;\n            background: #dcdee5;\n            align-items: center;\n\n            .toggle-flag {\n                display: flex;\n                width: 24px;\n                height: 24px;\n                font-size: 16px;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .type {\n                font-size: 19px;\n            }\n\n            .name {\n                padding-left: 5px;\n                font-size: 14px;\n                font-weight: bold;\n                color: #63656e;\n            }\n        }\n\n        table {\n            width: 100%;\n            color: #63656e;\n            border: 1px solid #dcdee5;\n            border-radius: 2px;\n\n            thead {\n                background: #fafbfd;\n            }\n\n            td,\n            th {\n                height: 40px;\n                padding: 0 10px;\n                text-align: left;\n            }\n\n            th {\n                font-weight: normal;\n                color: #313238;\n            }\n\n            td {\n                border-top: 1px solid #dcdee5;\n            }\n\n            .cell-text {\n                /* stylelint-disable value-no-vendor-prefix */\n                display: -webkit-box;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                word-break: break-all;\n                white-space: normal;\n                -webkit-box-orient: vertical;\n                -webkit-line-clamp: 1;\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"batch-preview-plan-global-variable\">\n        <template v-for=\"(list, key) in globalVariableRelatePlanMap\">\n            <render-related-info\n                ref=\"relate\"\n                :relate-list=\"list\"\n                :latest-value=\"latestValueMap[key]\"\n                :key=\"key\" />\n        </template>\n    </div>\n</template>\n<script>\n    import {\n        genGlobalVariableKey,\n    } from '../utils';\n    import RenderRelatedInfo from './components/render-related-info';\n    \n    export default {\n        name: 'EditPreview',\n        components: {\n            RenderRelatedInfo,\n        },\n        props: {\n            planList: {\n                type: Array,\n                required: true,\n            },\n            latestValueMap: {\n                type: Object,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                globalVariableRelatePlanMap: {},\n            };\n        },\n        created () {\n            this.relatePlanMap = {};\n            this.traverPlanList();\n        },\n        methods: {\n            /**\n             * @desc 遍历执行方案全局变量\n             */\n            traverPlanList () {\n                const globalVariableRelatePlanMap = {};\n                this.planList.forEach((planData) => {\n                    planData.variableList.forEach((variableData) => {\n                        const variableKey = genGlobalVariableKey(variableData);\n                        const relateData = {\n                            plan: planData,\n                            globalVariable: variableData,\n                        };\n                        if (Object.prototype.hasOwnProperty.call(this.latestValueMap, variableKey)) {\n                            if (globalVariableRelatePlanMap[variableKey]) {\n                                globalVariableRelatePlanMap[variableKey].push(relateData);\n                            } else {\n                                globalVariableRelatePlanMap[variableKey] = [\n                                    relateData,\n                                ];\n                            }\n                            this.relatePlanMap[planData.id] = planData;\n                        }\n                    });\n                });\n                \n                this.globalVariableRelatePlanMap = Object.freeze(globalVariableRelatePlanMap);\n                // 默认站看第一个全局变量的信息\n                this.$nextTick(() => {\n                    this.$refs.relate[0].handleToggle();\n                });\n            },\n            /**\n             * @desc 外部调用，获取需要更新的执行方案\n             * @return {Array} 需要更新的执行方案列表\n             */\n            getRelatePlanList () {\n                return Object.values(this.relatePlanMap);\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .batch-preview-plan-global-variable {\n        padding-top: 6px;\n    }\n</style>\n","<template>\n    <jb-sideslider\n        :is-show=\"isShow\"\n        :width=\"900\"\n        :title=\"'批量编辑变量值'\"\n        ref=\"root\"\n        :show-footer=\"!isLoading && isGlobalVariableNotEmpty\"\n        @update:isShow=\"handleCancel\">\n        <div v-if=\"isLoading\" style=\"min-height: 100px;\" v-bkloading=\"{ isLoading }\" />\n        <div v-else>\n            <div v-if=\"isGlobalVariableNotEmpty\" class=\"batch-edit-global-variable-box\">\n                <div class=\"edit-header\">\n                    <bk-steps :cur-step.sync=\"curStep\" style=\"width: 300px;\" :steps=\"steps\" />\n                </div>\n                <keep-alive exclude=\"editPreview\">\n                    <component\n                        v-if=\"planList.length > 0\"\n                        ref=\"handler\"\n                        :is=\"stepCom\"\n                        :plan-list=\"planList\"\n                        :latest-value-map=\"globalVariableValueMap\"\n                        @on-edit-change=\"handleEditChange\" />\n                </keep-alive>\n            </div>\n            <Empty v-else style=\"margin-top: 126px;\">\n                <div style=\"font-size: 20px; line-height: 26px; color: #63656e;\">\n                    {{ '暂无全局变量' }}\n                </div>\n                <div style=\"margin-top: 12px; font-size: 14px; line-height: 19px; color: #979ba5;\" slot=\"desc\">\n                    {{ '所选执行方案，无变量值可编辑' }}\n                </div>\n            </Empty>\n        </div>\n        <div slot=\"footer\">\n            <template v-if=\"curStep === 1\">\n                <bk-button\n                    theme=\"primary\"\n                    class=\"mr10\"\n                    \n                    @click=\"handlePreview\">\n                    {{ '下一步' }}\n                </bk-button>\n            </template>\n            <template v-if=\"curStep === 2\">\n                <jb-popover-confirm\n                    v-if=\"hasEmptyValueVariable\"\n                    :title=\"'确定立即批量更新？'\"\n                    :content=\"'请注意！变量值填框留空，即代表设置目标变量为空值。'\"\n                    :confirm-handler=\"handleSubmit\">\n                    <bk-button\n                        theme=\"primary\"\n                        class=\"mr10\">\n                        {{ '提交' }}\n                    </bk-button>\n                </jb-popover-confirm>\n                <bk-button\n                    v-else\n                    theme=\"primary\"\n                    class=\"mr10\"\n                    @click=\"handleSubmit\">\n                    {{ '提交' }}\n                </bk-button>\n                <bk-button\n                    theme=\"primary\"\n                    class=\"mr10\"\n                    @click=\"handleChangeStep(1)\">\n                    {{ '上一步' }}\n                </bk-button>\n            </template>\n            <bk-button @click=\"handleCancel\">{{ '取消' }}</bk-button>\n        </div>\n    </jb-sideslider>\n</template>\n<script>\n    import _ from 'lodash';\n       import TaskPlanService from '@service/task-plan';\n    import { leaveConfirm } from '@utils/assist';\n    import { genGlobalVariableKey } from './utils';\n    import EditValue from './edit-value';\n    import EditPreview from './edit-preview';\n\n    export default {\n        name: '',\n        components: {\n            EditValue,\n            EditPreview,\n        },\n        model: {\n            prop: 'isShow',\n            event: 'input',\n        },\n        props: {\n            isShow: {\n                type: Boolean,\n                default: false,\n            },\n            data: {\n                type: Array,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                isLoading: true,\n                curStep: 1,\n                isGlobalVariableNotEmpty: false,\n                planList: [{},{},{}],\n                isPreviewDisabled: true, // 选择的变量为空不能进行下一步\n                globalVariableValueMap: {}, // 全局变量编辑的值缓存\n            };\n        },\n        computed: {\n            stepCom () {\n                const comMap = {\n                    1: EditValue,\n                    2: EditPreview,\n                };\n                return comMap[this.curStep];\n            },\n            /**\n             * @desc 编辑的变量中是否有值为空的变量\n             * @return {Boolean}\n            */\n            hasEmptyValueVariable () {\n                for (const variableKey in this.globalVariableValueMap) {\n                    const variableValue = this.globalVariableValueMap[variableKey];\n                    if (!variableValue) {\n                        return true;\n                    }\n                    if (_.isObject(variableValue) && variableValue.isEmpty) {\n                        return true;\n                    }\n                }\n                return false;\n            },\n        },\n        watch: {\n            isShow: {\n                handler (isShow) {\n                    if (isShow) {\n                        this.fetchPlanDetailData();\n                    }\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.steps = [\n                {\n                    title: '编辑变量',\n                    icon: 1,\n                },\n                {\n                    title: '更新预览',\n                    icon: 2,\n                },\n            ];\n        },\n        methods: {\n            /**\n             * @desc 获取所选执行方案的详情数据\n             *\n             * 得到执行方案详情数据后需要判断所有的执行方案中是否有全局变量\n             */\n            fetchPlanDetailData () {\n                this.isLoading = true;\n                this.isGlobalVariableNotEmpty = false;\n                TaskPlanService.fetchBatchPlan({\n                    planIds: this.data.map(_ => _.id).join(','),\n                }).then((data) => {\n                    this.planList = Object.freeze(data);\n                    // eslint-disable-next-line no-plusplus\n                    for (let i = 0; i < this.planList.length; i++) {\n                        if (this.planList[i].variableList.length > 0) {\n                            this.isGlobalVariableNotEmpty = true;\n                            break;\n                        }\n                    }\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            handleEditChange (globalVariableValueMap) {\n                this.isPreviewDisabled = Object.values(globalVariableValueMap).length < 1;\n            },\n            /**\n             * @desc 修改预览\n             * @param {Number} step 指定的步骤\n             *\n             * 每次切换步骤时内容区需要滚动到顶部\n             */\n            handlePreview () {\n                this.globalVariableValueMap = Object.freeze(this.$refs.handler.getEditValue());\n                this.handleChangeStep(2);\n            },\n            /**\n             * @desc 切换步骤\n             * @param {Number} step 指定的步骤\n             *\n             * 每次切换步骤时内容区需要滚动到顶部\n             */\n            handleChangeStep (step) {\n                this.curStep = step;\n                this.$refs.root.$el.querySelector('.bk-sideslider-content').scrollTop = 0;\n            },\n            /**\n             * @desc 提交变量编辑\n            */\n            handleSubmit () {\n                const planList = this.$refs.handler.getRelatePlanList();\n                \n                const stack = [];\n                planList.forEach((currentPlan) => {\n                    const variableInfoList = [];\n                    const currentData = {\n                        planId: currentPlan.id,\n                        templateId: currentPlan.templateId,\n                        variableInfoList,\n                    };\n                    currentPlan.variableList.forEach((variableData) => {\n                        const variableKey = genGlobalVariableKey(variableData);\n                        if (Object.prototype.hasOwnProperty.call(this.globalVariableValueMap, variableKey)) {\n                            if (variableData.isHost) {\n                                variableInfoList.push({\n                                    ...variableData,\n                                    defaultTargetValue: this.globalVariableValueMap[variableKey],\n                                });\n                            } else {\n                                variableInfoList.push({\n                                    ...variableData,\n                                    defaultValue: this.globalVariableValueMap[variableKey],\n                                });\n                            }\n                        } else {\n                            variableInfoList.push(variableData);\n                        }\n                    });\n                    stack.push(currentData);\n                });\n                return TaskPlanService.batchUpdateVariable(stack)\n                    .then(() => {\n                        window.changeAlert = false;\n                        this.messageSuccess('编辑成功');\n                        this.$emit('on-success');\n                        // settimeout 保证 jb-popover-confirm能被先关闭\n                        setTimeout(() => {\n                            this.handleCancel();\n                        });\n                    });\n            },\n            /**\n             * @desc 取消编辑\n             */\n            handleCancel () {\n                leaveConfirm()\n                    .then(() => {\n                        this.curStep = 1;\n                        this.planList = [];\n                        this.globalVariableValueMap = {};\n                        this.isPreviewDisabled = true;\n                        this.$emit('change', false);\n                        this.$emit('input', false);\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .batch-edit-global-variable-box {\n        .edit-header {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            height: 56px;\n            margin: -20px -30px 0;\n            background: #f0f1f5;\n        }\n    }\n</style>\n","\n<template>\n    <div class=\"task-manage-plan-page\">\n        <list-action-layout>\n            <bk-button\n                theme=\"primary\"\n                class=\"w120\"\n                @click=\"handleCreatePlan\"\n                v-test=\"{ type: 'button', value: 'createPlan' }\">\n                {{ '新建' }}\n            </bk-button>\n            <span v-bk-tooltips=\"batchSyncDisableTips\">\n                <bk-button\n                    @click=\"handleSyncBatch\"\n                    v-test=\"{ type: 'button', value: 'batchSyncPlan' }\">\n                    {{ '批量同步' }}\n                </bk-button>\n            </span>\n            <span v-bk-tooltips=\"batchEditGlobalVariableTips\">\n                <bk-button\n                    @click=\"handleBatchEditGlobalVariable\"\n                    v-test=\"{ type: 'button', value: 'batchEditPlanValue' }\">\n                    {{ '批量编辑变量值' }}\n                </bk-button>\n            </span>\n            <template #right>\n                <jb-search-select\n                    ref=\"search\"\n                    :append-value=\"searchValue\"\n                    :data=\"searchData\"\n                    :placeholder=\"'输入 ID、执行方案名、作业模板名、更新人 或 创建人 进行搜索...'\"\n                    style=\"width: 420px;\"\n                    @on-change=\"handleSearch\" />\n                <bk-button @click=\"handleMyPlan\">{{ '我的方案' }}</bk-button>\n            </template>\n        </list-action-layout>\n        <layout :flod=\"isListFlod\" @on-flod=\"handleLayoutFlod\">\n            <render-list\n                ref=\"list\"\n                :data-source=\"listDataSource\"\n                :search-control=\"() => $refs.search\"\n                selectable\n                :outer-border=\"false\"\n                :size=\"tableSize\"\n                :row-class-name=\"caclRowClassName\"\n                :pagination-small=\"paginationSmall\"\n                @on-selection-change=\"handleSelection\"\n                v-test=\"{ type: 'list', value: 'plan' }\">\n                <div\n                    v-if=\"isCreatePlan\"\n                    slot=\"prepend\"\n                    class=\"create-plan-placeholder\"\n                    :class=\"{ active: selectPlanInfo.id === -1 }\">\n                    <div class=\"name-box\">{{ newPlanName || '--' }}</div>\n                    <Icon\n                        type=\"new-3\"\n                        svg\n                        style=\"font-size: 26px; color: #ff9c01;\" />\n                </div>\n                <bk-table-column\n                    v-if=\"allRenderColumnMap.id\"\n                    label=\"ID\"\n                    prop=\"id\"\n                    key=\"id\"\n                    width=\"120\"\n                    align=\"left\" />\n                <bk-table-column\n                    v-if=\"allRenderColumnMap.name\"\n                    :label=\"'执行方案名称'\"\n                    prop=\"name\"\n                    min-width=\"300\"\n                    key=\"name\"\n                    align=\"left\"\n                    class-name=\"plan-name-column\">\n                    <template slot-scope=\"{ row }\">\n                        <auth-component\n                            style=\"width: 100%;\"\n                            :permission=\"row.canView\"\n                            auth=\"job_plan/view\"\n                            :resource-id=\"row.id\">\n                            <div\n                                class=\"plan-name-box\"\n                                :class=\"{\n                                    active: selectPlanInfo.id === row.id,\n                                }\"\n                                @click=\"handlePlanSelect(row)\">\n                                <div class=\"name-wraper\">\n                                    <div\n                                        class=\"name-text\"\n                                        v-bk-overflow-tips>\n                                        {{ row.name }}\n                                    </div>\n                                    <router-link\n                                        v-if=\"row.cronJobCount > 0\"\n                                        class=\"cron-job-tag\"\n                                        :to=\"{\n                                            name: 'cronList',\n                                            query: {\n                                                planId: 4 || row.id,\n                                            },\n                                        }\"\n                                        target=\"_blank\"\n                                        v-bk-tooltips.html=\"`\n                                            <div>${'有'} ${row.cronJobCount} ${'个定时任务'}</div>\n                                            <div>${'点击前往查看'}</div>\n                                        `\">\n                                        <Icon type=\"job-timing\" svg />\n                                        <span style=\"margin-left: 2px;\">{{ row.cronJobCount }}</span>\n                                    </router-link>\n                                    <span\n                                        v-if=\"row.needUpdate\"\n                                        class=\"update-flag\">\n                                        <Icon\n                                            :tippy-tips=\"'未同步'\"\n                                            type=\"sync-8\"\n                                            svg />\n                                    </span>\n                                    \n                                </div>\n                                <Icon\n                                    @click.stop=\"handleCollection(row)\"\n                                    type=\"collection\"\n                                    class=\"collection-flag\"\n                                    :class=\"{ favored: row.favored }\" />\n                                <Icon\n                                    v-if=\"selectPlanInfo.id === row.id\"\n                                    class=\"select-flag\"\n                                    type=\"arrow-full-right\" />\n                            </div>\n                            <div\n                                slot=\"forbid\"\n                                class=\"plan-name-box\"\n                                :class=\"{\n                                    active: selectPlanInfo.id === row.id,\n                                }\">\n                                <div class=\"name-wraper\">\n                                    <div class=\"name-text\" v-bk-overflow-tips>{{ row.name }}</div>\n                                    <router-link\n                                        v-if=\"row.cronJobCount > 0\"\n                                        class=\"cron-job-tag\"\n                                        :to=\"{\n                                            name: 'cronList',\n                                            query: {\n                                                planId: 4 || row.id,\n                                            },\n                                        }\"\n                                        target=\"_blank\"\n                                        v-bk-tooltips.html=\"`\n                                            <div>${'有'} ${row.cronJobCount} ${'个定时任务'}</div>\n                                            <div>${'点击前往查看'}</div>\n                                        `\">\n                                        <Icon type=\"job-timing\" svg />\n                                        <span style=\"margin-left: 2px;\">{{ row.cronJobCount }}</span>\n                                    </router-link>\n                                    <span\n                                        v-if=\"row.needUpdate\"\n                                        class=\"update-flag\">\n                                        <Icon\n                                            :tippy-tips=\"'未同步'\"\n                                            type=\"sync-8\"\n                                            svg />\n                                    </span>\n                                    \n                                </div>\n                                <Icon\n                                    @click.stop=\"handleCollection(row)\"\n                                    type=\"collection\"\n                                    class=\"collection-flag\"\n                                    :class=\"{ favored: row.favored }\" />\n                            </div>\n                        </auth-component>\n                    </template>\n                </bk-table-column>\n                <bk-table-column\n                    v-if=\"allRenderColumnMap.templateName\"\n                    :label=\"'所属作业模板'\"\n                    prop=\"templateName\"\n                    min-width=\"200\"\n                    key=\"templateName\"\n                    show-overflow-tooltip\n                    align=\"left\" />\n                <bk-table-column\n                    v-if=\"allRenderColumnMap.lastModifyUser\"\n                    :label=\"'更新人'\"\n                    prop=\"lastModifyUser\"\n                    key=\"lastModifyUser\"\n                    width=\"160\"\n                    align=\"left\" />\n                <bk-table-column\n                    v-if=\"allRenderColumnMap.lastModifyTime\"\n                    :label=\"'更新时间'\"\n                    prop=\"lastModifyTime\"\n                    key=\"lastModifyTime\"\n                    width=\"180\"\n                    align=\"left\" />\n                <bk-table-column\n                    v-if=\"allRenderColumnMap.creator\"\n                    :label=\"'创建人'\"\n                    prop=\"creator\"\n                    key=\"creator\"\n                    width=\"120\"\n                    align=\"left\" />\n                <bk-table-column\n                    v-if=\"allRenderColumnMap.createTime\"\n                    :label=\"'创建时间'\"\n                    prop=\"createTime\"\n                    key=\"createTime\"\n                    width=\"180\"\n                    align=\"left\" />\n                <bk-table-column\n                    v-if=\"!isListFlod\"\n                    :resizable=\"false\"\n                    :label=\"'操作'\"\n                    prop=\"statusText\"\n                    fixed=\"right\"\n                    key=\"action\"\n                    width=\"120\"\n                    align=\"left\">\n                    <template slot-scope=\"{ row }\">\n                        <bk-button\n                            text\n                            @click=\"handleExecute(row)\"\n                            class=\"mr10\"\n                            v-test=\"{ type: 'button', value: 'execPlan' }\">\n                            {{ '去执行' }}\n                        </bk-button>\n                        <span :tippy-tips=\"row.needUpdate ? '' : '无需同步'\">\n                            <auth-button\n                                :permission=\"row.canEdit\"\n                                auth=\"job_plan/sync\"\n                                :resource-id=\"row.id\"\n                                text\n                                @click=\"handleUpdate(row)\"\n                                class=\"mr10\"\n                                v-test=\"{ type: 'button', value: 'syncPlan' }\">\n                                {{ '去同步' }}\n                            </auth-button>\n                        </span>\n                        <list-operation-extend>\n                            <div\n                                class=\"action-item\"\n                                @click=\"handleGoCreateCronJob(row)\"\n                                v-test=\"{ type: 'link', value: 'createCrontab' }\">\n                                {{ '定时执行' }}\n                            </div>\n                            <auth-component\n                                :permission=\"row.canEdit\"\n                                auth=\"job_plan/edit\"\n                                :resource-id=\"row.id\">\n                                <div\n                                    class=\"action-item\"\n                                    @click=\"handleEdit(row)\"\n                                    v-test=\"{ type: 'button', value: 'editPlan' }\">\n                                    {{ '编辑' }}\n                                </div>\n                                <div\n                                    class=\"action-item\"\n                                    slot=\"forbid\"\n                                    v-test=\"{ type: 'button', value: 'editPlan' }\">\n                                    {{ '编辑' }}\n                                </div>\n                            </auth-component>\n                            <jb-popover-confirm\n                                class=\"action-del\"\n                                :title=\"'确定删除该执行方案？'\"\n                                :content=\"'若已设置了定时任务，需要先删除才能操作'\"\n                                :confirm-handler=\"() => handleDelete(row)\">\n                                <auth-component\n                                    :permission=\"row.canDelete\"\n                                    auth=\"job_plan/delete\"\n                                    :resource-id=\"row.id\">\n                                    <div\n                                        class=\"action-item\"\n                                        v-test=\"{ type: 'button', value: 'deletePlan' }\">\n                                        {{ '删除' }}\n                                    </div>\n                                    <div\n                                        slot=\"forbid\"\n                                        class=\"action-item\"\n                                        v-test=\"{ type: 'button', value: 'deletePlan' }\">\n                                        {{ '删除' }}\n                                    </div>\n                                </auth-component>\n                            </jb-popover-confirm>\n                        </list-operation-extend>\n                    </template>\n                </bk-table-column>\n                <bk-table-column v-if=\"!isListFlod\" type=\"setting\">\n                    <bk-table-setting-content\n                        :fields=\"tableColumn\"\n                        :selected=\"selectedTableColumn\"\n                        :size=\"tableSize\"\n                        @setting-change=\"handleSettingChange\" />\n                </bk-table-column>\n            </render-list>\n            <template slot=\"flod\">\n                <component\n                    :is=\"planCom\"\n                    ref=\"planHandler\"\n                    v-bind=\"selectPlanInfo\"\n                    :bottom-offset=\"20\"\n                    :first-plan=\"isFirstTemplatePlan\"\n                    @on-name-change=\"handleCreatePlanNameChange\"\n                    @on-create=\"handleCreateSubmit\"\n                    @on-edit=\"handleShowPlanEdit\"\n                    @on-edit-cancle=\"handleEditCancle\"\n                    @on-edit-success=\"handleEditSuccess\"\n                    @on-delete=\"handlePlanDelete\" />\n            </template>\n        </layout>\n        <lower-component level=\"custom\" :custom=\"isShowTemplateSelect\">\n            <template-select\n                v-model=\"isShowTemplateSelect\"\n                @on-change=\"handleTemplateChange\" />\n        </lower-component>\n        <lower-component level=\"custom\" :custom=\"isShowBatchGlobalVariable\">\n            <batch-edit-global-variable\n                v-model=\"isShowBatchGlobalVariable\"\n                :data=\"listSelect\"\n                @on-success=\"handleBatchEditGlobalVariableSuccess\" />\n        </lower-component>\n    </div>\n</template>\n<script>\n    /**\n     * @desc 执行方案列表展示公用组件\n     *\n     * 用于作业模板详情展示指定作业模板的执行方案（固定搜索项作业模板名称）\n     * 用执行方案列表展示所有执行方案列表\n    */\n       import UserService from '@service/user';\n    import NotifyService from '@service/notify';\n    import ExecPlanService from '@service/task-plan';\n    import TaskExecuteService from '@service/task-execute';\n    import ListActionLayout from '@components/list-action-layout';\n    import RenderList from '@components/render-list';\n    import JbSearchSelect from '@components/jb-search-select';\n    import ListOperationExtend from '@components/list-operation-extend';\n    import { listColumnsCache } from '@utils/cache-helper';\n    import { leaveConfirm } from '@utils/assist';\n    import PlanDetail from '../detail';\n    import PlanEdit from '../edit';\n    import PlanCreate from '../create';\n    import Layout from './components/layout';\n    import TemplateSelect from './components/template-select';\n    import BatchEditGlobalVariable from './components/batch-edit-gobal-variable';\n\n    const TABLE_COLUMN_CACHE = 'task_plan_list_columns';\n\n    export default {\n        name: '',\n        components: {\n            ListActionLayout,\n            RenderList,\n            JbSearchSelect,\n            ListOperationExtend,\n            Layout,\n            PlanDetail,\n            PlanEdit,\n            TemplateSelect,\n            BatchEditGlobalVariable,\n        },\n        data () {\n            return {\n                searchValue: [],\n                listSelect: [],\n                isShowTemplateSelect: false,\n                isShowBatchGlobalVariable: false,\n                planComType: '',\n                newPlanName: '',\n                isFirstTemplatePlan: false,\n                selectPlanInfo: {\n                    templateId: -1,\n                    id: -1,\n                },\n                currentUser: {},\n                selectedTableColumn: [],\n                tableSize: 'small',\n                paginationSmall: false,\n            };\n        },\n        computed: {\n            isLoading () {\n                return this.$refs.list.isLoading;\n            },\n            allRenderColumnMap () {\n                if (this.isListFlod) {\n                    return {\n                        name: true,\n                    };\n                }\n                return this.selectedTableColumn.reduce((result, item) => {\n                    result[item.id] = true;\n                    return result;\n                }, {});\n            },\n            planCom () {\n                const planComMap = {\n                    detail: PlanDetail,\n                    edit: PlanEdit,\n                    create: PlanCreate,\n                };\n                if (!planComMap[this.planComType]) {\n                    return 'div';\n                }\n                return planComMap[this.planComType];\n            },\n            isCreatePlan () {\n                return this.planComType === 'create';\n            },\n            isListFlod () {\n                return Boolean(this.planComType);\n            },\n            /**\n             * @desc 批量同步按钮禁用tips\n             * 当所选执行方案中有执行方案中不需要同步或者有执行方案中没有权限同步，禁用批量同步操作\n             */\n            batchSyncDisableTips () {\n                if (this.listSelect.length < 1) {\n                    return '请选择要同步的执行方案';\n                }\n                let needUpdate = true;\n                let canEdit = true;\n                this.listSelect.forEach((currentSelect) => {\n                    if (!currentSelect.needUpdate) {\n                        needUpdate = false;\n                    }\n                    if (!currentSelect.canEdit) {\n                        canEdit = false;\n                    }\n                });\n                if (!needUpdate) {\n                    return '已选结果中有执行方案中不需要同步';\n                }\n                if (!canEdit) {\n                    return '已选结果中有执行方案中没有权限同步';\n                }\n                return '';\n            },\n            /**\n             * @desc 批量编辑全局变量按钮禁用tips\n             * 当所选执行方案中有执行方案中没有权限编辑禁用批量编辑操作\n             */\n            batchEditGlobalVariableTips () {\n                if (this.listSelect.length < 1) {\n                    return '请选择要编辑的执行方案';\n                }\n                let canEdit = true;\n                // eslint-disable-next-line no-plusplus\n                for (let i = 0; i < this.listSelect.length; i++) {\n                    const currentSelect = this.listSelect[i];\n                    if (!currentSelect.canEdit) {\n                        canEdit = false;\n                        break;\n                    }\n                }\n                \n                if (!canEdit) {\n                    return '已选结果中有执行方案中没有权限编辑';\n                }\n                return '';\n            },\n        },\n        created () {\n            this.parseUrl();\n\n            this.fetchUserInfo();\n\n            this.listDataSource = ExecPlanService.fetchAllPlan;\n            \n            // 查看指定作业模板的执行方案列表，不支持作业模板名称搜索\n            this.searchData = [\n                {\n                    name: 'ID',\n                    id: 'planId',\n                    description: '将覆盖其它条件',\n                    validate (values, item) {\n                        const validate = (values || []).every(_ => /^(\\d*)$/.test(_.name));\n                        return !validate ? 'ID只支持数字' : true;\n                    },\n                },\n                {\n                    name: '执行方案',\n                    id: 'planName',\n                    default: true,\n                },\n                {\n                    name: '更新人',\n                    id: 'lastModifyUser',\n                    remoteMethod: NotifyService.fetchUsersOfSearch,\n                    inputInclude: true,\n                },\n                {\n                    name: '创建人',\n                    id: 'creator',\n                    remoteMethod: NotifyService.fetchUsersOfSearch,\n                    inputInclude: true,\n                },\n            ];\n            if (!this.isViewTemplatePlanList) {\n                this.searchData.splice(2, 0, {\n                    name: '作业模板名称',\n                    id: 'templateName',\n                });\n            }\n            \n            // 列表可显示列\n            this.tableColumn = [\n                {\n                    id: 'id',\n                    label: 'ID',\n                },\n                {\n                    id: 'name',\n                    label: '执行方案',\n                    disabled: true,\n                },\n                {\n                    id: 'templateName',\n                    label: '所属作业模板',\n                },\n                {\n                    id: 'lastModifyUser',\n                    label: '更新人',\n                },\n                {\n                    id: 'lastModifyTime',\n                    label: '更新时间',\n                },\n                {\n                    id: 'creator',\n                    label: '创建人',\n                },\n                {\n                    id: 'createTime',\n                    label: '创建时间',\n                },\n            ];\n            const columnsCache = listColumnsCache.getItem(TABLE_COLUMN_CACHE);\n            if (columnsCache) {\n                this.selectedTableColumn = Object.freeze(columnsCache.columns);\n                this.tableSize = columnsCache.size;\n            } else {\n                this.selectedTableColumn = Object.freeze([\n                    { id: 'id' },\n                    { id: 'name' },\n                    { id: 'lastModifyUser' },\n                    { id: 'lastModifyTime' },\n                ]);\n            }\n        },\n        methods: {\n            /**\n             * @desc 执行方案列表\n             *\n             * 查看指定作业模板的执行方案列表\n             *  - api请求固定作业模板id，url查询参数需要拼接viewPlanId表示当前正常查看的执行方案\n             */\n            fetchData () {\n                const searchParams = {\n                    ...this.searchParams,\n                };\n                if (this.templateId) {\n                    searchParams.templateId = this.templateId;\n                }\n                this.$refs.list.$emit('onFetch', searchParams);\n            },\n            /**\n             * @desc 登陆用户信息\n             */\n            fetchUserInfo () {\n                UserService.fetchUserInfo()\n                    .then((data) => {\n                        this.currentUser = Object.freeze(data);\n                    });\n            },\n            /**\n             * @desc 解析 url 参数\n             */\n            parseUrl () {\n                // 查看作业模板的执行方案\n                this.isViewTemplatePlanList = this.$route.name === 'viewPlan';\n                // 执行方案列表所属的作业模板\n                this.templateId = '';\n                \n                if (this.isViewTemplatePlanList) {\n                    // 查看指定作业模板的执行方案列表\n\n                    // 解析路由查询参数viewPlanId，没有指定viewPlanId或者viewPlanId不存在列表数据中，默认赋值列表数据的第一个\n                    let {\n                        templateId,\n                    } = this.$route.params;\n                    templateId = Number(templateId);\n                    // 记录 templateId\n                    this.templateId = templateId;\n                    \n                    const {\n                        viewPlanId,\n                        mode,\n                    } = this.$route.query;\n                    // 默认显示新建执行方案\n                    if (mode === 'create') {\n                        setTimeout(() => {\n                            this.handleCreatePlan();\n                        });\n                        \n                        return;\n                    }\n                    // url 记录了指定查看那个执行方案\n                    // 默认显示执行方案详情\n                    const id = Number(viewPlanId) || 0;\n                    if (id > 0) {\n                        setTimeout(() => {\n                            this.handlePlanSelect({\n                                templateId,\n                                id,\n                            });\n                        });\n                    }\n                } else {\n                    // 查看所有执行方案列表\n                    const {\n                        viewTemplateId,\n                        viewPlanId,\n                    } = this.$route.query;\n                    const templateId = Number(viewTemplateId) || 0;\n                    const id = Number(viewPlanId) || 0;\n\n                    if (templateId && id) {\n                        setTimeout(() => {\n                            this.handlePlanSelect({\n                                templateId,\n                                id,\n                            });\n                        });\n                    }\n                }\n            },\n            caclRowClassName ({ row }) {\n                return row.id === this.selectPlanInfo.id ? 'active' : '';\n            },\n            /**\n             * @desc 表格列表配置\n             */\n            handleSettingChange ({ fields, size }) {\n                this.selectedTableColumn = Object.freeze(fields);\n                this.tableSize = size;\n                listColumnsCache.setItem(TABLE_COLUMN_CACHE, {\n                    columns: fields,\n                    size,\n                });\n            },\n            /**\n             * @desc 创建执行方案\n             *\n             * 在查看模板执行方案页面，直接创建当前作业模板下的执行方案\n             * 在查看所有执行方案列表页面，需要先选中作业模板然后才开始创建执行方案\n             *\n             */\n            handleCreatePlan () {\n                if (this.isViewTemplatePlanList) {\n                    this.handleTemplateChange(this.templateId);\n                } else {\n                    this.isShowTemplateSelect = true;\n                }\n            },\n            /**\n             * @desc 选择作业模板后显示新建执行方案页面\n             * @param {Number} templateId 作业模板id\n             *\n             * 需要判断将要新建的执行方案是否是改模板下面的第一个执行方案\n             */\n            handleTemplateChange (templateId) {\n                this.selectPlanInfo = {\n                    templateId,\n                    id: -1,\n                };\n                this.planComType = 'create';\n                this.paginationSmall = true;\n                this.isFirstTemplatePlan = this.$refs.list.data.length < 1;\n            },\n            /**\n             * @desc 新建执行方案时执行方案名更新\n             * @param {String} planName 执行方案名\n             */\n            handleCreatePlanNameChange (planName) {\n                this.newPlanName = planName;\n            },\n            /**\n             * @desc 批量同步已选的执行方案\n             */\n            handleSyncBatch () {\n                this.$router.push({\n                    name: 'syncPlanBatch',\n                    query: {\n                        planIds: this.listSelect.map(_ => _.id).join(','),\n                        from: this.$route.name,\n                    },\n                });\n            },\n            /**\n             * @desc 批量更新变量值\n             */\n            handleBatchEditGlobalVariable () {\n                this.isShowBatchGlobalVariable = true;\n            },\n            /**\n             * @desc 列表搜索\n             * @param {Object} params 搜索参数\n             */\n            handleSearch (params) {\n                this.searchParams = params;\n                this.fetchData();\n            },\n            /**\n             * @desc 筛选我的执行方案\n             */\n            handleMyPlan () {\n                const currentUserName = this.currentUser.username;\n                const creator = {\n                    name: '创建人',\n                    id: 'creator',\n                    values: [\n                        {\n                            id: currentUserName,\n                            name: currentUserName,\n                        },\n                    ],\n                };\n                this.searchParams = {\n                    ...this.searchParams,\n                    creator: currentUserName,\n                };\n                this.searchValue = [creator];\n                this.fetchData();\n            },\n            /**\n             * @desc 列表选择\n             * @param {Array} selectPlan 选中的执行方案\n             */\n            handleSelection (selectPlan) {\n                this.listSelect = Object.freeze(selectPlan);\n            },\n            /**\n             * @desc 列表布局收起\n             *\n             * 收起时需要更新 url 参数\n             */\n            handleLayoutFlod () {\n                this.planComType = '';\n                this.selectPlanInfo = {\n                    templateId: -1,\n                    id: -1,\n                };\n                this.paginationSmall = false;\n                const searchParams = new URLSearchParams(window.location.search);\n                searchParams.delete('viewTemplateId');\n                searchParams.delete('viewPlanId');\n                window.history.replaceState({}, '', `?${searchParams.toString()}`);\n            },\n            /**\n             * @desc 选中执行方案查看详情\n             * @param {Object} row 选中的行数据\n             * @param {String} mode 执行方案的展示状态（detail、edit、create）\n             *\n             * 显示执行方案详情面板\n             * url 查询参数拼接viewPlanId记录当前选中的执行方案id\n             */\n            handlePlanSelect (row, mode = 'detail') {\n                const currentPlanId = row.id;\n                if (currentPlanId === this.selectPlanInfo.id) {\n                    return;\n                }\n                leaveConfirm()\n                    .then(() => {\n                        this.planComType = mode;\n                        this.selectPlanInfo = {\n                            templateid: 4 || row.templateId,\n                            id: currentPlanId,\n                        };\n                        this.paginationSmall = true;\n                        // url 缓存用户场景\n                        setTimeout(() => {\n                            const searchParams = new URLSearchParams(window.location.search);\n                            searchParams.set('viewTemplateId', row.templateId);\n                            searchParams.set('viewPlanId', row.id);\n                            window.history.replaceState({}, '', `?${searchParams.toString()}`);\n                        });\n                    });\n            },\n            /**\n             * @desc 收藏执行方案\n             * @param {Object} plan 操作的执行方案数据\n             */\n            handleCollection (plan) {\n                const requestHander = plan.favored ? ExecPlanService.deleteFavorite : ExecPlanService.updateFavorite;\n                requestHander({\n                    id: plan.id,\n                    templateId: plan.templateId,\n                }).then(() => {\n                    plan.toggleFavored();\n                    this.messageSuccess(plan.favored ? '收藏成功' : '取消收藏成功');\n                });\n            },\n            /**\n             * @desc 跳转执行方案关联的定时任务列表\n             * @param {Object} plan 操作的执行方案数据\n             */\n            handleGoCronJobList (plan) {\n                const { href } = this.$router.resolve({\n                    name: 'cronList',\n                    query: {\n                        planId: plan.id,\n                    },\n                });\n                window.open(href);\n            },\n            /**\n             * @desc 执行选中的执行方案\n             * @param {Object} row 操作的执行方案数据\n             */\n            handleExecute (row) {\n                // 获取作业详情\n                // ExecPlanService.fetchPlanDetailInfo({\n                //     id: 4 || row.id,\n                //     templateid: 4 || row.templateId,\n                // }).then((data) => {\n                const data = { variableList: [1, 2] };\n                // 没有变量——直接执行\n                if (data.variableList.length < 1) {\n                    this.$bkInfo({\n                        title: '确认执行？',\n                        subTitle: '未设置全局变量，点击确认将直接执行。',\n                        confirmFn: () => {\n                            TaskExecuteService.taskExecution({\n                                taskId: 4 || row.id,\n                                taskVariables: [],\n                            }).then(({ taskInstanceId }) => {\n                                this.$bkMessage({\n                                    theme: 'success',\n                                    message: '操作成功',\n                                });\n                                this.$router.push({\n                                    name: 'historyTask',\n                                    params: {\n                                        id: taskInstanceId,\n                                    },\n                                    query: {\n                                        from: this.$route.name,\n                                    },\n                                });\n                            });\n                        },\n                    });\n                    return;\n                }\n                // 有变量——跳到设置变量页面\n                this.$router.push({\n                    name: 'settingVariable',\n                    params: {\n                        id: 4 || row.id,\n                        templateid: 4 || row.templateId,\n                    },\n                    query: {\n                        from: this.$route.name,\n                    },\n                });\n            },\n            /**\n             * @desc 编辑执行方案\n             * @param {Object} row 操作的执行方案数据\n             */\n            handleEdit (row) {\n                this.handlePlanSelect(row, 'edit');\n            },\n            /**\n             * @desc 同步执行方案\n             * @param {Object} row 操作的执行方案数据\n             */\n            handleUpdate (row) {\n                this.$router.push({\n                    name: 'syncPlan',\n                    params: {\n                        id: 4 || row.id,\n                        templateid: 4 || row.templateId,\n                    },\n                    query: {\n                        from: this.$route.name,\n                    },\n                });\n            },\n\n            /**\n             * @desc 新建执行方案\n             * @param {Object} row 操作的执行方案数据\n             */\n            handleGoCreateCronJob (row) {\n                const { href } = this.$router.resolve({\n                    name: 'cronList',\n                    query: {\n                        mode: 'create',\n                        templateid: 4 || row.templateId,\n                        planId: 4 || row.id,\n                    },\n                });\n                window.open(href);\n            },\n            /**\n             * @desc 删除执行方案\n             * @param {Object} row 操作的执行方案数据\n             */\n            handleDelete (row) {\n                return ExecPlanService.planDelete({\n                    id: 4 || row.id,\n                    templateid: 4 || row.templateId,\n                }).then((data) => {\n                    this.$bkMessage({\n                        theme: 'success',\n                        message: '操作成功',\n                    });\n                    this.fetchData();\n                });\n            },\n            /**\n             * @desc 创建执行方案成功\n             * @param {number} planId 新创建的执行方案id\n             *\n             * 执行方案创建成功重新拉取列表数据，并切换到新执行方案详情的查看页面\n             */\n            handleCreateSubmit (planId) {\n                this.fetchData();\n                this.handlePlanSelect({\n                    templateId: this.selectPlanInfo.templateId,\n                    id: planId,\n                });\n            },\n            /**\n             * @desc 切换编辑执行方案面板\n             */\n            handleShowPlanEdit () {\n                this.planComType = 'edit';\n            },\n            /**\n             * @desc 删除执行方案成功\n             *\n             * 收起面板，刷新列表数据\n             */\n            handlePlanDelete () {\n                this.handleLayoutFlod();\n                this.fetchData();\n            },\n            /**\n             * @desc 取消编辑执行方案\n             */\n            handleEditCancle () {\n                this.planComType = 'detail';\n            },\n            /**\n             * @desc 编辑执行方案成功，刷新列表数据\n             */\n            handleEditSuccess () {\n                this.fetchData();\n            },\n            /**\n             * @desc 批量编辑执行方案的全局变量\n             *\n             * 编辑成功\n             *  - 刷新执行方案面板数据\n             *  - 重置 table 行选中状态\n             */\n            handleBatchEditGlobalVariableSuccess () {\n                this.$refs.list.resetSelect();\n                if (this.$refs.planHandler) {\n                    this.$refs.planHandler.refresh();\n                }\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .task-manage-plan-page {\n        .bk-table tr:hover {\n            td.plan-name-column {\n                .plan-name-box {\n                    .collection-flag {\n                        display: inline-block;\n                    }\n                }\n            }\n        }\n\n        .bk-table-row {\n            &.active {\n                background: #eff5ff;\n            }\n        }\n\n        .create-plan-placeholder {\n            display: flex;\n            align-items: center;\n            height: 40px;\n            padding-left: 85px;\n            line-height: 40px;\n            color: #3a84ff;\n            border-bottom: 1px solid #dfe0e5;\n\n            &.active {\n                background: #eff5ff;\n            }\n\n            .name-box {\n                max-width: 226px;\n                margin-right: 8px;\n                overflow: hidden;\n                font-size: 13px;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n        }\n\n        .plan-name-column {\n            &:hover {\n                .collection-flag {\n                    display: block;\n                }\n            }\n\n            .cell {\n                overflow: unset;\n            }\n\n            .plan-name-box {\n                position: relative;\n                display: flex;\n                flex: 1;\n                align-items: center;\n                height: 40px;\n                cursor: pointer;\n            }\n\n            .name-wraper {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                padding-right: 6px;\n                overflow: hidden;\n            }\n\n            .name-text {\n                overflow: hidden;\n                color: #3a84ff;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n                cursor: pointer;\n                flex: 0 1 auto;\n                align-items: center;\n            }\n\n            .cron-job-tag {\n                flex: 0 0 auto;\n                display: inline-flex;\n                height: 16px;\n                padding: 0 4px;\n                margin-left: 4px;\n                font-size: 12px;\n                color: #fff;\n                cursor: pointer;\n                background: #3a84ff;\n                border-radius: 8px;\n                user-select: none;\n                justify-content: center;\n                align-items: center;\n            }\n\n            .update-flag {\n                flex: 0 0 auto;\n                display: inline-flex;\n                width: 16px;\n                height: 16px;\n                margin-left: 4px;\n                font-size: 12px;\n                color: #fff;\n                background: #ea3636;\n                border-radius: 8px;\n                user-select: none;\n                justify-content: center;\n                align-items: center;\n            }\n\n            .collection-flag {\n                position: absolute;\n                left: -32px;\n                display: none;\n                padding: 10px;\n                font-size: 14px;\n                color: #c4c6cc;\n\n                &.favored {\n                    display: inline-block;\n                    color: #ffd695;\n                }\n            }\n\n            .select-flag {\n                margin-left: auto;\n                color: #a3c5fd;\n            }\n        }\n    }\n</style>\n"],"names":[],"sourceRoot":""}