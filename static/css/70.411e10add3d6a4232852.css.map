{"version":3,"file":"static/css/70.411e10add3d6a4232852.css","mappings":"AAqUA,+CACA,iBASA,CAPA,yDAKA,cADA,eADA,UAFA,kBACA,SAIA,CC9NA,4BACA,YA0GA,CAvGA,kDACA,cACA,CAGA,oCACA,iBAeA,CAbA,iDACA,iBACA,CAGA,iEACA,wBACA,CAGA,kDACA,gBACA,CAGA,yCAGA,gBAGA,cAFA,0BAHA,kBAIA,oBAHA,SAuCA,CAjCA,sDACA,kBACA,CAEA,0DACA,cACA,CAEA,wDAcA,mBAJA,mBAEA,+BADA,4BAHA,WACA,eALA,aAGA,eADA,YASA,uBAdA,kBAEA,YADA,QAWA,2BARA,UAeA,CAHA,8DACA,kBACA,CAGA,uDACA,uBACA,CAGA,0CAIA,gBACA,kBAEA,OALA,iBACA,gBAFA,kBAKA,mBA8BA,CA3BA,wDACA,UACA,kBAKA,CAHA,+DACA,SACA,CAGA,qDAWA,mBADA,kBAFA,cACA,eALA,aAGA,eADA,YAMA,uBAXA,kBAEA,UADA,QAGA,UAYA,CAHA,2DACA,wBACA,CCjDA,0BAKA,gBACA,uCAJA,aACA,aACA,kBAHA,iBAiDA,CA1CA,4CACA,cACA,iBAMA,CAJA,gDAEA,YADA,UAEA,CAGA,yCACA,aAEA,sBADA,gBAyBA,CAtBA,8CACA,MACA,CAEA,qDAEA,cADA,aAEA,CAEA,qDAIA,cAHA,OAEA,mBADA,OAUA,CANA,+DACA,YACA,gBACA,uBACA,kBACA,CAIA,sCACA,YACA,CCqCA,gBAOA,yBAHA,SACA,OACA,eALA,eAEA,QADA,KA2JA,CApJA,wBAGA,mBAFA,aACA,WAwEA,CArEA,+BAEA,cADA,cAEA,CAEA,mCAMA,mBALA,aAGA,eACA,gBAFA,iBADA,kBA6DA,CAvDA,0IAKA,eAFA,aACA,iBAEA,8DACA,CAEA,6CACA,aASA,CAPA,qDACA,kBACA,CAEA,oDACA,kBACA,CAGA,gDACA,aASA,CAPA,wDACA,kBACA,CAEA,uDACA,kBACA,CAGA,6CACA,aASA,CAPA,qDACA,kBACA,CAEA,oDACA,kBACA,CAGA,qFAGA,WADA,SAEA,CAEA,0CAEA,gBADA,gBAEA,CAIA,uCAIA,mBACA,0BAJA,aACA,YACA,cAqBA,CAjBA,2GAKA,mBAHA,aAEA,aADA,cAGA,CAEA,qDACA,8BACA,CAEA,kDAEA,mBACA,qBAFA,aAGA,CAGA,kCACA,WACA,CAEA,gCAEA,mBADA,6BAEA,CAEA,kCACA,WACA,CAEA,8BAEA,yBADA,iBAEA,CAEA,0CACA,gBAYA,CAVA,wDAMA,gBACA,kBACA,WAPA,WAEA,YAEA,iBADA,eAFA,UAOA,CAGA,4BAKA,cACA,eAFA,eAHA,kBAEA,UADA,QAKA,kBAKA,CAHA,kCACA,uBACA,CCkkBA,iDACA,eACA,CAIA,sEACA,kBACA,CAIA,iMACA,4BACA,CAEA,yMACA,4BACA,CAEA,2MACA,4BACA,CAIA,8DAGA,cAFA,YACA,cAEA","sources":["webpack://job/./src/views/script-manage/common/copy-create.vue","webpack://job/./src/views/script-manage/version/components/layout.vue","webpack://job/./src/views/script-manage/version/components/script-basic.vue","webpack://job/./src/views/script-manage/version/components/diff.vue","webpack://job/./src/views/script-manage/version/index.vue"],"sourcesContent":["<template>\n    <layout class=\"script-manage-copy-create-box\">\n        <div slot=\"title\">{{ '新建脚本' }}</div>\n        <template slot=\"sub-header\">\n            <Icon\n                type=\"upload\"\n                @click=\"handleUploadScript\"\n                v-bk-tooltips=\"'上传脚本'\"\n                v-test=\"{ type: 'button', value: 'uploadScript' }\" />\n            <Icon\n                type=\"history\"\n                @click.stop=\"handleShowHistory\"\n                v-bk-tooltips=\"'历史缓存'\"\n                v-test=\"{ type: 'button', value: 'scriptEditHistory' }\" />\n            <Icon\n                type=\"full-screen\"\n                v-bk-tooltips=\"'全屏'\"\n                @click=\"handleFullScreen\"\n                v-test=\"{ type: 'button', value: 'scriptEditFullscreen' }\" />\n        </template>\n        <div slot=\"left\">\n            <jb-form\n                ref=\"form\"\n                :model=\"formData\"\n                form-type=\"vertical\"\n                :rules=\"rules\"\n                v-test=\"{ type: 'form', value: 'copyCreateScript' }\">\n                <jb-form-item\n                    :label=\"'版本号'\"\n                    required\n                    property=\"version\">\n                    <div class=\"script-version\">\n                        <jb-input\n                            :value=\"formData.version\"\n                            :placeholder=\"'输入版本号'\"\n                            :maxlength=\"30\"\n                            property=\"version\"\n                            @change=\"handleVersionChange\" />\n                        <Icon type=\"new-dark\" svg class=\"new-flag\" />\n                    </div>\n                </jb-form-item>\n                <jb-form-item :label=\"'版本日志'\">\n                    <bk-input\n                        v-model=\"formData.versionDesc\"\n                        type=\"textarea\"\n                        :maxlength=\"100\"\n                        :rows=\"5\" />\n                </jb-form-item>\n            </jb-form>\n        </div>\n        <div ref=\"content\">\n            <ace-editor\n                v-if=\"contentHeight > 0\"\n                ref=\"aceEditor\"\n                v-model=\"formData.content\"\n                :lang=\"formData.typeName\"\n                :height=\"contentHeight\"\n                :options=\"formData.typeName\"\n                @on-mode-change=\"handleTypeChange\" />\n        </div>\n        <template #footer>\n            <bk-button\n                class=\"w120 mr10\"\n                :loading=\"isSubmiting\"\n                theme=\"primary\"\n                @click=\"handleSubmit\"\n                v-test=\"{ type: 'button', value: 'copyCreateScriptSubmit' }\">\n                {{ '提交' }}\n            </bk-button>\n            <bk-button\n                class=\"mr10\"\n                @click=\"handleDebugScript\"\n                v-test=\"{ type: 'button', value: 'debugScript' }\">\n                {{ '调试' }}\n            </bk-button>\n            <bk-button\n                @click=\"handleCancel\"\n                v-test=\"{ type: 'button', value: 'copyCreateScriptCancel' }\">\n                {{ '取消' }}\n            </bk-button>\n        </template>\n    </layout>\n</template>\n<script>\n    import _ from 'lodash';\n       import ScriptManageService from '@service/script-manage';\n    import PublicScriptManageService from '@service/public-script-manage';\n    import JbInput from '@components/jb-input';\n    import AceEditor from '@components/ace-editor';\n    import {\n        formatScriptTypeValue,\n        genDefaultScriptVersion,\n        checkPublicScript,\n        getOffset,\n        leaveConfirm,\n        scriptErrorAlert,\n    } from '@utils/assist';\n    import { debugScriptCache } from '@utils/cache-helper';\n    import { scriptVersionRule } from '@utils/validator';\n    import Layout from './components/layout';\n\n    const genDefaultFormData = () => ({\n        id: '',\n        typeName: 'Shell',\n        version: genDefaultScriptVersion(),\n        versionDesc: '',\n        type: 1,\n        content: '',\n    });\n\n    export default {\n        name: '',\n        components: {\n            JbInput,\n            AceEditor,\n            Layout,\n        },\n        inheritAttrs: false,\n        props: {\n            scriptInfo: {\n                type: Object,\n                required: true,\n            },\n            scriptVersionList: {\n                type: Array,\n                default: () => [],\n            },\n        },\n        data () {\n            return {\n                isLoading: true,\n                isSubmiting: false,\n                formData: genDefaultFormData(),\n                contentHeight: 0,\n            };\n        },\n        computed: {\n            versionMap () {\n                return this.scriptVersionList.reduce((result, item) => {\n                    if (item.scriptVersionId < 1) {\n                        return result;\n                    }\n                    result[item.version] = true;\n                    return result;\n                }, {});\n            },\n        },\n        watch: {\n            scriptInfo: {\n                handler (scriptInfo) {\n                    if (!scriptInfo.id) {\n                        return;\n                    }\n                    const {\n                        content,\n                        id,\n                        name,\n                        versionDesc,\n                        type,\n                        typeName,\n                    } = scriptInfo;\n                    this.formData = {\n                        ...genDefaultFormData(),\n                        id,\n                        name,\n                        versionDesc,\n                        type,\n                        typeName,\n                        content,\n                    };\n                },\n                immediate: true,\n            },\n        },\n        created () {\n            this.publicScript = checkPublicScript(this.$route);\n            this.scriptManageServiceHandler = this.publicScript ? PublicScriptManageService : ScriptManageService;\n            this.rules = {\n                version: [\n                    {\n                        required: true,\n                        message: '版本号必填',\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: scriptVersionRule.validator,\n                        message: scriptVersionRule.message,\n                        trigger: 'blur',\n                    },\n                    {\n                        validator: value => !this.versionMap[value],\n                        message: '版本号已存在，请重新输入',\n                        trigger: 'blur',\n                    },\n                ],\n                content: [\n                    {\n                        required: true,\n                        message: '脚本内容不能为空',\n                        trigger: 'change',\n                    },\n                    {\n                        validator: value => ScriptManageService.getScriptValidation({\n                            content: value,\n                            scriptType: this.formData.type,\n                        }).then((data) => {\n                            // 高危语句报错状态需要全局保存\n                            this.$store.commit('setScriptCheckError', data.some(_ => _.isDangerous));\n                            return true;\n                        }),\n                        message: '脚本内容检测失败',\n                        trigger: 'blur',\n                    },\n                ],\n            };\n        },\n        mounted () {\n            this.calcContentHeight();\n            const handleResize = _.throttle(this.calcContentHeight, 60);\n            window.addEventListener('resize', handleResize);\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('resize', handleResize);\n            });\n        },\n        methods: {\n            /**\n             * @desc 计算内容去高度\n             */\n            calcContentHeight () {\n                const contentOffsetTop = getOffset(this.$refs.content).top;\n                this.contentHeight = window.innerHeight - contentOffsetTop - 66;\n            },\n            handleUploadScript () {\n                this.$refs.aceEditor.handleUploadScript();\n            },\n            handleShowHistory () {\n                this.$refs.aceEditor.handleShowHistory();\n            },\n            handleFullScreen () {\n                this.$refs.aceEditor.handleFullScreen();\n            },\n            /**\n             * @desc 脚本版本修改\n             */\n            handleVersionChange: _.debounce(function (value) {\n                this.formData.version = value;\n                const { scriptVersionId } = this.scriptInfo;\n                this.$emit('on-create-change', scriptVersionId, {\n                    version: value,\n                });\n            }, 100),\n            /**\n             * @desc 脚本语言\n             * @param {String} scriptType 脚本语言\n             */\n            handleTypeChange (scriptType) {\n                this.formData.type = formatScriptTypeValue(scriptType);\n            },\n            /**\n             * @desc 保存脚本\n             */\n            handleSubmit () {\n                if (!this.formData.content) {\n                    this.messageError('脚本内容不能为空');\n                    return;\n                }\n                this.isSubmiting = true;\n                Promise.all([\n                    // 验证表单\n                    this.$refs.form.validate(),\n                    // 脚本高危语句检测\n                    ScriptManageService.getScriptValidation({\n                        content: this.formData.content,\n                        scriptType: this.formData.type,\n                    }).then((data) => {\n                        // 高危语句报错状态需要全局保存\n                        this.$store.commit('setScriptCheckError', data.some(_ => _.isDangerous));\n                        return true;\n                    }),\n                ]).then(() => {\n                    if (this.$store.state.scriptCheckError) {\n                        scriptErrorAlert();\n                        return;\n                    }\n                    this.scriptManageServiceHandler.scriptUpdate({\n                        ...this.formData,\n                    }).then((data) => {\n                        this.$emit('on-create', {\n                            scriptVersionId: data.scriptVersionId,\n                        });\n                        window.changeAlert = false;\n                        this.messageSuccess('操作成功');\n                    });\n                })\n                    .finally(() => {\n                        this.isSubmiting = false;\n                    });\n            },\n            /**\n             * @desc 跳转到快速执行脚本页面执行\n             */\n            handleDebugScript () {\n                debugScriptCache.setItem(this.formData.content);\n                const { href } = this.$router.resolve({\n                    name: 'fastExecuteScript',\n                    query: {\n                        model: 'debugScript',\n                    },\n                });\n                window.open(href);\n            },\n            /**\n             * @desc 取消新建\n             */\n            handleCancel () {\n                leaveConfirm()\n                    .then(() => {\n                        this.$emit('on-create-cancel');\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .script-manage-copy-create-box {\n        .script-version {\n            position: relative;\n\n            .new-flag {\n                position: absolute;\n                top: -32px;\n                left: 55px;\n                font-size: 32px;\n                color: #7d6b50;\n            }\n        }\n    }\n</style>\n","<template>\n    <div\n        ref=\"layout\"\n        class=\"script-version-page-layout\"\n        :class=\"{\n            'is-flod': flod,\n            toggled: isOpen,\n        }\">\n        <div class=\"layout-left\">\n            <div class=\"left-wraper\" :style=\"styles\">\n                <slot />\n            </div>\n            <div v-if=\"isShowRight\" class=\"toggle-button\" @click=\"handleToggle\">\n                <Icon type=\"down-small\" class=\"toggle-arrow\" />\n            </div>\n        </div>\n        <div v-if=\"flod\" class=\"layout-right\" :style=\"rightStyles\">\n            <div class=\"right-wraper\" :class=\"{ active: isShowRight }\">\n                <slot v-if=\"isShowRight\" name=\"flod\" />\n            </div>\n            <div class=\"close-btn\" @click=\"handleClose\">\n                <Icon type=\"close-big\" />\n            </div>\n        </div>\n    </div>\n</template>\n<script>\n    import {\n        getOffset,\n        leaveConfirm,\n    } from '@utils/assist';\n\n    export default {\n        name: '',\n        props: {\n            flod: {\n                type: Boolean,\n                default: false,\n            },\n        },\n        data () {\n            return {\n                isShowRight: false,\n                isOpen: false,\n                layoutWidth: 'auto',\n                layoutOffsetTop: 0,\n            };\n        },\n        computed: {\n            styles () {\n                if (this.flod) {\n                    return {\n                        width: '360px',\n                    };\n                }\n                return {\n                    width: this.layoutWidth,\n                };\n            },\n            rightStyles () {\n                const paddingBottom = 20;\n                return {\n                    height: `calc(100vh -  ${this.layoutOffsetTop + paddingBottom}px)`,\n                };\n            },\n        },\n        watch: {\n            flod: {\n                handler (flod) {\n                    if (flod) {\n                        setTimeout(() => {\n                            this.isShowRight = flod;\n                        }, 110);\n                    } else {\n                        this.isShowRight = false;\n                    }\n                },\n                immediate: true,\n            },\n        },\n        mounted () {\n            this.init();\n            window.addEventListener('resize', this.init);\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('resize', this.init);\n            });\n        },\n        methods: {\n            /**\n             * @desc 根据屏幕尺寸动态计算 layout 的位置信息\n             */\n            init () {\n                const layoutWidth = this.$refs.layout.getBoundingClientRect().width;\n                this.layoutWidth = `${layoutWidth}px`;\n                const offsetTop = getOffset(this.$refs.layout).top;\n                this.layoutOffsetTop = offsetTop;\n            },\n            handleToggle () {\n                this.isOpen = !this.isOpen;\n            },\n            handleClose () {\n                leaveConfirm()\n                    .then(() => {\n                        this.isOpen = false;\n                        this.$emit('on-flod');\n                        this.$emit('update:flod', false);\n                    });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .script-version-page-layout {\n        display: flex;\n\n        &.is-flod {\n            .bk-table-row {\n                cursor: pointer;\n            }\n        }\n\n        &.toggled {\n            margin-left: -24px;\n\n            .left-wraper {\n                width: 0 !important;\n            }\n\n            .toggle-button {\n                .toggle-arrow {\n                    transform: rotateZ(-90deg);\n                }\n            }\n\n            .layout-right {\n                margin-left: 24px;\n            }\n        }\n\n        .layout-left {\n            position: relative;\n            z-index: 9;\n            background: #fff;\n            outline: 1px solid #dfe0e5;\n            transition: all 0.15s;\n            flex: 0 0 auto;\n\n            .left-wraper {\n                transition: all 0.1s;\n            }\n\n            .bk-table::before {\n                content: unset;\n            }\n\n            .toggle-button {\n                position: absolute;\n                top: 50%;\n                right: -14px;\n                display: flex;\n                width: 14px;\n                height: 64px;\n                font-size: 24px;\n                color: #fff;\n                cursor: pointer;\n                background: #dcdee5;\n                border-top-right-radius: 6px;\n                border-bottom-right-radius: 6px;\n                transform: translateY(-50%);\n                align-items: center;\n                justify-content: center;\n\n                &:hover {\n                    background: #c4c6cc;\n                }\n            }\n\n            .toggle-arrow {\n                transform: rotateZ(90deg);\n            }\n        }\n\n        .layout-right {\n            position: relative;\n            margin-left: 16px;\n            overflow: hidden;\n            background: #fff;\n            border-radius: 2px;\n            transition: all 0.15s;\n            flex: 1;\n\n            .right-wraper {\n                opacity: 0%;\n                transition: all 0.5s;\n\n                &.active {\n                    opacity: 100%;\n                }\n            }\n\n            .close-btn {\n                position: absolute;\n                top: 8px;\n                right: 8px;\n                display: flex;\n                width: 26px;\n                height: 26px;\n                font-size: 16px;\n                color: #c4c6cc;\n                cursor: pointer;\n                border-radius: 50%;\n                align-items: center;\n                justify-content: center;\n\n                &:hover {\n                    background-color: #4d4d4d;\n                }\n            }\n        }\n    }\n</style>\n","<template>\n    <div\n        ref=\"wraper\"\n        class=\"script-version-basic-box\"\n        v-bkloading=\"{ isLoading }\">\n        <template v-if=\"data.id\">\n            <div class=\"script-type-flag\">\n                <img :src=\"`/static/images/script/${data.typeName}.svg`\">\n            </div>\n            <div class=\"detail-column\" style=\"width: 270px;\">\n                <div class=\"detail-col\">\n                    <div class=\"item-label\">{{ '脚本名：' }}</div>\n                    <div class=\"item-value\">\n                        <auth-component\n                            auth=\"script/edit\"\n                            :resource-id=\"data.id\">\n                            <jb-edit-input\n                                style=\"width: 100%;\"\n                                field=\"scriptName\"\n                                :value=\"data.name\"\n                                :remote-hander=\"val => handleUpdateScript('scriptName', val)\" />\n                            <div slot=\"forbid\">{{ data.name }}</div>\n                        </auth-component>\n                    </div>\n                </div>\n                <div class=\"detail-col\">\n                    <div class=\"item-label\">{{ '更新人：' }}</div>\n                    <div class=\"item-value\">\n                        <div class=\"text-box\" v-bk-overflow-tips>{{ data.lastModifyUser }}</div>\n                    </div>\n                </div>\n                <div class=\"detail-col\">\n                    <div class=\"item-label\">{{ '创建人：' }}</div>\n                    <div class=\"item-value\">\n                        <div class=\"text-box\" v-bk-overflow-tips>{{ data.creator }}</div>\n                    </div>\n                </div>\n            </div>\n            <div class=\"detail-column\" style=\"width: 282px;\">\n                <div class=\"detail-col\">\n                    <div class=\"item-label\">{{ '脚本语言：' }}</div>\n                    <div class=\"item-value\">\n                        <div class=\"text-box\">{{ data.typeName }}</div>\n                    </div>\n                </div>\n                <div class=\"detail-col\">\n                    <div class=\"item-label\">{{ '更新时间：' }}</div>\n                    <div class=\"item-value\">\n                        <div class=\"text-box\" v-bk-overflow-tips>{{ data.lastModifyTime }}</div>\n                    </div>\n                </div>\n                <div class=\"detail-col\">\n                    <div class=\"item-label\">{{ '创建时间：' }}</div>\n                    <div class=\"item-value\" v-bk-overflow-tips>\n                        <div class=\"text-box\">{{ data.createTime }}</div>\n                    </div>\n                </div>\n            </div>\n            <div class=\"detail-column last\">\n                <div class=\"detail-col\">\n                    <div class=\"item-label\">{{ '场景标签：' }}</div>\n                    <div class=\"item-value\">\n                        <auth-component\n                            auth=\"script/edit\"\n                            :resource-id=\"data.id\">\n                            <jb-edit-tag\n                                class=\"input\"\n                                field=\"scriptTags\"\n                                :rows=\"1\"\n                                :value=\"data.tags\"\n                                :remote-hander=\"val => handleUpdateScript('scriptTags', val)\" />\n                            <div slot=\"forbid\">{{ data.tagText }}</div>\n                        </auth-component>\n                    </div>\n                </div>\n                <div class=\"detail-col\">\n                    <div class=\"item-label\">{{ '脚本描述：' }}</div>\n                    <div class=\"item-value\">\n                        <jb-edit-textarea\n                            field=\"scriptDesc\"\n                            single-row-render\n                            :placeholder=\"'在此处标注该脚本的备注和使用说明'\"\n                            :maxlength=\"500\"\n                            :rows=\"1\"\n                            :value=\"data.description\"\n                            :remote-hander=\"val => handleUpdateScript('scriptDesc', val)\" />\n                    </div>\n                </div>\n            </div>\n        </template>\n    </div>\n</template>\n<script>\n    import ScriptService from '@service/script-manage';\n    import PublicScriptService from '@service/public-script-manage';\n    import { checkPublicScript } from '@utils/assist';\n    import JbEditInput from '@components/jb-edit/input';\n    import JbEditTag from '@components/jb-edit/tag';\n    import JbEditTextarea from '@components/jb-edit/textarea';\n\n    export default {\n        name: '',\n        components: {\n            JbEditInput,\n            JbEditTag,\n            JbEditTextarea,\n        },\n        data () {\n            return {\n                isLoading: true,\n                data: {},\n            };\n        },\n        created () {\n            this.publicScript = checkPublicScript(this.$route);\n            this.serviceHandler = this.publicScript ? PublicScriptService : ScriptService;\n            this.scriptId = this.$route.params.id;\n            this.fetchScriptBasic();\n        },\n        methods: {\n            /**\n             * @desc 获取脚本基本信息\n             */\n            fetchScriptBasic () {\n                this.isLoading = true;\n                this.serviceHandler.fetchBasicInfo({\n                    id: this.scriptId,\n                }).then((data) => {\n                    this.data = Object.freeze(data);\n                    this.calcLableWidth();\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc 计算脚本lable的宽度\n             */\n            calcLableWidth () {\n                this.$refs.wraper.querySelectorAll('.detail-column').forEach((columnEl) => {\n                    const $lableEles = columnEl.querySelectorAll('.item-label');\n                    let maxWidth = 0;\n                    $lableEles.forEach((ele) => {\n                        const { width } = ele.getBoundingClientRect();\n                        maxWidth = Math.max(maxWidth, width);\n                    });\n                    $lableEles.forEach((ele) => {\n                        ele.style.width = `${maxWidth + 2}px`;\n                    });\n                });\n            },\n            /**\n             * @desc 更新脚本基本信息\n             * @param {String} field 指定更新的字段名\n             * @param {Object} payload 更新的字段key和value\n             */\n            handleUpdateScript (field, payload) {\n                return this.serviceHandler.scriptUpdateMeta({\n                    id: this.scriptId,\n                    ...payload,\n                    updateField: field,\n                });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .script-version-basic-box {\n        position: relative;\n        display: flex;\n        height: 128px;\n        padding: 16px 24px;\n        background: #fff;\n        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 16%);\n\n        .script-type-flag {\n            flex: 0 0  auto;\n            margin-right: 20px;\n\n            img {\n                width: 100%;\n                height: 100%;\n            }\n        }\n\n        .detail-column {\n            display: flex;\n            line-height: 30px;\n            flex-direction: column;\n\n            &.last {\n                flex: 1;\n            }\n\n            .item-label {\n                flex: 0 0 auto;\n                color: #b2b5bd;\n            }\n\n            .item-value {\n                flex: 1;\n                width: 0;\n                padding-right: 20px;\n                color: #63656e;\n\n                .text-box {\n                    height: 32px;\n                    overflow: hidden;\n                    text-overflow: ellipsis;\n                    white-space: nowrap;\n                }\n            }\n        }\n\n        .detail-col {\n            display: flex;\n        }\n    }\n</style>\n","<template>\n    <div class=\"jb-diff-layout\"\n        :style=\"{\n            'z-index': zIndex,\n        }\">\n        <div class=\"header\">\n            <div class=\"title\">{{ title }}</div>\n            <div class=\"diff-info\">\n                <div class=\"diff-del\" @click=\"handleViewDel\">\n                    <span class=\"before\" />\n                    <span class=\"after\" />\n                    <span>{{ '删除' }}（{{ del }}）</span>\n                </div>\n                <div class=\"diff-change\" @click=\"handleViewChange\">\n                    <span class=\"before\" />\n                    <span class=\"after\" />\n                    <span>{{ '变换' }}（{{ change }}）</span>\n                </div>\n                <div class=\"diff-ins\" @click=\"handleViewIns\">\n                    <span class=\"before\" />\n                    <span class=\"after\" />\n                    <span>{{ '新增'}}（{{ ins }}）</span>\n                </div>\n            </div>\n        </div>\n        <div class=\"version-select-layout\">\n            <div class=\"version-left\">\n                <bk-select class=\"version-selector\" :clearable=\"false\" v-model=\"oldVersion\">\n                    <bk-option\n                        v-for=\"item in data\"\n                        :key=\"item.scriptVersionId\"\n                        :id=\"item.scriptVersionId\"\n                        :name=\"item.version\"\n                         />\n                </bk-select>\n            </div>\n            <div class=\"version-right\">\n                <bk-select class=\"version-selector\" :clearable=\"false\" v-model=\"newVersion\">\n                    <bk-option\n                        v-for=\"item in data\"\n                        :key=\"item.scriptVersionId\"\n                        :id=\"item.scriptVersionId\"\n                        :name=\"item.version\"\n                         />\n                </bk-select>\n            </div>\n        </div>\n        <scroll-faker class=\"content-wraper\">\n            <jb-diff\n                class=\"diff-details\"\n                format=\"side-by-side\"\n                theme=\"dark\"\n                ref=\"diff\"\n                :language=\"language\"\n                :context=\"Infinity\"\n                :old-content=\"oldContent\"\n                :new-content=\"newContent\" />\n        </scroll-faker>\n        <i class=\"bk-icon icon-close\" @click=\"handleClose\" />\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import { Base64 } from 'js-base64';\n\n    export default {\n        props: {\n            data: {\n                type: Array,\n                required: true,\n            },\n            title: {\n                type: String,\n                default: '',\n            },\n            oldVersionId: {\n                type: Number,\n                required: true,\n            },\n            newVersionId: {\n                type: Number,\n                required: true,\n            },\n        },\n        data () {\n            return {\n                oldVersion: this.oldVersionId,\n                newVersion: this.newVersionId,\n                zIndex: 'auto',\n                del: 0,\n                ins: 0,\n                change: 0,\n            };\n        },\n        computed: {\n            language () {\n                if (this.data.length < 1) {\n                    return '';\n                }\n                return this.data[0].typeName.toLocaleLowerCase();\n            },\n            oldContent () {\n                const script = _.find(this.data, _ => _.scriptVersionId === this.oldVersion);\n                if (script) {\n                    return Base64.decode(script.content);\n                }\n                return '';\n            },\n            newContent () {\n                const script = _.find(this.data, _ => _.scriptVersionId === this.newVersion);\n                if (script) {\n                    return Base64.decode(script.content);\n                }\n                return '';\n            },\n        },\n        watch: {\n            oldContent () {\n                this.statisticsDiff();\n            },\n            newContent () {\n                this.statisticsDiff();\n            },\n        },\n        created () {\n            this.scrollTopMemo = 0;\n            this.insElements = [];\n            this.insIndex = 0;\n            this.delElements = [];\n            this.delIndex = 0;\n            this.changeElements = [];\n            this.changeIndex = 0;\n        },\n        mounted () {\n            this.zIndex = window.__bk_zIndex_manager.nextZIndex(); // eslint-disable-line no-underscore-dangle\n            document.body.append(this.$el);\n            window.addEventListener('keydown', this.handleEsc);\n            this.resetBodyStyle();\n            this.statisticsDiff();\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('keydown', this.handleEsc);\n                try {\n                    document.body.removeChild(this.$el);\n                } catch {}\n            });\n        },\n        methods: {\n            statisticsDiff () {\n                this.$nextTick(() => {\n                    const $contentTarget = this.$refs.diff.$el.querySelectorAll('.d2h-file-side-diff');\n                    const $newTarget = $contentTarget[1];// eslint-disable-line prefer-destructuring\n                    const $allChangeElemennts = Array.from($newTarget.querySelectorAll('td.d2h-code-side-linenumber.d2h-ins'));\n                    $allChangeElemennts.pop();\n\n                    this.insElements = [];\n                    this.ins = 0;\n                    this.insIndex = 0;\n                    this.changeElements = [];\n                    this.change = 0;\n                    this.changeIndex = 0;\n\n                    $allChangeElemennts.forEach((ele) => {\n                        if (ele.classList.contains('d2h-change')) {\n                            this.changeElements.push(ele);\n                            this.change += 1;\n                        } else {\n                            this.insElements.push(ele);\n                            this.ins += 1;\n                        }\n                    });\n                    \n                    const $dels = $newTarget.querySelectorAll('td.d2h-code-side-linenumber.d2h-code-side-emptyplaceholder');\n                    this.delElements = $dels;\n                    this.del = $dels.length;\n                    this.delIndex = 0;\n\n                    this.lineElements = $newTarget.querySelectorAll('td.d2h-code-side-linenumber');\n                });\n            },\n            lineViewReset () {\n                this.lineElements.forEach((item) => {\n                    item.classList.remove('active');\n                });\n            },\n            handleViewDel () {\n                this.lineViewReset();\n                if (this.del < 1) {\n                    return;\n                }\n                const $target = this.delElements[this.delIndex];\n                $target.scrollIntoView();\n                $target.classList.add('active');\n                this.changeIndex = 0;\n                this.insIndex = 0;\n                this.delIndex += 1;\n                if (this.delIndex >= this.del) {\n                    this.delIndex = 0;\n                }\n            },\n            handleViewChange () {\n                this.lineViewReset();\n                if (this.change < 1) {\n                    return;\n                }\n                const $target = this.changeElements[this.changeIndex];\n                $target.scrollIntoView();\n                $target.classList.add('active');\n                this.insIndex = 0;\n                this.delIndex = 0;\n                this.changeIndex += 1;\n                if (this.changeIndex >= this.change) {\n                    this.changeIndex = 0;\n                }\n            },\n            handleViewIns () {\n                this.lineViewReset();\n                if (this.ins < 1) {\n                    return;\n                }\n                const $target = this.insElements[this.insIndex];\n                $target.scrollIntoView();\n                $target.classList.add('active');\n                this.delIndex = 0;\n                this.changeIndex = 0;\n                this.insIndex += 1;\n                if (this.insIndex >= this.ins) {\n                    this.insIndex = 0;\n                }\n            },\n            handleEsc (event) {\n                if (event && event.code === 'Escape') {\n                    this.handleClose();\n                }\n            },\n            handleClose () {\n                this.$emit('on-change', {\n                    [this.oldVersion]: true,\n                    [this.newVersion]: true,\n                });\n                this.$emit('close');\n            },\n            resetBodyStyle () {\n                this.scrollTopMemo = document.scrollingElement.scrollTop;\n                document.scrollingElement.style.overflow = 'hidden';\n            },\n            recoveryBodyStyle () {\n                document.scrollingElement.style.overflow = 'initial';\n                document.scrollingElement.scrollTop = this.scrollTopMemo;\n            },\n        },\n    };\n</script>\n<style lang=\"postcss\">\n    .jb-diff-layout {\n        position: fixed;\n        top: 0;\n        right: 0;\n        bottom: 0;\n        left: 0;\n        padding: 0 40px;\n        background-color: #fafbfd;\n\n        .header {\n            display: flex;\n            height: 40px;\n            align-items: center;\n\n            .title {\n                font-size: 14px;\n                color: #313238;\n            }\n\n            .diff-info {\n                display: flex;\n                margin-right: 114px;\n                margin-left: auto;\n                font-size: 12px;\n                line-height: 1em;\n                align-items: center;\n\n                .diff-del,\n                .diff-change,\n                .diff-ins {\n                    display: flex;\n                    margin-left: 30px;\n                    cursor: pointer;\n                    user-select: none;\n                }\n\n                .diff-del {\n                    color: #bd5c58;\n\n                    .before {\n                        background: #b1615b;\n                    }\n\n                    .after {\n                        background: #dcdcdc;\n                    }\n                }\n\n                .diff-change {\n                    color: #63656e;\n\n                    .before {\n                        background: #b1615b;\n                    }\n\n                    .after {\n                        background: #9aad76;\n                    }\n                }\n\n                .diff-ins {\n                    color: #9aad76;\n\n                    .before {\n                        background: #dcdcdc;\n                    }\n\n                    .after {\n                        background: #9aad76;\n                    }\n                }\n\n                .before,\n                .after {\n                    width: 1em;\n                    height: 1em;\n                }\n\n                .after {\n                    margin-right: 6px;\n                    margin-left: 1px;\n                }\n            }\n        }\n\n        .version-select-layout {\n            display: flex;\n            height: 51px;\n            margin: 6px 0 0;\n            background: #2f3033;\n            border-radius: 2px 2px 0 0;\n\n            .version-left,\n            .version-right {\n                display: flex;\n                padding: 0 10px;\n                flex: 0 0 50%;\n                align-items: center;\n            }\n\n            .version-left {\n                border-right: 1px solid #dcdee5;\n            }\n\n            .bk-select {\n                color: #dcdee5;\n                background: #393a3d;\n                border-color: #393a3d;\n            }\n        }\n\n        .version-selector {\n            width: 300px;\n        }\n\n        .content-wraper {\n            max-height: calc(100vh - 92px);\n            background: #1d1d1d;\n        }\n\n        .d2h-file-wrapper {\n            border: none;\n        }\n\n        .diff-details {\n            position: relative;\n            background-color: #272822;\n        }\n\n        .d2h-code-side-linenumber {\n            line-height: 20px;\n\n            &.active::before {\n                float: left;\n                width: 10px;\n                height: 10px;\n                margin-top: 5px;\n                margin-left: 13px;\n                background: #666;\n                border-radius: 50%;\n                content: \"\";\n            }\n        }\n\n        .icon-close {\n            position: absolute;\n            top: 8px;\n            right: 8px;\n            font-size: 28px;\n            color: #313238;\n            cursor: pointer;\n            transition: all 0.1s;\n\n            &:hover {\n                transform: rotateZ(90deg);\n            }\n        }\n    }\n</style>\n","<template>\n    <div class=\"script-manage-version-page\">\n        <script-basic />\n        <div class=\"version-list-wraper\">\n            <list-action-layout>\n                <bk-button\n                    ref=\"newVersion\"\n                    @click=\"handlNewVersion\">\n                    {{ '新建版本' }}\n                </bk-button>\n                <bk-button\n                    \n                    @click=\"handlShowDiff\">\n                    {{ '版本对比' }}\n                </bk-button>\n                <template #right>\n                    <jb-search-select\n                        @on-change=\"handleSearch\"\n                        :data=\"searchSelect\"\n                        :placeholder=\"'直接输入 版本号 或 更新人 进行全局模糊搜索'\"\n                        :show-condition=\"false\"\n                        style=\"width: 420px;\" />\n                </template>\n            </list-action-layout>\n            <div ref=\"list\">\n                <layout :flod=\"isListFlod\" @on-flod=\"handleLayoutFlod\">\n                    <bk-table\n                        v-if=\"tableHeight\"\n                        class=\"script-version-list\"\n                        :data=\"renderList\"\n                        :outer-border=\"false\"\n                        :max-height=\"tableHeight\"\n                        @row-click=\"handleRowSelect\"\n                        @sort-change=\"handleSortChange\"\n                        :size=\"tableSize\"\n                        :row-class-name=\"rowClassName\">\n                        <bk-table-column\n                            key=\"selection\"\n                            width=\"47\"\n                            align=\"center\"\n                            :resizable=\"false\">\n                            <template slot-scope=\"{ row }\">\n                                <bk-checkbox\n                                    \n                                    :checked=\"isRowChecked(row)\"\n                                    @change=\"checked => handleSelectionChange(row, checked)\" />\n                            </template>\n                        </bk-table-column>\n                        <bk-table-column\n                            v-if=\"allColumnMap.scriptVersionId\"\n                            :label=\"'版本 ID'\"\n                            prop=\"scriptVersionId\"\n                            key=\"scriptVersionId\"\n                            align=\"left\"\n                            width=\"100\" />\n                        <bk-table-column\n                            v-if=\"allColumnMap.version\"\n                            :label=\"'版本号'\"\n                            prop=\"version\"\n                            key=\"version\"\n                            align=\"left\"\n                            show-overflow-tooltip\n                            :sortable=\"true\">\n                            <template slot-scope=\"{ row }\">\n                                <a @click=\"handleShowDetail(row)\">{{ row.version || '--' }}</a>\n                            </template>\n                        </bk-table-column>\n                        <bk-table-column\n                            v-if=\"allColumnMap.relatedTaskNum\"\n                            :label=\"'被引用'\"\n                            prop=\"relatedTaskNum\"\n                            key=\"relatedTaskNum\"\n                            :render-header=\"renderHeader\"\n                            align=\"right\"\n                            width=\"150\">\n                            <template slot-scope=\"{ row }\">\n                                <bk-button\n                                    class=\"mr20\"\n                                    text\n                                    v-bk-tooltips.allowHtml=\"`\n                                    <div>${'作业模板引用'}: ${row.relatedTaskTemplateNum}</div>\n                                    <div>${'执行方案引用'}: ${row.relatedTaskPlanNum}</div>`\"\n                                    @click=\"handleShowRelated(row)\">\n                                    <span>\n                                        {{ row.relatedTaskTemplateNum }}\n                                    </span>\n                                    <span> / </span>\n                                    <span>\n                                        {{ row.relatedTaskPlanNum }}\n                                    </span>\n                                </bk-button>\n                            </template>\n                        </bk-table-column>\n                        <bk-table-column\n                            v-if=\"allColumnMap.lastModifyUser\"\n                            :label=\"'更新人'\"\n                            prop=\"lastModifyUser\"\n                            key=\"lastModifyUser\"\n                            align=\"left\"\n                            width=\"160\" />\n                        <bk-table-column\n                            v-if=\"allColumnMap.lastModifyTime\"\n                            :label=\"'更新时间'\"\n                            prop=\"lastModifyTime\"\n                            key=\"lastModifyTime\"\n                            align=\"left\"\n                            width=\"200\"\n                            :sortable=\"true\" />\n                        <bk-table-column\n                            v-if=\"allColumnMap.statusDesc\"\n                            :label=\"'状态'\"\n                            prop=\"statusDesc\"\n                            key=\"statusDesc\"\n                            align=\"left\"\n                            width=\"120\"\n                            :sortable=\"true\">\n                            <template slot-scope=\"{ row }\">\n                                <span v-html=\"row.statusHtml\" />\n                                <Icon\n                                    v-show=\"row.scriptVersionId === selectVersionId\"\n                                    class=\"select-flag\"\n                                    type=\"arrow-full-right\" />\n                            </template>\n                        </bk-table-column>\n                        <bk-table-column\n                            v-if=\"!isListFlod\"\n                            :label=\"'操作'\"\n                            prop=\"action\"\n                            key=\"action\"\n                            align=\"left\"\n                            width=\"400\">\n                            <div slot-scope=\"{ row }\" @click.stop=\"\">\n                                <jb-popover-confirm\n                                    v-if=\"!row.isOnline\"\n                                    class=\"mr10\"\n                                    :title=\"'确定上线该版本？'\"\n                                    :content=\"'上线后，之前的线上版本将被置为「已下线」状态，但不影响作业使用'\"\n                                    \n                                    :confirm-handler=\"() => handleOnline(row.id, row.scriptVersionId)\">\n                                    <auth-button\n                                        :permission=\"row.canManage\"\n                                        :resource-id=\"row.id\"\n                                        auth=\"script/edit\"\n                                        \n                                        text>\n                                        {{ '上线' }}\n                                    </auth-button>\n                                </jb-popover-confirm>\n                                <jb-popover-confirm\n                                    class=\"mr10\"\n                                    :title=\"'确定禁用该版本？'\"\n                                    :content=\"'一旦禁用成功，线上引用该版本的作业脚本步骤都会执行失败，请务必谨慎操作！'\"\n                                    :confirm-handler=\"() => handleOffline(row.id, row.scriptVersionId)\">\n                                    <auth-button\n                                        :permission=\"row.canManage\"\n                                        :resource-id=\"row.id\"\n                                        auth=\"script/edit\"\n                                        text>\n                                        {{ '禁用' }}\n                                    </auth-button>\n                                </jb-popover-confirm>\n                                <auth-button\n                                    class=\"mr10\"\n                                    :permission=\"row.canManage\"\n                                    :resource-id=\"row.id\"\n                                    auth=\"script/edit\"\n                                    text\n                                    @click=\"handleEdit(row)\">\n                                    {{ '编辑' }}\n                                </auth-button>\n                                <span\n                                    class=\"mr10\"\n                                    :tippy-tips=\"isCopyCreateDisabled ? '已有[未上线]版本' : ''\">\n                                    <auth-button\n                                        :permission=\"row.canClone\"\n                                        :resource-id=\"row.id\"\n                                        auth=\"script/clone\"\n                                        \n                                        text\n                                        @click=\"handleToggleCopyCreate(row)\">\n                                        {{ '复制并新建' }}\n                                    </auth-button>\n                                </span>\n                                <auth-button\n                                    text\n                                    :permission=\"row.canManage\"\n                                    auth=\"script/execute\"\n                                    :resource-id=\"row.id\"\n                                    \n                                    @click=\"handleGoExce(row)\">\n                                    {{ '去执行' }}\n                                </auth-button>\n                                <span :tippy-tips=\"!row.syncEnabled ? '所有关联作业模板已是当前版本' : ''\">\n                                    <auth-button\n                                        :permission=\"row.canManage\"\n                                        :resource-id=\"row.id\"\n                                        auth=\"script/edit\"\n                                        class=\"ml10\"\n                                        \n                                        @click=\"handleSync(row)\"\n                                        text>\n                                        {{ '同步' }}\n                                    </auth-button>\n                                </span>\n                                <jb-popover-confirm\n                                    :title=\"'确定删除该版本？'\"\n                                    :content=\"'删除后不可恢复，请谨慎操作！'\"\n                                    :confirm-handler=\"() => handleRemove(row.scriptVersionId)\">\n                                    <auth-button\n                                        :permission=\"row.canManage\"\n                                        :resource-id=\"row.id\"\n                                        auth=\"script/delete\"\n                                        text>\n                                        {{ '删除' }}\n                                    </auth-button>\n                                </jb-popover-confirm>\n                            </div>\n                        </bk-table-column>\n                        <bk-table-column type=\"setting\">\n                            <bk-table-setting-content\n                                :fields=\"tableColumn\"\n                                :selected=\"selectedTableColumn\"\n                                :size=\"tableSize\"\n                                @setting-change=\"handleSettingChange\" />\n                        </bk-table-column>\n                    </bk-table>\n                    <template slot=\"flod\">\n                        <component\n                            :is=\"curCom\"\n                            :script-version-list=\"data\"\n                            :script-info=\"selectVersion\"\n                            @on-edit-change=\"handleScriptChangeSubmit\"\n                            @on-go-copy-create=\"handleToggleCopyCreate\"\n                            @on-go-edit=\"handleToggleEdit\"\n                            @on-delete=\"handleDeleteSubmit\"\n                            @on-create-change=\"handleCreateValueChange\"\n                            @on-create=\"handleCreateSubmit\"\n                            @on-create-cancel=\"handleCreateCancel\"\n                            @on-edit=\"handleEditSubmit\"\n                            @on-edit-cancel=\"handleEditCancel\" />\n                    </template>\n                </layout>\n            </div>\n        </div>\n        <div style=\"display: none;\">\n            <div id=\"newVersionDisableActions\" style=\"padding: 16px 12px;\">\n                <div style=\"margin-bottom: 17px; font-size: 14px; line-height: 22px; color: #313238;\">\n                    {{ '已有[未上线]版本' }}\n                </div>\n                <div>\n                    <bk-button\n                        theme=\"primary\"\n                        size=\"small\"\n                        style=\"margin-right: 8px;\"\n                        @click=\"handleEditDraftVersion\">\n                        {{ '前往编辑' }}\n                    </bk-button>\n                    <bk-button\n                        size=\"small\"\n                        @click=\"handleNewVersionClose\">\n                        {{ '取消' }}\n                    </bk-button>\n                </div>\n            </div>\n        </div>\n        <element-teleport v-if=\"currentVersionName\">\n            <span> - {{ currentVersionName }}</span>\n        </element-teleport>\n        <Diff\n            v-if=\"showDiff\"\n            :title=\"'版本对比'\"\n            :data=\"dataMemo\"\n            :old-version-id=\"diffInfo.oldVersionId\"\n            :new-version-id=\"diffInfo.newVersionId\"\n            @on-change=\"handleDiffVersionChange\"\n            @close=\"handleDiffClose\" />\n        <jb-sideslider\n            :is-show.sync=\"showRelated\"\n            :show-footer=\"false\"\n            quick-close\n            :title=\"'被引用'\"\n            :width=\"695\">\n            <script-related-info\n                :info=\"relatedScriptInfo\"\n                mode=\"scriptVersionList\" />\n        </jb-sideslider>\n        <jb-dialog\n            v-model=\"isShowNewVersion\"\n            header-position=\"left\"\n            :title=\"'新建版本'\"\n            :ok-text=\"'确定'\"\n            :mask-close=\"false\"\n            :width=\"480\">\n            <new-version\n                :version-list=\"data\"\n                @on-close=\"handleNewVersionClose\"\n                @on-create=\"handleToggleCopyCreate\" />\n        </jb-dialog>\n    </div>\n</template>\n<script>\n    import _ from 'lodash';\n    import Tippy from 'bk-magic-vue/lib/utils/tippy';\n       import ScriptService from '@service/script-manage';\n    import PublicScriptService from '@service/public-script-manage';\n    import NotifyService from '@service/notify';\n    import ScriptModel from '@model/script/script';\n    import JbSearchSelect from '@components/jb-search-select';\n    import ListActionLayout from '@components/list-action-layout';\n    import JbPopoverConfirm from '@components/jb-popover-confirm';\n    import {\n        checkPublicScript,\n        leaveConfirm,\n        getOffset,\n        genDefaultScriptVersion,\n        encodeRegexp,\n    } from '@utils/assist';\n    import { listColumnsCache } from '@utils/cache-helper';\n    import ScriptRelatedInfo from '../common/script-related-info';\n    import DetailScript from '../common/detail/index';\n    import Edit from '../common/edit';\n    import CopyCreate from '../common/copy-create';\n    import Layout from './components/layout';\n    import ScriptBasic from './components/script-basic';\n    import Diff from './components/diff';\n    import NewVersion from './components/new-version';\n\n    const TABLE_COLUMN_CACHE = 'script_version_list_columns';\n\n    export default {\n        name: 'ScriptVersion',\n        components: {\n            ListActionLayout,\n            JbPopoverConfirm,\n            JbSearchSelect,\n            ScriptRelatedInfo,\n            Diff,\n            Layout,\n            DetailScript,\n            Edit,\n            CopyCreate,\n            ScriptBasic,\n            NewVersion,\n        },\n        data () {\n            return {\n                isLoading: false,\n                isListFlod: false,\n                isShowNewVersion: false,\n                showDiff: false,\n                data: [{},{},{}],\n                dataAppendList: [{},{},{}],\n                scriptDetailInfo: {},\n                tableHeight: '',\n                selectedTableColumn: [],\n                selectVersionId: '',\n                choosedMap: {},\n                showRelated: false,\n                relatedScriptInfo: [],\n                displayCom: '',\n                tableSize: 'small',\n            };\n        },\n        computed: {\n            /**\n             * @desc 骨架屏 Loading\n             * @returns { Boolean }\n             */\n            isSkeletonLoading () {\n                return this.isLoading;\n            },\n            /**\n             * @desc 脚本展示状态组件\n             * @returns { Object }\n             */\n            curCom () {\n                if (!this.displayCom) {\n                    return 'div';\n                }\n                const comMap = {\n                    detail: DetailScript,\n                    edit: Edit,\n                    copyCreate: CopyCreate,\n                };\n                return comMap[this.displayCom];\n            },\n            /**\n             * @desc 列表数据\n             * @returns { Array }\n             */\n            renderList () {\n                return [\n                    ...this.dataAppendList,\n                    ...this.data,\n                ];\n            },\n            /**\n             * @desc 已存在未上线版本不允许新建版本\n             * @returns { Boolean }\n             */\n            isCopyCreateDisabled () {\n                return !!_.find(this.dataMemo, scriptVersion => scriptVersion.isDraft);\n            },\n            /**\n             * @desc 选中的脚本版本\n             * @returns { Object }\n             */\n            selectVersion () {\n                const current = _.find(this.renderList, _ => _.scriptVersionId === this.selectVersionId);\n                if (!current) {\n                    return {};\n                }\n                return current;\n            },\n            /**\n             * @desc 需要选中两个脚本才能对比\n             * @returns { Boolean }\n             */\n            disableDiff () {\n                return Object.keys(this.choosedMap).length < 2;\n            },\n            /**\n             * @desc 将要对比的脚本数据\n             * @returns { Object }\n             */\n            diffInfo () {\n                const diffVersion = Object.keys(this.choosedMap);\n                return {\n                    oldVersionId: parseInt(diffVersion[0], 10) || '',\n                    newVersionId: parseInt(diffVersion[1], 10) || '',\n                };\n            },\n            /**\n             * @desc 当前脚本版本的 name\n             * @returns { String }\n             */\n            currentVersionName () {\n                if (this.dataMemo.length < 1) {\n                    return '';\n                }\n                return this.dataMemo[0].name;\n            },\n            /**\n             * @desc 展示的列表列\n             * @returns { Object }\n             */\n            allColumnMap () {\n                if (this.isListFlod) {\n                    return {\n                        version: true,\n                        statusDesc: true,\n                    };\n                }\n                return this.selectedTableColumn.reduce((result, item) => {\n                    result[item.id] = true;\n                    return result;\n                }, {});\n            },\n        },\n        watch: {\n            displayCom (displayCom) {\n                // 当右侧详情面板切换时，需要重置dataAppendList\n                if (displayCom !== 'copyCreate') {\n                    this.dataAppendList = [];\n                }\n            },\n        },\n        created () {\n            // 缓存状态切换中的中间状态\n            this.lastSelectScriptVersionId = '';\n            // 缓存脚本版本的完整数据列表——用于脚本搜索\n            this.dataMemo = [];\n\n            this.publicScript = checkPublicScript(this.$route);\n            this.serviceHandler = this.publicScript ? PublicScriptService : ScriptService;\n            this.scriptId = this.$route.params.id;\n\n            this.fetchData(true);\n            \n            this.searchSelect = [\n                {\n                    name: '版本号',\n                    id: 'version',\n                    default: true,\n                },\n                {\n                    name: '更新人',\n                    id: 'lastModifyUser',\n                    remoteMethod: NotifyService.fetchUsersOfSearch,\n                    inputInclude: true,\n                },\n            ];\n            this.tableColumn = [\n                {\n                    id: 'scriptVersionId',\n                    label: '版本 ID',\n                },\n                {\n                    id: 'version',\n                    label: '版本号',\n                    disabled: true,\n                },\n                {\n                    id: 'relatedTaskNum',\n                    label: '被引用',\n                    disabled: true,\n                },\n                {\n                    id: 'lastModifyUser',\n                    label: '更新人',\n                },\n                {\n                    id: 'lastModifyTime',\n                    label: '更新时间',\n                },\n                {\n                    id: 'statusDesc',\n                    label: '状态',\n                    disabled: true,\n                },\n            ];\n            const columnsCache = listColumnsCache.getItem(TABLE_COLUMN_CACHE);\n            if (columnsCache) {\n                this.selectedTableColumn = Object.freeze(columnsCache.columns);\n                this.tableSize = columnsCache.size;\n            } else {\n                this.selectedTableColumn = Object.freeze([\n                    { id: 'version' },\n                    { id: 'relatedTaskNum' },\n                    { id: 'lastModifyUser' },\n                    { id: 'lastModifyTime' },\n                    { id: 'statusDesc' },\n                ]);\n            }\n        },\n        mounted () {\n            this.calcTableHeight();\n            window.addEventListener('resize', this.calcTableHeight);\n            this.$once('hook:beforeDestroy', () => {\n                window.removeEventListener('resize', this.calcTableHeight);\n            });\n        },\n        methods: {\n            /**\n             * @desc 获取脚本版本列表数据\n             * @param {Boolean} isFirst 第一次调用\n             *\n             * 需要解析url参数\n             */\n            fetchData (isFirst) {\n                this.isLoading = true;\n                return this.serviceHandler.scriptVersionList({\n                    id: this.scriptId,\n                }, {\n                    permission: 'page',\n                }).then((data) => {\n                    this.dataMemo = Object.freeze([\n                        ...data,\n                    ]);\n                    this.data = Object.freeze(data);\n\n                    if (isFirst) {\n                        this.parseUrl();\n                    }\n                })\n                    .finally(() => {\n                        this.isLoading = false;\n                    });\n            },\n            /**\n             * @desc URL链接指定了脚本版本\n             *\n             * 进入脚本详情模式\n             */\n            parseUrl () {\n                const scriptVersionId = parseInt(this.$route.query.scriptVersionId, 10);\n                if (scriptVersionId) {\n                    this.handleShowDetail({\n                        scriptVersionId,\n                    });\n                }\n            },\n            /**\n             * @desc 计算表格高度\n             */\n            calcTableHeight () {\n                const { top } = getOffset(this.$refs.list);\n                const windowHeight = window.innerHeight;\n                this.tableHeight = windowHeight - top - 20;\n            },\n            \n            rowClassName ({ row }) {\n                return row.scriptVersionId === this.selectVersionId ? 'active' : '';\n            },\n            /**\n             * @desc 新建脚本版本\n             */\n            handlNewVersion () {\n                if (!this.isCopyCreateDisabled) {\n                    this.isShowNewVersion = true;\n                    return;\n                }\n                // 已有未上线脚本给出提示\n                if (!this.newVersionPopperInstance) {\n                    this.newVersionPopperInstance = Tippy(this.$refs.newVersion.$el, {\n                        arrow: true,\n                        width: 192,\n                        placement: 'bottom-start',\n                        trigger: 'manual',\n                        theme: 'light',\n                        interactive: true,\n                        animation: 'slide-toggle',\n                        content: document.querySelector('#newVersionDisableActions'),\n                        boundary: 'window',\n                        distance: 20,\n                        zIndex: window.__bk_zIndex_manager.nextZIndex(), // eslint-disable-line no-underscore-dangle\n                    });\n                    this.$once('hook:beforeDestroy', () => {\n                        this.newVersionPopperInstance.hide();\n                        this.newVersionPopperInstance.destroy();\n                    });\n                }\n                this.newVersionPopperInstance.show();\n            },\n            /**\n             * @desc 编辑最新的未上线脚本版本\n             */\n            handleEditDraftVersion () {\n                const lastestDraftScriptVersion = _.find(this.dataMemo, scriptVersion => scriptVersion.isDraft);\n                this.handleEdit(lastestDraftScriptVersion);\n                this.newVersionPopperInstance.hide();\n            },\n            /**\n             * @desc 取消新建版本\n             */\n            handleNewVersionClose () {\n                this.newVersionPopperInstance && this.newVersionPopperInstance.hide();\n                this.isShowNewVersion = false;\n            },\n            /**\n             * @desc 列表搜索\n             * @param {Object} payload 搜索字段\n             */\n            handleSearch (payload) {\n                let list = this.dataMemo;\n                Object.keys(payload).forEach((key) => {\n                    const reg = new RegExp(encodeRegexp(payload[key]));\n                    list = list.filter(item => reg.test(item[key]));\n                });\n                this.data = Object.freeze(list);\n                this.handleLayoutFlod();\n            },\n            /**\n             * @desc 列表排序\n             * @param {Object} payload 排序字段\n             */\n            handleSortChange (payload) {\n                if (payload.prop) {\n                    const key = payload.prop;\n                    const list = [\n                        ...this.data,\n                    ];\n                    list.sort((preItem, nextItem) => {\n                        if (payload.order === 'descending') {\n                            return preItem[key] - nextItem[key];\n                        }\n                        return nextItem[key] - preItem[key];\n                    });\n                }\n            },\n            /**\n             * @desc 自定义列表配置\n             */\n            handleSettingChange ({ fields, size }) {\n                this.selectedTableColumn = Object.freeze(fields);\n                this.tableSize = size;\n                listColumnsCache.setItem(TABLE_COLUMN_CACHE, {\n                    columns: fields,\n                    size,\n                });\n            },\n            /**\n             * @desc 布局切换\n             */\n            handleLayoutFlod () {\n                this.displayCom = '';\n                this.isListFlod = false;\n                if (this.selectVersionId === -1) {\n                    // 还原复制并新建的占位数据\n                    this.handleCreateCancel();\n                }\n                this.selectVersionId = '';\n            },\n            /**\n             * @desc 选中一行\n             * @param {Object} payload 脚本数据\n             * @param {Boolean} checked 选择状态\n             */\n            handleSelectionChange (payload, checked) {\n                if (checked) {\n                    this.choosedMap[payload.scriptVersionId] = true;\n                } else {\n                    delete this.choosedMap[payload.scriptVersionId];\n                }\n                this.choosedMap = { ...this.choosedMap };\n            },\n            /**\n             * @desc 点击版本名查看详情\n             * @param {Object} row 脚本数据\n             */\n            handleShowDetail (row) {\n                leaveConfirm()\n                    .then(() => {\n                        this.selectVersionId = row.scriptVersionId;\n                        this.isListFlod = true;\n                        this.displayCom = 'detail';\n                    });\n            },\n            /**\n             * @desc 鼠标选中一行\n             * @param {Object} row 脚本数据\n             */\n            handleRowSelect (row) {\n                if (this.isListFlod) {\n                    this.handleShowDetail(row);\n                }\n            },\n            /**\n             * @desc 下线\n             * @param {Number} id 脚本id\n             * @param {String} versionId\n             */\n            handleOffline (id, versionId) {\n                return this.serviceHandler.scriptVersionOffline({\n                    id,\n                    versionId,\n                }).then(() => {\n                    this.messageSuccess('操作成功');\n                    this.fetchData();\n                });\n            },\n            /**\n             * @desc 上线\n             * @param {Number} id 脚本id\n             * @param {String} versionId 脚本版本id\n             */\n            handleOnline (id, versionId) {\n                return this.serviceHandler.scriptVersionOnline({\n                    id,\n                    versionId,\n                }).then(() => {\n                    this.messageSuccess('操作成功');\n                    this.fetchData();\n                });\n            },\n            /**\n             * @desc 删除\n             * @param {String} versionId 脚本版本id\n             */\n            handleRemove (versionId) {\n                return this.serviceHandler.scriptVersionRemove({\n                    versionId,\n                }).then(() => {\n                    this.messageSuccess('删除成功');\n                    this.fetchData();\n                });\n            },\n            /**\n             * @desc 执行\n             * @param {Object} payload 脚本数据\n             */\n            handleGoExce (payload) {\n                this.$router.push({\n                    name: 'fastExecuteScript',\n                    params: {\n                        taskInstanceId: 0,\n                        scriptVersionId: payload.scriptVersionId,\n                    },\n                    query: {\n                        from: 'scriptDetail',\n                    },\n                });\n            },\n            /**\n             * @desc 同步\n             * @param {Object} row 脚本数据\n             */\n            handleSync (row) {\n                const routerName = this.publicScript ? 'scriptPublicSync' : 'scriptSync';\n                \n                this.$router.push({\n                    name: routerName,\n                    params: {\n                        scriptId: 4 || row.id,\n                        scriptVersionid: 4 || row.scriptVersionId,\n                    },\n                });\n            },\n            /**\n             * @desc 编辑脚本版本\n             * @param {Object} scriptInfo 脚本数据\n             */\n            handleEdit (scriptInfo) {\n                this.selectVersionId = scriptInfo.scriptVersionId;\n                this.displayCom = 'edit';\n                this.isListFlod = true;\n                this.isShowNewVersion = false;\n            },\n            /**\n             * @desc 显示脚本引用列表\n             * @param {String} mode 引用的模板、执行方案\n             * @param {Object} payload 脚本数据\n             */\n            handleShowRelated (payload) {\n                this.showRelated = true;\n                this.relatedScriptInfo = payload;\n            },\n            /**\n             * @desc 显示脚本差异弹层\n             * @param {Object} payload\n             */\n            handlShowDiff () {\n                this.showDiff = true;\n            },\n            /**\n             * @desc 脚本对比版本切换\n             * @param {Object} payload\n             */\n            handleDiffVersionChange (payload) {\n                this.choosedMap = payload;\n            },\n            /**\n             * @desc 关闭脚本对比弹层\n             */\n            handleDiffClose () {\n                this.showDiff = false;\n            },\n            /**\n             * @desc 编辑成功刷新列表\n             */\n            handleScriptChangeSubmit () {\n                this.fetchData();\n            },\n            /**\n             * @desc 删除成功\n             *\n             * 更新布局、刷新列表\n             */\n            handleDeleteSubmit () {\n                this.handleLayoutFlod();\n                this.fetchData();\n            },\n            /**\n             * @desc 切换到复制并新建状态\n             */\n            handleToggleCopyCreate ({ scriptVersionId }) {\n                this.selectVersionId = scriptVersionId;\n                const currentScriptVersion = _.find(this.dataMemo, _ => _.scriptVersionId === scriptVersionId);\n                const newScriptVersion = new ScriptModel({\n                    ...currentScriptVersion,\n                    scriptVersionId: -1,\n                    status: -1,\n                    version: genDefaultScriptVersion(),\n                });\n                this.isListFlod = true;\n                this.lastSelectScriptVersionId = this.selectVersionId;\n                this.selectVersionId = -1;\n                this.displayCom = 'copyCreate';\n                this.dataAppendList = Object.freeze([\n                    newScriptVersion,\n                ]);\n            },\n            /**\n             * @desc 编辑脚本\n             */\n            handleToggleEdit () {\n                this.displayCom = 'edit';\n            },\n            /**\n             * @desc 取消新建脚本版本\n             */\n            handleCreateCancel () {\n                this.displayCom = 'detail';\n                this.selectVersionId = this.lastSelectScriptVersionId;\n            },\n            /**\n             * @desc 新建成功\n             *\n             * 并选中新版本\n             */\n            handleCreateSubmit ({ scriptVersionId }) {\n                this.fetchData()\n                    .then(() => {\n                        setTimeout(() => {\n                            this.displayCom = 'detail';\n                            this.selectVersionId = scriptVersionId;\n                        });\n                    });\n            },\n            /**\n             * @desc 新建脚本过程中字段值改变\n             * @param {Number} scriptVersionId 脚本版本id\n             * @param {Object} payload 脚本数据\n             */\n            handleCreateValueChange (scriptVersionId, payload) {\n                const data = [\n                    ...this.dataAppendList,\n                ];\n                const currentScriptVersion = _.find(data, _ => _.scriptVersionId === scriptVersionId);\n                if (currentScriptVersion) {\n                    Object.assign(currentScriptVersion, payload);\n                    this.dataAppendList = Object.freeze(data);\n                }\n            },\n            /**\n             * @desc 编辑成功\n             *\n             * 显示脚本详情\n             * 刷新列表数据\n             */\n            handleEditSubmit () {\n                this.displayCom = 'detail';\n                this.fetchData();\n            },\n            /**\n             * @desc 编辑取消\n             */\n            handleEditCancel () {\n                this.displayCom = 'detail';\n            },\n            \n            /**\n             * @desc 判断是否可以选中\n             * @param {Object} row 脚本数据\n             */\n            isRowSelectable (row) {\n                if (this.disableDiff) {\n                    return true;\n                }\n                return this.choosedMap[row.scriptVersionId];\n            },\n            /**\n             * @desc 判断是否选中\n             * @param {Object} row 脚本数据\n             */\n            isRowChecked (row) {\n                return this.choosedMap[row.scriptVersionId];\n            },\n            /**\n             * @desc 自定义表头\n             */\n            renderHeader (h, data) {\n                return (\n                    <span>\n                        <span>{ data.column.label }</span>\n                        <bk-popover>\n                            <icon\n                                type=\"circle-italics-info\"\n                                style=\"margin-left: 8px; font-size: 12px;\" />\n                            <div slot=\"content\">\n                                <div>{ '显示被作业引用的次数' }</div>\n                                <div>{ '显示被执行方案引用的次数' }</div>\n                            </div>\n                        </bk-popover>\n                    </span>\n                );\n            },\n            /**\n             * @desc 路由回退\n             */\n            routerBack () {\n                if (this.publicScript) {\n                    this.$router.push({\n                        name: 'publicScriptList',\n                    });\n                    return;\n                }\n                this.$router.push({\n                    name: 'scriptList',\n                });\n            },\n        },\n    };\n</script>\n<style lang='postcss'>\n    .script-manage-version-page {\n        .version-list-wraper {\n            margin-top: 20px;\n        }\n\n        .script-version-list {\n            .bk-table-row {\n                &.active {\n                    background: #eff5ff;\n                }\n\n                &.active,\n                &.hover-row {\n                    span[data-script-status] {\n                        background: #e6e7eb !important;\n                    }\n\n                    span[data-script-status=\"1\"] {\n                        background: #daebde !important;\n                    }\n\n                    span[data-script-status=\"-1\"] {\n                        background: #ffe8c3 !important;\n                    }\n                }\n            }\n\n            .select-flag {\n                float: right;\n                margin-top: 3px;\n                color: #a3c5fd;\n            }\n        }\n    }\n</style>\n"],"names":[],"sourceRoot":""}