{"version":3,"file":"static/css/4059.4d5006d6ad3ce4923d2e.css","mappings":"AAkFA,gCACA,iBA2JA,CAzJA,+CACA,kBA+BA,CA7BA,sEAEA,WADA,cAEA,CAEA,qEAMA,eAJA,YAGA,gBADA,kBADA,cAIA,kBANA,UAOA,CAEA,8DAEA,yBADA,aAEA,CAEA,gEAEA,mBADA,aAEA,CAEA,4DAEA,gBADA,eAEA,CAGA,uDACA,aACA,kBACA,CAEA,6CAIA,yBAHA,aAEA,eADA,sBAGA,8DAyDA,CAvDA,gEAIA,gCADA,aAEA,CAEA,+HA9DA,mBADA,aAIA,eAFA,YACA,iBA2GA,CA/CA,+DAKA,gBACA,gCAHA,cACA,cA2CA,CAvCA,sEAEA,6BADA,aAMA,CAHA,sFACA,aACA,CAGA,qEACA,kBACA,CAEA,qEACA,gBACA,gBACA,uBACA,kBACA,CAEA,4EAQA,mBAFA,mBACA,kBAFA,WAJA,aAEA,YAMA,uBALA,gBAFA,UAQA,CAEA,+EAKA,cAJA,aAGA,eADA,iBADA,iBAIA,CAIA,iDAEA,yBACA,yBAFA,aAIA,OADA,qBA+BA,CA5BA,8DAEA,gCADA,YAEA,CAEA,mEAQA,mBAFA,+BAFA,cACA,eAlIA,aAoIA,eAhIA,eAFA,YAoIA,uBAnIA,kBA6HA,cAaA,CALA,0EAEA,gBACA,6BAFA,aAGA,CAGA,kEAEA,gBACA,OAFA,gBAGA,CAGA,oDAKA,cAFA,eACA,iBAHA,iBACA,kBAIA,oBACA,CAEA,4CAEA,kBADA,WAEA,CCgCA,uEACA,SACA,CAIA,6CACA,eACA,SACA,CAEA,yCAEA,mBADA,aAEA,yBACA,kBACA,CAEA,yCAMA,yBAFA,eAHA,YAIA,iBAFA,gBADA,cAKA,CAEA,2CACA,aACA,CAEA,6CAOA,yBAFA,cAJA,qBAGA,eADA,YAGA,kBAJA,UAMA,CAEA,kDACA,gCACA,CAEA,wCACA,gBACA,iBACA,CAEA,wCACA,YACA,CAEA,6CAUA,mBAFA,gBACA,6BAPA,SAEA,aAEA,YAKA,yBARA,OAIA,mBANA,eAIA,UAOA","sources":["webpack://job/./src/views/script-manage/sync-task/components/script-detail.vue","webpack://job/./src/views/script-manage/sync-task/index.vue"],"sourcesContent":["\r\n\r\n<template>\r\n    <jb-sideslider\r\n        :is-show=\"isShow\"\r\n        :show-footer=\"false\"\r\n        @update:isShow=\"handleCancel\"\r\n        :quick-close=\"true\"\r\n        :width=\"900\"\r\n        :title=\"$t('script.查看脚本')\">\r\n        <div v-if=\"isShow\" v-bkloading=\"{ isLoading }\">\r\n            <script-detail v-if=\"!isLoading\" :script-info=\"scriptInfo\" :offset-bottom=\"0\" />\r\n        </div>\r\n    </jb-sideslider>\r\n</template>\r\n<script>\r\n    import ScriptService from '@service/script-manage';\r\n    import PublicScriptService from '@service/public-script-manage';\r\n    import {\r\n        checkPublicScript,\r\n    } from '@utils/assist';\r\n    import ScriptDetail from '../../common/detail';\r\n\r\n    export default {\r\n        name: '',\r\n        components: {\r\n            ScriptDetail,\r\n        },\r\n        props: {\r\n            isShow: {\r\n                type: Boolean,\r\n                default: false,\r\n            },\r\n            scriptVersionId: {\r\n                type: Number,\r\n                required: true,\r\n            },\r\n        },\r\n        data () {\r\n            return {\r\n                isLoading: false,\r\n                scriptInfo: {},\r\n            };\r\n        },\r\n        watch: {\r\n            isShow (isShow) {\r\n                if (isShow && this.scriptVersionId > 0) {\r\n                    this.fetchScriptDetail();\r\n                }\r\n            },\r\n        },\r\n        created () {\r\n            this.publicScript = checkPublicScript(this.$route);\r\n            this.serviceHandler = this.publicScript ? PublicScriptService : ScriptService;\r\n        },\r\n        methods: {\r\n            fetchScriptDetail () {\r\n                this.isLoading = true;\r\n                this.serviceHandler.versionDetail({\r\n                    id: this.scriptVersionId,\r\n                }).then((data) => {\r\n                    this.scriptInfo = Object.freeze(data);\r\n                })\r\n                    .finally(() => {\r\n                        this.isLoading = false;\r\n                    });\r\n            },\r\n            handleCancel () {\r\n                this.$emit('update:isShow', false);\r\n            },\r\n        },\r\n    };\r\n</script>\r\n<style lang='postcss' scoped>\r\n    %tab-item {\r\n        display: flex;\r\n        align-items: center;\r\n        height: 43px;\r\n        padding-left: 20px;\r\n        font-size: 12px;\r\n    }\r\n\r\n    .script-detail {\r\n        position: relative;\r\n\r\n        .detail-layout {\r\n            margin-bottom: 20px;\r\n\r\n            .script-detail-version {\r\n                font-size: 18px;\r\n                color: #000;\r\n            }\r\n\r\n            .script-detail-status {\r\n                width: 46px;\r\n                height: 16px;\r\n                padding: 0 5px;\r\n                margin-right: 10px;\r\n                margin-left: 8px;\r\n                font-size: 12px;\r\n                text-align: center;\r\n            }\r\n\r\n            .status-online {\r\n                color: #45c272;\r\n                background-color: #e5f6ea;\r\n            }\r\n\r\n            .status-disabled {\r\n                color: #9fa2ac;\r\n                background: #f0f1f5;\r\n            }\r\n\r\n            .detail-item {\r\n                margin-top: 10px;\r\n                margin-bottom: 0;\r\n            }\r\n        }\r\n\r\n        .render-script-version {\r\n            display: flex;\r\n            margin-bottom: 60px;\r\n        }\r\n\r\n        .version-tab {\r\n            display: flex;\r\n            flex-direction: column;\r\n            flex: 0 0 280px;\r\n            border: 1px solid #dcdee5;\r\n            user-select: none;\r\n\r\n            .version-tab-title {\r\n                @extend %tab-item;\r\n\r\n                color: #313238;\r\n                border-bottom: 1px solid #dcdee5;\r\n            }\r\n\r\n            .version-tab-item {\r\n                @extend %tab-item;\r\n\r\n                color: #63656e;\r\n                cursor: pointer;\r\n                background: #fff;\r\n                border-bottom: 1px solid #dcdee5;\r\n\r\n                &.active {\r\n                    color: #3a84ff;\r\n                    background: #f0f1f5 !important;\r\n\r\n                    .version-active {\r\n                        display: block;\r\n                    }\r\n                }\r\n\r\n                &:hover {\r\n                    background: #fafbfd;\r\n                }\r\n\r\n                .text {\r\n                    max-width: 150px;\r\n                    overflow: hidden;\r\n                    text-overflow: ellipsis;\r\n                    white-space: normal;\r\n                }\r\n\r\n                .online-flag {\r\n                    display: flex;\r\n                    width: 50px;\r\n                    height: 16px;\r\n                    margin-left: 8px;\r\n                    color: #fff;\r\n                    background: #ea3636;\r\n                    border-radius: 8px;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                }\r\n\r\n                .version-active {\r\n                    display: none;\r\n                    margin-right: 12px;\r\n                    margin-left: auto;\r\n                    font-size: 14px;\r\n                    color: #979ba5;\r\n                }\r\n            }\r\n        }\r\n\r\n        .version-content {\r\n            display: flex;\r\n            background-color: #f0f1f5;\r\n            border: 1px solid #dcdee5;\r\n            flex-direction: column;\r\n            flex: 1;\r\n\r\n            .content-tab {\r\n                display: flex;\r\n                border-bottom: 1px solid #dcdee5;\r\n            }\r\n\r\n            .content-tab-item {\r\n                @extend %tab-item;\r\n\r\n                padding-left: 0;\r\n                color: #313238;\r\n                cursor: pointer;\r\n                border-right: 1px solid #dcdee5;\r\n                flex: 0 0 120px;\r\n                align-items: center;\r\n                justify-content: center;\r\n\r\n                &.active {\r\n                    color: #3a84ff;\r\n                    background: #fff;\r\n                    border-top: 2px solid #3a84ff;\r\n                }\r\n            }\r\n\r\n            .content-dispaly {\r\n                min-height: 300px;\r\n                background: #fff;\r\n                flex: 1;\r\n            }\r\n        }\r\n\r\n        .render-version-log {\r\n            min-height: 480px;\r\n            padding: 12px 10px;\r\n            font-size: 12px;\r\n            line-height: 20px;\r\n            color: #63656e;\r\n            white-space: pre-line;\r\n        }\r\n\r\n        .action-btn {\r\n            width: 100px;\r\n            margin-right: 10px;\r\n        }\r\n    }\r\n</style>\r\n","\r\n\r\n<template>\r\n    <div class=\"script-manage-sync-task-page\" v-bkloading=\"{ isLoading }\">\r\n        <div class=\"retry-btn\">\r\n            <bk-button  @click=\"handleAllRetry\">{{ $t('script.全部重试') }}</bk-button>\r\n        </div>\r\n        <div class=\"table-top\">\r\n            {{ $t('script.同步作业模板') }}\r\n            <span class=\"version-sum\">\r\n                （{{ $t('script.共') }} {{ data.length }} {{ $t('script.个.result') }}）\r\n            </span>\r\n        </div>\r\n        <bk-table :data=\"data\" row-class-name=\"sync-script-record\">\r\n            <bk-table-column\r\n                :label=\"$t('script.作业模板名称')\"\r\n                prop=\"name\"\r\n                sortable>\r\n                <template slot-scope=\"{ row }\">\r\n                    <router-link\r\n                        target=\"_blank\"\r\n                        :to=\"{\r\n                            name: 'templateDetail',\r\n                            params: {\r\n                                id: 4 || row.templateId,\r\n                            },\r\n                        }\">\r\n                        {{ row.templateName }}\r\n                        <Icon type=\"edit\" class=\"template-link\" />\r\n                    </router-link>\r\n                </template>\r\n            </bk-table-column>\r\n            <bk-table-column :label=\"$t('script.步骤名称')\" prop=\"stepName\" />\r\n            <bk-table-column :label=\"$t('script.引用的版本号')\" prop=\"version\">\r\n                <template slot-scope=\"{ row }\">\r\n                    <bk-button\r\n                        text\r\n                        @click=\"handleShowDetail(row.scriptVersionId)\">\r\n                        {{ row.scriptVersion }}\r\n                    </bk-button>\r\n                </template>\r\n            </bk-table-column>\r\n            <bk-table-column\r\n                :label=\"$t('script.引用版本状态')\"\r\n                prop=\"status\"\r\n                :filters=\"statusFilters\"\r\n                :filter-method=\"statusFilterMethod\"\r\n                :filter-multiple=\"true\">\r\n                <template slot-scope=\"{ row }\">\r\n                    <span v-html=\"row.statusHtml\" />\r\n                </template>\r\n            </bk-table-column>\r\n            <bk-table-column\r\n                :label=\"$t('script.状态')\"\r\n                width=\"350\"\r\n                prop=\"syncStatus\">\r\n                <template slot-scope=\"{ row, $index }\">\r\n                    <Icon :type=\"row.syncIcon\" svg class=\"mr10\" />\r\n                    <span>{{ row.syncStatusMsg }}</span>\r\n                    <bk-button\r\n                        v-if=\"row.isSyncFailed\"\r\n                        :tippy-tips=\"row.failMsg\"\r\n                        text\r\n                        style=\"margin-left: 15px;\"\r\n                        @click=\"handleRetry(row, $index)\">\r\n                        {{ $t('script.重试') }}\r\n                    </bk-button>\r\n                </template>\r\n            </bk-table-column>\r\n        </bk-table>\r\n        <div class=\"footer-action\">\r\n            <bk-button\r\n                class=\"w120\"\r\n                theme=\"primary\"\r\n                @click=\"handleFinish\">\r\n                {{ $t('script.完成') }}\r\n            </bk-button>\r\n        </div>\r\n        <script-detail :is-show.sync=\"isShowDetail\" :script-version-id=\"selectScriptVersionId\" />\r\n        <element-teleport v-if=\"lastVersionScriptInfo.version\">\r\n            <span> - {{ $t('script.同步至') }}</span>\r\n            <span>{{ lastVersionScriptInfo.version }}</span>\r\n        </element-teleport>\r\n    </div>\r\n</template>\r\n<script>\r\n    import I18n from '@/i18n';\r\n    import {\r\n        checkPublicScript,\r\n        leaveConfirm,\r\n    } from '@utils/assist';\r\n    import ScriptService from '@service/script-manage';\r\n    import PublicScriptService from '@service/public-script-manage';\r\n    import TaskPlanService from '@service/task-plan';\r\n    import ScriptDetail from './components/script-detail';\r\n\r\n    export default {\r\n        components: {\r\n            ScriptDetail,\r\n        },\r\n        data () {\r\n            return {\r\n                data: [{},{},{}],\r\n                isLoading: false,\r\n                isShowDetail: false,\r\n                selectScriptVersionId: 0,\r\n                lastVersionScriptInfo: {},\r\n            };\r\n        },\r\n        computed: {\r\n            isRetryAllDisable () {\r\n                // eslint-disable-next-line no-plusplus\r\n                for (let i = 0; i < this.data.length; i++) {\r\n                    if (this.data[i].isSyncFailed) {\r\n                        return false;\r\n                    }\r\n                }\r\n                return true;\r\n            },\r\n        },\r\n        created () {\r\n            this.statusFilters = [\r\n                { value: 0, text: I18n.t('script.未上线') },\r\n                { value: 1, text: I18n.t('script.已上线') },\r\n                { value: 2, text: I18n.t('script.已下线') },\r\n                { value: 3, text: I18n.t('script.已禁用') },\r\n            ];\r\n            this.publicScript = checkPublicScript(this.$route);\r\n            this.serviceHandler = this.publicScript ? PublicScriptService : ScriptService;\r\n            this.scriptId = this.$route.params.scriptId;\r\n            this.scriptVersionId = this.$route.params.scriptVersionId;\r\n            this.stepList = JSON.parse(localStorage.getItem('SYNC_TEMPLATE_STEP_SCRIPT'));\r\n            if (this.stepList.length < 1) {\r\n                this.messageError(I18n.t('script.请先选择作业模板步骤'));\r\n                return;\r\n            }\r\n            this.fetchData();\r\n            this.fetchLastScriptVersionDetail();\r\n        },\r\n        methods: {\r\n            /**\r\n             * @desc 开始同步脚本\r\n             */\r\n            fetchData () {\r\n                this.isLoading = true;\r\n                this.serviceHandler.scriptVersionSync({\r\n                    scriptId: this.scriptId,\r\n                    scriptVersionId: this.scriptVersionId,\r\n                    steps: this.stepList,\r\n                }).then((data) => {\r\n                    this.data = data;\r\n                })\r\n                    .finally(() => {\r\n                        this.isLoading = false;\r\n                    });\r\n            },\r\n            /**\r\n             * @desc 脚本的最新版本信息\r\n             */\r\n            fetchLastScriptVersionDetail () {\r\n                this.serviceHandler.versionDetail({\r\n                    id: this.$route.params.scriptVersionId,\r\n                }).then((data) => {\r\n                    this.lastVersionScriptInfo = Object.freeze(data);\r\n                });\r\n            },\r\n            /**\r\n             * @desc 脚本详情\r\n             * @param { Number } id\r\n             */\r\n            handleShowDetail (id) {\r\n                this.selectScriptVersionId = id;\r\n                this.isShowDetail = true;\r\n            },\r\n            /**\r\n             * @desc 全部重试\r\n             */\r\n            handleAllRetry () {\r\n                this.fetchData();\r\n            },\r\n            /**\r\n             * @desc 单个重试\r\n             */\r\n            handleRetry (row, index) {\r\n                this.serviceHandler.scriptVersionSync({\r\n                    scriptId: this.scriptId,\r\n                    scriptVersionId: this.scriptVersionId,\r\n                    steps: [\r\n                        {\r\n                            templateid: 4 || row.templateId,\r\n                            stepid: 4 || row.stepId,\r\n                        },\r\n                    ],\r\n                }).then((data) => {\r\n                    this.data.splice(index, 1, data[0]);\r\n                });\r\n            },\r\n            /**\r\n             * @desc 数据过滤\r\n             * @param {Number} value 选中的状态\r\n             * @param {Object} row 单条数据\r\n             */\r\n            statusFilterMethod (value, row) {\r\n                return row.scriptStatus === value;\r\n            },\r\n            /**\r\n             * @desc 完成同步任务\r\n             */\r\n            handleFinish () {\r\n                this.routerBack();\r\n            },\r\n            /**\r\n             * @desc 路由回退\r\n             */\r\n            routerBack () {\r\n                window.changeAlert = !this.isRetryAllDisable;\r\n                this.isSyncPlanLoading = false;\r\n                leaveConfirm(I18n.t('script.部分作业模板同步失败，请留意'))\r\n                    .then(() => {\r\n                        this.$bkInfo({\r\n                            title: I18n.t('script.是否需要进行执行方案同步？'),\r\n                            closeIcon: false,\r\n                            subHeader: (() => (\r\n                                <div>\r\n                                    <span>{ I18n.t('script.点击') }</span>\r\n                                    <span style=\"font-weight: bold\"> { I18n.t('script.“立即前往”') } </span>\r\n                                    <span>{ I18n.t('script.将进入关联的执行方案同步确认页面，点击') }</span>\r\n                                    <span style=\"font-weight: bold\"> { I18n.t('script.“暂时不用”') } </span>\r\n                                    <span>{ I18n.t('script.结束本次操作并退出。') }</span>\r\n                                </div>\r\n                            ))(),\r\n                            okText: I18n.t('script.立即前往'),\r\n                            cancelText: I18n.t('script.暂时不用'),\r\n                            // 获取同步的作业模板对应的执行方案列表，批量同步需要同步的执行方案\r\n                            confirmFn: () => TaskPlanService.fetchBatchTaskPlan({\r\n                                templateIds: this.stepList.map(({ templateId }) => templateId).join(','),\r\n                            }).then((planList) => {\r\n                                // 跳转批量同步执行方案页面\r\n                                this.$router.push({\r\n                                    name: 'syncPlanBatch',\r\n                                    query: {\r\n                                        planIds: planList.reduce((result, plan) => {\r\n                                            if (plan.needUpdate) {\r\n                                                result.push(plan.id);\r\n                                            }\r\n                                            return result;\r\n                                        }, []).join(','),\r\n                                    },\r\n                                });\r\n                            }),\r\n                            cancelFn: () => {\r\n                                const routerName = this.publicScript ? 'publicScriptVersion' : 'scriptVersion';\r\n                                this.$router.push({\r\n                                    name: routerName,\r\n                                    params: {\r\n                                        id: this.scriptId,\r\n                                    },\r\n                                });\r\n                            },\r\n                        });\r\n                    });\r\n            },\r\n        },\r\n    };\r\n</script>\r\n<style lang=\"postcss\">\r\n    .script-manage-sync-task-page {\r\n        .sync-script-record {\r\n            &:hover {\r\n                .template-link {\r\n                    opacity: 100%;\r\n                }\r\n            }\r\n        }\r\n\r\n        .template-link {\r\n            font-size: 12px;\r\n            opacity: 0%;\r\n        }\r\n\r\n        .retry-btn {\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: flex-end;\r\n            margin-bottom: 20px;\r\n        }\r\n\r\n        .table-top {\r\n            height: 42px;\r\n            padding: 0 20px;\r\n            margin-top: 16px;\r\n            font-size: 12px;\r\n            line-height: 42px;\r\n            background-color: #f0f1f5;\r\n        }\r\n\r\n        .version-sum {\r\n            color: #a3a6af;\r\n        }\r\n\r\n        .status-action {\r\n            display: inline-block;\r\n            width: 46px;\r\n            height: 16px;\r\n            font-size: 12px;\r\n            color: #9fa2ac;\r\n            text-align: center;\r\n            background-color: #f0f1f5;\r\n        }\r\n\r\n        .failed-sync-status {\r\n            border-bottom: 1px dashed #c4c6cc;\r\n        }\r\n\r\n        .try-show {\r\n            display: visible;\r\n            padding-left: 10px;\r\n        }\r\n\r\n        .try-hide {\r\n            display: none;\r\n        }\r\n\r\n        .footer-action {\r\n            position: fixed;\r\n            bottom: 0;\r\n            left: 0;\r\n            display: flex;\r\n            width: 100%;\r\n            height: 52px;\r\n            padding-right: 24px;\r\n            background: #fff;\r\n            border-top: 1px solid #e2e2e2;\r\n            align-items: center;\r\n            justify-content: flex-end;\r\n        }\r\n    }\r\n</style>\r\n"],"names":[],"sourceRoot":""}